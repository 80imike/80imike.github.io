<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="keyword"  content="Linux,运维,Nginx,Zabbix,Centos,Ansible,MySQL,Python,Docker,ELK,Haproxy,Git,Nodejs,安全,技术">
    <link rel="shortcut icon" href="/img/ironman-draw.png">
    <!-- Place this tag in your head or just before your close body tag. -->
    <script async defer src="https://buttons.github.io/buttons.js"></script>
    <title>
        
          Percona MySQL Server 部署指南 - 奇妙的 Linux 世界
        
    </title>

    <link rel="canonical" href="https://www.hi-linux.com/posts/8700.html">

    <!-- Bootstrap Core CSS -->
    
<link rel="stylesheet" href="/css/bootstrap.min.css">


    <!-- Custom CSS --> 
    
<link rel="stylesheet" href="/css/beantech.min.css">

    
    <!-- Pygments Highlight CSS -->
    
<link rel="stylesheet" href="/css/highlight.css">


    
<link rel="stylesheet" href="/css/widget.css">


    
<link rel="stylesheet" href="/css/rocket.css">


    
<link rel="stylesheet" href="/css/signature.css">


    
<link rel="stylesheet" href="/css/toc.css">


    <!-- Custom Fonts -->
    <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- Hux Delete, sad but pending in China
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/
    css'>
    -->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>
<meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="奇妙的 Linux 世界" type="application/atom+xml">
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">
	<!-- Modified by Yu-Hsuan Yen -->
<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        
            background-image: url('/img/header_img/building.jpg')
            /*post*/
        
    }
    
</style>

<header class="intro-header" >
    <!-- Signature -->
    <div id="signature">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                
                    <div class="post-heading">
                        <div class="tags">
                            
                              <a class="tag" href="/tags/#技巧" title="技巧">技巧</a>
                            
                              <a class="tag" href="/tags/#Linux" title="Linux">Linux</a>
                            
                              <a class="tag" href="/tags/#MySQL" title="MySQL">MySQL</a>
                            
                        </div>
                        <h1>Percona MySQL Server 部署指南</h1>
                        <h2 class="subheading"></h2>
                        <span class="meta">
                            Posted by Mike on
                            2021-01-18
                        </span>
                    </div>
                


                </div>
            </div>
        </div>
    </div>
</header>

	
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">奇妙的 Linux 世界</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>

                    

                        
                    

                        
                    

                        
                        <li>
                            <a href="/about/">About</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/tags/">Tags</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/archive/">Archives</a>
                        </li>
                        
                    
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>


    <!-- Main Content -->
    <!-- Modify by Yu-Hsuan Yen -->

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

            <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <div id="vip-container"><h2><span id="一-版本信息">一、版本信息</span></h2>
<p>目前采用 MySQL fork 版本 Percona Server 5.7.28，监控方面选择 Percona Monitoring and Management 2.1.0，对应监控 Client 版本为 2.1.0</p>
<h2><span id="二-percona-server-安装">二、Percona Server 安装</span></h2>
<p>为保证兼容以及稳定性，MySQL 宿主机系统选择 CentOS 7，Percona Server 安装方式为 rpm 包，安装后由 Systemd 守护</p>
<h3><span id="21-下载安装包">2.1、下载安装包</span></h3>
<p>安装包下载地址为 <a href="https://www.percona.com/downloads/Percona-Server-5.7/LATEST/%EF%BC%8C%E4%B8%8B%E8%BD%BD%E6%97%B6%E9%80%89%E6%8B%A9" target="_blank" rel="noopener">https://www.percona.com/downloads/Percona-Server-5.7/LATEST/，下载时选择</a> <code>Download All Packages Together</code>，下载后是所有组件全量的压缩 tar 包。</p>
<h3><span id="22-安装前准备">2.2、安装前准备</span></h3>
<p>针对 CentOS 7 系统，安装前升级所有系统组件库，执行 <code>yum update</code> 既可；大部份 <strong>CentOS 7 安装后可能会附带 <code>mariadb-libs</code> 包，这个包会默认创建一些配置文件，导致后面的 Percona Server 无法覆盖它(例如 <code>/etc/my.cnf</code>)，所以安装 Percona Server 之前需要卸载它 <code>yum remove mariadb-libs</code></strong></p>
<p>针对于数据存储硬盘，目前统一为 SSD 硬盘，挂载点为 <code>/data</code>，挂载方式可以采用 <code>fstab</code>、<code>systemd-mount</code>，分区格式目前采用 <code>xfs</code> 格式。</p>
<p><strong>SSD 优化有待补充…</strong></p>
<h3><span id="23-安装-percona-server">2.3、安装 Percona Server</span></h3>
<p>Percona Server tar 包解压后会有 9 个 rpm 包，实际安装时只需要安装其中 4 个既可</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install Percona-Server-client-57-5.7.28-31.1.el7.x86_64.rpm Percona-Server-server-57-5.7.28-31.1.el7.x86_64.rpm Percona-Server-shared-57-5.7.28-31.1.el7.x86_64.rpm Percona-Server-shared-compat-57-5.7.28-31.1.el7.x86_64.rpm</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h3><span id="24-安装后调整">2.4、安装后调整</span></h3>
<h4><span id="241-硬盘调整">2.4.1、硬盘调整</span></h4>
<p>目前 MySQL 数据会统一存放到 <code>/data</code> 目录下，所以需要将单独的数据盘挂载到 <code>/data</code> 目录；<strong>如果是 SSD 硬盘还需要调整系统 I/O 调度器等其他优化。</strong></p>
<h4><span id="242-目录预创建">2.4.2、目录预创建</span></h4>
<p>Percona Server 安装完成后，由于配置调整原因，还会用到一些其他的数据目录，这些目录可以预先创建并授权</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p &#x2F;var&#x2F;log&#x2F;mysql &#x2F;data&#x2F;mysql_tmp</span><br><span class="line">chown -R mysql:mysql &#x2F;var&#x2F;log&#x2F;mysql &#x2F;data&#x2F;mysql_tmp</span><br></pre></td></tr></table></figure>
<p><code>/var/log/mysql</code> 目录用来存放 MySQL 相关的日志(不包括 binlog)，<code>/data/mysql_tmp</code> 用来存放 MySQL 运行时产生的缓存文件。</p>
<h4><span id="243-文件描述符调整">2.4.3、文件描述符调整</span></h4>
<p>由于 rpm 安装的 Percona Server 会采用 Systemd 守护，所以如果想修改文件描述符配置应当调整 Systemd 配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;mysqld.service</span><br><span class="line"></span><br><span class="line"># Sets open_files_limit</span><br><span class="line"># 注意 infinity &#x3D; 65536</span><br><span class="line">LimitCORE &#x3D; infinity</span><br><span class="line">LimitNOFILE &#x3D; infinity</span><br><span class="line">LimitNPROC &#x3D; infinity</span><br></pre></td></tr></table></figure>
<p>然后执行 <code>systemctl daemon-reload</code> 重载既可。</p>
<h4><span id="244-配置文件调整">2.4.4、配置文件调整</span></h4>
<p>Percona Server 安装完成后也会生成 <code>/etc/my.cnf</code> 配置文件，不过不建议直接修改该文件；修改配置文件需要进入到 <code>/etc/percona-server.conf.d/</code> 目录调整相应配置；以下为配置样例(<strong>生产环境 mysqld 配置需要优化调整</strong>)</p>
<p><strong>mysql.cnf</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[mysql]</span><br><span class="line">auto-rehash</span><br><span class="line">default_character_set&#x3D;utf8mb4</span><br></pre></td></tr></table></figure>
<p><strong>mysqld.cnf</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br></pre></td><td class="code"><pre><span class="line"># Percona Server template configuration</span><br><span class="line"></span><br><span class="line">[mysqld]</span><br><span class="line">#</span><br><span class="line"># Remove leading # and set to the amount of RAM for the most important data</span><br><span class="line"># cache in MySQL. Start at 70% of total RAM for dedicated server, else 10%.</span><br><span class="line"># innodb_buffer_pool_size &#x3D; 128M</span><br><span class="line">#</span><br><span class="line"># Remove leading # to turn on a very important data integrity option: logging</span><br><span class="line"># changes to the binary log between backups.</span><br><span class="line"># log_bin</span><br><span class="line">#</span><br><span class="line"># Remove leading # to set options mainly useful for reporting servers.</span><br><span class="line"># The server defaults are faster for transactions and fast SELECTs.</span><br><span class="line"># Adjust sizes as needed, experiment to find the optimal values.</span><br><span class="line"># join_buffer_size &#x3D; 128M</span><br><span class="line"># sort_buffer_size &#x3D; 2M</span><br><span class="line"># read_rnd_buffer_size &#x3D; 2M</span><br><span class="line">port&#x3D;3306</span><br><span class="line">datadir&#x3D;&#x2F;data&#x2F;mysql</span><br><span class="line">socket&#x3D;&#x2F;data&#x2F;mysql&#x2F;mysql.sock</span><br><span class="line">pid_file&#x3D;&#x2F;data&#x2F;mysql&#x2F;mysqld.pid</span><br><span class="line"></span><br><span class="line"># 服务端编码</span><br><span class="line">character_set_server&#x3D;utf8mb4</span><br><span class="line"># 服务端排序</span><br><span class="line">collation_server&#x3D;utf8mb4_general_ci</span><br><span class="line"># 强制使用 utf8mb4 编码集，忽略客户端设置</span><br><span class="line">skip_character_set_client_handshake&#x3D;1</span><br><span class="line"># 日志输出到文件</span><br><span class="line">log_output&#x3D;FILE</span><br><span class="line"># 开启常规日志输出</span><br><span class="line">general_log&#x3D;1</span><br><span class="line"># 常规日志输出文件位置</span><br><span class="line">general_log_file&#x3D;&#x2F;var&#x2F;log&#x2F;mysql&#x2F;mysqld.log</span><br><span class="line"># 错误日志位置</span><br><span class="line">log_error&#x3D;&#x2F;var&#x2F;log&#x2F;mysql&#x2F;mysqld-error.log</span><br><span class="line"># 记录慢查询</span><br><span class="line">slow_query_log&#x3D;1</span><br><span class="line"># 慢查询时间(大于 1s 被视为慢查询)</span><br><span class="line">long_query_time&#x3D;1</span><br><span class="line"># 慢查询日志文件位置</span><br><span class="line">slow_query_log_file&#x3D;&#x2F;var&#x2F;log&#x2F;mysql&#x2F;mysqld-slow.log</span><br><span class="line"># 临时文件位置</span><br><span class="line">tmpdir&#x3D;&#x2F;data&#x2F;mysql_tmp</span><br><span class="line"># 线程池缓存(refs https:&#x2F;&#x2F;my.oschina.net&#x2F;realfighter&#x2F;blog&#x2F;363853)</span><br><span class="line">thread_cache_size&#x3D;30</span><br><span class="line"># The number of open tables for all threads.(refs https:&#x2F;&#x2F;dev.mysql.com&#x2F;doc&#x2F;refman&#x2F;5.7&#x2F;en&#x2F;server-system-variables.html#sysvar_table_open_cache)</span><br><span class="line">table_open_cache&#x3D;16384</span><br><span class="line"># 文件描述符(此处修改不生效，请修改 systemd service 配置) </span><br><span class="line"># refs https:&#x2F;&#x2F;www.percona.com&#x2F;blog&#x2F;2017&#x2F;10&#x2F;12&#x2F;open_files_limit-mystery&#x2F;</span><br><span class="line"># refs https:&#x2F;&#x2F;www.cnblogs.com&#x2F;wxxjianchi&#x2F;p&#x2F;10370419.html</span><br><span class="line">#open_files_limit&#x3D;65535</span><br><span class="line"># 表定义缓存(5.7 以后自动调整)</span><br><span class="line"># refs https:&#x2F;&#x2F;dev.mysql.com&#x2F;doc&#x2F;refman&#x2F;5.6&#x2F;en&#x2F;server-system-variables.html#sysvar_table_definition_cache</span><br><span class="line"># refs http:&#x2F;&#x2F;mysql.taobao.org&#x2F;monthly&#x2F;2015&#x2F;08&#x2F;10&#x2F;</span><br><span class="line">#table_definition_cache&#x3D;16384</span><br><span class="line">sort_buffer_size&#x3D;1M</span><br><span class="line">join_buffer_size&#x3D;1M</span><br><span class="line"># MyiSAM 引擎专用(内部临时磁盘表可能会用)</span><br><span class="line">read_buffer_size&#x3D;1M</span><br><span class="line">read_rnd_buffer_size&#x3D;1M</span><br><span class="line"># MyiSAM 引擎专用(内部临时磁盘表可能会用)</span><br><span class="line">key_buffer_size&#x3D;32M</span><br><span class="line"># MyiSAM 引擎专用(内部临时磁盘表可能会用)</span><br><span class="line">bulk_insert_buffer_size&#x3D;16M</span><br><span class="line"># myisam_sort_buffer_size 与 sort_buffer_size 区别请参考(https:&#x2F;&#x2F;stackoverflow.com&#x2F;questions&#x2F;7871027&#x2F;myisam-sort-buffer-size-vs-sort-buffer-size)</span><br><span class="line">myisam_sort_buffer_size&#x3D;64M</span><br><span class="line"># 内部内存临时表大小</span><br><span class="line">tmp_table_size&#x3D;32M</span><br><span class="line"># 用户创建的 MEMORY 表最大大小(tmp_table_size 受此值影响)</span><br><span class="line">max_heap_table_size&#x3D;32M</span><br><span class="line"># 开启查询缓存</span><br><span class="line">query_cache_type&#x3D;1</span><br><span class="line"># 查询缓存大小</span><br><span class="line">query_cache_size&#x3D;32M</span><br><span class="line"># sql mode</span><br><span class="line">sql_mode&#x3D;&#39;STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION&#39;</span><br><span class="line"></span><br><span class="line">########### Network ###########</span><br><span class="line"># 最大连接数(该参数受到最大文件描述符影响，如果不生效请检查最大文件描述符设置)</span><br><span class="line"># refs https:&#x2F;&#x2F;stackoverflow.com&#x2F;questions&#x2F;39976756&#x2F;the-max-connections-in-mysql-5-7</span><br><span class="line">max_connections&#x3D;1500</span><br><span class="line"># mysql 堆栈内暂存的链接数量</span><br><span class="line"># 当短时间内链接数量超过 max_connections 时，部分链接会存储在堆栈内，存储数量受此参数控制</span><br><span class="line">back_log&#x3D;256</span><br><span class="line"># 最大链接错误，针对于 client 主机，超过此数量的链接错误将会导致 mysql server 针对此主机执行锁定(禁止链接 ERROR 1129 )</span><br><span class="line"># 此错误计数仅在 mysql 链接握手失败才会计算，一般出现问题时都是网络故障</span><br><span class="line"># refs https:&#x2F;&#x2F;www.cnblogs.com&#x2F;kerrycode&#x2F;p&#x2F;8405862.html</span><br><span class="line">max_connect_errors&#x3D;100000</span><br><span class="line"># mysql server 允许的最大数据包大小</span><br><span class="line">max_allowed_packet&#x3D;64M</span><br><span class="line"># 交互式客户端链接超时(30分钟自动断开)</span><br><span class="line">interactive_timeout&#x3D;1800</span><br><span class="line"># 非交互式链接超时时间(10分钟)</span><br><span class="line"># 如果客户端有连接池，则需要协商此参数(refs https:&#x2F;&#x2F;database.51cto.com&#x2F;art&#x2F;201909&#x2F;603519.htm)</span><br><span class="line">wait_timeout&#x3D;600</span><br><span class="line"># 跳过外部文件系统锁定</span><br><span class="line"># If you run multiple servers that use the same database directory (not recommended), </span><br><span class="line"># each server must have external locking enabled.</span><br><span class="line"># refs https:&#x2F;&#x2F;dev.mysql.com&#x2F;doc&#x2F;refman&#x2F;5.7&#x2F;en&#x2F;external-locking.html</span><br><span class="line">skip_external_locking&#x3D;1</span><br><span class="line"># 跳过链接的域名解析(开启此选项后 mysql 用户授权的 host 方式失效)</span><br><span class="line">skip_name_resolve&#x3D;0</span><br><span class="line"># 禁用主机名缓存，每次都会走 DNS</span><br><span class="line">host_cache_size&#x3D;0</span><br><span class="line"></span><br><span class="line">########### REPL ###########</span><br><span class="line"># 开启 binlog</span><br><span class="line">log_bin&#x3D;mysql-bin</span><br><span class="line"># 作为从库时，同步信息依然写入 binlog，方便此从库再作为其他从库的主库</span><br><span class="line">log_slave_updates&#x3D;1</span><br><span class="line"># server id，默认为 ipv4 地址去除第一段</span><br><span class="line"># eg: 172.16.10.11 &#x3D;&gt; 161011</span><br><span class="line">server_id&#x3D;161011</span><br><span class="line"># 每次次事务 binlog 刷新到磁盘</span><br><span class="line"># refs http:&#x2F;&#x2F;liyangliang.me&#x2F;posts&#x2F;2014&#x2F;03&#x2F;innodb_flush_log_at_trx_commit-and-sync_binlog&#x2F;</span><br><span class="line">sync_binlog&#x3D;100</span><br><span class="line"># binlog 格式(refs https:&#x2F;&#x2F;zhuanlan.zhihu.com&#x2F;p&#x2F;33504555)</span><br><span class="line">binlog_format&#x3D;row</span><br><span class="line"># binlog 自动清理时间</span><br><span class="line">expire_logs_days&#x3D;10</span><br><span class="line"># 开启 relay-log，一般作为 slave 时开启</span><br><span class="line">relay_log&#x3D;mysql-replay</span><br><span class="line"># 主从复制时跳过 test 库</span><br><span class="line">replicate_ignore_db&#x3D;test</span><br><span class="line"># 每个 session binlog 缓存</span><br><span class="line">binlog_cache_size&#x3D;4M</span><br><span class="line"># binlog 滚动大小</span><br><span class="line">max_binlog_size&#x3D;1024M</span><br><span class="line"># GTID 相关(refs https:&#x2F;&#x2F;keithlan.github.io&#x2F;2016&#x2F;06&#x2F;23&#x2F;gtid&#x2F;)</span><br><span class="line">#gtid_mode&#x3D;1</span><br><span class="line">#enforce_gtid_consistency&#x3D;1</span><br><span class="line"></span><br><span class="line">########### InnoDB ###########</span><br><span class="line"># 永久表默认存储引擎</span><br><span class="line">default_storage_engine&#x3D;InnoDB</span><br><span class="line"># 系统表空间数据文件大小(初始化为 1G，并且自动增长)</span><br><span class="line">innodb_data_file_path&#x3D;ibdata1:1G:autoextend</span><br><span class="line"># InnoDB 缓存池大小</span><br><span class="line"># innodb_buffer_pool_size 必须等于 innodb_buffer_pool_chunk_size*innodb_buffer_pool_instances，或者是其整数倍</span><br><span class="line"># refs https:&#x2F;&#x2F;dev.mysql.com&#x2F;doc&#x2F;refman&#x2F;5.7&#x2F;en&#x2F;innodb-buffer-pool-resize.html</span><br><span class="line"># refs https:&#x2F;&#x2F;zhuanlan.zhihu.com&#x2F;p&#x2F;60089484</span><br><span class="line">innodb_buffer_pool_size&#x3D;7680M</span><br><span class="line">innodb_buffer_pool_instances&#x3D;10</span><br><span class="line">innodb_buffer_pool_chunk_size&#x3D;128M</span><br><span class="line"># InnoDB 强制恢复(refs https:&#x2F;&#x2F;www.askmaclean.com&#x2F;archives&#x2F;mysql-innodb-innodb_force_recovery.html)</span><br><span class="line">innodb_force_recovery&#x3D;0</span><br><span class="line"># InnoDB buffer 预热(refs http:&#x2F;&#x2F;www.dbhelp.net&#x2F;2017&#x2F;01&#x2F;12&#x2F;mysql-innodb-buffer-pool-warmup.html)</span><br><span class="line">innodb_buffer_pool_dump_at_shutdown&#x3D;1</span><br><span class="line">innodb_buffer_pool_load_at_startup&#x3D;1</span><br><span class="line"># InnoDB 日志组中的日志文件数</span><br><span class="line">innodb_log_files_in_group&#x3D;2</span><br><span class="line"># InnoDB redo 日志大小</span><br><span class="line"># refs https:&#x2F;&#x2F;www.percona.com&#x2F;blog&#x2F;2017&#x2F;10&#x2F;18&#x2F;chose-mysql-innodb_log_file_size&#x2F;</span><br><span class="line">innodb_log_file_size&#x3D;256MB</span><br><span class="line"># 缓存还未提交的事务的缓冲区大小</span><br><span class="line">innodb_log_buffer_size&#x3D;16M</span><br><span class="line"># InnoDB 在事务提交后的日志写入频率</span><br><span class="line"># refs http:&#x2F;&#x2F;liyangliang.me&#x2F;posts&#x2F;2014&#x2F;03&#x2F;innodb_flush_log_at_trx_commit-and-sync_binlog&#x2F;</span><br><span class="line">innodb_flush_log_at_trx_commit&#x3D;2</span><br><span class="line"># InnoDB DML 操作行级锁等待时间</span><br><span class="line"># 超时返回 ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction</span><br><span class="line"># refs https:&#x2F;&#x2F;ningyu1.github.io&#x2F;site&#x2F;post&#x2F;75-mysql-lock-wait-timeout-exceeded&#x2F;</span><br><span class="line">innodb_lock_wait_timeout&#x3D;30</span><br><span class="line"># InnoDB 行级锁超时是否回滚整个事务，默认为 OFF 仅回滚上一条语句</span><br><span class="line"># 此时应用程序可以接受到错误后选择是否继续提交事务(并没有违反 ACID 原子性)</span><br><span class="line"># refs https:&#x2F;&#x2F;www.cnblogs.com&#x2F;hustcat&#x2F;archive&#x2F;2012&#x2F;11&#x2F;18&#x2F;2775487.html</span><br><span class="line">#innodb_rollback_on_timeout&#x3D;ON</span><br><span class="line"># InnoDB 数据写入磁盘的方式，具体见博客文章</span><br><span class="line"># refs https:&#x2F;&#x2F;www.cnblogs.com&#x2F;gomysql&#x2F;p&#x2F;3595806.html</span><br><span class="line">innodb_flush_method&#x3D;O_DIRECT</span><br><span class="line"># InnoDB 缓冲池脏页刷新百分比</span><br><span class="line"># refs https:&#x2F;&#x2F;dbarobin.com&#x2F;2015&#x2F;08&#x2F;29&#x2F;mysql-optimization-under-ssd</span><br><span class="line">innodb_max_dirty_pages_pct&#x3D;50</span><br><span class="line"># InnoDB 每秒执行的写IO量</span><br><span class="line"># refs https:&#x2F;&#x2F;www.centos.bz&#x2F;2016&#x2F;11&#x2F;mysql-performance-tuning-15-config-item&#x2F;#10.INNODB_IO_CAPACITY,%20INNODB_IO_CAPACITY_MAX</span><br><span class="line">innodb_io_capacity&#x3D;500</span><br><span class="line">innodb_io_capacity_max&#x3D;1000</span><br><span class="line"># 请求并发 InnoDB 线程数</span><br><span class="line"># refs https:&#x2F;&#x2F;www.cnblogs.com&#x2F;xinysu&#x2F;p&#x2F;6439715.html#_lab2_1_0</span><br><span class="line">innodb_thread_concurrency&#x3D;60</span><br><span class="line"># 再使用多个 InnoDB 表空间时，允许打开的最大 &quot;.ibd&quot; 文件个数，不设置默认 300，</span><br><span class="line"># 并且取与 table_open_cache 相比较大的一个，此选项独立于 open_files_limit</span><br><span class="line"># refs https:&#x2F;&#x2F;dev.mysql.com&#x2F;doc&#x2F;refman&#x2F;5.7&#x2F;en&#x2F;innodb-parameters.html#sysvar_innodb_open_files</span><br><span class="line">innodb_open_files&#x3D;65535</span><br><span class="line"># 每个 InnoDB 表都存储在独立的表空间(.ibd)中</span><br><span class="line">innodb_file_per_table&#x3D;1</span><br><span class="line"># 事务级别(可重复读，会出幻读)</span><br><span class="line">transaction_isolation&#x3D;REPEATABLE-READ</span><br><span class="line"># 是否在搜索和索引扫描中使用间隙锁(gap locking)，不建议使用未来将删除</span><br><span class="line">innodb_locks_unsafe_for_binlog&#x3D;0</span><br><span class="line"># InnoDB 后台清理线程数，更大的值有助于 DML 执行性能，&gt;&#x3D; 5.7.8 默认为 4</span><br><span class="line">innodb_purge_threads&#x3D;4</span><br></pre></td></tr></table></figure>
<p><strong>mysqld_safe.cnf</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#</span><br><span class="line"># The Percona Server 5.7 configuration file.</span><br><span class="line">#</span><br><span class="line"># One can use all long options that the program supports.</span><br><span class="line"># Run program with --help to get a list of available options and with</span><br><span class="line"># --print-defaults to see which it would actually understand and use.</span><br><span class="line">#</span><br><span class="line"># For explanations see</span><br><span class="line"># http:&#x2F;&#x2F;dev.mysql.com&#x2F;doc&#x2F;mysql&#x2F;en&#x2F;server-system-variables.html</span><br><span class="line"></span><br><span class="line">[mysqld_safe]</span><br><span class="line">pid-file &#x3D; &#x2F;var&#x2F;run&#x2F;mysqld&#x2F;mysqld.pid</span><br><span class="line">socket   &#x3D; &#x2F;var&#x2F;run&#x2F;mysqld&#x2F;mysqld.sock</span><br><span class="line">nice     &#x3D; 0</span><br></pre></td></tr></table></figure>
<p><strong>mysqldump.cnf</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[mysqldump]</span><br><span class="line">quick</span><br><span class="line">default-character-set&#x3D;utf8mb4</span><br><span class="line">max_allowed_packet&#x3D;256M</span><br></pre></td></tr></table></figure>
<h3><span id="25-启动">2.5、启动</span></h3>
<p>配置文件调整完成后启动既可</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start mysqld</span><br></pre></td></tr></table></figure>
<p>启动完成后默认 root 密码会自动生成，通过 <code>grep 'temporary password' /var/log/mysql/*</code> 查看默认密码；获得默认密码后可以通过 <code>mysqladmin -S /data/mysql/mysql.sock -u root -p password</code> 修改 root 密码。</p>
<h2><span id="三-percona-monitoring-and-management">三、Percona Monitoring and Management</span></h2>
<p>数据库创建成功后需要增加 pmm 监控，后续将会通过监控信息来调优数据库，所以数据库监控必不可少。</p>
<h3><span id="31-安装前准备">3.1、安装前准备</span></h3>
<p>pmm 监控需要使用特定用户来监控数据信息，所以需要预先为 pmm 创建用户</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">USE mysql;</span><br><span class="line">GRANT ALL PRIVILEGES ON *.* TO &#39;pmm&#39;@&#39;%&#39; IDENTIFIED BY &#39;pmm12345&#39; WITH GRANT OPTION;</span><br><span class="line">FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure>
<h3><span id="32-安装-pmm-server">3.2、安装 PMM Server</span></h3>
<p>pmm server 端推荐直接使用 docker 启动，以下为样例 docker compose</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">version: &#39;3.7&#39;</span><br><span class="line">services:</span><br><span class="line">  pmm:</span><br><span class="line">    image: percona&#x2F;pmm-server:2.1.0</span><br><span class="line">    container_name: pmm</span><br><span class="line">    restart: always</span><br><span class="line">    volumes:</span><br><span class="line">      - data:&#x2F;srv</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;80:80&quot;</span><br><span class="line">      - &quot;443:443&quot;</span><br><span class="line">volumes:</span><br><span class="line">  data:</span><br></pre></td></tr></table></figure>
<p><strong>如果想要自定义证书，请将证书复制到 volume 内的 nginx 目录下，自定义证书需要以下证书文件</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pmmserver.node ➜ tree</span><br><span class="line">.</span><br><span class="line">├── ca-certs.pem</span><br><span class="line">├── certificate.conf  # 此文件是 pmm 默认生成自签证书的配置文件，不需要关注</span><br><span class="line">├── certificate.crt</span><br><span class="line">├── certificate.key</span><br><span class="line">└── dhparam.pem</span><br></pre></td></tr></table></figure>
<p><strong>pmm server 启动后访问 <code>http(s)://IP_ADDRESS</code> 既可进入 granafa 面板，默认账户名和密码都是 <code>admin</code></strong></p>
<h3><span id="33-安装-pmm-client">3.3、安装 PMM Client</span></h3>
<p>PMM Client 同样采用 rpm 安装，下载地址 <a href="https://www.percona.com/downloads/pmm2/%EF%BC%8C%E5%BD%93%E5%89%8D%E9%87%87%E7%94%A8%E6%9C%80%E6%96%B0%E7%9A%84" target="_blank" rel="noopener">https://www.percona.com/downloads/pmm2/，当前采用最新的</a> 2.1.0 版本；rpm 下载完成后直接 <code>yum install</code> 既可。</p>
<p>rpm 安装完成后使用 <code>pmm-admin</code> 命令配置服务端地址，并添加当前 mysql 实例监控</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 配置服务端地址</span><br><span class="line">pmm-admin config --server-url https:&#x2F;&#x2F;admin:admin@pmm.mysql.node 172.16.0.11 generic mysql</span><br><span class="line"># 配置当前 mysql 实例</span><br><span class="line">pmm-admin add mysql --username&#x3D;pmm --password&#x3D;pmm12345 mysql 172.16.0.11:3306</span><br></pre></td></tr></table></figure>
<p>完成后稍等片刻既可在 pmm server 端的 granafa 中看到相关数据。</p>
<h2><span id="四-数据导入">四、数据导入</span></h2>
<p>从原始数据库 dump 相关库，并导入到新数据库既可</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># dump</span><br><span class="line">mysqldump -h 172.16.1.10 -u root -p --master-data&#x3D;2 --routines --triggers --single_transaction --databases DATABASE_NAME &gt; dump.sql</span><br><span class="line"># load</span><br><span class="line">mysql -S &#x2F;data&#x2F;mysql&#x2F;mysql.sock -u root -p &lt; dump.sql</span><br></pre></td></tr></table></figure>
<p>数据导入后重建业务用户既可</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">USE mysql;</span><br><span class="line">GRANT ALL PRIVILEGES ON *.* TO &#39;test_user&#39;@&#39;%&#39; IDENTIFIED BY &#39;test_user&#39; WITH GRANT OPTION;</span><br><span class="line">FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure>
<h2><span id="五-数据备份">五、数据备份</span></h2>
<h3><span id="51-安装-xtrabackup">5.1、安装 xtrabackup</span></h3>
<p>目前数据备份采用 Perconra xtrabackup 工具，xtrabackup 可以实现高速、压缩带增量的备份；xtrabackup 安装同样采用 rpm 方式，下载地址为 <a href="https://www.percona.com/downloads/Percona-XtraBackup-2.4/LATEST/%EF%BC%8C%E4%B8%8B%E8%BD%BD%E5%AE%8C%E6%88%90%E5%90%8E%E6%89%A7%E8%A1%8C" target="_blank" rel="noopener">https://www.percona.com/downloads/Percona-XtraBackup-2.4/LATEST/，下载完成后执行</a> <code>yum install</code> 既可</p>
<h3><span id="52-备份工具">5.2、备份工具</span></h3>
<p>目前备份工具开源在 <a href="https://github.com/gozap/mybak" target="_blank" rel="noopener">GitHub</a> 上，每次全量备份会写入 <code>.full-backup</code> 文件，增量备份会写入 <code>.inc-backup</code> 文件</p>
<h3><span id="53-配置-systemd">5.3、配置 systemd</span></h3>
<p>为了使备份自动运行，目前将定时任务配置到 systemd 中，由 systemd 调度并执行；以下为相关 systemd 配置文件</p>
<p><strong>mysql-backup-full.service</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description&#x3D;mysql full backup</span><br><span class="line">After&#x3D;network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type&#x3D;simple</span><br><span class="line">Restart&#x3D;on-failure</span><br><span class="line">ExecStart&#x3D;&#x2F;usr&#x2F;local&#x2F;bin&#x2F;mybak --backup-dir &#x2F;data&#x2F;mysql_backup --prefix mysql full</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy&#x3D;multi-user.target</span><br></pre></td></tr></table></figure>
<p><strong>mysql-backup-inc.service</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description&#x3D;mysql incremental backup</span><br><span class="line">After&#x3D;network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type&#x3D;simple</span><br><span class="line">Restart&#x3D;on-failure</span><br><span class="line">ExecStart&#x3D;&#x2F;usr&#x2F;local&#x2F;bin&#x2F;mybak --backup-dir &#x2F;data&#x2F;mysql_backup --prefix mysql inc</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy&#x3D;multi-user.target</span><br></pre></td></tr></table></figure>
<p><strong>mysql-backup-compress.service</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description&#x3D;mysql backup compress</span><br><span class="line">After&#x3D;network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type&#x3D;simple</span><br><span class="line">Restart&#x3D;on-failure</span><br><span class="line">ExecStart&#x3D;&#x2F;usr&#x2F;local&#x2F;bin&#x2F;mybak --backup-dir &#x2F;data&#x2F;mysql_backup --prefix mysql compress --clean</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy&#x3D;multi-user.target</span><br></pre></td></tr></table></figure>
<p><strong>mysql-backup-full.timer</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description&#x3D;mysql weekly full backup</span><br><span class="line"># 备份之前依赖相关目录的挂载</span><br><span class="line">After&#x3D;data.mount</span><br><span class="line">After&#x3D;data-mysql_backup.mount</span><br><span class="line"></span><br><span class="line">[Timer]</span><br><span class="line"># 目前每周日一个全量备份</span><br><span class="line">OnCalendar&#x3D;Sun *-*-* 3:00</span><br><span class="line">Persistent&#x3D;true</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy&#x3D;timers.target</span><br></pre></td></tr></table></figure>
<p><strong>mysql-backup-inc.timer</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description&#x3D;mysql weekly full backup</span><br><span class="line">After&#x3D;data.mount</span><br><span class="line">After&#x3D;data-mysql_backup.mount</span><br><span class="line"></span><br><span class="line">[Timer]</span><br><span class="line"># 每天三个增量备份</span><br><span class="line">OnCalendar&#x3D;*-*-* 9:00</span><br><span class="line">OnCalendar&#x3D;*-*-* 13:00</span><br><span class="line">OnCalendar&#x3D;*-*-* 18:00</span><br><span class="line">Persistent&#x3D;true</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy&#x3D;timers.target</span><br></pre></td></tr></table></figure>
<p><strong>mysql-backup-compress.timer</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description&#x3D;mysql weekly backup compress</span><br><span class="line"># 备份之前依赖相关目录的挂载</span><br><span class="line">After&#x3D;data.mount</span><br><span class="line">After&#x3D;data-mysql_backup.mount</span><br><span class="line"></span><br><span class="line">[Timer]</span><br><span class="line"># 目前每周日一个全量备份，自动压缩后同时完成清理</span><br><span class="line">OnCalendar&#x3D;Sun *-*-* 5:00</span><br><span class="line">Persistent&#x3D;true</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy&#x3D;timers.target</span><br></pre></td></tr></table></figure>
<p>创建好相关文件后启动相关定时器既可</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cp *.timer *.service &#x2F;lib&#x2F;systemd&#x2F;system</span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start mysql-backup-full.timer mysql-backup-inc.timer mysql-backup-compress.timer</span><br><span class="line">systemctl enable mysql-backup-full.timer mysql-backup-inc.timer mysql-backup-compress.timer</span><br></pre></td></tr></table></figure>
<h2><span id="六-数据恢复">六、数据恢复</span></h2>
<h3><span id="61-全量备份恢复">6.1、全量备份恢复</span></h3>
<p>针对于全量备份，只需要按照官方文档的还原顺序进行还原既可</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 由于备份时进行了压缩，所以先解压备份文件</span><br><span class="line">xtrabackup --decompress --parallel 4 --target-dir &#x2F;data&#x2F;mysql_backup&#x2F;mysql-20191205230502</span><br><span class="line"># 执行预处理</span><br><span class="line">xtrabackup --prepare --target-dir &#x2F;data&#x2F;mysql_backup&#x2F;mysql-20191205230502</span><br><span class="line"># 执行恢复(恢复时自动根据 my.cnf 将数据覆盖到 data 数据目录)</span><br><span class="line">xtrabackup --copy-back --target-dir &#x2F;data&#x2F;mysql_backup&#x2F;mysql-20191205230502</span><br><span class="line"># 修复数据目录权限</span><br><span class="line">chown -R mysql:mysql &#x2F;data&#x2F;mysql</span><br><span class="line"># 启动 mysql</span><br><span class="line">systemctl start mysqld</span><br></pre></td></tr></table></figure>
<h3><span id="62-增量备份恢复">6.2、增量备份恢复</span></h3>
<p>对于增量备份恢复，其与全量备份恢复的根本区别在于: <strong>对于非最后一个增量文件的预处理必须使用 <code>--apply-log-only</code> 选项防止运行回滚阶段的处理</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># 对所有备份文件进行解压处理</span><br><span class="line">for dir in &#96;ls&#96;; do xtrabackup --decompress --parallel 4 --target-dir $dir; done</span><br><span class="line"># 对全量备份文件执行预处理(注意增加 --apply-log-only 选项)</span><br><span class="line">xtrabackup --prepare --apply-log-only --target-dir &#x2F;data&#x2F;mysql_backup&#x2F;mysql-20191205230502</span><br><span class="line"># 对非最后一个增量备份执行预处理</span><br><span class="line">xtrabackup --prepare --apply-log-only --target-dir &#x2F;data&#x2F;mysql_backup&#x2F;mysql-20191205230502 --incremental-dir &#x2F;data&#x2F;mysql_backup&#x2F;mysql-inc-20191206230802</span><br><span class="line"># 对最后一个增量备份执行预处理(不需要 --apply-log-only)</span><br><span class="line">xtrabackup --prepare --target-dir &#x2F;data&#x2F;mysql_backup&#x2F;mysql-20191205230502 --incremental-dir &#x2F;data&#x2F;mysql_backup&#x2F;mysql-inc-20191207031005</span><br><span class="line"># 执行恢复(恢复时自动根据 my.cnf 将数据覆盖到 data 数据目录)</span><br><span class="line">xtrabackup --copy-back --target-dir &#x2F;data&#x2F;mysql_backup&#x2F;mysql-20191205230502</span><br><span class="line"># 修复数据目录权限</span><br><span class="line">chown -R mysql:mysql &#x2F;data&#x2F;mysql</span><br><span class="line"># 启动 mysql</span><br><span class="line">systemctl start mysqld</span><br></pre></td></tr></table></figure>
<h3><span id="63-创建-slave">6.3、创建 slave</span></h3>
<p>针对 xtrabackup 备份的数据可以直接恢复成 slave 节点，具体步骤如下:</p>
<p>首先将备份文件复制到目标机器，然后执行解压(默认备份工具采用 lz4 压缩)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xtrabackup --decompress --target-dir&#x3D;xxxxxx</span><br></pre></td></tr></table></figure>
<p>解压完成后执行预处理操作(<strong>在执行预处理之前请确保 slave 机器上相关配置文件与 master 相同，并且处理好数据目录存放等</strong>)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xtrabackup --user&#x3D;root --password&#x3D;xxxxxxx --prepare --target-dir&#x3D;xxxx</span><br></pre></td></tr></table></figure>
<p>预处理成功后便可执行恢复，以下命令将自动读取 <code>my.cnf</code> 配置，自动识别数据目录位置并将数据文件移动到该位置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xtrabackup --move-back --target-dir&#x3D;xxxxx</span><br></pre></td></tr></table></figure>
<p>所由准备就绪后需要进行权限修复</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chown -R mysql:mysql MYSQL_DATA_DIR</span><br></pre></td></tr></table></figure>
<p>最后在 mysql 内启动 slave 既可，slave 信息可通过从数据备份目录的 <code>xtrabackup_binlog_info</code> 中获取</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># 获取备份 POS 信息</span><br><span class="line">cat xxxxxx&#x2F;xtrabackup_binlog_info</span><br><span class="line"></span><br><span class="line"># 创建 slave 节点</span><br><span class="line">CHANGE MASTER TO</span><br><span class="line">    MASTER_HOST&#x3D;&#39;192.168.2.48&#39;,</span><br><span class="line">    MASTER_USER&#x3D;&#39;repl&#39;,</span><br><span class="line">    MASTER_PASSWORD&#x3D;&#39;xxxxxxx&#39;,</span><br><span class="line">    MASTER_LOG_FILE&#x3D;&#39;mysql-bin.000005&#39;,</span><br><span class="line">    MASTER_LOG_POS&#x3D;52500595;</span><br><span class="line"></span><br><span class="line"># 启动 slave</span><br><span class="line">start slave;</span><br><span class="line">show slave status \G;</span><br></pre></td></tr></table></figure>
<h2><span id="七-生产处理">七、生产处理</span></h2>
<h3><span id="71-数据目录">7.1、数据目录</span></h3>
<p>目前生产环境数据目录位置调整到 <code>/home/mysql</code>，所以目录权限处理也要做对应调整</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p &#x2F;var&#x2F;log&#x2F;mysql &#x2F;home&#x2F;mysql_tmp</span><br><span class="line">chown -R mysql:mysql &#x2F;var&#x2F;log&#x2F;mysql &#x2F;home&#x2F;mysql_tmp</span><br></pre></td></tr></table></figure>
<h3><span id="72-配置文件">7.2、配置文件</span></h3>
<p>生产环境目前节点配置如下</p>
<ul>
<li>CPU: <code>Intel(R) Xeon(R) CPU E5-2620 v4 @ 2.10GHz</code></li>
<li>RAM: <code>128G</code></li>
</ul>
<p>所以配置文件也需要做相应的优化调整</p>
<p><strong>mysql.cnf</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[mysql]</span><br><span class="line">auto-rehash</span><br><span class="line">default_character_set&#x3D;utf8mb4</span><br></pre></td></tr></table></figure>
<p><strong>mysqld.cnf</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br></pre></td><td class="code"><pre><span class="line"># Percona Server template configuration</span><br><span class="line"></span><br><span class="line">[mysqld]</span><br><span class="line">#</span><br><span class="line"># Remove leading # and set to the amount of RAM for the most important data</span><br><span class="line"># cache in MySQL. Start at 70% of total RAM for dedicated server, else 10%.</span><br><span class="line"># innodb_buffer_pool_size &#x3D; 128M</span><br><span class="line">#</span><br><span class="line"># Remove leading # to turn on a very important data integrity option: logging</span><br><span class="line"># changes to the binary log between backups.</span><br><span class="line"># log_bin</span><br><span class="line">#</span><br><span class="line"># Remove leading # to set options mainly useful for reporting servers.</span><br><span class="line"># The server defaults are faster for transactions and fast SELECTs.</span><br><span class="line"># Adjust sizes as needed, experiment to find the optimal values.</span><br><span class="line"># join_buffer_size &#x3D; 128M</span><br><span class="line"># sort_buffer_size &#x3D; 2M</span><br><span class="line"># read_rnd_buffer_size &#x3D; 2M</span><br><span class="line">port&#x3D;3306</span><br><span class="line">datadir&#x3D;&#x2F;home&#x2F;mysql&#x2F;mysql</span><br><span class="line">socket&#x3D;&#x2F;home&#x2F;mysql&#x2F;mysql&#x2F;mysql.sock</span><br><span class="line">pid_file&#x3D;&#x2F;home&#x2F;mysql&#x2F;mysql&#x2F;mysqld.pid</span><br><span class="line"></span><br><span class="line"># 服务端编码</span><br><span class="line">character_set_server&#x3D;utf8mb4</span><br><span class="line"># 服务端排序</span><br><span class="line">collation_server&#x3D;utf8mb4_general_ci</span><br><span class="line"># 强制使用 utf8mb4 编码集，忽略客户端设置</span><br><span class="line">skip_character_set_client_handshake&#x3D;1</span><br><span class="line"># 日志输出到文件</span><br><span class="line">log_output&#x3D;FILE</span><br><span class="line"># 开启常规日志输出</span><br><span class="line">general_log&#x3D;1</span><br><span class="line"># 常规日志输出文件位置</span><br><span class="line">general_log_file&#x3D;&#x2F;var&#x2F;log&#x2F;mysql&#x2F;mysqld.log</span><br><span class="line"># 错误日志位置</span><br><span class="line">log_error&#x3D;&#x2F;var&#x2F;log&#x2F;mysql&#x2F;mysqld-error.log</span><br><span class="line"># 记录慢查询</span><br><span class="line">slow_query_log&#x3D;1</span><br><span class="line"># 慢查询时间(大于 1s 被视为慢查询)</span><br><span class="line">long_query_time&#x3D;1</span><br><span class="line"># 慢查询日志文件位置</span><br><span class="line">slow_query_log_file&#x3D;&#x2F;var&#x2F;log&#x2F;mysql&#x2F;mysqld-slow.log</span><br><span class="line"># 临时文件位置</span><br><span class="line">tmpdir&#x3D;&#x2F;home&#x2F;mysql&#x2F;mysql_tmp</span><br><span class="line"># The number of open tables for all threads.(refs https:&#x2F;&#x2F;dev.mysql.com&#x2F;doc&#x2F;refman&#x2F;5.7&#x2F;en&#x2F;server-system-variables.html#sysvar_table_open_cache)</span><br><span class="line">table_open_cache&#x3D;16384</span><br><span class="line"># 文件描述符(此处修改不生效，请修改 systemd service 配置) </span><br><span class="line"># refs https:&#x2F;&#x2F;www.percona.com&#x2F;blog&#x2F;2017&#x2F;10&#x2F;12&#x2F;open_files_limit-mystery&#x2F;</span><br><span class="line"># refs https:&#x2F;&#x2F;www.cnblogs.com&#x2F;wxxjianchi&#x2F;p&#x2F;10370419.html</span><br><span class="line">#open_files_limit&#x3D;65535</span><br><span class="line"># 表定义缓存(5.7 以后自动调整)</span><br><span class="line"># refs https:&#x2F;&#x2F;dev.mysql.com&#x2F;doc&#x2F;refman&#x2F;5.6&#x2F;en&#x2F;server-system-variables.html#sysvar_table_definition_cache</span><br><span class="line"># refs http:&#x2F;&#x2F;mysql.taobao.org&#x2F;monthly&#x2F;2015&#x2F;08&#x2F;10&#x2F;</span><br><span class="line">#table_definition_cache&#x3D;16384</span><br><span class="line">sort_buffer_size&#x3D;1M</span><br><span class="line">join_buffer_size&#x3D;1M</span><br><span class="line"># MyiSAM 引擎专用(内部临时磁盘表可能会用)</span><br><span class="line">read_buffer_size&#x3D;1M</span><br><span class="line">read_rnd_buffer_size&#x3D;1M</span><br><span class="line"># MyiSAM 引擎专用(内部临时磁盘表可能会用)</span><br><span class="line">key_buffer_size&#x3D;32M</span><br><span class="line"># MyiSAM 引擎专用(内部临时磁盘表可能会用)</span><br><span class="line">bulk_insert_buffer_size&#x3D;16M</span><br><span class="line"># myisam_sort_buffer_size 与 sort_buffer_size 区别请参考(https:&#x2F;&#x2F;stackoverflow.com&#x2F;questions&#x2F;7871027&#x2F;myisam-sort-buffer-size-vs-sort-buffer-size)</span><br><span class="line">myisam_sort_buffer_size&#x3D;64M</span><br><span class="line"># 内部内存临时表大小</span><br><span class="line">tmp_table_size&#x3D;32M</span><br><span class="line"># 用户创建的 MEMORY 表最大大小(tmp_table_size 受此值影响)</span><br><span class="line">max_heap_table_size&#x3D;32M</span><br><span class="line"># 开启查询缓存</span><br><span class="line">query_cache_type&#x3D;1</span><br><span class="line"># 查询缓存大小</span><br><span class="line">query_cache_size&#x3D;32M</span><br><span class="line"># sql mode</span><br><span class="line">sql_mode&#x3D;&#39;STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION&#39;</span><br><span class="line"></span><br><span class="line">########### Network ###########</span><br><span class="line"># 最大连接数(该参数受到最大文件描述符影响，如果不生效请检查最大文件描述符设置)</span><br><span class="line"># refs https:&#x2F;&#x2F;stackoverflow.com&#x2F;questions&#x2F;39976756&#x2F;the-max-connections-in-mysql-5-7</span><br><span class="line">max_connections&#x3D;1500</span><br><span class="line"># mysql 堆栈内暂存的链接数量</span><br><span class="line"># 当短时间内链接数量超过 max_connections 时，部分链接会存储在堆栈内，存储数量受此参数控制</span><br><span class="line">back_log&#x3D;256</span><br><span class="line"># 最大链接错误，针对于 client 主机，超过此数量的链接错误将会导致 mysql server 针对此主机执行锁定(禁止链接 ERROR 1129 )</span><br><span class="line"># 此错误计数仅在 mysql 链接握手失败才会计算，一般出现问题时都是网络故障</span><br><span class="line"># refs https:&#x2F;&#x2F;www.cnblogs.com&#x2F;kerrycode&#x2F;p&#x2F;8405862.html</span><br><span class="line">max_connect_errors&#x3D;100000</span><br><span class="line"># mysql server 允许的最大数据包大小</span><br><span class="line">max_allowed_packet&#x3D;64M</span><br><span class="line"># 交互式客户端链接超时(30分钟自动断开)</span><br><span class="line">interactive_timeout&#x3D;1800</span><br><span class="line"># 非交互式链接超时时间(10分钟)</span><br><span class="line"># 如果客户端有连接池，则需要协商此参数(refs https:&#x2F;&#x2F;database.51cto.com&#x2F;art&#x2F;201909&#x2F;603519.htm)</span><br><span class="line">wait_timeout&#x3D;28800</span><br><span class="line"># 跳过外部文件系统锁定</span><br><span class="line"># If you run multiple servers that use the same database directory (not recommended), </span><br><span class="line"># each server must have external locking enabled.</span><br><span class="line"># refs https:&#x2F;&#x2F;dev.mysql.com&#x2F;doc&#x2F;refman&#x2F;5.7&#x2F;en&#x2F;external-locking.html</span><br><span class="line">skip_external_locking&#x3D;1</span><br><span class="line"># 跳过链接的域名解析(开启此选项后 mysql 用户授权的 host 方式失效)</span><br><span class="line">skip_name_resolve&#x3D;0</span><br><span class="line"># 禁用主机名缓存，每次都会走 DNS</span><br><span class="line">host_cache_size&#x3D;0</span><br><span class="line"></span><br><span class="line">########### REPL ###########</span><br><span class="line"># 开启 binlog</span><br><span class="line">log_bin&#x3D;mysql-bin</span><br><span class="line"># 作为从库时，同步信息依然写入 binlog，方便此从库再作为其他从库的主库</span><br><span class="line">log_slave_updates&#x3D;1</span><br><span class="line"># server id，默认为 ipv4 地址去除第一段</span><br><span class="line"># eg: 192.168.2.48 &#x3D;&gt; 168248</span><br><span class="line">server_id&#x3D;168248</span><br><span class="line"># 每 n 次事务 binlog 刷新到磁盘</span><br><span class="line"># refs http:&#x2F;&#x2F;liyangliang.me&#x2F;posts&#x2F;2014&#x2F;03&#x2F;innodb_flush_log_at_trx_commit-and-sync_binlog&#x2F;</span><br><span class="line">sync_binlog&#x3D;100</span><br><span class="line"># binlog 格式(refs https:&#x2F;&#x2F;zhuanlan.zhihu.com&#x2F;p&#x2F;33504555)</span><br><span class="line">binlog_format&#x3D;row</span><br><span class="line"># binlog 自动清理时间</span><br><span class="line">expire_logs_days&#x3D;20</span><br><span class="line"># 开启 relay-log，一般作为 slave 时开启</span><br><span class="line">relay_log&#x3D;mysql-replay</span><br><span class="line"># 主从复制时跳过 test 库</span><br><span class="line">replicate_ignore_db&#x3D;test</span><br><span class="line"># 每个 session binlog 缓存</span><br><span class="line">binlog_cache_size&#x3D;4M</span><br><span class="line"># binlog 滚动大小</span><br><span class="line">max_binlog_size&#x3D;1024M</span><br><span class="line"># GTID 相关(refs https:&#x2F;&#x2F;keithlan.github.io&#x2F;2016&#x2F;06&#x2F;23&#x2F;gtid&#x2F;)</span><br><span class="line">#gtid_mode&#x3D;1</span><br><span class="line">#enforce_gtid_consistency&#x3D;1</span><br><span class="line"></span><br><span class="line">########### InnoDB ###########</span><br><span class="line"># 永久表默认存储引擎</span><br><span class="line">default_storage_engine&#x3D;InnoDB</span><br><span class="line"># 系统表空间数据文件大小(初始化为 1G，并且自动增长)</span><br><span class="line">innodb_data_file_path&#x3D;ibdata1:1G:autoextend</span><br><span class="line"># InnoDB 缓存池大小(资源充足，为所欲为)</span><br><span class="line"># innodb_buffer_pool_size 必须等于 innodb_buffer_pool_chunk_size*innodb_buffer_pool_instances，或者是其整数倍</span><br><span class="line"># refs https:&#x2F;&#x2F;dev.mysql.com&#x2F;doc&#x2F;refman&#x2F;5.7&#x2F;en&#x2F;innodb-buffer-pool-resize.html</span><br><span class="line"># refs https:&#x2F;&#x2F;zhuanlan.zhihu.com&#x2F;p&#x2F;60089484</span><br><span class="line">innodb_buffer_pool_size&#x3D;61440M</span><br><span class="line">innodb_buffer_pool_instances&#x3D;16</span><br><span class="line"># 默认 128M</span><br><span class="line">innodb_buffer_pool_chunk_size&#x3D;128M</span><br><span class="line"># InnoDB 强制恢复(refs https:&#x2F;&#x2F;www.askmaclean.com&#x2F;archives&#x2F;mysql-innodb-innodb_force_recovery.html)</span><br><span class="line">innodb_force_recovery&#x3D;0</span><br><span class="line"># InnoDB buffer 预热(refs http:&#x2F;&#x2F;www.dbhelp.net&#x2F;2017&#x2F;01&#x2F;12&#x2F;mysql-innodb-buffer-pool-warmup.html)</span><br><span class="line">innodb_buffer_pool_dump_at_shutdown&#x3D;1</span><br><span class="line">innodb_buffer_pool_load_at_startup&#x3D;1</span><br><span class="line"># InnoDB 日志组中的日志文件数</span><br><span class="line">innodb_log_files_in_group&#x3D;2</span><br><span class="line"># InnoDB redo 日志大小</span><br><span class="line"># refs https:&#x2F;&#x2F;www.percona.com&#x2F;blog&#x2F;2017&#x2F;10&#x2F;18&#x2F;chose-mysql-innodb_log_file_size&#x2F;</span><br><span class="line">innodb_log_file_size&#x3D;256MB</span><br><span class="line"># 缓存还未提交的事务的缓冲区大小</span><br><span class="line">innodb_log_buffer_size&#x3D;16M</span><br><span class="line"># InnoDB 在事务提交后的日志写入频率</span><br><span class="line"># refs http:&#x2F;&#x2F;liyangliang.me&#x2F;posts&#x2F;2014&#x2F;03&#x2F;innodb_flush_log_at_trx_commit-and-sync_binlog&#x2F;</span><br><span class="line">innodb_flush_log_at_trx_commit&#x3D;2</span><br><span class="line"># InnoDB DML 操作行级锁等待时间</span><br><span class="line"># 超时返回 ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction</span><br><span class="line"># refs https:&#x2F;&#x2F;ningyu1.github.io&#x2F;site&#x2F;post&#x2F;75-mysql-lock-wait-timeout-exceeded&#x2F;</span><br><span class="line">innodb_lock_wait_timeout&#x3D;30</span><br><span class="line"># InnoDB 行级锁超时是否回滚整个事务，默认为 OFF 仅回滚上一条语句</span><br><span class="line"># 此时应用程序可以接受到错误后选择是否继续提交事务(并没有违反 ACID 原子性)</span><br><span class="line"># refs https:&#x2F;&#x2F;www.cnblogs.com&#x2F;hustcat&#x2F;archive&#x2F;2012&#x2F;11&#x2F;18&#x2F;2775487.html</span><br><span class="line">#innodb_rollback_on_timeout&#x3D;ON</span><br><span class="line"># InnoDB 数据写入磁盘的方式，具体见博客文章</span><br><span class="line"># refs https:&#x2F;&#x2F;www.cnblogs.com&#x2F;gomysql&#x2F;p&#x2F;3595806.html</span><br><span class="line">innodb_flush_method&#x3D;O_DIRECT</span><br><span class="line"># InnoDB 缓冲池脏页刷新百分比</span><br><span class="line"># refs https:&#x2F;&#x2F;dbarobin.com&#x2F;2015&#x2F;08&#x2F;29&#x2F;mysql-optimization-under-ssd</span><br><span class="line">innodb_max_dirty_pages_pct&#x3D;50</span><br><span class="line"># InnoDB 每秒执行的写IO量</span><br><span class="line"># refs https:&#x2F;&#x2F;www.centos.bz&#x2F;2016&#x2F;11&#x2F;mysql-performance-tuning-15-config-item&#x2F;#10.INNODB_IO_CAPACITY,%20INNODB_IO_CAPACITY_MAX</span><br><span class="line"># refs https:&#x2F;&#x2F;www.alibabacloud.com&#x2F;blog&#x2F;testing-io-performance-with-sysbench_594709</span><br><span class="line">innodb_io_capacity&#x3D;8000</span><br><span class="line">innodb_io_capacity_max&#x3D;16000</span><br><span class="line"># 请求并发 InnoDB 线程数</span><br><span class="line"># refs https:&#x2F;&#x2F;www.cnblogs.com&#x2F;xinysu&#x2F;p&#x2F;6439715.html#_lab2_1_0</span><br><span class="line">innodb_thread_concurrency&#x3D;0</span><br><span class="line"># 再使用多个 InnoDB 表空间时，允许打开的最大 &quot;.ibd&quot; 文件个数，不设置默认 300，</span><br><span class="line"># 并且取与 table_open_cache 相比较大的一个，此选项独立于 open_files_limit</span><br><span class="line"># refs https:&#x2F;&#x2F;dev.mysql.com&#x2F;doc&#x2F;refman&#x2F;5.7&#x2F;en&#x2F;innodb-parameters.html#sysvar_innodb_open_files</span><br><span class="line">innodb_open_files&#x3D;65535</span><br><span class="line"># 每个 InnoDB 表都存储在独立的表空间(.ibd)中</span><br><span class="line">innodb_file_per_table&#x3D;1</span><br><span class="line"># 事务级别(可重复读，会出幻读)</span><br><span class="line">transaction_isolation&#x3D;REPEATABLE-READ</span><br><span class="line"># 是否在搜索和索引扫描中使用间隙锁(gap locking)，不建议使用未来将删除</span><br><span class="line">innodb_locks_unsafe_for_binlog&#x3D;0</span><br><span class="line"># InnoDB 后台清理线程数，更大的值有助于 DML 执行性能，&gt;&#x3D; 5.7.8 默认为 4</span><br><span class="line">innodb_purge_threads&#x3D;4</span><br></pre></td></tr></table></figure>
<p><strong>mysqld_safe.cnf</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#</span><br><span class="line"># The Percona Server 5.7 configuration file.</span><br><span class="line">#</span><br><span class="line"># One can use all long options that the program supports.</span><br><span class="line"># Run program with --help to get a list of available options and with</span><br><span class="line"># --print-defaults to see which it would actually understand and use.</span><br><span class="line">#</span><br><span class="line"># For explanations see</span><br><span class="line"># http:&#x2F;&#x2F;dev.mysql.com&#x2F;doc&#x2F;mysql&#x2F;en&#x2F;server-system-variables.html</span><br><span class="line"></span><br><span class="line">[mysqld_safe]</span><br><span class="line">pid-file &#x3D; &#x2F;var&#x2F;run&#x2F;mysqld&#x2F;mysqld.pid</span><br><span class="line">socket   &#x3D; &#x2F;var&#x2F;run&#x2F;mysqld&#x2F;mysqld.sock</span><br><span class="line">nice     &#x3D; 0</span><br></pre></td></tr></table></figure>
<p><strong>mysqldump.cnf</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[mysqldump]</span><br><span class="line">quick</span><br><span class="line">default-character-set&#x3D;utf8mb4</span><br><span class="line">max_allowed_packet&#x3D;256M</span><br></pre></td></tr></table></figure>
<h2><span id="八-常用诊断">八、常用诊断</span></h2>
<h3><span id="81-动态配置-diff">8.1、动态配置 diff</span></h3>
<p>mysql 默认允许在实例运行后使用 <code>set global VARIABLES=VALUE</code> 的方式动态调整一些配置，这可能导致在运行一段时间后(运维动态修改)实例运行配置和配置文件中配置不一致；所以<strong>建议定期 diff 运行时配置与配置文件配置差异，防制特殊情况下 mysql 重启后运行期配置丢失</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pt-config-diff &#x2F;etc&#x2F;percona-server.conf.d&#x2F;mysqld.cnf h&#x3D;127.0.0.1 --user root --ask-pass --report-width 100</span><br><span class="line">Enter MySQL password:</span><br><span class="line">2 config differences</span><br><span class="line">Variable                  &#x2F;etc&#x2F;percona-server.conf.d&#x2F;mysqld.cnf mysql47.test.com</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">innodb_max_dirty_pages... 50                                    50.000000</span><br><span class="line">skip_name_resolve         0                                     ON</span><br></pre></td></tr></table></figure>
<h3><span id="82-配置优化建议">8.2、配置优化建议</span></h3>
<p>Percona Toolkit 提供了一个诊断工具，用于对 mysql 内的配置进行扫描并给出优化建议，在初始化时可以使用此工具评估 mysql 当前配置的具体情况</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">pt-variable-advisor 127.0.0.1 --user root --ask-pass | grep -v &#39;^$&#39;</span><br><span class="line">Enter password: </span><br><span class="line"></span><br><span class="line"># WARN delay_key_write: MyISAM index blocks are never flushed until necessary.</span><br><span class="line"># WARN innodb_flush_log_at_trx_commit-1: InnoDB is not configured in strictly ACID mode.</span><br><span class="line"># NOTE innodb_max_dirty_pages_pct: The innodb_max_dirty_pages_pct is lower than the default.</span><br><span class="line"># WARN max_connections: If the server ever really has more than a thousand threads running, then the system is likely to spend more time scheduling threads than really doing useful work.</span><br><span class="line"># NOTE read_buffer_size-1: The read_buffer_size variable should generally be left at its default unless an expert determines it is necessary to change it.</span><br><span class="line"># NOTE read_rnd_buffer_size-1: The read_rnd_buffer_size variable should generally be left at its default unless an expert determines it is necessary to change it.</span><br><span class="line"># NOTE sort_buffer_size-1: The sort_buffer_size variable should generally be left at its default unless an expert determines it is necessary to change it.</span><br><span class="line"># NOTE innodb_data_file_path: Auto-extending InnoDB files can consume a lot of disk space that is very difficult to reclaim later.</span><br><span class="line"># WARN myisam_recover_options: myisam_recover_options should be set to some value such as BACKUP,FORCE to ensure that table corruption is noticed.</span><br><span class="line"># WARN sync_binlog: Binary logging is enabled, but sync_binlog isn&#39;t configured so that every transaction is flushed to the binary log for durability.</span><br></pre></td></tr></table></figure>
<h3><span id="83-死锁诊断">8.3、死锁诊断</span></h3>
<p>使用 pt-deadlock-logger 工具可以诊断当前的死锁状态，以下为对死锁检测的测试</p>
<p>首先创建测试数据库和表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 创建测试库</span><br><span class="line">CREATE DATABASE dbatest CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;</span><br><span class="line"># 切换到测试库并建立测试表</span><br><span class="line">USE dbatest;</span><br><span class="line">CREATE TABLE IF NOT EXISTS test (id INT AUTO_INCREMENT PRIMARY KEY, value VARCHAR(255), createtime TIMESTAMP DEFAULT CURRENT_TIMESTAMP) ENGINE&#x3D;INNODB;</span><br></pre></td></tr></table></figure>
<p>在一个其他终端上开启 pt-deadlock-logger 检测</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pt-deadlock-logger 127.0.0.1 --user root --ask-pass --tab</span><br></pre></td></tr></table></figure>
<p>检测开启后进行死锁测试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"># 插入两条测试数据</span><br><span class="line">INSERT INTO test(value) VALUES(&#39;test1&#39;);</span><br><span class="line">INSERT INTO test(value) VALUES(&#39;test2&#39;);</span><br><span class="line"># 在两个终端下进行交叉事务</span><br><span class="line"></span><br><span class="line"># 统一关闭自动提交</span><br><span class="line">terminal_1 # SET AUTOCOMMIT &#x3D; 0;</span><br><span class="line">terminal_2 # SET AUTOCOMMIT &#x3D; 0;</span><br><span class="line"></span><br><span class="line"># 交叉事务，终端 1 先更新第一条数据，终端 2 先更新第二条数据</span><br><span class="line">terminal_1 # BEGIN;</span><br><span class="line">terminal_1 # UPDATE test set value&#x3D;&#39;x1&#39; where id&#x3D;1;</span><br><span class="line">terminal_2 # BEGIN;</span><br><span class="line">terminal_2 # UPDATE test set value&#x3D;&#39;x2&#39; where id&#x3D;2;</span><br><span class="line"></span><br><span class="line"># 此后终端 1 再尝试更新第二条数据，终端 2 再尝试更新第一条数据；造成等待互向释放锁的死锁</span><br><span class="line">terminal_1 # UPDATE test set value&#x3D;&#39;lock2&#39; where id&#x3D;2;</span><br><span class="line">terminal_2 # UPDATE test set value&#x3D;&#39;lock1&#39; where id&#x3D;1;</span><br><span class="line"></span><br><span class="line"># 此时由于开启了 mysql innodb 的死锁自动检测机制，会导致终端 2 弹出错误</span><br><span class="line">ERROR 1213 (40001): Deadlock found when trying to get lock; try restarting transaction</span><br><span class="line"></span><br><span class="line"># 同时 pt-deadlock-logger 有日志输出</span><br><span class="line">server  ts      thread  txn_id  txn_time        user    hostname    ip      db      tbl     idx     lock_type       lock_mode       wait_hold       victim  query</span><br><span class="line">127.0.0.1       2019-12-24T14:57:10     87      0       52      root            127.0.0.1       dbatest test    PRIMARY RECORD  X       w       0       UPDATE test set value&#x3D;&#39;lock2&#39; where id&#x3D;2</span><br><span class="line">127.0.0.1       2019-12-24T14:57:10     89      0       41      root            127.0.0.1       dbatest test    PRIMARY RECORD  X       w       1       UPDATE test set value&#x3D;&#39;lock1&#39; where id&#x3D;1</span><br></pre></td></tr></table></figure>
<h3><span id="84-查看-io-详情">8.4、查看 IO 详情</span></h3>
<p>不同于 <code>iostat</code>，<code>pt-diskstats</code> 提供了更加详细的 IO 详情统计，并且据有交互式处理，执行一下命令将会实时检测 IO 状态</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pt-diskstats --show-timestamps</span><br></pre></td></tr></table></figure>
<p>其中几个关键值含义如下(更详细的请参考官方文档 <a href="https://www.percona.com/doc/percona-toolkit/LATEST/pt-diskstats.html#output" target="_blank" rel="noopener">https://www.percona.com/doc/percona-toolkit/LATEST/pt-diskstats.html#output</a>)</p>
<ul>
<li>rd_s: 每秒平均读取次数。这是发送到基础设备的 IO 请求数。通常，此数量少于应用程序发出的逻辑IO请求的数量。更多请求可能已排队到块设备，但是其中一些请求通常在发送到磁盘之前先进行合并。</li>
<li>rd_avkb: 读取的平均大小，以千字节为单位。</li>
<li>rd_mb_s: 每秒读取的平均兆字节数。</li>
<li>rd_mrg: 在发送到物理设备之前在队列调度程序中合并在一起的读取请求的百分比。</li>
<li>rd_rt: 读取操作的平均响应时间(以毫秒为单位)；这是端到端响应时间，包括在队列中花费的时间。这是发出 IO 请求的应用程序看到的响应时间，而不是块设备下的物理磁盘的响应时间。</li>
<li>busy: 设备至少有一个请求 wall-clock 时间的比例；等同于 <code>iostat</code> 的 <code>％util</code>。</li>
<li>in_prg: 正在进行的请求数。与读写并发是从可靠数字中生成的平均值不同，该数字是一个时样本，您可以看到它可能表示请求峰值，而不是真正的长期平均值。如果此数字很大，则从本质上讲意味着设备高负载运行。</li>
<li>ios_s: 物理设备的平均吞吐量，以每秒 IO 操作(IOPS)为单位。此列显示基础设备正在处理的总 IOPS；它是 rd_s 和 wr_s 的总和。</li>
<li>qtime: 平均排队时间；也就是说，请求在发送到物理设备之前在设备调度程序队列中花费的时间。</li>
<li>stime: 平均服务时间；也就是说，请求完成在队列中的等待之后，物理设备处理请求的时间。</li>
</ul>
<h3><span id="85-重复索引优化">8.5、重复索引优化</span></h3>
<p>pt-duplicate-key-checker 工具提供了对数据库重复索引和外键的自动查找功能，工具使用如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">pt-duplicate-key-checker 127.0.0.1 --user root --ask-pass</span><br><span class="line">Enter password:</span><br><span class="line"></span><br><span class="line"># A software update is available:</span><br><span class="line"># ########################################################################</span><br><span class="line"># aaaaaa.aaaaaa_audit</span><br><span class="line"># ########################################################################</span><br><span class="line"></span><br><span class="line"># index_linkId is a duplicate of unique_linkId</span><br><span class="line"># Key definitions:</span><br><span class="line">#   KEY &#96;index_linkId&#96; (&#96;link_id&#96;)</span><br><span class="line">#   UNIQUE KEY &#96;unique_linkId&#96; (&#96;link_id&#96;),</span><br><span class="line"># Column types:</span><br><span class="line">#         &#96;link_id&#96; bigint(20) not null comment &#39;bdid&#39;</span><br><span class="line"># To remove this duplicate index, execute:</span><br><span class="line">ALTER TABLE &#96;aaaaaa.aaaaaa_audit&#96; DROP INDEX &#96;index_linkId&#96;;</span><br><span class="line"></span><br><span class="line"># ########################################################################</span><br><span class="line"># Summary of indexes</span><br><span class="line"># ########################################################################</span><br><span class="line"></span><br><span class="line"># Size Duplicate Indexes   927420</span><br><span class="line"># Total Duplicate Indexes  3</span><br><span class="line"># Total Indexes            847</span><br></pre></td></tr></table></figure>
<h3><span id="86-表统计">8.6、表统计</span></h3>
<p>pt-find 是一个很方便的表查找统计工具，默认的一些选项可以实现批量查找符合条件的表，甚至执行一些 SQL 处理命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># 批量查找大于 5G 的表，并排序</span><br><span class="line">pt-find --host 127.0.0.1 --user root --ask-pass --tablesize +5G | sort -rn</span><br><span class="line">Enter password: </span><br><span class="line"></span><br><span class="line">&#96;rss_service&#96;.&#96;test_feed_news&#96;</span><br><span class="line">&#96;db_log_history&#96;.&#96;test_mobile_click_201912&#96;</span><br><span class="line">&#96;db_log_history&#96;.&#96;test_mobile_click_201911&#96;</span><br><span class="line">&#96;db_log_history&#96;.&#96;test_mobile_click_201910&#96;</span><br><span class="line">&#96;test_dix&#96;.&#96;test_user_messages&#96;</span><br><span class="line">&#96;test_dix&#96;.&#96;test_user_link_history&#96;</span><br><span class="line">&#96;test_dix&#96;.&#96;test_mobile_click&#96;</span><br><span class="line">&#96;test_dix&#96;.&#96;test_message&#96;</span><br><span class="line">&#96;test_dix&#96;.&#96;test_link_votes&#96;</span><br><span class="line">&#96;test_dix&#96;.&#96;test_links_mobile_content&#96;</span><br><span class="line">&#96;test_dix&#96;.&#96;test_links&#96;</span><br><span class="line">&#96;test_dix&#96;.&#96;test_comment_votes&#96;</span><br><span class="line">&#96;test_dix&#96;.&#96;test_comments&#96;</span><br></pre></td></tr></table></figure>
<p>如果想要定制输出可以采用 <code>--printf</code> 选项</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">pt-find --host 127.0.0.1 --user root --ask-pass --tablesize +5G --printf &quot;%T\t%D.%N\n&quot; | sort -rn</span><br><span class="line">Enter password: </span><br><span class="line"></span><br><span class="line">13918404608     &#96;test_dix&#96;.&#96;test_links_mobile_content&#96;</span><br><span class="line">13735231488     &#96;test_dix&#96;.&#96;test_comment_votes&#96;</span><br><span class="line">12633227264     &#96;test_dix&#96;.&#96;test_user_messages&#96;</span><br><span class="line">12610174976     &#96;test_dix&#96;.&#96;test_user_link_history&#96;</span><br><span class="line">10506305536     &#96;test_dix&#96;.&#96;test_links&#96;</span><br><span class="line">9686745088      &#96;test_dix&#96;.&#96;test_message&#96;</span><br><span class="line">9603907584      &#96;rss_service&#96;.&#96;test_feed_news&#96;</span><br><span class="line">9004122112      &#96;db_log_history&#96;.&#96;test_mobile_click_201910&#96;</span><br><span class="line">8919007232      &#96;test_dix&#96;.&#96;test_comments&#96;</span><br><span class="line">8045707264      &#96;db_log_history&#96;.&#96;test_mobile_click_201912&#96;</span><br><span class="line">7855915008      &#96;db_log_history&#96;.&#96;test_mobile_click_201911&#96;</span><br><span class="line">6099566592      &#96;test_dix&#96;.&#96;test_mobile_click&#96;</span><br><span class="line">5892898816      &#96;test_dix&#96;.&#96;test_link_votes&#96;</span><br></pre></td></tr></table></figure>
<p><strong>遗憾的是目前 <code>printf</code> 格式来源与 Perl 的 <code>sprintf</code> 函数，所以支持格式有限，不过简单的格式定制已经基本实现，复杂的建议通过 awk 处理</strong>；其他的可选参数具体参考官方文档 <a href="https://www.percona.com/doc/percona-toolkit/LATEST/pt-find.html" target="_blank" rel="noopener">https://www.percona.com/doc/percona-toolkit/LATEST/pt-find.html</a></p>
<h3><span id="87-其他命令">8.7、其他命令</span></h3>
<p>迫于篇幅，其他更多的高级命令请自行查阅官方文档 <a href="https://www.percona.com/doc/percona-toolkit/LATEST/index.html" target="_blank" rel="noopener">https://www.percona.com/doc/percona-toolkit/LATEST/index.html</a></p>
<blockquote>
<p>本文转载自：「 Bleem 」，原文：<a href="https://tinyurl.com/y5snvvlp" target="_blank" rel="noopener">https://tinyurl.com/y5snvvlp</a> ，版权归原作者所有。欢迎投稿，投稿邮箱: <a href="mailto:editor@hi-linux.com">editor@hi-linux.com</a>。</p>
</blockquote>
</div>

			<script src="https://my.openwrite.cn/js/readmore.js" type="text/javascript"></script>
			<script>
			var isMobile = navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i);
			if (!isMobile) {
			    var btw = new BTWPlugin();
			    btw.init({
			        "id": "vip-container",
			        "blogId": "10135-1588830050631-449",
			        "name": "「奇妙的 Linux 世界」",
			        "qrcode": "https://www.hi-linux.com/img/wechat/mp_qrcode_12.jpg",
			        "keyword": "VIP"
			    });
			}
			</script>
		
                

                <hr>
                <!-- Pager -->
                <ul class="pager">
                    
                        <li class="previous">
                            <a href="/posts/64715.html" data-toggle="tooltip" data-placement="top" title="重磅 | 微众银行开源一款生产级云原生容器平台 Dockin">&larr; Previous Post</a>
                        </li>
                    
                    
                        <li class="next">
                            <a href="/posts/29316.html" data-toggle="tooltip" data-placement="top" title="Caddy 2.0 简明教程">Next Post &rarr;</a>
                        </li>
                    
                </ul>

                <!-- duoshuo Share start -->
                
                <!-- 多说 Share end-->

                <!-- 多说评论框 start -->
                
                <!-- 多说评论框 end -->

                <!-- disqus comment start -->
                
                <!-- disqus comment end -->

                
                    <!-- disqus 评论框 start -->
                    <div class="comment">
                        <div id="lv-container" data-id="city" data-uid="MTAyMC8yNzg2My80NDQw"></div>
                    </div>
                    <!-- disqus 评论框 end -->
                

            </div>
            
            <!-- Tabe of Content -->
            <!-- Table of Contents -->

  
    <style>
      span.toc-nav-number{
        display: none
      }
    </style>
  
    
      <aside id="sidebar">
        <div id="toc" class="toc-article">
        <strong class="toc-title">Contents</strong>
        
          <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">一、版本信息</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">2.</span> <span class="toc-nav-text">二、Percona Server 安装</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">2.1.</span> <span class="toc-nav-text">2.1、下载安装包</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">2.2.</span> <span class="toc-nav-text">2.2、安装前准备</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">2.3.</span> <span class="toc-nav-text">2.3、安装 Percona Server</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">2.4.</span> <span class="toc-nav-text">2.4、安装后调整</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">2.4.1.</span> <span class="toc-nav-text">2.4.1、硬盘调整</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">2.4.2.</span> <span class="toc-nav-text">2.4.2、目录预创建</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">2.4.3.</span> <span class="toc-nav-text">2.4.3、文件描述符调整</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">2.4.4.</span> <span class="toc-nav-text">2.4.4、配置文件调整</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">2.5.</span> <span class="toc-nav-text">2.5、启动</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">3.</span> <span class="toc-nav-text">三、Percona Monitoring and Management</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">3.1.</span> <span class="toc-nav-text">3.1、安装前准备</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">3.2.</span> <span class="toc-nav-text">3.2、安装 PMM Server</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">3.3.</span> <span class="toc-nav-text">3.3、安装 PMM Client</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">4.</span> <span class="toc-nav-text">四、数据导入</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">5.</span> <span class="toc-nav-text">五、数据备份</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">5.1.</span> <span class="toc-nav-text">5.1、安装 xtrabackup</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">5.2.</span> <span class="toc-nav-text">5.2、备份工具</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">5.3.</span> <span class="toc-nav-text">5.3、配置 systemd</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">6.</span> <span class="toc-nav-text">六、数据恢复</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">6.1.</span> <span class="toc-nav-text">6.1、全量备份恢复</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">6.2.</span> <span class="toc-nav-text">6.2、增量备份恢复</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">6.3.</span> <span class="toc-nav-text">6.3、创建 slave</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">7.</span> <span class="toc-nav-text">七、生产处理</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">7.1.</span> <span class="toc-nav-text">7.1、数据目录</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">7.2.</span> <span class="toc-nav-text">7.2、配置文件</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">8.</span> <span class="toc-nav-text">八、常用诊断</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">8.1.</span> <span class="toc-nav-text">8.1、动态配置 diff</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">8.2.</span> <span class="toc-nav-text">8.2、配置优化建议</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">8.3.</span> <span class="toc-nav-text">8.3、死锁诊断</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">8.4.</span> <span class="toc-nav-text">8.4、查看 IO 详情</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">8.5.</span> <span class="toc-nav-text">8.5、重复索引优化</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">8.6.</span> <span class="toc-nav-text">8.6、表统计</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">8.7.</span> <span class="toc-nav-text">8.7、其他命令</span></a></li></ol></li></ol>
        
        </div>
      </aside>
    

                
            <!-- Sidebar Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <!-- no hr -->
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                       
                          <a class="tag" href="/tags/#技巧" title="技巧">技巧</a>
                        
                          <a class="tag" href="/tags/#Linux" title="Linux">Linux</a>
                        
                          <a class="tag" href="/tags/#MySQL" title="MySQL">MySQL</a>
                        
                    </div>
                </section>
                

                <!-- Friends Blog -->
                
                <hr>
                <h5>FRIENDS</h5>
                <ul class="list-inline">

                    
                        <li><a href="http://www.mike.org.cn/" target="_blank">简单.生活</a></li>
                    
                        <li><a href="http://shang.qq.com/wpa/qunwpa?idkey=ea4c43493c2269428ac6ef6141de4b6d78e5ab2d41380ca4099b833b62884ee9" target="_blank">技术交流群</a></li>
                    
                        <li><a href="" target="_blank"></a></li>
                    
                        <li><a href="" target="_blank"></a></li>
                    
                </ul>
                
            </div>
        </div>
    </div>
</article>






    <!-- 来必力City版公共JS代码 start (一个网页只需插入一次) -->
    <script type="text/javascript">
       (function(d, s) {
           var j, e = d.getElementsByTagName(s)[0];
    
           if (typeof LivereTower === 'function') { return; }
    
           j = d.createElement(s);
           j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
           j.async = true;
    
           e.parentNode.insertBefore(j, e);
       })(document, 'script');
    </script>
    <noscript>为正常使用来必力评论功能请激活JavaScript</noscript>
    <!-- 来必力City版 公共JS代码 end -->



<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'hover',
          placement: 'left',
          icon: 'ℬ'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                
                    <li>
                        <a href="/atom.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                
                
                
                    <li>
                        <a target="_blank" href="https://www.zhihu.com/people/80imike">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa  fa-stack-1x fa-inverse">知</i>
                            </span>
                        </a>
                    </li>
                

                
                    <li>
                        <a target="_blank" href="http://weibo.com/2093524665">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                

                

                

                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; Mike 2021 | Hosted by <a href="https://pages.coding.me" target="_blank" rel="noopener" style="font-weight: bold">Coding Pages</a>
                    <br>
                    Theme by <a href="http://beantech.org" target="_blank" rel="noopener">BeanTech</a> 
                    <span style="display: inline-block; margin: 0 5px;">
                        <i class="fa fa-heart"></i>
                    </span> 
                    re-Ported by <a href="http://www.huweihuang.com" target="_blank" rel="noopener">胡伟煌</a> | 
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="91px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=huweihuang&repo=hexo-theme-huweihuang&type=star&count=true" >
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->

<script src="/js/jquery.min.js"></script>


<!-- Bootstrap Core JavaScript -->

<script src="/js/bootstrap.min.js"></script>


<!-- Custom Theme JavaScript -->

<script src="/js/hux-blog.min.js"></script>



<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- 
     Because of the native support for backtick-style fenced code blocks 
     right within the Markdown is landed in Github Pages, 
     From V1.6, There is no need for Highlight.js, 
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0  
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/    
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->


<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("https://www.hi-linux.com/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->




<!-- Baidu Tongji -->






	<a id="rocket" href="#top" class=""></a>
	<script type="text/javascript" src="/js/totop.js?v=1.0.0" async=""></script>
    <script type="text/javascript" src="/js/toc.js?v=1.0.0" async=""></script>
<!-- Image to hack wechat -->
<img src="https://www.hi-linux.com/img/icon_wechat.png" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

<script>(function(w,d, s, id) {w.webpushr=w.webpushr||function(){(w.webpushr.q=w.webpushr.q||[]).push(arguments)};var js, fjs = d.getElementsByTagName(s)[0];js = d.createElement(s); js.id = id;js.src = 'https://cdn.webpushr.com/app.min.js';fjs.parentNode.appendChild(js);}(window,document, 'script', 'webpushr-jssdk'));webpushr('init','BF9JK7xV9kjWTdMx2lr6RWaPfXV7wNuZaVAJ1bfIGoBNJavqLEBVFMKLubITnCA4bh2fI9iH9tMF95nXnPt7xxY');</script></body>

</html>
