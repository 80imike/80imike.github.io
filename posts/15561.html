<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="keyword"  content="Linux,运维,Nginx,Zabbix,Centos,Ansible,MySQL,Python,Docker,Kubernetes,K3s,AI,WireGuard,ELK,Haproxy,Git,Nodejs,安全,技术">
    <link rel="shortcut icon" href="/img/ironman-draw.png">
    <!-- Place this tag in your head or just before your close body tag. -->
    <script async defer src="https://buttons.github.io/buttons.js"></script>
    <title>
        
          Tailscale 开源版中文部署指南（支持无限设备数、自定义多网段 、自建中继等高级特性） - 奇妙的 Linux 世界
        
    </title>

    <link rel="canonical" href="https://www.hi-linux.com/posts/15561.html">

    <!-- Bootstrap Core CSS -->
    
<link rel="stylesheet" href="/css/bootstrap.min.css">


    <!-- Custom CSS --> 
    
<link rel="stylesheet" href="/css/beantech.min.css">

    
    <!-- Pygments Highlight CSS -->
    
<link rel="stylesheet" href="/css/highlight.css">


    
<link rel="stylesheet" href="/css/widget.css">


    
<link rel="stylesheet" href="/css/rocket.css">


    
<link rel="stylesheet" href="/css/signature.css">


    
<link rel="stylesheet" href="/css/toc.css">


    <!-- Custom Fonts -->
    <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- Hux Delete, sad but pending in China
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/
    css'>
    -->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>
<meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="奇妙的 Linux 世界" type="application/atom+xml">
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">
	<!-- Modified by Yu-Hsuan Yen -->
<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        
            background-image: url('/img/header_img/building.jpg')
            /*post*/
        
    }
    
</style>

<header class="intro-header" >
    <!-- Signature -->
    <div id="signature">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                
                    <div class="post-heading">
                        <div class="tags">
                            
                              <a class="tag" href="/tags/#Linux" title="Linux">Linux</a>
                            
                              <a class="tag" href="/tags/#Tailscale" title="Tailscale">Tailscale</a>
                            
                              <a class="tag" href="/tags/#WireGuard" title="WireGuard">WireGuard</a>
                            
                        </div>
                        <h1>Tailscale 开源版中文部署指南（支持无限设备数、自定义多网段 、自建中继等高级特性）</h1>
                        <h2 class="subheading"></h2>
                        <span class="meta">
                            Posted by Mike on
                            2022-03-30
                        </span>
                    </div>
                


                </div>
            </div>
        </div>
    </div>
</header>

	
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">奇妙的 Linux 世界</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>

                    

                        
                    

                        
                    

                        
                        <li>
                            <a href="/about/">About</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/tags/">Tags</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/archive/">Archives</a>
                        </li>
                        
                    
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>


    <!-- Main Content -->
    <!-- Modify by Yu-Hsuan Yen -->

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

            <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <div id="vip-container"><p><img src="https://img.hi-linux.com/staticfile/2022-03-21-11-13-q1TRI3-2022-03-30-ooh4UE.png" alt></p>
<p>目前国家工信部在大力推动三大运营商发展 IPv6，对家用宽带而言，可以使用的 IPv4 公网 IP 会越来越少。有部分地区即使拿到了公网 IPv4 地址，也是个大内网地址，根本不是真正的公网 IP，访问家庭内网的资源将会变得越来越困难。</p>
<p>部分小伙伴可能会选择使用 frp 等针对特定协议和端口的内网穿透方案，但这种方案还是不够酸爽，无法访问家庭内网任意设备的任意端口。更佳的选择还是通过 VPN 来组建大内网。至于该选择哪种 VPN，毫无疑问肯定是 WireGuard，WireGuard 就是 VPN 的未来。<strong>我已经不止一次向大家推荐使用 WireGuard 了，我累了，不想再讲了，你爱 JB 用辣鸡 OpenVPN 之类的就用吧，你开心就好。</strong></p>
<p>WireGuard 相比于传统 VPN 的核心优势是没有 VPN 网关，所有节点之间都可以点对点（P2P）连接，也就是我之前提到的<a href="https://fuckcloudnative.io/posts/wireguard-full-mesh/#1-%E5%85%A8%E4%BA%92%E8%81%94%E6%A8%A1%E5%BC%8F%E6%9E%B6%E6%9E%84%E4%B8%8E%E9%85%8D%E7%BD%AE" target="_blank" rel="noopener">全互联模式（full mesh）</a>，效率更高，速度更快，成本更低。</p>
<p>WireGuard 目前最大的痛点就是上层应用的功能不够健全，因为 WireGuard 推崇的是 Unix 的哲学，WireGuard 本身只是一个内核级别的模块，只是一个数据平面，至于上层的更高级的功能（比如秘钥交换机制，UDP 打洞，ACL 等），需要通过用户空间的应用来实现。</p>
<a id="more"></a>
<p>所以为了基于 WireGuard 实现更完美的 VPN 工具，现在已经涌现出了很多项目在互相厮杀。笔者前段时间一直在推崇 <a href="https://fuckcloudnative.io/posts/configure-a-mesh-network-with-netmaker/" target="_blank" rel="noopener">Netmaker</a>，它通过可视化界面来配置 WireGuard 的全互联模式，它支持 UDP 打洞、多租户等各种高端功能，几乎适配所有平台，非常强大。然而现实世界是复杂的，无法保证所有的 NAT 都能打洞成功，且 Netmaker 目前还没有 fallback 机制，如果打洞失败，无法 fallback 改成走中继节点。Tailscale 在这一点上比 Netmaker 高明许多，它支持 fallback 机制，可以尽最大努力实现全互联模式，部分节点即使打洞不成功，也能通过中继节点在这个虚拟网络中畅通无阻。</p>
<p>没错，我移情别恋了，从 Netmaker 阵营转向了 Tailscale，是渣男没错了。</p>
<h2><span id="tailscale-是什么">Tailscale 是什么</span></h2>
<p>Tailscale 是一种基于 WireGuard 的虚拟组网工具，和 Netmaker 类似，<strong>最大的区别在于 Tailscale 是在用户态实现了 WireGuard 协议，而 Netmaker 直接使用了内核态的 WireGuard</strong>。所以 Tailscale 相比于内核态 WireGuard 性能会有所损失，但与 OpenVPN 之流相比还是能甩好几十条街的，Tailscale 虽然在性能上做了些许取舍，但在功能和易用性上绝对是完爆其他工具：</p>
<ol>
<li>开箱即用</li>
</ol>
<ul>
<li>无需配置防火墙</li>
<li>没有额外的配置</li>
</ul>
<ol>
<li>高安全性/私密性</li>
</ol>
<ul>
<li>自动密钥轮换</li>
<li>点对点连接</li>
<li>支持用户审查端到端的访问记录</li>
</ul>
<ol>
<li>在原有的 ICE、STUN 等 UDP 协议外，实现了 DERP TCP 协议来实现 NAT 穿透</li>
<li>基于公网的控制服务器下发 ACL 和配置，实现节点动态更新</li>
<li>通过第三方（如 Google） SSO 服务生成用户和私钥，实现身份认证</li>
</ol>
<p>简而言之，我们可以将 Tailscale 看成是更为易用、功能更完善的 WireGuard。</p>
<p><img src="https://img.hi-linux.com/staticfile/2022-03-20-14-50-Q4bWmK-2022-03-30-HyPo1B.png" alt></p>
<p>光有这些还不够，作为一个白嫖党，咱更关心的是<strong>免费</strong>与<strong>开源</strong>。</p>
<p>Tailscale 是一款商业产品，但个人用户是可以白嫖的，个人用户在接入设备不超过 20 台的情况下是可以免费使用的（虽然有一些限制，比如子网网段无法自定义，且无法设置多个子网）。除 Windows 和 macOS 的图形应用程序外，其他 Tailscale 客户端的组件（包含 Android 客户端）是在 BSD 许可下以开源项目的形式开发的，你可以在他们的 <a href="https://github.com/tailscale/" target="_blank" rel="noopener">GitHub 仓库</a>找到各个操作系统的客户端源码。</p>
<p>对于大部份用户来说，白嫖 Tailscale 已经足够了，如果你有更高的需求，比如自定义网段，可以选择付费。</p>
<p><strong>我就不想付费行不行？行，不过得往下看。</strong></p>
<h2><span id="headscale-是什么">Headscale 是什么</span></h2>
<p>Tailscale 的控制服务器是不开源的，而且对免费用户有诸多限制，这是人家的摇钱树，可以理解。好在目前有一款开源的实现叫 <a href="https://github.com/juanfont/headscale" target="_blank" rel="noopener">Headscale</a>，这也是唯一的一款，希望能发展壮大。</p>
<p>Headscale 由欧洲航天局的 Juan Font 使用 Go 语言开发，在 BSD 许可下发布，实现了 Tailscale 控制服务器的所有主要功能，可以部署在企业内部，没有任何设备数量的限制，且所有的网络流量都由自己控制。</p>
<p>目前 Headscale 还没有可视化界面，期待后续更新吧。</p>
<h2><span id="headscale-部署">Headscale 部署</span></h2>
<p>Headscale 部署很简单，推荐直接在 Linux 主机上安装。</p>
<blockquote>
<p>理论上来说只要你的 Headscale 服务可以暴露到公网出口就行，但最好不要有 NAT，所以推荐将 Headscale 部署在有公网 IP 的云主机上。</p>
</blockquote>
<p>首先需要到其 GitHub 仓库的 Release 页面下载最新版的二进制文件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ wget --output-document=/usr/<span class="built_in">local</span>/bin/headscale \</span><br><span class="line">   https://github.com/juanfont/headscale/releases/download/v&lt;HEADSCALE VERSION&gt;/headscale_&lt;HEADSCALE VERSION&gt;_linux_&lt;ARCH&gt;</span><br><span class="line"></span><br><span class="line">$ chmod +x /usr/<span class="built_in">local</span>/bin/headscale</span><br></pre></td></tr></table></figure>
<p>创建配置目录：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir -p /etc/headscale</span><br></pre></td></tr></table></figure>
<p>创建目录用来存储数据与证书：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir -p /var/lib/headscale</span><br></pre></td></tr></table></figure>
<p>创建空的 SQLite 数据库文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ touch /var/lib/headscale/db.sqlite</span><br></pre></td></tr></table></figure>
<p>创建 Headscale 配置文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://github.com/juanfont/headscale/raw/main/config-example.yaml -O /etc/headscale/config.yaml</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>修改配置文件，将 <code>server_url</code> 改为公网 IP 或域名。<strong>如果是国内服务器，域名必须要备案</strong>。我的域名无法备案，所以我就直接用公网 IP 了。</p>
</li>
<li>
<p>如果暂时用不到 DNS 功能，可以先将 <code>magic_dns</code> 设为 false。</p>
</li>
<li>
<p><code>server_url</code> 设置为 <code>http://&lt;PUBLIC_IP&gt;:8080</code>，将 <code>&lt;PUBLIC_IP&gt;</code> 替换为公网 IP 或者域名。</p>
</li>
<li>
<p>可自定义私有网段，也可同时开启 IPv4 和 IPv6：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ip_prefixes:</span></span><br><span class="line">  <span class="comment"># - fd7a:115c:a1e0::/48</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">10.1</span><span class="number">.0</span><span class="number">.0</span><span class="string">/16</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>创建 SystemD service 配置文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /etc/systemd/system/headscale.service</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=headscale controller</span><br><span class="line">After=syslog.target</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">User=headscale</span><br><span class="line">Group=headscale</span><br><span class="line">ExecStart=/usr/<span class="built_in">local</span>/bin/headscale serve</span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=5</span><br><span class="line"></span><br><span class="line"><span class="comment"># Optional security enhancements</span></span><br><span class="line">NoNewPrivileges=yes</span><br><span class="line">PrivateTmp=yes</span><br><span class="line">ProtectSystem=strict</span><br><span class="line">ProtectHome=yes</span><br><span class="line">ReadWritePaths=/var/lib/headscale /var/run/headscale</span><br><span class="line">AmbientCapabilities=CAP_NET_BIND_SERVICE</span><br><span class="line">RuntimeDirectory=headscale</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>
<p>创建 headscale 用户：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ useradd headscale -d /home/headscale -m</span><br></pre></td></tr></table></figure>
<p>修改 /var/lib/headscale 目录的 owner：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ chown -R headscale:headscale /var/lib/headscale</span><br></pre></td></tr></table></figure>
<p>修改配置文件中的 <code>unix_socket</code>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">unix_socket:</span> <span class="string">/var/run/headscale/headscale.sock</span></span><br></pre></td></tr></table></figure>
<p>Reload SystemD 以加载新的配置文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ systemctl daemon-reload</span><br></pre></td></tr></table></figure>
<p>启动 Headscale 服务并设置开机自启：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ systemctl <span class="built_in">enable</span> --now headscale</span><br></pre></td></tr></table></figure>
<p>查看运行状态：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ systemctl status headscale</span><br></pre></td></tr></table></figure>
<p>查看占用端口：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ ss -tulnp|grep headscale</span><br><span class="line"></span><br><span class="line">tcp LISTEN 0 1024 [::]:9090 [::]:* users:((<span class="string">"headscale"</span>,pi</span><br><span class="line"></span><br><span class="line">d=10899,fd=13))</span><br><span class="line"></span><br><span class="line">tcp LISTEN 0 1024 [::]:50443 [::]:* users:((<span class="string">"headscale"</span>,pi</span><br><span class="line"></span><br><span class="line">d=10899,fd=10))</span><br><span class="line"></span><br><span class="line">tcp LISTEN 0 1024 [::]:8080 [::]:* users:((<span class="string">"headscale"</span>,pi</span><br><span class="line"></span><br><span class="line">d=10899,fd=12))</span><br></pre></td></tr></table></figure>
<p>Tailscale 中有一个概念叫 tailnet，你可以理解成租户，租户与租户之间是相互隔离的，具体看参考 Tailscale 的官方文档：<a href="https://tailscale.com/kb/1136/tailnet/" target="_blank" rel="noopener">What is a tailnet</a>。Headscale 也有类似的实现叫 namespace，即命名空间。我们需要先创建一个 namespace，以便后续客户端接入，例如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ headscale namespaces create default</span><br></pre></td></tr></table></figure>
<p>查看命名空间：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ headscale namespaces list</span><br><span class="line"></span><br><span class="line">ID | Name | Created</span><br><span class="line"></span><br><span class="line">1 | default | 2022-03-09 06:12:06</span><br></pre></td></tr></table></figure>
<h2><span id="tailscale-客户端接入">Tailscale 客户端接入</span></h2>
<p>目前除了 iOS 客户端，其他平台的客户端都有办法自定义 Tailscale 的控制服务器。</p>
<table>
<thead>
<tr>
<th style="text-align:left">OS</th>
<th style="text-align:left">是否支持 Headscale</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Linux</td>
<td style="text-align:left">Yes</td>
</tr>
<tr>
<td style="text-align:left">OpenBSD</td>
<td style="text-align:left">Yes</td>
</tr>
<tr>
<td style="text-align:left">FreeBSD</td>
<td style="text-align:left">Yes</td>
</tr>
<tr>
<td style="text-align:left">macOS</td>
<td style="text-align:left">Yes</td>
</tr>
<tr>
<td style="text-align:left">Windows</td>
<td style="text-align:left">Yes 参考 <a href="https://github.com/juanfont/headscale/blob/main/docs/windows-client.md" target="_blank" rel="noopener">Windows 客户端文档</a></td>
</tr>
<tr>
<td style="text-align:left">Android</td>
<td style="text-align:left"><a href="https://github.com/juanfont/headscale/issues/58#issuecomment-950386833" target="_blank" rel="noopener">需要自己编译客户端</a></td>
</tr>
<tr>
<td style="text-align:left">iOS</td>
<td style="text-align:left">暂不支持</td>
</tr>
</tbody>
</table>
<p>我们先来看下 Linux 平台的接入。</p>
<h3><span id="linux">Linux</span></h3>
<p>Tailscale 官方提供了各种 Linux 发行版的软件包，但国内的网络你懂得，软件源根本用不了。好在官方还提供了<a href="https://tailscale.com/download/linux/static" target="_blank" rel="noopener">静态编译的二进制文件</a>，我们可以直接下载。例如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://pkgs.tailscale.com/stable/tailscale_1.22.2_amd64.tgz</span><br></pre></td></tr></table></figure>
<p>解压：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ tar zxvf tailscale_1.22.2_amd64.tgz</span><br><span class="line">x tailscale_1.22.2_amd64/</span><br><span class="line">x tailscale_1.22.2_amd64/tailscale</span><br><span class="line">x tailscale_1.22.2_amd64/tailscaled</span><br><span class="line">x tailscale_1.22.2_amd64/systemd/</span><br><span class="line">x tailscale_1.22.2_amd64/systemd/tailscaled.defaults</span><br><span class="line">x tailscale_1.22.2_amd64/systemd/tailscaled.service</span><br></pre></td></tr></table></figure>
<p>将二进制文件复制到官方软件包默认的路径下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cp tailscale_1.22.2_amd64/tailscaled /usr/sbin/tailscaled</span><br><span class="line">$ cp tailscale_1.22.2_amd64/tailscale /usr/bin/tailscale</span><br></pre></td></tr></table></figure>
<p>将 systemD service 配置文件复制到系统路径下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ cp tailscale_1.22.2_amd64/systemd/tailscaled.service /lib/systemd/system/tailscaled.service</span><br></pre></td></tr></table></figure>
<p>将环境变量配置文件复制到系统路径下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ cp tailscale_1.22.2_amd64/systemd/tailscaled.defaults /etc/default/tailscaled</span><br></pre></td></tr></table></figure>
<p>启动 tailscaled.service 并设置开机自启：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ systemctl <span class="built_in">enable</span> --now tailscaled</span><br></pre></td></tr></table></figure>
<p>查看服务状态：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ systemctl status tailscaled</span><br></pre></td></tr></table></figure>
<p>Tailscale 接入 Headscale：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将 &lt;HEADSCALE_PUB_IP&gt; 换成你的 Headscale 公网 IP 或域名</span></span><br><span class="line">$ tailscale up --login-server=http://&lt;HEADSCALE_PUB_IP&gt;:8080 --accept-routes=<span class="literal">true</span> --accept-dns=<span class="literal">false</span></span><br></pre></td></tr></table></figure>
<p>这里推荐将 DNS 功能关闭，因为它会覆盖系统的默认 DNS。如果你对 DNS 有需求，可自己研究官方文档，这里不再赘述。</p>
<p>执行完上面的命令后，会出现下面的信息：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">To authenticate, visit:</span><br><span class="line"></span><br><span class="line">http://xxxxxx:8080/register?key=905cf165204800247fbd33989dbc22be95c987286c45aac303393704</span><br><span class="line"></span><br><span class="line">1150d846</span><br></pre></td></tr></table></figure>
<p>在浏览器中打开该链接，就会出现如下的界面：</p>
<p><img src="https://img.hi-linux.com/staticfile/2022-03-20-17-06-08qWbz-2022-03-30-omWdbc.png" alt></p>
<p>将其中的命令复制粘贴到 headscale 所在机器的终端中，并将 NAMESPACE 替换为前面所创建的 namespace。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ headscale -n default nodes register --key 905cf165204800247fbd33989dbc22be95c987286c45aac3033937041150d846</span><br><span class="line">Machine register</span><br></pre></td></tr></table></figure>
<p>注册成功，查看注册的节点：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ headscale nodes list</span><br><span class="line"></span><br><span class="line">ID | Name | NodeKey | Namespace | IP addresses | Ephemeral | Last seen | Onlin</span><br><span class="line"></span><br><span class="line">e | Expired</span><br><span class="line"></span><br><span class="line">1 | coredns | [Ew3RB] | default | 10.1.0.1 | <span class="literal">false</span> | 2022-03-20 09:08:58 | onlin</span><br><span class="line"></span><br><span class="line">e | no</span><br></pre></td></tr></table></figure>
<p>回到 Tailscale 客户端所在的 Linux 主机，可以看到 Tailscale 会自动创建相关的路由表和 iptables 规则。路由表可通过以下命令查看：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ip route show table 52</span><br></pre></td></tr></table></figure>
<p>查看 iptables 规则：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ iptables -S</span><br><span class="line">-P INPUT DROP</span><br><span class="line">-P FORWARD ACCEPT</span><br><span class="line">-P OUTPUT ACCEPT</span><br><span class="line">-N ts-forward</span><br><span class="line">-N ts-input</span><br><span class="line">-A INPUT -j ts-input</span><br><span class="line">-A FORWARD -j ts-forward</span><br><span class="line">-A ts-forward -i tailscale0 -j MARK --<span class="built_in">set</span>-xmark 0x40000/0xffffffff</span><br><span class="line">-A ts-forward -m mark --mark 0x40000 -j ACCEPT</span><br><span class="line">-A ts-forward -s 100.64.0.0/10 -o tailscale0 -j DROP</span><br><span class="line">-A ts-forward -o tailscale0 -j ACCEPT</span><br><span class="line">-A ts-input -s 10.1.0.5/32 -i lo -j ACCEPT</span><br><span class="line">-A ts-input -s 100.115.92.0/23 ! -i tailscale0 -j RETURN</span><br><span class="line">-A ts-input -s 100.64.0.0/10 ! -i tailscale0 -j DROP</span><br><span class="line"></span><br><span class="line">$ iptables -S -t nat</span><br><span class="line">-P PREROUTING ACCEPT</span><br><span class="line">-P INPUT ACCEPT</span><br><span class="line">-P OUTPUT ACCEPT</span><br><span class="line">-P POSTROUTING ACCEPT</span><br><span class="line">-A ts-postrouting -m mark --mark 0x40000 -j MASQUERADE</span><br></pre></td></tr></table></figure>
<h3><span id="macos">macOS</span></h3>
<p>macOS 客户端的安装相对来说就简单多了，只需要在应用商店安装 APP 即可，前提是你<strong>需要一个美区 ID</strong>。。。</p>
<p><img src="https://img.hi-linux.com/staticfile/2022-03-20-17-33-3uRFwF-20220330100846245-2022-03-30-UU0DC4.png" alt></p>
<p>安装完成后还需要做一些骚操作，才能让 Tailscale 使用 Headscale 作为控制服务器。当然，Headscale 已经给我们提供了详细的操作步骤，你只需要在浏览器中打开 URL：<code>http://&lt;HEADSCALE_PUB_IP&gt;:8080/apple</code>，便会出现如下的界面：</p>
<p><img src="https://img.hi-linux.com/staticfile/2022-03-20-17-39-arYdfv-20220330100854600-2022-03-30-QA5zoK.png" alt></p>
<p>你只需要按照图中所述的步骤操作即可，本文就不再赘述了。</p>
<p>修改完成后重启 Tailscale 客户端，在 macOS 顶部状态栏中找到 Tailscale 并点击，然后再点击 <code>Log in</code>。</p>
<p><img src="https://img.hi-linux.com/staticfile/2022-03-20-17-43-pTW3r7-2022-03-30-lici7s.png" alt></p>
<p>然后立马就会跳转到浏览器并打开一个页面。</p>
<p><img src="https://img.hi-linux.com/staticfile/2022-03-20-17-46-AbzngB-2022-03-30-I0Dftb.png" alt></p>
<p>接下来与之前 Linux 客户端相同，回到 Headscale 所在的机器执行浏览器中的命令即可，注册成功：</p>
<p><img src="https://img.hi-linux.com/staticfile/2022-03-20-17-51-Gcjcmy-2022-03-30-kfN06l.png" alt></p>
<p>回到 Headscale 所在主机，查看注册的节点：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ headscale nodes list</span><br><span class="line"></span><br><span class="line">ID | Name | NodeKey | Namespace | IP addresses | Ephemeral | Last seen | Onlin</span><br><span class="line"></span><br><span class="line">e | Expired</span><br><span class="line"></span><br><span class="line">1 | coredns | [Ew3RB] | default | 10.1.0.1 | <span class="literal">false</span> | 2022-03-20 09:08:58 | onlin</span><br><span class="line"></span><br><span class="line">e | no</span><br><span class="line">2 | carsondemacbook-pro | [k7bzX] | default   | 10.1.0.2     | <span class="literal">false</span>     | 2022-03-20 09:48:30 | online  | no</span><br></pre></td></tr></table></figure>
<p>回到 macOS，测试是否能 ping 通对端节点：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ ping -c 2 10.1.0.1</span><br><span class="line">PING 10.1.0.1 (10.1.0.1): 56 data bytes</span><br><span class="line">64 bytes from 10.1.0.1: icmp_seq=0 ttl=64 time=37.025 ms</span><br><span class="line">64 bytes from 10.1.0.1: icmp_seq=1 ttl=64 time=38.181 ms</span><br><span class="line"></span><br><span class="line">--- 10.1.0.1 ping statistics ---</span><br><span class="line">2 packets transmitted, 2 packets received, 0.0% packet loss</span><br><span class="line">round-trip min/avg/max/stddev = 37.025/37.603/38.181/0.578 ms</span><br></pre></td></tr></table></figure>
<p>也可以使用 Tailscale CLI 来测试：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ /Applications/Tailscale.app/Contents/MacOS/Tailscale ping 10.1.0.1</span><br><span class="line">pong from coredns (10.1.0.1) via xxxx:41641 <span class="keyword">in</span> 36ms</span><br></pre></td></tr></table></figure>
<p>如果你没有美区 ID，无法安装 App，可以直接使用命令行版本，通过 Homebrew 安装即可：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ brew install tailscale</span><br></pre></td></tr></table></figure>
<h3><span id="android">Android</span></h3>
<p>Android 客户端就比较麻烦了，需要自己修改源代码编译 App，具体可参考<a href="https://github.com/juanfont/headscale/issues/58#issuecomment-950386833" target="_blank" rel="noopener">这个 issue</a>。编译过程还是比较麻烦的，需要先修改源码，然后构建一个包含编译环境的 Docker 镜像，最后在通过该镜像启动容器编译 apk。</p>
<p>我知道很多人一看麻烦就不想搞了，这个问题不大，我送佛送到西，提供了一条龙服务，你只需 fork 我的 GitHub 仓库 <a href="https://github.com/yangchuansheng/tailscale-android" target="_blank" rel="noopener">tailscale-android</a>：</p>
<p><img src="https://img.hi-linux.com/staticfile/2022-03-20-21-25-utX9zr-20220330100913552-2022-03-30-oLXzfj.png" alt></p>
<p>然后在你的仓库中点击 <strong>Settings</strong> 标签，找到 <strong>Secrets</strong> 下拉框中的 Actions 选项：</p>
<p><img src="https://img.hi-linux.com/staticfile/2022-03-20-21-32-OQT9m7-2022-03-30-X3WXc1.jpg" alt></p>
<p>选择 <strong>New repository secret</strong> 添加一个 secret 叫 <code>HEADSCALE_URL</code>，将你的 Headscale 服务公网地址填入其中：</p>
<p><img src="https://img.hi-linux.com/staticfile/2022-03-20-21-35-ep7qXR-20220330100925768-2022-03-30-wX3Vxc.png" alt></p>
<p><strong>添加在这里的配置，将只对你可见，不用担心会泄露给他人。</strong></p>
<p>然后点击 <strong>Actions</strong> 标签，选择 <strong>Release</strong> Workflow。</p>
<p><img src="https://img.hi-linux.com/staticfile/2022-03-20-21-53-CXAfAl-20220330100934764-2022-03-30-N045W9.png" alt></p>
<p>你会看到一个 <strong>Run workflow</strong> 按钮，点击它，然后在下拉框中点击 <strong>Run workflow</strong>。</p>
<p><img src="https://img.hi-linux.com/staticfile/2022-03-20-22-02-SaxiiT-20220330100941082-2022-03-30-jMUwEO.png" alt></p>
<p>流水线就会开始执行，执行成功后就会在 Release 页面看到编译好的 apk。</p>
<p><img src="https://img.hi-linux.com/staticfile/2022-03-20-22-05-wxjatP-20220330100947763-2022-03-30-XNDPE9.png" alt></p>
<p>接下来的事情就简单了，下载这个 apk 到你的 Android 手机上安装就好了。安装完成后打开 Tailscale App，选择 <strong>Sign in with other</strong>。</p>
<p><img src="https://img.hi-linux.com/staticfile/2022-03-20-22-14-34ZnDn-20220330100954238-2022-03-30-OgX2LV.jpeg" alt></p>
<p>然后就会跳出这个页面：</p>
<p><img src="https://img.hi-linux.com/staticfile/2022-03-21-11-10-jbk5KL-2022-03-30-s7wFak-2022-03-30-MhBzl0.jpeg" alt></p>
<p>将其中的命令粘贴到 Headscale 所在主机的终端，将 <strong>NAMESPACE</strong> 替换为之前创建的 namespace，然后执行命令即可。注册成功后可将该页面关闭，回到 App 主页，效果如图：</p>
<p><img src="https://img.hi-linux.com/staticfile/2022-03-20-22-19-GET2os-20220330101008543-2022-03-30-1Wfo84.jpeg" alt></p>
<p>回到之前的 GitHub 仓库，刚才我们是通过手动触发 Workflow 来编译 apk 的，有没有办法自动编译呢？<strong>只要 Tailscale 官方仓库有更新，就立即触发 Workflow 开始编译。</strong></p>
<p>那当然是可以实现的，而且我已经实现了，仔细看 GitHub Actions 的编排文件：</p>
<p><img src="https://img.hi-linux.com/staticfile/2022-03-20-22-29-QJvXwt-20220330101015867-2022-03-30-0Sh9T7.png" alt></p>
<p>红框圈出来的部分表示只要仓库的 <code>main</code> 分支有更新，便会触发 Workflow。<strong>现在的问题是如何让 main 分支和上游官方仓库一致，一直保持在最新状态。</strong></p>
<p>这个问题使用第三方 Github App 就可以解决，这个 App 名字简单粗暴，就叫 <a href="https://github.com/apps/pull" target="_blank" rel="noopener">Pull</a>，它的作用非也很简单粗暴：保持你的 Fork 在最新状态。</p>
<p>Pull 的使用方法很简单：</p>
<ol>
<li>打开 <a href="https://github.com/apps/pull" target="_blank" rel="noopener">Pull App</a> 页面</li>
<li>点击右上角绿色的 install 按钮</li>
</ol>
<p><img src="https://img.hi-linux.com/staticfile/2022-03-20-22-44-fRwr6j-20220330101027005-2022-03-30-FKoCBW.png" alt></p>
<ol>
<li>在选项页面，使用默认的 <strong>All repositories</strong> 即可（你也可以选择指定的仓库，比如 tailscale-android），然后点击绿色的 <strong>install</strong> 按钮：</li>
</ol>
<p><img src="https://img.hi-linux.com/staticfile/2022-03-20-22-46-flOKJW-2022-03-30-LfAe4V-2022-03-30-m2esZD.png" alt></p>
<p>简单三步，Pull App 就安装好了。接下来 Pull App 会每天定时帮你更新代码库，使你 fork 的代码始终是最新版的。</p>
<h3><span id="windows">Windows</span></h3>
<p>Windows Tailscale 客户端想要使用 Headscale 作为控制服务器，只需在浏览器中打开 URL：<code>http://&lt;HEADSCALE_PUB_IP&gt;:8080/windows</code>，便会出现如下的界面：</p>
<p><img src="https://img.hi-linux.com/staticfile/2022-03-20-23-30-zcQX3F-2022-03-30-OUQVcT.png" alt></p>
<p>按照其中的步骤操作即可。</p>
<h3><span id="其他-linux-发行版">其他 Linux 发行版</span></h3>
<p>除了常规的 Linux 发行版之外，还有一些特殊场景的 Linux 发行版，比如 OpenWrt、威联通（QNAP）、群晖等，这些发行版的安装方法已经有人写好了，这里就不详细描述了，我只给出相关的 GitHub 仓库，大家如果自己有需求，直接去看相关仓库的文档即可。</p>
<ul>
<li>OpenWrt：<a href="https://github.com/adyanth/openwrt-tailscale-enabler" target="_blank" rel="noopener">https://github.com/adyanth/openwrt-tailscale-enabler</a></li>
<li>群晖：<a href="https://github.com/tailscale/tailscale-synology" target="_blank" rel="noopener">https://github.com/tailscale/tailscale-synology</a></li>
<li>威联通：<a href="https://github.com/ivokub/tailscale-qpkg" target="_blank" rel="noopener">https://github.com/ivokub/tailscale-qpkg</a></li>
</ul>
<h3><span id="ios">iOS</span></h3>
<p>Tailscale iOS 客户端源代码没有开源，目前还无法破解使其使用第三方控制服务器，遗憾~~</p>
<h2><span id="打通局域网">打通局域网</span></h2>
<p>到目前为止我们只是打造了一个点对点的 Mesh 网络，各个节点之间都可以通过 WireGuard 的私有网络 IP 进行直连。但我们可以更大胆一点，还记得我在文章开头提到的访问家庭内网的资源吗？我们可以通过适当的配置让每个节点都能访问其他节点的局域网 IP。这个使用场景就比较多了，你可以直接访问家庭内网的 NAS，或者内网的任何一个服务，<strong>更高级的玩家可以使用这个方法来访问云上 Kubernetes 集群的 Pod IP 和 Service IP。</strong></p>
<p>假设你的家庭内网有一台 Linux 主机（比如 OpenWrt）安装了 Tailscale 客户端，我们希望其他 Tailscale 客户端可以直接通过家中的局域网 IP（例如 <strong>192.168.100.0/24</strong>） 访问家庭内网的任何一台设备。</p>
<p>配置方法很简单，首先需要设置 IPv4 与 IPv6 路由转发：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">'net.ipv4.ip_forward = 1'</span> | tee /etc/sysctl.d/ipforwarding.conf</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">'net.ipv6.conf.all.forwarding = 1'</span> | tee -a /etc/sysctl.d/ipforwarding.conf</span><br><span class="line">$ sysctl -p /etc/sysctl.d/ipforwarding.conf</span><br></pre></td></tr></table></figure>
<p>客户端修改注册节点的命令，在原来命令的基础上加上参数 <code>--advertise-routes=192.168.100.0/24</code>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ tailscale up --login-server=http://&lt;HEADSCALE_PUB_IP&gt;:8080 --accept-routes=<span class="literal">true</span> --accept-dns=<span class="literal">false</span> --advertise-routes=192.168.100.0/24</span><br></pre></td></tr></table></figure>
<p>在 Headscale 端查看路由，可以看到相关路由是关闭的。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ headscale nodes list|grep openwrt</span><br><span class="line"></span><br><span class="line">6 | openwrt | [7LdVc] | default | 10.1.0.6 | <span class="literal">false</span> | 2022-03-20 15:50:46 | onlin</span><br><span class="line"></span><br><span class="line">e | no</span><br><span class="line"></span><br><span class="line">$ headscale routes list -i 6</span><br><span class="line"></span><br><span class="line">Route | Enabled</span><br><span class="line"></span><br><span class="line">192.168.100.0/24 | <span class="literal">false</span></span><br></pre></td></tr></table></figure>
<p>开启路由：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ headscale routes <span class="built_in">enable</span> -i 6 -r <span class="string">"192.168.100.0/24"</span></span><br><span class="line"></span><br><span class="line">Route | Enabled</span><br><span class="line"></span><br><span class="line">192.168.100.0/24 | <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>其他节点查看路由结果：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ip route show table 52|grep <span class="string">"192.168.100.0/24"</span></span><br><span class="line">192.168.100.0/24 dev tailscale0</span><br></pre></td></tr></table></figure>
<p>现在你在任何一个 Tailscale 客户端所在的节点都可以 ping 通家庭内网的机器了，你在公司或者星巴克也可以像在家里一样用同样的 IP 随意访问家中的任何一个设备，就问你香不香？</p>
<h2><span id="总结">总结</span></h2>
<p>目前从稳定性来看，Tailscale 比 Netmaker 略胜一筹，基本上不会像 Netmaker 一样时不时出现 ping 不通的情况，这取决于 Tailscale 在用户态对 NAT 穿透所做的种种优化，他们还专门写了一篇文章介绍 <a href="https://tailscale.com/blog/how-nat-traversal-works/" target="_blank" rel="noopener">NAT 穿透的原理</a>，<a href="https://arthurchiao.art/blog/how-nat-traversal-works-zh/" target="_blank" rel="noopener">中文版</a>翻译自国内的 eBPF 大佬赵亚楠，墙裂推荐大家阅读。放一张图给大家感受一下：</p>
<p><img src="https://img.hi-linux.com/staticfile/2022-03-21-10-52-TzXGEZ-20220330101049526-2022-03-30-9Eqg5N.png" alt></p>
<p>本文给大家介绍了 Tailscale 和 Headscale，包括 Headscale 的安装部署和各个平台客户端的接入，以及如何打通各个节点所在的局域网。下篇文章将会给大家介绍如何让 Tailscale 使用自定义的 DERP Servers（也就是中继服务器），See you~~</p>
<p>上面我们介绍了如何使用 <code>Headscale</code> 替代 Tailscale 官方的控制服务器，并接入各个平台的客户端。本文将会介绍如何让 Tailscale 使用自定义的 DERP Servers。可能很多人都不知道 <code>DERP</code> 是个啥玩意儿，没关系，我先从<strong>中继服务器</strong>开始讲起。</p>
<h2><span id="stun-是什么">STUN 是什么</span></h2>
<p>Tailscale 的终极目标是让两台<strong>处于网络上的任何位置</strong>的机器建立<strong>点对点连接</strong>（直连），但现实世界是复杂的，大部份情况下机器都位于 NAT 和防火墙后面，这时候就需要通过打洞来实现直连，也就是 NAT 穿透。</p>
<p>NAT 按照 <strong>NAT 映射行为</strong>和<strong>有状态防火墙行为</strong>可以分为多种类型，但对于 NAT 穿透来说根本不需要关心这么多类型，只需要看 <strong>NAT 或者有状态防火墙是否会严格检查目标 Endpoint</strong>，根据这个因素，可以将 NAT 分为 <strong>Easy NAT</strong> 和 <strong>Hard NAT</strong>。</p>
<ul>
<li><strong>Easy NAT</strong> 及其变种称为 “Endpoint-Independent Mapping” (<strong>EIM，终点无关的映射</strong>)<br>
这里的 Endpoint 指的是目标 Endpoint，也就是说，有状态防火墙只要看到有客户端自己发起的出向包，就会允许相应的入向包进入，<strong>不管这个入向包是谁发进来的都可以</strong>。</li>
<li><strong>hard NAT</strong> 以及变种称为 “Endpoint-Dependent Mapping”（<strong>EDM，终点相关的映射</strong>）<br>
这种 NAT 会针对每个目标 Endpoint 来生成一条相应的映射关系。 在这样的设备上，如果客户端向某个目标 Endpoint 发起了出向包，假设客户端的公网 IP 是 2.2.2.2，那么有状态防火墙就会打开一个端口，假设是 4242。那么只有来自该目标 Endpoint 的入向包才允许通过 <code>2.2.2.2:4242</code>，其他客户端一律不允许。这种 NAT 更加严格，所以叫 Hard NAT。</li>
</ul>
<p>对于 Easy NAT，我们只需要提供一个第三方的服务，它能够告诉客户端“它看到的客户端的公网 ip:port 是什么”，然后将这个信息以某种方式告诉通信对端（peer），后者就知道该和哪个地址建连了！这种服务就叫 <strong>STUN</strong> (Session Traversal Utilities for NAT，NAT会话穿越应用程序)。它的工作流程如下图所示：</p>
<ul>
<li>笔记本向 STUN 服务器发送一个请求：“从你的角度看，我的地址什么？”</li>
<li>STUN 服务器返回一个响应：“我看到你的 UDP 包是从这个地址来的：<code>ip:port</code>”。</li>
</ul>
<p><img src="https://img.hi-linux.com/staticfile/2022-03-26-17-27-yqHlMG-20220330101057816-2022-03-30-PeORYt.jpg" alt></p>
<h2><span id="中继是什么">中继是什么</span></h2>
<p>对于 <strong>Hard NAT</strong> 来说，STUN 就不好使了，即使 STUN 拿到了客户端的公网 <code>ip:port</code> 告诉通信对端也于事无补，因为防火墙是和 STUN 通信才打开的缺口，这个缺口只允许 STUN 的入向包进入，其他通信对端知道了这个缺口也进不来。通常企业级 NAT 都属于 Hard NAT。</p>
<p>这种情况下打洞是不可能了，但也不能就此放弃，可以选择一种折衷的方式：创建一个中继服务器（relay server），客户端与中继服务器进行通信，中继服务器再将包中继（relay）给通信对端。</p>
<p>至于中继的性能，那要看具体情况了：</p>
<ul>
<li>如果能直连，那显然没必要用中继方式；</li>
<li>但如果无法直连，而中继路径又非常接近双方直连的真实路径，并且带宽足够大，那中继方式并不会明显降低通信质量。延迟肯定会增加一点，带宽会占用一些，但<strong>相比完全连接不上，还是可以接受的</strong>。</li>
</ul>
<p>事实上对于大部分网络而言，Tailscale 都可以通过各种黑科技打洞成功，只有极少数情况下才会选择中继，中继只是一种 fallback 机制。</p>
<h2><span id="中继协议简介">中继协议简介</span></h2>
<p>中继协议有多种实现方式。</p>
<h3><span id="turn">TURN</span></h3>
<p>TURN 即 Traversal Using Relays around NAT，这是一种经典的中继实现方式，核心理念是：</p>
<ul>
<li><strong>用户</strong>（人）先去公网上的 TURN 服务器认证，成功后后者会告诉你：“我已经为你分配了 ip:port，接下来将为你中继流量”，</li>
<li>然后将这个 ip:port 地址告诉对方，让它去连接这个地址，接下去就是非常简单的客户端/服务器通信模型了。</li>
</ul>
<p>与 STUN 不同，这种协议没有真正的交互性，不是很好用，因此 Tailscale 并没有采用 TURN 作为中继协议。</p>
<h3><span id="derp">DERP</span></h3>
<p>DERP 即 Detoured Encrypted Routing Protocol，这是 Tailscale 自研的一个协议：</p>
<ul>
<li>它是一个<strong>通用目的包中继协议，运行在 HTTP 之上</strong>，而大部分网络都是允许 HTTP 通信的。</li>
<li>它根据目的公钥（destination’s public key）来中继加密的流量（encrypted payloads）。</li>
</ul>
<p><img src="https://img.hi-linux.com/staticfile/2022-03-26-19-02-zLDv51-2022-03-30-KTRx7G.svg" alt="Tailscale 会自动选择离目标节点最近的 DERP server 来中继流量"></p>
<p>Tailscale 使用的算法很有趣，<strong>所有客户端之间的连接都是先选择 DERP 模式（中继模式），这意味着连接立即就能建立（优先级最低但 100% 能成功的模式），用户不用任何等待</strong>。然后开始并行地进行路径发现，通常几秒钟之后，我们就能发现一条更优路径，然后将现有连接透明升级（upgrade）过去，变成点对点连接（直连）。</p>
<p>因此，DERP 既是 Tailscale 在 NAT 穿透失败时的保底通信方式（此时的角色与 TURN 类似），也是在其他一些场景下帮助我们完成 NAT 穿透的旁路信道。 换句话说，它既是我们的保底方式，也是有更好的穿透链路时，帮助我们进行连接升级（upgrade to a peer-to-peer connection）的基础设施。</p>
<h2><span id="自建私有-derp-server">自建私有 DERP server</span></h2>
<p>Tailscale 的私钥只会保存在当前节点，因此 DERP server 无法解密流量，它只能和互联网上的其他路由器一样，呆呆地将加密的流量从一个节点转发到另一个节点，只不过 DERP 使用了一个稍微高级一点的协议来防止滥用。</p>
<p>Tailscale 开源了 DERP 服务器的代码，如果你感兴趣，可以阅读 <a href="https://github.com/tailscale/tailscale/tree/main/derp" target="_blank" rel="noopener">DERP 的源代码</a>。</p>
<p>Tailscale 官方内置了很多 DERP 服务器，分步在全球各地，<strong>惟独不包含中国大陆</strong>，原因你懂得。这就导致了一旦流量通过 DERP 服务器进行中继，延时就会非常高。而且官方提供的 DERP 服务器是万人骑，存在安全隐患。</p>
<p>为了实现低延迟、高安全性，我们可以参考 <a href="https://tailscale.com/kb/1118/custom-derp-servers/" target="_blank" rel="noopener">Tailscale 官方文档</a>自建私有的 DERP 服务器。有两种部署模式，一种是基于域名，另外一种不需要域名，可以直接使用 IP，不过需要一点黑科技。我们先来看最简单的使用域名的方案。</p>
<h3><span id="使用域名">使用域名</span></h3>
<p>这种方案需要满足以下几个条件：</p>
<ul>
<li>要有自己的域名，并且申请了 SSL 证书</li>
<li>需要准备一台或多台云主机</li>
<li>如果服务器在国内，域名需要备案</li>
<li>如果服务器在国外，则不需要备案</li>
</ul>
<p>如果以上条件都俱备，就可以按照下面的步骤开始部署了。</p>
<p>推荐直接使用 Docker 来部署，我已经构建好了 Docker 镜像，直接部署就可以了：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">🐳  → docker run --restart always \</span><br><span class="line">  --name derper -p 12345:12345 -p 3478:3478/udp \</span><br><span class="line">  -v /root/.acme.sh/xxxx/:/app/certs \</span><br><span class="line">  -e DERP_CERT_MODE=manual \</span><br><span class="line">  -e DERP_ADDR=:12345 \</span><br><span class="line">  -e DERP_DOMAIN=xxxx \</span><br><span class="line">  -d ghcr.io/yangchuansheng/derper:latest</span><br></pre></td></tr></table></figure>
<p>有几点需要注意：</p>
<ul>
<li>能用 443 端口尽量用 443 端口，实在不行再用别的端口；</li>
<li>默认情况下也会开启 STUN 服务，UDP 端口是 <code>3478</code>；</li>
<li>防火墙需要放行端口 12345 和 3478；</li>
<li>准备好 SSL 证书；</li>
<li>域名部分我打了码，请换成你自己的域名。</li>
</ul>
<p>关于证书部分需要重点说明：<strong>假设你的域名是 <code>xxx.com</code>，那么证书的名称必须是 <code>xxx.com.crt</code>，一个字符都不能错！同理，私钥名称必须是 <code>xxx.com.key</code>，一个字符都不能错！</strong></p>
<p>查看容器日志：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">🐳  → docker logs -f derper</span><br><span class="line">2022/03/26 11:36:28 no config path specified; using /var/lib/derper/derper.key</span><br><span class="line">2022/03/26 11:36:28 derper: serving on :12345 with TLS</span><br><span class="line">2022/03/26 11:36:28 running STUN server on [::]:3478</span><br></pre></td></tr></table></figure>
<p>目前 derper 运行一段时间就会崩溃，暂时还没有更好的解决方案，只能通过定时重启来解决，比如通过 crontab 来设置每两小时重启一次容器：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 */2 * * * docker restart derper &amp;&gt; /dev/null</span><br></pre></td></tr></table></figure>
<p>具体可参考这个 issue：<a href="https://github.com/tailscale/tailscale/issues/4082" target="_blank" rel="noopener">Derper TLS handshake error: remote error: tls: internal error</a></p>
<p>部署好 derper 之后，就可以修改 Headscale 的配置来使用自定义的 DERP 服务器了。Headscale 可以通过两种形式的配置来使用自定义 DERP：</p>
<ul>
<li>一种是在线 URL，格式是 <code>JSON</code>，与 Tailscale 官方控制服务器使用的格式和语法相同。</li>
<li>另一种是本地文件，格式是 <code>YAML</code>。</li>
</ul>
<p>我们可以直接使用本地的 YAML 配置文件，内容如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /etc/headscale/derp.yaml</span></span><br><span class="line"><span class="attr">regions:</span></span><br><span class="line">  <span class="attr">900:</span></span><br><span class="line">    <span class="attr">regionid:</span> <span class="number">900</span></span><br><span class="line">    <span class="attr">regioncode:</span> <span class="string">thk</span> </span><br><span class="line">    <span class="attr">regionname:</span> <span class="string">Tencent</span> <span class="string">Hongkong</span> </span><br><span class="line">    <span class="attr">nodes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">900a</span></span><br><span class="line">        <span class="attr">regionid:</span> <span class="number">900</span></span><br><span class="line">        <span class="attr">hostname:</span> <span class="string">xxxx</span></span><br><span class="line">        <span class="attr">ipv4:</span> <span class="string">xxxx</span></span><br><span class="line">        <span class="attr">stunport:</span> <span class="number">3478</span></span><br><span class="line">        <span class="attr">stunonly:</span> <span class="literal">false</span></span><br><span class="line">        <span class="attr">derpport:</span> <span class="number">12345</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">900b</span></span><br><span class="line">        <span class="attr">regionid:</span> <span class="number">900</span></span><br><span class="line">        <span class="attr">hostname:</span> <span class="string">xxxx</span></span><br><span class="line">        <span class="attr">ipv4:</span> <span class="string">xxxx</span></span><br><span class="line">        <span class="attr">stunport:</span> <span class="number">3478</span></span><br><span class="line">        <span class="attr">stunonly:</span> <span class="literal">false</span></span><br><span class="line">        <span class="attr">derpport:</span> <span class="number">12345</span></span><br><span class="line">  <span class="attr">901:</span></span><br><span class="line">    <span class="attr">regionid:</span> <span class="number">901</span></span><br><span class="line">    <span class="attr">regioncode:</span> <span class="string">hs</span> </span><br><span class="line">    <span class="attr">regionname:</span> <span class="string">Huawei</span> <span class="string">Shanghai</span> </span><br><span class="line">    <span class="attr">nodes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">901a</span></span><br><span class="line">        <span class="attr">regionid:</span> <span class="number">901</span></span><br><span class="line">        <span class="attr">hostname:</span> <span class="string">xxxx</span></span><br><span class="line">        <span class="attr">ipv4:</span> <span class="string">xxxx</span></span><br><span class="line">        <span class="attr">stunport:</span> <span class="number">3478</span></span><br><span class="line">        <span class="attr">stunonly:</span> <span class="literal">false</span></span><br><span class="line">        <span class="attr">derpport:</span> <span class="number">12345</span></span><br></pre></td></tr></table></figure>
<p>配置说明：</p>
<ul>
<li><code>regions</code> 是 YAML 中的<strong>对象</strong>，下面的每一个对象表示一个<strong>可用区</strong>，每个<strong>可用区</strong>里面可设置多个 DERP 节点，即 <code>nodes</code>。</li>
<li>每个可用区的 <code>regionid</code> 不能重复。</li>
<li>每个 <code>node</code> 的 <code>name</code> 不能重复。</li>
<li><code>regionname</code> 一般用来描述可用区，<code>regioncode</code> 一般设置成可用区的缩写。</li>
<li><code>ipv4</code> 字段不是必须的，如果你的域名可以通过公网解析到你的 DERP 服务器地址，这里可以不填。如果你使用了一个二级域名，而这个域名你并没有在公共 DNS server 中添加相关的解析记录，那么这里就需要指定 IP（前提是你的证书包含了这个二级域名，这个很好支持，搞个泛域名证书就行了）。</li>
<li><code>stunonly: false</code> 表示除了使用 STUN 服务，还可以使用 DERP 服务。</li>
<li>上面的配置中域名和 IP 部分我都打码了，你需要根据你的实际情况填写。</li>
</ul>
<p>接下来还需要修改 Headscale 的配置文件，引用上面的自定义 DERP 配置文件。需要修改的配置项如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /etc/headscale/config.yaml</span></span><br><span class="line"><span class="attr">derp:</span></span><br><span class="line">  <span class="comment"># List of externally available DERP maps encoded in JSON</span></span><br><span class="line">  <span class="attr">urls:</span></span><br><span class="line">  <span class="comment">#  - https://controlplane.tailscale.com/derpmap/default</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Locally available DERP map files encoded in YAML</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># This option is mostly interesting for people hosting</span></span><br><span class="line">  <span class="comment"># their own DERP servers:</span></span><br><span class="line">  <span class="comment"># https://tailscale.com/kb/1118/custom-derp-servers/</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># paths:</span></span><br><span class="line">  <span class="comment">#   - /etc/headscale/derp-example.yaml</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/etc/headscale/derp.yaml</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># If enabled, a worker will be set up to periodically</span></span><br><span class="line">  <span class="comment"># refresh the given sources and update the derpmap</span></span><br><span class="line">  <span class="comment"># will be set up.</span></span><br><span class="line">  <span class="attr">auto_update_enabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># How often should we check for DERP updates?</span></span><br><span class="line">  <span class="attr">update_frequency:</span> <span class="string">24h</span></span><br></pre></td></tr></table></figure>
<p>可以把 Tailscale 官方的 DERP 服务器禁用，来测试自建的 DERP 服务器是否能正常工作。</p>
<p>修改完配置后，重启 headscale 服务：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ systemctl restart headscale</span><br></pre></td></tr></table></figure>
<p>在 Tailscale 客户端上使用以下命令查看目前可以使用的 DERP 服务器：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ tailscale netcheck</span><br><span class="line"></span><br><span class="line">Report:</span><br><span class="line">        * UDP: <span class="literal">true</span></span><br><span class="line">        * IPv4: yes, xxxxx:57068</span><br><span class="line">        * IPv6: no</span><br><span class="line">        * MappingVariesByDestIP: <span class="literal">false</span></span><br><span class="line">        * HairPinning: <span class="literal">false</span></span><br><span class="line">        * PortMapping: </span><br><span class="line">        * Nearest DERP: Tencent Hongkong</span><br><span class="line">        * DERP latency:</span><br><span class="line">                - thk: 39.7ms (Tencent Hongkong)</span><br></pre></td></tr></table></figure>
<p><code>tailscale netcheck</code> 实际上只检测 <code>3478/udp</code> 的端口， 就算 netcheck 显示能连，也不一定代表 12345 端口可以转发流量。最简单的办法是直接打开 DERP 服务器的 URL：<a href="https://xxxx:12345" target="_blank" rel="noopener">https://xxxx:12345</a>，如果看到如下页面，且地址栏的 SSL 证书标签显示正常可用，那才是真没问题了。</p>
<p><img src="https://img.hi-linux.com/staticfile/2022-03-27-11-21-dZ5dtZ-2022-03-30-jkEw4r.png" alt></p>
<p>查看与通信对端的连接方式：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ tailscale status</span><br><span class="line">10.1.0.5        coredns              default      linux   -</span><br><span class="line">                carsondemacbook-pro  default      macOS   active; direct xxxx:2756; offline, tx 50424 rx 34056</span><br><span class="line">                oneplus-8t           default      android active; relay <span class="string">"thk"</span>; offline, tx 1608 rx 1552</span><br><span class="line">                openwrt              default      linux   active; direct xxxx:2834; offline, tx 1403688 rx 1217620</span><br></pre></td></tr></table></figure>
<p>这个客户端是一台云主机，有 3 个通信对端，分别是 macOS、OpenWRT 与 Android 手机，macOS 和 OpenWRT 都处于电信家庭内网中，Android 手机使用的是电信流量。可以看到只有 Android 手机是通过自定义的 DERP 服务器来中继流量的，打洞成功率相当高。使用 ping 来测试连通性：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ ping 10.1.0.8</span><br><span class="line">PING 10.1.0.8 (10.1.0.8) 56(84) bytes of data.</span><br><span class="line">64 bytes from 10.1.0.8: icmp_seq=1 ttl=64 time=150 ms</span><br><span class="line">64 bytes from 10.1.0.8: icmp_seq=2 ttl=64 time=131 ms</span><br><span class="line">64 bytes from 10.1.0.8: icmp_seq=3 ttl=64 time=161 ms</span><br><span class="line">64 bytes from 10.1.0.8: icmp_seq=4 ttl=64 time=137 ms</span><br><span class="line">64 bytes from 10.1.0.8: icmp_seq=5 ttl=64 time=156 ms</span><br><span class="line">64 bytes from 10.1.0.8: icmp_seq=6 ttl=64 time=169 ms</span><br><span class="line">^C</span><br><span class="line">--- 10.1.0.8 ping statistics ---</span><br><span class="line">6 packets transmitted, 6 received, 0% packet loss, time 5005ms</span><br><span class="line">rtt min/avg/max/mdev = 131.728/151.154/169.627/13.193 ms</span><br></pre></td></tr></table></figure>
<p>也可以使用 Tailscale 命令行工具来测试：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ tailscale ping 10.1.0.8</span><br><span class="line">pong from oneplus-8t (10.1.0.8) via DERP(thk) <span class="keyword">in</span> 104ms</span><br><span class="line">pong from oneplus-8t (10.1.0.8) via DERP(thk) <span class="keyword">in</span> 111ms</span><br><span class="line">pong from oneplus-8t (10.1.0.8) via DERP(thk) <span class="keyword">in</span> 105ms</span><br></pre></td></tr></table></figure>
<p>这个更加友好一点，会直接告诉你是通过 DERP 中继服务器来和对方通信的。</p>
<p>如果当前 Tailscale 客户端所在主机开启了 IPv6，那么与手机便可以直接通过 IPv6 点对点连接：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ /Applications/Tailscale.app/Contents/MacOS/Tailscale status</span><br><span class="line">                coredns              default      linux   active; direct xxxx:45986; offline, tx 124352 rx 185736</span><br><span class="line">                oneplus-8t           default      android active; direct [240e:472:da0:24a2:a07f:2a67:2a1e:4475]:37237; offline, tx 125216 rx 20052</span><br><span class="line">                openwrt              default      linux   active; direct [240e:390:caf:1870:c02c:e8ff:feb9:b0b]:41641; offline, tx 181992 rx 3910120</span><br><span class="line"></span><br><span class="line">$ /Applications/Tailscale.app/Contents/MacOS/Tailscale ping 10.1.0.8</span><br><span class="line">pong from oneplus-8t (10.1.0.8) via [240e:472:da0:24a2:a07f:2a67:2a1e:4475]:37237 <span class="keyword">in</span> 62ms</span><br></pre></td></tr></table></figure>
<p>所以如果你开启了 IPv6，可以大大增加<strong>点对点连接</strong>的成功率。</p>
<h3><span id="使用纯-ip">使用纯 IP</span></h3>
<p>我知道，大部分人是没有自己的域名的。再退一步，就算有自己的域名，如果没有备案，也是没办法部署在国内服务器上使用的。</p>
<p>这个时候我们就只能从 derper 源码上动手脚了，找到 tailscale 仓库中的 <code>cmd/derper/cert.go</code> 文件，将与域名验证相关的内容删除或注释：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *manualCertManager)</span> <span class="title">getCertificate</span><span class="params">(hi *tls.ClientHelloInfo)</span> <span class="params">(*tls.Certificate, error)</span></span> &#123;</span><br><span class="line">	<span class="comment">//if hi.ServerName != m.hostname &#123;</span></span><br><span class="line">	<span class="comment">//	return nil, fmt.Errorf("cert mismatch with hostname: %q", hi.ServerName)</span></span><br><span class="line">	<span class="comment">//&#125;</span></span><br><span class="line">	<span class="keyword">return</span> m.cert, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>还需要创建自签名证书，可以通过脚本来创建：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># build_cert.sh</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">CERT_HOST=<span class="variable">$1</span></span><br><span class="line">CERT_DIR=<span class="variable">$2</span></span><br><span class="line">CONF_FILE=<span class="variable">$3</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"[req]</span></span><br><span class="line"><span class="string">default_bits  = 2048</span></span><br><span class="line"><span class="string">distinguished_name = req_distinguished_name</span></span><br><span class="line"><span class="string">req_extensions = req_ext</span></span><br><span class="line"><span class="string">x509_extensions = v3_req</span></span><br><span class="line"><span class="string">prompt = no</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[req_distinguished_name]</span></span><br><span class="line"><span class="string">countryName = XX</span></span><br><span class="line"><span class="string">stateOrProvinceName = N/A</span></span><br><span class="line"><span class="string">localityName = N/A</span></span><br><span class="line"><span class="string">organizationName = Self-signed certificate</span></span><br><span class="line"><span class="string">commonName = <span class="variable">$CERT_HOST</span>: Self-signed certificate</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[req_ext]</span></span><br><span class="line"><span class="string">subjectAltName = @alt_names</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[v3_req]</span></span><br><span class="line"><span class="string">subjectAltName = @alt_names</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[alt_names]</span></span><br><span class="line"><span class="string">IP.1 = <span class="variable">$CERT_HOST</span></span></span><br><span class="line"><span class="string">"</span> &gt; <span class="string">"<span class="variable">$CONF_FILE</span>"</span></span><br><span class="line"></span><br><span class="line">mkdir -p <span class="string">"<span class="variable">$CERT_DIR</span>"</span></span><br><span class="line">openssl req -x509 -nodes -days 730 -newkey rsa:2048 -keyout <span class="string">"<span class="variable">$CERT_DIR</span>/<span class="variable">$CERT_HOST</span>.key"</span> -out <span class="string">"<span class="variable">$CERT_DIR</span>/<span class="variable">$CERT_HOST</span>.crt"</span> -config <span class="string">"<span class="variable">$CONF_FILE</span>"</span></span><br></pre></td></tr></table></figure>
<p>重新编写 Dockerfile，将 derper 的域名设置为 <code>127.0.0.1</code>：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> golang:latest AS builder</span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /app</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ========= CONFIG =========</span></span><br><span class="line"><span class="comment"># - download links</span></span><br><span class="line"><span class="keyword">ENV</span> MODIFIED_DERPER_GIT=https://github.com/yangchuansheng/ip_derper.git</span><br><span class="line"><span class="keyword">ENV</span> BRANCH=ip_derper</span><br><span class="line"><span class="comment"># ==========================</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># build modified derper</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> git <span class="built_in">clone</span> -b <span class="variable">$BRANCH</span> <span class="variable">$MODIFIED_DERPER_GIT</span> tailscale --depth 1 &amp;&amp; \</span></span><br><span class="line"><span class="bash">    <span class="built_in">cd</span> /app/tailscale/cmd/derper &amp;&amp; \</span></span><br><span class="line"><span class="bash">    /usr/<span class="built_in">local</span>/go/bin/go build -ldflags <span class="string">"-s -w"</span> -o /app/derper &amp;&amp; \</span></span><br><span class="line"><span class="bash">    <span class="built_in">cd</span> /app &amp;&amp; \</span></span><br><span class="line"><span class="bash">    rm -rf /app/tailscale</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">20.04</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /app</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ========= CONFIG =========</span></span><br><span class="line"><span class="comment"># - derper args</span></span><br><span class="line"><span class="keyword">ENV</span> DERP_HOST=<span class="number">127.0</span>.<span class="number">0.1</span></span><br><span class="line"><span class="keyword">ENV</span> DERP_CERTS=/app/certs/</span><br><span class="line"><span class="keyword">ENV</span> DERP_STUN true</span><br><span class="line"><span class="keyword">ENV</span> DERP_VERIFY_CLIENTS false</span><br><span class="line"><span class="comment"># ==========================</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># apt</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update &amp;&amp; \</span></span><br><span class="line"><span class="bash">    apt-get install -y openssl curl</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> build_cert.sh /app/</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> --from=builder /app/derper /app/derper</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># build self-signed certs &amp;&amp; start derper</span></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> bash /app/build_cert.sh <span class="variable">$DERP_HOST</span> <span class="variable">$DERP_CERTS</span> /app/san.conf &amp;&amp; \</span></span><br><span class="line"><span class="bash">    /app/derper --hostname=<span class="variable">$DERP_HOST</span> \</span></span><br><span class="line"><span class="bash">    --certmode=manual \</span></span><br><span class="line"><span class="bash">    --certdir=<span class="variable">$DERP_CERTS</span> \</span></span><br><span class="line"><span class="bash">    --stun=<span class="variable">$DERP_STUN</span>  \</span></span><br><span class="line"><span class="bash">    --verify-clients=<span class="variable">$DERP_VERIFY_CLIENTS</span></span></span><br></pre></td></tr></table></figure>
<p>构建好镜像后，就可以在你想部署 derper 的主机上直接通过该镜像启动 derper 容器了，命令如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">🐳  → docker run --restart always --net host --name derper -d ghcr.io/yangchuansheng/ip_derper</span><br></pre></td></tr></table></figure>
<p>和使用域名的方案一样，防火墙需要放行相应端口（12345 与 3478）。</p>
<p>查看容器日志：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">🐳  → docker logs -f derper</span><br><span class="line">Generating a RSA private key</span><br><span class="line">.......................................+++++</span><br><span class="line">..............+++++</span><br><span class="line">writing new private key to <span class="string">'/app/certs//127.0.0.1.key'</span></span><br><span class="line">-----</span><br><span class="line">2022/03/26 14:30:31 no config path specified; using /var/lib/derper/derper.key</span><br><span class="line">2022/03/26 14:30:31 derper: serving on :443 with TLS</span><br><span class="line">2022/03/26 14:30:31 running STUN server on [::]:3478</span><br></pre></td></tr></table></figure>
<p>如果你想自己构建 derper 镜像，可以参考<a href="https://github.com/yangchuansheng/ip_derper" target="_blank" rel="noopener">我的 GitHub 仓库</a>。</p>
<p>下面就是骚操作了，我们在 Headscale 的配置中需要<strong>将 DERP 的域名设置为 IP</strong>！不理解的可以再消化一下，然后继续往下看哈哈~~</p>
<p>除了 derper 之外，Tailscale 客户端还需要<strong>跳过域名验证</strong>，这个需要在 DERP 的配置中设置。而 Headscale 的本地 YAML 文件目前还不支持这个配置项，所以没办法，咱只能使用在线 URL 了。JSON 配置内容如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"Regions"</span>: &#123;</span><br><span class="line">    <span class="attr">"901"</span>: &#123;</span><br><span class="line">      <span class="attr">"RegionID"</span>: <span class="number">901</span>,</span><br><span class="line">      <span class="attr">"RegionCode"</span>: <span class="string">"ali-sh"</span>,</span><br><span class="line">      <span class="attr">"RegionName"</span>: <span class="string">"Aliyun Shanghai"</span>,</span><br><span class="line">      <span class="attr">"Nodes"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">"Name"</span>: <span class="string">"901a"</span>,</span><br><span class="line">          <span class="attr">"RegionID"</span>: <span class="number">901</span>,</span><br><span class="line">          <span class="attr">"DERPPort"</span>: <span class="number">443</span>,</span><br><span class="line">          <span class="attr">"HostName"</span>: <span class="string">"xxxx"</span>,</span><br><span class="line">          <span class="attr">"IPv4"</span>: <span class="string">"xxxx"</span>,</span><br><span class="line">          <span class="attr">"InsecureForTests"</span>: <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>配置解析：</p>
<ul>
<li><code>HostName</code> 直接填 derper 的公网 IP，即和 <code>IPv4</code> 的值相同。</li>
<li><code>InsecureForTests</code> 一定要设置为 true，以跳过域名验证。</li>
</ul>
<p>你需要把这个 JSON 文件变成 Headscale 服务器可以访问的 URL，比如在 Headscale 主机上搭个 Nginx，或者上传到对象存储（比如阿里云 OSS）。</p>
<p>接下来还需要修改 Headscale 的配置文件，引用上面的自定义 DERP 的 URL。需要修改的配置项如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /etc/headscale/config.yaml</span></span><br><span class="line"><span class="attr">derp:</span></span><br><span class="line">  <span class="comment"># List of externally available DERP maps encoded in JSON</span></span><br><span class="line">  <span class="attr">urls:</span></span><br><span class="line">  <span class="comment">#  - https://controlplane.tailscale.com/derpmap/default</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">https://xxxxx/derp.json</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Locally available DERP map files encoded in YAML</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># This option is mostly interesting for people hosting</span></span><br><span class="line">  <span class="comment"># their own DERP servers:</span></span><br><span class="line">  <span class="comment"># https://tailscale.com/kb/1118/custom-derp-servers/</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># paths:</span></span><br><span class="line">  <span class="comment">#   - /etc/headscale/derp-example.yaml</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/etc/headscale/derp.yaml</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># If enabled, a worker will be set up to periodically</span></span><br><span class="line">  <span class="comment"># refresh the given sources and update the derpmap</span></span><br><span class="line">  <span class="comment"># will be set up.</span></span><br><span class="line">  <span class="attr">auto_update_enabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># How often should we check for DERP updates?</span></span><br><span class="line">  <span class="attr">update_frequency:</span> <span class="string">24h</span></span><br></pre></td></tr></table></figure>
<p>修改完配置后，重启 headscale 服务：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ systemctl restart headscale</span><br></pre></td></tr></table></figure>
<p>在 Tailscale 客户端上使用以下命令查看目前可以使用的 DERP 服务器：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ tailscale netcheck</span><br><span class="line"></span><br><span class="line">Report:</span><br><span class="line">	* UDP: <span class="literal">true</span></span><br><span class="line">	* IPv4: yes, 192.168.100.1:49656</span><br><span class="line">	* IPv6: no</span><br><span class="line">	* MappingVariesByDestIP: <span class="literal">true</span></span><br><span class="line">	* HairPinning: <span class="literal">false</span></span><br><span class="line">	* PortMapping: UPnP</span><br><span class="line">	* Nearest DERP: Home Hangzhou</span><br><span class="line">	* DERP latency:</span><br><span class="line">		- home: 9.7ms   (Home Hangzhou)</span><br><span class="line">		-  hs: 25.2ms  (Huawei Shanghai)</span><br><span class="line">		- thk: 43.5ms  (Tencent Hongkong)</span><br></pre></td></tr></table></figure>
<p>再次查看与通信对端的连接方式：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ tailscale status</span><br><span class="line">                coredns              default      linux   active; direct xxxx:45986; offline, tx 131012 rx 196020</span><br><span class="line">                oneplus-8t           default      android active; relay <span class="string">"home"</span>; offline, tx 211900 rx 22780</span><br><span class="line">                openwrt              default      linux   active; direct 192.168.100.254:41641; offline, tx 189868 rx 4074772</span><br></pre></td></tr></table></figure>
<p>可以看到这一次 Tailscale 自动选择了一个线路最优的<strong>国内的</strong> DERP 服务器作为中继，可以测试一下延迟：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ tailscale ping 10.1.0.8</span><br><span class="line">pong from oneplus-8t (10.1.0.8) via DERP(home) <span class="keyword">in</span> 30ms</span><br><span class="line">pong from oneplus-8t (10.1.0.8) via DERP(home) <span class="keyword">in</span> 45ms</span><br><span class="line">pong from oneplus-8t (10.1.0.8) via DERP(home) <span class="keyword">in</span> 30ms</span><br></pre></td></tr></table></figure>
<p>完美！这里的 home 当然是我的家庭宽带，部署方式与上面所说的国内云主机类似，你需要额外开启公网的端口映射（12345/tcp, 3478/udp）。还有一点需要注意的是配置内容：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"Regions"</span>: &#123;</span><br><span class="line">    <span class="attr">"901"</span>: &#123;</span><br><span class="line">      <span class="attr">"RegionID"</span>: <span class="number">901</span>,</span><br><span class="line">      <span class="attr">"RegionCode"</span>: <span class="string">"ali-sh"</span>,</span><br><span class="line">      <span class="attr">"RegionName"</span>: <span class="string">"Aliyun Shanghai"</span>,</span><br><span class="line">      <span class="attr">"Nodes"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">"Name"</span>: <span class="string">"901a"</span>,</span><br><span class="line">          <span class="attr">"RegionID"</span>: <span class="number">901</span>,</span><br><span class="line">          <span class="attr">"DERPPort"</span>: <span class="number">443</span>,</span><br><span class="line">          <span class="attr">"HostName"</span>: <span class="string">"xxxx"</span>,</span><br><span class="line">          <span class="attr">"IPv4"</span>: <span class="string">"xxxx"</span>,</span><br><span class="line">          <span class="attr">"InsecureForTests"</span>: <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"902"</span>: &#123;</span><br><span class="line">      <span class="attr">"RegionID"</span>: <span class="number">902</span>,</span><br><span class="line">      <span class="attr">"RegionCode"</span>: <span class="string">"home"</span>,</span><br><span class="line">      <span class="attr">"RegionName"</span>: <span class="string">"Home Hangzhou"</span>,</span><br><span class="line">      <span class="attr">"Nodes"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">"Name"</span>: <span class="string">"902a"</span>,</span><br><span class="line">          <span class="attr">"RegionID"</span>: <span class="number">902</span>,</span><br><span class="line">          <span class="attr">"DERPPort"</span>: <span class="number">12345</span>,</span><br><span class="line">          <span class="attr">"HostName"</span>: <span class="string">"xxxx"</span>,</span><br><span class="line">          <span class="attr">"InsecureForTests"</span>: <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>与国内云主机相比，家庭宽带的配置有两点不同：</p>
<ul>
<li>需要删除 <code>IPv4</code> 配置项。因为家用宽带的公网 IP 是动态变化的，所以你需要使用 <strong>DDNS</strong> 来动态解析公网 IP。</li>
<li><code>HostName</code> 最好填域名，因为你的公网 IP 是动态变化的，没法填写 IP，除非你不停地修改配置文件。填域名也没关系啦，反正不会验证域名的，也不用关心证书的事情，<strong>只要域名能解析到你的公网 IP 即可。</strong></li>
</ul>
<h2><span id="防止-derp-被白嫖">防止 DERP 被白嫖</span></h2>
<p>默认情况下 DERP 服务器是可以被白嫖的，只要别人知道了你的 DERP 服务器的地址和端口，就可以为他所用。如果你的服务器是个小水管，用的人多了可能会把你撑爆，因此我们需要修改配置来防止被白嫖。</p>
<blockquote>
<p>特别声明：只有使用域名的方式才可以通过认证防止被白嫖，使用纯 IP 的方式无法防白嫖，你只能小心翼翼地隐藏好你的 IP 和端口，不能让别人知道。</p>
</blockquote>
<p>只需要做两件事情：</p>
<p><strong>1、在 DERP 服务器上安装 Tailscale。</strong></p>
<p>第一步需要在 DERP 服务所在的主机上安装 Tailscale 客户端，<strong>启动 tailscaled 进程</strong>。</p>
<p><strong>2、derper 启动时加上参数 <code>--verify-clients</code>。</strong></p>
<p>本文推荐的是通过容器启动，<a href="https://github.com/yangchuansheng/docker-image/blob/master/derper/Dockerfile" target="_blank" rel="noopener">Dockerfile 内容</a>如下：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> golang:latest AS builder</span><br><span class="line"></span><br><span class="line"><span class="keyword">LABEL</span><span class="bash"> org.opencontainers.image.source https://github.com/yangchuansheng/docker-image</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /app</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># https://tailscale.com/kb/1118/custom-derp-servers/</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> go install tailscale.com/cmd/derper@main</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> ubuntu</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /app</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ARG</span> DEBIAN_FRONTEND=noninteractive</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update &amp;&amp; \</span></span><br><span class="line"><span class="bash">    apt-get install -y --no-install-recommends apt-utils &amp;&amp; \</span></span><br><span class="line"><span class="bash">    apt-get install -y ca-certificates &amp;&amp; \</span></span><br><span class="line"><span class="bash">    mkdir /app/certs</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> DERP_DOMAIN your-hostname.com</span><br><span class="line"><span class="keyword">ENV</span> DERP_CERT_MODE letsencrypt</span><br><span class="line"><span class="keyword">ENV</span> DERP_CERT_DIR /app/certs</span><br><span class="line"><span class="keyword">ENV</span> DERP_ADDR :<span class="number">443</span></span><br><span class="line"><span class="keyword">ENV</span> DERP_STUN true</span><br><span class="line"><span class="keyword">ENV</span> DERP_HTTP_PORT <span class="number">80</span></span><br><span class="line"><span class="keyword">ENV</span> DERP_VERIFY_CLIENTS false</span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> --from=builder /go/bin/derper .</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> /app/derper --hostname=<span class="variable">$DERP_DOMAIN</span> \</span></span><br><span class="line"><span class="bash">    --certmode=<span class="variable">$DERP_CERT_MODE</span> \</span></span><br><span class="line"><span class="bash">    --certdir=<span class="variable">$DERP_CERT_DIR</span> \</span></span><br><span class="line"><span class="bash">    --a=<span class="variable">$DERP_ADDR</span> \</span></span><br><span class="line"><span class="bash">    --stun=<span class="variable">$DERP_STUN</span>  \</span></span><br><span class="line"><span class="bash">    --http-port=<span class="variable">$DERP_HTTP_PORT</span> \</span></span><br><span class="line"><span class="bash">    --verify-clients=<span class="variable">$DERP_VERIFY_CLIENTS</span></span></span><br></pre></td></tr></table></figure>
<p>默认情况下 <code>--verify-clients</code> 参数设置的是 <code>false</code>。我们不需要对 Dockerfile 内容做任何改动，只需在容器启动时加上环境变量即可，将之前的启动命令修改一下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">🐳  → docker run --restart always \</span><br><span class="line">  --name derper -p 12345:12345 -p 3478:3478/udp \</span><br><span class="line">  -v /root/.acme.sh/xxxx/:/app/certs \</span><br><span class="line">  -e DERP_CERT_MODE=manual \</span><br><span class="line">  -e DERP_ADDR=:12345 \</span><br><span class="line">  -e DERP_DOMAIN=xxxx \</span><br><span class="line">  -e DERP_VERIFY_CLIENTS=<span class="literal">true</span> \</span><br><span class="line">  -d ghcr.io/yangchuansheng/derper:latest</span><br></pre></td></tr></table></figure>
<p>这样就大功告成了，别人即使知道了你的 DERP 服务器地址也无法使用，但还是要说明一点，即便如此，你也应该尽量不让别人知道你的服务器地址，防止别人有可趁之机。</p>
<h2><span id="总结">总结</span></h2>
<p>本文给大家介绍了 STUN 对于辅助 NAT 穿透的意义，科普了几种常见的中继协议，包含 Tailscale 自研的 DERP 协议。最后手把手教大家如何自建私有的 DERP 服务器，并让 Tailscale 使用我们自建的 DERP 服务器。</p>
<h2><span id="参考资料">参考资料</span></h2>
<ul>
<li><a href="https://arthurchiao.art/blog/how-nat-traversal-works-zh/" target="_blank" rel="noopener">NAT 穿透是如何工作的：技术原理及企业级实践</a></li>
<li><a href="https://tailscale.com/kb/1118/custom-derp-servers/" target="_blank" rel="noopener">Custom DERP Servers</a></li>
<li><a href="https://tailscale.com/blog/how-tailscale-works/#encrypted-tcp-relays-derp" target="_blank" rel="noopener">Encrypted TCP relays (DERP)</a></li>
</ul>
<blockquote>
<p>本文转载自：「 云原生实验室 」，原文：<a href="https://tinyurl.com/588mv65u" target="_blank" rel="noopener">https://tinyurl.com/588mv65u</a> ，版权归原作者所有。欢迎投稿，投稿邮箱: <a href="mailto:editor@hi-linux.com">editor@hi-linux.com</a>。</p>
</blockquote>
</div>

			<script src="https://my.openwrite.cn/js/readmore.js" type="text/javascript"></script>
			<script>
			var isMobile = navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i);
			if (!isMobile) {
			    var btw = new BTWPlugin();
			    btw.init({
			        "id": "vip-container",
			        "blogId": "10135-1588830050631-449",
			        "name": "「奇妙的 Linux 世界」",
			        "qrcode": "https://www.hi-linux.com/img/wechat/mp_qrcode_12.jpg",
			        "keyword": "VIP"
			    });
			}
			</script>
		
                

                <hr>
                <!-- Pager -->
                <ul class="pager">
                    
                        <li class="previous">
                            <a href="/posts/42601.html" data-toggle="tooltip" data-placement="top" title="24 个 常见的 Docker 疑难杂症处理技巧">&larr; Previous Post</a>
                        </li>
                    
                    
                        <li class="next">
                            <a href="/posts/24272.html" data-toggle="tooltip" data-placement="top" title="零代码变更，巧用 Reloader 快速实现 Kubernetes 的 Configmap 和 Secret 热更新">Next Post &rarr;</a>
                        </li>
                    
                </ul>

                <!-- duoshuo Share start -->
                
                <!-- 多说 Share end-->

                <!-- 多说评论框 start -->
                
                <!-- 多说评论框 end -->

                <!-- disqus comment start -->
                
                <!-- disqus comment end -->

                
                    <!-- disqus 评论框 start -->
                    <div class="comment">
                        <div id="lv-container" data-id="city" data-uid="MTAyMC8yNzg2My80NDQw"></div>
                    </div>
                    <!-- disqus 评论框 end -->
                

            </div>
            
            <!-- Tabe of Content -->
            <!-- Table of Contents -->

  
    <style>
      span.toc-nav-number{
        display: none
      }
    </style>
  
    
      <aside id="sidebar">
        <div id="toc" class="toc-article">
        <strong class="toc-title">Contents</strong>
        
          <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">Tailscale 是什么</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">2.</span> <span class="toc-nav-text">Headscale 是什么</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">3.</span> <span class="toc-nav-text">Headscale 部署</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">4.</span> <span class="toc-nav-text">Tailscale 客户端接入</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">4.1.</span> <span class="toc-nav-text">Linux</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">4.2.</span> <span class="toc-nav-text">macOS</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">4.3.</span> <span class="toc-nav-text">Android</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">4.4.</span> <span class="toc-nav-text">Windows</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">4.5.</span> <span class="toc-nav-text">其他 Linux 发行版</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">4.6.</span> <span class="toc-nav-text">iOS</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">5.</span> <span class="toc-nav-text">打通局域网</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">6.</span> <span class="toc-nav-text">总结</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">7.</span> <span class="toc-nav-text">STUN 是什么</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">8.</span> <span class="toc-nav-text">中继是什么</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">9.</span> <span class="toc-nav-text">中继协议简介</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">9.1.</span> <span class="toc-nav-text">TURN</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">9.2.</span> <span class="toc-nav-text">DERP</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">10.</span> <span class="toc-nav-text">自建私有 DERP server</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">10.1.</span> <span class="toc-nav-text">使用域名</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">10.2.</span> <span class="toc-nav-text">使用纯 IP</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">11.</span> <span class="toc-nav-text">防止 DERP 被白嫖</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">12.</span> <span class="toc-nav-text">总结</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">13.</span> <span class="toc-nav-text">参考资料</span></a></li></ol>
        
        </div>
      </aside>
    

                
            <!-- Sidebar Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <!-- no hr -->
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                       
                          <a class="tag" href="/tags/#Linux" title="Linux">Linux</a>
                        
                          <a class="tag" href="/tags/#Tailscale" title="Tailscale">Tailscale</a>
                        
                          <a class="tag" href="/tags/#WireGuard" title="WireGuard">WireGuard</a>
                        
                    </div>
                </section>
                

                <!-- Friends Blog -->
                
                <hr>
                <h5>FRIENDS</h5>
                <ul class="list-inline">

                    
                        <li><a href="https://bestgeek.org/" target="_blank">极客视界</a></li>
                    
                        <li><a href="https://666666.dev/" target="_blank">IT 人必备工具箱</a></li>
                    
                        <li><a href="https://mp.weixin.qq.com/s/ZgoeD1FBp7eouyxBte4MWw" target="_blank">Linux 技术交流群</a></li>
                    
                        <li><a href="" target="_blank"></a></li>
                    
                        <li><a href="" target="_blank"></a></li>
                    
                </ul>
                
            </div>
        </div>
    </div>
</article>






    <!-- 来必力City版公共JS代码 start (一个网页只需插入一次) -->
    <script type="text/javascript">
       (function(d, s) {
           var j, e = d.getElementsByTagName(s)[0];
    
           if (typeof LivereTower === 'function') { return; }
    
           j = d.createElement(s);
           j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
           j.async = true;
    
           e.parentNode.insertBefore(j, e);
       })(document, 'script');
    </script>
    <noscript>为正常使用来必力评论功能请激活JavaScript</noscript>
    <!-- 来必力City版 公共JS代码 end -->



<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'hover',
          placement: 'left',
          icon: 'ℬ'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                
                    <li>
                        <a href="/atom.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                
                
                
                    <li>
                        <a target="_blank" href="https://www.zhihu.com/people/80imike">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa  fa-stack-1x fa-inverse">知</i>
                            </span>
                        </a>
                    </li>
                

                
                    <li>
                        <a target="_blank" href="http://weibo.com/2093524665">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                

                

                

                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; Mike 2025 | Hosted by <a href="https://pages.coding.me" target="_blank" rel="noopener" style="font-weight: bold">Coding Pages</a>
                    <br>
                    Theme by <a href="http://beantech.org" target="_blank" rel="noopener">BeanTech</a> 
                    <span style="display: inline-block; margin: 0 5px;">
                        <i class="fa fa-heart"></i>
                    </span> 
                    re-Ported by <a href="http://www.huweihuang.com" target="_blank" rel="noopener">胡伟煌</a> | 
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="91px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=huweihuang&repo=hexo-theme-huweihuang&type=star&count=true" >
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->

<script src="/js/jquery.min.js"></script>


<!-- Bootstrap Core JavaScript -->

<script src="/js/bootstrap.min.js"></script>


<!-- Custom Theme JavaScript -->

<script src="/js/hux-blog.min.js"></script>



<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- 
     Because of the native support for backtick-style fenced code blocks 
     right within the Markdown is landed in Github Pages, 
     From V1.6, There is no need for Highlight.js, 
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0  
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/    
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->


<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("https://www.hi-linux.com/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->




<!-- Baidu Tongji -->



<script defer src="https://umami.hi-linux.com/script.js"
    data-website-id="db99ccfc-f114-4595-8f3b-9dd1fbd3bf19"></script>


	<a id="rocket" href="#top" class=""></a>
	<script type="text/javascript" src="/js/totop.js?v=1.0.0" async=""></script>
    <script type="text/javascript" src="/js/toc.js?v=1.0.0" async=""></script>
<!-- Image to hack wechat -->
<img src="https://www.hi-linux.com/img/icon_wechat.png" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

<script>(function(w,d, s, id) {w.webpushr=w.webpushr||function(){(w.webpushr.q=w.webpushr.q||[]).push(arguments)};var js, fjs = d.getElementsByTagName(s)[0];js = d.createElement(s); js.id = id;js.src = 'https://cdn.webpushr.com/app.min.js';fjs.parentNode.appendChild(js);}(window,document, 'script', 'webpushr-jssdk'));webpushr('init','BF9JK7xV9kjWTdMx2lr6RWaPfXV7wNuZaVAJ1bfIGoBNJavqLEBVFMKLubITnCA4bh2fI9iH9tMF95nXnPt7xxY');</script></body>

</html>
