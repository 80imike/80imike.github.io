<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="keyword"  content="Linux,运维,Nginx,Zabbix,Centos,Ansible,MySQL,Python,Docker,ELK,Haproxy,Git,Nodejs,安全,技术">
    <link rel="shortcut icon" href="/img/ironman-draw.png">
    <!-- Place this tag in your head or just before your close body tag. -->
    <script async defer src="https://buttons.github.io/buttons.js"></script>
    <title>
        
          如何使用 Skopeo 做一个优雅的镜像搬运工 - 奇妙的 Linux 世界
        
    </title>

    <link rel="canonical" href="https://www.hi-linux.com/posts/55385.html">

    <!-- Bootstrap Core CSS -->
    
<link rel="stylesheet" href="/css/bootstrap.min.css">


    <!-- Custom CSS --> 
    
<link rel="stylesheet" href="/css/beantech.min.css">

    
    <!-- Pygments Highlight CSS -->
    
<link rel="stylesheet" href="/css/highlight.css">


    
<link rel="stylesheet" href="/css/widget.css">


    
<link rel="stylesheet" href="/css/rocket.css">


    
<link rel="stylesheet" href="/css/signature.css">


    
<link rel="stylesheet" href="/css/toc.css">


    <!-- Custom Fonts -->
    <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- Hux Delete, sad but pending in China
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/
    css'>
    -->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>
<meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="奇妙的 Linux 世界" type="application/atom+xml">
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">
	<!-- Modified by Yu-Hsuan Yen -->
<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        
            background-image: url('/img/header_img/building.jpg')
            /*post*/
        
    }
    
</style>

<header class="intro-header" >
    <!-- Signature -->
    <div id="signature">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                
                    <div class="post-heading">
                        <div class="tags">
                            
                              <a class="tag" href="/tags/#Linux" title="Linux">Linux</a>
                            
                              <a class="tag" href="/tags/#Docker" title="Docker">Docker</a>
                            
                              <a class="tag" href="/tags/#Skopeo" title="Skopeo">Skopeo</a>
                            
                        </div>
                        <h1>如何使用 Skopeo 做一个优雅的镜像搬运工</h1>
                        <h2 class="subheading"></h2>
                        <span class="meta">
                            Posted by Mike on
                            2022-06-01
                        </span>
                    </div>
                


                </div>
            </div>
        </div>
    </div>
</header>

	
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">奇妙的 Linux 世界</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>

                    

                        
                    

                        
                    

                        
                        <li>
                            <a href="/about/">About</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/archive/">Archives</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/tags/">Tags</a>
                        </li>
                        
                    
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>


    <!-- Main Content -->
    <!-- Modify by Yu-Hsuan Yen -->

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

            <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <div id="vip-container"><h2><span id="1-基础介绍">1. 基础介绍</span></h2>
<p>描述: 作为公司内部 PaaS toB 产品的打包发布人员，容器镜像对我们打工人而言就像是工地上的砖头 🧱，而我的一部分工作就是将这些砖头在各个仓库之间搬来搬去，最终将这些砖头打包放在产品的安装包中，形成一个完整的 PaaS 产品安装包。</p>
<ul>
<li>Q: 在 PaaS (平台即服务)中的大家常说的 ToB 与 ToC 到底是什么?</li>
</ul>
<blockquote>
<p>ToC 面向普通用户服务, 主要是让用户体验感好，解决用户使用方面的问题记录，并返回给前后端开发。<br>
ToB 是面向企业用户服务, 产品可用、其中最关键是让Boss使用Happly!</p>
</blockquote>
<ul>
<li>Q: 假如有如下场景，我们从 dockerhub 公共仓库中下载一个 GB 以上的镜像，到本地的私有仓库中，我想通常你会这样做先 <code>docker pull</code> 到本地，然后使用 <code>docker tag</code> 更改为私有仓库地址加上镜像名称版本，最后再使用<code>docker push</code> 上传镜像到私有仓库中，以供其它内网机器拉取并使用。虽然该方法是可行，但是如果有多个大于 GB 以上的镜像需要上传到私有仓库，每次都要先解压 layer 到本地，然后再压缩 layer 上传到私有仓库中，你能想象此过程花费的时间有多久吗? 对于我们运维工程师来说时间就是金钱，所以需想尽一切方法来节约时间成本，那有没有一种办法可以直接将 registry 上的 blob 复制到另一个 registry，中间过程不涉及对镜像 layer 的解压缩，这岂不美哉。</li>
</ul>
<blockquote>
<p>解决方案当然是存在的，如果你不想使用docker进行images镜像拉取上传，我们完成可以使用skope工具来完全替代 docker-cli 来搬运镜像，skopeo是一个命令行实用程序，可对容器映像和映像存储库执行各种操作。</p>
</blockquote>
<a id="more"></a>
<p><strong>什么是 Skopeo ?</strong></p>
<p>skopeo 使用 API V2 Registry，例如 Docker Registry、Atomic Registry、私有Registry、本地目录和本地 OCI 镜像目录。skopeo 不需要运行守护进程，它可以执行的操作包括：</p>
<ul>
<li>通过各种存储机制复制镜像，例如，可以在不需要特权的情况下将镜像从一个 Registry 复制到另一个 Registry</li>
<li>检测远程镜像并查看其属性，包括其图层，无需将镜像拉到本地</li>
<li>从镜像库中删除镜像</li>
<li>当存储库需要时，skopeo 可以传递适当的凭据和证书进行身份验证</li>
</ul>
<p><strong>镜像存储特点</strong></p>
<p>根据 Robin 大佬在 《镜像仓库中镜像存储的原理解析》文章里得出的结论：</p>
<ul>
<li>
<p>通过 Registry API 获得的两个镜像仓库中相同镜像的 manifest 信息完全相同。</p>
</li>
<li>
<p>两个镜像仓库中相同镜像的 manifest 信息的存储路径和内容完全相同。</p>
</li>
<li>
<p>两个镜像仓库中相同镜像的 blob 信息的存储路径和内容完全相同</p>
</li>
</ul>
<p><strong>项目信息</strong></p>
<ul>
<li>Github 官方地址: <a href="https://github.com/containers/skopeo" target="_blank" rel="noopener">https://github.com/containers/skopeo</a></li>
<li>Gitee mirror: <a href="https://gitee.com/mirrors/skopeo" target="_blank" rel="noopener">https://gitee.com/mirrors/skopeo</a></li>
</ul>
<h2><span id="2-安装编译">2. 安装编译</span></h2>
<p>描述: Skopeo 官方安装&amp;编译方式参考文档: <a href="https://github.com/containers/skopeo/blob/main/install.md" target="_blank" rel="noopener">https://github.com/containers/skopeo/blob/main/install.md</a></p>
<p>本节安装实践环境将在 Ubuntu 20.04 LTS 以及 docker 20.10.12 中进行实践源码编译以及 apt 仓库源下载安装实践。</p>
<h3><span id="21-源码编译静态">2.1 源码编译（静态）</span></h3>
<p>描述: 要构建 skopeo 二进制文件您至少需要 Go 1.12 版本以上, 其次构建 skopeo 有两种方法，即<code>在容器中</code>或者在本地环境中构建(安装环境较为复杂), 此处为了方便演示将采用容器方式进行编译构建。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"># 1.拉取skopeo源码到本地</span><br><span class="line">$ git clone --depth&#x3D;1 https:&#x2F;&#x2F;github.com&#x2F;containers&#x2F;skopeo.git  # https:&#x2F;&#x2F;github.com&#x2F;containers&#x2F;skopeo.git</span><br><span class="line">$ cd skopeo</span><br><span class="line">$ sed -i &#39;s#proxy.golang.org#https:&#x2F;&#x2F;goproxy.cn#g&#39; skopeo&#x2F;Makefile</span><br><span class="line"></span><br><span class="line"># 2.下载镜像构建依赖</span><br><span class="line">$ sudo apt-get install go-md2man  # 构建手册依赖于 go-md2man。</span><br><span class="line">$ whereis go-md2man  # 获得本机中go-md2man路径。</span><br><span class="line"></span><br><span class="line"># 3.构建静态二进制文件</span><br><span class="line">$ BUILD_IMAGE&#x3D;&quot;golang:latest&quot;</span><br><span class="line">$ docker run --name skopeo-build -v $PWD:&#x2F;src -v &#x2F;usr&#x2F;bin&#x2F;go-md2man:&#x2F;go&#x2F;bin&#x2F;go-md2man -w &#x2F;src -e CGO_ENABLED&#x3D;0 -e GOPROXY&#x3D;https:&#x2F;&#x2F;goproxy.cn,direct $&#123;BUILD_IMAGE&#125; \</span><br><span class="line">sh -c &#39;make BUILDTAGS&#x3D;containers_image_openpgp GO_DYN_FLAGS&#x3D;&#39;</span><br><span class="line">  # CGO_CFLAGS&#x3D;&quot;&quot; CGO_LDFLAGS&#x3D;&quot;&quot; GO111MODULE&#x3D;on go build -mod&#x3D;vendor  -ldflags &#39;-X main.gitCommit&#x3D;df4d82b960572c19e9333381a203c0ac475766d7 &#39; -gcflags &quot;&quot; -tags  &quot;containers_image_openpgp&quot; -o bin&#x2F;skopeo .&#x2F;cmd&#x2F;skopeo</span><br><span class="line"></span><br><span class="line"># 4.运行编译生成的skopeo可执行文件</span><br><span class="line">$ cd .&#x2F;bin # &#x2F;opt&#x2F;software&#x2F;skopeo&#x2F;bin</span><br><span class="line">$ .&#x2F;skopeo --help</span><br><span class="line">  # Various operations with container images and container image registries</span><br><span class="line">  # .......</span><br><span class="line">  # Use &quot;skopeo [command] --help&quot; for more information about a command.</span><br></pre></td></tr></table></figure>
<p><strong>构建关键参数解析:</strong></p>
<ul>
<li>CGO_ENABLED=0 : 设置该环境变量, 禁用 CGO 会导致 Go 在可能的情况下更喜欢静态连接库，而不是动态链接到系统库 (解决可以在Ubuntu或者其它linux发行版中执行编译后二进制文件)。</li>
<li>GOPROXY=https://goproxy.cn,direct : Golong 依赖下载镜像站,加快go get依赖拉拉取。</li>
<li>BUILDTAGS=containers_image_openpgp : 设置该make参数消除了对libgpgme 及其配套库的依赖, Skopeo 的一些特性依赖于非 Go 库，例如 libgpgme 和 libdevmapper。</li>
<li>GO_DYN_FLAGS= : 清空该make参数 (否则会强制创建动态可执行文件)</li>
</ul>
<h3><span id="22-分发包安装">2.2 分发包安装</span></h3>
<p>描述: skopeo 可能已经打包在您的发行版中，此处以 ubuntu 20.04 为例进行安装。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 1.只支持 Ubuntu 20.10 and newer 发行版 </span><br><span class="line">$ sudo apt-get -y update</span><br><span class="line">$ sudo apt-get -y install skopeo</span><br><span class="line"></span><br><span class="line"># 2.但 Kubic 项目为 Ubuntu 20.04 提供了软件包，我们可以通过如下方式在我们及其上进行安装。</span><br><span class="line">$ . &#x2F;etc&#x2F;os-release</span><br><span class="line">$ echo &quot;deb https:&#x2F;&#x2F;download.opensuse.org&#x2F;repositories&#x2F;devel:&#x2F;kubic:&#x2F;libcontainers:&#x2F;stable&#x2F;xUbuntu_$&#123;VERSION_ID&#125;&#x2F; &#x2F;&quot; | sudo tee &#x2F;etc&#x2F;apt&#x2F;sources.list.d&#x2F;devel:kubic:libcontainers:stable.list</span><br><span class="line">$ curl -L https:&#x2F;&#x2F;download.opensuse.org&#x2F;repositories&#x2F;devel:&#x2F;kubic:&#x2F;libcontainers:&#x2F;stable&#x2F;xUbuntu_$&#123;VERSION_ID&#125;&#x2F;Release.key | sudo apt-key add -</span><br><span class="line">$ sudo apt-get update</span><br><span class="line">$ sudo apt-get -y upgrade</span><br><span class="line">$ sudo apt-get -y install skopeo</span><br></pre></td></tr></table></figure>
<h3><span id="23-容器安装运行">2.3 容器安装运行</span></h3>
<p>Skopeo 容器镜像可在 <a href="http://quay.io/skopeo/stable:latest" target="_blank" rel="noopener">quay.io/skopeo/stable:latest</a> 获得, 例如我们采用podman命令进行如下操作:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ podman run docker:&#x2F;&#x2F;quay.io&#x2F;skopeo&#x2F;stable:latest copy --help</span><br></pre></td></tr></table></figure>
<h2><span id="3-快速上手">3. 快速上手</span></h2>
<h3><span id="31-命令浅析">3.1 命令浅析</span></h3>
<p>描述: skopen 是操作各种容器映像和容器映像仓库的工具，其使用方法及其可用命令如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">$ .&#x2F;skopeo --help    # 子命令可采用如下命令 skopeo [command] --help 命令</span><br><span class="line">Usage:</span><br><span class="line">  skopeo [flags]</span><br><span class="line">  skopeo [command]</span><br><span class="line">Available Commands: </span><br><span class="line">  copy          # 复制一个镜像从 A 到 B，这里的 A 和 B 可以为本地 docker 镜像或者 registry 上的镜像；</span><br><span class="line">  delete        # 删除一个镜像 tag，可以是本地 docker 镜像或者 registry 上的镜像；</span><br><span class="line">  help          # 帮助查看</span><br><span class="line">  inspect       # 查看一个镜像的 manifest 或者 image config 详细信息；</span><br><span class="line">  list-tags     # 列出存储库名称指定的镜像的tag</span><br><span class="line">  login           # 登陆某个镜像仓库,类似于 docker login 命令</span><br><span class="line">  logout          # 退出某个已认证的镜像仓库, 类似于 docker logout 命令</span><br><span class="line">  manifest-digest # 计算文件的清单摘要是一个sha256sum 值</span><br><span class="line">  standalone-sign   # 使用本地文件创建签名</span><br><span class="line">  standalone-verify # 验证本地文件的签名</span><br><span class="line">  sync              # 将一个或多个图像从一个位置同步到另一个位置 (该功能非常Nice)</span><br><span class="line">Flags:</span><br><span class="line">    --command-timeout duration   # 命令超时时间(单位秒)</span><br><span class="line">    --debug                      # 启用debug模式</span><br><span class="line">    --insecure-policy            # 在不进行任何策略检查的情况下运行该工具（如果没有配置 policy 的话需要加上该参数）</span><br><span class="line">    --override-arch ARCH         # 处理镜像时覆盖客户端 CPU 体系架构，如在 amd64 的机器上用 skopeo 处理 arm64 的镜像</span><br><span class="line">    --override-os OS             # 处理镜像时覆盖客户端 OS</span><br><span class="line">    --override-variant VARIANT   # 处理镜像时使用VARIANT而不是运行架构变量</span><br><span class="line">    --policy string              # 信任策略文件的路径 (为镜像配置安全策略情况下使用)</span><br><span class="line">    --registries.d DIR           # 在目录中使用Registry配置文件（例如，用于容器签名存储）</span><br><span class="line">    --tmpdir string              # 用于存储临时文件的目录</span><br><span class="line">-h, --help                       help for skopeo </span><br><span class="line">-v, --version                    Version for Skopeo</span><br></pre></td></tr></table></figure>
<h3><span id="32-skopeo-初体验">3.2 Skopeo 初体验</span></h3>
<p>描述: 在使用体验skopeo之前，我们需要了解一哈 Skopeo 可以在那些图像和存储库类型上执行镜像操作(官网文档走一波)：</p>
<table>
<thead>
<tr>
<th style="text-align:center">Repository types</th>
<th>Describe</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>containers-storage:docker-reference</code></td>
<td>适用于后端是 Podman, CRI-O, Buildah 的情况</td>
<td><code>containers-storage:</code></td>
</tr>
<tr>
<td style="text-align:center"><code>dir:path</code></td>
<td>适用于将manifest, layer tarballs 和 signatures 存储为单独文件的现有本地目录路径的情况</td>
<td><code>dir:/tmp/alpine:latest</code></td>
</tr>
<tr>
<td style="text-align:center"><code>docker://docker-reference</code></td>
<td>适用于Registry中实现&quot;Docker Registry HTTP API V2&quot;的镜像的情况</td>
<td><code>docker://harbor.weiyigeek.top/myblog:v2.8</code></td>
</tr>
<tr>
<td style="text-align:center"><code>docker-archive:path[:docker-reference]</code></td>
<td>适用于采用<code>docker save</code>命令导出镜像以tar格式存储的文件的情况</td>
<td><code>docker-archive:alpine.tar</code></td>
</tr>
<tr>
<td style="text-align:center"><code>docker-daemon:docker-reference</code></td>
<td>适用于存储在 docker 守护进程内部存储中的图像的情况</td>
<td><code>docker-daemon:alpine:latest</code></td>
</tr>
<tr>
<td style="text-align:center"><code>oci:path:tag</code></td>
<td>适用于符合&quot;Open Container Image Layout Specification&quot;的目录中的图像标记</td>
<td><code>oci:alpine:latest</code></td>
</tr>
</tbody>
</table>
<blockquote>
<p>温馨提示: 同一个镜像存在的方式有可能不同，不同类型方式存储对镜像的 layer 处理的方式也不一样,。</p>
</blockquote>
<p><strong>测试环境说明</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Docker 官方 hub 仓库 -&gt; docker.io             # 官网地址: https:&#x2F;&#x2F;hub.docker.com&#x2F;</span><br><span class="line">私有 Harbor 仓库     -&gt; harbor.weiyigeek.top</span><br><span class="line">临时创建的本地仓库    -&gt; 192.168.12.111:5000   # 一梭子解决: docker run -d -p 5000:5000 --name registry -v &#x2F;opt&#x2F;data&#x2F;registry:&#x2F;var&#x2F;lib&#x2F;registry registry:2</span><br></pre></td></tr></table></figure>
<blockquote>
<p>说明: 上述仓库都是在Registry中支持Docker Registry HTTP API V2版本的。</p>
</blockquote>
<h4><span id="321-skopeo-loginloout-远程仓库-auth">3.2.1 Skopeo login/loout - 远程仓库 Auth</span></h4>
<p>描述: 在使用 skopeo 前如果 src 或 dest 镜像是在 registry 仓库中的并且配置了非 public 的镜像需要相应的 auth 认证, 此时我们可以使用 <code>docker login</code> 或者 <code>skopeo login</code> 的方式登录到 registry 仓库，然后默认会在<code>~/.docker</code>目录下生成 registry 登录配置文件 config.json ,该文件里保存了登录需要的验证信息，skopeo 拿到该验证信息才有权限往 registry push 镜像。</p>
<ul>
<li><strong>登陆认证</strong></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"># (1) skopeo login 登陆示例 (两种方式)</span><br><span class="line">$ skopeo login -u WeiyiGeek -p testpassword harbor.weiyigeek.top</span><br><span class="line">  # Login Succeeded!</span><br><span class="line"></span><br><span class="line"># (2) docker login 登陆示例</span><br><span class="line">$ docker login -u WeiyiGeek docker.io</span><br><span class="line">$ docker login -u WeiyiGeek harbor.weiyigeek.top</span><br><span class="line">$ docker login -u anonymous -p anonymous 192.168.12.111:5000  # 实际上临时仓库没有配置认证, 账号密码随意即可。</span><br><span class="line">  # WARNING! Using --password via the CLI is insecure. Use --password-stdin.</span><br><span class="line">  # WARNING! Your password will be stored unencrypted in &#x2F;root&#x2F;.docker&#x2F;config.json.</span><br><span class="line">  # Configure a credential helper to remove this warning. See</span><br><span class="line">  # https:&#x2F;&#x2F;docs.docker.com&#x2F;engine&#x2F;reference&#x2F;commandline&#x2F;login&#x2F;#credentials-store</span><br><span class="line">  # Login Succeeded</span><br><span class="line"></span><br><span class="line"># (3) docker login 生成的 registry 登录配置文件（base64编码安全性不多说）</span><br><span class="line">$ cat ~&#x2F;.docker&#x2F;config.json</span><br><span class="line">&#123;</span><br><span class="line">  &quot;auths&quot;: &#123;</span><br><span class="line">    &quot;192.168.12.111:5000&quot;: &#123;</span><br><span class="line">        &quot;auth&quot;: &quot;YW5v*******Q&#x3D;&#x3D;&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">    &quot;harbor.weiyigeek.top&quot;: &#123;</span><br><span class="line">        &quot;auth&quot;: &quot;YWR*******LkA&#x3D;&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">    &quot;https:&#x2F;&#x2F;index.docker.io&#x2F;v1&#x2F;&quot;: &#123;</span><br><span class="line">        &quot;auth&quot;: &quot;d2Vp**************kyZA&#x3D;&#x3D;&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>注销认证</strong></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ skopeo logout myregistrydomain.com:5000</span><br></pre></td></tr></table></figure>
<blockquote>
<p>温馨提示: 如果企业自建harbor仓库(一般都会设置自签证书)或者其它私有仓库配置证书,为了防止出错建议进行以下操作(正式环境请根据需要进行配置)。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># (1) 在 &#x2F;etc&#x2F;docker&#x2F;daemon.json 中配置 insecure-registries 字段,表示允许不安全的仓库。</span><br><span class="line">&quot;insecure-registries&quot;: [&quot;harbor.weiyigeek.top&quot;,&quot;192.168.12.111:5000&quot;]</span><br><span class="line"> </span><br><span class="line"># (2) 从官方文档可知客户端要使用tls与Harbor通信使用的还是&#96;自签证书&#96;，那么必须建立一个目录：&#96;&#x2F;etc&#x2F;docker&#x2F;certs.d&#96;</span><br><span class="line"># 如果配置可能会出现 x509: certificate signed by unknown authority 错误提示。</span><br><span class="line">$ mkdir -vp &#x2F;etc&#x2F;docker&#x2F;certs.d&#x2F;harbor.weiyigeek.top</span><br><span class="line">$ cp -a &#x2F;deployapp&#x2F;harbor&#x2F;harbor.pem  &#x2F;etc&#x2F;docker&#x2F;certs.d&#x2F;harbor.weiyigeek.top&#x2F;harbor.crt</span><br></pre></td></tr></table></figure>
<blockquote>
<p>温馨提示: 为了防止后续执行 skopeo 命令操作镜像时出错, 建议忽略 policy 策略和证书校验参数如下:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">--insecure-policy \</span><br><span class="line">--src-tls-verify&#x3D;false \ </span><br><span class="line">--dest-tls-verify&#x3D;false \</span><br></pre></td></tr></table></figure>
<h4><span id="322-skopeo-inspect-检查存储库中的镜像">3.2.2 Skopeo inspect - 检查存储库中的镜像</span></h4>
<p>描述: skopeo 能够检查容器 Registry 上的存储库并获取图像层。检查命令获取存储库的清单，它能够向您显示有关整个存储库或标签的类似 <code>docker inspect</code> 的 json 输出。与 docker inspect 相比,此工具可帮助您在拉取存储库或标签之前收集有用的信息(使用磁盘空间), 检查命令可以向您显示给定存储库可用的标签、映像具有的标签、映像的创建日期和操作系统等。</p>
<p>支持传输的类型 : <code>containers-storage, dir, docker, docker-archive, docker-daemon, oci, oci-archive, ostree, tarball</code></p>
<ul>
<li>步骤 01. 显示 busybox:latest 镜像的属性相关信息。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">$ skopeo inspect docker:&#x2F;&#x2F;docker.io&#x2F;busybox:latest</span><br><span class="line">&#123;</span><br><span class="line">  &quot;Name&quot;: &quot;docker.io&#x2F;library&#x2F;busybox&quot;,</span><br><span class="line">  &quot;Digest&quot;: &quot;sha256:5acba83a746c7608ed544dc1533b87c737a0b0fb730301639a0179f9344b1678&quot;,</span><br><span class="line">  &quot;RepoTags&quot;: [</span><br><span class="line">      &quot;1&quot;,</span><br><span class="line">      &quot;1-glibc&quot;,</span><br><span class="line">      &quot;1-musl&quot;,</span><br><span class="line">      &quot;1-ubuntu&quot;,</span><br><span class="line">      &quot;1-uclibc&quot;,</span><br><span class="line">      &quot;1.21-ubuntu&quot;,</span><br><span class="line">      &quot;1.21.0-ubuntu&quot;,</span><br><span class="line">        .......          # 镜像历史tags</span><br><span class="line">      &quot;unstable-uclibc&quot;</span><br><span class="line">  ],</span><br><span class="line">  &quot;Created&quot;: &quot;2021-12-30T19:19:41.006954958Z&quot;,</span><br><span class="line">  &quot;DockerVersion&quot;: &quot;20.10.7&quot;,</span><br><span class="line">  &quot;Labels&quot;: null,</span><br><span class="line">  &quot;Architecture&quot;: &quot;amd64&quot;,</span><br><span class="line">  &quot;Os&quot;: &quot;linux&quot;,</span><br><span class="line">  &quot;Layers&quot;: [</span><br><span class="line">      &quot;sha256:5cc84ad355aaa64f46ea9c7bbcc319a9d808ab15088a27209c9e70ef86e5a2aa&quot;</span><br><span class="line">  ],</span><br><span class="line">  &quot;Env&quot;: [</span><br><span class="line">      &quot;PATH&#x3D;&#x2F;usr&#x2F;local&#x2F;sbin:&#x2F;usr&#x2F;local&#x2F;bin:&#x2F;usr&#x2F;sbin:&#x2F;usr&#x2F;bin:&#x2F;sbin:&#x2F;bin&quot;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>步骤 02. 显示 busybox:latest 镜像的容器配置相关信息。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">$ skopeo inspect --config docker:&#x2F;&#x2F;docker.io&#x2F;busybox:latest  | jq</span><br><span class="line">&#123;</span><br><span class="line">  &quot;created&quot;: &quot;2021-12-30T19:19:41.006954958Z&quot;,</span><br><span class="line">  &quot;architecture&quot;: &quot;amd64&quot;,</span><br><span class="line">  &quot;os&quot;: &quot;linux&quot;,</span><br><span class="line">  &quot;config&quot;: &#123;</span><br><span class="line">    &quot;Env&quot;: [</span><br><span class="line">      &quot;PATH&#x3D;&#x2F;usr&#x2F;local&#x2F;sbin:&#x2F;usr&#x2F;local&#x2F;bin:&#x2F;usr&#x2F;sbin:&#x2F;usr&#x2F;bin:&#x2F;sbin:&#x2F;bin&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;Cmd&quot;: [</span><br><span class="line">      &quot;sh&quot;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;rootfs&quot;: &#123;</span><br><span class="line">    &quot;type&quot;: &quot;layers&quot;,</span><br><span class="line">    &quot;diff_ids&quot;: [</span><br><span class="line">      &quot;sha256:01fd6df81c8ec7dd24bbbd72342671f41813f992999a3471b9d9cbc44ad88374&quot;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;history&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;created&quot;: &quot;2021-12-30T19:19:40.833034683Z&quot;,</span><br><span class="line">      &quot;created_by&quot;: &quot;&#x2F;bin&#x2F;sh -c #(nop) ADD file:6db446a57cbd2b7f4cfde1f280177b458390ed5a6d1b54c6169522bc2c4d838e in &#x2F; &quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;created&quot;: &quot;2021-12-30T19:19:41.006954958Z&quot;,</span><br><span class="line">      &quot;created_by&quot;: &quot;&#x2F;bin&#x2F;sh -c #(nop)  CMD [\&quot;sh\&quot;]&quot;,</span><br><span class="line">      &quot;empty_layer&quot;: true</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>步骤 03. 显示未经验证的图像 Digest（摘要）</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ skopeo inspect --format &quot;Name: &#123;&#123;.Name&#125;&#125; Digest: &#123;&#123;.Digest&#125;&#125;&quot; docker:&#x2F;&#x2F;docker.io&#x2F;busybox:latest</span><br></pre></td></tr></table></figure>
<h4><span id="323-skopeo-copy-仓库镜像拷贝">3.2.3 Skopeo copy - 仓库镜像拷贝</span></h4>
<p>描述: skopeo 可以在各种存储机制之间复制容器镜像，支持包括容器仓库(<code>The Quay, Docker Hub, OpenShift, GCR, ，Artifactory ...</code>)以及容器存储后端 (<code>Podman, CRI-O, Docker</code>) 等、本地目录、本地 OCI-layout 目录。</p>
<p>例如，此处我从 hub 仓库复制 <code>busybox:latest</code> 镜像到私有 harbor 仓库中,在从私有 harbor 仓库中拷贝到本地指定目录中。</p>
<ul>
<li>步骤 01. 从 regsitry A 到 registry B 复制 busybox:latest 镜像。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ skopeo copy --insecure-policy --src-tls-verify&#x3D;false --dest-tls-verify&#x3D;false --dest-authfile &#x2F;root&#x2F;.docker&#x2F;config.json docker:&#x2F;&#x2F;docker.io&#x2F;busybox:latest docker:&#x2F;&#x2F;harbor.weiyigeek.top&#x2F;devops&#x2F;busybox:latest</span><br><span class="line">  # Getting image source signatures</span><br><span class="line">  # Copying blob 5cc84ad355aa done</span><br><span class="line">  # Copying config beae173cca done</span><br><span class="line">  # Writing manifest to image destination</span><br><span class="line">  # Storing signatures</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Tips: 由上述日志可以看到 skopeo 是直接从 registry 中 copy 镜像 layer 的 blob 文件，传输是镜像在 registry 中存储的原始格式。</p>
</blockquote>
<ul>
<li>步骤 02. 从 registry B 复制 busybox:latest 镜像到本地 busybox:latest 目录中。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">$ skopeo copy --insecure-policy --src-tls-verify&#x3D;false docker:&#x2F;&#x2F;harbor.weiyigeek.top&#x2F;devops&#x2F;busybox:latest dir:busybox:latest</span><br><span class="line"># Getting image source signatures</span><br><span class="line"># Copying blob 5cc84ad355aa done</span><br><span class="line"># Copying config beae173cca done</span><br><span class="line"># Writing manifest to image destination</span><br><span class="line"># Storing signatures</span><br><span class="line"></span><br><span class="line">$ ls &amp;&amp; tree busybox\:latest&#x2F;</span><br><span class="line">busybox:latest&#x2F;</span><br><span class="line">├── 5cc84ad355aaa64f46ea9c7bbcc319a9d808ab15088a27209c9e70ef86e5a2aa   # blob 块文件 -&gt; vnd.docker.image.rootfs.diff.tar.gzip</span><br><span class="line">├── beae173ccac6ad749f76713cf4440fe3d21d1043fe616dfbe30775815d1d0f6a   # 镜像配置信息文件 -&gt; vnd.docker.container.image.v1+json </span><br><span class="line">├── manifest.json</span><br><span class="line">└── version</span><br><span class="line">0 directories, 4 files</span><br><span class="line"></span><br><span class="line"># 查看镜像的 manifest 文件</span><br><span class="line">$ cat busybox\:latest&#x2F;manifest.json</span><br><span class="line">&#123;</span><br><span class="line">   &quot;schemaVersion&quot;: 2,</span><br><span class="line">   &quot;mediaType&quot;: &quot;application&#x2F;vnd.docker.distribution.manifest.v2+json&quot;,</span><br><span class="line">   &quot;config&quot;: &#123;</span><br><span class="line">      &quot;mediaType&quot;: &quot;application&#x2F;vnd.docker.container.image.v1+json&quot;,</span><br><span class="line">      &quot;size&quot;: 1456,</span><br><span class="line">      &quot;digest&quot;: &quot;sha256:beae173ccac6ad749f76713cf4440fe3d21d1043fe616dfbe30775815d1d0f6a&quot;</span><br><span class="line">   &#125;,</span><br><span class="line">   &quot;layers&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">         &quot;mediaType&quot;: &quot;application&#x2F;vnd.docker.image.rootfs.diff.tar.gzip&quot;,</span><br><span class="line">         &quot;size&quot;: 772788,</span><br><span class="line">         &quot;digest&quot;: &quot;sha256:5cc84ad355aaa64f46ea9c7bbcc319a9d808ab15088a27209c9e70ef86e5a2aa&quot;</span><br><span class="line">      &#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 根据 manifest 文件查看镜像的 image config 文件 (存放镜像Build指令与镜像相关配置信息)</span><br><span class="line">$ jq &#39;.&#39; busybox\:latest&#x2F;beae173ccac6ad749f76713cf4440fe3d21d1043fe616dfbe30775815d1d0f6a</span><br><span class="line">&#123;</span><br><span class="line">  &quot;architecture&quot;: &quot;amd64&quot;,</span><br><span class="line">  &quot;config&quot;: &#123;</span><br><span class="line">    &quot;Hostname&quot;: &quot;&quot;,</span><br><span class="line">    &quot;Domainname&quot;: &quot;&quot;,</span><br><span class="line">    &quot;User&quot;: &quot;&quot;,</span><br><span class="line">    &quot;AttachStdin&quot;: false,</span><br><span class="line">    &quot;AttachStdout&quot;: false,</span><br><span class="line">    &quot;AttachStderr&quot;: false,</span><br><span class="line">    &quot;Tty&quot;: false,</span><br><span class="line">    &quot;OpenStdin&quot;: false,</span><br><span class="line">    &quot;StdinOnce&quot;: false,</span><br><span class="line">    &quot;Env&quot;: [</span><br><span class="line">      &quot;PATH&#x3D;&#x2F;usr&#x2F;local&#x2F;sbin:&#x2F;usr&#x2F;local&#x2F;bin:&#x2F;usr&#x2F;sbin:&#x2F;usr&#x2F;bin:&#x2F;sbin:&#x2F;bin&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;Cmd&quot;: [</span><br><span class="line">      &quot;sh&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;Image&quot;: &quot;sha256:da658412c37aa24e561eb7e16c61bc82a9711340d8fb5cf1a8f39d8e96d7f723&quot;,</span><br><span class="line">    &quot;Volumes&quot;: null,</span><br><span class="line">    &quot;WorkingDir&quot;: &quot;&quot;,</span><br><span class="line">    &quot;Entrypoint&quot;: null,</span><br><span class="line">    &quot;OnBuild&quot;: null,</span><br><span class="line">    &quot;Labels&quot;: null</span><br><span class="line">  &#125;,</span><br><span class="line">........</span><br><span class="line">  &quot;history&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;created&quot;: &quot;2021-12-30T19:19:40.833034683Z&quot;,</span><br><span class="line">      &quot;created_by&quot;: &quot;&#x2F;bin&#x2F;sh -c #(nop) ADD file:6db446a57cbd2b7f4cfde1f280177b458390ed5a6d1b54c6169522bc2c4d838e in &#x2F; &quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;created&quot;: &quot;2021-12-30T19:19:41.006954958Z&quot;,</span><br><span class="line">      &quot;created_by&quot;: &quot;&#x2F;bin&#x2F;sh -c #(nop)  CMD [\&quot;sh\&quot;]&quot;,</span><br><span class="line">      &quot;empty_layer&quot;: true</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  &quot;os&quot;: &quot;linux&quot;,</span><br><span class="line">  &quot;rootfs&quot;: &#123;</span><br><span class="line">    &quot;type&quot;: &quot;layers&quot;,</span><br><span class="line">    &quot;diff_ids&quot;: [</span><br><span class="line">      &quot;sha256:01fd6df81c8ec7dd24bbbd72342671f41813f992999a3471b9d9cbc44ad88374&quot;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>步骤 03. 将 busybox:latest 镜像从 registry B 复制到本地目录，并以 OCI 格式保存</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ skopeo copy --insecure-policy --src-tls-verify&#x3D;false docker:&#x2F;&#x2F;harbor.weiyigeek.top&#x2F;devops&#x2F;busybox:latest oci:busybox-latest</span><br><span class="line">  # Getting image source signatures</span><br><span class="line">  # Copying blob 5cc84ad355aa done</span><br><span class="line">  # Copying config 48edd9298a done</span><br><span class="line">  # Writing manifest to image destination</span><br><span class="line">  # Storing signatures</span><br><span class="line"></span><br><span class="line">$ tree -h busybox-latest&#x2F;</span><br><span class="line">  # busybox-latest&#x2F;</span><br><span class="line">  # ├── [4.0K]  blobs</span><br><span class="line">  # │   └── [4.0K]  sha256</span><br><span class="line">  # │       ├── [ 347]  1612e16ff3f6b0d09eefdc4e9d5c5c0624f63032743e016585b095b958778016</span><br><span class="line">  # │       ├── [ 575]  48edd9298a25de2c97cd574a5523026f87576c6b7202330a2b60ce7d304ec307</span><br><span class="line">  # │       └── [755K]  5cc84ad355aaa64f46ea9c7bbcc319a9d808ab15088a27209c9e70ef86e5a2aa  # Blob 块 -</span><br><span class="line">  # ├── [ 186]  index.json</span><br><span class="line">  # └── [  31]  oci-layout</span><br><span class="line">  # 2 directories, 5 files</span><br></pre></td></tr></table></figure>
<ul>
<li>步骤 04. 将 <code>alpine:3.13.1</code> 镜像从 docker 本地存储（ /var/lib/docker/image） push 到 registry B中(实际上替代 docker push 功能)</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 在  &#x2F;var&#x2F;lib&#x2F;docker&#x2F; 目录中此处主要关心 image (主要存放镜像中layer层的元数据) 和 overlay2 (各层的具体信息)</span><br><span class="line">$ docker images alpine:3.13.1</span><br><span class="line">  # REPOSITORY   TAG       IMAGE ID       CREATED         SIZE</span><br><span class="line">  # alpine       3.13.1    e50c909a8df2   11 months ago   5.61MB</span><br><span class="line"></span><br><span class="line">$ skopeo copy --insecure-policy --dest-tls-verify&#x3D;false --dest-authfile &#x2F;root&#x2F;.docker&#x2F;config.json docker-daemon:alpine:3.13.1 docker:&#x2F;&#x2F;harbor.weiyigeek.top&#x2F;devops&#x2F;alpine:3.13.1</span><br><span class="line">  # Getting image source signatures</span><br><span class="line">  # Copying blob 1119ff37d4a9 done</span><br><span class="line">  # Copying config e50c909a8d done</span><br><span class="line">  # Writing manifest to image destination</span><br><span class="line">  # Storing signatures</span><br></pre></td></tr></table></figure>
<p><img src="https://img.hi-linux.com/staticfile/640-20220520095506113-2022-05-20-jxlRy3.png" alt></p>
<h4><span id="324-skopeo-sync-镜像同步命令">3.2.4 Skopeo sync - 镜像同步命令</span></h4>
<p>描述: Skopeo sync可以在容器仓库和本地目录之间同步镜像，其功能类似于阿里云的 image-syncer (<a href="https://github.com/AliyunContainerService/image-syncer" target="_blank" rel="noopener">https://github.com/AliyunContainerService/image-syncer</a>) 工具, 实际上其比 image-syncer 更强大、灵活性更强一些，废话不多说实践为王。</p>
<p>skopeo sync 镜像同步文件示例:</p>
<ul>
<li>步骤 01. 将仓库中所有 busybox 镜像版本同步到本地目录。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ skopeo sync --insecure-policy --src-tls-verify&#x3D;false --src docker --dest dir harbor.weiyigeek.top&#x2F;devops&#x2F;busybox &#x2F;tmp</span><br><span class="line">  # INFO[0000] Tag presence check                            imagename&#x3D;harbor.weiyigeek.top&#x2F;devops&#x2F;busybox tagged&#x3D;false</span><br><span class="line">  # INFO[0000] Getting tags                                  image&#x3D;harbor.weiyigeek.top&#x2F;devops&#x2F;busybox</span><br><span class="line">  # INFO[0000] Copying image ref 1&#x2F;1                         from&#x3D;&quot;docker:&#x2F;&#x2F;harbor.weiyigeek.top&#x2F;devops&#x2F;busybox:latest&quot; to&#x3D;&quot;dir:&#x2F;tmp&#x2F;busybox:latest&quot;</span><br><span class="line">  # Getting image source signatures</span><br><span class="line">  # Copying blob 5cc84ad355aa done</span><br><span class="line">  # Copying config beae173cca done</span><br><span class="line">  # Writing manifest to image destination</span><br><span class="line">  # Storing signatures</span><br><span class="line">  # INFO[0000] Synced 1 images from 1 sources</span><br><span class="line"></span><br><span class="line">$ tree -h &#x2F;tmp&#x2F;busybox:latest</span><br><span class="line">&#x2F;tmp&#x2F;busybox:latest</span><br><span class="line">├── [755K]  5cc84ad355aaa64f46ea9c7bbcc319a9d808ab15088a27209c9e70ef86e5a2aa</span><br><span class="line">├── [1.4K]  beae173ccac6ad749f76713cf4440fe3d21d1043fe616dfbe30775815d1d0f6a</span><br><span class="line">├── [ 527]  manifest.json</span><br><span class="line">└── [  33]  version</span><br><span class="line">0 directories, 4 files</span><br></pre></td></tr></table></figure>
<ul>
<li>步骤 02. 从本地目录 <code>/tmp/</code> 同步到 docker 的 hub 容器仓库中，此外我们可以通过浏览器看到 <code>weiyigeek</code> 用户下的 <code>busybox</code> 镜像 (<a href="https://hub.docker.com/u/weiyigeek" target="_blank" rel="noopener">https://hub.docker.com/u/weiyigeek</a>)。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ skopeo sync --insecure-policy --dest-tls-verify&#x3D;false --src dir --dest docker &#x2F;tmp weiyigeek</span><br><span class="line">  # INFO[0000] Copying image ref 1&#x2F;1                         from&#x3D;&quot;dir:&#x2F;tmp&#x2F;busybox:latest&quot; to&#x3D;&quot;docker:&#x2F;&#x2F;weiyigeek&#x2F;busybox:latest&quot;</span><br><span class="line">  # Getting image source signatures</span><br><span class="line">  # Copying blob 5cc84ad355aa skipped: already exists</span><br><span class="line">  # Copying config beae173cca done</span><br><span class="line">  # Writing manifest to image destination</span><br><span class="line">  # Storing signatures</span><br><span class="line">  # INFO[0021] Synced 1 images from 1 sources</span><br></pre></td></tr></table></figure>
<p><img src="https://img.hi-linux.com/staticfile/640-20220520095506152-2022-05-20-wOfOkf.png" alt></p>
<ul>
<li>步骤 03. 从 hub 容器仓库中同步 alpine-jenkins-jnlp:v2.285 镜像到本地临时容器仓库中。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ skopeo sync --insecure-policy --src-tls-verify&#x3D;false --dest-tls-verify&#x3D;false --src docker --dest docker weiyigeek&#x2F;alpine-jenkins-jnlp:v2.285 192.168.12.111:5000&#x2F;</span><br><span class="line">  # INFO[0000] Tag presence check imagename&#x3D;&quot;weiyigeek&#x2F;alpine-jenkins-jnlp:v2.285&quot; tagged&#x3D;true</span><br><span class="line">  # INFO[0000] Copying image ref 1&#x2F;1 from&#x3D;&quot;docker:&#x2F;&#x2F;weiyigeek&#x2F;alpine-jenkins-jnlp:v2.285&quot; to&#x3D;&quot;docker:&#x2F;&#x2F;192.168.12.111:5000&#x2F;alpine-jenkins-jnlp:v2.285&quot;</span><br><span class="line">  # Getting image source signatures</span><br><span class="line">  # Copying blob 68517a8c32d3 [&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&gt;-------------------------------] 45.0MiB &#x2F; 255.7MiB</span><br><span class="line">  # Copying blob 4c0d98bf9879 done</span><br></pre></td></tr></table></figure>
<ul>
<li>步骤 04. 以配置文件方式进行同步, 首先我们需要准备一个需要同步的资源清单。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># YAML 文件内容（用于 **--src yaml** 的源）</span><br><span class="line">$ cat &lt;&lt;&#39;EOF&#39; &gt; skopeo-sync.yml</span><br><span class="line">registry.example.com:</span><br><span class="line">  images:</span><br><span class="line">    busybox: []</span><br><span class="line">    redis:</span><br><span class="line">      - &quot;1.0&quot;</span><br><span class="line">      - &quot;2.0&quot;</span><br><span class="line">      - &quot;sha256:111111&quot;</span><br><span class="line">  images-by-tag-regex:</span><br><span class="line">      nginx: ^1\.13\.[12]-alpine-perl$</span><br><span class="line">  credentials:</span><br><span class="line">      username: john</span><br><span class="line">      password: this is a secret</span><br><span class="line">  tls-verify: true</span><br><span class="line">  cert-dir: &#x2F;home&#x2F;john&#x2F;certs</span><br><span class="line">quay.io:</span><br><span class="line">  tls-verify: false</span><br><span class="line">  images:</span><br><span class="line">    coreos&#x2F;etcd:</span><br><span class="line">      - latest</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"># 以yaml文件方式进行同步镜像到 my-registry.local.lan&#x2F;repo&#x2F; 仓库中</span><br><span class="line">$ skopeo sync --src yaml --dest docker skopeo-sync.yml my-registry.local.lan&#x2F;repo&#x2F;</span><br></pre></td></tr></table></figure>
<p>skopeo-sync.yml 文件中镜像匹配复制镜像说明:</p>
<ul>
<li><a href="http://registry.example.com/busybox" target="_blank" rel="noopener">registry.example.com/busybox</a> : 所有版本的镜像.</li>
<li><a href="http://registry.example.com/redis" target="_blank" rel="noopener">registry.example.com/redis</a> : 标记为“1.0”和“2.0”的图像以及带有摘要的图像&quot;sha256:0000000000000000000000000000000011111111111111111111111111111111&quot;.</li>
<li><a href="http://registry.example.com/nginx" target="_blank" rel="noopener">registry.example.com/nginx</a> : 图片标记为“1.13.1-alpine-perl”和“1.13.2-alpine-perl”.</li>
<li><a href="http://quay.io/coreos/etcd" target="_blank" rel="noopener">quay.io/coreos/etcd</a> : 拉取最新版本的镜像。</li>
</ul>
<h4><span id="325-skopeo-list-tags-仓库中镜像-tag-查看">3.2.5 Skopeo list-tags - 仓库中镜像 Tag 查看</span></h4>
<p>描述: 利用该命令我们可以列出 registry 上的某个镜像的所有 tag ，它是使用标准的 registry API 来获取镜像 tag。</p>
<p>简单示例:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ skopeo list-tags docker:&#x2F;&#x2F;harbor.weiyigeek.top&#x2F;devops&#x2F;busybox:latest</span><br></pre></td></tr></table></figure>
<h4><span id="326-skopeo-delete-删除仓库中镜像-tag">3.2.6 Skopeo delete - 删除仓库中镜像 Tag</span></h4>
<p>描述: 使用该命令我们可以删除镜像 Tag,注意此处仅仅只是通过 registry API 来删除镜像的 tag（即删除了 tag 对 manifests 文件的引用）并非真正将镜像删除掉，如果想要删除镜像的 layer 还是需要通过 registry GC 的方式。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"># 方式1. 利用 skopeo delete</span><br><span class="line">$ skopeo delete docker:&#x2F;&#x2F;harbor.weiyigeek.top&#x2F;devops&#x2F;busybox:latest --debug</span><br><span class="line">  # DEBU[0000] Loading registries configuration &quot;&#x2F;etc&#x2F;containers&#x2F;registries.conf&quot;</span><br><span class="line">  # DEBU[0000] Found credentials for harbor.weiyigeek.top in credential helper containers-auth.json in file &#x2F;home&#x2F;weiyigeek&#x2F;.docker&#x2F;config.json</span><br><span class="line">  # DEBU[0000] Using registries.d directory &#x2F;etc&#x2F;containers&#x2F;registries.d for sigstore configuration</span><br><span class="line">  # DEBU[0000]  No signature storage configuration found for harbor.weiyigeek.top&#x2F;devops&#x2F;busybox:latest, using built-in default file:&#x2F;&#x2F;&#x2F;home&#x2F;weiyigeek&#x2F;.local&#x2F;share&#x2F;containers&#x2F;sigstore</span><br><span class="line">  # DEBU[0000] Looking for TLS certificates and private keys in &#x2F;etc&#x2F;docker&#x2F;certs.d&#x2F;harbor.weiyigeek.top</span><br><span class="line">  # DEBU[0000]  crt: &#x2F;etc&#x2F;docker&#x2F;certs.d&#x2F;harbor.weiyigeek.top&#x2F;harbor.crt</span><br><span class="line">  # DEBU[0000] GET https:&#x2F;&#x2F;harbor.weiyigeek.top&#x2F;v2&#x2F;</span><br><span class="line">  # DEBU[0000] Ping https:&#x2F;&#x2F;harbor.weiyigeek.top&#x2F;v2&#x2F; status 401</span><br><span class="line">  # DEBU[0000] GET https:&#x2F;&#x2F;harbor.weiyigeek.top&#x2F;service&#x2F;token?account&#x3D;WeiyiGeek&amp;scope&#x3D;repository%3Adevops%2Fbusybox%3A%2A&amp;service&#x3D;harbor-registry</span><br><span class="line">  # DEBU[0000] GET https:&#x2F;&#x2F;harbor.weiyigeek.top&#x2F;v2&#x2F;devops&#x2F;busybox&#x2F;manifests&#x2F;latest</span><br><span class="line">  # DEBU[0000] DELETE https:&#x2F;&#x2F;harbor.weiyigeek.top&#x2F;v2&#x2F;devops&#x2F;busybox&#x2F;manifests&#x2F;sha256:62ffc2ed7554e4c6d360bce40bbcf196573dd27c4ce080641a2c59867e732dee</span><br><span class="line">  # DEBU[0000] Deleting &#x2F;home&#x2F;weiyigeek&#x2F;.local&#x2F;share&#x2F;containers&#x2F;sigstore&#x2F;devops&#x2F;busybox@sha256&#x3D;62ffc2ed7554e4c6d360bce40bbcf196573dd27c4ce080641a2c59867e732dee&#x2F;signature-1</span><br><span class="line"></span><br><span class="line"># 方式2.利用 curl 命令进行 registery 进行删除 Tag。</span><br><span class="line">$ curl --header &quot;Accept: application&#x2F;vnd.docker.distribution.manifest.v2+json&quot; -I -X GET http:&#x2F;&#x2F;192.168.12.111:5000&#x2F;v2&#x2F;busybox&#x2F;manifests&#x2F;latest</span><br><span class="line">  # HTTP&#x2F;1.1 200 OK</span><br><span class="line">  # Content-Length: 527</span><br><span class="line">  # Content-Type: application&#x2F;vnd.docker.distribution.manifest.v2+json</span><br><span class="line">  # Docker-Content-Digest: sha256:62ffc2ed7554e4c6d360bce40bbcf196573dd27c4ce080641a2c59867e732dee</span><br><span class="line">  # Docker-Distribution-Api-Version: registry&#x2F;2.0</span><br><span class="line">  # Etag: &quot;sha256:62ffc2ed7554e4c6d360bce40bbcf196573dd27c4ce080641a2c59867e732dee&quot;</span><br><span class="line">  # X-Content-Type-Options: nosniff</span><br><span class="line">  # Date: Thu, 20 Jan 2022 13:18:28 GMT</span><br><span class="line"></span><br><span class="line"># 一把梭织搞定</span><br><span class="line">$ Docker-Content-Digest&#x3D;$(curl -s --header &quot;Accept: application&#x2F;vnd.docker.distribution.manifest.v2+json&quot; -I -X GET http:&#x2F;&#x2F;192.168.12.111:5000&#x2F;v2&#x2F;busybox&#x2F;manifests&#x2F;latest | grep &quot;Docker-Content-Digest&quot; | cut -d &#39; &#39; -f 2)</span><br><span class="line">$ curl -I -X DELETE http:&#x2F;&#x2F;192.168.12.111:5000&#x2F;v2&#x2F;busybox&#x2F;manifests&#x2F;$&#123;Docker-Content-Digest&#125;</span><br></pre></td></tr></table></figure>
<h2><span id="4-镜像同步最佳实践">4. 镜像同步最佳实践</span></h2>
<p>本节，主要参考我前同事木子.其博客地址(<a href="https://blog.k8s.li" target="_blank" rel="noopener">https://blog.k8s.li</a>)。</p>
<h3><span id="41-指定文本中镜像同步">4.1 指定文本中镜像同步</span></h3>
<p>假如,给你一个镜像列表 images-list.txt, 其格式如下, 我们可以直接采用 shell 脚本调用 skopeo 进行执行。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># images-list.txt</span><br><span class="line">cat &lt;&lt;&#39;EOF&#39; &gt; images-list.txt</span><br><span class="line">kubesphere&#x2F;kube-apiserver:v1.20.6</span><br><span class="line">kubesphere&#x2F;kube-scheduler:v1.20.6</span><br><span class="line">kubesphere&#x2F;kube-proxy:v1.20.6</span><br><span class="line">kubesphere&#x2F;kube-controller-manager:v1.20.6</span><br><span class="line">kubesphere&#x2F;kube-apiserver:v1.19.8</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>同步的 shell 脚本 <a href="http://skopeo-copy.sh" target="_blank" rel="noopener">skopeo-copy.sh</a></strong></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">GREEN_COL&#x3D;&quot;\\033[32;1m&quot;</span><br><span class="line">RED_COL&#x3D;&quot;\\033[1;31m&quot;</span><br><span class="line">NORMAL_COL&#x3D;&quot;\\033[0;39m&quot;</span><br><span class="line"></span><br><span class="line">SOURCE_REGISTRY&#x3D;$1</span><br><span class="line">TARGET_REGISTRY&#x3D;$2</span><br><span class="line"></span><br><span class="line"># shell 变量赋值，当没有从命令行中传递值给SOURCE_REGISTRY和TARGET_REGISTRY变量时，便采用下述值进行覆盖。</span><br><span class="line">: $&#123;IMAGES_LIST_FILE:&#x3D;&quot;images-list.txt&quot;&#125;</span><br><span class="line">: $&#123;TARGET_REGISTRY:&#x3D;&quot;hub.k8s.li&quot;&#125;</span><br><span class="line">: $&#123;SOURCE_REGISTRY:&#x3D;&quot;docker.io&quot;&#125;</span><br><span class="line"></span><br><span class="line">BLOBS_PATH&#x3D;&quot;docker&#x2F;registry&#x2F;v2&#x2F;blobs&#x2F;sha256&quot;</span><br><span class="line">REPO_PATH&#x3D;&quot;docker&#x2F;registry&#x2F;v2&#x2F;repositories&quot;</span><br><span class="line"></span><br><span class="line">set -eo pipefail</span><br><span class="line"></span><br><span class="line">CURRENT_NUM&#x3D;0</span><br><span class="line">ALL_IMAGES&#x3D;&quot;$(sed -n &#39;&#x2F;#&#x2F;d;s&#x2F;:&#x2F;:&#x2F;p&#39; $&#123;IMAGES_LIST_FILE&#125; | sort -u)&quot;</span><br><span class="line">TOTAL_NUMS&#x3D;$(echo &quot;$&#123;ALL_IMAGES&#125;&quot; | wc -l)</span><br><span class="line"></span><br><span class="line"># shopeo 拷贝函数，注意其传递的参数，此处值得学习记录。</span><br><span class="line">skopeo_copy() &#123;</span><br><span class="line"> if skopeo copy --insecure-policy --src-tls-verify&#x3D;false --dest-tls-verify&#x3D;false \</span><br><span class="line"> --override-arch amd64 --override-os linux -q docker:&#x2F;&#x2F;$1 docker:&#x2F;&#x2F;$2; then</span><br><span class="line">  echo -e &quot;$GREEN_COL Progress: $&#123;CURRENT_NUM&#125;&#x2F;$&#123;TOTAL_NUMS&#125; sync $1 to $2 successful $NORMAL_COL&quot;</span><br><span class="line"> else</span><br><span class="line">  echo -e &quot;$RED_COL Progress: $&#123;CURRENT_NUM&#125;&#x2F;$&#123;TOTAL_NUMS&#125; sync $1 to $2 failed $NORMAL_COL&quot;</span><br><span class="line">  exit 2</span><br><span class="line"> fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 调用拷贝函数并记录当前执行序号。</span><br><span class="line">for image in $&#123;ALL_IMAGES&#125;; do</span><br><span class="line"> let CURRENT_NUM&#x3D;$&#123;CURRENT_NUM&#125;+1</span><br><span class="line"> skopeo_copy $&#123;SOURCE_REGISTRY&#125;&#x2F;$&#123;image&#125; $&#123;TARGET_REGISTRY&#125;&#x2F;$&#123;image&#125;</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>执行命令和结果:</strong></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ bash sync.sh docker.io localhost:5000</span><br><span class="line">Progress: 1&#x2F;143 sync docker.io&#x2F;alpine:3.14 to localhost:5000&#x2F;alpine:3.14 successful</span><br><span class="line">Progress: 2&#x2F;143 sync docker.io&#x2F;busybox:1.31.1 to localhost:5000&#x2F;busybox:1.31.1 successful</span><br><span class="line">....</span><br><span class="line">Progress: 142&#x2F;143 sync docker.io&#x2F;weaveworks&#x2F;scope:1.13.0 to localhost:5000&#x2F;weaveworks&#x2F;scope:1.13.0 successful</span><br><span class="line">Progress: 143&#x2F;143 sync docker.io&#x2F;wordpress:4.8-apache to localhost:5000&#x2F;wordpress:4.8-apache successful</span><br></pre></td></tr></table></figure>
<h3><span id="42-使用-registry-存储特性同步">4.2 使用 registry 存储特性同步</span></h3>
<p>描述: 将镜像从 registry 中同步到本地目录，使用 registry 存储的特性，将本地目录中的镜像转换成 registry 存储的格式, 这样的好处就是可以去除一些 skopeo dir 中重复的 layers，减少镜像的总大小。</p>
<ul>
<li><a href="http://convert-images.sh" target="_blank" rel="noopener">convert-images.sh</a></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">set -eo pipefail</span><br><span class="line"></span><br><span class="line">GREEN_COL&#x3D;&quot;\\033[32;1m&quot;</span><br><span class="line">RED_COL&#x3D;&quot;\\033[1;31m&quot;</span><br><span class="line">NORMAL_COL&#x3D;&quot;\\033[0;39m&quot;</span><br><span class="line"></span><br><span class="line"># 命令行参数</span><br><span class="line">SOURCE_REGISTRY&#x3D;$1</span><br><span class="line">TARGET_REGISTRY&#x3D;$2</span><br><span class="line">IMAGES_DIR&#x3D;$2</span><br><span class="line"></span><br><span class="line">: $&#123;IMAGES_DIR:&#x3D;&quot;images&quot;&#125;</span><br><span class="line">: $&#123;IMAGES_LIST_FILE:&#x3D;&quot;images-list.txt&quot;&#125;</span><br><span class="line">: $&#123;SOURCE_REGISTRY:&#x3D;&quot;docker.io&quot;&#125;</span><br><span class="line">: $&#123;TARGET_REGISTRY:&#x3D;&quot;hub.k8s.li&quot;&#125;</span><br><span class="line"></span><br><span class="line"># hub.k8s.li 仓库服务器中的目录</span><br><span class="line">BLOBS_PATH&#x3D;&quot;docker&#x2F;registry&#x2F;v2&#x2F;blobs&#x2F;sha256&quot;</span><br><span class="line">REPO_PATH&#x3D;&quot;docker&#x2F;registry&#x2F;v2&#x2F;repositories&quot;</span><br><span class="line"></span><br><span class="line"># 记录当前数和总镜像数</span><br><span class="line">CURRENT_NUM&#x3D;0</span><br><span class="line">ALL_IMAGES&#x3D;&quot;$(sed -n &#39;&#x2F;#&#x2F;d;s&#x2F;:&#x2F;:&#x2F;p&#39; $&#123;IMAGES_LIST_FILE&#125; | sort -u)&quot;</span><br><span class="line">TOTAL_NUMS&#x3D;$(echo &quot;$&#123;ALL_IMAGES&#125;&quot; | wc -l)</span><br><span class="line"></span><br><span class="line"># 从远程仓库同步指定镜像到本地目录中。</span><br><span class="line">skopeo_sync() &#123;</span><br><span class="line"> if skopeo sync --insecure-policy --src-tls-verify&#x3D;false --dest-tls-verify&#x3D;false \</span><br><span class="line"> --override-arch amd64 --override-os linux --src docker --dest dir $1 $2 &gt; &#x2F;dev&#x2F;null; then</span><br><span class="line">  echo -e &quot;$GREEN_COL Progress: $&#123;CURRENT_NUM&#125;&#x2F;$&#123;TOTAL_NUMS&#125; sync $1 to $2 successful $NORMAL_COL&quot;</span><br><span class="line"> else</span><br><span class="line">  echo -e &quot;$RED_COL Progress: $&#123;CURRENT_NUM&#125;&#x2F;$&#123;TOTAL_NUMS&#125; sync $1 to $2 failed $NORMAL_COL&quot;</span><br><span class="line">  exit 2</span><br><span class="line"> fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">convert_images() &#123;</span><br><span class="line"> rm -rf $&#123;IMAGES_DIR&#125;; mkdir -p $&#123;IMAGES_DIR&#125;</span><br><span class="line"> for image in $&#123;ALL_IMAGES&#125;; do</span><br><span class="line">  let CURRENT_NUM&#x3D;$&#123;CURRENT_NUM&#125;+1</span><br><span class="line">  </span><br><span class="line">  # 取 images-list.txt 文本中的每一行，并分隔存储。</span><br><span class="line">  image_name&#x3D;$&#123;image%%:*&#125;</span><br><span class="line">  image_tag&#x3D;$&#123;image##*:&#125;</span><br><span class="line">  image_repo&#x3D;$&#123;image%%&#x2F;*&#125;</span><br><span class="line"></span><br><span class="line">  # 函数调用 从仓库同步镜像到本地images目录</span><br><span class="line">  skopeo_sync $&#123;SOURCE_REGISTRY&#125;&#x2F;$&#123;image&#125; $&#123;IMAGES_DIR&#125;&#x2F;$&#123;image_repo&#125;</span><br><span class="line"></span><br><span class="line">  # 在本地images目录中，取得get image manifest sha256sum 信息</span><br><span class="line">  manifest&#x3D;&quot;$&#123;IMAGES_DIR&#125;&#x2F;$&#123;image&#125;&#x2F;manifest.json&quot;</span><br><span class="line">  manifest_sha256&#x3D;$(sha256sum $&#123;manifest&#125; | awk &#39;&#123;print $1&#125;&#39;)      # 62ffc2ed7554e4c6d360bce40bbcf196573dd27c4ce080641a2c59867e732dee</span><br><span class="line">  mkdir -p $&#123;BLOBS_PATH&#125;&#x2F;$&#123;manifest_sha256:0:2&#125;&#x2F;$&#123;manifest_sha256&#125; # docker&#x2F;registry&#x2F;v2&#x2F;blobs&#x2F;sha256&#x2F;62&#x2F;62ffc2ed7554e4c6d360bce40bbcf196573dd27c4ce080641a2c59867e732dee</span><br><span class="line">  ln -f $&#123;manifest&#125; $&#123;BLOBS_PATH&#125;&#x2F;$&#123;manifest_sha256:0:2&#125;&#x2F;$&#123;manifest_sha256&#125;&#x2F;data  #  该 data 文件实际上是镜像的 manifest.json 文件。</span><br><span class="line"></span><br><span class="line">  # make image repositories dir</span><br><span class="line">  mkdir -p $&#123;REPO_PATH&#125;&#x2F;$&#123;image_name&#125;&#x2F;&#123;_uploads,_layers,_manifests&#125;</span><br><span class="line">  mkdir -p $&#123;REPO_PATH&#125;&#x2F;$&#123;image_name&#125;&#x2F;_manifests&#x2F;revisions&#x2F;sha256&#x2F;$&#123;manifest_sha256&#125;</span><br><span class="line">  mkdir -p $&#123;REPO_PATH&#125;&#x2F;$&#123;image_name&#125;&#x2F;_manifests&#x2F;tags&#x2F;$&#123;image_tag&#125;&#x2F;&#123;current,index&#x2F;sha256&#125;</span><br><span class="line">  mkdir -p $&#123;REPO_PATH&#125;&#x2F;$&#123;image_name&#125;&#x2F;_manifests&#x2F;tags&#x2F;$&#123;image_tag&#125;&#x2F;index&#x2F;sha256&#x2F;$&#123;manifest_sha256&#125;</span><br><span class="line"></span><br><span class="line">  # create image tag manifest link file</span><br><span class="line">  echo -n &quot;sha256:$&#123;manifest_sha256&#125;&quot; &gt; $&#123;REPO_PATH&#125;&#x2F;$&#123;image_name&#125;&#x2F;_manifests&#x2F;revisions&#x2F;sha256&#x2F;$&#123;manifest_sha256&#125;&#x2F;link  # sha256:62ffc2ed7554e4c6d360bce40bbcf196573dd27c4ce080641a2c59867e732deer</span><br><span class="line">  echo -n &quot;sha256:$&#123;manifest_sha256&#125;&quot; &gt; $&#123;REPO_PATH&#125;&#x2F;$&#123;image_name&#125;&#x2F;_manifests&#x2F;tags&#x2F;$&#123;image_tag&#125;&#x2F;current&#x2F;link</span><br><span class="line">  echo -n &quot;sha256:$&#123;manifest_sha256&#125;&quot; &gt; $&#123;REPO_PATH&#125;&#x2F;$&#123;image_name&#125;&#x2F;_manifests&#x2F;tags&#x2F;$&#123;image_tag&#125;&#x2F;index&#x2F;sha256&#x2F;$&#123;manifest_sha256&#125;&#x2F;link</span><br><span class="line"></span><br><span class="line">  # link image layers file to registry blobs dir</span><br><span class="line">  for layer in $(sed &#39;&#x2F;v1Compatibility&#x2F;d&#39; $&#123;manifest&#125; | grep -Eo &quot;\b[a-f0-9]&#123;64&#125;\b&quot;); do  # 匹配 manifest.json 中&quot;digest&quot;两个不带sha256的值</span><br><span class="line">    mkdir -p $&#123;BLOBS_PATH&#125;&#x2F;$&#123;layer:0:2&#125;&#x2F;$&#123;layer&#125;                 # 5cc84ad355aaa64f46ea9c7bbcc319a9d808ab15088a27209c9e70ef86e5a2aa 、 beae173ccac6ad749f76713cf4440fe3d21d1043fe616dfbe30775815d1d0f6a</span><br><span class="line">    mkdir -p $&#123;REPO_PATH&#125;&#x2F;$&#123;image_name&#125;&#x2F;_layers&#x2F;sha256&#x2F;$&#123;layer&#125;  # 5cc84ad355aaa64f46ea9c7bbcc319a9d808ab15088a27209c9e70ef86e5a2aa 、 beae173ccac6ad749f76713cf4440fe3d21d1043fe616dfbe30775815d1d0f6a</span><br><span class="line">    echo -n &quot;sha256:$&#123;layer&#125;&quot; &gt; $&#123;REPO_PATH&#125;&#x2F;$&#123;image_name&#125;&#x2F;_layers&#x2F;sha256&#x2F;$&#123;layer&#125;&#x2F;link  # sha256:5cc84ad355aaa64f46ea9c7bbcc319a9d808ab15088a27209c9e70ef86e5a2aa</span><br><span class="line">    ln -f $&#123;IMAGES_DIR&#125;&#x2F;$&#123;image&#125;&#x2F;$&#123;layer&#125; $&#123;BLOBS_PATH&#125;&#x2F;$&#123;layer:0:2&#125;&#x2F;$&#123;layer&#125;&#x2F;data     # 复制images目录中 &quot;application&#x2F;vnd.docker.container.image.v1+json&quot; 容器配置 config 与 多个 &quot;application&#x2F;vnd.docker.image.rootfs.diff.tar.gzip&quot; layer </span><br><span class="line">  done</span><br><span class="line"> done</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">convert_images</span><br></pre></td></tr></table></figure>
<ul>
<li><a href="http://install.sh" target="_blank" rel="noopener">install.sh</a> : 使用这个脚本将 registry 存储中的镜像转换成 skopeo dir 的方式，然后再将镜像同步到 registry 中。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">REGISTRY_DOMAIN&#x3D;&quot;harbor.k8s.li&quot;</span><br><span class="line">REGISTRY_PATH&#x3D;&quot;&#x2F;var&#x2F;lib&#x2F;registry&quot;</span><br><span class="line"></span><br><span class="line"># 切换到 registry 存储主目录下</span><br><span class="line">cd $&#123;REGISTRY_PATH&#125;</span><br><span class="line">gen_skopeo_dir() &#123;</span><br><span class="line">   # 定义 registry 存储的 blob 目录 和 repositories 目录，方便后面使用</span><br><span class="line">    BLOB_DIR&#x3D;&quot;docker&#x2F;registry&#x2F;v2&#x2F;blobs&#x2F;sha256&quot;</span><br><span class="line">    REPO_DIR&#x3D;&quot;docker&#x2F;registry&#x2F;v2&#x2F;repositories&quot;</span><br><span class="line">    # 定义生成 skopeo 目录</span><br><span class="line">    SKOPEO_DIR&#x3D;&quot;docker&#x2F;skopeo&quot;</span><br><span class="line">    # 通过 find 出 current 文件夹可以得到所有带 tag 的镜像，因为一个 tag 对应一个 current 目录</span><br><span class="line">    for image in $(find $&#123;REPO_DIR&#125; -type d -name &quot;current&quot;); do</span><br><span class="line">        # 根据镜像的 tag 提取镜像的名字</span><br><span class="line">        name&#x3D;$(echo $&#123;image&#125; | awk -F &#39;&#x2F;&#39; &#39;&#123;print $5&quot;&#x2F;&quot;$6&quot;:&quot;$9&#125;&#39;)</span><br><span class="line">        link&#x3D;$(cat $&#123;image&#125;&#x2F;link | sed &#39;s&#x2F;sha256:&#x2F;&#x2F;&#39;)</span><br><span class="line">        mfs&#x3D;&quot;$&#123;BLOB_DIR&#125;&#x2F;$&#123;link:0:2&#125;&#x2F;$&#123;link&#125;&#x2F;data&quot;</span><br><span class="line">        # 创建镜像的硬链接需要的目录</span><br><span class="line">        mkdir -p &quot;$&#123;SKOPEO_DIR&#125;&#x2F;$&#123;name&#125;&quot;</span><br><span class="line">        # 硬链接镜像的 manifests 文件到目录的 manifest 文件</span><br><span class="line">        ln $&#123;mfs&#125; $&#123;SKOPEO_DIR&#125;&#x2F;$&#123;name&#125;&#x2F;manifest.json</span><br><span class="line">        # 使用正则匹配出所有的 sha256 值，然后排序去重</span><br><span class="line">        layers&#x3D;$(grep -Eo &quot;\b[a-f0-9]&#123;64&#125;\b&quot; $&#123;mfs&#125; | sort -n | uniq)</span><br><span class="line">        for layer in $&#123;layers&#125;; do</span><br><span class="line">          # 硬链接 registry 存储目录里的镜像 layer 和 images config 到镜像的 dir 目录</span><br><span class="line">            ln $&#123;BLOB_DIR&#125;&#x2F;$&#123;layer:0:2&#125;&#x2F;$&#123;layer&#125;&#x2F;data $&#123;SKOPEO_DIR&#125;&#x2F;$&#123;name&#125;&#x2F;$&#123;layer&#125;</span><br><span class="line">        done</span><br><span class="line">    done</span><br><span class="line">&#125;</span><br><span class="line">sync_image() &#123;</span><br><span class="line">    # 使用 skopeo sync 将 dir 格式的镜像同步到 harbor</span><br><span class="line">    for project in $(ls $&#123;SKOPEO_DIR&#125;); do</span><br><span class="line">        skopeo sync --insecure-policy --src-tls-verify&#x3D;false --dest-tls-verify&#x3D;false \</span><br><span class="line">        --src dir --dest docker $&#123;SKOPEO_DIR&#125;&#x2F;$&#123;project&#125; $&#123;REGISTRY_DOMAIN&#125;&#x2F;$&#123;project&#125;</span><br><span class="line">    done</span><br><span class="line">&#125;</span><br><span class="line">gen_skopeo_dir</span><br></pre></td></tr></table></figure>
<blockquote>
<p>温馨提示: 此种方式是有些复杂对于大镜像的复制是推荐的, 而对于一些小镜像且显得多余。</p>
</blockquote>
<h3><span id="43-从-registry-存储中-select-出镜像进行同步">4.3 从 registry 存储中 select 出镜像进行同步</span></h3>
<p>描述: 先将镜像同步到一个 registry 中，再将镜像从 registry 存储中捞出来，该 registry 可以当作一个镜像存储的池子，我们使用 Linux 中硬链接的特性将镜像&quot;复制&quot;一份出来，然后再打一个 tar 包, 这样做的好处就是每次打包镜像的时候都能复用历史的镜像数据，而且性能极快。</p>
<ul>
<li>步骤 01. 先将镜像同步到一个固定的 registry 中。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ bash skopeo-copy.sh docker.io localhost:5000</span><br></pre></td></tr></table></figure>
<ul>
<li>步骤 02. 使用该脚本将镜像从 registry 存储中捞出来</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">set -eo pipefail</span><br><span class="line"># 命令行变量</span><br><span class="line">IMAGES_LIST&#x3D;&quot;$1&quot;</span><br><span class="line">REGISTRY_PATH&#x3D;&quot;$2&quot;</span><br><span class="line">OUTPUT_DIR&#x3D;&quot;$3&quot;</span><br><span class="line"></span><br><span class="line"># Registry 仓库数据目录</span><br><span class="line">BLOB_DIR&#x3D;&quot;docker&#x2F;registry&#x2F;v2&#x2F;blobs&#x2F;sha256&quot;</span><br><span class="line">REPO_DIR&#x3D;&quot;docker&#x2F;registry&#x2F;v2&#x2F;repositories&quot;</span><br><span class="line"></span><br><span class="line"># 判断输出目录是否存在如不存在则移除。</span><br><span class="line">if [ -d $&#123;OUTPUT_DIR&#125; ];then</span><br><span class="line">  rm -rf $&#123;OUTPUT_DIR&#125;;</span><br><span class="line">fi</span><br><span class="line">mkdir -p $&#123;OUTPUT_DIR&#125;</span><br><span class="line"></span><br><span class="line">for image in $(find $&#123;IMAGES_LIST&#125; -type f -name &quot;*.list&quot; | xargs grep -Ev &#39;^#|^&#x2F;&#39; | grep &#39;:&#39;); do</span><br><span class="line">  # 镜像名称和Tag</span><br><span class="line">  image_name&#x3D;$&#123;image%%:*&#125;</span><br><span class="line">  image_tag&#x3D;$&#123;image##*:&#125;</span><br><span class="line"></span><br><span class="line">  # link 路径获取</span><br><span class="line">  tag_link&#x3D;$&#123;REGISTRY_PATH&#125;&#x2F;$&#123;REPO_DIR&#125;&#x2F;$&#123;image_name&#125;&#x2F;_manifests&#x2F;tags&#x2F;$&#123;image_tag&#125;&#x2F;current&#x2F;link</span><br><span class="line">  manifest_sha256&#x3D;$(sed &#39;s&#x2F;sha256:&#x2F;&#x2F;&#39; $&#123;tag_link&#125;)</span><br><span class="line">  manifest&#x3D;$&#123;REGISTRY_PATH&#125;&#x2F;$&#123;BLOB_DIR&#125;&#x2F;$&#123;manifest_sha256:0:2&#125;&#x2F;$&#123;manifest_sha256&#125;&#x2F;data</span><br><span class="line">  mkdir -p $&#123;OUTPUT_DIR&#125;&#x2F;$&#123;BLOB_DIR&#125;&#x2F;$&#123;manifest_sha256:0:2&#125;&#x2F;$&#123;manifest_sha256&#125;</span><br><span class="line"></span><br><span class="line">  # 强制硬链接到指定目录</span><br><span class="line">  ln -f $&#123;manifest&#125; $&#123;OUTPUT_DIR&#125;&#x2F;$&#123;BLOB_DIR&#125;&#x2F;$&#123;manifest_sha256:0:2&#125;&#x2F;$&#123;manifest_sha256&#125;&#x2F;data</span><br><span class="line"></span><br><span class="line">  # make image repositories dir</span><br><span class="line">  mkdir -p $&#123;OUTPUT_DIR&#125;&#x2F;$&#123;REPO_DIR&#125;&#x2F;$&#123;image_name&#125;&#x2F;&#123;_uploads,_layers,_manifests&#125;</span><br><span class="line">  mkdir -p $&#123;OUTPUT_DIR&#125;&#x2F;$&#123;REPO_DIR&#125;&#x2F;$&#123;image_name&#125;&#x2F;_manifests&#x2F;revisions&#x2F;sha256&#x2F;$&#123;manifest_sha256&#125;</span><br><span class="line">  mkdir -p $&#123;OUTPUT_DIR&#125;&#x2F;$&#123;REPO_DIR&#125;&#x2F;$&#123;image_name&#125;&#x2F;_manifests&#x2F;tags&#x2F;$&#123;image_tag&#125;&#x2F;&#123;current,index&#x2F;sha256&#125;</span><br><span class="line">  mkdir -p $&#123;OUTPUT_DIR&#125;&#x2F;$&#123;REPO_DIR&#125;&#x2F;$&#123;image_name&#125;&#x2F;_manifests&#x2F;tags&#x2F;$&#123;image_tag&#125;&#x2F;index&#x2F;sha256&#x2F;$&#123;manifest_sha256&#125;</span><br><span class="line"></span><br><span class="line">  # create image tag manifest link file  </span><br><span class="line">  echo -n &quot;sha256:$&#123;manifest_sha256&#125;&quot; &gt; $&#123;OUTPUT_DIR&#125;&#x2F;$&#123;REPO_DIR&#125;&#x2F;$&#123;image_name&#125;&#x2F;_manifests&#x2F;tags&#x2F;$&#123;image_tag&#125;&#x2F;current&#x2F;link</span><br><span class="line">  echo -n &quot;sha256:$&#123;manifest_sha256&#125;&quot; &gt; $&#123;OUTPUT_DIR&#125;&#x2F;$&#123;REPO_DIR&#125;&#x2F;$&#123;image_name&#125;&#x2F;_manifests&#x2F;revisions&#x2F;sha256&#x2F;$&#123;manifest_sha256&#125;&#x2F;link</span><br><span class="line">  echo -n &quot;sha256:$&#123;manifest_sha256&#125;&quot; &gt; $&#123;OUTPUT_DIR&#125;&#x2F;$&#123;REPO_DIR&#125;&#x2F;$&#123;image_name&#125;&#x2F;_manifests&#x2F;tags&#x2F;$&#123;image_tag&#125;&#x2F;index&#x2F;sha256&#x2F;$&#123;manifest_sha256&#125;&#x2F;link</span><br><span class="line"></span><br><span class="line">  # 强制创建 &#x2F;docker&#x2F;registry&#x2F;v2&#x2F;blobs&#x2F; 各 layer data 文件到指定目录之中</span><br><span class="line">  for layer in $(sed &#39;&#x2F;v1Compatibility&#x2F;d&#39; $&#123;manifest&#125; | grep -Eo &#39;\b[a-f0-9]&#123;64&#125;\b&#39; | sort -u); do</span><br><span class="line">      mkdir -p $&#123;OUTPUT_DIR&#125;&#x2F;$&#123;BLOB_DIR&#125;&#x2F;$&#123;layer:0:2&#125;&#x2F;$&#123;layer&#125;</span><br><span class="line">      mkdir -p $&#123;OUTPUT_DIR&#125;&#x2F;$&#123;REPO_DIR&#125;&#x2F;$&#123;image_name&#125;&#x2F;_layers&#x2F;sha256&#x2F;$&#123;layer&#125;</span><br><span class="line">      ln -f $&#123;BLOB_DIR&#125;&#x2F;$&#123;layer:0:2&#125;&#x2F;$&#123;layer&#125;&#x2F;data $&#123;OUTPUT_DIR&#125;&#x2F;$&#123;BLOB_DIR&#125;&#x2F;$&#123;layer:0:2&#125;&#x2F;$&#123;layer&#125;&#x2F;data</span><br><span class="line">      echo -n &quot;sha256:$&#123;layer&#125;&quot; &gt; $&#123;OUTPUT_DIR&#125;&#x2F;$&#123;REPO_DIR&#125;&#x2F;$&#123;image_name&#125;&#x2F;_layers&#x2F;sha256&#x2F;$&#123;layer&#125;&#x2F;link</span><br><span class="line">  done</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<p>至此完毕！</p>
<blockquote>
<p>本文转载自：「 WeiyiGeek 」，原文：<a href="https://url.hi-linux.com/xCmXo/" target="_blank" rel="noopener">https://url.hi-linux.com/xCmXo/</a> ，版权归原作者所有。欢迎投稿，投稿邮箱: <a href="mailto:editor@hi-linux.com">editor@hi-linux.com</a>。</p>
</blockquote>
</div>

			<script src="https://my.openwrite.cn/js/readmore.js" type="text/javascript"></script>
			<script>
			var isMobile = navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i);
			if (!isMobile) {
			    var btw = new BTWPlugin();
			    btw.init({
			        "id": "vip-container",
			        "blogId": "10135-1588830050631-449",
			        "name": "「奇妙的 Linux 世界」",
			        "qrcode": "https://www.hi-linux.com/img/wechat/mp_qrcode_12.jpg",
			        "keyword": "VIP"
			    });
			}
			</script>
		
                

                <hr>
                <!-- Pager -->
                <ul class="pager">
                    
                        <li class="previous">
                            <a href="/posts/28253.html" data-toggle="tooltip" data-placement="top" title="如何使用 Kubectl 优雅的滚动更新应用">&larr; Previous Post</a>
                        </li>
                    
                    
                        <li class="next">
                            <a href="/posts/907.html" data-toggle="tooltip" data-placement="top" title="轻量级 Kubernetes 集群发行版 K3s 完全进阶指南">Next Post &rarr;</a>
                        </li>
                    
                </ul>

                <!-- duoshuo Share start -->
                
                <!-- 多说 Share end-->

                <!-- 多说评论框 start -->
                
                <!-- 多说评论框 end -->

                <!-- disqus comment start -->
                
                <!-- disqus comment end -->

                
                    <!-- disqus 评论框 start -->
                    <div class="comment">
                        <div id="lv-container" data-id="city" data-uid="MTAyMC8yNzg2My80NDQw"></div>
                    </div>
                    <!-- disqus 评论框 end -->
                

            </div>
            
            <!-- Tabe of Content -->
            <!-- Table of Contents -->

  
    <style>
      span.toc-nav-number{
        display: none
      }
    </style>
  
    
      <aside id="sidebar">
        <div id="toc" class="toc-article">
        <strong class="toc-title">Contents</strong>
        
          <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">1. 基础介绍</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">2.</span> <span class="toc-nav-text">2. 安装编译</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">2.1.</span> <span class="toc-nav-text">2.1 源码编译（静态）</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">2.2.</span> <span class="toc-nav-text">2.2 分发包安装</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">2.3.</span> <span class="toc-nav-text">2.3 容器安装运行</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">3.</span> <span class="toc-nav-text">3. 快速上手</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">3.1.</span> <span class="toc-nav-text">3.1 命令浅析</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">3.2.</span> <span class="toc-nav-text">3.2 Skopeo 初体验</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">3.2.1.</span> <span class="toc-nav-text">3.2.1 Skopeo login&#x2F;loout - 远程仓库 Auth</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">3.2.2.</span> <span class="toc-nav-text">3.2.2 Skopeo inspect - 检查存储库中的镜像</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">3.2.3.</span> <span class="toc-nav-text">3.2.3 Skopeo copy - 仓库镜像拷贝</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">3.2.4.</span> <span class="toc-nav-text">3.2.4 Skopeo sync - 镜像同步命令</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">3.2.5.</span> <span class="toc-nav-text">3.2.5 Skopeo list-tags - 仓库中镜像 Tag 查看</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">3.2.6.</span> <span class="toc-nav-text">3.2.6 Skopeo delete - 删除仓库中镜像 Tag</span></a></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">4.</span> <span class="toc-nav-text">4. 镜像同步最佳实践</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">4.1.</span> <span class="toc-nav-text">4.1 指定文本中镜像同步</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">4.2.</span> <span class="toc-nav-text">4.2 使用 registry 存储特性同步</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">4.3.</span> <span class="toc-nav-text">4.3 从 registry 存储中 select 出镜像进行同步</span></a></li></ol></li></ol>
        
        </div>
      </aside>
    

                
            <!-- Sidebar Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <!-- no hr -->
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                       
                          <a class="tag" href="/tags/#Linux" title="Linux">Linux</a>
                        
                          <a class="tag" href="/tags/#Docker" title="Docker">Docker</a>
                        
                          <a class="tag" href="/tags/#Skopeo" title="Skopeo">Skopeo</a>
                        
                    </div>
                </section>
                

                <!-- Friends Blog -->
                
                <hr>
                <h5>FRIENDS</h5>
                <ul class="list-inline">

                    
                        <li><a href="http://www.mike.org.cn/" target="_blank">简单.生活</a></li>
                    
                        <li><a href="http://shang.qq.com/wpa/qunwpa?idkey=ea4c43493c2269428ac6ef6141de4b6d78e5ab2d41380ca4099b833b62884ee9" target="_blank">技术交流群</a></li>
                    
                        <li><a href="" target="_blank"></a></li>
                    
                        <li><a href="" target="_blank"></a></li>
                    
                </ul>
                
            </div>
        </div>
    </div>
</article>






    <!-- 来必力City版公共JS代码 start (一个网页只需插入一次) -->
    <script type="text/javascript">
       (function(d, s) {
           var j, e = d.getElementsByTagName(s)[0];
    
           if (typeof LivereTower === 'function') { return; }
    
           j = d.createElement(s);
           j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
           j.async = true;
    
           e.parentNode.insertBefore(j, e);
       })(document, 'script');
    </script>
    <noscript>为正常使用来必力评论功能请激活JavaScript</noscript>
    <!-- 来必力City版 公共JS代码 end -->



<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'hover',
          placement: 'left',
          icon: 'ℬ'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                
                    <li>
                        <a href="/atom.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                
                
                
                    <li>
                        <a target="_blank" href="https://www.zhihu.com/people/80imike">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa  fa-stack-1x fa-inverse">知</i>
                            </span>
                        </a>
                    </li>
                

                
                    <li>
                        <a target="_blank" href="http://weibo.com/2093524665">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                

                

                

                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; Mike 2025 | Hosted by <a href="https://pages.coding.me" target="_blank" rel="noopener" style="font-weight: bold">Coding Pages</a>
                    <br>
                    Theme by <a href="http://beantech.org" target="_blank" rel="noopener">BeanTech</a> 
                    <span style="display: inline-block; margin: 0 5px;">
                        <i class="fa fa-heart"></i>
                    </span> 
                    re-Ported by <a href="http://www.huweihuang.com" target="_blank" rel="noopener">胡伟煌</a> | 
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="91px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=huweihuang&repo=hexo-theme-huweihuang&type=star&count=true" >
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->

<script src="/js/jquery.min.js"></script>


<!-- Bootstrap Core JavaScript -->

<script src="/js/bootstrap.min.js"></script>


<!-- Custom Theme JavaScript -->

<script src="/js/hux-blog.min.js"></script>



<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- 
     Because of the native support for backtick-style fenced code blocks 
     right within the Markdown is landed in Github Pages, 
     From V1.6, There is no need for Highlight.js, 
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0  
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/    
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->


<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("https://www.hi-linux.com/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->




<!-- Baidu Tongji -->



<script defer src="https://umami.hi-linux.com/script.js"
    data-website-id="db99ccfc-f114-4595-8f3b-9dd1fbd3bf19"></script>


	<a id="rocket" href="#top" class=""></a>
	<script type="text/javascript" src="/js/totop.js?v=1.0.0" async=""></script>
    <script type="text/javascript" src="/js/toc.js?v=1.0.0" async=""></script>
<!-- Image to hack wechat -->
<img src="https://www.hi-linux.com/img/icon_wechat.png" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

<script>(function(w,d, s, id) {w.webpushr=w.webpushr||function(){(w.webpushr.q=w.webpushr.q||[]).push(arguments)};var js, fjs = d.getElementsByTagName(s)[0];js = d.createElement(s); js.id = id;js.src = 'https://cdn.webpushr.com/app.min.js';fjs.parentNode.appendChild(js);}(window,document, 'script', 'webpushr-jssdk'));webpushr('init','BF9JK7xV9kjWTdMx2lr6RWaPfXV7wNuZaVAJ1bfIGoBNJavqLEBVFMKLubITnCA4bh2fI9iH9tMF95nXnPt7xxY');</script></body>

</html>
