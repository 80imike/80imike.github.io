<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="keyword"  content="Linux,è¿ç»´,Nginx,Zabbix,Centos,Ansible,MySQL,Python,Docker,ELK,Haproxy,Git,Nodejs,å®‰å…¨,æŠ€æœ¯">
    <link rel="shortcut icon" href="/img/ironman-draw.png">
    <!-- Place this tag in your head or just before your close body tag. -->
    <script async defer src="https://buttons.github.io/buttons.js"></script>
    <title>
        
          ä¸‡å­—é•¿æ–‡è¯¦è§£ PaaS toB åœºæ™¯ä¸‹ Kubernetes ç¦»çº¿éƒ¨ç½²æ–¹æ¡ˆ - å¥‡å¦™çš„ Linux ä¸–ç•Œ
        
    </title>

    <link rel="canonical" href="https://www.hi-linux.com/posts/27427.html">

    <!-- Bootstrap Core CSS -->
    
<link rel="stylesheet" href="/css/bootstrap.min.css">


    <!-- Custom CSS --> 
    
<link rel="stylesheet" href="/css/beantech.min.css">

    
    <!-- Pygments Highlight CSS -->
    
<link rel="stylesheet" href="/css/highlight.css">


    
<link rel="stylesheet" href="/css/widget.css">


    
<link rel="stylesheet" href="/css/rocket.css">


    
<link rel="stylesheet" href="/css/signature.css">


    
<link rel="stylesheet" href="/css/toc.css">


    <!-- Custom Fonts -->
    <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- Hux Delete, sad but pending in China
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/
    css'>
    -->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>
<meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="å¥‡å¦™çš„ Linux ä¸–ç•Œ" type="application/atom+xml">
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">
	<!-- Modified by Yu-Hsuan Yen -->
<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        
            background-image: url('/img/header_img/building.jpg')
            /*post*/
        
    }
    
</style>

<header class="intro-header" >
    <!-- Signature -->
    <div id="signature">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                
                    <div class="post-heading">
                        <div class="tags">
                            
                              <a class="tag" href="/tags/#æŠ€å·§" title="æŠ€å·§">æŠ€å·§</a>
                            
                              <a class="tag" href="/tags/#Linux" title="Linux">Linux</a>
                            
                              <a class="tag" href="/tags/#Kubernetes" title="Kubernetes">Kubernetes</a>
                            
                        </div>
                        <h1>ä¸‡å­—é•¿æ–‡è¯¦è§£ PaaS toB åœºæ™¯ä¸‹ Kubernetes ç¦»çº¿éƒ¨ç½²æ–¹æ¡ˆ</h1>
                        <h2 class="subheading"></h2>
                        <span class="meta">
                            Posted by Mike on
                            2021-09-01
                        </span>
                    </div>
                


                </div>
            </div>
        </div>
    </div>
</header>

	
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">å¥‡å¦™çš„ Linux ä¸–ç•Œ</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>

                    

                        
                    

                        
                    

                        
                        <li>
                            <a href="/archive/">Archives</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/about/">About</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/tags/">Tags</a>
                        </li>
                        
                    
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>


    <!-- Main Content -->
    <!-- Modify by Yu-Hsuan Yen -->

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

            <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <div id="vip-container"><p>åœ¨ä¼ä¸šç§æœ‰äº‘ç¯å¢ƒå½“ä¸­ï¼Œå‡ºäºå¯¹æ•°æ®å®‰å…¨çš„è€ƒè™‘ä»¥åŠæ»¡è¶³ <a href="http://www.djbh.net/" target="_blank" rel="noopener">ç½‘ç»œå®‰å…¨ç­‰çº§ä¿æŠ¤</a> çš„è¦æ±‚ï¼Œå¾€å¾€ä¼šå¯¹å†…éƒ¨ç¯å¢ƒä¸­çš„æœåŠ¡å™¨åšå‡ºä¸¥æ ¼çš„è®¿é—®é™åˆ¶ã€‚ä¸€èˆ¬æ¥è®²ç”Ÿäº§ç¯å¢ƒéƒ½ä¼šç¦æ­¢è®¿é—®å¤–éƒ¨ç½‘ç»œï¼Œå¼€å‘äººå‘˜è¦è®¿é—®ç”Ÿäº§ç¯å¢ƒä¹Ÿå¿…é¡»é€šè¿‡å ¡å’æœºæˆ–è€…å…¶ä»–æ–¹å¼è¿›è¡Œå®‰å…¨å®¡è®¡ç™»å½•ã€‚åœ¨è¿™ç§æ— ç½‘ï¼ˆæ— æ³•è®¿é—®å…¬ç½‘ï¼‰çš„ç¯å¢ƒä¸­ï¼Œæƒ³è¦éƒ¨ç½²å¥½ä¸€ä¸ª K8s é›†ç¾¤å¹¶ä¸æ˜¯ä¸€ä»¶è½»æ¾çš„äº‹å„¿ã€‚å¸‚é¢ä¸Š K8s éƒ¨ç½²å·¥å…·ä¹Ÿå¤šä¸èƒœæ•°ï¼Œå¯¹äºç¦»çº¿éƒ¨ç½²çš„æ”¯æŒæƒ…å†µä¹Ÿå„ä¸ç›¸åŒï¼š</p>
<table>
<thead>
<tr>
<th style="text-align:left">Item</th>
<th style="text-align:left">Language</th>
<th style="text-align:left">Star</th>
<th style="text-align:left">Fork</th>
<th style="text-align:left">ç¦»çº¿éƒ¨ç½²æ”¯æŒæƒ…å†µ</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><a href="https://github.com/kubernetes/kops" target="_blank" rel="noopener">kops</a></td>
<td style="text-align:left">Golang</td>
<td style="text-align:left">13.2k</td>
<td style="text-align:left">4.1k</td>
<td style="text-align:left">ä¸æ”¯æŒ</td>
</tr>
<tr>
<td style="text-align:left"><a href="https://github.com/kubernetes-sigs/kubespray" target="_blank" rel="noopener">kubespray</a></td>
<td style="text-align:left">Ansible</td>
<td style="text-align:left">11.1k</td>
<td style="text-align:left">4.7k</td>
<td style="text-align:left">æ”¯æŒï¼Œéœ€è‡ªè¡Œæ„å»ºå®‰è£…åŒ…</td>
</tr>
<tr>
<td style="text-align:left"><a href="https://github.com/easzlab/kubeasz" target="_blank" rel="noopener">kubeasz</a></td>
<td style="text-align:left">Ansible</td>
<td style="text-align:left">7.2k</td>
<td style="text-align:left">2.7k</td>
<td style="text-align:left">æ”¯æŒï¼Œéœ€è‡ªè¡Œæ„å»ºå®‰è£…åŒ…</td>
</tr>
<tr>
<td style="text-align:left"><a href="https://github.com/fanux/sealos" target="_blank" rel="noopener">sealos</a></td>
<td style="text-align:left">Golang</td>
<td style="text-align:left">4.1k</td>
<td style="text-align:left">790</td>
<td style="text-align:left">æ”¯æŒï¼Œéœ€ä»˜è´¹å……å€¼ä¼šå‘˜</td>
</tr>
<tr>
<td style="text-align:left"><a href="https://github.com/rancher/rke" target="_blank" rel="noopener">RKE</a></td>
<td style="text-align:left">Golang</td>
<td style="text-align:left">2.5k</td>
<td style="text-align:left">480</td>
<td style="text-align:left">ä¸æ”¯æŒï¼Œéœ€è‡ªè¡Œå®‰è£… docker</td>
</tr>
<tr>
<td style="text-align:left"><a href="https://github.com/alibaba/sealer" target="_blank" rel="noopener">sealer</a></td>
<td style="text-align:left">Golang</td>
<td style="text-align:left">503</td>
<td style="text-align:left">112</td>
<td style="text-align:left">æ”¯æŒï¼Œæºè‡ª <a href="https://github.com/fanux/sealos" target="_blank" rel="noopener">sealos</a></td>
</tr>
<tr>
<td style="text-align:left"><a href="https://github.com/kubesphere/kubekey" target="_blank" rel="noopener">kubekey</a></td>
<td style="text-align:left">Golang</td>
<td style="text-align:left">471</td>
<td style="text-align:left">155</td>
<td style="text-align:left">éƒ¨åˆ†æ”¯æŒï¼Œä»…é•œåƒå¯ç¦»çº¿</td>
</tr>
</tbody>
</table>
<p>æ— ç½‘ç¯å¢ƒç¦»çº¿éƒ¨ç½² K8s å¾€å¾€æ˜¯ä½œä¸ºä¸€ä¸ªå•†ä¸šæœåŠ¡æˆ–è€…å•†ä¸šä»˜è´¹äº§å“æ¥å‡ºå”®ï¼ˆå¦‚ <a href="https://www.sealyun.com/" target="_blank" rel="noopener">sealos</a> ï¼‰ï¼Œå¾ˆå°‘æœ‰å¼€æºå…è´¹çš„è§£å†³æ–¹æ¡ˆï¼›æˆ–è€…è™½ç„¶æä¾›äº†ç¦»çº¿éƒ¨ç½²æ–¹æ¡ˆï¼Œä½†æƒ³è¦æ“ä½œèµ·æ¥ååˆ†ç¹çï¼Œå¾ˆéš¾é¡ºç•…åœ°åšåˆ°ä¸€é”®éƒ¨ç½²ï¼›åˆæˆ–è€…åªæ”¯æŒéƒ¨åˆ†ç¦»çº¿éƒ¨ç½²ï¼Œè¿˜æœ‰ä¸€éƒ¨åˆ†èµ„æºéœ€è¦åœ¨éƒ¨ç½²çš„æ—¶å€™é€šè¿‡å…¬ç½‘è·å–ã€‚</p>
<p>é’ˆå¯¹ä¸Šè¿°é—®é¢˜ï¼Œæœ¬æ–‡è°ƒç ”ä¸»æµçš„ K8s éƒ¨ç½²å·¥å…·ï¼Œå¹¶åŸºäºè¿™äº›å·¥å…·è®¾è®¡å¹¶å®ç°ä¸€ç§ä»æ„å»ºç¦»çº¿å®‰è£…åŒ…åˆ°ä¸€é”®éƒ¨ç½² K8s é›†ç¾¤å…¨æµç¨‹çš„è§£å†³æ–¹æ¡ˆï¼Œä»¥æ»¡è¶³åœ¨æ— ç½‘çš„ç¯å¢ƒä¸­ä¸€é”®éƒ¨ç½² K8s é›†ç¾¤çš„éœ€æ±‚ï¼Œæ¯”è¾ƒé€‚åˆåŸºäº K8s çš„ PaaS toB äº§å“ä½¿ç”¨ã€‚</p>
<a id="more"></a>
<h2><span id="ç¦»çº¿èµ„æº">ç¦»çº¿èµ„æº</span></h2>
<p>æ€»ä½“æ¥è®²éƒ¨ç½²ä¸€ä¸ª K8s é›†ç¾¤å¤§è‡´éœ€è¦ä¾èµ–å¦‚ä¸‹ä¸‰ç§èµ„æºï¼š</p>
<ul>
<li>ç³»ç»Ÿ OS çš„ rpm/deb åŒ…ï¼šå¦‚ docker-ceã€containerdã€ipvsadmã€conntrack ç­‰ï¼›</li>
<li>äºŒè¿›åˆ¶æ–‡ä»¶ï¼šå¦‚ kubeletã€kubectlã€kubeadmã€crictl ç­‰ï¼›</li>
<li>ç»„ä»¶å®¹å™¨é•œåƒï¼šå¦‚ kube-apiserverã€kube-proxyã€corednsã€calicoã€flannel ç­‰ï¼›</li>
</ul>
<h3><span id="os-packages">OS packages</span></h3>
<p>è¿™ç±»å±äº OS ç³»ç»Ÿå±‚é¢çš„ä¾èµ–ï¼Œæ ¹æ®ä¸åŒç³»ç»Ÿæˆ–è€…æ”¯æŒçš„åŠŸèƒ½éœ€è¦ä½¿ç”¨ç›¸åº”çš„åŒ…ç®¡ç†å™¨å®‰è£…ç›¸åº”çš„ä¾èµ–åŒ…ï¼Œå¤§è‡´åˆ†ä¸ºå¦‚ä¸‹å‡ ç§ï¼š</p>
<ul>
<li>kubernetes ç»„ä»¶ä¾èµ–</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- conntrack           # kube-proxy ä¾èµ–</span><br><span class="line">- ipset               # kube-proxy ä½¿ç”¨ ipvs æ¨¡å¼éœ€è¦</span><br><span class="line">- ipvsadm             # kube-proxy ä½¿ç”¨ ipvs æ¨¡å¼éœ€è¦</span><br><span class="line">- socat               # ç”¨äº port forwarding</span><br></pre></td></tr></table></figure>
<blockquote>
<p><a href="https://kubernetes.io/docs/reference/setup-tools/kubeadm/implementation-details/" target="_blank" rel="noopener">Implementation details</a>:</p>
<p>[Error] if conntrack, ip, iptables, mount, nsenter commands are not present in the command path<br>
[warning] if ebtables, ethtool, socat, tc, touch, crictl commands are not present in the command path</p>
</blockquote>
<ul>
<li>éƒ¨ç½²ä¾èµ–</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- ebtables            # kubeadm ä¾èµ–å·¥å…·</span><br><span class="line">- ethtool             # kubeadm ä¾èµ–å·¥å…·</span><br><span class="line">- chrony              # æ—¶é’ŸåŒæ­¥å·¥å…·ï¼Œéƒ¨ç½²å‰èŠ‚ç‚¹çš„æ—¶å€™å¿…é¡»ä¸€è‡´ï¼Œä¸ç„¶è¯ä¹¦æˆ–è€… CNI æ’ä»¶ä¼šå‡ºç°é—®é¢˜</span><br></pre></td></tr></table></figure>
<ul>
<li>CRI å®¹å™¨è¿è¡Œè¿è¡Œæ—¶</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- containerd.io       # å¯å•ç‹¬å®‰è£…&#x2F;docker-ce ä¾èµ–</span><br><span class="line">- docker-ce           # docker-ce</span><br><span class="line">- libseccomp          # å®‰è£… containerd éœ€è¦</span><br><span class="line">- nvidia-container-runtime # æ”¯æŒ GPU æ—¶éœ€è¦ä¾èµ–</span><br></pre></td></tr></table></figure>
<ul>
<li>å­˜å‚¨å®¢æˆ·ç«¯ä¾èµ–</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- nfs-utils&#x2F;nfs-common # åˆ›å»ºåŸºäº nfs çš„ PV éœ€è¦</span><br><span class="line">- ceph-common          # ceph å®¢æˆ·ç«¯å®‰è£…åŒ…ï¼Œåˆ›å»ºåŸºäº ceph çš„ pv éœ€è¦</span><br><span class="line">- lvm2                 # åˆ›å»ºåŸºäº ceph çš„ pv éœ€è¦</span><br><span class="line">- glusterfs-client     # åˆ›å»ºåŸºäº glusterfs çš„ pv éœ€è¦</span><br><span class="line">- glusterfs-common     # åˆ›å»ºåŸºäº glusterfs çš„ pv éœ€è¦</span><br><span class="line">- cifs-utils           # åˆ›å»ºåŸºäº cifs çš„ pv éœ€è¦</span><br><span class="line">- fuse                 # ceph æˆ–è€…å…¶ä»–å­˜å‚¨å®¢æˆ·ç«¯ä¾èµ–</span><br></pre></td></tr></table></figure>
<p>æƒ³è¦è§£å†³ä¸Šé¢è¿™äº›ä¾èµ–é¡¹ååˆ†æ£˜æ‰‹ï¼Œä¹Ÿæ˜¯ç¦»çº¿éƒ¨ç½²åœºæ™¯ä¸‹æœ€éš¾çš„ä¸€éƒ¨åˆ†ï¼Œè‡³ä»Šå¹¶æ²¡æœ‰ä¸€ä¸ªæˆç†Ÿçš„æ–¹æ¡ˆå®ç°è¿™äº›ä¾èµ–çš„ç¦»çº¿éƒ¨ç½²ï¼ŒåŸºæœ¬ä¸Šæ‰€æœ‰çš„ k8s éƒ¨ç½²å·¥å…·éƒ½æ²¡æœ‰æä¾›è¿™äº›åŒ…çš„ç¦»çº¿å®‰è£…æ–¹å¼ã€‚å¯¹äºè¿™äº›åŒ…çš„ä¾èµ–ï¼Œç›®å‰ä¸»è¦æœ‰é¿å…å®‰è£…è¿™äº›ä¾èµ–å’Œåˆ¶ä½œç¦»çº¿æºè¿™ä¸¤ç§è§£å†³æ–¹æ¡ˆã€‚</p>
<h4><span id="sealos">sealos</span></h4>
<p>åœ¨ <a href="https://github.com/fanux/sealos" target="_blank" rel="noopener">sealos</a> ä¸­å°±æåŠ›é¿å…ä½¿ç”¨åŒ…ç®¡ç†å™¨æ¥å®‰è£…ä¾èµ–ï¼Œæ¯”å¦‚å®‰è£… containerd æ—¶çš„ä¾èµ– libseccomp ä½¿ç”¨çš„æ˜¯ç¼–è¯‘å¥½çš„ .so æ–‡ä»¶çš„æ–¹å¼ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ tar -tf kube1.20.0.tar.gz</span><br><span class="line">kube&#x2F;</span><br><span class="line">kube&#x2F;lib64&#x2F;</span><br><span class="line">kube&#x2F;lib64&#x2F;README.md</span><br><span class="line">kube&#x2F;lib64&#x2F;libseccomp.so.2</span><br><span class="line">kube&#x2F;lib64&#x2F;libseccomp.so.2.3.1</span><br></pre></td></tr></table></figure>
<p>å®‰è£… docker ä½¿ç”¨çš„äºŒè¿›åˆ¶çš„æ–¹å¼ï¼Œä½† docker å®˜æ–¹æ–‡æ¡£ä¸­ä¹Ÿæ˜ç¡®è¯´æ˜<strong>ä¸å»ºè®®ä½¿ç”¨äºŒè¿›åˆ¶çš„æ–¹å¼æ¥å®‰è£… docker</strong>ï¼Œåº”è¯¥ä½¿ç”¨å‘è¡Œç‰ˆè‡ªå¸¦çš„åŒ…ç®¡ç†å™¨æ¥å®‰è£…ã€‚</p>
<blockquote>
<p>If you want to try Docker or use it in a testing environment, but youâ€™re not on a supported platform, you can try installing from static binaries. <strong>If possible, you should use packages built for your operating system</strong>, and use your operating systemâ€™s package management system to manage Docker installation and upgrades.</p>
<p><a href="https://docs.docker.com/engine/install/binaries/" target="_blank" rel="noopener">Install Docker Engine from binaries</a></p>
</blockquote>
<p>å®é™…ä¸Šä»»ä½•éƒ¨ç½²å·¥å…·éƒ½ä¼šå¯¹ç³»ç»Ÿ rpm/deb åŒ…éƒ½ä¼šæœ‰ä¸åŒç¨‹åº¦ä¸Šçš„ä¾èµ–ï¼Œæœ‰ä¸€éƒ¨åˆ†ä¾èµ–å¯ä»¥åƒ <a href="https://github.com/fanux/sealos" target="_blank" rel="noopener">sealos</a> è¿™æ ·é€šè¿‡æŸç§æ–¹å¼å»è§„é¿æ‰ã€‚ä½†å¹¶ä¸æ˜¯æ‰€æœ‰çš„ä¾èµ–éƒ½èƒ½è§„é¿çš„ï¼Œæ¯”å¦‚æä¾›æŒ‚è½½ PV éœ€è¦ä¾èµ–çš„å­˜å‚¨å®¢æˆ·ç«¯ï¼ˆnfs-common/nfs-utilsï¼Œlvm2ï¼Œgluster-clientï¼‰è¿™äº›åŒ…ï¼ŒåŸºæœ¬ä¸Šæ˜¯æ²¡æœ‰ä»»ä½•è§„é¿çš„é€”å¾„ï¼Œå¿…é¡»é€šè¿‡åŒ…ç®¡ç†å™¨æ¥å®‰è£…æ‰è¡Œã€‚</p>
<p>å½“ç„¶å¦‚æœè¿™äº›å‰ç½®çš„ä¾èµ–é¡¹åœ¨éƒ¨ç½²å·¥å…·ä¹‹å¤–æ‰‹åŠ¨è§£å†³æˆ–è€…è®©ç”¨æˆ·è‡ªè¡Œå»è§£å†³ï¼Œé‚£ä¹ˆä½¿ç”¨ <a href="https://github.com/fanux/sealos" target="_blank" rel="noopener">sealos</a> è¿™ç§è½»é‡çº§çš„å·¥å…·æ¥éƒ¨ç½² K8s æ˜¯æ¯”è¾ƒåˆé€‚çš„ã€‚ä½†å¯¹äºä¸€äº› PaaS toB çš„äº§å“è€Œè¨€ï¼Œè®©ç”¨æˆ·è‡ªå·±å»æ‰‹åŠ¨è§£å†³è¿™äº›ä¾èµ–ææ€•ä¸å¤ªå¥½ã€‚ç«™åœ¨å®¢æˆ·çš„è§’åº¦æ¥è€ƒè™‘æ—¢ç„¶å¹³å°æä¾›äº†è¿™éƒ¨åˆ†åŠŸèƒ½ï¼Œå°±åº”è¯¥åœ¨éƒ¨ç½²çš„æ—¶å€™è§£å†³æ‰€æœ‰çš„ä¾èµ–é—®é¢˜ï¼Œè€Œä¸æ˜¯è®©æˆ‘è‡ªå·±æ‰‹åŠ¨ä¸´æ—¶æ¥è§£å†³ã€‚</p>
<h4><span id="kubekey">kubekey</span></h4>
<p>åœ¨ kubekey ä¸­ä¸€äº›ä¾èµ–é¡¹ç›®åˆ™æ˜¯è¦æ±‚ç”¨æˆ·è‡ªè¡Œå®‰è£…ï¼Œå¹¶æ²¡æœ‰æä¾›ç¦»çº¿å®‰è£…çš„æ–¹å¼ï¼š</p>
<blockquote>
<ul>
<li>å»ºè®®æ‚¨ä½¿ç”¨å¹²å‡€çš„æ“ä½œç³»ç»Ÿï¼ˆä¸å®‰è£…ä»»ä½•å…¶ä»–è½¯ä»¶ï¼‰ï¼Œå¦åˆ™å¯èƒ½ä¼šæœ‰å†²çªã€‚</li>
<li>è¯·ç¡®ä¿æ¯ä¸ªèŠ‚ç‚¹çš„ç¡¬ç›˜è‡³å°‘æœ‰ <strong>100G</strong>ã€‚</li>
<li>æ‰€æœ‰èŠ‚ç‚¹å¿…é¡»éƒ½èƒ½é€šè¿‡ <code>SSH</code> è®¿é—®ã€‚</li>
<li>æ‰€æœ‰èŠ‚ç‚¹æ—¶é—´åŒæ­¥ã€‚</li>
<li>æ‰€æœ‰èŠ‚ç‚¹éƒ½åº”ä½¿ç”¨ <code>sudo</code>/<code>curl</code>/<code>openssl</code>ã€‚</li>
</ul>
<p>KubeKey èƒ½å¤ŸåŒæ—¶å®‰è£… Kubernetes å’Œ KubeSphereã€‚æ ¹æ®è¦å®‰è£…çš„ Kubernetes ç‰ˆæœ¬ï¼Œéœ€è¦å®‰è£…çš„ä¾èµ–é¡¹å¯èƒ½ä¼šä¸åŒã€‚æ‚¨å¯ä»¥å‚è€ƒä¸‹æ–¹åˆ—è¡¨ï¼ŒæŸ¥çœ‹æ˜¯å¦éœ€è¦æå‰åœ¨æ‚¨çš„èŠ‚ç‚¹ä¸Šå®‰è£…ç›¸å…³ä¾èµ–é¡¹ã€‚</p>
<table>
<thead>
<tr>
<th style="text-align:left">ä¾èµ–é¡¹</th>
<th style="text-align:left">Kubernetes ç‰ˆæœ¬ â‰¥ 1.18</th>
<th style="text-align:left">Kubernetes ç‰ˆæœ¬ &lt; 1.18</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>socat</code></td>
<td style="text-align:left">å¿…é¡»</td>
<td style="text-align:left">å¯é€‰ä½†å»ºè®®</td>
</tr>
<tr>
<td style="text-align:left"><code>conntrack</code></td>
<td style="text-align:left">å¿…é¡»</td>
<td style="text-align:left">å¯é€‰ä½†å»ºè®®</td>
</tr>
<tr>
<td style="text-align:left"><code>ebtables</code></td>
<td style="text-align:left">å¯é€‰ä½†å»ºè®®</td>
<td style="text-align:left">å¯é€‰ä½†å»ºè®®</td>
</tr>
<tr>
<td style="text-align:left"><code>ipset</code></td>
<td style="text-align:left">å¯é€‰ä½†å»ºè®®</td>
<td style="text-align:left">å¯é€‰ä½†å»ºè®®</td>
</tr>
</tbody>
</table>
<p>å¤‡æ³¨</p>
<ul>
<li>åœ¨ç¦»çº¿ç¯å¢ƒä¸­ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ç§æœ‰åŒ…ã€RPM åŒ…ï¼ˆé€‚ç”¨äº CentOSï¼‰æˆ–è€… Deb åŒ…ï¼ˆé€‚ç”¨äº Debianï¼‰æ¥å®‰è£…è¿™äº›ä¾èµ–é¡¹ã€‚</li>
<li>å»ºè®®æ‚¨äº‹å…ˆåˆ›å»ºä¸€ä¸ªæ“ä½œç³»ç»Ÿé•œåƒæ–‡ä»¶ï¼Œå¹¶ä¸”å®‰è£…å¥½æ‰€æœ‰ç›¸å…³ä¾èµ–é¡¹ã€‚è¿™æ ·ï¼Œæ‚¨ä¾¿å¯ä»¥ç›´æ¥ä½¿ç”¨è¯¥é•œåƒæ–‡ä»¶åœ¨æ¯å°æœºå™¨ä¸Šå®‰è£…æ“ä½œç³»ç»Ÿï¼Œæé«˜éƒ¨ç½²æ•ˆç‡ï¼Œä¹Ÿä¸ç”¨æ‹…å¿ƒä»»ä½•ä¾èµ–é¡¹é—®é¢˜ã€‚</li>
</ul>
<p>æ‚¨çš„é›†ç¾¤å¿…é¡»æœ‰ä¸€ä¸ªå¯ç”¨çš„å®¹å™¨è¿è¡Œæ—¶ã€‚åœ¨ç¦»çº¿ç¯å¢ƒä¸­åˆ›å»ºé›†ç¾¤ä¹‹å‰ï¼Œæ‚¨å¿…é¡»æ‰‹åŠ¨å®‰è£… Docker æˆ–å…¶ä»–å®¹å™¨è¿è¡Œæ—¶ã€‚</p>
<p><a href="https://github.com/kubesphere/kubekey#requirements-and-recommendations" target="_blank" rel="noopener">Requirements and Recommendations</a></p>
</blockquote>
<h4><span id="æ„å»ºç¦»çº¿æº">æ„å»ºç¦»çº¿æº</span></h4>
<p>å¯¹äºç³»ç»Ÿ rpm/deb åŒ…çš„ä¾èµ–ï¼Œæˆ‘ä»¬è¿˜æ˜¯è¸è¸å®å®åœ°ä½¿ç”¨åŒ…ç®¡ç†å™¨æ¥å®‰è£…è¿™äº›åŒ…è¾ƒä¸ºå¦¥å½“ï¼Œå› æ­¤æˆ‘ä»¬æœ‰å¿…è¦ä¸ºè¿™äº›ä¾èµ–çš„ rpm/deb åŒ…æ„å»ºæˆç¦»çº¿æºï¼Œéƒ¨ç½²çš„æ—¶å€™ä½¿ç”¨è¿™ä¸ªç¦»çº¿æºæ¥å®‰è£…è¿™äº›ä¾èµ–ã€‚åœ¨ ã€Š<a href="https://blog.k8s.li/make-offline-mirrors.html" target="_blank" rel="noopener">ä½¿ç”¨ docker build åˆ¶ä½œ yum/apt ç¦»çº¿æº</a>ã€‹ä¸€æ–‡ä¸­æ›¾åˆ†æè¿‡åˆ¶ä½œå’Œä½¿ç”¨ç¦»çº¿æºè¿™ä¹ˆéš¾çš„åŸå› ï¼š</p>
<blockquote>
<p>ä½œä¸ºå¹³å°éƒ¨ç½²å·¥å…·çš„å¼€å‘è€…ï¼Œå§‹ç»ˆè¢«ç¦»çº¿éƒ¨ç½²è¿™ä¸ªéš¾é¢˜å›°æ‰°ç€ã€‚åœ¨çº¿çš„å®¹å™¨é•œåƒå’ŒäºŒè¿›åˆ¶æ–‡ä»¶æ¯”è¾ƒå¥½è§£å†³ï¼Œå› ä¸ºè¿™äº›èµ„æºæ˜¯ä¸ OS æ— å…³çš„ï¼Œåªè¦ä¸‹è½½ä¸‹æ¥æ”¾åˆ°å®‰è£…åŒ…é‡Œï¼Œéƒ¨ç½²çš„æ—¶å€™å¯åŠ¨ä¸€ä¸ª HTTP æœåŠ¡å™¨å’Œé•œåƒä»“åº“æœåŠ¡æä¾›è¿™äº›èµ„æºçš„ä¸‹è½½å³å¯ã€‚</p>
<p>ä½†æ˜¯å¯¹äº yum/apt ä¹‹ç±»çš„è½¯ä»¶æ¥è®²å¹¶ä¸é‚£ä¹ˆç®€å•ï¼š</p>
<ul>
<li>é¦–å…ˆç”±äºå„ä¸ªåŒ…ä¹‹é—´çš„ä¾èµ–å…³ç³»æ¯”è¾ƒå¤æ‚ï¼Œå¹¶ä¸èƒ½å°†å®ƒä»¬ç›´æ¥ä¸‹è½½ä¸‹æ¥ï¼›</li>
<li>å…¶æ¬¡å³ä¾¿ä¸‹è½½ä¸‹æ¥ä¹‹åä¹Ÿæ— æ³•ç›´æ¥é€šè¿‡ yum/apt çš„æ–¹å¼å®‰è£…æŒ‡å®šçš„è½¯ä»¶åŒ…ï¼Œè™½ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨ scp çš„æ–¹å¼å°†è¿™äº›åŒ…å¤åˆ¶åˆ°éƒ¨ç½²èŠ‚ç‚¹ï¼Œé€šè¿‡ rpm æˆ– dpkg çš„æ–¹å¼æ¥å®‰è£…ä¸Šï¼Œä½†è¿™æ ·å¹¶ä¸æ˜¯å¾ˆä¼˜é›…ï¼Œè€Œä¸”é€šç”¨æ€§èƒ½ä¹Ÿä¸æ˜¯å¾ˆå¥½ï¼›</li>
<li>æœ€åéœ€è¦é€‚é…çš„ Linux å‘è¡Œç‰ˆå’ŒåŒ…ç®¡ç†å™¨ç§ç±»ä¹Ÿæœ‰å¤šç§ï¼Œè€Œä¸”æœ‰äº›åŒ…çš„åŒ…åæˆ–è€…ç‰ˆæœ¬å·åœ¨ä¸åŒçš„åŒ…ç®¡ç†ä¹‹é—´ä¹Ÿç›¸å·®ç”šå¤§ï¼Œæ— æ³•åšåˆ°ç»Ÿä¸€ç®¡ç†ã€‚</li>
<li>ç¦»çº¿æºåŒæ—¶é€‚é…é€‚é… ARM64 å’Œ AMD64 æœ‰ä¸€å®šçš„éš¾åº¦</li>
</ul>
</blockquote>
<p>å¥½åœ¨æ–‡ä¸­ä¹Ÿç»™å‡ºäº†ä¸€ä¸ªæ¯”è¾ƒé€šç”¨çš„è§£å†³æ–¹æ¡ˆï¼Œå³é€šè¿‡ Dockerfile æ¥æ„å»ºç¦»çº¿æºï¼Œå…·ä½“çš„å®ç°ç»†èŠ‚å¯ä»¥ç¿»çœ‹ã€Š<a href="https://blog.k8s.li/make-offline-mirrors.html" target="_blank" rel="noopener">ä½¿ç”¨ docker build åˆ¶ä½œ yum/apt ç¦»çº¿æº</a>ã€‹ä¸€æ–‡ã€‚ä½¿ç”¨è¿™ä¸ªæ–¹æ¡ˆå¯ä»¥è§£å†³ PaaS æˆ–è€… IaaS å±‚é¢çš„ç¦»çº¿æºåˆ¶ä½œçš„éš¾é¢˜ï¼ŒåŒæ ·ä¹Ÿé€‚ç”¨äºæˆ‘ä»¬éƒ¨ç½² K8s é›†ç¾¤çš„åœºæ™¯ï¼Œè€Œä¸”é‡‡ç”¨ Dockerfile çš„æ–¹å¼æ¥æ„å»ºç¦»çº¿æºå¯ä»¥å®Œç¾åœ°è§£å†³åŒæ—¶é€‚é… arm64 å’Œ amd64 çš„éš¾é¢˜ã€‚</p>
<h3><span id="files">files</span></h3>
<p>ä¸€äº›éƒ¨ç½²è¿‡ç¨‹ä¸­éœ€è¦çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">- kubelet</span><br><span class="line">- kubeadm</span><br><span class="line">- kubectl</span><br><span class="line">- etcd            # systemd æ–¹å¼éƒ¨ç½² etcd æ—¶éœ€è¦çš„å®‰è£…åŒ…</span><br><span class="line">- crictl          # k8s å®˜æ–¹çš„ CRI CLI å·¥å…·</span><br><span class="line">- calicoctl       # calico çš„ CLI å·¥å…·</span><br><span class="line">- helm            # å®‰è£… helm éœ€è¦çš„äºŒè¿›åˆ¶å®‰è£…åŒ…</span><br><span class="line">- nerdctl         # containerd çš„ CLI å·¥å…·</span><br><span class="line">- cni-plugins     # CNI æ’ä»¶</span><br><span class="line">- cuda            # GPU ä¾èµ–</span><br><span class="line">- nvidia_driver   # GPU é©±åŠ¨</span><br></pre></td></tr></table></figure>
<h4><span id="sealos">sealos</span></h4>
<p>sealos å¯¹äºŒè¿›åˆ¶æ–‡ä»¶çš„å¤„ç†æ¯”è¾ƒå¥½ï¼Œå…¨éƒ¨æ‰“åŒ…åœ¨ç¦»çº¿å®‰è£…åŒ…é‡Œï¼Œéƒ¨ç½²çš„æ—¶å€™ä¼šåˆ†å‘åˆ°é›†ç¾¤èŠ‚ç‚¹ä¸Šï¼Œæ•´ä¸ªéƒ¨ç½²è¿‡ç¨‹éƒ½æ— éœ€è®¿é—®å…¬ç½‘ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ tar -tf kube1.20.0.tar.gz</span><br><span class="line">kube&#x2F;bin&#x2F;kubelet</span><br><span class="line">kube&#x2F;bin&#x2F;kubectl</span><br><span class="line">kube&#x2F;bin&#x2F;conntrack</span><br><span class="line">kube&#x2F;bin&#x2F;kubeadm</span><br></pre></td></tr></table></figure>
<h4><span id="kubekey">kubekey</span></h4>
<p>åœ¨ kubekey çš„æºç å½“ä¸­ï¼Œæ˜¯å°†æ‰€æœ‰äºŒè¿›åˆ¶æ–‡ä»¶çš„ URL ç¡¬ç¼–ç åœ¨ä»£ç å½“ä¸­çš„ã€‚å¦‚æœåœ¨éƒ¨ç½²çš„æ—¶å€™éœ€è¦æ ¹æ®éƒ¨ç½²ç¯å¢ƒæ¥ä¿®æ”¹äºŒè¿›åˆ¶æ–‡ä»¶çš„ä¸‹è½½åœ°å€ï¼Œæ¯”å¦‚ä»å†…ç½‘ nginx æœåŠ¡å™¨ä¸Šä¸‹è½½ï¼Œå°±éœ€è¦ä¿®æ”¹è¿™éƒ¨åˆ†æºç æŠŠ <code>https://kubernetes-release.pek3b.qingstor.com</code> ä¿®æ”¹æˆå†…ç½‘åœ°å€ï¼Œæ¯”å¦‚ <code>http://172.20.0.25:8080/files</code> ï¼Œç„¶è€Œåœ¨éƒ¨ç½²çš„æ—¶å€™é‡æ–°ç¼–è¯‘ kubekey çš„ä»£ç åˆå¿…é¡»èƒ½è®¿é—®å…¬ç½‘æ‰è¡Œï¼Œè¿™å°±å¾ˆåƒµç¡¬ã€‚æ‰€ä»¥ä»¥ç›®å‰å¼€æºçš„ kubekey æ¥çœ‹ï¼Œæ˜¯æ²¡æœ‰åŠæ³•åšåˆ°æ— ç½‘ç¯å¢ƒä¸­æ„‰å¿«åœ°éƒ¨ç½² k8s çš„ï¼Œå¯èƒ½å•†ä¸šç‰ˆä¼šæ”¯æŒï¼ˆçŒœæµ‹ï¼‰ã€‚</p>
<ul>
<li><a href="https://github.com/kubesphere/kubekey/blob/master/pkg/kubernetes/preinstall/preinstall.go" target="_blank" rel="noopener">kubekey/blob/master/pkg/kubernetes/preinstall/preinstall.go</a></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; FilesDownloadHTTP defines the kubernetes&#39; binaries that need to be downloaded in advance and downloads them.</span><br><span class="line">func FilesDownloadHTTP(mgr *manager.Manager, filepath, version, arch string) error &#123;</span><br><span class="line">	kkzone :&#x3D; os.Getenv(&quot;KKZONE&quot;)</span><br><span class="line">	etcd :&#x3D; files.KubeBinary&#123;Name: &quot;etcd&quot;, Arch: arch, Version: kubekeyapiv1alpha1.DefaultEtcdVersion&#125;</span><br><span class="line">	kubeadm :&#x3D; files.KubeBinary&#123;Name: &quot;kubeadm&quot;, Arch: arch, Version: version&#125;</span><br><span class="line">	kubelet :&#x3D; files.KubeBinary&#123;Name: &quot;kubelet&quot;, Arch: arch, Version: version&#125;</span><br><span class="line">	kubectl :&#x3D; files.KubeBinary&#123;Name: &quot;kubectl&quot;, Arch: arch, Version: version&#125;</span><br><span class="line">	kubecni :&#x3D; files.KubeBinary&#123;Name: &quot;kubecni&quot;, Arch: arch, Version: kubekeyapiv1alpha1.DefaultCniVersion&#125;</span><br><span class="line">	helm :&#x3D; files.KubeBinary&#123;Name: &quot;helm&quot;, Arch: arch, Version: kubekeyapiv1alpha1.DefaultHelmVersion&#125;</span><br><span class="line"></span><br><span class="line">	etcd.Path &#x3D; fmt.Sprintf(&quot;%s&#x2F;etcd-%s-linux-%s.tar.gz&quot;, filepath, kubekeyapiv1alpha1.DefaultEtcdVersion, arch)</span><br><span class="line">	kubeadm.Path &#x3D; fmt.Sprintf(&quot;%s&#x2F;kubeadm&quot;, filepath)</span><br><span class="line">	kubelet.Path &#x3D; fmt.Sprintf(&quot;%s&#x2F;kubelet&quot;, filepath)</span><br><span class="line">	kubectl.Path &#x3D; fmt.Sprintf(&quot;%s&#x2F;kubectl&quot;, filepath)</span><br><span class="line">	kubecni.Path &#x3D; fmt.Sprintf(&quot;%s&#x2F;cni-plugins-linux-%s-%s.tgz&quot;, filepath, arch, kubekeyapiv1alpha1.DefaultCniVersion)</span><br><span class="line">	helm.Path &#x3D; fmt.Sprintf(&quot;%s&#x2F;helm&quot;, filepath)</span><br><span class="line"></span><br><span class="line">	if kkzone &#x3D;&#x3D; &quot;cn&quot; &#123;</span><br><span class="line">		etcd.Url &#x3D; fmt.Sprintf(&quot;https:&#x2F;&#x2F;kubernetes-release.pek3b.qingstor.com&#x2F;etcd&#x2F;release&#x2F;download&#x2F;%s&#x2F;etcd-%s-linux-%s.tar.gz&quot;, etcd.Version, etcd.Version, etcd.Arch)</span><br><span class="line">		kubeadm.Url &#x3D; fmt.Sprintf(&quot;https:&#x2F;&#x2F;kubernetes-release.pek3b.qingstor.com&#x2F;release&#x2F;%s&#x2F;bin&#x2F;linux&#x2F;%s&#x2F;kubeadm&quot;, kubeadm.Version, kubeadm.Arch)</span><br><span class="line">		kubelet.Url &#x3D; fmt.Sprintf(&quot;https:&#x2F;&#x2F;kubernetes-release.pek3b.qingstor.com&#x2F;release&#x2F;%s&#x2F;bin&#x2F;linux&#x2F;%s&#x2F;kubelet&quot;, kubelet.Version, kubelet.Arch)</span><br><span class="line">		kubectl.Url &#x3D; fmt.Sprintf(&quot;https:&#x2F;&#x2F;kubernetes-release.pek3b.qingstor.com&#x2F;release&#x2F;%s&#x2F;bin&#x2F;linux&#x2F;%s&#x2F;kubectl&quot;, kubectl.Version, kubectl.Arch)</span><br><span class="line">		kubecni.Url &#x3D; fmt.Sprintf(&quot;https:&#x2F;&#x2F;containernetworking.pek3b.qingstor.com&#x2F;plugins&#x2F;releases&#x2F;download&#x2F;%s&#x2F;cni-plugins-linux-%s-%s.tgz&quot;, kubecni.Version, kubecni.Arch, kubecni.Version)</span><br><span class="line">		helm.Url &#x3D; fmt.Sprintf(&quot;https:&#x2F;&#x2F;kubernetes-helm.pek3b.qingstor.com&#x2F;linux-%s&#x2F;%s&#x2F;helm&quot;, helm.Arch, helm.Version)</span><br><span class="line">		helm.GetCmd &#x3D; mgr.DownloadCommand(helm.Path, helm.Url)</span><br><span class="line">	&#125; else &#123;</span><br><span class="line">		etcd.Url &#x3D; fmt.Sprintf(&quot;https:&#x2F;&#x2F;github.com&#x2F;coreos&#x2F;etcd&#x2F;releases&#x2F;download&#x2F;%s&#x2F;etcd-%s-linux-%s.tar.gz&quot;, etcd.Version, etcd.Version, etcd.Arch)</span><br><span class="line">		kubeadm.Url &#x3D; fmt.Sprintf(&quot;https:&#x2F;&#x2F;storage.googleapis.com&#x2F;kubernetes-release&#x2F;release&#x2F;%s&#x2F;bin&#x2F;linux&#x2F;%s&#x2F;kubeadm&quot;, kubeadm.Version, kubeadm.Arch)</span><br><span class="line">		kubelet.Url &#x3D; fmt.Sprintf(&quot;https:&#x2F;&#x2F;storage.googleapis.com&#x2F;kubernetes-release&#x2F;release&#x2F;%s&#x2F;bin&#x2F;linux&#x2F;%s&#x2F;kubelet&quot;, kubelet.Version, kubelet.Arch)</span><br><span class="line">		kubectl.Url &#x3D; fmt.Sprintf(&quot;https:&#x2F;&#x2F;storage.googleapis.com&#x2F;kubernetes-release&#x2F;release&#x2F;%s&#x2F;bin&#x2F;linux&#x2F;%s&#x2F;kubectl&quot;, kubectl.Version, kubectl.Arch)</span><br><span class="line">		kubecni.Url &#x3D; fmt.Sprintf(&quot;https:&#x2F;&#x2F;github.com&#x2F;containernetworking&#x2F;plugins&#x2F;releases&#x2F;download&#x2F;%s&#x2F;cni-plugins-linux-%s-%s.tgz&quot;, kubecni.Version, kubecni.Arch, kubecni.Version)</span><br><span class="line">		helm.Url &#x3D; fmt.Sprintf(&quot;https:&#x2F;&#x2F;get.helm.sh&#x2F;helm-%s-linux-%s.tar.gz&quot;, helm.Version, helm.Arch)</span><br><span class="line">		getCmd :&#x3D; mgr.DownloadCommand(fmt.Sprintf(&quot;%s&#x2F;helm-%s-linux-%s.tar.gz&quot;, filepath, helm.Version, helm.Arch), helm.Url)</span><br><span class="line">		helm.GetCmd &#x3D; fmt.Sprintf(&quot;%s &amp;&amp; cd %s &amp;&amp; tar -zxf helm-%s-linux-%s.tar.gz &amp;&amp; mv linux-%s&#x2F;helm . &amp;&amp; rm -rf *linux-%s*&quot;, getCmd, filepath, helm.Version, helm.Arch, helm.Arch, helm.Arch)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ­¤å¤– kubekey åœ¨å®‰è£… docker æ—¶ï¼Œæ˜¯ç›´æ¥è°ƒç”¨çš„ <a href="https://get.docker.com/" target="_blank" rel="noopener">docker å®˜æ–¹çš„è„šæœ¬</a> æ¥å®‰è£…ï¼Œå®‰è£…è¿‡ç¨‹ä¹Ÿå¿…é¡»è®¿é—®å…¬ç½‘æ‰è¡Œã€‚</p>
<ul>
<li><a href="https://github.com/kubesphere/kubekey/blob/master/pkg/container-engine/docker/docker.go" target="_blank" rel="noopener">kubekey/blob/master/pkg/container-engine/docker/docker.go</a></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">func installDockerOnNode(mgr *manager.Manager, _ *kubekeyapiv1alpha1.HostCfg) error &#123;</span><br><span class="line">	dockerConfig, err :&#x3D; GenerateDockerConfig(mgr)</span><br><span class="line">	if err !&#x3D; nil &#123;</span><br><span class="line">		return err</span><br><span class="line">	&#125;</span><br><span class="line">	dockerConfigBase64 :&#x3D; base64.StdEncoding.EncodeToString([]byte(dockerConfig))</span><br><span class="line">	output, err1 :&#x3D; mgr.Runner.ExecuteCmd(fmt.Sprintf(&quot;sudo -E &#x2F;bin&#x2F;sh -c \&quot;if [ -z $(which docker) ] || [ ! -e &#x2F;var&#x2F;run&#x2F;docker.sock ]; then curl https:&#x2F;&#x2F;kubernetes.pek3b.qingstor.com&#x2F;tools&#x2F;kubekey&#x2F;docker-install.sh | sh &amp;&amp; systemctl enable docker; if [ ! -f &#x2F;etc&#x2F;docker&#x2F;daemon.json ]; then mkdir -p &#x2F;etc&#x2F;docker &amp;&amp; echo %s | base64 -d &gt; &#x2F;etc&#x2F;docker&#x2F;daemon.json; fi; systemctl daemon-reload &amp;&amp; systemctl restart docker; fi\&quot;&quot;, dockerConfigBase64), 0, false)</span><br><span class="line">	if err1 !&#x3D; nil &#123;</span><br><span class="line">		return errors.Wrap(errors.WithStack(err1), fmt.Sprintf(&quot;Failed to install docker:\n%s&quot;, output))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	return nil</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨ docker å®˜æ–¹çš„å®‰è£…è„šæœ¬æ¥å®‰è£… docker æ˜¯æœ‰ä¸€ä¸ªæ˜æ˜¾çš„é—®é¢˜å°±æ˜¯ï¼šæ²¡æœ‰ç‰ˆæœ¬æ§åˆ¶ï¼Œä¸èƒ½æŒ‡å®š docker çš„ç‰ˆæœ¬ï¼Œæ¯æ¬¡å®‰è£…çš„ docker ç‰ˆæœ¬éƒ½æ˜¯æœ€æ–°çš„ stable ç‰ˆæœ¬ã€‚æ²¡æœ‰ç‰ˆæœ¬æ§åˆ¶å°±ä¼šå¯¼è‡´ä¸åŒæ—¶é—´éƒ¨ç½²çš„é›†ç¾¤æˆ–è€…åŠ å…¥çš„èŠ‚ç‚¹ï¼Œdocker ç‰ˆæœ¬å¯èƒ½å°±ä¸ä¸€æ ·ï¼Œåœ¨è¿™é‡Œå¯èƒ½ä¼šåŸ‹ä¸‹ä¸€äº›å‘ï¼Œå¯èƒ½ä¼šå¸¦æ¥ä¸€å®šçš„ç»´æŠ¤æˆæœ¬æˆ–è€…å°†æ¥å‡çº§æ—¶é‡åˆ°é—®é¢˜ã€‚</p>
<p>ç¼–è¯‘è¿‡ kubernetes ç»„ä»¶çš„å¯èƒ½éƒ½çŸ¥é“ k8s æºç å½“ä¸­å­˜åœ¨ä¸€ä¸ª <a href="https://github.com/kubernetes/kubernetes/blob/master/build/dependencies.yaml" target="_blank" rel="noopener">build/dependencies.yaml</a> çš„æ–‡ä»¶ï¼Œé‡Œé¢è®°å½•çš„æ˜¯ k8s ç»„ä»¶ä¸å…¶ä»–ç»„ä»¶ (å¦‚ docker, etcd, coredns, cni, pause) æ‰€åŒ¹é…çš„æœ€ä½³ç‰ˆæœ¬ã€‚</p>
<blockquote>
<p>On each of your nodes, install the Docker for your Linux distribution as per <a href="https://docs.docker.com/engine/install/#server" target="_blank" rel="noopener">Install Docker Engine</a>. You can find the latest validated version of Docker in this <a href="https://git.k8s.io/kubernetes/build/dependencies.yaml" target="_blank" rel="noopener">dependencies</a> file.</p>
</blockquote>
<ul>
<li><a href="https://github.com/kubernetes/kubernetes/blob/release-1.20/build/dependencies.yaml" target="_blank" rel="noopener">kubernetes/blob/release-1.20/build/dependencies.yaml</a></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">dependencies:</span><br><span class="line">  # zeitgeist (https:&#x2F;&#x2F;github.com&#x2F;kubernetes-sigs&#x2F;zeitgeist) was inspired by</span><br><span class="line">  # (and now replaces) the cmd&#x2F;verifydependencies tool to verify external</span><br><span class="line">  # dependencies across the repo.</span><br><span class="line">  #</span><br><span class="line">  # The zeitgeist dependencies.yaml file format is intended to be</span><br><span class="line">  # backwards-compatible with the original tooling.</span><br><span class="line">  #</span><br><span class="line">  # In instances where the file format may change across versions, this meta</span><br><span class="line">  # dependency check exists to ensure we&#39;re pinned to a known good version.</span><br><span class="line">  #</span><br><span class="line">  # ref: https:&#x2F;&#x2F;github.com&#x2F;kubernetes&#x2F;kubernetes&#x2F;pull&#x2F;98845</span><br><span class="line"></span><br><span class="line">  # Docker</span><br><span class="line">  - name: &quot;docker&quot;</span><br><span class="line">    version: 19.03</span><br><span class="line">    refPaths:</span><br><span class="line">    - path: vendor&#x2F;k8s.io&#x2F;system-validators&#x2F;validators&#x2F;docker_validator.go</span><br><span class="line">      match: latestValidatedDockerVersion</span><br></pre></td></tr></table></figure>
<p>ä»¥ 1.20.x ç‰ˆæœ¬çš„ k8s ä¸ºä¾‹ï¼Œå®ƒæ‰€ä¾èµ–çš„ docker ç‰ˆæœ¬ä¸º 19.03ï¼Œè€Œç°åœ¨æœ€æ–°çš„ docker ç‰ˆæœ¬å¦‚ 20.10.8ï¼Œå¹¶ä¸æ˜¯ K8s å®˜æ–¹æ‰€å»ºè®®çš„æœ€ä½³ç‰ˆæœ¬ã€‚æ€»ä¹‹ï¼Œæˆ‘ä»¬åœ¨éƒ¨ç½² K8s æ—¶ï¼Œå¯ä»¥å‚è€ƒ <a href="https://github.com/kubernetes/kubernetes/blob/master/build/dependencies.yaml" target="_blank" rel="noopener">build/dependencies.yaml</a> æ¥ç¡®å®šä¸ K8s ç›¸å…³çš„ç»„ä»¶åº”è¯¥é€‰æ‹©å“ªä¸€ä¸ªæœ€ä½³çš„ç‰ˆæœ¬ï¼Œè€Œä¸æ˜¯éšä¾¿è£…ä¸€ä¸ªæœ€æ–°çš„ç‰ˆæœ¬å°±å®Œäº‹å„¿äº†ã€‚</p>
<h4><span id="kubespray">kubespray</span></h4>
<p>åœ¨ kubespray ä¸­ï¼Œæ‰€æœ‰äºŒè¿›åˆ¶æ–‡ä»¶çš„ URL éƒ½æ˜¯é€šè¿‡å˜é‡çš„æ–¹å¼å®šä¹‰çš„ï¼Œæƒ³è¦åšåˆ°ç¦»çº¿éƒ¨ç½²ååˆ†ç®€å•ï¼Œåªéœ€è¦é€šè¿‡ ansible å˜é‡ä¼˜å…ˆçº§çš„ç‰¹æ€§ï¼Œå°†å®ƒä»¬åœ¨ group_vars é€šè¿‡ overrides çš„æ–¹å¼è¦†ç›–å³å¯ã€‚æ¯”å¦‚è¿™æ ·ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># Download URLs</span><br><span class="line">kubelet_download_url: &quot;&#123;&#123; download_url &#125;&#125;&#x2F;storage.googleapis.com&#x2F;kubernetes-release&#x2F;release&#x2F;&#123;&#123; kube_version &#125;&#125;&#x2F;bin&#x2F;linux&#x2F;&#123;&#123; image_arch &#125;&#125;&#x2F;kubelet&quot;</span><br><span class="line">kubectl_download_url: &quot;&#123;&#123; download_url &#125;&#125;&#x2F;storage.googleapis.com&#x2F;kubernetes-release&#x2F;release&#x2F;&#123;&#123; kube_version &#125;&#125;&#x2F;bin&#x2F;linux&#x2F;&#123;&#123; image_arch &#125;&#125;&#x2F;kubectl&quot;</span><br><span class="line">kubeadm_download_url: &quot;&#123;&#123; download_url &#125;&#125;&#x2F;storage.googleapis.com&#x2F;kubernetes-release&#x2F;release&#x2F;&#123;&#123; kube_version &#125;&#125;&#x2F;bin&#x2F;linux&#x2F;&#123;&#123; image_arch &#125;&#125;&#x2F;kubeadm&quot;</span><br></pre></td></tr></table></figure>
<h3><span id="images">images</span></h3>
<p>ä¸€äº›å¦‚ kube-proxyã€kube-apiserverã€corednsã€calico ç»„ä»¶é•œåƒï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">k8s.gcr.io&#x2F;kube-apiserver:v1.20.7</span><br><span class="line">k8s.gcr.io&#x2F;kube-controller-manager:v1.20.7</span><br><span class="line">k8s.gcr.io&#x2F;kube-proxy:v1.20.7</span><br><span class="line">k8s.gcr.io&#x2F;kube-registry-proxy:0.4</span><br><span class="line">k8s.gcr.io&#x2F;kube-scheduler:v1.20.7</span><br><span class="line">k8s.gcr.io&#x2F;pause:3.3</span><br><span class="line">k8s.gcr.io&#x2F;coredns:1.7.0</span><br><span class="line">k8s.gcr.io&#x2F;cpa&#x2F;cluster-proportional-autoscaler-amd64:1.8.3</span><br><span class="line">k8s.gcr.io&#x2F;dns&#x2F;k8s-dns-node-cache:1.17.1</span><br></pre></td></tr></table></figure>
<h4><span id="sealos">sealos</span></h4>
<p>sealos å°†è¿™äº›é•œåƒä½¿ç”¨ docker save çš„æ–¹å¼æ‰“åŒ…æˆä¸€ä¸ª tar åŒ…ï¼Œåœ¨éƒ¨ç½²çš„æ—¶å€™ä½¿ç”¨ docker/ctr load çš„æ–¹å¼å°†é•œåƒå¯¼å…¥åˆ°å®¹å™¨è¿è¡Œæ—¶çš„å­˜å‚¨ç›®å½•å½“ä¸­ï¼Œæºç å¦‚ä¸‹ï¼š</p>
<ul>
<li><a href="https://github.com/fanux/sealos/blob/develop/install/send.go" target="_blank" rel="noopener">fanux/sealos/blob/develop/install/send.go</a></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; SendPackage is send new pkg to all nodes.</span><br><span class="line">func (u *SealosUpgrade) SendPackage() &#123;</span><br><span class="line">	all :&#x3D; append(u.Masters, u.Nodes...)</span><br><span class="line">	pkg :&#x3D; path.Base(u.NewPkgUrl)</span><br><span class="line">	&#x2F;&#x2F; rm old sealos in package avoid old version problem. if sealos not exist in package then skip rm</span><br><span class="line">	var kubeHook string</span><br><span class="line">	if For120(Version) &#123;</span><br><span class="line">		&#x2F;&#x2F; TODO update need load modprobe -- br_netfilter modprobe -- bridge.</span><br><span class="line">		&#x2F;&#x2F; https:&#x2F;&#x2F;github.com&#x2F;fanux&#x2F;cloud-kernel&#x2F;issues&#x2F;23</span><br><span class="line">		kubeHook &#x3D; fmt.Sprintf(&quot;cd &#x2F;root &amp;&amp; rm -rf kube &amp;&amp; tar zxvf %s  &amp;&amp; cd &#x2F;root&#x2F;kube&#x2F;shell &amp;&amp; rm -f ..&#x2F;bin&#x2F;sealos &amp;&amp; (ctr -n&#x3D;k8s.io image import ..&#x2F;images&#x2F;images.tar || true) &amp;&amp; cp -f ..&#x2F;bin&#x2F;* &#x2F;usr&#x2F;bin&#x2F; &quot;, pkg)</span><br><span class="line">	&#125; else &#123;</span><br><span class="line">		kubeHook &#x3D; fmt.Sprintf(&quot;cd &#x2F;root &amp;&amp; rm -rf kube &amp;&amp; tar zxvf %s  &amp;&amp; cd &#x2F;root&#x2F;kube&#x2F;shell &amp;&amp; rm -f ..&#x2F;bin&#x2F;sealos &amp;&amp; (docker load -i ..&#x2F;images&#x2F;images.tar || true) &amp;&amp; cp -f ..&#x2F;bin&#x2F;* &#x2F;usr&#x2F;bin&#x2F; &quot;, pkg)</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	PkgUrl &#x3D; SendPackage(pkg, all, &quot;&#x2F;root&quot;, nil, &amp;kubeHook)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨è¿™ç§æ–¹å¼åŠ è½½é•œåƒæœ‰ä¸€ä¸ªæ¯”è¾ƒæ˜æ˜¾çš„é™åˆ¶å°±æ˜¯ kube-apiserver çš„ admission å‡†å…¥æ§åˆ¶ä¸­ä¸èƒ½åŠ å…¥ <code>AlwaysPullImages</code> å‚æ•°ã€‚ä¸ç„¶ä¸è¿™äº›é•œåƒç›¸å…³çš„ pod é‡æ–°è°ƒåº¦æˆ–è€…é‡å¯ä¹‹åä¼šé‡æ–°ä»æºé•œåƒä»“åº“æ‹‰å–é•œåƒï¼Œåœ¨æ— ç½‘æˆ–è€…ç½‘ç»œé™åˆ¶çš„ç¯å¢ƒä¸­å¯èƒ½æ— æ³•æ‹‰å–é•œåƒå¯¼è‡´è¿™äº› Pod å¯åŠ¨å¤±è´¥ï¼Œä»è€Œå¯¼è‡´é›†ç¾¤å¼‚å¸¸ã€‚</p>
<p>è€Œåœ¨å¤šç§Ÿæˆ·åœºæ™¯ä¸‹ï¼Œå‡ºäºå®‰å…¨çš„è€ƒè™‘ <code>AlwaysPullImages</code> å‡†å…¥æ§åˆ¶å¾€å¾€æ˜¯è¦å¼€å¯çš„ã€‚å› æ­¤ sealos å¯èƒ½å¹¶ä¸é€‚ç”¨äºå¤šç§Ÿæˆ·æˆ–è€…å¯¹æ­¤æœ‰è¦æ±‚çš„ç¯å¢ƒä¸­ï¼ˆæœ€å¸¸è§çš„å°±æ˜¯ PaaS å¹³å°ï¼‰ã€‚</p>
<blockquote>
<p>è¯¥å‡†å…¥æ§åˆ¶å™¨ä¼šä¿®æ”¹æ¯ä¸€ä¸ªæ–°åˆ›å»ºçš„ Pod çš„é•œåƒæ‹‰å–ç­–ç•¥ä¸º Always ã€‚ è¿™åœ¨å¤šç§Ÿæˆ·é›†ç¾¤ä¸­æ˜¯æœ‰ç”¨çš„ï¼Œè¿™æ ·ç”¨æˆ·å°±å¯ä»¥æ”¾å¿ƒï¼Œä»–ä»¬çš„ç§æœ‰é•œåƒåªèƒ½è¢«é‚£äº›æœ‰å‡­è¯çš„äººä½¿ç”¨ã€‚ å¦‚æœæ²¡æœ‰è¿™ä¸ªå‡†å…¥æ§åˆ¶å™¨ï¼Œä¸€æ—¦é•œåƒè¢«æ‹‰å–åˆ°èŠ‚ç‚¹ä¸Šï¼Œä»»ä½•ç”¨æˆ·çš„ Pod éƒ½å¯ä»¥é€šè¿‡å·²äº†è§£åˆ°çš„é•œåƒçš„åç§°ï¼ˆå‡è®¾ Pod è¢«è°ƒåº¦åˆ°æ­£ç¡®çš„èŠ‚ç‚¹ä¸Šï¼‰æ¥ä½¿ç”¨å®ƒï¼Œè€Œä¸éœ€è¦å¯¹é•œåƒè¿›è¡Œä»»ä½•æˆæƒæ£€æŸ¥ã€‚ å½“å¯ç”¨è¿™ä¸ªå‡†å…¥æ§åˆ¶å™¨æ—¶ï¼Œæ€»æ˜¯åœ¨å¯åŠ¨å®¹å™¨ä¹‹å‰æ‹‰å–é•œåƒï¼Œè¿™æ„å‘³ç€éœ€è¦æœ‰æ•ˆçš„å‡­è¯ã€‚</p>
</blockquote>
<h4><span id="kubekey">kubekey</span></h4>
<p><a href="https://kubesphere.io/docs/installing-on-linux/introduction/air-gapped-installation/" target="_blank" rel="noopener">kubekey å®˜æ–¹çš„æ–‡æ¡£</a> ä¸­æœ‰æåˆ°ç»„ä»¶é•œåƒç¦»çº¿éƒ¨ç½²çš„æ–¹å¼ï¼Œä¸è¿‡ååˆ†ç¹ç(åŠé€€ğŸ˜‚)ï¼Œåœ¨ <a href="https://github.com/kubesphere/kubekey/issues/597" target="_blank" rel="noopener">Offline installation is too troublesome #597</a> ä¸­ä¹Ÿæœ‰äººåæ§½è¿™ä¸ªé—®é¢˜ã€‚ä¸è¿‡ç›®å‰ kubekey å¼€å‘å›¢é˜Ÿå·²ç»åœ¨é‡æ„è¿™éƒ¨åˆ†å†…å®¹äº†ï¼Œè‡³äºç»“æœå¦‚ä½•ï¼Œåªèƒ½ç­‰äº†ã€‚</p>
<h4><span id="é•œåƒä»“åº“">é•œåƒä»“åº“</span></h4>
<p>åœ¨ç§æœ‰äº‘ç¯å¢ƒä¸­ï¼Œä¼ä¸šä¸€èˆ¬éƒ½ä¼šæœ‰è‡ªå·±çš„é•œåƒä»“åº“ï¼ˆæ¯”å¦‚ harbor ï¼‰ç”¨äºå­˜æ”¾ä¸šåŠ¡ç»„ä»¶é•œåƒæˆ–è€…ä¸€äº›å…¶ä»–å¹³å°ä¾èµ–çš„é•œåƒã€‚å†åŠ ä¸Š Docker Hub è‡ªä»å»å¹´å¼€å§‹å°±åŠ å…¥äº† pull é•œåƒæ¬¡æ•°çš„é™åˆ¶ï¼Œå¦‚æœç›´æ¥ä½¿ç”¨ Docker Hub ä¸Šé¢çš„é•œåƒæ¥éƒ¨ç½²é›†ç¾¤ï¼Œå¾ˆæœ‰å¯èƒ½ä¼šå› ä¸º <a href="https://www.docker.com/increase-rate-limit" target="_blank" rel="noopener">429 toomanyrequests</a> æˆ–è€…ä¸€äº›ç½‘ç»œåŸå› å¯¼è‡´æ‹‰å–é•œåƒå¤±è´¥ã€‚å› æ­¤å¯¹äº k8s é›†ç¾¤éƒ¨ç½²è€Œè¨€ï¼Œå»ºè®®ä½¿ç”¨å†…éƒ¨è‡ªå·±çš„é•œåƒä»“åº“ï¼Œè€Œéå…¬ç½‘ä¸Šé•œåƒä»“åº“ã€‚å¦‚æœæ²¡æœ‰çš„è¯å¯ä»¥ä½¿ç”¨ harbor æˆ–è€… docker registry åœ¨æœ¬åœ°éƒ¨ç½²ä¸€ä¸ªé•œåƒä»“åº“ã€‚æˆ‘ä»¬å°†éƒ¨ç½²ä¾èµ–çš„é•œåƒå¯¼å…¥åˆ°å·²ç»å­˜åœ¨çš„é•œåƒä»“åº“ä¸­ï¼Œéƒ¨ç½²çš„æ—¶å€™ä»è¯¥é•œåƒä»“åº“æ‹‰å–å³å¯ã€‚</p>
<h2><span id="éƒ¨ç½²å·¥å…·é€‰æ‹©">éƒ¨ç½²å·¥å…·é€‰æ‹©</span></h2>
<p>ä¸Šé¢ç®€å•æ¢³ç†äº†ä¸€ä¸‹éƒ¨ç½² k8s é›†ç¾¤è¿‡ç¨‹ä¸­æ‰€ä¾èµ–çš„çš„åœ¨çº¿èµ„æºï¼Œä»¥åŠå¦‚ä½•å°†å®ƒä»¬åˆ¶ä½œæˆç¦»çº¿èµ„æºçš„ä¸€äº›åˆ†æã€‚ä¸Šé¢æåŠçš„éƒ¨ç½²å·¥å…·å„æœ‰å„çš„ä¼˜ç¼ºç‚¹ï¼Œé’ˆå¯¹ä»¥ä¸‹ä¸¤ç§ä¸åŒçš„åœºæ™¯å¯ä»¥é€‰æ‹©ä¸åŒçš„éƒ¨ç½²å·¥å…·ã€‚</p>
<h3><span id="sealos">sealos</span></h3>
<p>å¦‚æœä»…ä»…æ˜¯éƒ¨ç½²ä¸€ä¸ªç®€å•çš„ k8s é›†ç¾¤ï¼Œå¯¹é›†ç¾¤æ²¡æœ‰å¤ªå¤šå®šåˆ¶åŒ–çš„éœ€æ±‚ï¼Œé‚£ä¹ˆä½¿ç”¨ <a href="https://github.com/fanux/sealos" target="_blank" rel="noopener">sealos</a> å¯èƒ½æ˜¯æœ€ä½³çš„é€‰æ‹©ï¼Œåªä¸è¿‡å®ƒæ˜¯æ”¶è´¹çš„ï¼Œ<a href="https://www.sealyun.com/" target="_blank" rel="noopener">éœ€è¦å……å€¼ä¼šå‘˜</a> ğŸ˜‚ã€‚</p>
<blockquote>
<h3><span id="ç°åœ¨å¼€å§‹-99-69å¹´">ç°åœ¨å¼€å§‹ <s>ï¿¥99</s> ï¿¥69/å¹´</span></h3>
<p>æ¬¢è¿æˆä¸ºå¹´è´¹ä¼šå‘˜ï¼Œä»»æ„ä¸‹è½½æ‰€æœ‰ç‰ˆæœ¬è½¯ä»¶åŒ…!</p>
<blockquote>
<p>@F-liuhui ç¦»çº¿åŒ…å±…ç„¶è¦æ”¶è´¹ï¼Ÿé‚£è¿˜æ˜¯å¼€æºé¡¹ç›®å—ï¼Ÿ</p>
</blockquote>
<p>å¼€æºä¸ä»˜è´¹ä¸å†²çªï¼Œ100%å¼€æº 100%ä»˜è´¹</p>
<p><a href="https://www.sealyun.com/" target="_blank" rel="noopener">sealyun.com</a></p>
</blockquote>
<p>å¦‚æœåŠ¨æ‰‹èƒ½åŠ›å¼ºçš„è¯ï¼Œå¯ä»¥æ ¹æ® selaos ç¦»çº¿å®‰è£…åŒ…çš„ç›®å½•ç»“æ„ä½¿ç”¨ GitHub Actions æ¥æ„å»ºï¼Œå®ç°èµ·æ¥ä¹Ÿä¸æ˜¯å¾ˆéš¾ã€‚åªä¸è¿‡ç ¸åˆ«äººé¥­ç¢—çš„äº‹å„¿è¿˜æ˜¯ä¸åšä¸ºå¥½ï¼Œå› æ­¤æˆ‘ä»¬åº”è¯¥é€‰æ‹©å¦ä¸€ç§æ–¹æ¡ˆæ¥å®ç°ï¼Œè¿™æ ·ä¹Ÿèƒ½é¿å…ä¸€äº›å•†ä¸šçº çº·é—®é¢˜ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">$ tar -tf kube1.20.0.tar.gz</span><br><span class="line">kube&#x2F;</span><br><span class="line">kube&#x2F;lib64&#x2F;</span><br><span class="line">kube&#x2F;lib64&#x2F;README.md</span><br><span class="line">kube&#x2F;lib64&#x2F;libseccomp.so.2</span><br><span class="line">kube&#x2F;lib64&#x2F;libseccomp.so.2.3.1</span><br><span class="line">kube&#x2F;shell&#x2F;</span><br><span class="line">kube&#x2F;shell&#x2F;containerd.sh</span><br><span class="line">kube&#x2F;shell&#x2F;init.sh</span><br><span class="line">kube&#x2F;shell&#x2F;master.sh</span><br><span class="line">kube&#x2F;README.md</span><br><span class="line">kube&#x2F;bin&#x2F;</span><br><span class="line">kube&#x2F;bin&#x2F;kubelet</span><br><span class="line">kube&#x2F;bin&#x2F;kubectl</span><br><span class="line">kube&#x2F;bin&#x2F;conntrack</span><br><span class="line">kube&#x2F;bin&#x2F;kubeadm</span><br><span class="line">kube&#x2F;bin&#x2F;kubelet-pre-start.sh</span><br><span class="line">kube&#x2F;conf&#x2F;</span><br><span class="line">kube&#x2F;conf&#x2F;kubeadm.yaml</span><br><span class="line">kube&#x2F;conf&#x2F;kubelet.service</span><br><span class="line">kube&#x2F;conf&#x2F;calico.yaml</span><br><span class="line">kube&#x2F;conf&#x2F;10-kubeadm.conf</span><br><span class="line">kube&#x2F;conf&#x2F;net&#x2F;</span><br><span class="line">kube&#x2F;conf&#x2F;net&#x2F;calico.yaml</span><br><span class="line">kube&#x2F;containerd&#x2F;</span><br><span class="line">kube&#x2F;containerd&#x2F;README.md</span><br><span class="line">kube&#x2F;containerd&#x2F;cri-containerd-cni-linux-amd64.tar.gz</span><br><span class="line">kube&#x2F;images&#x2F;</span><br><span class="line">kube&#x2F;images&#x2F;images.tar</span><br><span class="line">kube&#x2F;images&#x2F;README.md</span><br></pre></td></tr></table></figure>
<h3><span id="kubekey">kubekey</span></h3>
<p>ç”±äº kubekey éƒ¨ç½²æ—¶äºŒè¿›åˆ¶æ–‡ä»¶éœ€è¦å…¬ç½‘è·å–ï¼Œdocker æ— æ³•ç¦»çº¿éƒ¨ç½²ä»¥åŠéœ€è¦æ‰‹åŠ¨å®‰è£…ä¸€äº›å‰ç½®ä¾èµ–ï¼Œæ²¡æœ‰åŠæ³•åšåˆ°å®Œæ•´çš„ç¦»çº¿éƒ¨ç½²ï¼Œå› æ­¤ç¦»çº¿éƒ¨ç½²çš„æ–¹æ¡ˆä¹Ÿå°±ç›´æ¥æ”¾å¼ƒæ‰äº†ï¼ŒæŠ½ç©ºä»–ä»¬æä¸ª Issue æˆ– PR çœ‹çœ‹èƒ½å¦æ”¯æŒè¿™éƒ¨åˆ† ğŸ˜…ã€‚</p>
<h3><span id="kubespray">kubespray</span></h3>
<p>å¦‚æœæƒ³æ‰¾ä¸€ä¸ªå³å¼€æºåˆå…è´¹çš„ç¦»çº¿éƒ¨ç½²æ–¹æ¡ˆï¼Œæˆ–è€…å¯¹é›†ç¾¤éƒ¨ç½²æœ‰ç‰¹æ®Šçš„è¦æ±‚ï¼Œæ¯”å¦‚åŸºäº K8s çš„ PaaS toB äº§å“ï¼Œéœ€è¦åœ¨éƒ¨ç½²æ—¶å®‰è£…å¹³å°æœ¬èº«éœ€è¦çš„ä¸€äº›ä¾èµ–ï¼ˆå¦‚å­˜å‚¨å®¢æˆ·ç«¯ã€GPU é©±åŠ¨ç­‰ï¼‰ã€‚é‚£ä¹ˆä¸å¦¨å…ˆçœ‹ä¸€ä¸‹ kubernetes-sig ç¤¾åŒºçš„ <a href="https://github.com/kubernetes-sigs/kubespray" target="_blank" rel="noopener">kubespray</a> å¦‚ä½• ğŸ¤”ï¼Œä¸»è¦çš„ç‰¹æ€§å¦‚ä¸‹ï¼š</p>
<ul>
<li>æ”¯æŒçš„ 10 ç§ CNI æ’ä»¶</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">- cni-plugins v0.9.1</span><br><span class="line">- calico v3.17.4</span><br><span class="line">- canal (given calico&#x2F;flannel versions)</span><br><span class="line">- cilium v1.9.9</span><br><span class="line">- flanneld v0.14.0</span><br><span class="line">- kube-ovn v1.7.1</span><br><span class="line">- kube-router v1.3.0</span><br><span class="line">- multus v3.7.2</span><br><span class="line">- ovn4nfv v1.1.0</span><br><span class="line">- weave v2.8.1</span><br></pre></td></tr></table></figure>
<ul>
<li>æ”¯æŒ 3 ç§å®¹å™¨è¿è¡Œæ—¶ä»¥åŠ <a href="https://github.com/kubernetes-sigs/kubespray/blob/master/docs/kata-containers.md" target="_blank" rel="noopener">Kata Containers</a> è¿˜æœ‰ nvidia-gpu-device-plugin ç­‰</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- docker v20.10</span><br><span class="line">- containerd v1.4.6</span><br><span class="line">- cri-o v1.21</span><br></pre></td></tr></table></figure>
<ul>
<li>é€‚é…äº† 10 ç§ Linux å‘è¡Œç‰ˆï¼Œè¦†ç›–äº†ç»å¤§å¤šæ•°ç§æœ‰äº‘åœºæ™¯</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">- Flatcar Container Linux by Kinvolk</span><br><span class="line">- Debian Buster, Jessie, Stretch, Wheezy</span><br><span class="line">- Ubuntu 16.04, 18.04, 20.04</span><br><span class="line">- CentOS&#x2F;RHEL 7, 8</span><br><span class="line">- Fedora 33, 34</span><br><span class="line">- Fedora CoreOS (see fcos Note)</span><br><span class="line">- openSUSE Leap 15.x&#x2F;Tumbleweed</span><br><span class="line">- Oracle Linux 7, 8</span><br><span class="line">- Alma Linux 8</span><br><span class="line">- Amazon Linux 2</span><br></pre></td></tr></table></figure>
<ul>
<li>ä¸°å¯Œçš„æ’ä»¶å’Œæ‰©å±•</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">## å·¥å…·ç±»</span><br><span class="line">- helm</span><br><span class="line">- krew</span><br><span class="line">- nerdctl</span><br><span class="line"></span><br><span class="line">## ä¸€äº› controller å’Œ provisioner</span><br><span class="line">- ambassador: v1.5</span><br><span class="line">- cephfs-provisioner v2.1.0-k8s1.11</span><br><span class="line">- rbd-provisioner v2.1.1-k8s1.11</span><br><span class="line">- cert-manager v0.16.1</span><br><span class="line">- coredns v1.8.0</span><br><span class="line">- ingress-nginx v0.43.0</span><br></pre></td></tr></table></figure>
<ul>
<li>ä¾èµ–çš„æ–‡ä»¶å’Œé•œåƒæ”¯æŒç¦»çº¿éƒ¨ç½² <a href="https://github.com/kubernetes-sigs/kubespray/blob/master/docs/offline-environment.md" target="_blank" rel="noopener">Offline environment</a></li>
</ul>
<p>kubespray å¯¹æ‰€æœ‰çš„ä¾èµ–èµ„æºéƒ½åšåˆ°äº†ç¦»çº¿ä¸‹è½½çš„æ”¯æŒï¼šæ¯”å¦‚æ‰€æœ‰ä¾èµ–æ–‡ä»¶çš„ URL éƒ½é€šè¿‡å˜é‡çš„æ–¹å¼æ¥å®šä¹‰ï¼Œè€Œé kubekey é‚£æ ·ç¡¬ç¼–ç åœ¨ä»£ç ä¸­ï¼›æ‰€æœ‰é•œåƒçš„ repo å’Œ tag éƒ½æ˜¯é€šè¿‡å˜é‡çš„æ–¹å¼æ¥å®šä¹‰ã€‚è¿™æ ·çš„å¥½å¤„å°±æ˜¯åœ¨éƒ¨ç½²çš„æ—¶å€™å¯ä»¥æ ¹æ®å®¢æˆ·ç¯å¢ƒçš„çš„é•œåƒä»“åº“åœ°å€å’Œæ–‡ä»¶æœåŠ¡å™¨çš„ URL åœ°å€æ¥å¡«å†™ç›¸åº”çš„å‚æ•°ï¼Œæ— éœ€é€šè¿‡å…¬ç½‘æ¥è·å–ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># Registry overrides</span><br><span class="line">kube_image_repo: &quot;&#123;&#123; registry_host &#125;&#125;&quot;</span><br><span class="line">gcr_image_repo: &quot;&#123;&#123; registry_host &#125;&#125;&quot;</span><br><span class="line">docker_image_repo: &quot;&#123;&#123; registry_host &#125;&#125;&quot;</span><br><span class="line">quay_image_repo: &quot;&#123;&#123; registry_host &#125;&#125;&quot;</span><br><span class="line"></span><br><span class="line">kubeadm_download_url: &quot;&#123;&#123; files_repo &#125;&#125;&#x2F;kubernetes&#x2F;&#123;&#123; kube_version &#125;&#125;&#x2F;kubeadm&quot;</span><br><span class="line">kubectl_download_url: &quot;&#123;&#123; files_repo &#125;&#125;&#x2F;kubernetes&#x2F;&#123;&#123; kube_version &#125;&#125;&#x2F;kubectl&quot;</span><br><span class="line">kubelet_download_url: &quot;&#123;&#123; files_repo &#125;&#125;&#x2F;kubernetes&#x2F;&#123;&#123; kube_version &#125;&#125;&#x2F;kubelet&quot;</span><br><span class="line"># etcd is optional if you **DON&#39;T** use etcd_deployment&#x3D;host</span><br><span class="line">etcd_download_url: &quot;&#123;&#123; files_repo &#125;&#125;&#x2F;kubernetes&#x2F;etcd&#x2F;etcd-&#123;&#123; etcd_version &#125;&#125;-linux-amd64.tar.gz&quot;</span><br><span class="line">cni_download_url: &quot;&#123;&#123; files_repo &#125;&#125;&#x2F;kubernetes&#x2F;cni&#x2F;cni-plugins-linux-&#123;&#123; image_arch &#125;&#125;-&#123;&#123; cni_version &#125;&#125;.tgz&quot;</span><br><span class="line">crictl_download_url: &quot;&#123;&#123; files_repo &#125;&#125;&#x2F;kubernetes&#x2F;cri-tools&#x2F;crictl-&#123;&#123; crictl_version &#125;&#125;-&#123;&#123; ansible_system | lower &#125;&#125;-&#123;&#123; image_arch &#125;&#125;.tar.gz&quot;</span><br><span class="line"># If using Calico</span><br><span class="line">calicoctl_download_url: &quot;&#123;&#123; files_repo &#125;&#125;&#x2F;kubernetes&#x2F;calico&#x2F;&#123;&#123; calico_ctl_version &#125;&#125;&#x2F;calicoctl-linux-&#123;&#123; image_arch &#125;&#125;&quot;</span><br></pre></td></tr></table></figure>
<p>å’Œä¸Šè¿°å‡ ç§éƒ¨ç½²å·¥å…·å¯¹æ¯”ä¸éš¾å‘ç°ï¼Œkubespray çµæ´»æ€§å’Œå¯æ‰©å±•æ€§è¦é¢†å…ˆå…¶ä»–å·¥å…·ï¼ˆæ”¯æŒ 10 ç§ CNIã€10ç§ Linux å‘è¡Œç‰ˆã€3 ç§ CRIã€ä»¥åŠå¤šç§æ’ä»¶å’Œæ‰©å±•ï¼‰å¹¶åœ¨å‚æ•°å±‚é¢ä¸Šåšåˆ°äº†ç¦»çº¿éƒ¨ç½²çš„æ”¯æŒã€‚å› æ­¤æˆ‘ä»¬é¦–å…ˆé€‰ç”¨ kubespray ä½œä¸ºé›†ç¾¤éƒ¨ç½²çš„åº•å±‚å·¥å…·ã€‚</p>
<p>è¿˜æœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯ kubespray è™½ç„¶åœ¨å‚æ•°é…ç½®ä¸Šæ”¯æŒç¦»çº¿éƒ¨ç½²ï¼Œä½†æ˜¯ä»åˆ¶ä½œç¦»çº¿å®‰è£…åŒ…åˆ°ä¸€é”®éƒ¨ç½²ï¼Œç›®å‰ä¸ºæ­¢è¿˜æœªæœ‰ä¸€ä¸ªå®Œæ•´çš„å®ç°æ–¹æ¡ˆã€‚å› æ­¤éœ€è¦ä¸º kubespray è®¾è®¡ä¸€å¥—ä»ç¦»çº¿å®‰è£…åŒ…çš„æ„å»ºåˆ°é›†ç¾¤ä¸€é”®éƒ¨ç½²çš„æµç¨‹å’Œæ–¹æ¡ˆï¼Œä¸ºæ­¤æˆ‘ä»¬æ–°å»ºä¸€ä¸ªåä¸º <a href="https://github.com/k8sli/kubeplay" target="_blank" rel="noopener">kubeplay</a> çš„ repo æ¥å®Œæˆè¿™éƒ¨åˆ†å†…å®¹ã€‚</p>
<p>å¦å¤–å€¼å¾—ä¸€æçš„æ˜¯ kubesphere æ—©æœŸçš„ç‰ˆæœ¬ v2.x ä½¿ç”¨ä¹Ÿæ˜¯ kubespray éƒ¨ç½²çš„ k8sï¼Œè‡³ä»Š ks-installer ä»£ç ä¸­ä»æ®‹ç•™ç€ <a href="https://github.com/kubesphere/ks-installer/commits/master/roles/download/tasks" target="_blank" rel="noopener">éƒ¨åˆ† kubespray çš„ä»£ç </a> ï¼Œåˆ°äº† 3.0 çš„æ—¶å€™å¼€å§‹ä½¿ç”¨è‡ªç ”çš„ kubekey æ¥éƒ¨ç½² K8s äº†ã€‚</p>
<blockquote>
<p>åŸºäº Ansible çš„å®‰è£…ç¨‹åºå…·æœ‰å¤§é‡è½¯ä»¶ä¾èµ–æ€§ï¼Œä¾‹å¦‚ Pythonã€‚KubeKey æ˜¯ä½¿ç”¨ Go è¯­è¨€å¼€å‘çš„ï¼Œå¯ä»¥æ¶ˆé™¤åœ¨å„ç§ç¯å¢ƒä¸­å‡ºç°çš„é—®é¢˜ï¼Œä»è€Œæé«˜å®‰è£…æˆåŠŸç‡ã€‚</p>
<p><a href="https://github.com/kubesphere/kubekey/blob/master/README_zh-CN.md" target="_blank" rel="noopener">README_zh-CN.md</a></p>
</blockquote>
<p>ä¸è¿‡ ansible çš„ä¾èµ–é—®é¢˜å½“æ—¶ä¸ºä»€ä¹ˆæ²¡æœ‰è€ƒè™‘é‡‡ç”¨å®¹å™¨åŒ–çš„æ–¹å¼è¿è¡Œ kubespray ğŸ¤”ï¼Œè‡³äº ansible çš„æ€§èƒ½é—®é¢˜ä¹Ÿä¸æ˜¯æ²¡æœ‰ä¼˜åŒ–çš„ä½™åœ°ã€‚</p>
<h2><span id="kubeplay"></span></h2>
<p>kubeplay è¿™ä¸ªé¡¹ç›®ä¸»è¦æ˜¯å®ç° K8s ç¦»çº¿å®‰è£…åŒ…çš„æ„å»ºå’Œä¸€é”®éƒ¨ç½²åŠŸèƒ½ï¼Œç›®å‰åªé€‚é…äº† kubesprayï¼Œç­‰åˆ°åé¢ä¼šé€‚é…ä¸€äº›å…¶ä»–éƒ¨ç½²å·¥å…·å¦‚ kubekeyã€‚</p>
<h3><span id="æ‰“åŒ…æ–¹å¼">æ‰“åŒ…æ–¹å¼</span></h3>
<p>ç”±äºéƒ¨ç½²ä¾èµ–çš„äºŒè¿›åˆ¶æ–‡ä»¶å’Œç»„ä»¶é•œåƒå¤§éƒ½å­˜æ”¾åœ¨ GitHub ã€Docker Hubã€<a href="http://gcr.io" target="_blank" rel="noopener">gcr.io</a>ï¼ˆGoogle Container Registryï¼‰ã€<a href="http://quay.io" target="_blank" rel="noopener">quay.io</a> è¿™äº›å›½å¤–çš„å¹³å°ä¸Šï¼Œåœ¨å›½å†…ç¯å¢ƒè·å–è¿™äº›èµ„æºæ˜¯æœ‰ä¸€å®šçš„ç½‘ç»œé™åˆ¶ã€‚è€Œ GitHub æ‰˜ç®¡çš„ runner è¿è¡Œåœ¨å›½å¤–çš„æœºæˆ¿å½“ä¸­ï¼Œå¯ä»¥å¾ˆé¡ºç•…åœ°è·å–è¿™äº›èµ„æºã€‚å› æ­¤æˆ‘ä»¬é€‰æ‹©ä½¿ç”¨ GitHub Actions æ¥è¿›è¡Œç¦»çº¿å®‰è£…åŒ…çš„æ„å»ºã€‚</p>
<p>åƒ selos é‚£æ ·å°†å®‰è£…åŒ…å­˜æ”¾åœ¨é˜¿é‡Œäº‘ OSS ä¸Šï¼Œåœ¨å›½å†…èƒ½ååˆ†é¡ºç•…åœ°é«˜é€Ÿä¸‹è½½ï¼Œæ”¶è´¹ä¹Ÿæ˜¯ç†æ‰€å½“ç„¶ã€‚ä½†æˆ‘ä»¬çš„æ–¹æ¡ˆæ˜¯ 100% å¼€æº 100% å…è´¹ï¼Œæ¯ä¸ªäººéƒ½å¯ä»¥ fork ä»£ç åˆ°è‡ªå·±çš„ repoï¼Œæ ¹æ®è‡ªå·±çš„éœ€æ±‚è¿›è¡Œæ„å»ºã€‚å› æ­¤é€‰æ‹© GitHub æ¥æ„å»ºå’Œå­˜æ”¾æˆ‘ä»¬çš„å®‰è£…åŒ…æ˜¯æœ€åˆé€‚çš„é€‰æ‹©ï¼Œè¿™æ ·ä¹Ÿä¸ç”¨å»é¢å¤–è€ƒè™‘å®‰è£…åŒ…ä¸‹è½½çš„é—®é¢˜ã€‚è‡³äºä» GitHub ä¸Šä¸‹è½½å®‰è£…åŒ…æ…¢çš„é—®é¢˜ï¼Œé‚£åº”è¯¥ç”±ä½¿ç”¨è€…è‡ªè¡Œå»è§£å†³ï¼Œè€Œéæœ¬æ–¹æ¡ˆæ‰€å…³å¿ƒçš„é—®é¢˜ã€‚</p>
<blockquote>
<p>Qï¼šå¦‚ä½•æ‘†è„±ç½‘ç»œçš„ä¾èµ–æ¥åˆ›å»ºä¸ª Docker çš„ image å‘¢ï¼Œæˆ‘è§‰å¾—è¿™ä¸ªæ˜¯ Docker ç”¨æˆ·è‡ªå·±çš„åŸºæœ¬æƒåˆ©ï¼Ÿ</p>
<p>Aï¼šè¿™ä¸ªåŸºæœ¬æƒåˆ©æˆ‘è§‰å¾—è¿˜æ˜¯è¦é—® GFW ï¼Œå›½å¤–çš„å¼€å‘äººå‘˜æ˜¯éå¸¸éš¾ç†è§£æœ‰äº›ä»–ä»¬è®¤ä¸ºè·Ÿæ°´ç”µä¸€æ ·æ™®åŠçš„åŸºç¡€è®¾æ–½åœ¨æŸäº›åœ°æ–¹è¿˜æ˜¯å¾ˆå›°éš¾çš„ã€‚</p>
<p>æ­¤å¤„å¼•ç”¨ <a href="http://dockone.io/article/722" target="_blank" rel="noopener">DockOneæŠ€æœ¯åˆ†äº«ï¼ˆäºŒåå››ï¼‰ï¼šå®¹å™¨å’ŒIaaSï¼šè°åŠ¨äº†è°çš„å¥¶é…ª</a></p>
</blockquote>
<p>é€‰æ‹©å¥½çš„æ„å»ºåœºæ‰€ä¸º GitHub Actions ä¹‹åæˆ‘ä»¬å†å°†è¿™äº›ç¦»çº¿èµ„æºè¿›è¡Œæ‹†åˆ†ï¼Œç›®çš„æ˜¯ä¸ºäº†å®ç°å„ä¸ªç¦»çº¿èµ„æºä¹‹é—´çš„è§£è€¦ï¼Œè¿™æ ·åšçµæ´»æ€§æ›´å¥½ä¸€äº›ï¼Œæ¯”å¦‚èƒ½å¤Ÿé€‚é…å¤šç§ OSã€æ”¯æŒå¤šä¸ª k8s ç‰ˆæœ¬ç­‰ã€‚ä¸»è¦æ‹†åˆ†æˆå¦‚ä¸‹å‡ ä¸ªæ¨¡å—ã€‚</p>
<table>
<thead>
<tr>
<th style="text-align:left">æ¨¡å—</th>
<th style="text-align:left">Repo</th>
<th style="text-align:left">ç”¨é€”</th>
<th style="text-align:left">è¿è¡Œ/ä½¿ç”¨æ–¹å¼</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">compose</td>
<td style="text-align:left"><a href="https://github.com/k8sli/kubeplay" target="_blank" rel="noopener">kubeplay</a></td>
<td style="text-align:left">ç”¨äºéƒ¨ç½² nginx å’Œ registry æœåŠ¡</td>
<td style="text-align:left">nerdctl compose</td>
</tr>
<tr>
<td style="text-align:left">os-tools</td>
<td style="text-align:left"><a href="https://github.com/k8sli/kubeplay" target="_blank" rel="noopener">kubeplay</a></td>
<td style="text-align:left">éƒ¨ç½² compose æ—¶çš„ä¸€äº›ä¾èµ–å·¥å…·</td>
<td style="text-align:left">äºŒè¿›åˆ¶å®‰è£…</td>
</tr>
<tr>
<td style="text-align:left">os-packages</td>
<td style="text-align:left"><a href="https://github.com/k8sli/os-packages" target="_blank" rel="noopener">os-packages</a></td>
<td style="text-align:left">æä¾› rpm/deb ç¦»çº¿æº</td>
<td style="text-align:left">nginx æä¾› http æ–¹å¼ä¸‹è½½</td>
</tr>
<tr>
<td style="text-align:left">kubespray</td>
<td style="text-align:left"><a href="https://github.com/k8sli/kubespray" target="_blank" rel="noopener">kubespray</a></td>
<td style="text-align:left">ç”¨äºéƒ¨ç½²/æ‰©ç¼©å®¹ k8s é›†ç¾¤</td>
<td style="text-align:left">å®¹å™¨æˆ–è€… pod</td>
</tr>
<tr>
<td style="text-align:left">kubespray-files</td>
<td style="text-align:left"><a href="https://github.com/k8sli/kubespray" target="_blank" rel="noopener">kubespray</a></td>
<td style="text-align:left">æä¾›äºŒè¿›åˆ¶æ–‡ä»¶ä¾èµ–</td>
<td style="text-align:left">nginx æä¾› http æ–¹å¼ä¸‹è½½</td>
</tr>
<tr>
<td style="text-align:left">kubespray-images</td>
<td style="text-align:left"><a href="https://github.com/k8sli/kubespray" target="_blank" rel="noopener">kubespray</a></td>
<td style="text-align:left">æä¾›ç»„ä»¶é•œåƒ</td>
<td style="text-align:left">registry æä¾›é•œåƒä¸‹è½½</td>
</tr>
</tbody>
</table>
<p>æ‹†åˆ†å®Œæˆä¹‹åï¼Œæˆ‘ä»¬æœ€ç»ˆè¿˜æ˜¯éœ€è¦å°†å®ƒä»¬ç»„åˆæˆä¸€ä¸ªå®Œæˆçš„ç¦»çº¿å®‰è£…åŒ…ã€‚ä¸ºäº†å‡å°‘ç»´æŠ¤æˆæœ¬ï¼Œæˆ‘ä»¬å°†æ¯ä¸ªæ¨¡å—çš„æ„å»ºæ“ä½œéƒ½æ”¾åœ¨ Dockerfile ä¸­ï¼Œå³ <code>All in Dockerfile</code> ğŸ¤£ã€‚è¿™æ ·æ¯ä¸ªæ¨¡å—çš„ GitHub Actions æµæ°´çº¿æœ€ç»ˆäº¤ä»˜çš„éƒ½æ˜¯ä¸€ä¸ªé•œåƒï¼Œç„¶åé•œåƒéƒ½æ¨é€åˆ° <code>ghcr.io</code> ä¸Šï¼Œè¿™æ ·å°±è§£å†³äº†æ¨¡å—é—´äº§ç‰©ä¼ é€’ä»¥åŠé•œåƒç¼“å­˜çš„é—®é¢˜ã€‚æœ€ç»ˆé€šè¿‡ä¸€ä¸ªæœ€ç»ˆçš„ <a href="https://github.com/k8sli/kubeplay/blob/main/Dockerfile" target="_blank" rel="noopener">Dockerfile</a> å°†è¿™äº›æ¨¡å—çš„é•œåƒå…¨éƒ¨ COPY åˆ°ä¸€ä¸ªé•œåƒå½“ä¸­ï¼Œåªè¦æ‰“åŒ…è¿™ä¸ªæœ€ç»ˆçš„é•œåƒä¸ºç¦»çº¿å®‰è£…åŒ…å³å¯ï¼›å¦ä¸€ä¸ªå¥½å¤„å°±ä½¿ç”¨ buildx æ„å»ºè¿™äº›ç¦»çº¿èµ„æºå°±åŸç”Ÿæ”¯æŒå¤š CPU ä½“ç³»æ¶æ„ï¼Œèƒ½å¤ŸåŒæ—¶é€‚é… amd64 å’Œ arm64 ä½“ç³»æ¶æ„ï¼Œè¿™æ · arm64 ä¹Ÿèƒ½æ„‰å¿«åœ°ç©è€äº†ï¼ŒçœŸæ˜¯ä¸€ä¸¾ä¸¤å¾—ã€‚</p>
<p>ä¸‹é¢å°±è¯¦ç»†è®²è§£æ¯ä¸ªæ¨¡å—çš„åŠŸèƒ½ä»¥åŠæ˜¯å¦‚ä½•æ‰“åŒ…çš„ï¼š</p>
<h3><span id="compose">compose</span></h3>
<p>compose æ¨¡å—é‡Œé¢ä¸»è¦è¿ä¸¤ä¸ªæœåŠ¡ï¼š ç”¨äºæä¾›æ–‡ä»¶ä¸‹è½½çš„ nginx å’Œç»„ä»¶é•œåƒæ‹‰å–çš„ registryã€‚è¿™ä¸¤ä¸ªæˆ‘ä»¬ä¾æ—§æ˜¯å®¹å™¨åŒ–ä»¥ç±»ä¼¼ docker-compose çš„æ–¹å¼æ¥éƒ¨ç½²ï¼Œè€Œæ‰€ä¾èµ–çš„ä¹Ÿåªæœ‰ä¸¤ä¸ªé•œåƒå’Œä¸€äº›é…ç½®æ–‡ä»¶è€Œå·²ã€‚</p>
<ul>
<li><a href="https://github.com/k8sli/kubeplay/blob/main/compose.yaml" target="_blank" rel="noopener">kubeplay/blob/main/compose.yaml</a></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">version: &#39;3.1&#39;</span><br><span class="line">services:</span><br><span class="line">  nginx:</span><br><span class="line">    container_name: nginx</span><br><span class="line">    image: nginx:1.20-alpine</span><br><span class="line">    restart: always</span><br><span class="line">    volumes:</span><br><span class="line">      - .&#x2F;resources&#x2F;nginx:&#x2F;usr&#x2F;share&#x2F;nginx</span><br><span class="line">      - .&#x2F;config&#x2F;compose&#x2F;certs&#x2F;domain.crt:&#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;domain.crt</span><br><span class="line">      - .&#x2F;config&#x2F;compose&#x2F;certs&#x2F;domain.key:&#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;domain.key</span><br><span class="line">      - .&#x2F;config&#x2F;compose&#x2F;nginx.conf:&#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;default.conf</span><br><span class="line">    ports:</span><br><span class="line">      # 443 ç«¯å£åå‘ä»£ç† registr çš„ 5000 ç«¯å£ï¼Œä»…ç”¨äº pull é•œåƒ</span><br><span class="line">      - 443:443</span><br><span class="line">      - 8080:8080</span><br><span class="line"></span><br><span class="line">  registry:</span><br><span class="line">    image: registry:2.7.1</span><br><span class="line">    container_name: registry</span><br><span class="line">    restart: always</span><br><span class="line">    volumes:</span><br><span class="line">      - .&#x2F;resources&#x2F;registry:&#x2F;var&#x2F;lib&#x2F;registry</span><br><span class="line">    ports:</span><br><span class="line">      # åªå…è®¸æœ¬åœ° 5000 ç«¯å£ push é•œåƒ</span><br><span class="line">      - 127.0.0.1:5000:5000</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸¤ä¸ªé•œåƒæˆ‘ä»¬ä½¿ç”¨ skopeo copy çš„æ–¹å¼ä¿å­˜ä¸º tar åŒ…ï¼Œéƒ¨ç½²çš„æ—¶å€™ load åˆ°å®¹å™¨è¿è¡Œæ—¶çš„å­˜å‚¨ä¸­ã€‚</p>
<blockquote>
<p>Qï¼šä¸ºä»€ä¹ˆè¦ç”¨ skopeo è€Œä¸æ˜¯ dockerï¼Ÿ</p>
<p>Aï¼šå› ä¸º Dockerfile æ„å»ºè¿‡ç¨‹ä¸­ä¸æ”¯æŒè¿è¡Œ docker å‘½ä»¤ save é•œåƒ</p>
</blockquote>
<ul>
<li>Dockerfile</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">FROM alpine:latest as downloader</span><br><span class="line">ARG SKOPEO_VERSION&#x3D;v1.4.0</span><br><span class="line">ARG NGINX_VERSION&#x3D;1.20-alpine</span><br><span class="line">ARG RERGISRRY_VERSION&#x3D;2.7.1</span><br><span class="line"></span><br><span class="line">WORKDIR &#x2F;tools</span><br><span class="line">RUN ARCH&#x3D;$(uname -m | sed &#39;s&#x2F;x86_64&#x2F;amd64&#x2F;;s&#x2F;aarch64&#x2F;arm64&#x2F;&#39;) \</span><br><span class="line">    &amp;&amp; apk --no-cache add wget ca-certificates \</span><br><span class="line">    &amp;&amp; wget -q -k https:&#x2F;&#x2F;github.com&#x2F;k8sli&#x2F;skopeo&#x2F;releases&#x2F;download&#x2F;v1.4.0&#x2F;skopeo-linux-$&#123;ARCH&#125; -O &#x2F;tools&#x2F;skopeo-linux-$&#123;ARCH&#125; \</span><br><span class="line">    &amp;&amp; chmod a+x &#x2F;tools&#x2F;* \</span><br><span class="line">    &amp;&amp; ln -s &#x2F;tools&#x2F;skopeo-linux-$&#123;ARCH&#125; &#x2F;usr&#x2F;bin&#x2F;skopeo</span><br><span class="line"></span><br><span class="line">WORKDIR &#x2F;images</span><br><span class="line">RUN ARCH&#x3D;$(uname -m | sed &#39;s&#x2F;x86_64&#x2F;amd64&#x2F;;s&#x2F;aarch64&#x2F;arm64&#x2F;&#39;) \</span><br><span class="line">    &amp;&amp; skopeo copy --insecure-policy --src-tls-verify&#x3D;false --override-arch $&#123;ARCH&#125; --additional-tag nginx:$&#123;NGINX_VERSION&#125; \</span><br><span class="line">       docker:&#x2F;&#x2F;docker.io&#x2F;library&#x2F;nginx:$&#123;NGINX_VERSION&#125; docker-archive:nginx-$&#123;NGINX_VERSION&#125;.tar \</span><br><span class="line">    &amp;&amp; skopeo copy --insecure-policy --src-tls-verify&#x3D;false --override-arch $&#123;ARCH&#125; --additional-tag registry:$&#123;RERGISRRY_VERSION&#125; \</span><br><span class="line">       docker:&#x2F;&#x2F;docker.io&#x2F;library&#x2F;registry:$&#123;RERGISRRY_VERSION&#125; docker-archive:registry-$&#123;RERGISRRY_VERSION&#125;.tar</span><br></pre></td></tr></table></figure>
<p>åœ¨éƒ¨ç½²çš„æ—¶å€™æˆ‘ä»¬ä½¿ç”¨ nerdctl compose çš„æ–¹å¼å¯åŠ¨å³å¯ï¼Œä½¿ç”¨æ–¹å¼æœ‰ç‚¹ç±»ä¼¼äº docker-composeã€‚</p>
<blockquote>
<p>Q: ä¸ºä»€ä¹ˆä¸ç”¨ docker å’Œ docker-compose</p>
<p>Aï¼šK8s å» docker æ˜¯å¤§åŠ¿æ‰€è¶‹ï¼Œé€‰æ‹© containerd æ›´ç¬¦åˆä¸»æµå‘å±•æ–¹å‘</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># å°†é•œåƒ load è¿› containerd å­˜å‚¨</span><br><span class="line">$ find $&#123;IMAGES_DIR&#125; -type f -name &#39;*.tar&#39; | xargs -L1 nerdctl load -i</span><br><span class="line"># nerdctl compose å¯åŠ¨ nginx å’Œ registry</span><br><span class="line">$ nerdctl compose -f compose.yaml up</span><br></pre></td></tr></table></figure>
<h3><span id="os-packages">os-packages</span></h3>
<p>è¿™éƒ¨åˆ†æ˜¯ rpm/deb ç¦»çº¿æºçš„æ„å»ºï¼Œå…¶è¯¦ç»†çš„è¿‡ç¨‹å’ŒåŸç†å¯ä»¥å‚è€ƒæˆ‘ä¹‹å‰å†™çš„åšå®¢ ã€Š<a href="https://blog.k8s.li/make-offline-mirrors.html" target="_blank" rel="noopener">ä½¿ç”¨ docker build åˆ¶ä½œ yum/apt ç¦»çº¿æº</a>ã€‹ï¼Œä¸‹é¢åªåˆ—ä¸¾ä¸€ä¸‹ CentOS7 ç¦»çº¿æºçš„æ„å»ºé…ç½®ï¼š</p>
<ul>
<li><a href="https://github.com/k8sli/os-packages/blob/main/build/Dockerfile.os.centos7" target="_blank" rel="noopener">Dockerfile</a></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">FROM centos:7.9.2009 as os-centos7</span><br><span class="line">ARG OS_VERSION&#x3D;7</span><br><span class="line">ARG DOCKER_MIRROR_URL&#x3D;&quot;https:&#x2F;&#x2F;download.docker.com&quot;</span><br><span class="line">ARG BUILD_TOOLS&#x3D;&quot;yum-utils createrepo epel-release wget&quot;</span><br><span class="line"></span><br><span class="line"># å®‰è£…æ„å»ºå·¥å…·ï¼Œé…ç½® docker å®˜æ–¹ yum æº</span><br><span class="line">RUN yum install -q -y $&#123;BUILD_TOOLS&#125; \</span><br><span class="line">    &amp;&amp; yum-config-manager --add-repo $&#123;DOCKER_MIRROR_URL&#125;&#x2F;linux&#x2F;centos&#x2F;docker-ce.repo \</span><br><span class="line">    &amp;&amp; yum makecache</span><br><span class="line"></span><br><span class="line">WORKDIR &#x2F;centos&#x2F;$OS_VERSION&#x2F;os</span><br><span class="line">COPY packages.yaml .</span><br><span class="line">COPY --from&#x3D;mikefarah&#x2F;yq:4.11.1 &#x2F;usr&#x2F;bin&#x2F;yq &#x2F;usr&#x2F;bin&#x2F;yq</span><br><span class="line"></span><br><span class="line"># æ ¹æ®é…ç½®æ–‡ä»¶è§£æè¯¥ OS éœ€è¦æ„å»ºçš„åŒ…ï¼Œå¹¶è·å–è¿™äº›åŒ…çš„ä¸‹è½½ url</span><br><span class="line">RUN yq eval &#39;.common[],.yum[],.centos7[],.kubespray.common[],.kubespray.yum[]&#39; packages.yaml &gt; packages.list \</span><br><span class="line">    &amp;&amp; sort -u packages.list | xargs repotrack --urls | sort -u &gt; packages.urls</span><br><span class="line"></span><br><span class="line"># é€šè¿‡ wget çš„æ–¹å¼ä¸‹è½½ rpm åŒ…ï¼Œä½¿ç”¨ createrepo åˆ›å»º repo ç´¢å¼•æ–‡ä»¶</span><br><span class="line">RUN ARCH&#x3D;$(uname -m) \</span><br><span class="line">    &amp;&amp; wget -q -x -P $&#123;ARCH&#125; -i packages.urls \</span><br><span class="line">    &amp;&amp; createrepo -d $&#123;ARCH&#125;</span><br><span class="line"></span><br><span class="line"># å°†æ„å»ºçš„å†…å®¹ COPY æˆå•ç‹¬çš„ä¸€å±‚</span><br><span class="line">FROM scratch</span><br><span class="line">COPY --from&#x3D;os-centos7 &#x2F;centos &#x2F;centos</span><br></pre></td></tr></table></figure>
<ul>
<li><a href="https://github.com/k8sli/os-packages/blob/main/packages.yaml" target="_blank" rel="noopener">packages.yaml</a> é…ç½®æ–‡ä»¶</li>
</ul>
<p>è¿™ä¸ªæ˜¯éœ€è¦å®‰è£…åŒ…çš„é…ç½®æ–‡ä»¶ï¼Œå¯ä»¥æ ¹æ®å¹³å°æˆ–è€…å®¢æˆ·çš„ä¸€äº›è¦æ±‚é…ç½®ä¸Šä¸åŒçš„åŒ…</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">kubespray:</span><br><span class="line">  common:</span><br><span class="line">    - curl</span><br><span class="line">    - rsync</span><br><span class="line">    - socat</span><br><span class="line">    - unzip</span><br><span class="line">    - e2fsprogs</span><br><span class="line">    - xfsprogs</span><br><span class="line">    - ebtables</span><br><span class="line">    - bash-completion</span><br><span class="line">    - ipvsadm</span><br><span class="line">    - ipset</span><br><span class="line">    - conntrack</span><br><span class="line"></span><br><span class="line">  yum:</span><br><span class="line">    - nss</span><br><span class="line">    - libselinux-python</span><br><span class="line">    - device-mapper-libs</span><br><span class="line">  apt:</span><br><span class="line">    - python-apt</span><br><span class="line">    - python3-apt</span><br><span class="line">    - aufs-tools</span><br><span class="line">    - apt-transport-https</span><br><span class="line">    - software-properties-common</span><br><span class="line"></span><br><span class="line">common:</span><br><span class="line">  - cifs-utils</span><br><span class="line">  - lsof</span><br><span class="line">  - lvm2</span><br><span class="line">  - openssl</span><br><span class="line">  - sshpass</span><br><span class="line">  - vim</span><br><span class="line">  - wget</span><br><span class="line">  - ethtool</span><br><span class="line">  - net-tools</span><br><span class="line">  - rsync</span><br><span class="line">  - chrony</span><br><span class="line"></span><br><span class="line">yum:</span><br><span class="line">  - nfs-utils</span><br><span class="line">  - yum-utils</span><br><span class="line">  - createrepo</span><br><span class="line">  - epel-release</span><br><span class="line">  - nc</span><br><span class="line">  - httpd-tools</span><br><span class="line"></span><br><span class="line">apt:</span><br><span class="line">  - nfs-common</span><br><span class="line">  - apt-transport-https</span><br><span class="line">  - ca-certificates</span><br><span class="line">  - gnupg</span><br><span class="line">  - lsb-release</span><br><span class="line">  - aptitude</span><br><span class="line">  - dpkg-dev</span><br><span class="line">  - gnupg2</span><br><span class="line">  - netcat</span><br><span class="line">  - apache2-utils</span><br><span class="line"></span><br><span class="line">centos7:</span><br><span class="line">  - containerd.io-1.4.6</span><br><span class="line"></span><br><span class="line">ubuntu:</span><br><span class="line">  - containerd.io&#x3D;1.4.6-1</span><br><span class="line"></span><br><span class="line">debian10:</span><br><span class="line">  - containerd.io&#x3D;1.4.6-1</span><br></pre></td></tr></table></figure>
<blockquote>
<p>å¯¹äº toB äº§å“ï¼Œå»ºè®®å°†ä¸‹é¢è¿™äº›å¸¸è§çš„è¿ç»´è°ƒè¯•å·¥å…·ï¼ˆå¦‚ tcpdump, strace, lsof, net-tools ç­‰ï¼‰ä¹Ÿæ„å»ºåœ¨ç¦»çº¿æºä¸­ã€‚è¿™æ ·ä¹Ÿä¸è‡³äºåœ¨å®¢æˆ·çš„ç¯å¢ƒä¸­æ’æŸ¥é—®é¢˜çš„æ—¶å€™æœºå™¨ä¸Šè¿ä¸ª tcpdump éƒ½æ²¡æœ‰ï¼Œå°¤å…¶æ˜¯åœ¨æ— ç½‘çš„ç¯å¢ƒä¸­ï¼Œå¦‚æœæ²¡æœ‰è¿™äº›å¸¸ç”¨çš„è¿ç»´å·¥å…·ï¼Œæ’æŸ¥é—®é¢˜å°†ä¼šååˆ†æ£˜æ‰‹ã€‚</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">tools:</span><br><span class="line">  - bash-completion</span><br><span class="line">  - chrony</span><br><span class="line">  - cifs-utils</span><br><span class="line">  - curl</span><br><span class="line">  - dstat</span><br><span class="line">  - e2fsprogs</span><br><span class="line">  - ebtables</span><br><span class="line">  - expect</span><br><span class="line">  - gdb</span><br><span class="line">  - htop</span><br><span class="line">  - iftop</span><br><span class="line">  - iotop</span><br><span class="line">  - ipset</span><br><span class="line">  - ipvsadm</span><br><span class="line">  - jq</span><br><span class="line">  - lsof</span><br><span class="line">  - lvm2</span><br><span class="line">  - ncdu</span><br><span class="line">  - net-tools</span><br><span class="line">  - nethogs</span><br><span class="line">  - nload</span><br><span class="line">  - ntpdate</span><br><span class="line">  - openssl</span><br><span class="line">  - pciutils</span><br><span class="line">  - psmisc</span><br><span class="line">  - rsync</span><br><span class="line">  - smartmontools</span><br><span class="line">  - socat</span><br><span class="line">  - sshpass</span><br><span class="line">  - strace</span><br><span class="line">  - sysstat</span><br><span class="line">  - tcpdump</span><br><span class="line">  - telnet</span><br><span class="line">  - tmux</span><br></pre></td></tr></table></figure>
<h3><span id="kubespray">kubespray</span></h3>
<p>kubespray æ˜¯éƒ¨ç½² K8s é›†ç¾¤ã€å¢åŠ èŠ‚ç‚¹ã€åˆ é™¤èŠ‚ç‚¹ã€ç§»é™¤é›†ç¾¤ç­‰æ¶‰åŠå¯¹é›†ç¾¤æ“ä½œçš„ä¸»è¦å·¥å…·ã€‚æˆ‘ä»¬ä¾æ—§é‡‡ç”¨å®¹å™¨åŒ–çš„æ–¹å¼è¿è¡Œ kubesprayï¼Œä¸»è¦æœ‰ä»¥ä¸‹åœºæ™¯ä¼šç”¨åˆ° kubesprayï¼š</p>
<ul>
<li>åœ¨éƒ¨ç½²å·¥å…·è¿è¡ŒèŠ‚ç‚¹ï¼Œä½¿ç”¨ nerdctl æ¥è¿è¡Œ kubespray å®¹å™¨éƒ¨ç½² K8s é›†ç¾¤</li>
<li>K8s é›†ç¾¤éƒ¨ç½²å®Œæ¯•åï¼Œä»¥ Job pod çš„æ–¹å¼è¿è¡Œéƒ¨ç½²å¦ä¸€ä¸ª K8s é›†ç¾¤ï¼Œå®ç°å¤šé›†ç¾¤éƒ¨ç½²çš„åŸºæœ¬èƒ½åŠ›</li>
<li>K8s é›†ç¾¤éƒ¨ç½²å®Œæ¯•åï¼Œä»¥ Job pod çš„æ–¹å¼è¿è¡Œ kubespray å¯¹è¯¥é›†ç¾¤é›†ç¾¤èŠ‚ç‚¹è¿›è¡Œæ‰©ç¼©å®¹</li>
</ul>
<p>Job pod æ–¹å¼å¯¹é›†ç¾¤è¿›è¡Œæ‰©ç¼©å®¹çš„è®¾è®¡çš„æ˜¯ä¸ºäº†ä»ä¸€å®šç¨‹åº¦ä¸Šè§£å†³éƒ¨ç½²å¤§è§„æ¨¡é›†ç¾¤æ—¶ ansible æ€§èƒ½é—®é¢˜ã€‚å³æˆ‘ä»¬ä¸€å¼€å§‹ä¸å¿…å°±éƒ¨ç½²ä¸€ä¸ªä¸ŠåƒèŠ‚ç‚¹çš„é›†ç¾¤ï¼Œè€Œæ˜¯å…ˆæŠŠä¸€ä¸ªè§„æ¨¡è¾ƒå°çš„é›†ç¾¤éƒ¨ç½²èµ·æ¥ï¼Œç„¶åé€šè¿‡åˆ›å»ºæ‰¹é‡çš„ Job çš„æ–¹å¼è¿è¡Œ kubespray å†å°†é›†ç¾¤æ…¢æ…¢æ‰©å®¹èµ·æ¥ï¼Œæ¯”å¦‚æ‰©å®¹åˆ°ä¸Šåƒå°èŠ‚ç‚¹ã€‚</p>
<p>kubespray å®˜æ–¹çš„ Dockerfile æ„å»ºå‡ºæ¥çš„é•œåƒæœ‰ 1.4GBï¼Œå®åœ¨æ˜¯å¤ªå¤§äº†ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ä¼˜åŒ–ä¸€ä¸‹ï¼Œå‡å°‘é•œåƒå¤§å°</p>
<ul>
<li>kubespray BASE é•œåƒ</li>
</ul>
<p>é¦–å…ˆæ„å»ºä¸€ä¸ª base é•œåƒï¼Œå¯¹äºä¸ç»å¸¸å˜åŠ¨çš„å†…å®¹æˆ‘ä»¬æŠŠå®ƒå°è£…åœ¨ä¸€ä¸ª base é•œåƒé‡Œï¼Œåªæœ‰å½“ç›¸å…³ä¾èµ–æ›´æ–°äº†æ‰éœ€è¦é‡æ–°æ„å»ºè¿™ä¸ª base é•œåƒï¼Œ<code>Dockerfile.base</code> å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">FROM python:3 as builder</span><br><span class="line">ARG KUBE_VERSION&#x3D;v1.21.3</span><br><span class="line">COPY requirements.txt requirements.txt</span><br><span class="line">COPY tests&#x2F;requirements.txt tests&#x2F;requirements.txt</span><br><span class="line">RUN echo &#39;shellcheck-py&#x3D;&#x3D;0.7.2.1&#39; &gt;&gt; requirements.txt \</span><br><span class="line">    &amp;&amp; grep -E &#39;^yamllint|^ansible-lint&#39; tests&#x2F;requirements.txt &gt;&gt; requirements.txt \</span><br><span class="line">    &amp;&amp; pip3 install --user -r requirements.txt</span><br><span class="line"></span><br><span class="line">RUN ARCH&#x3D;$(uname -m | sed &#39;s&#x2F;x86_64&#x2F;amd64&#x2F;;s&#x2F;aarch64&#x2F;arm64&#x2F;&#39;) \</span><br><span class="line">    &amp;&amp; wget -O &#x2F;root&#x2F;.local&#x2F;bin&#x2F;kubectl -q https:&#x2F;&#x2F;dl.k8s.io&#x2F;$&#123;KUBE_VERSION&#125;&#x2F;bin&#x2F;linux&#x2F;$&#123;ARCH&#125;&#x2F;kubectl \</span><br><span class="line">	&amp;&amp; chmod a+x &#x2F;root&#x2F;.local&#x2F;bin&#x2F;kubectl</span><br><span class="line"></span><br><span class="line">FROM python:3-slim</span><br><span class="line">RUN DEBIAN_FRONTEND&#x3D;noninteractive apt-get update -y -qq \</span><br><span class="line">    &amp;&amp; apt-get install -y -qq --no-install-recommends \</span><br><span class="line">        ca-certificates libssl-dev openssh-client sshpass curl gnupg2 rsync \</span><br><span class="line">        jq moreutils vim iputils-ping wget tcpdump xz-utils \</span><br><span class="line">    &amp;&amp; rm -rf &#x2F;var&#x2F;lib&#x2F;apt&#x2F;lists&#x2F;*</span><br><span class="line"></span><br><span class="line">COPY --from&#x3D;builder &#x2F;root&#x2F;.local &#x2F;usr&#x2F;local</span><br><span class="line">WORKDIR &#x2F;kubespray</span><br></pre></td></tr></table></figure>
<ul>
<li><a href="https://blog.k8s.li/pass-tob-k8s-offline-deploy.html?utm_source=pocket_mylist" target="_blank" rel="noopener">kubespray é•œåƒ</a></li>
</ul>
<p>FROM çš„ base é•œåƒå°±ä½¿ç”¨æˆ‘ä»¬åˆšåˆšæ„å»ºå¥½çš„é•œåƒï¼Œç›¸å…³ä¾èµ–å·²ç»åœ¨ base é•œåƒä¸­å®‰è£…å¥½äº†ï¼Œè¿™é‡Œæ„å»ºçš„æ—¶å€™åªéœ€è¦æŠŠ repo æºç å¤åˆ¶åˆ° /kubespray ç›®å½•ä¸‹å³å¯ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ARG BASE_IMAGE&#x3D;ghcr.io&#x2F;k8sli&#x2F;kubespray-base</span><br><span class="line">ARG BASE_IMAGE_VERSION&#x3D;latest</span><br><span class="line">FROM $BASE_IMAGE:$BASE_IMAGE_VERSION</span><br><span class="line">WORKDIR &#x2F;kubespray</span><br><span class="line">COPY . .</span><br></pre></td></tr></table></figure>
<ul>
<li>kubespray é›†ç¾¤éƒ¨ç½²å…¥å£ <code>run.sh</code></li>
</ul>
<p>å°†é›†ç¾¤éƒ¨ç½²ã€å¢åŠ èŠ‚ç‚¹ã€åˆ é™¤èŠ‚ç‚¹ã€åˆ é™¤é›†ç¾¤ç­‰æ“ä½œå°è£…æˆä¸€ä¸ªå…¥å£çš„è„šæœ¬ï¼Œæä¾›å¤–éƒ¨å·¥å…·è°ƒç”¨è¯¥è„šæœ¬ï¼Œä¸ç„¶å¤–éƒ¨è°ƒç”¨çš„æ—¶å€™ç›´æ¥è¿è¡Œ <code>ansible-playbook</code> å‘½ä»¤å®åœ¨æ˜¯ä¸å¤ªæ–¹ä¾¿ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">TYPE&#x3D;$1</span><br><span class="line">NODES&#x3D;$2</span><br><span class="line"></span><br><span class="line">KUBE_ROOT&#x3D;&quot;$(cd &quot;$(dirname &quot;$0&quot;)&quot; &amp;&amp; pwd)&quot;</span><br><span class="line"></span><br><span class="line">: $&#123;TYPE:&#x3D;deploy-cluster&#125;</span><br><span class="line">: $&#123;ANSIBLE_FORKS:&#x3D;10&#125;</span><br><span class="line">: $&#123;BECOME_USER:&#x3D;root&#125;</span><br><span class="line">: $&#123;ANSIBLE_LOG_FORMAT:&#x3D;yaml&#125;</span><br><span class="line">: $&#123;INVENTORY:&#x3D;$&#123;KUBE_ROOT&#125;&#x2F;config&#x2F;inventory&#125;</span><br><span class="line">: $&#123;ENV_FILE:&#x3D;$&#123;KUBE_ROOT&#125;&#x2F;config&#x2F;env.yml&#125;</span><br><span class="line">: $&#123;INSTALL_STEPS_FILE:&#x3D;$&#123;KUBE_ROOT&#125;&#x2F;config&#x2F;.install_steps&#125;</span><br><span class="line"></span><br><span class="line">export ANSIBLE_STDOUT_CALLBACK&#x3D;$&#123;ANSIBLE_LOG_FORMAT&#125;</span><br><span class="line">export ANSIBLE_ARGS&#x3D;&quot;-f $&#123;ANSIBLE_FORKS&#125; --become --become-user&#x3D;$&#123;BECOME_USER&#125; -i $&#123;INVENTORY&#125; -e @$&#123;ENV_FILE&#125;&quot;</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"># Set logging colors</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line">NORMAL_COL&#x3D;$(tput sgr0)</span><br><span class="line">RED_COL&#x3D;$(tput setaf 1)</span><br><span class="line">WHITE_COL&#x3D;$(tput setaf 7)</span><br><span class="line">GREEN_COL&#x3D;$(tput setaf 76)</span><br><span class="line">YELLOW_COL&#x3D;$(tput setaf 202)</span><br><span class="line"></span><br><span class="line">debuglog()&#123; printf &quot;$&#123;WHITE_COL&#125;%s$&#123;NORMAL_COL&#125;\n&quot; &quot;$@&quot;; &#125;</span><br><span class="line">infolog()&#123; printf &quot;$&#123;GREEN_COL&#125;âœ” %s$&#123;NORMAL_COL&#125;\n&quot; &quot;$@&quot;; &#125;</span><br><span class="line">warnlog()&#123; printf &quot;$&#123;YELLOW_COL&#125;âœ %s$&#123;NORMAL_COL&#125;\n&quot; &quot;$@&quot;; &#125;</span><br><span class="line">errorlog()&#123; printf &quot;$&#123;RED_COL&#125;âœ– %s$&#123;NORMAL_COL&#125;\n&quot; &quot;$@&quot;; &#125;</span><br><span class="line"></span><br><span class="line">set -eo pipefail</span><br><span class="line"></span><br><span class="line">if [[ ! -f $&#123;INVENTORY&#125; ]]; then</span><br><span class="line">  errorlog &quot;$&#123;INVENTORY&#125; file is missing, please check the inventory file is exists&quot;</span><br><span class="line">  exit 1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">deploy_cluster()&#123;</span><br><span class="line">:</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">main()&#123;</span><br><span class="line">  case $TYPE in</span><br><span class="line">    deploy-cluster)</span><br><span class="line">      infolog &quot;######  start deploy kubernetes cluster  ######&quot;</span><br><span class="line">      deploy_cluster</span><br><span class="line">      infolog &quot;######  kubernetes cluster successfully installed  ######&quot;</span><br><span class="line">      ;;</span><br><span class="line">    remove-cluster)</span><br><span class="line">      infolog &quot;######  start remove kubernetes cluster  ######&quot;</span><br><span class="line">      if ansible-playbook $&#123;ANSIBLE_ARGS&#125; $&#123;KUBE_ROOT&#125;&#x2F;reset.yml &gt;&#x2F;dev&#x2F;stdout 2&gt;&#x2F;dev&#x2F;stderr; then</span><br><span class="line">        rm -f $&#123;INSTALL_STEP_FILE&#125;</span><br><span class="line">        infolog &quot;######  kubernetes cluster successfully removed ######&quot;</span><br><span class="line">      fi</span><br><span class="line">      ;;</span><br><span class="line">    add-node)</span><br><span class="line">      check_nodename</span><br><span class="line">      infolog &quot;######  start add worker to kubernetes cluster  ######&quot;</span><br><span class="line">      ansible-playbook $&#123;ANSIBLE_ARGS&#125; --limit&#x3D;&quot;$&#123;NODES&#125;&quot; $&#123;KUBE_ROOT&#125;&#x2F;playbooks&#x2F;10-scale-nodes.yml &gt;&#x2F;dev&#x2F;stdout 2&gt;&#x2F;dev&#x2F;stderr</span><br><span class="line">      ;;</span><br><span class="line">    remove-node)</span><br><span class="line">      check_nodename</span><br><span class="line">      infolog &quot;######  start remove worker from kubernetes cluster  ######&quot;</span><br><span class="line">      ansible-playbook $&#123;ANSIBLE_ARGS&#125; -e node&#x3D;&quot;$&#123;NODES&#125;&quot; -e reset_nodes&#x3D;true $&#123;KUBE_ROOT&#125;&#x2F;remove-node.yml &gt;&#x2F;dev&#x2F;stdout 2&gt;&#x2F;dev&#x2F;stderr</span><br><span class="line">      ;;</span><br><span class="line">    *)</span><br><span class="line">      errorlog &quot;unknow [TYPE] parameter: $&#123;TYPE&#125;&quot;</span><br><span class="line">      ;;</span><br><span class="line">  esac</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">main &quot;$@&quot;</span><br></pre></td></tr></table></figure>
<ul>
<li>åˆ†å±‚éƒ¨ç½² <a href="https://github.com/k8sli/kubespray/tree/main/playbooks" target="_blank" rel="noopener">playbooks</a></li>
</ul>
<p>ä¸åŒäº kubespray å®˜æ–¹ä½¿ç”¨ä¸€ä¸ªå®Œæ•´çš„ <a href="https://github.com/kubernetes-sigs/kubespray/blob/master/cluster.yml" target="_blank" rel="noopener">cluster.yaml</a> æ¥å®Œæˆæ•´ä¸ª K8s é›†ç¾¤çš„éƒ¨ç½²ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œå¼•å…¥äº†åˆ†å±‚éƒ¨ç½²çš„ç‰¹æ€§ã€‚å³å°†é›†ç¾¤éƒ¨ç½²åˆ†æˆè‹¥å¹²ä¸ªç›¸äº’ç‹¬ç«‹çš„ playbookï¼Œç„¶ååœ¨å„ä¸ª playbook é‡Œå¼•å…¥æˆ‘ä»¬å¢åŠ çš„ roles ä»¥åŠäºŒå¼€å†…å®¹ã€‚è¿™æ ·çš„å¥½å¤„å°±æ˜¯èƒ½å’Œ kubespray ä¸Šæ¸¸çš„ä»£ç ä¿æŒç›¸äº’ç‹¬ç«‹ï¼Œåœ¨ rebase æˆ–è€… cherry-pick ä¸Šæ¸¸æœ€æ–°çš„ä»£ç èƒ½å¤Ÿé¿å…å‡ºç°å†²çªçš„ç°è±¡ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">playbooks</span><br><span class="line">â”œâ”€â”€ 00-default-ssh-config.yml    # é…ç½® ssh è¿æ¥</span><br><span class="line">â”œâ”€â”€ 01-cluster-bootstrap-os.yml  # åˆå§‹åŒ–é›†ç¾¤èŠ‚ç‚¹</span><br><span class="line">â”œâ”€â”€ 02-cluster-etcd.yml          # éƒ¨ç½² etcd é›†ç¾¤</span><br><span class="line">â”œâ”€â”€ 03-cluster-kubernetes.yml    # éƒ¨ç½² k8s master å’Œ node</span><br><span class="line">â”œâ”€â”€ 04-cluster-network.yml       # éƒ¨ç½² CNI æ’ä»¶</span><br><span class="line">â”œâ”€â”€ 05-cluster-apps.yml          # éƒ¨ç½²ä¸€äº› addon ç»„ä»¶å¦‚ coredns</span><br><span class="line">â””â”€â”€ 10-scale-nodes.yml           # å¢åˆ èŠ‚ç‚¹</span><br></pre></td></tr></table></figure>
<p>åˆ†å±‚éƒ¨ç½²çš„æ—¶å€™é€šè¿‡ä¸€ä¸ªæ–‡ä»¶æ¥è®°å½•å·²ç»éƒ¨ç½²æˆåŠŸçš„æ­¥éª¤ï¼Œè¿™æ ·å¦‚æœæœ¬æ¬¡å› ä¸ºä¸€äº›åŸå› å¯¼è‡´éƒ¨ç½²å¤±è´¥ï¼ˆå¦‚ç½‘ç»œä¸­æ–­ï¼‰ï¼Œé‚£ä¹ˆä¸‹æ¬¡é‡æ–°éƒ¨ç½²çš„æ—¶å€™ä¼šè·³è¿‡å·²ç»éƒ¨ç½²å¥½çš„æ­¥éª¤ï¼Œä»å¤±è´¥çš„åœ°æ–¹ç»§ç»­éƒ¨ç½²ï¼Œä»¥æå‡æ•´ä½“çš„éƒ¨ç½²æ•ˆç‡ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">deploy_cluster()&#123;</span><br><span class="line">  touch $&#123;INSTALL_STEPS_FILE&#125;</span><br><span class="line">  STEPS&#x3D;&quot;00-default-ssh-config 01-cluster-bootstrap-os 02-cluster-etcd 03-cluster-kubernetes 04-cluster-network 05-cluster-apps&quot;</span><br><span class="line">  for step in $&#123;STEPS&#125;; do</span><br><span class="line">    if ! grep -q &quot;$&#123;step&#125;&quot; $&#123;INSTALL_STEPS_FILE&#125;; then</span><br><span class="line">      infolog &quot;start deploy $&#123;step&#125;&quot;</span><br><span class="line">      if ansible-playbook $&#123;ANSIBLE_ARGS&#125; $&#123;KUBE_ROOT&#125;&#x2F;playbooks&#x2F;$&#123;step&#125;.yml; then</span><br><span class="line">        echo $&#123;step&#125; &gt;&gt; $&#123;INSTALL_STEPS_FILE&#125;</span><br><span class="line">        infolog &quot;$&#123;step&#125; successfully installed&quot;</span><br><span class="line">      else</span><br><span class="line">        errorlog &quot;$&#123;step&#125; installation failed&quot;</span><br><span class="line">        exit 1</span><br><span class="line">      fi</span><br><span class="line">    else</span><br><span class="line">      warnlog &quot;$&#123;step&#125; is already installed, so skipped...&quot;</span><br><span class="line">    fi</span><br><span class="line">  done</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3><span id="æ–‡ä»¶å’Œé•œåƒ">æ–‡ä»¶å’Œé•œåƒ</span></h3>
<p>æˆ‘ä»¬éœ€è¦æå–å‡º kubespray éƒ¨ç½²çš„æ—¶å€™ä¾èµ–çš„æ–‡ä»¶å’Œé•œåƒï¼Œç”Ÿæˆä¸€ä¸ªæ–‡ä»¶åˆ—è¡¨å’Œé•œåƒåˆ—è¡¨ï¼Œç„¶åæ ¹æ®è¿™äº›åˆ—è¡¨ä¸‹è½½å¹¶æ„å»ºåˆ°ä¸€ä¸ªé•œåƒé‡Œã€‚</p>
<ul>
<li>æ–‡ä»¶</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># Download URLs</span><br><span class="line">kubelet_download_url: &quot;&#123;&#123; download_url &#125;&#125;&#x2F;storage.googleapis.com&#x2F;kubernetes-release&#x2F;release&#x2F;&#123;&#123; kube_version &#125;&#125;&#x2F;bin&#x2F;linux&#x2F;&#123;&#123; image_arch &#125;&#125;&#x2F;kubelet&quot;</span><br><span class="line">kubectl_download_url: &quot;&#123;&#123; download_url &#125;&#125;&#x2F;storage.googleapis.com&#x2F;kubernetes-release&#x2F;release&#x2F;&#123;&#123; kube_version &#125;&#125;&#x2F;bin&#x2F;linux&#x2F;&#123;&#123; image_arch &#125;&#125;&#x2F;kubectl&quot;</span><br><span class="line">kubeadm_download_url: &quot;&#123;&#123; download_url &#125;&#125;&#x2F;storage.googleapis.com&#x2F;kubernetes-release&#x2F;release&#x2F;&#123;&#123; kube_version &#125;&#125;&#x2F;bin&#x2F;linux&#x2F;&#123;&#123; image_arch &#125;&#125;&#x2F;kubeadm&quot;</span><br><span class="line">etcd_download_url: &quot;&#123;&#123; download_url &#125;&#125;&#x2F;github.com&#x2F;coreos&#x2F;etcd&#x2F;releases&#x2F;download&#x2F;&#123;&#123; etcd_version &#125;&#125;&#x2F;etcd-&#123;&#123; etcd_version &#125;&#125;-linux-&#123;&#123; image_arch &#125;&#125;.tar.gz&quot;</span><br><span class="line">cni_download_url: &quot;&#123;&#123; download_url &#125;&#125;&#x2F;github.com&#x2F;containernetworking&#x2F;plugins&#x2F;releases&#x2F;download&#x2F;&#123;&#123; cni_version &#125;&#125;&#x2F;cni-plugins-linux-&#123;&#123; image_arch &#125;&#125;-&#123;&#123; cni_version &#125;&#125;.tgz&quot;</span><br><span class="line">calicoctl_download_url: &quot;&#123;&#123; download_url &#125;&#125;&#x2F;github.com&#x2F;projectcalico&#x2F;calicoctl&#x2F;releases&#x2F;download&#x2F;&#123;&#123; calico_ctl_version &#125;&#125;&#x2F;calicoctl-linux-&#123;&#123; image_arch &#125;&#125;&quot;</span><br><span class="line">calico_crds_download_url: &quot;&#123;&#123; download_url &#125;&#125;&#x2F;github.com&#x2F;projectcalico&#x2F;calico&#x2F;archive&#x2F;&#123;&#123; calico_version &#125;&#125;.tar.gz&quot;</span><br><span class="line">crictl_download_url: &quot;&#123;&#123; download_url &#125;&#125;&#x2F;github.com&#x2F;kubernetes-sigs&#x2F;cri-tools&#x2F;releases&#x2F;download&#x2F;&#123;&#123; crictl_version &#125;&#125;&#x2F;crictl-&#123;&#123; crictl_version &#125;&#125;-&#123;&#123; ansible_system | lower &#125;&#125;-&#123;&#123; image_arch &#125;&#125;.tar.gz&quot;</span><br><span class="line">helm_download_url: &quot;&#123;&#123; download_url &#125;&#125;&#x2F;get.helm.sh&#x2F;helm-&#123;&#123; helm_version &#125;&#125;-linux-&#123;&#123; image_arch &#125;&#125;.tar.gz&quot;</span><br><span class="line">nerdctl_download_url: &quot;&#123;&#123; download_url &#125;&#125;&#x2F;github.com&#x2F;containerd&#x2F;nerdctl&#x2F;releases&#x2F;download&#x2F;v&#123;&#123; nerdctl_version &#125;&#125;&#x2F;nerdctl-&#123;&#123; nerdctl_version &#125;&#125;-&#123;&#123; ansible_system | lower &#125;&#125;-&#123;&#123; image_arch &#125;&#125;.tar.gz&quot;</span><br><span class="line">patched_kubeadm_download_url: &quot;&#123;&#123; download_url &#125;&#125;&#x2F;github.com&#x2F;k8sli&#x2F;kubernetes&#x2F;releases&#x2F;download&#x2F;&#123;&#123; kubeadm_patch_version &#125;&#125;&#x2F;kubeadm-linux-&#123;&#123; image_arch &#125;&#125;&quot;</span><br></pre></td></tr></table></figure>
<p>åœ¨æ„å»ºå®‰è£…åŒ…çš„æ—¶å€™ï¼Œå°† download_url å˜é‡è®¾ç½®ä¸º <code>https://</code> ï¼Œåœ¨éƒ¨ç½²çš„æ—¶å€™å°† <code>download_url</code> è®¾ç½®ä¸ºå†…ç½‘ æ–‡ä»¶æœåŠ¡å™¨æœåŠ¡å™¨çš„ URLï¼Œæ¯”å¦‚ <code>https://172.20.0.25:8080/files</code>ï¼Œè¿™æ ·å°±å¯ä»¥å®ç°æ–‡ä»¶æ„å»ºå’Œéƒ¨ç½²ä½¿ç”¨çš„ç»Ÿä¸€ï¼ŒèŠ‚çœç»´æŠ¤æˆæœ¬ã€‚</p>
<ul>
<li>é•œåƒ</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"># Define image repo and tag overwrite role&#x2F;download&#x2F;default&#x2F;main.yml</span><br><span class="line">pod_infra_image_tag: &quot;&#123;&#123; pod_infra_version &#125;&#125;&quot;</span><br><span class="line">pod_infra_image_repo: &quot;&#123;&#123; kube_image_repo &#125;&#125;&#x2F;pause&quot;</span><br><span class="line"></span><br><span class="line">kube_proxy_image_repo: &quot;&#123;&#123; kube_image_repo &#125;&#125;&#x2F;kube-proxy&quot;</span><br><span class="line">kube_apiserver_image_repo: &quot;&#123;&#123; kube_image_repo &#125;&#125;&#x2F;kube-apiserver&quot;</span><br><span class="line">kube_scheduler_image_repo: &quot;&#123;&#123; kube_image_repo &#125;&#125;&#x2F;kube-scheduler&quot;</span><br><span class="line">kube_controller_manager_image_repo: &quot;&#123;&#123; kube_image_repo &#125;&#125;&#x2F;kube-controller-manager&quot;</span><br><span class="line"></span><br><span class="line">coredns_image_tag: &quot;&#123;&#123; coredns_version &#125;&#125;&quot;</span><br><span class="line">dnsautoscaler_image_tag: &quot;&#123;&#123; dnsautoscaler_version &#125;&#125;&quot;</span><br><span class="line">coredns_image_repo: &quot;&#123;&#123; docker_image_repo &#125;&#125;&#x2F;coredns&quot;</span><br><span class="line">dnsautoscaler_image_repo: &quot;&#123;&#123; kube_image_repo &#125;&#125;&#x2F;cluster-proportional-autoscaler-&#123;&#123; image_arch &#125;&#125;&quot;</span><br><span class="line"></span><br><span class="line"># Full image name for generate images list</span><br><span class="line">kube_proxy_image_name: &quot;&#123;&#123; kube_proxy_image_repo &#125;&#125;:&#123;&#123; kube_version &#125;&#125;&quot;</span><br><span class="line">kube_apiserver_image_name: &quot;&#123;&#123; kube_apiserver_image_repo &#125;&#125;:&#123;&#123; kube_version &#125;&#125;&quot;</span><br><span class="line">kube_scheduler_image_name: &quot;&#123;&#123; kube_scheduler_image_repo &#125;&#125;:&#123;&#123; kube_version &#125;&#125;&quot;</span><br><span class="line">kube_controller_manager_image_name: &quot;&#123;&#123; kube_controller_manager_image_repo &#125;&#125;:&#123;&#123; kube_version &#125;&#125;&quot;</span><br><span class="line">coredns_image_name: &quot;&#123;&#123; coredns_image_repo &#125;&#125;:&#123;&#123; coredns_image_tag &#125;&#125;&quot;</span><br><span class="line">dnsautoscaler_image_name: &quot;&#123;&#123; dnsautoscaler_image_repo &#125;&#125;:&#123;&#123; dnsautoscaler_image_tag &#125;&#125;&quot;</span><br><span class="line">nginx_image_name: &quot;&#123;&#123; nginx_image_repo &#125;&#125;:&#123;&#123; nginx_image_tag &#125;&#125;&quot;</span><br><span class="line">pod_infra_image_name: &quot;&#123;&#123; pod_infra_image_repo &#125;&#125;:&#123;&#123; pod_infra_image_tag &#125;&#125;&quot;</span><br><span class="line">calico_policy_image_name: &quot;&#123;&#123; calico_policy_image_repo &#125;&#125;:&#123;&#123; calico_policy_image_tag &#125;&#125;&quot;</span><br><span class="line">calico_cni_image_name: &quot;&#123;&#123; calico_cni_image_repo &#125;&#125;:&#123;&#123; calico_cni_image_tag &#125;&#125;&quot;</span><br><span class="line">calico_node_image_name: &quot;&#123;&#123; calico_node_image_repo &#125;&#125;:&#123;&#123; calico_node_image_tag &#125;&#125;&quot;</span><br><span class="line">flannel_image_name: &quot;&#123;&#123; flannel_image_repo &#125;&#125;:&#123;&#123; flannel_image_tag &#125;&#125;&quot;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>generate.sh</code> åˆ—è¡¨ç”Ÿæˆè„šæœ¬</li>
</ul>
<p>æˆ‘ä»¬æ ¹æ®ä¸Šé¢ group_vars ä¸­å®šä¹‰çš„ç‰ˆæœ¬å·å’Œä¸€äº›å‚æ•°ï¼Œä½¿ç”¨è„šæœ¬çš„æ–¹å¼è‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªæ–‡ä»¶åˆ—è¡¨å’Œé•œåƒåˆ—è¡¨ï¼Œæ„å»ºçš„æ—¶å€™æ ¹æ®è¿™äº›åˆ—è¡¨æ¥ä¸‹è½½æ‰€éœ€è¦çš„æ–‡ä»¶å’Œé•œåƒã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">set -eo pipefail</span><br><span class="line"></span><br><span class="line">SCRIPT_PATH&#x3D;$(cd $(dirname $0); pwd)</span><br><span class="line">REPO_PATH&#x3D;&quot;$&#123;SCRIPT_PATH%&#x2F;build&#125;&quot;</span><br><span class="line"></span><br><span class="line">: $&#123;IMAGE_ARCH:&#x3D;&quot;amd64&quot;&#125;</span><br><span class="line">: $&#123;ANSIBLE_ARCHITECTURE:&#x3D;&quot;x86_64&quot;&#125;</span><br><span class="line">: $&#123;DOWNLOAD_YML:&#x3D;&quot;config&#x2F;group_vars&#x2F;all&#x2F;download.yml&quot;&#125;</span><br><span class="line"></span><br><span class="line"># ARCH used in convert &#123;%- if image_arch !&#x3D; &#39;amd64&#39; -%&#125;-&#123;&#123; image_arch &#125;&#125;&#123;%- endif -%&#125; to &#123;&#123;arch&#125;&#125;</span><br><span class="line">if [[ &quot;$&#123;IMAGE_ARCH&#125;&quot; !&#x3D; &quot;amd64&quot; ]]; then ARCH&#x3D;&quot;-$&#123;IMAGE_ARCH&#125;&quot;; fi</span><br><span class="line"></span><br><span class="line">cat &gt; &#x2F;tmp&#x2F;generate.sh &lt;&lt; EOF</span><br><span class="line">arch&#x3D;$&#123;ARCH&#125;</span><br><span class="line">download_url&#x3D;https:&#x2F;</span><br><span class="line">image_arch&#x3D;$&#123;IMAGE_ARCH&#125;</span><br><span class="line">ansible_system&#x3D;linux</span><br><span class="line">ansible_architecture&#x3D;$&#123;ANSIBLE_ARCHITECTURE&#125;</span><br><span class="line">registry_project&#x3D;library</span><br><span class="line">registry_domain&#x3D;localhost</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"># generate all component version by $DOWNLOAD_YML</span><br><span class="line">grep &#39;_version:&#39; $&#123;REPO_PATH&#125;&#x2F;$&#123;DOWNLOAD_YML&#125; \</span><br><span class="line">| sed &#39;s&#x2F;: &#x2F;&#x3D;&#x2F;g;s&#x2F;&#123;&#123;&#x2F;$&#123;&#x2F;g;s&#x2F;&#125;&#125;&#x2F;&#125;&#x2F;g&#39; | tr -d &#39; &#39; &gt;&gt; &#x2F;tmp&#x2F;generate.sh</span><br><span class="line"></span><br><span class="line"># generate download files url list</span><br><span class="line">grep &#39;_download_url:&#39; $&#123;REPO_PATH&#125;&#x2F;$&#123;DOWNLOAD_YML&#125; \</span><br><span class="line">| sed &#39;s&#x2F;: &#x2F;&#x3D;&#x2F;g;s&#x2F; &#x2F;&#x2F;g;s&#x2F;&#123;&#123;&#x2F;$&#123;&#x2F;g;s&#x2F;&#125;&#125;&#x2F;&#125;&#x2F;g;s&#x2F;|lower&#x2F;&#x2F;g;s&#x2F;^.*_url&#x3D;&#x2F;echo &#x2F;g&#39; &gt;&gt; &#x2F;tmp&#x2F;generate.sh</span><br><span class="line"></span><br><span class="line"># generate download images list</span><br><span class="line">grep -E &#39;_image_tag:|_image_repo:|_image_name:&#39; $&#123;REPO_PATH&#125;&#x2F;$&#123;DOWNLOAD_YML&#125; \</span><br><span class="line">| sed &quot;s#&#123;%- if image_arch !&#x3D; &#39;amd64&#39; -%&#125;-&#123;&#123; image_arch &#125;&#125;&#123;%- endif -%&#125;#&#123;&#123;arch&#125;&#125;#g&quot; \</span><br><span class="line">| sed &#39;s&#x2F;: &#x2F;&#x3D;&#x2F;g;s&#x2F;&#123;&#123;&#x2F;$&#123;&#x2F;g;s&#x2F;&#125;&#125;&#x2F;&#125;&#x2F;g&#39; | tr -d &#39; &#39; &gt;&gt; &#x2F;tmp&#x2F;generate.sh</span><br><span class="line"></span><br><span class="line">grep &#39;_image_name:&#39; $&#123;REPO_PATH&#125;&#x2F;$&#123;DOWNLOAD_YML&#125; \</span><br><span class="line">| cut -d &#39;:&#39; -f1 | sed &#39;s&#x2F;^&#x2F;echo $&#x2F;g&#39; &gt;&gt; &#x2F;tmp&#x2F;generate.sh</span><br></pre></td></tr></table></figure>
<p>ä¸ºäº†åŒæ—¶æ”¯æŒ amd64 å’Œ arm64 çš„ CPU æ¶æ„ï¼Œéœ€è¦ä¸ºä¸¤ç§æ¶æ„å„è‡ªç”Ÿæˆåˆ—è¡¨ï¼Œéœ€è¦ç‰¹æ®Šå¤„ç†ä¸€ä¸‹ã€‚åœ¨è¿™é‡Œè¸©çš„ä¸€ä¸ªå‘å°±æ˜¯ä¸åŒçš„ç»„ä»¶é•œåƒçš„å‘½åæ–¹æ³•åƒå·®ä¸‡åˆ«ï¼Œå¤§è‡´å¯ä»¥åˆ†ä¸ºå¦‚ä¸‹å››ç§æƒ…å†µï¼š</p>
<ul>
<li>åƒ kube-apiserver è¿™äº› k8s ç»„ä»¶çš„é•œåƒï¼Œé•œåƒåç§°å’Œé•œåƒ tag æ˜¯ä¸éœ€è¦åŠ ä¸Š CPU ä½“ç³»æ¶æ„çš„ï¼›</li>
<li>cluster-proportional-autoscaler çš„é•œåƒåˆ™æ˜¯åœ¨é•œåƒçš„åç§°åé¢åŠ ä¸Šäº† CPU ä½“ç³»æ¶æ„çš„åç§°å¦‚ cluster-proportional-autoscaler-amd64ï¼Œcluster-proportional-autoscaler-arm64ï¼›</li>
<li>flannel åˆ™æ˜¯å°† CPU ä½“ç³»æ¶æ„åç§°å®šä¹‰åœ¨é•œåƒ tag åé¢æ¯”å¦‚ <code>flannel:v0.14.0-amd64</code>ï¼›</li>
<li>è¿˜æœ‰ calico æ›´å¥‡è‘©ï¼Œamd64 æ¶æ„çš„é•œåƒä¸éœ€è¦åŠ ä½“ç³»æ¶æ„çš„åç§°å¦‚ <code>calico/cni:v3.18.4</code>ï¼Œè€Œ arm64 çš„åˆ™å¿…é¡»è¦åœ¨é•œåƒ tag åé¢å¸¦ä¸Š CPU ä½“ç³»æ¶æ„æ¯”å¦‚ <code>calico/cni:v3.18.4-arm64</code>ï¼›</li>
</ul>
<p>åœ¨è¿™é‡Œéœ€è¦å¼ºè°ƒä¸€ä¸‹ï¼Œæ–‡ä»¶åˆ—è¡¨å’Œé•œåƒåˆ—è¡¨ä¸€å®šè¦ä½¿ç”¨è‡ªåŠ¨åŒ–çš„æ–¹å¼æ¥ç®¡ç†ï¼Œåˆ‡å‹¿æ‰‹åŠ¨æ›´æ–°ï¼Œè¿™æ ·èƒ½èŠ‚çœå¤§é‡çš„ç»´æŠ¤æˆæœ¬ï¼Œä¸ç„¶çš„è¯æ¯æ¬¡éƒ½æ‰‹åŠ¨å»æ›´æ–°è¿™äº›åˆ—è¡¨æˆæœ¬å®åœ¨æ˜¯å¤ªé«˜äº†ï¼Œè€Œä¸”ç‰¹åˆ«å®¹æ˜“å‡ºå‡ºé”™æˆ–è€…é—æ¼æŸä¸ªç»„ä»¶ã€‚</p>
<h3><span id="kubespray-files">kubespray-files</span></h3>
<p>æˆ‘ä»¬å°† kubespray éƒ¨ç½²æ‰€ä¾èµ–çš„äºŒè¿›åˆ¶æ–‡ä»¶æ„å»ºåœ¨ä¸€ä¸ªåä¸º kubespray-files çš„é•œåƒå½“ä¸­ï¼š</p>
<ul>
<li>ç”Ÿæˆçš„æ–‡ä»¶åˆ—è¡¨</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;get.helm.sh&#x2F;helm-v3.6.3-linux-amd64.tar.gz</span><br><span class="line">https:&#x2F;&#x2F;github.com&#x2F;containerd&#x2F;nerdctl&#x2F;releases&#x2F;download&#x2F;v0.8.1&#x2F;nerdctl-0.8.1-linux-amd64.tar.gz</span><br><span class="line">https:&#x2F;&#x2F;github.com&#x2F;containernetworking&#x2F;plugins&#x2F;releases&#x2F;download&#x2F;v0.9.1&#x2F;cni-plugins-linux-amd64-v0.9.1.tgz</span><br><span class="line">https:&#x2F;&#x2F;github.com&#x2F;coreos&#x2F;etcd&#x2F;releases&#x2F;download&#x2F;v3.4.13&#x2F;etcd-v3.4.13-linux-amd64.tar.gz</span><br><span class="line">https:&#x2F;&#x2F;github.com&#x2F;k8sli&#x2F;kubernetes&#x2F;releases&#x2F;download&#x2F;v1.21.3-patch-1.0&#x2F;kubeadm-linux-amd64</span><br><span class="line">https:&#x2F;&#x2F;github.com&#x2F;kubernetes-sigs&#x2F;cri-tools&#x2F;releases&#x2F;download&#x2F;v1.21.0&#x2F;crictl-v1.21.0-linux-amd64.tar.gz</span><br><span class="line">https:&#x2F;&#x2F;github.com&#x2F;projectcalico&#x2F;calico&#x2F;archive&#x2F;v3.18.4.tar.gz</span><br><span class="line">https:&#x2F;&#x2F;github.com&#x2F;projectcalico&#x2F;calicoctl&#x2F;releases&#x2F;download&#x2F;v3.18.4&#x2F;calicoctl-linux-amd64</span><br><span class="line">https:&#x2F;&#x2F;storage.googleapis.com&#x2F;kubernetes-release&#x2F;release&#x2F;v1.21.3&#x2F;bin&#x2F;linux&#x2F;amd64&#x2F;kubeadm</span><br><span class="line">https:&#x2F;&#x2F;storage.googleapis.com&#x2F;kubernetes-release&#x2F;release&#x2F;v1.21.3&#x2F;bin&#x2F;linux&#x2F;amd64&#x2F;kubectl</span><br><span class="line">https:&#x2F;&#x2F;storage.googleapis.com&#x2F;kubernetes-release&#x2F;release&#x2F;v1.21.3&#x2F;bin&#x2F;linux&#x2F;amd64&#x2F;kubelet</span><br></pre></td></tr></table></figure>
<ul>
<li>Dockerfile</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">FROM alpine:latest as files</span><br><span class="line">RUN apk --no-cache add wget ca-certificates</span><br><span class="line">WORKDIR &#x2F;build</span><br><span class="line">COPY build&#x2F;kubespray-files&#x2F;files_*.list &#x2F;build&#x2F;</span><br><span class="line">RUN ARCH&#x3D;$(uname -m | sed &#39;s&#x2F;x86_64&#x2F;amd64&#x2F;;s&#x2F;aarch64&#x2F;arm64&#x2F;&#39;) \</span><br><span class="line">    &amp;&amp; sed &#39;&#x2F;#&#x2F;d&#39; *$&#123;ARCH&#125;.list &gt; all_files.list \</span><br><span class="line">    &amp;&amp; wget -q -x -P &#x2F;files -i all_files.list</span><br><span class="line"></span><br><span class="line">FROM scratch</span><br><span class="line">COPY --from&#x3D;files &#x2F;files &#x2F;files</span><br></pre></td></tr></table></figure>
<ul>
<li>æ„å»ºåçš„ç›®å½•ç»“æ„ï¼Œé€šè¿‡ç›®å½•å±‚çº§çš„æ–¹å¼ä¿ç•™åŸæœ‰çš„ URL åœ°å€ï¼Œç»´æŠ¤å’Œä½¿ç”¨èµ·æ¥æ¯”è¾ƒæ–¹ä¾¿</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">files&#x2F;</span><br><span class="line">â”œâ”€â”€ get.helm.sh</span><br><span class="line">â”‚   â””â”€â”€ helm-v3.6.3-linux-amd64.tar.gz</span><br><span class="line">â”œâ”€â”€ github.com</span><br><span class="line">â”‚   â”œâ”€â”€ containerd</span><br><span class="line">â”‚   â”‚   â””â”€â”€ nerdctl</span><br><span class="line">â”‚   â”‚       â””â”€â”€ releases</span><br><span class="line">â”‚   â”‚           â””â”€â”€ download</span><br><span class="line">â”‚   â”‚               â””â”€â”€ v0.8.1</span><br><span class="line">â”‚   â”‚                   â””â”€â”€ nerdctl-0.8.1-linux-amd64.tar.gz</span><br><span class="line">â”‚   â”œâ”€â”€ containernetworking</span><br><span class="line">â”‚   â”‚   â””â”€â”€ plugins</span><br><span class="line">â”‚   â”‚       â””â”€â”€ releases</span><br><span class="line">â”‚   â”‚           â””â”€â”€ download</span><br><span class="line">â”‚   â”‚               â””â”€â”€ v0.9.1</span><br><span class="line">â”‚   â”‚                   â””â”€â”€ cni-plugins-linux-amd64-v0.9.1.tgz</span><br><span class="line">â”‚   â”œâ”€â”€ coreos</span><br><span class="line">â”‚   â”‚   â””â”€â”€ etcd</span><br><span class="line">â”‚   â”‚       â””â”€â”€ releases</span><br><span class="line">â”‚   â”‚           â””â”€â”€ download</span><br><span class="line">â”‚   â”‚               â””â”€â”€ v3.4.13</span><br><span class="line">â”‚   â”‚                   â””â”€â”€ etcd-v3.4.13-linux-amd64.tar.gz</span><br><span class="line">â”‚   â”œâ”€â”€ k8sli</span><br><span class="line">â”‚   â”‚   â””â”€â”€ kubernetes</span><br><span class="line">â”‚   â”‚       â””â”€â”€ releases</span><br><span class="line">â”‚   â”‚           â””â”€â”€ download</span><br><span class="line">â”‚   â”‚               â””â”€â”€ v1.21.3-patch-1.0</span><br><span class="line">â”‚   â”‚                   â””â”€â”€ kubeadm-linux-amd64</span><br><span class="line">â”‚   â”œâ”€â”€ kubernetes-sigs</span><br><span class="line">â”‚   â”‚   â””â”€â”€ cri-tools</span><br><span class="line">â”‚   â”‚       â””â”€â”€ releases</span><br><span class="line">â”‚   â”‚           â””â”€â”€ download</span><br><span class="line">â”‚   â”‚               â””â”€â”€ v1.21.0</span><br><span class="line">â”‚   â”‚                   â””â”€â”€ crictl-v1.21.0-linux-amd64.tar.gz</span><br><span class="line">â”‚   â””â”€â”€ projectcalico</span><br><span class="line">â”‚       â”œâ”€â”€ calico</span><br><span class="line">â”‚       â”‚   â””â”€â”€ archive</span><br><span class="line">â”‚       â”‚       â””â”€â”€ v3.18.4.tar.gz</span><br><span class="line">â”‚       â””â”€â”€ calicoctl</span><br><span class="line">â”‚           â””â”€â”€ releases</span><br><span class="line">â”‚               â””â”€â”€ download</span><br><span class="line">â”‚                   â””â”€â”€ v3.18.4</span><br><span class="line">â”‚                       â””â”€â”€ calicoctl-linux-amd64</span><br><span class="line">â””â”€â”€ storage.googleapis.com</span><br><span class="line">    â””â”€â”€ kubernetes-release</span><br><span class="line">        â””â”€â”€ release</span><br><span class="line">            â””â”€â”€ v1.21.3</span><br><span class="line">                â””â”€â”€ bin</span><br><span class="line">                    â””â”€â”€ linux</span><br><span class="line">                        â””â”€â”€ amd64</span><br><span class="line">                            â”œâ”€â”€ kubeadm</span><br><span class="line">                            â”œâ”€â”€ kubectl</span><br><span class="line">                            â””â”€â”€ kubelet</span><br></pre></td></tr></table></figure>
<h3><span id="kubespray-images">kubespray-images</span></h3>
<p>æˆ‘ä»¬åŒæ ·å°† kubespray éƒ¨ç½²æ‰€éœ€è¦çš„ç»„ä»¶é•œåƒæ„å»ºåœ¨ä¸€ä¸ªåä¸º kubespray-images çš„é•œåƒå½“ä¸­ï¼š</p>
<ul>
<li>é•œåƒåˆ—è¡¨</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">library&#x2F;calico-cni:v3.18.4</span><br><span class="line">library&#x2F;calico-kube-controllers:v3.18.4</span><br><span class="line">library&#x2F;calico-node:v3.18.4</span><br><span class="line">library&#x2F;calico-pod2daemon-flexvol:v3.18.4</span><br><span class="line">library&#x2F;cluster-proportional-autoscaler-amd64:1.8.3</span><br><span class="line">library&#x2F;coredns:v1.8.0</span><br><span class="line">library&#x2F;flannel:v0.14.0-amd64</span><br><span class="line">library&#x2F;kube-apiserver:v1.21.3</span><br><span class="line">library&#x2F;kube-controller-manager:v1.21.3</span><br><span class="line">library&#x2F;kube-proxy:v1.21.3</span><br><span class="line">library&#x2F;kube-scheduler:v1.21.3</span><br><span class="line">library&#x2F;nginx:1.19</span><br><span class="line">library&#x2F;pause:3.3</span><br></pre></td></tr></table></figure>
<ul>
<li>Dockerfile</li>
</ul>
<p>åœ¨ Dockerfile é‡Œå®Œæˆæ‰€æœ‰é•œåƒçš„ä¸‹è½½ï¼Œå¹¶ä½¿ç”¨ ã€Š<a href="https://blog.k8s.li/skopeo-to-registry.html" target="_blank" rel="noopener">å¦‚ä½•ä½¿ç”¨ registry å­˜å‚¨çš„ç‰¹æ€§</a>ã€‹æ–‡ä¸­æåˆ°çš„éªšæ“ä½œï¼Œåˆ©ç”¨ registry å­˜å‚¨å¤ç”¨ç›¸åŒ layer çš„ç‰¹æ€§ï¼Œå°† skopeo sync ä¸‹è½½çš„é•œåƒè½¬æ¢æˆ registry å­˜å‚¨çš„ç»“æ„ã€‚è¿™æ ·åœ¨éƒ¨ç½²çš„æ—¶å€™ç›´æ¥æŠŠè¿™ä¸ª registry å­˜å‚¨ç›®å½•æŒ‚è½½è¿› registry å®¹å™¨çš„ <code>/var/lib/registry</code> å³å¯ã€‚ç‰¹ç‚¹æ˜¯æ€§èƒ½æ–¹é¢æ— è®ºæ˜¯æ„å»ºå’Œéƒ¨ç½²ï¼Œéƒ½æ¯”å¸¸è§„ä½¿ç”¨ docker save å’Œ docker load çš„æ–¹å¼è¦å¿«è‡³å°‘ 5 åˆ° 10 å€ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">FROM alpine:3.12 as images</span><br><span class="line">ARG SKOPEO_VERSION&#x3D;v1.4.0</span><br><span class="line">ARG YQ_VERSION&#x3D;v4.11.2</span><br><span class="line">RUN ARCH&#x3D;$(uname -m | sed &#39;s&#x2F;x86_64&#x2F;amd64&#x2F;;s&#x2F;aarch64&#x2F;arm64&#x2F;&#39;) \</span><br><span class="line">    &amp;&amp; apk --no-cache add bash wget ca-certificates \</span><br><span class="line">    &amp;&amp; wget -q -k https:&#x2F;&#x2F;github.com&#x2F;mikefarah&#x2F;yq&#x2F;releases&#x2F;download&#x2F;$&#123;YQ_VERSION&#125;&#x2F;yq_linux_$&#123;ARCH&#125; -O &#x2F;usr&#x2F;local&#x2F;bin&#x2F;yq \</span><br><span class="line">    &amp;&amp; wget -q -k https:&#x2F;&#x2F;github.com&#x2F;k8sli&#x2F;skopeo&#x2F;releases&#x2F;download&#x2F;$&#123;SKOPEO_VERSION&#125;&#x2F;skopeo-linux-$&#123;ARCH&#125; -O &#x2F;usr&#x2F;local&#x2F;bin&#x2F;skopeo \</span><br><span class="line">    &amp;&amp; chmod a+x &#x2F;usr&#x2F;local&#x2F;bin&#x2F;*</span><br><span class="line"></span><br><span class="line">WORKDIR &#x2F;build</span><br><span class="line">COPY build&#x2F;kubespray-images&#x2F;*  &#x2F;build&#x2F;</span><br><span class="line">RUN ARCH&#x3D;$(uname -m | sed &#39;s&#x2F;x86_64&#x2F;amd64&#x2F;;s&#x2F;aarch64&#x2F;arm64&#x2F;&#39;) \</span><br><span class="line">    &amp;&amp; IMAGE_ARCH&#x3D;$&#123;ARCH&#125; bash build.sh</span><br><span class="line"></span><br><span class="line">FROM scratch</span><br><span class="line">COPY --from&#x3D;images &#x2F;build&#x2F;docker &#x2F;docker</span><br></pre></td></tr></table></figure>
<ul>
<li>images_origin.yaml é•œåƒé…ç½®æ–‡ä»¶</li>
</ul>
<p>è€ƒè™‘åˆ°æœ‰å°†é•œåƒå¯¼å…¥åˆ°å·²ç»å­˜åœ¨çš„é•œåƒä»“åº“ä¸­çš„åœºæ™¯ï¼Œè¿™é‡Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹ä¸€ä¸‹é•œåƒä»“åº“çš„ repoã€‚å› ä¸º <code>library</code> è¿™ä¸ª repo åœ¨ harbor ä¸­æ˜¯é»˜è®¤è‡ªå¸¦çš„ï¼Œåœ¨å¯¼å…¥åˆ° harbor çš„è¿‡ç¨‹ä¸­ä¹Ÿä¸éœ€è¦åˆ›å»ºä¸€äº›é¢å¤–çš„ project ï¼Œæ‰€ä»¥å°†æ‰€æœ‰é•œåƒçš„ repo å…¨éƒ¨ç»Ÿä¸€ä¸º <code>library</code> æ›´é€šç”¨ä¸€äº›ã€‚</p>
<p>è¿™é‡Œç”¨ä¸€ä¸ª yaml é…ç½®æ–‡ä»¶æ¥è®°å½•åŸé•œåƒåœ°å€å’Œ library é•œåƒçš„åœ°å€çš„å¯¹åº”å…³ç³»ã€‚æ¯”å¦‚ä¸Šæ¸¸çš„ <code>k8s.gcr.io/kube-apiserver</code> æ˜ å°„ä¸º <code>library/kube-apiserver</code>ï¼Œ <code>quay.io/calico/node</code> æ˜ å°„ä¸º <code>library/calico-node</code>ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line"># kubeadm core images</span><br><span class="line">- src: k8s.gcr.io&#x2F;kube-apiserver</span><br><span class="line">  dest: library&#x2F;kube-apiserver</span><br><span class="line">- src: k8s.gcr.io&#x2F;kube-controller-manager</span><br><span class="line">  dest: library&#x2F;kube-controller-manager</span><br><span class="line">- src: k8s.gcr.io&#x2F;kube-proxy</span><br><span class="line">  dest: library&#x2F;kube-proxy</span><br><span class="line">- src: k8s.gcr.io&#x2F;kube-scheduler</span><br><span class="line">  dest: library&#x2F;kube-scheduler</span><br><span class="line">- src: k8s.gcr.io&#x2F;coredns&#x2F;coredns</span><br><span class="line">  dest: library&#x2F;coredns</span><br><span class="line">- src: k8s.gcr.io&#x2F;pause</span><br><span class="line">  dest: library&#x2F;pause</span><br><span class="line"></span><br><span class="line"># kubernetes addons</span><br><span class="line">- src: k8s.gcr.io&#x2F;dns&#x2F;k8s-dns-node-cache</span><br><span class="line">  dest: library&#x2F;k8s-dns-node-cache</span><br><span class="line">- src: k8s.gcr.io&#x2F;cpa&#x2F;cluster-proportional-autoscaler-amd64</span><br><span class="line">  dest: library&#x2F;cluster-proportional-autoscaler-amd64</span><br><span class="line">- src: k8s.gcr.io&#x2F;cpa&#x2F;cluster-proportional-autoscaler-arm64</span><br><span class="line">  dest: library&#x2F;cluster-proportional-autoscaler-arm64</span><br><span class="line"></span><br><span class="line"># network plugin</span><br><span class="line">- src: quay.io&#x2F;calico&#x2F;cni</span><br><span class="line">  dest: library&#x2F;calico-cni</span><br><span class="line">- src: quay.io&#x2F;calico&#x2F;node</span><br><span class="line">  dest: library&#x2F;calico-node</span><br><span class="line">- src: quay.io&#x2F;calico&#x2F;kube-controllers</span><br><span class="line">  dest: library&#x2F;calico-kube-controllers</span><br><span class="line">- src: quay.io&#x2F;calico&#x2F;pod2daemon-flexvol</span><br><span class="line">  dest: library&#x2F;calico-pod2daemon-flexvol</span><br><span class="line"></span><br><span class="line">- src: quay.io&#x2F;calico&#x2F;typha</span><br><span class="line">  dest: library&#x2F;calico-typha</span><br><span class="line">- src: quay.io&#x2F;coreos&#x2F;flannel</span><br><span class="line">  dest: library&#x2F;flannel</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># nginx for daemonset and offline</span><br><span class="line">- src: docker.io&#x2F;library&#x2F;nginx</span><br><span class="line">  dest: library&#x2F;nginx</span><br></pre></td></tr></table></figure>
<h3><span id="kubeplay">kubeplay</span></h3>
<p>kubeplay éƒ¨ç½²çš„ä»£ç ä¸»è¦æ˜¯ç”±ä¸€äº› shell è„šæœ¬å’Œé…ç½®æ–‡ä»¶æ„æˆï¼Œç”¨äºå®Œæˆ nginx æœåŠ¡å’Œ registry æœåŠ¡çš„éƒ¨ç½²ï¼Œä»¥åŠæœ€åè°ƒç”¨ kubespray æ¥å®Œæˆé›†ç¾¤éƒ¨ç½²ã€‚</p>
<blockquote>
<p>kubeplay é¡¹ç›®åœ°å€ï¼š<a href="https://github.com/k8sli/kubeplay" target="_blank" rel="noopener">https://github.com/k8sli/kubeplay</a></p>
</blockquote>
<ul>
<li>ä»£ç ç»“æ„</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">kubeplay&#x2F;</span><br><span class="line">â”œâ”€â”€ Dockerfile          # æ„å»ºå®Œæ•´å®‰è£…åŒ…çš„ Dockerfile</span><br><span class="line">â”œâ”€â”€ compose.yaml        # compose å¯åŠ¨é…ç½® yaml æ–‡ä»¶</span><br><span class="line">â”œâ”€â”€ config</span><br><span class="line">â”‚   â”œâ”€â”€ compose</span><br><span class="line">â”‚   â”‚   â””â”€â”€ nginx.conf  # nginx é…ç½®æ–‡ä»¶</span><br><span class="line">â”‚   â””â”€â”€ rootCA.cnf      # ç”Ÿæˆé•œåƒä»“åº“è¯ä¹¦ç”¨åˆ°çš„ openssl é…ç½®æ–‡ä»¶</span><br><span class="line">â”œâ”€â”€ config-sample.yaml  # ä¸»é…ç½®æ–‡ä»¶</span><br><span class="line">â”œâ”€â”€ install.sh          # å®‰è£…æ“ä½œç„¶å</span><br><span class="line">â””â”€â”€ library             # ä¸€äº› shell å‡½æ•°åº“</span><br></pre></td></tr></table></figure>
<ul>
<li>Dockerfile</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">FROM alpine:latest as downloader</span><br><span class="line">ARG SKOPEO_VERSION&#x3D;v1.4.0</span><br><span class="line">ARG YQ_VERSION&#x3D;v4.11.2</span><br><span class="line">ARG NERDCTL_VERSION&#x3D;0.11.0</span><br><span class="line">ARG NGINX_VERSION&#x3D;1.20-alpine</span><br><span class="line">ARG RERGISRRY_VERSION&#x3D;2.7.1</span><br><span class="line">ARG KUBESPRAY_VERSION&#x3D;latest</span><br><span class="line">ARG KUBESPRAY_IMAGE&#x3D;ghcr.io&#x2F;k8sli&#x2F;kubespray</span><br><span class="line"></span><br><span class="line"># ä¸‹è½½éƒ¨ç½²æ—¶éœ€è¦çš„å·¥å…·ï¼Œå¦‚ yqã€skopeoã€nerdctl-fullsss</span><br><span class="line">WORKDIR &#x2F;tools</span><br><span class="line">RUN ARCH&#x3D;$(uname -m | sed &#39;s&#x2F;x86_64&#x2F;amd64&#x2F;;s&#x2F;aarch64&#x2F;arm64&#x2F;&#39;) \</span><br><span class="line">    &amp;&amp; apk --no-cache add wget ca-certificates \</span><br><span class="line">    &amp;&amp; wget -q -k https:&#x2F;&#x2F;github.com&#x2F;mikefarah&#x2F;yq&#x2F;releases&#x2F;download&#x2F;$&#123;YQ_VERSION&#125;&#x2F;yq_linux_$&#123;ARCH&#125;  -O &#x2F;tools&#x2F;yq-linux-$&#123;ARCH&#125; \</span><br><span class="line">    &amp;&amp; wget -q -k https:&#x2F;&#x2F;github.com&#x2F;k8sli&#x2F;skopeo&#x2F;releases&#x2F;download&#x2F;v1.4.0&#x2F;skopeo-linux-$&#123;ARCH&#125; -O &#x2F;tools&#x2F;skopeo-linux-$&#123;ARCH&#125; \</span><br><span class="line">    &amp;&amp; wget -q -k https:&#x2F;&#x2F;github.com&#x2F;containerd&#x2F;nerdctl&#x2F;releases&#x2F;download&#x2F;v$&#123;NERDCTL_VERSION&#125;&#x2F;nerdctl-full-$&#123;NERDCTL_VERSION&#125;-linux-$&#123;ARCH&#125;.tar.gz \</span><br><span class="line">    &amp;&amp; chmod a+x &#x2F;tools&#x2F;* \</span><br><span class="line">    &amp;&amp; ln -s &#x2F;tools&#x2F;skopeo-linux-$&#123;ARCH&#125; &#x2F;usr&#x2F;bin&#x2F;skopeo</span><br><span class="line"></span><br><span class="line"># ä¸‹è½½ä¸€äº›é•œåƒï¼Œå¦‚ nginxã€registryã€kubespray</span><br><span class="line">WORKDIR &#x2F;images</span><br><span class="line">RUN ARCH&#x3D;$(uname -m | sed &#39;s&#x2F;x86_64&#x2F;amd64&#x2F;;s&#x2F;aarch64&#x2F;arm64&#x2F;&#39;) \</span><br><span class="line">    &amp;&amp; skopeo copy --insecure-policy --src-tls-verify&#x3D;false --override-arch $&#123;ARCH&#125; --additional-tag nginx:$&#123;NGINX_VERSION&#125; \</span><br><span class="line">       docker:&#x2F;&#x2F;docker.io&#x2F;library&#x2F;nginx:$&#123;NGINX_VERSION&#125; docker-archive:nginx-$&#123;NGINX_VERSION&#125;.tar \</span><br><span class="line">    &amp;&amp; skopeo copy --insecure-policy --src-tls-verify&#x3D;false --override-arch $&#123;ARCH&#125; --additional-tag registry:$&#123;RERGISRRY_VERSION&#125; \</span><br><span class="line">       docker:&#x2F;&#x2F;docker.io&#x2F;library&#x2F;registry:$&#123;RERGISRRY_VERSION&#125; docker-archive:registry-$&#123;RERGISRRY_VERSION&#125;.tar \</span><br><span class="line">    &amp;&amp; skopeo copy --insecure-policy --src-tls-verify&#x3D;false --override-arch $&#123;ARCH&#125; --additional-tag kubespray:$&#123;KUBESPRAY_VERSION&#125; \</span><br><span class="line">       docker:&#x2F;&#x2F;$&#123;KUBESPRAY_IMAGE&#125;:$&#123;KUBESPRAY_VERSION&#125; docker-archive:kubespray-$&#123;KUBESPRAY_VERSION&#125;.tar</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">FROM scratch</span><br><span class="line">COPY . .</span><br><span class="line"> # å°†å…¶å®ƒæ¨¡å—ä¸­çš„å†…å®¹å¤åˆ¶åˆ° scratch é•œåƒä¸­ï¼Œæ„å»ºçš„æ—¶å€™å¯¼å‡ºä¸º local æ–¹å¼</span><br><span class="line">COPY --from&#x3D;downloader &#x2F;tools &#x2F;resources&#x2F;nginx&#x2F;tools</span><br><span class="line">COPY --from&#x3D;downloader &#x2F;images &#x2F;resources&#x2F;images</span><br><span class="line">COPY --from&#x3D;$&#123;OS_PACKAGES_IMAGE&#125;:$&#123;OS_PACKAGE_REPO_TAG&#125; &#x2F; &#x2F;resources&#x2F;nginx</span><br><span class="line">COPY --from&#x3D;$&#123;KUBESPRAY_FILES_IMAGE&#125;:$&#123;KUBESPRAY_REPO_TAG&#125; &#x2F; &#x2F;resources&#x2F;nginx</span><br><span class="line">COPY --from&#x3D;$&#123;KUBESPRAY_IMAGES_IMAGE&#125;:$&#123;KUBESPRAY_REPO_TAG&#125; &#x2F; &#x2F;resources&#x2F;registry</span><br></pre></td></tr></table></figure>
<h3><span id="æ„å»º">æ„å»º</span></h3>
<p>ç”±äºæœ€ç»ˆçš„æ„å»ºæ¶‰åŠå¤šä¸ªæ¨¡å—å’Œ repoï¼Œå…¶æµç¨‹æ¯”è¾ƒå¤æ‚ï¼Œè¯¦ç»†çš„ä»£ç å¯å‚è€ƒæºç  <a href="https://github.com/k8sli/kubeplay/blob/main/.github/workflows/build.yaml" target="_blank" rel="noopener">build.yaml</a> ï¼Œåœ¨è¿™é‡Œåªè®²å‡ ä¸ªå…³é”®çš„éƒ¨åˆ†</p>
<ul>
<li>checkout repoï¼Œå°† kubespray å’Œ os-packages repo clone åˆ°å·¥ä½œç›®å½•</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">jobs:</span><br><span class="line">  build-package:</span><br><span class="line">    # ä»¥ tag çš„äº‹ä»¶è§¦å‘æ„å»ºæµæ°´çº¿</span><br><span class="line">    if: startsWith(github.ref, &#39;refs&#x2F;tags&#x2F;&#39;)</span><br><span class="line">    runs-on: ubuntu-20.04</span><br><span class="line">    steps:</span><br><span class="line">      - name: Checkout</span><br><span class="line">        uses: actions&#x2F;checkout@v2</span><br><span class="line">        with:</span><br><span class="line">          # fetch all git repo tag for define image tag</span><br><span class="line">          fetch-depth: 0</span><br><span class="line"></span><br><span class="line">      - name: Checkout kubespray repo</span><br><span class="line">        uses: actions&#x2F;checkout@v2</span><br><span class="line">        with:</span><br><span class="line">          ref: main</span><br><span class="line">          fetch-depth: 0</span><br><span class="line">          path: kubespray</span><br><span class="line">          repository: $&#123;&#123; github.repository_owner &#125;&#125;&#x2F;kubespray</span><br><span class="line"></span><br><span class="line">      - name: Checkout os-packages repo</span><br><span class="line">        uses: actions&#x2F;checkout@v2</span><br><span class="line">        with:</span><br><span class="line">          ref: main</span><br><span class="line">          fetch-depth: 0</span><br><span class="line">          path: os-packages</span><br><span class="line">          repository: $&#123;&#123; github.repository_owner &#125;&#125;&#x2F;os-packages</span><br></pre></td></tr></table></figure>
<ul>
<li>è·å– kubespray å’Œ os-packages çš„ repo tagï¼Œæ ¹æ®å®ƒæ¥ç¡®å®š os-packages, kubespray-files, kubespray-images è¿™ä¸ªä¸‰ä¸ªé•œåƒçš„ tagï¼Œå¹¶ç”Ÿæˆä¸€ä¸ª All in One çš„ Dockerfile ç”¨äºå®Œæˆåç»­å®‰è£…åŒ…çš„æ„å»ºã€‚</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># è·å–ä¸€äº›ç»„ä»¶çš„ç‰ˆæœ¬å’Œå˜é‡ä¼ é€’ç»™ Dockerfile</span><br><span class="line">- name: Prepare for build images</span><br><span class="line">  shell: bash</span><br><span class="line">  run: |</span><br><span class="line">    git describe --tags --always | sed &#39;s&#x2F;^&#x2F;IMAGE_TAG&#x3D;&#x2F;&#39; &gt;&gt; $GITHUB_ENV</span><br><span class="line"></span><br><span class="line">    cd kubespray &amp;&amp; git describe --tags --always | sed &#39;s&#x2F;^&#x2F;KUBESPRAY_VERSION&#x3D;&#x2F;&#39; &gt;&gt; $GITHUB_ENV &amp;&amp; cd ..</span><br><span class="line">    cd os-packages &amp;&amp; git describe --tags --always | sed &#39;s&#x2F;^&#x2F;OS_PACKAGE_REPO_TAG&#x3D;&#x2F;&#39; &gt;&gt; $GITHUB_ENV &amp;&amp; cd ..</span><br><span class="line">    cp -rf kubespray&#x2F;config config&#x2F;kubespray &amp;&amp; rm -rf kubespray os-packages</span><br><span class="line"></span><br><span class="line">    source $GITHUB_ENV</span><br><span class="line">    echo &quot;&quot; &gt;&gt; Dockerfile</span><br><span class="line">    echo &quot;COPY --from&#x3D;$&#123;OS_PACKAGES_IMAGE&#125;:$&#123;OS_PACKAGE_REPO_TAG&#125; &#x2F; &#x2F;resources&#x2F;nginx&quot; &gt;&gt; Dockerfile</span><br><span class="line">    echo &quot;COPY --from&#x3D;$&#123;KUBESPRAY_FILES_IMAGE&#125;:$&#123;KUBESPRAY_VERSION&#125; &#x2F; &#x2F;resources&#x2F;nginx&quot; &gt;&gt; Dockerfile</span><br><span class="line">    echo &quot;COPY --from&#x3D;$&#123;KUBESPRAY_IMAGES_IMAGE&#125;:$&#123;KUBESPRAY_VERSION&#125; &#x2F; &#x2F;resources&#x2F;registry&quot; &gt;&gt; Dockerfile</span><br><span class="line"></span><br><span class="line">    sed -n &#39;s|image: nginx:|NGINX_VERSION&#x3D;|p&#39; compose.yaml | tr -d &#39; &#39; &gt;&gt; $GITHUB_ENV</span><br><span class="line">    sed -n &#39;s|image: registry:|RERGISRRY_VERSION&#x3D;|p&#39; compose.yaml | tr -d &#39; &#39; &gt;&gt; $GITHUB_ENV</span><br></pre></td></tr></table></figure>
<ul>
<li>ä½¿ç”¨ <code>outputs: type=local,dest=./</code> æ„å»ºé•œåƒåˆ°æœ¬åœ°ç›®å½•è€Œé push åˆ° registry</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">- name: Build kubeplay image to local</span><br><span class="line">  uses: docker&#x2F;build-push-action@v2</span><br><span class="line">  with:</span><br><span class="line">    context: .</span><br><span class="line">    file: Dockerfile</span><br><span class="line">    platforms: linux&#x2F;amd64,linux&#x2F;arm64</span><br><span class="line">    build-args: |</span><br><span class="line">      NGINX_VERSION&#x3D;$&#123;&#123; env.NGINX_VERSION &#125;&#125;</span><br><span class="line">      RERGISRRY_VERSION&#x3D;$&#123;&#123; env.RERGISRRY_VERSION &#125;&#125;</span><br><span class="line">      KUBESPRAY_IMAGE&#x3D;$&#123;&#123; env.KUBESPRAY_IMAGE &#125;&#125;</span><br><span class="line">      KUBESPRAY_VERSION&#x3D;$&#123;&#123; env.KUBESPRAY_VERSION &#125;&#125;</span><br><span class="line">    outputs: type&#x3D;local,dest&#x3D;.&#x2F;</span><br></pre></td></tr></table></figure>
<ul>
<li>æ‰“åŒ…å¹¶ä¸Šä¼ å®‰è£…åŒ…åˆ° GitHub release å­˜å‚¨</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">- name: Prepare for upload package</span><br><span class="line">  shell: bash</span><br><span class="line">  run: |</span><br><span class="line">    rm -rf linux_&#123;amd64,arm64&#125;&#x2F;&#123;Dockerfile,LICENSE&#125;</span><br><span class="line">    mv linux_amd64 kubeplay</span><br><span class="line">    tar -I pigz -cf kubeplay-$&#123;IMAGE_TAG&#125;-linux-amd64.tar.gz kubeplay --remove-files</span><br><span class="line">    mv linux_arm64 kubeplay</span><br><span class="line">    tar -I pigz -cf kubeplay-$&#123;IMAGE_TAG&#125;-linux-arm64.tar.gz kubeplay --remove-files</span><br><span class="line">    sha256sum kubeplay-$&#123;IMAGE_TAG&#125;-linux-&#123;amd64,arm64&#125;.tar.gz &gt; sha256sum.txt</span><br><span class="line"></span><br><span class="line">- name: Release and upload packages</span><br><span class="line">  uses: softprops&#x2F;action-gh-release@v1</span><br><span class="line">  env:</span><br><span class="line">    GITHUB_TOKEN: $&#123;&#123; secrets.GITHUB_TOKEN &#125;&#125;</span><br><span class="line">  with:</span><br><span class="line">    files: |</span><br><span class="line">      sha256sum.txt</span><br><span class="line">      kubeplay-$&#123;&#123; env.IMAGE_TAG &#125;&#125;-linux-amd64.tar.gz</span><br><span class="line">      kubeplay-$&#123;&#123; env.IMAGE_TAG &#125;&#125;-linux-arm64.tar.gz</span><br></pre></td></tr></table></figure>
<p>ç”±æ­¤ä¸€ä¸ªå®Œæ•´çš„ç¦»çº¿å®‰è£…åŒ…å°±æ„å»ºå®Œæˆäº†ï¼Œæ¥ä¸‹æ¥å†è®²ä¸€ä¸‹å®‰è£…æµç¨‹</p>
<h2><span id="å®‰è£…æµç¨‹">å®‰è£…æµç¨‹</span></h2>
<p>åœ¨ <a href="https://github.com/k8sli/kubeplay/releases" target="_blank" rel="noopener">GitHub release é¡µé¢</a> å°†æˆ‘ä»¬çš„ç¦»çº¿å®‰è£…åŒ…ä¸‹è½½åˆ°æœ¬åœ°ï¼Œéœ€è¦æ ¹æ® CPU æ¶æ„çš„ç±»å‹é€‰æ‹©ç›¸åº”çš„å®‰è£…åŒ…ã€‚</p>
<p><img src="https://p.k8s.li/2021-08-24-offline-deploy-k8s-1.png" alt></p>
<p>ä¸‹è½½å®Œæˆä¹‹åå†å°†å®‰è£…åŒ…é€šè¿‡ scp æˆ–è€…å…¶ä»–æ–¹å¼ä¸Šä¼ åˆ°å†…ç½‘çš„éƒ¨ç½²èŠ‚ç‚¹ä¸Šï¼Œéƒ¨ç½²çš„æ–‡æ¡£å¯å‚è€ƒ <a href="https://github.com/k8sli/kubeplay" target="_blank" rel="noopener">README</a> ã€‚è¿‡ç¨‹ååˆ†ç®€å•ï¼šåªéœ€è¦å¡«å†™å¥½ <code>config.yaml</code> é…ç½®æ–‡ä»¶ç„¶åæ‰§è¡Œ <code>bash install.sh</code> å³å¯å®Œæˆ K8s é›†ç¾¤çš„ä¸€é”®éƒ¨ç½²ã€‚</p>
<p>ä¸‹é¢ä»æºç è€Œé README æ–‡æ¡£çš„è§’åº¦æ¥è®²ä¸€ä¸‹éƒ¨ç½²æµç¨‹çš„å®ç°ç»†èŠ‚</p>
<h3><span id="å®‰è£…åŒ…ç»“æ„">å®‰è£…åŒ…ç»“æ„</span></h3>
<ul>
<li>é…ç½®æ–‡ä»¶ <code>config.yaml</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"># nginx ç«¯å£å’Œ registry åŸŸåé…ç½®å‚æ•°</span><br><span class="line">compose:</span><br><span class="line">  # Compose bootstrap node ip, default is local internal ip</span><br><span class="line">  internal_ip: 172.20.0.25</span><br><span class="line">  # Nginx http server bind port for download files and packages</span><br><span class="line">  nginx_http_port: 8080</span><br><span class="line">  # Registry domain for CRI runtime download images</span><br><span class="line">  registry_domain: kube.registry.local</span><br><span class="line"></span><br><span class="line"># kubespray å‚æ•°</span><br><span class="line">kubespray:</span><br><span class="line">  # Kubernetes version by default, only support v1.20.6</span><br><span class="line">  kube_version: v1.21.3</span><br><span class="line">  # For deploy HA cluster you must configure a external apiserver access ip</span><br><span class="line">  external_apiserver_access_ip: 127.0.0.1</span><br><span class="line">  # Set network plugin to calico with vxlan mode by default</span><br><span class="line">  kube_network_plugin: calico</span><br><span class="line">  #Container runtime, only support containerd if offline deploy</span><br><span class="line">  container_manager: containerd</span><br><span class="line">  # Now only support host if use containerd as CRI runtime</span><br><span class="line">  etcd_deployment_type: host</span><br><span class="line">  # Settings for etcd event server</span><br><span class="line">  etcd_events_cluster_setup: true</span><br><span class="line">  etcd_events_cluster_enabled: true</span><br><span class="line"></span><br><span class="line"># é›†ç¾¤èŠ‚ç‚¹ ssh ç™»å½• inventory é…ç½®</span><br><span class="line"># Cluster nodes inventory info</span><br><span class="line">inventory:</span><br><span class="line">  all:</span><br><span class="line">    vars:</span><br><span class="line">      ansible_port: 22</span><br><span class="line">      ansible_user: root</span><br><span class="line">      ansible_ssh_pass: Password</span><br><span class="line">      # ansible_ssh_private_key_file: &#x2F;kubespray&#x2F;config&#x2F;id_rsa</span><br><span class="line">    hosts:</span><br><span class="line">      node1:</span><br><span class="line">        ansible_host: 172.20.0.21</span><br><span class="line">      node2:</span><br><span class="line">        ansible_host: 172.20.0.22</span><br><span class="line">      node3:</span><br><span class="line">        ansible_host: 172.20.0.23</span><br><span class="line">      node4:</span><br><span class="line">        ansible_host: 172.20.0.24</span><br><span class="line">    children:</span><br><span class="line">      kube_control_plane:</span><br><span class="line">        hosts:</span><br><span class="line">          node1:</span><br><span class="line">          node2:</span><br><span class="line">          node3:</span><br><span class="line">      kube_node:</span><br><span class="line">        hosts:</span><br><span class="line">          node1:</span><br><span class="line">          node2:</span><br><span class="line">          node3:</span><br><span class="line">          node4:</span><br><span class="line">      etcd:</span><br><span class="line">        hosts:</span><br><span class="line">          node1:</span><br><span class="line">          node2:</span><br><span class="line">          node3:</span><br><span class="line">      k8s_cluster:</span><br><span class="line">        children:</span><br><span class="line">          kube_control_plane:</span><br><span class="line">          kube_node:</span><br><span class="line">      gpu:</span><br><span class="line">        hosts: &#123;&#125;</span><br><span class="line">      calico_rr:</span><br><span class="line">        hosts: &#123;&#125;</span><br><span class="line"></span><br><span class="line"># ä¸€äº›é»˜è®¤çš„é…ç½®ï¼Œä¸€èˆ¬æƒ…å†µä¸‹æ— éœ€ä¿®æ”¹</span><br><span class="line">### Default parameters ###</span><br><span class="line">## This filed not need config, will auto update,</span><br><span class="line">## if no special requirement, do not modify these parameters.</span><br><span class="line">default:</span><br><span class="line">  # NTP server ip address or domain, default is internal_ip</span><br><span class="line">  ntp_server:</span><br><span class="line">    - internal_ip</span><br><span class="line">  # Registry ip address, default is internal_ip</span><br><span class="line">  registry_ip: internal_ip</span><br><span class="line">  # Offline resource url for download files, default is internal_ip:nginx_http_port</span><br><span class="line">  offline_resources_url: internal_ip:nginx_http_port</span><br><span class="line">  # Use nginx and registry provide all offline resources</span><br><span class="line">  offline_resources_enabled: true</span><br><span class="line">  # Image repo in registry</span><br><span class="line">  image_repository: library</span><br><span class="line">  # Kubespray container image for deploy user cluster or scale</span><br><span class="line">  kubespray_image: &quot;kubespray&quot;</span><br><span class="line">  # Auto generate self-signed certificate for registry domain</span><br><span class="line">  generate_domain_crt: true</span><br><span class="line">  # For nodes pull image, use 443 as default</span><br><span class="line">  registry_https_port: 443</span><br><span class="line">  # For push image to this registry, use 5000 as default, and only bind at 127.0.0.1</span><br><span class="line">  registry_push_port: 5000</span><br><span class="line">  # Set false to disable download all container images on all nodes</span><br><span class="line">  download_container: false</span><br></pre></td></tr></table></figure>
<ul>
<li>å®‰è£…åŒ…ç›®å½•</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">kubeplay&#x2F;</span><br><span class="line">.</span><br><span class="line">â”œâ”€â”€ compose.yaml                 # compose é…ç½®æ–‡ä»¶</span><br><span class="line">â”œâ”€â”€ config</span><br><span class="line">â”‚   â”œâ”€â”€ compose</span><br><span class="line">â”‚   â”‚   â””â”€â”€ nginx.conf           # nginx é…ç½®æ–‡ä»¶</span><br><span class="line">â”‚   â”œâ”€â”€ kubespray</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ env.yml</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ group_vars           # kubespray group_vars  é…ç½®æ–‡ä»¶</span><br><span class="line">â”‚   â”‚   â””â”€â”€ inventory.ini</span><br><span class="line">â”‚   â””â”€â”€ rootCA.cnf               # openssl é…ç½®æ–‡ä»¶</span><br><span class="line">â”œâ”€â”€ config-sample.yaml           # ä¸»é…ç½®æ–‡ä»¶</span><br><span class="line">â”œâ”€â”€ install.sh                   # å®‰è£…åŒ…å…¥å£è„šæœ¬</span><br><span class="line">â”œâ”€â”€ library</span><br><span class="line">â””â”€â”€ resources                    # æ‰€æœ‰ç¦»çº¿èµ„æº</span><br><span class="line">    â”œâ”€â”€ images</span><br><span class="line">    â”‚   â”œâ”€â”€ kubespray-v2.16.tar  # kubespray é•œåƒ</span><br><span class="line">    â”‚   â”œâ”€â”€ nginx-1.20-alpine.tar# nginx é•œåƒ</span><br><span class="line">    â”‚   â””â”€â”€ registry-2.7.1.tar   # registry é•œåƒ</span><br><span class="line">    â”œâ”€â”€ nginx                    # rpm&#x2F;deb åŒ…ä»¥åŠä¸€äº›äºŒè¿›åˆ¶æ–‡ä»¶</span><br><span class="line">    â”‚   â”œâ”€â”€ centos               # centos rpm åŒ…</span><br><span class="line">    â”‚   â”œâ”€â”€ debian               # debian deb åŒ…</span><br><span class="line">    â”‚   â”œâ”€â”€ files                # ä¸€äº›äºŒè¿›åˆ¶æ–‡ä»¶</span><br><span class="line">    â”‚   â”œâ”€â”€ repos                # yum&#x2F;apt é…ç½®æ–‡ä»¶</span><br><span class="line">    â”‚   â”œâ”€â”€ tools                # ä¸€äº›éƒ¨ç½²æ—¶ä¾èµ–çš„å·¥å…·</span><br><span class="line">    â”‚   â””â”€â”€ ubuntu               # ubuntu deb åŒ…</span><br><span class="line">    â””â”€â”€ registry</span><br><span class="line">        â””â”€â”€ docker               # ç»„ä»¶é•œåƒ registry å­˜å‚¨ç›®å½•</span><br></pre></td></tr></table></figure>
<h3><span id="compose-èŠ‚ç‚¹">compose èŠ‚ç‚¹</span></h3>
<p>éœ€è¦å•ç‹¬åˆ’åˆ†å‡ºä¸€ä¸ªèŠ‚ç‚¹ç”¨æˆ·éƒ¨ç½² nginx å’Œé•œåƒä»“åº“æœåŠ¡ï¼Œå¹¶åœ¨è¯¥èŠ‚ç‚¹ä¸Šè¿è¡Œ kubespray æ¥éƒ¨ç½² K8s é›†ç¾¤ã€‚å¤§è‡´æµç¨‹çš„ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">deploy_compose()&#123;</span><br><span class="line">  case $&#123;ID&#125; in</span><br><span class="line">    Debian|debian)</span><br><span class="line">      system::debian::config_repo</span><br><span class="line">      ;;</span><br><span class="line">    CentOS|centos)</span><br><span class="line">      system::centos::disable_selinux</span><br><span class="line">      system::centos::config_repo</span><br><span class="line">      ;;</span><br><span class="line">    Ubuntu|ubuntu)</span><br><span class="line">      system::ubuntu::config_repo</span><br><span class="line">      ;;</span><br><span class="line">    *)</span><br><span class="line">      errorlog &quot;Not support system: $&#123;ID&#125;&quot;</span><br><span class="line">      exit 1</span><br><span class="line">      ;;</span><br><span class="line">  esac</span><br><span class="line">  system::disable_firewalld</span><br><span class="line">  system::install_pkgs</span><br><span class="line">  common::install_tools</span><br><span class="line">  common::rudder_config</span><br><span class="line">  common::update_hosts</span><br><span class="line">  common::generate_domain_certs</span><br><span class="line">  common::load_images</span><br><span class="line">  common::compose_up</span><br><span class="line">  common::health_check</span><br><span class="line">  system::install_chrony</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">main()&#123;</span><br><span class="line">  case $&#123;INSTALL_TYPE&#125; in</span><br><span class="line">    all)</span><br><span class="line">      deploy_compose</span><br><span class="line">      common::push_kubespray_image</span><br><span class="line">      common::run_kubespray &quot;bash &#x2F;kubespray&#x2F;run.sh deploy-cluster&quot;</span><br><span class="line">      ;;</span><br><span class="line">    *)</span><br><span class="line">      echowarn &quot;unknow [TYPE] parameter: $&#123;INSTALL_TYPE&#125;&quot;</span><br><span class="line">      common::usage</span><br><span class="line">      ;;</span><br><span class="line">  esac</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">main &quot;$@&quot;</span><br></pre></td></tr></table></figure>
<ul>
<li>é¦–å…ˆåˆå§‹åŒ–èŠ‚ç‚¹ï¼Œå…³é—­é˜²ç«å¢™å’Œ <code>SELinux</code></li>
<li>é…ç½®éƒ¨ç½²èŠ‚ç‚¹ yum/apt ç¦»çº¿æº</li>
<li>å®‰è£…ä¸€äº›éƒ¨ç½²ä¾èµ–åŒ…ï¼Œå¦‚ chronyã€ libseccomp ç­‰</li>
<li>å®‰è£…ä¸€äº›å·¥å…·å¦‚ yq, skopeo, kubectl ç­‰</li>
<li>å®‰è£… nerdctl-full (containerd)</li>
<li>ä½¿ç”¨ nerdctl load -i çš„æ–¹å¼å¯¼å…¥nginx, registry, kubespray é•œåƒ</li>
<li>ä½¿ç”¨ yq æ¸²æŸ“é…ç½®æ–‡ä»¶ï¼Œç”Ÿæˆ kubespray éœ€è¦çš„ env æ–‡ä»¶å’Œ inventory æ–‡ä»¶</li>
<li>ç”Ÿæˆé•œåƒä»“åº“åŸŸåè¯ä¹¦å¹¶å°†è‡ªç­¾è¯ä¹¦æ·»åŠ åˆ°ä¸»æœºçš„ CA trust ä¿¡ä»»å½“ä¸­</li>
<li>åœ¨ <code>/etc/hosts</code> ä¸­æ·»åŠ é•œåƒä»“åº“åŸŸå hosts æ˜ å°„</li>
<li>ä½¿ç”¨ nerdctl compose å¯åŠ¨ nginx å’Œ registry æœåŠ¡</li>
<li>éƒ¨ç½²æ—¶é’ŸåŒæ­¥æœåŠ¡ chrony</li>
<li>æ£€æŸ¥å„ä¸ªæœåŠ¡çš„çŠ¶æ€</li>
<li>æœ€åä½¿ç”¨ nerdctl run å¯åŠ¨ kubespray å®¹å™¨æ¥éƒ¨ç½² k8s é›†ç¾¤</li>
</ul>
<h3><span id="kubespray">kubespray</span></h3>
<p>éƒ¨ç½²çš„æµç¨‹ä¸ŠåŸºæœ¬ä¸Šå’Œ kubespray å®˜æ–¹å¤§ä½“ä¸€è‡´ï¼Œåªä¸è¿‡æˆ‘ä»¬å¼•å…¥é‡Œåˆ†å±‚éƒ¨ç½²çš„ç‰¹æ€§</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">deploy_cluster()&#123;</span><br><span class="line">  touch $&#123;INSTALL_STEPS_FILE&#125;</span><br><span class="line">  STEPS&#x3D;&quot;00-default-ssh-config 01-cluster-bootstrap-os 02-cluster-etcd 03-cluster-kubernetes 04-cluster-network 05-cluster-apps&quot;</span><br><span class="line">  for step in $&#123;STEPS&#125;; do</span><br><span class="line">    if ! grep -q &quot;$&#123;step&#125;&quot; $&#123;INSTALL_STEPS_FILE&#125;; then</span><br><span class="line">      infolog &quot;start deploy $&#123;step&#125;&quot;</span><br><span class="line">      if ansible-playbook $&#123;ANSIBLE_ARGS&#125; $&#123;KUBE_ROOT&#125;&#x2F;playbooks&#x2F;$&#123;step&#125;.yml; then</span><br><span class="line">        echo $&#123;step&#125; &gt;&gt; $&#123;INSTALL_STEPS_FILE&#125;</span><br><span class="line">        infolog &quot;$&#123;step&#125; successfully installed&quot;</span><br><span class="line">      else</span><br><span class="line">        errorlog &quot;$&#123;step&#125; installation failed&quot;</span><br><span class="line">        exit 1</span><br><span class="line">      fi</span><br><span class="line">    else</span><br><span class="line">      warnlog &quot;$&#123;step&#125; is already installed, so skipped...&quot;</span><br><span class="line">    fi</span><br><span class="line">  done</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>é…ç½®å ¡å’æœº ssh ç™»å½•ï¼ˆå¯é€‰ï¼‰</li>
<li>é…ç½®èŠ‚ç‚¹ yum/apt æºä¸º nginx æœåŠ¡æä¾›çš„æº</li>
<li>å°†è‡ªç­¾çš„åŸŸåè¯ä¹¦æ·»åŠ åˆ°ä¸»æœºçš„ CA trust ä¿¡ä»»å½“ä¸­</li>
<li>åœ¨ <code>/etc/hosts</code> ä¸­æ·»åŠ é•œåƒä»“åº“åŸŸå hosts æ˜ å°„</li>
<li>å…³é—­é˜²ç«å¢™ï¼Œå®‰è£…æ—¶é’ŸåŒæ­¥æœåŠ¡ï¼Œè¿›è¡ŒåŒæ­¥æ—¶é’Ÿ</li>
<li>åˆå§‹åŒ–é›†ç¾¤èŠ‚ç‚¹ï¼Œå®‰è£…éƒ¨ç½²ä¾èµ–</li>
<li>å®‰è£…å®¹å™¨è¿è¡Œæ—¶ï¼Œä¸‹è½½æ–‡ä»¶å’Œç»„ä»¶é•œåƒ</li>
<li>éƒ¨ç½² etcd é›†ç¾¤</li>
<li>éƒ¨ç½² K8s é›†ç¾¤</li>
<li>éƒ¨ç½² CNI æ’ä»¶</li>
<li>å®‰è£…ä¸€äº›é¢å¤–çš„ addon ç»„ä»¶å¦‚ (coredns)</li>
</ul>
<p>è‡³æ­¤æ•´ä¸ªæ‰“åŒ…å’Œéƒ¨ç½²æµç¨‹å°±å®Œæ¯•äº†ï¼Œä¸‹é¢å†è®²å‡ ä¸ªæ‰“åŒ…/éƒ¨ç½²å¸¸è§çš„é—®é¢˜</p>
<h2><span id="å…¶ä»–">å…¶ä»–</span></h2>
<h3><span id="kubeadm-è¯ä¹¦">kubeadm è¯ä¹¦</span></h3>
<p>é€šè¿‡ä¿®æ”¹ kubeadm æºç çš„æ–¹å¼å°†è¯ä¹¦ç»­å‘½åˆ° 10 å¹´ï¼Œå¼€å¯ <code>kubeadm_patch_enabled</code> å‚æ•°éƒ¨ç½²æ—¶å°±å°† kubeadm æ›¿æ¢ä¸ºä¿®æ”¹åçš„ kubeadmã€‚å…³äº kubeadm çš„ä¿®æ”¹å’Œæ„å»ºå’Œå‚è€ƒæˆ‘ä¹‹å‰å†™è¿‡çš„ã€Š<a href="https://blog.k8s.li/build-k8s-binary-by-github-actions.html" target="_blank" rel="noopener">ä½¿ç”¨ GitHub Actions ç¼–è¯‘ kubernetes ç»„ä»¶</a>ã€‹ã€‚</p>
<ul>
<li><a href="https://github.com/k8sli/kubespray/blob/main/roles/cluster/download/tasks/main.yml" target="_blank" rel="noopener">roles/cluster/download/tasks/main.yml</a></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">- name: Relpace kubeadm binary file as patched version</span><br><span class="line">  get_url:</span><br><span class="line">    url: &quot;&#123;&#123; patched_kubeadm_download_url &#125;&#125;&quot;</span><br><span class="line">    dest: &quot;&#123;&#123; bin_dir &#125;&#125;&#x2F;kubeadm&quot;</span><br><span class="line">    mode: 0755</span><br><span class="line">    owner: root</span><br><span class="line">    group: root</span><br><span class="line">  tags:</span><br><span class="line">    - kubeadm</span><br><span class="line">  when: kubeadm_patch_enabled | default(true) | bool</span><br></pre></td></tr></table></figure>
<h3><span id="é•œåƒç¼“å­˜">é•œåƒç¼“å­˜</span></h3>
<p>os-packages, kubespray-base, kubespray-files, kubespray-images è¿™å››ä¸ªé•œåƒåœ¨æ„å»ºçš„æ—¶å€™éƒ½ä¼šé‡‡ç”¨ md5 å€¼çš„æ–¹å¼æ ¡éªŒæ˜¯å¦éœ€è¦é‡æ–°æ„å»ºé•œåƒï¼Œè¿™æ ·èƒ½å¤Ÿå¤§å¤§æå‡ CI çš„æ‰§è¡Œæ•ˆç‡ï¼Œä¸‹é¢ä»¥ kubespray-base è¿™ä¸ªé•œåƒä¸ºä¾‹ä»‹ç»å…¶åŸç†å’Œå®ç°ï¼š</p>
<ul>
<li>åœ¨æ„å»ºé•œåƒå‰ä¼šæœ‰ä¸€ä¸ª md5 è®¡ç®—å’Œæ ¡éªŒçš„æ­¥éª¤ï¼Œå°†ä¸è¯¥é•œåƒç´§å¯†ç›¸å…³çš„æ–‡ä»¶å†…å®¹è¿›è¡Œæ±‡æ€»å¹¶ç”Ÿæˆ md5 å€¼ï¼Œå¹¶å°†è¿™ä¸ªå€¼å¾—ä»¥ label çš„æ–¹å¼ä¿å­˜åœ¨é•œåƒçš„å…ƒæ•°æ®ä¿¡æ¯å½“ä¸­ã€‚å¦‚æœè¯¥å€¼ä¸ä¸Šä¸ªæœ€æ–°çš„é•œåƒä¸­çš„ md5 å€¼ç›¸ç­‰ï¼Œé‚£ä¹ˆå°±ä¸éœ€è¦é‡æ–°æ„å»ºè¯¥é•œåƒï¼Œåªéœ€è¦è¿›è¡Œ retag å³å¯ã€‚</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">- name: Prepare for build images</span><br><span class="line">  shell: bash</span><br><span class="line">  run: |</span><br><span class="line">    git describe --tags --always | sed &#39;s&#x2F;^&#x2F;IMAGE_TAG&#x3D;&#x2F;&#39; &gt;&gt; $GITHUB_ENV</span><br><span class="line">    git branch --show-current | sed &#39;s&#x2F;^&#x2F;BRANCH_NAME&#x3D;&#x2F;&#39; &gt;&gt; $GITHUB_ENV</span><br><span class="line">    git branch --show-current | sed &#39;s&#x2F;master&#x2F;latest&#x2F;;s&#x2F;main&#x2F;latest&#x2F;;s&#x2F;^&#x2F;IMAGE_TAG_BY_BRANCH&#x3D;&#x2F;&#39; &gt;&gt; $GITHUB_ENV</span><br><span class="line">    sed -n &#39;s&#x2F;^kube_version: &#x2F;KUBE_VERSION&#x3D;&#x2F;p&#39; roles&#x2F;kubespray-defaults&#x2F;defaults&#x2F;main.yaml &gt;&gt; $GITHUB_ENV</span><br><span class="line">    cat build&#x2F;kubespray-base&#x2F;Dockerfile requirements.txt tests&#x2F;requirements.txt .github&#x2F;workflows&#x2F;build.yaml \</span><br><span class="line">    | md5sum | tr -d &#39;\ -&#39; | sed &#39;s&#x2F;^&#x2F;BASE_MD5&#x3D;md5-&#x2F;&#39; &gt;&gt; $GITHUB_ENV</span><br><span class="line"></span><br><span class="line">    source $GITHUB_ENV</span><br><span class="line">    if skopeo inspect docker:&#x2F;&#x2F;$&#123;BASE_IMAGE_REPO&#125;:$&#123;BRANCH_NAME&#125; &gt; mainfest.json; then</span><br><span class="line">      jq -r &#39;.Labels.BASE_MD5&#39; mainfest.json | sed &#39;s&#x2F;^&#x2F;LATEST_BASE_MD5&#x3D;&#x2F;&#39; &gt;&gt; $GITHUB_ENV</span><br><span class="line">    else</span><br><span class="line">      echo &#39;LATEST_BASE_MD5&#x3D;null&#39; &gt;&gt; $GITHUB_ENV</span><br><span class="line">    fi</span><br></pre></td></tr></table></figure>
<ul>
<li>å¦‚æœå½“å‰md5 çš„å€¼ä¸æœ€æ–°çš„ md5 å€¼ç›¸ç­‰ï¼Œå°±é‡æ–°ç”Ÿæˆä¸€ä¸ªæ–°çš„ Dockerfile æ¥è¿›è¡Œé•œåƒ retag çš„æ“ä½œã€‚</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- name: Replace Dockerfile if MD5 not update</span><br><span class="line">  if: $&#123;&#123; env.BASE_MD5 &#x3D;&#x3D; env.LATEST_BASE_MD5 &#125;&#125;</span><br><span class="line">  run: |</span><br><span class="line">    echo &quot;FROM $&#123;&#123; env.BASE_IMAGE_REPO &#125;&#125;:$&#123;&#123; env.BASE_MD5 &#125;&#125;&quot; &gt; build&#x2F;kubespray-base&#x2F;Dockerfile</span><br></pre></td></tr></table></figure>
<ul>
<li>æ„å»ºé•œåƒå¹¶å°† md5 å€¼ä½œä¸º labels å¡«å……åˆ°é•œåƒçš„å…ƒæ•°æ®ä¿¡æ¯å½“ä¸­ã€‚</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">- name: Build and push kubespray-base images</span><br><span class="line">  uses: docker&#x2F;build-push-action@v2</span><br><span class="line">  with:</span><br><span class="line">    context: .</span><br><span class="line">    push: $&#123;&#123; github.event_name !&#x3D; &#39;pull_request&#39; &#125;&#125;</span><br><span class="line">    file: build&#x2F;kubespray-base&#x2F;Dockerfile</span><br><span class="line">    platforms: linux&#x2F;amd64,linux&#x2F;arm64</span><br><span class="line">    cache-from: type&#x3D;local,src&#x3D;&#x2F;tmp&#x2F;.buildx-cache</span><br><span class="line">    cache-to: type&#x3D;local,dest&#x3D;&#x2F;tmp&#x2F;.buildx-cache-new</span><br><span class="line">    build-args: KUBE_VERSION&#x3D;$&#123;&#123; env.KUBE_VERSION &#125;&#125;</span><br><span class="line">    labels: BASE_MD5&#x3D;$&#123;&#123; env.BASE_MD5 &#125;&#125;</span><br><span class="line">    tags: |</span><br><span class="line">      $&#123;&#123; env.BASE_IMAGE_REPO &#125;&#125;:$&#123;&#123; env.IMAGE_TAG &#125;&#125;</span><br><span class="line">      $&#123;&#123; env.BASE_IMAGE_REPO &#125;&#125;:$&#123;&#123; env.BASE_MD5 &#125;&#125;</span><br><span class="line">      $&#123;&#123; env.BASE_IMAGE_REPO &#125;&#125;:$&#123;&#123; env.BRANCH_NAME &#125;&#125;</span><br><span class="line">      $&#123;&#123; env.BASE_IMAGE_REPO &#125;&#125;:$&#123;&#123; env.IMAGE_TAG_BY_BRANCH &#125;&#125;</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨è¿™ç§æ–¹å¼çš„å¥½å¤„å°±åœ¨äºåœ¨ä¸éœ€è¦æ„å»ºé•œåƒçš„æ—¶å€™èƒ½å¤§å¹…åº¦æå‡ CI çš„è¿è¡Œæ•ˆç‡ã€‚</p>
<blockquote>
<p>æœ¬æ–‡è½¬è½½è‡ªï¼šã€Œ æœ¨å­çš„åšå®¢ ã€ï¼ŒåŸæ–‡ï¼š<a href="https://tinyurl.com/y9bekf67" target="_blank" rel="noopener">https://tinyurl.com/y9bekf67</a> ï¼Œç‰ˆæƒå½’åŸä½œè€…æ‰€æœ‰ã€‚æ¬¢è¿æŠ•ç¨¿ï¼ŒæŠ•ç¨¿é‚®ç®±: <a href="mailto:editor@hi-linux.com">editor@hi-linux.com</a>ã€‚</p>
</blockquote>
</div>

			<script src="https://my.openwrite.cn/js/readmore.js" type="text/javascript"></script>
			<script>
			var isMobile = navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i);
			if (!isMobile) {
			    var btw = new BTWPlugin();
			    btw.init({
			        "id": "vip-container",
			        "blogId": "10135-1588830050631-449",
			        "name": "ã€Œå¥‡å¦™çš„ Linux ä¸–ç•Œã€",
			        "qrcode": "https://www.hi-linux.com/img/wechat/mp_qrcode_12.jpg",
			        "keyword": "VIP"
			    });
			}
			</script>
		
                

                <hr>
                <!-- Pager -->
                <ul class="pager">
                    
                        <li class="previous">
                            <a href="/posts/16167.html" data-toggle="tooltip" data-placement="top" title="å¦‚ä½•å¿«é€Ÿçš„åœ¨ Kubernetes ä¸Šéƒ¨ç½²äº‘åŸç”Ÿå¾®æœåŠ¡ç½‘å…³ APISIX">&larr; Previous Post</a>
                        </li>
                    
                    
                        <li class="next">
                            <a href="/posts/19507.html" data-toggle="tooltip" data-placement="top" title="ä¸¤ä¸ª 99% çš„äººéƒ½é‡åˆ°è¿‡çš„ Kubernetes æ•…éšœå¤„ç†æŠ€å·§">Next Post &rarr;</a>
                        </li>
                    
                </ul>

                <!-- duoshuo Share start -->
                
                <!-- å¤šè¯´ Share end-->

                <!-- å¤šè¯´è¯„è®ºæ¡† start -->
                
                <!-- å¤šè¯´è¯„è®ºæ¡† end -->

                <!-- disqus comment start -->
                
                <!-- disqus comment end -->

                
                    <!-- disqus è¯„è®ºæ¡† start -->
                    <div class="comment">
                        <div id="lv-container" data-id="city" data-uid="MTAyMC8yNzg2My80NDQw"></div>
                    </div>
                    <!-- disqus è¯„è®ºæ¡† end -->
                

            </div>
            
            <!-- Tabe of Content -->
            <!-- Table of Contents -->

  
    <style>
      span.toc-nav-number{
        display: none
      }
    </style>
  
    
      <aside id="sidebar">
        <div id="toc" class="toc-article">
        <strong class="toc-title">Contents</strong>
        
          <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">ç¦»çº¿èµ„æº</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">1.1.</span> <span class="toc-nav-text">OS packages</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">1.1.1.</span> <span class="toc-nav-text">sealos</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">1.1.2.</span> <span class="toc-nav-text">kubekey</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">1.1.3.</span> <span class="toc-nav-text">æ„å»ºç¦»çº¿æº</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">1.2.</span> <span class="toc-nav-text">files</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">1.2.1.</span> <span class="toc-nav-text">sealos</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">1.2.2.</span> <span class="toc-nav-text">kubekey</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">1.2.3.</span> <span class="toc-nav-text">kubespray</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">1.3.</span> <span class="toc-nav-text">images</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">1.3.1.</span> <span class="toc-nav-text">sealos</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">1.3.2.</span> <span class="toc-nav-text">kubekey</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">1.3.3.</span> <span class="toc-nav-text">é•œåƒä»“åº“</span></a></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">2.</span> <span class="toc-nav-text">éƒ¨ç½²å·¥å…·é€‰æ‹©</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">2.1.</span> <span class="toc-nav-text">sealos</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">2.2.</span> <span class="toc-nav-text">ç°åœ¨å¼€å§‹ ï¿¥99 ï¿¥69&#x2F;å¹´</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">2.3.</span> <span class="toc-nav-text">kubekey</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">2.4.</span> <span class="toc-nav-text">kubespray</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">3.</span> <span class="toc-nav-text"></span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">3.1.</span> <span class="toc-nav-text">æ‰“åŒ…æ–¹å¼</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">3.2.</span> <span class="toc-nav-text">compose</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">3.3.</span> <span class="toc-nav-text">os-packages</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">3.4.</span> <span class="toc-nav-text">kubespray</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">3.5.</span> <span class="toc-nav-text">æ–‡ä»¶å’Œé•œåƒ</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">3.6.</span> <span class="toc-nav-text">kubespray-files</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">3.7.</span> <span class="toc-nav-text">kubespray-images</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">3.8.</span> <span class="toc-nav-text">kubeplay</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">3.9.</span> <span class="toc-nav-text">æ„å»º</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">4.</span> <span class="toc-nav-text">å®‰è£…æµç¨‹</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">4.1.</span> <span class="toc-nav-text">å®‰è£…åŒ…ç»“æ„</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">4.2.</span> <span class="toc-nav-text">compose èŠ‚ç‚¹</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">4.3.</span> <span class="toc-nav-text">kubespray</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">5.</span> <span class="toc-nav-text">å…¶ä»–</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">5.1.</span> <span class="toc-nav-text">kubeadm è¯ä¹¦</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#vip-container"><span class="toc-nav-number">5.2.</span> <span class="toc-nav-text">é•œåƒç¼“å­˜</span></a></li></ol></li></ol>
        
        </div>
      </aside>
    

                
            <!-- Sidebar Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <!-- no hr -->
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                       
                          <a class="tag" href="/tags/#æŠ€å·§" title="æŠ€å·§">æŠ€å·§</a>
                        
                          <a class="tag" href="/tags/#Linux" title="Linux">Linux</a>
                        
                          <a class="tag" href="/tags/#Kubernetes" title="Kubernetes">Kubernetes</a>
                        
                    </div>
                </section>
                

                <!-- Friends Blog -->
                
                <hr>
                <h5>FRIENDS</h5>
                <ul class="list-inline">

                    
                        <li><a href="http://www.mike.org.cn/" target="_blank">ç®€å•.ç”Ÿæ´»</a></li>
                    
                        <li><a href="http://shang.qq.com/wpa/qunwpa?idkey=ea4c43493c2269428ac6ef6141de4b6d78e5ab2d41380ca4099b833b62884ee9" target="_blank">æŠ€æœ¯äº¤æµç¾¤</a></li>
                    
                        <li><a href="" target="_blank"></a></li>
                    
                        <li><a href="" target="_blank"></a></li>
                    
                </ul>
                
            </div>
        </div>
    </div>
</article>






    <!-- æ¥å¿…åŠ›Cityç‰ˆå…¬å…±JSä»£ç  start (ä¸€ä¸ªç½‘é¡µåªéœ€æ’å…¥ä¸€æ¬¡) -->
    <script type="text/javascript">
       (function(d, s) {
           var j, e = d.getElementsByTagName(s)[0];
    
           if (typeof LivereTower === 'function') { return; }
    
           j = d.createElement(s);
           j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
           j.async = true;
    
           e.parentNode.insertBefore(j, e);
       })(document, 'script');
    </script>
    <noscript>ä¸ºæ­£å¸¸ä½¿ç”¨æ¥å¿…åŠ›è¯„è®ºåŠŸèƒ½è¯·æ¿€æ´»JavaScript</noscript>
    <!-- æ¥å¿…åŠ›Cityç‰ˆ å…¬å…±JSä»£ç  end -->



<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'hover',
          placement: 'left',
          icon: 'â„¬'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                
                    <li>
                        <a href="/atom.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                
                
                
                    <li>
                        <a target="_blank" href="https://www.zhihu.com/people/80imike">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa  fa-stack-1x fa-inverse">çŸ¥</i>
                            </span>
                        </a>
                    </li>
                

                
                    <li>
                        <a target="_blank" href="http://weibo.com/2093524665">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                

                

                

                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; Mike 2024 | Hosted by <a href="https://pages.coding.me" target="_blank" rel="noopener" style="font-weight: bold">Coding Pages</a>
                    <br>
                    Theme by <a href="http://beantech.org" target="_blank" rel="noopener">BeanTech</a> 
                    <span style="display: inline-block; margin: 0 5px;">
                        <i class="fa fa-heart"></i>
                    </span> 
                    re-Ported by <a href="http://www.huweihuang.com" target="_blank" rel="noopener">èƒ¡ä¼Ÿç…Œ</a> | 
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="91px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=huweihuang&repo=hexo-theme-huweihuang&type=star&count=true" >
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->

<script src="/js/jquery.min.js"></script>


<!-- Bootstrap Core JavaScript -->

<script src="/js/bootstrap.min.js"></script>


<!-- Custom Theme JavaScript -->

<script src="/js/hux-blog.min.js"></script>



<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- 
     Because of the native support for backtick-style fenced code blocks 
     right within the Markdown is landed in Github Pages, 
     From V1.6, There is no need for Highlight.js, 
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0  
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/    
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->


<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("https://www.hi-linux.com/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->




<!-- Baidu Tongji -->



<script async defer data-website-id="0d8da2a4-a24e-4240-9304-00a6e347ddfe"
    src="https://umami.hi-linux.com/umami.js"></script>



	<a id="rocket" href="#top" class=""></a>
	<script type="text/javascript" src="/js/totop.js?v=1.0.0" async=""></script>
    <script type="text/javascript" src="/js/toc.js?v=1.0.0" async=""></script>
<!-- Image to hack wechat -->
<img src="https://www.hi-linux.com/img/icon_wechat.png" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

<script>(function(w,d, s, id) {w.webpushr=w.webpushr||function(){(w.webpushr.q=w.webpushr.q||[]).push(arguments)};var js, fjs = d.getElementsByTagName(s)[0];js = d.createElement(s); js.id = id;js.src = 'https://cdn.webpushr.com/app.min.js';fjs.parentNode.appendChild(js);}(window,document, 'script', 'webpushr-jssdk'));webpushr('init','BF9JK7xV9kjWTdMx2lr6RWaPfXV7wNuZaVAJ1bfIGoBNJavqLEBVFMKLubITnCA4bh2fI9iH9tMF95nXnPt7xxY');</script></body>

</html>
