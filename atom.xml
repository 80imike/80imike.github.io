<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>å¥‡å¦™çš„ Linux ä¸–ç•Œ</title>
  
  <subtitle>ç§ä¸€æ£µæ ‘æœ€å¥½çš„æ—¶é—´æ˜¯åå¹´å‰ï¼Œå…¶æ¬¡æ˜¯ç°åœ¨ã€‚</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://www.hi-linux.com/"/>
  <updated>2022-06-01T08:29:56.618Z</updated>
  <id>https://www.hi-linux.com/</id>
  
  <author>
    <name>Mike</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>å¦‚ä½•ä½¿ç”¨ Skopeo åšä¸€ä¸ªä¼˜é›…çš„é•œåƒæ¬è¿å·¥</title>
    <link href="https://www.hi-linux.com/posts/55385.html"/>
    <id>https://www.hi-linux.com/posts/55385.html</id>
    <published>2022-06-01T01:00:00.000Z</published>
    <updated>2022-06-01T08:29:56.618Z</updated>
    
    <content type="html"><![CDATA[<div id="vip-container"><h2><span id="1-åŸºç¡€ä»‹ç»">1. åŸºç¡€ä»‹ç»</span></h2><p>æè¿°: ä½œä¸ºå…¬å¸å†…éƒ¨ PaaS toB äº§å“çš„æ‰“åŒ…å‘å¸ƒäººå‘˜ï¼Œå®¹å™¨é•œåƒå¯¹æˆ‘ä»¬æ‰“å·¥äººè€Œè¨€å°±åƒæ˜¯å·¥åœ°ä¸Šçš„ç –å¤´ ğŸ§±ï¼Œè€Œæˆ‘çš„ä¸€éƒ¨åˆ†å·¥ä½œå°±æ˜¯å°†è¿™äº›ç –å¤´åœ¨å„ä¸ªä»“åº“ä¹‹é—´æ¬æ¥æ¬å»ï¼Œæœ€ç»ˆå°†è¿™äº›ç –å¤´æ‰“åŒ…æ”¾åœ¨äº§å“çš„å®‰è£…åŒ…ä¸­ï¼Œå½¢æˆä¸€ä¸ªå®Œæ•´çš„ PaaS äº§å“å®‰è£…åŒ…ã€‚</p><ul><li>Q: åœ¨ PaaS (å¹³å°å³æœåŠ¡)ä¸­çš„å¤§å®¶å¸¸è¯´çš„ ToB ä¸ ToC åˆ°åº•æ˜¯ä»€ä¹ˆ?</li></ul><blockquote><p>ToC é¢å‘æ™®é€šç”¨æˆ·æœåŠ¡, ä¸»è¦æ˜¯è®©ç”¨æˆ·ä½“éªŒæ„Ÿå¥½ï¼Œè§£å†³ç”¨æˆ·ä½¿ç”¨æ–¹é¢çš„é—®é¢˜è®°å½•ï¼Œå¹¶è¿”å›ç»™å‰åç«¯å¼€å‘ã€‚<br>ToB æ˜¯é¢å‘ä¼ä¸šç”¨æˆ·æœåŠ¡, äº§å“å¯ç”¨ã€å…¶ä¸­æœ€å…³é”®æ˜¯è®©Bossä½¿ç”¨Happly!</p></blockquote><ul><li>Q: å‡å¦‚æœ‰å¦‚ä¸‹åœºæ™¯ï¼Œæˆ‘ä»¬ä» dockerhub å…¬å…±ä»“åº“ä¸­ä¸‹è½½ä¸€ä¸ª GB ä»¥ä¸Šçš„é•œåƒï¼Œåˆ°æœ¬åœ°çš„ç§æœ‰ä»“åº“ä¸­ï¼Œæˆ‘æƒ³é€šå¸¸ä½ ä¼šè¿™æ ·åšå…ˆ <code>docker pull</code> åˆ°æœ¬åœ°ï¼Œç„¶åä½¿ç”¨ <code>docker tag</code> æ›´æ”¹ä¸ºç§æœ‰ä»“åº“åœ°å€åŠ ä¸Šé•œåƒåç§°ç‰ˆæœ¬ï¼Œæœ€åå†ä½¿ç”¨<code>docker push</code> ä¸Šä¼ é•œåƒåˆ°ç§æœ‰ä»“åº“ä¸­ï¼Œä»¥ä¾›å…¶å®ƒå†…ç½‘æœºå™¨æ‹‰å–å¹¶ä½¿ç”¨ã€‚è™½ç„¶è¯¥æ–¹æ³•æ˜¯å¯è¡Œï¼Œä½†æ˜¯å¦‚æœæœ‰å¤šä¸ªå¤§äº GB ä»¥ä¸Šçš„é•œåƒéœ€è¦ä¸Šä¼ åˆ°ç§æœ‰ä»“åº“ï¼Œæ¯æ¬¡éƒ½è¦å…ˆè§£å‹ layer åˆ°æœ¬åœ°ï¼Œç„¶åå†å‹ç¼© layer ä¸Šä¼ åˆ°ç§æœ‰ä»“åº“ä¸­ï¼Œä½ èƒ½æƒ³è±¡æ­¤è¿‡ç¨‹èŠ±è´¹çš„æ—¶é—´æœ‰å¤šä¹…å—? å¯¹äºæˆ‘ä»¬è¿ç»´å·¥ç¨‹å¸ˆæ¥è¯´æ—¶é—´å°±æ˜¯é‡‘é’±ï¼Œæ‰€ä»¥éœ€æƒ³å°½ä¸€åˆ‡æ–¹æ³•æ¥èŠ‚çº¦æ—¶é—´æˆæœ¬ï¼Œé‚£æœ‰æ²¡æœ‰ä¸€ç§åŠæ³•å¯ä»¥ç›´æ¥å°† registry ä¸Šçš„ blob å¤åˆ¶åˆ°å¦ä¸€ä¸ª registryï¼Œä¸­é—´è¿‡ç¨‹ä¸æ¶‰åŠå¯¹é•œåƒ layer çš„è§£å‹ç¼©ï¼Œè¿™å²‚ä¸ç¾å“‰ã€‚</li></ul><blockquote><p>è§£å†³æ–¹æ¡ˆå½“ç„¶æ˜¯å­˜åœ¨çš„ï¼Œå¦‚æœä½ ä¸æƒ³ä½¿ç”¨dockerè¿›è¡Œimagesé•œåƒæ‹‰å–ä¸Šä¼ ï¼Œæˆ‘ä»¬å®Œæˆå¯ä»¥ä½¿ç”¨skopeå·¥å…·æ¥å®Œå…¨æ›¿ä»£ docker-cli æ¥æ¬è¿é•œåƒï¼Œskopeoæ˜¯ä¸€ä¸ªå‘½ä»¤è¡Œå®ç”¨ç¨‹åºï¼Œå¯å¯¹å®¹å™¨æ˜ åƒå’Œæ˜ åƒå­˜å‚¨åº“æ‰§è¡Œå„ç§æ“ä½œã€‚</p></blockquote><a id="more"></a><p><strong>ä»€ä¹ˆæ˜¯ Skopeo ?</strong></p><p>skopeo ä½¿ç”¨ API V2 Registryï¼Œä¾‹å¦‚ Docker Registryã€Atomic Registryã€ç§æœ‰Registryã€æœ¬åœ°ç›®å½•å’Œæœ¬åœ° OCI é•œåƒç›®å½•ã€‚skopeo ä¸éœ€è¦è¿è¡Œå®ˆæŠ¤è¿›ç¨‹ï¼Œå®ƒå¯ä»¥æ‰§è¡Œçš„æ“ä½œåŒ…æ‹¬ï¼š</p><ul><li>é€šè¿‡å„ç§å­˜å‚¨æœºåˆ¶å¤åˆ¶é•œåƒï¼Œä¾‹å¦‚ï¼Œå¯ä»¥åœ¨ä¸éœ€è¦ç‰¹æƒçš„æƒ…å†µä¸‹å°†é•œåƒä»ä¸€ä¸ª Registry å¤åˆ¶åˆ°å¦ä¸€ä¸ª Registry</li><li>æ£€æµ‹è¿œç¨‹é•œåƒå¹¶æŸ¥çœ‹å…¶å±æ€§ï¼ŒåŒ…æ‹¬å…¶å›¾å±‚ï¼Œæ— éœ€å°†é•œåƒæ‹‰åˆ°æœ¬åœ°</li><li>ä»é•œåƒåº“ä¸­åˆ é™¤é•œåƒ</li><li>å½“å­˜å‚¨åº“éœ€è¦æ—¶ï¼Œskopeo å¯ä»¥ä¼ é€’é€‚å½“çš„å‡­æ®å’Œè¯ä¹¦è¿›è¡Œèº«ä»½éªŒè¯</li></ul><p><strong>é•œåƒå­˜å‚¨ç‰¹ç‚¹</strong></p><p>æ ¹æ® Robin å¤§ä½¬åœ¨ ã€Šé•œåƒä»“åº“ä¸­é•œåƒå­˜å‚¨çš„åŸç†è§£æã€‹æ–‡ç« é‡Œå¾—å‡ºçš„ç»“è®ºï¼š</p><ul><li><p>é€šè¿‡ Registry API è·å¾—çš„ä¸¤ä¸ªé•œåƒä»“åº“ä¸­ç›¸åŒé•œåƒçš„ manifest ä¿¡æ¯å®Œå…¨ç›¸åŒã€‚</p></li><li><p>ä¸¤ä¸ªé•œåƒä»“åº“ä¸­ç›¸åŒé•œåƒçš„ manifest ä¿¡æ¯çš„å­˜å‚¨è·¯å¾„å’Œå†…å®¹å®Œå…¨ç›¸åŒã€‚</p></li><li><p>ä¸¤ä¸ªé•œåƒä»“åº“ä¸­ç›¸åŒé•œåƒçš„ blob ä¿¡æ¯çš„å­˜å‚¨è·¯å¾„å’Œå†…å®¹å®Œå…¨ç›¸åŒ</p></li></ul><p><strong>é¡¹ç›®ä¿¡æ¯</strong></p><ul><li>Github å®˜æ–¹åœ°å€: <a href="https://github.com/containers/skopeo" target="_blank" rel="noopener">https://github.com/containers/skopeo</a></li><li>Gitee mirror: <a href="https://gitee.com/mirrors/skopeo" target="_blank" rel="noopener">https://gitee.com/mirrors/skopeo</a></li></ul><h2><span id="2-å®‰è£…ç¼–è¯‘">2. å®‰è£…ç¼–è¯‘</span></h2><p>æè¿°: Skopeo å®˜æ–¹å®‰è£…&amp;ç¼–è¯‘æ–¹å¼å‚è€ƒæ–‡æ¡£: <a href="https://github.com/containers/skopeo/blob/main/install.md" target="_blank" rel="noopener">https://github.com/containers/skopeo/blob/main/install.md</a></p><p>æœ¬èŠ‚å®‰è£…å®è·µç¯å¢ƒå°†åœ¨ Ubuntu 20.04 LTS ä»¥åŠ docker 20.10.12 ä¸­è¿›è¡Œå®è·µæºç ç¼–è¯‘ä»¥åŠ apt ä»“åº“æºä¸‹è½½å®‰è£…å®è·µã€‚</p><h3><span id="21-æºç ç¼–è¯‘é™æ€">2.1 æºç ç¼–è¯‘ï¼ˆé™æ€ï¼‰</span></h3><p>æè¿°: è¦æ„å»º skopeo äºŒè¿›åˆ¶æ–‡ä»¶æ‚¨è‡³å°‘éœ€è¦ Go 1.12 ç‰ˆæœ¬ä»¥ä¸Š, å…¶æ¬¡æ„å»º skopeo æœ‰ä¸¤ç§æ–¹æ³•ï¼Œå³<code>åœ¨å®¹å™¨ä¸­</code>æˆ–è€…åœ¨æœ¬åœ°ç¯å¢ƒä¸­æ„å»º(å®‰è£…ç¯å¢ƒè¾ƒä¸ºå¤æ‚), æ­¤å¤„ä¸ºäº†æ–¹ä¾¿æ¼”ç¤ºå°†é‡‡ç”¨å®¹å™¨æ–¹å¼è¿›è¡Œç¼–è¯‘æ„å»ºã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"># 1.æ‹‰å–skopeoæºç åˆ°æœ¬åœ°</span><br><span class="line">$ git clone --depth&#x3D;1 https:&#x2F;&#x2F;github.com&#x2F;containers&#x2F;skopeo.git  # https:&#x2F;&#x2F;github.com&#x2F;containers&#x2F;skopeo.git</span><br><span class="line">$ cd skopeo</span><br><span class="line">$ sed -i &#39;s#proxy.golang.org#https:&#x2F;&#x2F;goproxy.cn#g&#39; skopeo&#x2F;Makefile</span><br><span class="line"></span><br><span class="line"># 2.ä¸‹è½½é•œåƒæ„å»ºä¾èµ–</span><br><span class="line">$ sudo apt-get install go-md2man  # æ„å»ºæ‰‹å†Œä¾èµ–äº go-md2manã€‚</span><br><span class="line">$ whereis go-md2man  # è·å¾—æœ¬æœºä¸­go-md2manè·¯å¾„ã€‚</span><br><span class="line"></span><br><span class="line"># 3.æ„å»ºé™æ€äºŒè¿›åˆ¶æ–‡ä»¶</span><br><span class="line">$ BUILD_IMAGE&#x3D;&quot;golang:latest&quot;</span><br><span class="line">$ docker run --name skopeo-build -v $PWD:&#x2F;src -v &#x2F;usr&#x2F;bin&#x2F;go-md2man:&#x2F;go&#x2F;bin&#x2F;go-md2man -w &#x2F;src -e CGO_ENABLED&#x3D;0 -e GOPROXY&#x3D;https:&#x2F;&#x2F;goproxy.cn,direct $&#123;BUILD_IMAGE&#125; \</span><br><span class="line">sh -c &#39;make BUILDTAGS&#x3D;containers_image_openpgp GO_DYN_FLAGS&#x3D;&#39;</span><br><span class="line">  # CGO_CFLAGS&#x3D;&quot;&quot; CGO_LDFLAGS&#x3D;&quot;&quot; GO111MODULE&#x3D;on go build -mod&#x3D;vendor  -ldflags &#39;-X main.gitCommit&#x3D;df4d82b960572c19e9333381a203c0ac475766d7 &#39; -gcflags &quot;&quot; -tags  &quot;containers_image_openpgp&quot; -o bin&#x2F;skopeo .&#x2F;cmd&#x2F;skopeo</span><br><span class="line"></span><br><span class="line"># 4.è¿è¡Œç¼–è¯‘ç”Ÿæˆçš„skopeoå¯æ‰§è¡Œæ–‡ä»¶</span><br><span class="line">$ cd .&#x2F;bin # &#x2F;opt&#x2F;software&#x2F;skopeo&#x2F;bin</span><br><span class="line">$ .&#x2F;skopeo --help</span><br><span class="line">  # Various operations with container images and container image registries</span><br><span class="line">  # .......</span><br><span class="line">  # Use &quot;skopeo [command] --help&quot; for more information about a command.</span><br></pre></td></tr></table></figure><p><strong>æ„å»ºå…³é”®å‚æ•°è§£æ:</strong></p><ul><li>CGO_ENABLED=0 : è®¾ç½®è¯¥ç¯å¢ƒå˜é‡, ç¦ç”¨ CGO ä¼šå¯¼è‡´ Go åœ¨å¯èƒ½çš„æƒ…å†µä¸‹æ›´å–œæ¬¢é™æ€è¿æ¥åº“ï¼Œè€Œä¸æ˜¯åŠ¨æ€é“¾æ¥åˆ°ç³»ç»Ÿåº“ (è§£å†³å¯ä»¥åœ¨Ubuntuæˆ–è€…å…¶å®ƒlinuxå‘è¡Œç‰ˆä¸­æ‰§è¡Œç¼–è¯‘åäºŒè¿›åˆ¶æ–‡ä»¶)ã€‚</li><li>GOPROXY=https://goproxy.cn,direct : Golong ä¾èµ–ä¸‹è½½é•œåƒç«™,åŠ å¿«go getä¾èµ–æ‹‰æ‹‰å–ã€‚</li><li>BUILDTAGS=containers_image_openpgp : è®¾ç½®è¯¥makeå‚æ•°æ¶ˆé™¤äº†å¯¹libgpgme åŠå…¶é…å¥—åº“çš„ä¾èµ–, Skopeo çš„ä¸€äº›ç‰¹æ€§ä¾èµ–äºé Go åº“ï¼Œä¾‹å¦‚ libgpgme å’Œ libdevmapperã€‚</li><li>GO_DYN_FLAGS= : æ¸…ç©ºè¯¥makeå‚æ•° (å¦åˆ™ä¼šå¼ºåˆ¶åˆ›å»ºåŠ¨æ€å¯æ‰§è¡Œæ–‡ä»¶)</li></ul><h3><span id="22-åˆ†å‘åŒ…å®‰è£…">2.2 åˆ†å‘åŒ…å®‰è£…</span></h3><p>æè¿°: skopeo å¯èƒ½å·²ç»æ‰“åŒ…åœ¨æ‚¨çš„å‘è¡Œç‰ˆä¸­ï¼Œæ­¤å¤„ä»¥ ubuntu 20.04 ä¸ºä¾‹è¿›è¡Œå®‰è£…ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 1.åªæ”¯æŒ Ubuntu 20.10 and newer å‘è¡Œç‰ˆ </span><br><span class="line">$ sudo apt-get -y update</span><br><span class="line">$ sudo apt-get -y install skopeo</span><br><span class="line"></span><br><span class="line"># 2.ä½† Kubic é¡¹ç›®ä¸º Ubuntu 20.04 æä¾›äº†è½¯ä»¶åŒ…ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼åœ¨æˆ‘ä»¬åŠå…¶ä¸Šè¿›è¡Œå®‰è£…ã€‚</span><br><span class="line">$ . &#x2F;etc&#x2F;os-release</span><br><span class="line">$ echo &quot;deb https:&#x2F;&#x2F;download.opensuse.org&#x2F;repositories&#x2F;devel:&#x2F;kubic:&#x2F;libcontainers:&#x2F;stable&#x2F;xUbuntu_$&#123;VERSION_ID&#125;&#x2F; &#x2F;&quot; | sudo tee &#x2F;etc&#x2F;apt&#x2F;sources.list.d&#x2F;devel:kubic:libcontainers:stable.list</span><br><span class="line">$ curl -L https:&#x2F;&#x2F;download.opensuse.org&#x2F;repositories&#x2F;devel:&#x2F;kubic:&#x2F;libcontainers:&#x2F;stable&#x2F;xUbuntu_$&#123;VERSION_ID&#125;&#x2F;Release.key | sudo apt-key add -</span><br><span class="line">$ sudo apt-get update</span><br><span class="line">$ sudo apt-get -y upgrade</span><br><span class="line">$ sudo apt-get -y install skopeo</span><br></pre></td></tr></table></figure><h3><span id="23-å®¹å™¨å®‰è£…è¿è¡Œ">2.3 å®¹å™¨å®‰è£…è¿è¡Œ</span></h3><p>Skopeo å®¹å™¨é•œåƒå¯åœ¨ <a href="http://quay.io/skopeo/stable:latest" target="_blank" rel="noopener">quay.io/skopeo/stable:latest</a> è·å¾—, ä¾‹å¦‚æˆ‘ä»¬é‡‡ç”¨podmanå‘½ä»¤è¿›è¡Œå¦‚ä¸‹æ“ä½œ:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ podman run docker:&#x2F;&#x2F;quay.io&#x2F;skopeo&#x2F;stable:latest copy --help</span><br></pre></td></tr></table></figure><h2><span id="3-å¿«é€Ÿä¸Šæ‰‹">3. å¿«é€Ÿä¸Šæ‰‹</span></h2><h3><span id="31-å‘½ä»¤æµ…æ">3.1 å‘½ä»¤æµ…æ</span></h3><p>æè¿°: skopen æ˜¯æ“ä½œå„ç§å®¹å™¨æ˜ åƒå’Œå®¹å™¨æ˜ åƒä»“åº“çš„å·¥å…·ï¼Œå…¶ä½¿ç”¨æ–¹æ³•åŠå…¶å¯ç”¨å‘½ä»¤å¦‚ä¸‹:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">$ .&#x2F;skopeo --help    # å­å‘½ä»¤å¯é‡‡ç”¨å¦‚ä¸‹å‘½ä»¤ skopeo [command] --help å‘½ä»¤</span><br><span class="line">Usage:</span><br><span class="line">  skopeo [flags]</span><br><span class="line">  skopeo [command]</span><br><span class="line">Available Commands: </span><br><span class="line">  copy          # å¤åˆ¶ä¸€ä¸ªé•œåƒä» A åˆ° Bï¼Œè¿™é‡Œçš„ A å’Œ B å¯ä»¥ä¸ºæœ¬åœ° docker é•œåƒæˆ–è€… registry ä¸Šçš„é•œåƒï¼›</span><br><span class="line">  delete        # åˆ é™¤ä¸€ä¸ªé•œåƒ tagï¼Œå¯ä»¥æ˜¯æœ¬åœ° docker é•œåƒæˆ–è€… registry ä¸Šçš„é•œåƒï¼›</span><br><span class="line">  help          # å¸®åŠ©æŸ¥çœ‹</span><br><span class="line">  inspect       # æŸ¥çœ‹ä¸€ä¸ªé•œåƒçš„ manifest æˆ–è€… image config è¯¦ç»†ä¿¡æ¯ï¼›</span><br><span class="line">  list-tags     # åˆ—å‡ºå­˜å‚¨åº“åç§°æŒ‡å®šçš„é•œåƒçš„tag</span><br><span class="line">  login           # ç™»é™†æŸä¸ªé•œåƒä»“åº“,ç±»ä¼¼äº docker login å‘½ä»¤</span><br><span class="line">  logout          # é€€å‡ºæŸä¸ªå·²è®¤è¯çš„é•œåƒä»“åº“, ç±»ä¼¼äº docker logout å‘½ä»¤</span><br><span class="line">  manifest-digest # è®¡ç®—æ–‡ä»¶çš„æ¸…å•æ‘˜è¦æ˜¯ä¸€ä¸ªsha256sum å€¼</span><br><span class="line">  standalone-sign   # ä½¿ç”¨æœ¬åœ°æ–‡ä»¶åˆ›å»ºç­¾å</span><br><span class="line">  standalone-verify # éªŒè¯æœ¬åœ°æ–‡ä»¶çš„ç­¾å</span><br><span class="line">  sync              # å°†ä¸€ä¸ªæˆ–å¤šä¸ªå›¾åƒä»ä¸€ä¸ªä½ç½®åŒæ­¥åˆ°å¦ä¸€ä¸ªä½ç½® (è¯¥åŠŸèƒ½éå¸¸Nice)</span><br><span class="line">Flags:</span><br><span class="line">    --command-timeout duration   # å‘½ä»¤è¶…æ—¶æ—¶é—´(å•ä½ç§’)</span><br><span class="line">    --debug                      # å¯ç”¨debugæ¨¡å¼</span><br><span class="line">    --insecure-policy            # åœ¨ä¸è¿›è¡Œä»»ä½•ç­–ç•¥æ£€æŸ¥çš„æƒ…å†µä¸‹è¿è¡Œè¯¥å·¥å…·ï¼ˆå¦‚æœæ²¡æœ‰é…ç½® policy çš„è¯éœ€è¦åŠ ä¸Šè¯¥å‚æ•°ï¼‰</span><br><span class="line">    --override-arch ARCH         # å¤„ç†é•œåƒæ—¶è¦†ç›–å®¢æˆ·ç«¯ CPU ä½“ç³»æ¶æ„ï¼Œå¦‚åœ¨ amd64 çš„æœºå™¨ä¸Šç”¨ skopeo å¤„ç† arm64 çš„é•œåƒ</span><br><span class="line">    --override-os OS             # å¤„ç†é•œåƒæ—¶è¦†ç›–å®¢æˆ·ç«¯ OS</span><br><span class="line">    --override-variant VARIANT   # å¤„ç†é•œåƒæ—¶ä½¿ç”¨VARIANTè€Œä¸æ˜¯è¿è¡Œæ¶æ„å˜é‡</span><br><span class="line">    --policy string              # ä¿¡ä»»ç­–ç•¥æ–‡ä»¶çš„è·¯å¾„ (ä¸ºé•œåƒé…ç½®å®‰å…¨ç­–ç•¥æƒ…å†µä¸‹ä½¿ç”¨)</span><br><span class="line">    --registries.d DIR           # åœ¨ç›®å½•ä¸­ä½¿ç”¨Registryé…ç½®æ–‡ä»¶ï¼ˆä¾‹å¦‚ï¼Œç”¨äºå®¹å™¨ç­¾åå­˜å‚¨ï¼‰</span><br><span class="line">    --tmpdir string              # ç”¨äºå­˜å‚¨ä¸´æ—¶æ–‡ä»¶çš„ç›®å½•</span><br><span class="line">-h, --help                       help for skopeo </span><br><span class="line">-v, --version                    Version for Skopeo</span><br></pre></td></tr></table></figure><h3><span id="32-skopeo-åˆä½“éªŒ">3.2 Skopeo åˆä½“éªŒ</span></h3><p>æè¿°: åœ¨ä½¿ç”¨ä½“éªŒskopeoä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦äº†è§£ä¸€å“ˆ Skopeo å¯ä»¥åœ¨é‚£äº›å›¾åƒå’Œå­˜å‚¨åº“ç±»å‹ä¸Šæ‰§è¡Œé•œåƒæ“ä½œ(å®˜ç½‘æ–‡æ¡£èµ°ä¸€æ³¢)ï¼š</p><table><thead><tr><th style="text-align:center">Repository types</th><th>Describe</th><th>Example</th></tr></thead><tbody><tr><td style="text-align:center"><code>containers-storage:docker-reference</code></td><td>é€‚ç”¨äºåç«¯æ˜¯ Podman, CRI-O, Buildah çš„æƒ…å†µ</td><td><code>containers-storage:</code></td></tr><tr><td style="text-align:center"><code>dir:path</code></td><td>é€‚ç”¨äºå°†manifest, layer tarballs å’Œ signatures å­˜å‚¨ä¸ºå•ç‹¬æ–‡ä»¶çš„ç°æœ‰æœ¬åœ°ç›®å½•è·¯å¾„çš„æƒ…å†µ</td><td><code>dir:/tmp/alpine:latest</code></td></tr><tr><td style="text-align:center"><code>docker://docker-reference</code></td><td>é€‚ç”¨äºRegistryä¸­å®ç°&quot;Docker Registry HTTP API V2&quot;çš„é•œåƒçš„æƒ…å†µ</td><td><code>docker://harbor.weiyigeek.top/myblog:v2.8</code></td></tr><tr><td style="text-align:center"><code>docker-archive:path[:docker-reference]</code></td><td>é€‚ç”¨äºé‡‡ç”¨<code>docker save</code>å‘½ä»¤å¯¼å‡ºé•œåƒä»¥taræ ¼å¼å­˜å‚¨çš„æ–‡ä»¶çš„æƒ…å†µ</td><td><code>docker-archive:alpine.tar</code></td></tr><tr><td style="text-align:center"><code>docker-daemon:docker-reference</code></td><td>é€‚ç”¨äºå­˜å‚¨åœ¨ docker å®ˆæŠ¤è¿›ç¨‹å†…éƒ¨å­˜å‚¨ä¸­çš„å›¾åƒçš„æƒ…å†µ</td><td><code>docker-daemon:alpine:latest</code></td></tr><tr><td style="text-align:center"><code>oci:path:tag</code></td><td>é€‚ç”¨äºç¬¦åˆ&quot;Open Container Image Layout Specification&quot;çš„ç›®å½•ä¸­çš„å›¾åƒæ ‡è®°</td><td><code>oci:alpine:latest</code></td></tr></tbody></table><blockquote><p>æ¸©é¦¨æç¤º: åŒä¸€ä¸ªé•œåƒå­˜åœ¨çš„æ–¹å¼æœ‰å¯èƒ½ä¸åŒï¼Œä¸åŒç±»å‹æ–¹å¼å­˜å‚¨å¯¹é•œåƒçš„ layer å¤„ç†çš„æ–¹å¼ä¹Ÿä¸ä¸€æ ·,ã€‚</p></blockquote><p><strong>æµ‹è¯•ç¯å¢ƒè¯´æ˜</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Docker å®˜æ–¹ hub ä»“åº“ -&gt; docker.io             # å®˜ç½‘åœ°å€: https:&#x2F;&#x2F;hub.docker.com&#x2F;</span><br><span class="line">ç§æœ‰ Harbor ä»“åº“     -&gt; harbor.weiyigeek.top</span><br><span class="line">ä¸´æ—¶åˆ›å»ºçš„æœ¬åœ°ä»“åº“    -&gt; 192.168.12.111:5000   # ä¸€æ¢­å­è§£å†³: docker run -d -p 5000:5000 --name registry -v &#x2F;opt&#x2F;data&#x2F;registry:&#x2F;var&#x2F;lib&#x2F;registry registry:2</span><br></pre></td></tr></table></figure><blockquote><p>è¯´æ˜: ä¸Šè¿°ä»“åº“éƒ½æ˜¯åœ¨Registryä¸­æ”¯æŒDocker Registry HTTP API V2ç‰ˆæœ¬çš„ã€‚</p></blockquote><h4><span id="321-skopeo-loginloout-è¿œç¨‹ä»“åº“-auth">3.2.1 Skopeo login/loout - è¿œç¨‹ä»“åº“ Auth</span></h4><p>æè¿°: åœ¨ä½¿ç”¨ skopeo å‰å¦‚æœ src æˆ– dest é•œåƒæ˜¯åœ¨ registry ä»“åº“ä¸­çš„å¹¶ä¸”é…ç½®äº†é public çš„é•œåƒéœ€è¦ç›¸åº”çš„ auth è®¤è¯, æ­¤æ—¶æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>docker login</code> æˆ–è€… <code>skopeo login</code> çš„æ–¹å¼ç™»å½•åˆ° registry ä»“åº“ï¼Œç„¶åé»˜è®¤ä¼šåœ¨<code>~/.docker</code>ç›®å½•ä¸‹ç”Ÿæˆ registry ç™»å½•é…ç½®æ–‡ä»¶ config.json ,è¯¥æ–‡ä»¶é‡Œä¿å­˜äº†ç™»å½•éœ€è¦çš„éªŒè¯ä¿¡æ¯ï¼Œskopeo æ‹¿åˆ°è¯¥éªŒè¯ä¿¡æ¯æ‰æœ‰æƒé™å¾€ registry push é•œåƒã€‚</p><ul><li><strong>ç™»é™†è®¤è¯</strong></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"># (1) skopeo login ç™»é™†ç¤ºä¾‹ (ä¸¤ç§æ–¹å¼)</span><br><span class="line">$ skopeo login -u WeiyiGeek -p testpassword harbor.weiyigeek.top</span><br><span class="line">  # Login Succeeded!</span><br><span class="line"></span><br><span class="line"># (2) docker login ç™»é™†ç¤ºä¾‹</span><br><span class="line">$ docker login -u WeiyiGeek docker.io</span><br><span class="line">$ docker login -u WeiyiGeek harbor.weiyigeek.top</span><br><span class="line">$ docker login -u anonymous -p anonymous 192.168.12.111:5000  # å®é™…ä¸Šä¸´æ—¶ä»“åº“æ²¡æœ‰é…ç½®è®¤è¯, è´¦å·å¯†ç éšæ„å³å¯ã€‚</span><br><span class="line">  # WARNING! Using --password via the CLI is insecure. Use --password-stdin.</span><br><span class="line">  # WARNING! Your password will be stored unencrypted in &#x2F;root&#x2F;.docker&#x2F;config.json.</span><br><span class="line">  # Configure a credential helper to remove this warning. See</span><br><span class="line">  # https:&#x2F;&#x2F;docs.docker.com&#x2F;engine&#x2F;reference&#x2F;commandline&#x2F;login&#x2F;#credentials-store</span><br><span class="line">  # Login Succeeded</span><br><span class="line"></span><br><span class="line"># (3) docker login ç”Ÿæˆçš„ registry ç™»å½•é…ç½®æ–‡ä»¶ï¼ˆbase64ç¼–ç å®‰å…¨æ€§ä¸å¤šè¯´ï¼‰</span><br><span class="line">$ cat ~&#x2F;.docker&#x2F;config.json</span><br><span class="line">&#123;</span><br><span class="line">  &quot;auths&quot;: &#123;</span><br><span class="line">    &quot;192.168.12.111:5000&quot;: &#123;</span><br><span class="line">        &quot;auth&quot;: &quot;YW5v*******Q&#x3D;&#x3D;&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">    &quot;harbor.weiyigeek.top&quot;: &#123;</span><br><span class="line">        &quot;auth&quot;: &quot;YWR*******LkA&#x3D;&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">    &quot;https:&#x2F;&#x2F;index.docker.io&#x2F;v1&#x2F;&quot;: &#123;</span><br><span class="line">        &quot;auth&quot;: &quot;d2Vp**************kyZA&#x3D;&#x3D;&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>æ³¨é”€è®¤è¯</strong></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ skopeo logout myregistrydomain.com:5000</span><br></pre></td></tr></table></figure><blockquote><p>æ¸©é¦¨æç¤º: å¦‚æœä¼ä¸šè‡ªå»ºharborä»“åº“(ä¸€èˆ¬éƒ½ä¼šè®¾ç½®è‡ªç­¾è¯ä¹¦)æˆ–è€…å…¶å®ƒç§æœ‰ä»“åº“é…ç½®è¯ä¹¦,ä¸ºäº†é˜²æ­¢å‡ºé”™å»ºè®®è¿›è¡Œä»¥ä¸‹æ“ä½œ(æ­£å¼ç¯å¢ƒè¯·æ ¹æ®éœ€è¦è¿›è¡Œé…ç½®)ã€‚</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># (1) åœ¨ &#x2F;etc&#x2F;docker&#x2F;daemon.json ä¸­é…ç½® insecure-registries å­—æ®µ,è¡¨ç¤ºå…è®¸ä¸å®‰å…¨çš„ä»“åº“ã€‚</span><br><span class="line">&quot;insecure-registries&quot;: [&quot;harbor.weiyigeek.top&quot;,&quot;192.168.12.111:5000&quot;]</span><br><span class="line"> </span><br><span class="line"># (2) ä»å®˜æ–¹æ–‡æ¡£å¯çŸ¥å®¢æˆ·ç«¯è¦ä½¿ç”¨tlsä¸Harboré€šä¿¡ä½¿ç”¨çš„è¿˜æ˜¯&#96;è‡ªç­¾è¯ä¹¦&#96;ï¼Œé‚£ä¹ˆå¿…é¡»å»ºç«‹ä¸€ä¸ªç›®å½•ï¼š&#96;&#x2F;etc&#x2F;docker&#x2F;certs.d&#96;</span><br><span class="line"># å¦‚æœé…ç½®å¯èƒ½ä¼šå‡ºç° x509: certificate signed by unknown authority é”™è¯¯æç¤ºã€‚</span><br><span class="line">$ mkdir -vp &#x2F;etc&#x2F;docker&#x2F;certs.d&#x2F;harbor.weiyigeek.top</span><br><span class="line">$ cp -a &#x2F;deployapp&#x2F;harbor&#x2F;harbor.pem  &#x2F;etc&#x2F;docker&#x2F;certs.d&#x2F;harbor.weiyigeek.top&#x2F;harbor.crt</span><br></pre></td></tr></table></figure><blockquote><p>æ¸©é¦¨æç¤º: ä¸ºäº†é˜²æ­¢åç»­æ‰§è¡Œ skopeo å‘½ä»¤æ“ä½œé•œåƒæ—¶å‡ºé”™, å»ºè®®å¿½ç•¥ policy ç­–ç•¥å’Œè¯ä¹¦æ ¡éªŒå‚æ•°å¦‚ä¸‹:</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">--insecure-policy \</span><br><span class="line">--src-tls-verify&#x3D;false \ </span><br><span class="line">--dest-tls-verify&#x3D;false \</span><br></pre></td></tr></table></figure><h4><span id="322-skopeo-inspect-æ£€æŸ¥å­˜å‚¨åº“ä¸­çš„é•œåƒ">3.2.2 Skopeo inspect - æ£€æŸ¥å­˜å‚¨åº“ä¸­çš„é•œåƒ</span></h4><p>æè¿°: skopeo èƒ½å¤Ÿæ£€æŸ¥å®¹å™¨ Registry ä¸Šçš„å­˜å‚¨åº“å¹¶è·å–å›¾åƒå±‚ã€‚æ£€æŸ¥å‘½ä»¤è·å–å­˜å‚¨åº“çš„æ¸…å•ï¼Œå®ƒèƒ½å¤Ÿå‘æ‚¨æ˜¾ç¤ºæœ‰å…³æ•´ä¸ªå­˜å‚¨åº“æˆ–æ ‡ç­¾çš„ç±»ä¼¼ <code>docker inspect</code> çš„ json è¾“å‡ºã€‚ä¸ docker inspect ç›¸æ¯”,æ­¤å·¥å…·å¯å¸®åŠ©æ‚¨åœ¨æ‹‰å–å­˜å‚¨åº“æˆ–æ ‡ç­¾ä¹‹å‰æ”¶é›†æœ‰ç”¨çš„ä¿¡æ¯(ä½¿ç”¨ç£ç›˜ç©ºé—´), æ£€æŸ¥å‘½ä»¤å¯ä»¥å‘æ‚¨æ˜¾ç¤ºç»™å®šå­˜å‚¨åº“å¯ç”¨çš„æ ‡ç­¾ã€æ˜ åƒå…·æœ‰çš„æ ‡ç­¾ã€æ˜ åƒçš„åˆ›å»ºæ—¥æœŸå’Œæ“ä½œç³»ç»Ÿç­‰ã€‚</p><p>æ”¯æŒä¼ è¾“çš„ç±»å‹ : <code>containers-storage, dir, docker, docker-archive, docker-daemon, oci, oci-archive, ostree, tarball</code></p><ul><li>æ­¥éª¤ 01. æ˜¾ç¤º busybox:latest é•œåƒçš„å±æ€§ç›¸å…³ä¿¡æ¯ã€‚</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">$ skopeo inspect docker:&#x2F;&#x2F;docker.io&#x2F;busybox:latest</span><br><span class="line">&#123;</span><br><span class="line">  &quot;Name&quot;: &quot;docker.io&#x2F;library&#x2F;busybox&quot;,</span><br><span class="line">  &quot;Digest&quot;: &quot;sha256:5acba83a746c7608ed544dc1533b87c737a0b0fb730301639a0179f9344b1678&quot;,</span><br><span class="line">  &quot;RepoTags&quot;: [</span><br><span class="line">      &quot;1&quot;,</span><br><span class="line">      &quot;1-glibc&quot;,</span><br><span class="line">      &quot;1-musl&quot;,</span><br><span class="line">      &quot;1-ubuntu&quot;,</span><br><span class="line">      &quot;1-uclibc&quot;,</span><br><span class="line">      &quot;1.21-ubuntu&quot;,</span><br><span class="line">      &quot;1.21.0-ubuntu&quot;,</span><br><span class="line">        .......          # é•œåƒå†å²tags</span><br><span class="line">      &quot;unstable-uclibc&quot;</span><br><span class="line">  ],</span><br><span class="line">  &quot;Created&quot;: &quot;2021-12-30T19:19:41.006954958Z&quot;,</span><br><span class="line">  &quot;DockerVersion&quot;: &quot;20.10.7&quot;,</span><br><span class="line">  &quot;Labels&quot;: null,</span><br><span class="line">  &quot;Architecture&quot;: &quot;amd64&quot;,</span><br><span class="line">  &quot;Os&quot;: &quot;linux&quot;,</span><br><span class="line">  &quot;Layers&quot;: [</span><br><span class="line">      &quot;sha256:5cc84ad355aaa64f46ea9c7bbcc319a9d808ab15088a27209c9e70ef86e5a2aa&quot;</span><br><span class="line">  ],</span><br><span class="line">  &quot;Env&quot;: [</span><br><span class="line">      &quot;PATH&#x3D;&#x2F;usr&#x2F;local&#x2F;sbin:&#x2F;usr&#x2F;local&#x2F;bin:&#x2F;usr&#x2F;sbin:&#x2F;usr&#x2F;bin:&#x2F;sbin:&#x2F;bin&quot;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>æ­¥éª¤ 02. æ˜¾ç¤º busybox:latest é•œåƒçš„å®¹å™¨é…ç½®ç›¸å…³ä¿¡æ¯ã€‚</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">$ skopeo inspect --config docker:&#x2F;&#x2F;docker.io&#x2F;busybox:latest  | jq</span><br><span class="line">&#123;</span><br><span class="line">  &quot;created&quot;: &quot;2021-12-30T19:19:41.006954958Z&quot;,</span><br><span class="line">  &quot;architecture&quot;: &quot;amd64&quot;,</span><br><span class="line">  &quot;os&quot;: &quot;linux&quot;,</span><br><span class="line">  &quot;config&quot;: &#123;</span><br><span class="line">    &quot;Env&quot;: [</span><br><span class="line">      &quot;PATH&#x3D;&#x2F;usr&#x2F;local&#x2F;sbin:&#x2F;usr&#x2F;local&#x2F;bin:&#x2F;usr&#x2F;sbin:&#x2F;usr&#x2F;bin:&#x2F;sbin:&#x2F;bin&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;Cmd&quot;: [</span><br><span class="line">      &quot;sh&quot;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;rootfs&quot;: &#123;</span><br><span class="line">    &quot;type&quot;: &quot;layers&quot;,</span><br><span class="line">    &quot;diff_ids&quot;: [</span><br><span class="line">      &quot;sha256:01fd6df81c8ec7dd24bbbd72342671f41813f992999a3471b9d9cbc44ad88374&quot;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;history&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;created&quot;: &quot;2021-12-30T19:19:40.833034683Z&quot;,</span><br><span class="line">      &quot;created_by&quot;: &quot;&#x2F;bin&#x2F;sh -c #(nop) ADD file:6db446a57cbd2b7f4cfde1f280177b458390ed5a6d1b54c6169522bc2c4d838e in &#x2F; &quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;created&quot;: &quot;2021-12-30T19:19:41.006954958Z&quot;,</span><br><span class="line">      &quot;created_by&quot;: &quot;&#x2F;bin&#x2F;sh -c #(nop)  CMD [\&quot;sh\&quot;]&quot;,</span><br><span class="line">      &quot;empty_layer&quot;: true</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>æ­¥éª¤ 03. æ˜¾ç¤ºæœªç»éªŒè¯çš„å›¾åƒ Digestï¼ˆæ‘˜è¦ï¼‰</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ skopeo inspect --format &quot;Name: &#123;&#123;.Name&#125;&#125; Digest: &#123;&#123;.Digest&#125;&#125;&quot; docker:&#x2F;&#x2F;docker.io&#x2F;busybox:latest</span><br></pre></td></tr></table></figure><h4><span id="323-skopeo-copy-ä»“åº“é•œåƒæ‹·è´">3.2.3 Skopeo copy - ä»“åº“é•œåƒæ‹·è´</span></h4><p>æè¿°: skopeo å¯ä»¥åœ¨å„ç§å­˜å‚¨æœºåˆ¶ä¹‹é—´å¤åˆ¶å®¹å™¨é•œåƒï¼Œæ”¯æŒåŒ…æ‹¬å®¹å™¨ä»“åº“(<code>The Quay, Docker Hub, OpenShift, GCR, ï¼ŒArtifactory ...</code>)ä»¥åŠå®¹å™¨å­˜å‚¨åç«¯ (<code>Podman, CRI-O, Docker</code>) ç­‰ã€æœ¬åœ°ç›®å½•ã€æœ¬åœ° OCI-layout ç›®å½•ã€‚</p><p>ä¾‹å¦‚ï¼Œæ­¤å¤„æˆ‘ä» hub ä»“åº“å¤åˆ¶ <code>busybox:latest</code> é•œåƒåˆ°ç§æœ‰ harbor ä»“åº“ä¸­,åœ¨ä»ç§æœ‰ harbor ä»“åº“ä¸­æ‹·è´åˆ°æœ¬åœ°æŒ‡å®šç›®å½•ä¸­ã€‚</p><ul><li>æ­¥éª¤ 01. ä» regsitry A åˆ° registry B å¤åˆ¶ busybox:latest é•œåƒã€‚</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ skopeo copy --insecure-policy --src-tls-verify&#x3D;false --dest-tls-verify&#x3D;false --dest-authfile &#x2F;root&#x2F;.docker&#x2F;config.json docker:&#x2F;&#x2F;docker.io&#x2F;busybox:latest docker:&#x2F;&#x2F;harbor.weiyigeek.top&#x2F;devops&#x2F;busybox:latest</span><br><span class="line">  # Getting image source signatures</span><br><span class="line">  # Copying blob 5cc84ad355aa done</span><br><span class="line">  # Copying config beae173cca done</span><br><span class="line">  # Writing manifest to image destination</span><br><span class="line">  # Storing signatures</span><br></pre></td></tr></table></figure><blockquote><p>Tips: ç”±ä¸Šè¿°æ—¥å¿—å¯ä»¥çœ‹åˆ° skopeo æ˜¯ç›´æ¥ä» registry ä¸­ copy é•œåƒ layer çš„ blob æ–‡ä»¶ï¼Œä¼ è¾“æ˜¯é•œåƒåœ¨ registry ä¸­å­˜å‚¨çš„åŸå§‹æ ¼å¼ã€‚</p></blockquote><ul><li>æ­¥éª¤ 02. ä» registry B å¤åˆ¶ busybox:latest é•œåƒåˆ°æœ¬åœ° busybox:latest ç›®å½•ä¸­ã€‚</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">$ skopeo copy --insecure-policy --src-tls-verify&#x3D;false docker:&#x2F;&#x2F;harbor.weiyigeek.top&#x2F;devops&#x2F;busybox:latest dir:busybox:latest</span><br><span class="line"># Getting image source signatures</span><br><span class="line"># Copying blob 5cc84ad355aa done</span><br><span class="line"># Copying config beae173cca done</span><br><span class="line"># Writing manifest to image destination</span><br><span class="line"># Storing signatures</span><br><span class="line"></span><br><span class="line">$ ls &amp;&amp; tree busybox\:latest&#x2F;</span><br><span class="line">busybox:latest&#x2F;</span><br><span class="line">â”œâ”€â”€ 5cc84ad355aaa64f46ea9c7bbcc319a9d808ab15088a27209c9e70ef86e5a2aa   # blob å—æ–‡ä»¶ -&gt; vnd.docker.image.rootfs.diff.tar.gzip</span><br><span class="line">â”œâ”€â”€ beae173ccac6ad749f76713cf4440fe3d21d1043fe616dfbe30775815d1d0f6a   # é•œåƒé…ç½®ä¿¡æ¯æ–‡ä»¶ -&gt; vnd.docker.container.image.v1+json </span><br><span class="line">â”œâ”€â”€ manifest.json</span><br><span class="line">â””â”€â”€ version</span><br><span class="line">0 directories, 4 files</span><br><span class="line"></span><br><span class="line"># æŸ¥çœ‹é•œåƒçš„ manifest æ–‡ä»¶</span><br><span class="line">$ cat busybox\:latest&#x2F;manifest.json</span><br><span class="line">&#123;</span><br><span class="line">   &quot;schemaVersion&quot;: 2,</span><br><span class="line">   &quot;mediaType&quot;: &quot;application&#x2F;vnd.docker.distribution.manifest.v2+json&quot;,</span><br><span class="line">   &quot;config&quot;: &#123;</span><br><span class="line">      &quot;mediaType&quot;: &quot;application&#x2F;vnd.docker.container.image.v1+json&quot;,</span><br><span class="line">      &quot;size&quot;: 1456,</span><br><span class="line">      &quot;digest&quot;: &quot;sha256:beae173ccac6ad749f76713cf4440fe3d21d1043fe616dfbe30775815d1d0f6a&quot;</span><br><span class="line">   &#125;,</span><br><span class="line">   &quot;layers&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">         &quot;mediaType&quot;: &quot;application&#x2F;vnd.docker.image.rootfs.diff.tar.gzip&quot;,</span><br><span class="line">         &quot;size&quot;: 772788,</span><br><span class="line">         &quot;digest&quot;: &quot;sha256:5cc84ad355aaa64f46ea9c7bbcc319a9d808ab15088a27209c9e70ef86e5a2aa&quot;</span><br><span class="line">      &#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># æ ¹æ® manifest æ–‡ä»¶æŸ¥çœ‹é•œåƒçš„ image config æ–‡ä»¶ (å­˜æ”¾é•œåƒBuildæŒ‡ä»¤ä¸é•œåƒç›¸å…³é…ç½®ä¿¡æ¯)</span><br><span class="line">$ jq &#39;.&#39; busybox\:latest&#x2F;beae173ccac6ad749f76713cf4440fe3d21d1043fe616dfbe30775815d1d0f6a</span><br><span class="line">&#123;</span><br><span class="line">  &quot;architecture&quot;: &quot;amd64&quot;,</span><br><span class="line">  &quot;config&quot;: &#123;</span><br><span class="line">    &quot;Hostname&quot;: &quot;&quot;,</span><br><span class="line">    &quot;Domainname&quot;: &quot;&quot;,</span><br><span class="line">    &quot;User&quot;: &quot;&quot;,</span><br><span class="line">    &quot;AttachStdin&quot;: false,</span><br><span class="line">    &quot;AttachStdout&quot;: false,</span><br><span class="line">    &quot;AttachStderr&quot;: false,</span><br><span class="line">    &quot;Tty&quot;: false,</span><br><span class="line">    &quot;OpenStdin&quot;: false,</span><br><span class="line">    &quot;StdinOnce&quot;: false,</span><br><span class="line">    &quot;Env&quot;: [</span><br><span class="line">      &quot;PATH&#x3D;&#x2F;usr&#x2F;local&#x2F;sbin:&#x2F;usr&#x2F;local&#x2F;bin:&#x2F;usr&#x2F;sbin:&#x2F;usr&#x2F;bin:&#x2F;sbin:&#x2F;bin&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;Cmd&quot;: [</span><br><span class="line">      &quot;sh&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;Image&quot;: &quot;sha256:da658412c37aa24e561eb7e16c61bc82a9711340d8fb5cf1a8f39d8e96d7f723&quot;,</span><br><span class="line">    &quot;Volumes&quot;: null,</span><br><span class="line">    &quot;WorkingDir&quot;: &quot;&quot;,</span><br><span class="line">    &quot;Entrypoint&quot;: null,</span><br><span class="line">    &quot;OnBuild&quot;: null,</span><br><span class="line">    &quot;Labels&quot;: null</span><br><span class="line">  &#125;,</span><br><span class="line">........</span><br><span class="line">  &quot;history&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;created&quot;: &quot;2021-12-30T19:19:40.833034683Z&quot;,</span><br><span class="line">      &quot;created_by&quot;: &quot;&#x2F;bin&#x2F;sh -c #(nop) ADD file:6db446a57cbd2b7f4cfde1f280177b458390ed5a6d1b54c6169522bc2c4d838e in &#x2F; &quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;created&quot;: &quot;2021-12-30T19:19:41.006954958Z&quot;,</span><br><span class="line">      &quot;created_by&quot;: &quot;&#x2F;bin&#x2F;sh -c #(nop)  CMD [\&quot;sh\&quot;]&quot;,</span><br><span class="line">      &quot;empty_layer&quot;: true</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  &quot;os&quot;: &quot;linux&quot;,</span><br><span class="line">  &quot;rootfs&quot;: &#123;</span><br><span class="line">    &quot;type&quot;: &quot;layers&quot;,</span><br><span class="line">    &quot;diff_ids&quot;: [</span><br><span class="line">      &quot;sha256:01fd6df81c8ec7dd24bbbd72342671f41813f992999a3471b9d9cbc44ad88374&quot;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>æ­¥éª¤ 03. å°† busybox:latest é•œåƒä» registry B å¤åˆ¶åˆ°æœ¬åœ°ç›®å½•ï¼Œå¹¶ä»¥ OCI æ ¼å¼ä¿å­˜</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ skopeo copy --insecure-policy --src-tls-verify&#x3D;false docker:&#x2F;&#x2F;harbor.weiyigeek.top&#x2F;devops&#x2F;busybox:latest oci:busybox-latest</span><br><span class="line">  # Getting image source signatures</span><br><span class="line">  # Copying blob 5cc84ad355aa done</span><br><span class="line">  # Copying config 48edd9298a done</span><br><span class="line">  # Writing manifest to image destination</span><br><span class="line">  # Storing signatures</span><br><span class="line"></span><br><span class="line">$ tree -h busybox-latest&#x2F;</span><br><span class="line">  # busybox-latest&#x2F;</span><br><span class="line">  # â”œâ”€â”€ [4.0K]  blobs</span><br><span class="line">  # â”‚   â””â”€â”€ [4.0K]  sha256</span><br><span class="line">  # â”‚       â”œâ”€â”€ [ 347]  1612e16ff3f6b0d09eefdc4e9d5c5c0624f63032743e016585b095b958778016</span><br><span class="line">  # â”‚       â”œâ”€â”€ [ 575]  48edd9298a25de2c97cd574a5523026f87576c6b7202330a2b60ce7d304ec307</span><br><span class="line">  # â”‚       â””â”€â”€ [755K]  5cc84ad355aaa64f46ea9c7bbcc319a9d808ab15088a27209c9e70ef86e5a2aa  # Blob å— -</span><br><span class="line">  # â”œâ”€â”€ [ 186]  index.json</span><br><span class="line">  # â””â”€â”€ [  31]  oci-layout</span><br><span class="line">  # 2 directories, 5 files</span><br></pre></td></tr></table></figure><ul><li>æ­¥éª¤ 04. å°† <code>alpine:3.13.1</code> é•œåƒä» docker æœ¬åœ°å­˜å‚¨ï¼ˆ /var/lib/docker/imageï¼‰ push åˆ° registry Bä¸­(å®é™…ä¸Šæ›¿ä»£ docker push åŠŸèƒ½)</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># åœ¨  &#x2F;var&#x2F;lib&#x2F;docker&#x2F; ç›®å½•ä¸­æ­¤å¤„ä¸»è¦å…³å¿ƒ image (ä¸»è¦å­˜æ”¾é•œåƒä¸­layerå±‚çš„å…ƒæ•°æ®) å’Œ overlay2 (å„å±‚çš„å…·ä½“ä¿¡æ¯)</span><br><span class="line">$ docker images alpine:3.13.1</span><br><span class="line">  # REPOSITORY   TAG       IMAGE ID       CREATED         SIZE</span><br><span class="line">  # alpine       3.13.1    e50c909a8df2   11 months ago   5.61MB</span><br><span class="line"></span><br><span class="line">$ skopeo copy --insecure-policy --dest-tls-verify&#x3D;false --dest-authfile &#x2F;root&#x2F;.docker&#x2F;config.json docker-daemon:alpine:3.13.1 docker:&#x2F;&#x2F;harbor.weiyigeek.top&#x2F;devops&#x2F;alpine:3.13.1</span><br><span class="line">  # Getting image source signatures</span><br><span class="line">  # Copying blob 1119ff37d4a9 done</span><br><span class="line">  # Copying config e50c909a8d done</span><br><span class="line">  # Writing manifest to image destination</span><br><span class="line">  # Storing signatures</span><br></pre></td></tr></table></figure><p><img src="https://img.hi-linux.com/staticfile/640-20220520095506113-2022-05-20-jxlRy3.png" alt></p><h4><span id="324-skopeo-sync-é•œåƒåŒæ­¥å‘½ä»¤">3.2.4 Skopeo sync - é•œåƒåŒæ­¥å‘½ä»¤</span></h4><p>æè¿°: Skopeo syncå¯ä»¥åœ¨å®¹å™¨ä»“åº“å’Œæœ¬åœ°ç›®å½•ä¹‹é—´åŒæ­¥é•œåƒï¼Œå…¶åŠŸèƒ½ç±»ä¼¼äºé˜¿é‡Œäº‘çš„ image-syncer (<a href="https://github.com/AliyunContainerService/image-syncer" target="_blank" rel="noopener">https://github.com/AliyunContainerService/image-syncer</a>) å·¥å…·, å®é™…ä¸Šå…¶æ¯” image-syncer æ›´å¼ºå¤§ã€çµæ´»æ€§æ›´å¼ºä¸€äº›ï¼ŒåºŸè¯ä¸å¤šè¯´å®è·µä¸ºç‹ã€‚</p><p>skopeo sync é•œåƒåŒæ­¥æ–‡ä»¶ç¤ºä¾‹:</p><ul><li>æ­¥éª¤ 01. å°†ä»“åº“ä¸­æ‰€æœ‰ busybox é•œåƒç‰ˆæœ¬åŒæ­¥åˆ°æœ¬åœ°ç›®å½•ã€‚</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ skopeo sync --insecure-policy --src-tls-verify&#x3D;false --src docker --dest dir harbor.weiyigeek.top&#x2F;devops&#x2F;busybox &#x2F;tmp</span><br><span class="line">  # INFO[0000] Tag presence check                            imagename&#x3D;harbor.weiyigeek.top&#x2F;devops&#x2F;busybox tagged&#x3D;false</span><br><span class="line">  # INFO[0000] Getting tags                                  image&#x3D;harbor.weiyigeek.top&#x2F;devops&#x2F;busybox</span><br><span class="line">  # INFO[0000] Copying image ref 1&#x2F;1                         from&#x3D;&quot;docker:&#x2F;&#x2F;harbor.weiyigeek.top&#x2F;devops&#x2F;busybox:latest&quot; to&#x3D;&quot;dir:&#x2F;tmp&#x2F;busybox:latest&quot;</span><br><span class="line">  # Getting image source signatures</span><br><span class="line">  # Copying blob 5cc84ad355aa done</span><br><span class="line">  # Copying config beae173cca done</span><br><span class="line">  # Writing manifest to image destination</span><br><span class="line">  # Storing signatures</span><br><span class="line">  # INFO[0000] Synced 1 images from 1 sources</span><br><span class="line"></span><br><span class="line">$ tree -h &#x2F;tmp&#x2F;busybox:latest</span><br><span class="line">&#x2F;tmp&#x2F;busybox:latest</span><br><span class="line">â”œâ”€â”€ [755K]  5cc84ad355aaa64f46ea9c7bbcc319a9d808ab15088a27209c9e70ef86e5a2aa</span><br><span class="line">â”œâ”€â”€ [1.4K]  beae173ccac6ad749f76713cf4440fe3d21d1043fe616dfbe30775815d1d0f6a</span><br><span class="line">â”œâ”€â”€ [ 527]  manifest.json</span><br><span class="line">â””â”€â”€ [  33]  version</span><br><span class="line">0 directories, 4 files</span><br></pre></td></tr></table></figure><ul><li>æ­¥éª¤ 02. ä»æœ¬åœ°ç›®å½• <code>/tmp/</code> åŒæ­¥åˆ° docker çš„ hub å®¹å™¨ä»“åº“ä¸­ï¼Œæ­¤å¤–æˆ‘ä»¬å¯ä»¥é€šè¿‡æµè§ˆå™¨çœ‹åˆ° <code>weiyigeek</code> ç”¨æˆ·ä¸‹çš„ <code>busybox</code> é•œåƒ (<a href="https://hub.docker.com/u/weiyigeek" target="_blank" rel="noopener">https://hub.docker.com/u/weiyigeek</a>)ã€‚</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ skopeo sync --insecure-policy --dest-tls-verify&#x3D;false --src dir --dest docker &#x2F;tmp weiyigeek</span><br><span class="line">  # INFO[0000] Copying image ref 1&#x2F;1                         from&#x3D;&quot;dir:&#x2F;tmp&#x2F;busybox:latest&quot; to&#x3D;&quot;docker:&#x2F;&#x2F;weiyigeek&#x2F;busybox:latest&quot;</span><br><span class="line">  # Getting image source signatures</span><br><span class="line">  # Copying blob 5cc84ad355aa skipped: already exists</span><br><span class="line">  # Copying config beae173cca done</span><br><span class="line">  # Writing manifest to image destination</span><br><span class="line">  # Storing signatures</span><br><span class="line">  # INFO[0021] Synced 1 images from 1 sources</span><br></pre></td></tr></table></figure><p><img src="https://img.hi-linux.com/staticfile/640-20220520095506152-2022-05-20-wOfOkf.png" alt></p><ul><li>æ­¥éª¤ 03. ä» hub å®¹å™¨ä»“åº“ä¸­åŒæ­¥ alpine-jenkins-jnlp:v2.285 é•œåƒåˆ°æœ¬åœ°ä¸´æ—¶å®¹å™¨ä»“åº“ä¸­ã€‚</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ skopeo sync --insecure-policy --src-tls-verify&#x3D;false --dest-tls-verify&#x3D;false --src docker --dest docker weiyigeek&#x2F;alpine-jenkins-jnlp:v2.285 192.168.12.111:5000&#x2F;</span><br><span class="line">  # INFO[0000] Tag presence check imagename&#x3D;&quot;weiyigeek&#x2F;alpine-jenkins-jnlp:v2.285&quot; tagged&#x3D;true</span><br><span class="line">  # INFO[0000] Copying image ref 1&#x2F;1 from&#x3D;&quot;docker:&#x2F;&#x2F;weiyigeek&#x2F;alpine-jenkins-jnlp:v2.285&quot; to&#x3D;&quot;docker:&#x2F;&#x2F;192.168.12.111:5000&#x2F;alpine-jenkins-jnlp:v2.285&quot;</span><br><span class="line">  # Getting image source signatures</span><br><span class="line">  # Copying blob 68517a8c32d3 [&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&gt;-------------------------------] 45.0MiB &#x2F; 255.7MiB</span><br><span class="line">  # Copying blob 4c0d98bf9879 done</span><br></pre></td></tr></table></figure><ul><li>æ­¥éª¤ 04. ä»¥é…ç½®æ–‡ä»¶æ–¹å¼è¿›è¡ŒåŒæ­¥, é¦–å…ˆæˆ‘ä»¬éœ€è¦å‡†å¤‡ä¸€ä¸ªéœ€è¦åŒæ­¥çš„èµ„æºæ¸…å•ã€‚</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># YAML æ–‡ä»¶å†…å®¹ï¼ˆç”¨äº **--src yaml** çš„æºï¼‰</span><br><span class="line">$ cat &lt;&lt;&#39;EOF&#39; &gt; skopeo-sync.yml</span><br><span class="line">registry.example.com:</span><br><span class="line">  images:</span><br><span class="line">    busybox: []</span><br><span class="line">    redis:</span><br><span class="line">      - &quot;1.0&quot;</span><br><span class="line">      - &quot;2.0&quot;</span><br><span class="line">      - &quot;sha256:111111&quot;</span><br><span class="line">  images-by-tag-regex:</span><br><span class="line">      nginx: ^1\.13\.[12]-alpine-perl$</span><br><span class="line">  credentials:</span><br><span class="line">      username: john</span><br><span class="line">      password: this is a secret</span><br><span class="line">  tls-verify: true</span><br><span class="line">  cert-dir: &#x2F;home&#x2F;john&#x2F;certs</span><br><span class="line">quay.io:</span><br><span class="line">  tls-verify: false</span><br><span class="line">  images:</span><br><span class="line">    coreos&#x2F;etcd:</span><br><span class="line">      - latest</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"># ä»¥yamlæ–‡ä»¶æ–¹å¼è¿›è¡ŒåŒæ­¥é•œåƒåˆ° my-registry.local.lan&#x2F;repo&#x2F; ä»“åº“ä¸­</span><br><span class="line">$ skopeo sync --src yaml --dest docker skopeo-sync.yml my-registry.local.lan&#x2F;repo&#x2F;</span><br></pre></td></tr></table></figure><p>skopeo-sync.yml æ–‡ä»¶ä¸­é•œåƒåŒ¹é…å¤åˆ¶é•œåƒè¯´æ˜:</p><ul><li><a href="http://registry.example.com/busybox" target="_blank" rel="noopener">registry.example.com/busybox</a> : æ‰€æœ‰ç‰ˆæœ¬çš„é•œåƒ.</li><li><a href="http://registry.example.com/redis" target="_blank" rel="noopener">registry.example.com/redis</a> : æ ‡è®°ä¸ºâ€œ1.0â€å’Œâ€œ2.0â€çš„å›¾åƒä»¥åŠå¸¦æœ‰æ‘˜è¦çš„å›¾åƒ&quot;sha256:0000000000000000000000000000000011111111111111111111111111111111&quot;.</li><li><a href="http://registry.example.com/nginx" target="_blank" rel="noopener">registry.example.com/nginx</a> : å›¾ç‰‡æ ‡è®°ä¸ºâ€œ1.13.1-alpine-perlâ€å’Œâ€œ1.13.2-alpine-perlâ€.</li><li><a href="http://quay.io/coreos/etcd" target="_blank" rel="noopener">quay.io/coreos/etcd</a> : æ‹‰å–æœ€æ–°ç‰ˆæœ¬çš„é•œåƒã€‚</li></ul><h4><span id="325-skopeo-list-tags-ä»“åº“ä¸­é•œåƒ-tag-æŸ¥çœ‹">3.2.5 Skopeo list-tags - ä»“åº“ä¸­é•œåƒ Tag æŸ¥çœ‹</span></h4><p>æè¿°: åˆ©ç”¨è¯¥å‘½ä»¤æˆ‘ä»¬å¯ä»¥åˆ—å‡º registry ä¸Šçš„æŸä¸ªé•œåƒçš„æ‰€æœ‰ tag ï¼Œå®ƒæ˜¯ä½¿ç”¨æ ‡å‡†çš„ registry API æ¥è·å–é•œåƒ tagã€‚</p><p>ç®€å•ç¤ºä¾‹:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ skopeo list-tags docker:&#x2F;&#x2F;harbor.weiyigeek.top&#x2F;devops&#x2F;busybox:latest</span><br></pre></td></tr></table></figure><h4><span id="326-skopeo-delete-åˆ é™¤ä»“åº“ä¸­é•œåƒ-tag">3.2.6 Skopeo delete - åˆ é™¤ä»“åº“ä¸­é•œåƒ Tag</span></h4><p>æè¿°: ä½¿ç”¨è¯¥å‘½ä»¤æˆ‘ä»¬å¯ä»¥åˆ é™¤é•œåƒ Tag,æ³¨æ„æ­¤å¤„ä»…ä»…åªæ˜¯é€šè¿‡ registry API æ¥åˆ é™¤é•œåƒçš„ tagï¼ˆå³åˆ é™¤äº† tag å¯¹ manifests æ–‡ä»¶çš„å¼•ç”¨ï¼‰å¹¶éçœŸæ­£å°†é•œåƒåˆ é™¤æ‰ï¼Œå¦‚æœæƒ³è¦åˆ é™¤é•œåƒçš„ layer è¿˜æ˜¯éœ€è¦é€šè¿‡ registry GC çš„æ–¹å¼ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"># æ–¹å¼1. åˆ©ç”¨ skopeo delete</span><br><span class="line">$ skopeo delete docker:&#x2F;&#x2F;harbor.weiyigeek.top&#x2F;devops&#x2F;busybox:latest --debug</span><br><span class="line">  # DEBU[0000] Loading registries configuration &quot;&#x2F;etc&#x2F;containers&#x2F;registries.conf&quot;</span><br><span class="line">  # DEBU[0000] Found credentials for harbor.weiyigeek.top in credential helper containers-auth.json in file &#x2F;home&#x2F;weiyigeek&#x2F;.docker&#x2F;config.json</span><br><span class="line">  # DEBU[0000] Using registries.d directory &#x2F;etc&#x2F;containers&#x2F;registries.d for sigstore configuration</span><br><span class="line">  # DEBU[0000]  No signature storage configuration found for harbor.weiyigeek.top&#x2F;devops&#x2F;busybox:latest, using built-in default file:&#x2F;&#x2F;&#x2F;home&#x2F;weiyigeek&#x2F;.local&#x2F;share&#x2F;containers&#x2F;sigstore</span><br><span class="line">  # DEBU[0000] Looking for TLS certificates and private keys in &#x2F;etc&#x2F;docker&#x2F;certs.d&#x2F;harbor.weiyigeek.top</span><br><span class="line">  # DEBU[0000]  crt: &#x2F;etc&#x2F;docker&#x2F;certs.d&#x2F;harbor.weiyigeek.top&#x2F;harbor.crt</span><br><span class="line">  # DEBU[0000] GET https:&#x2F;&#x2F;harbor.weiyigeek.top&#x2F;v2&#x2F;</span><br><span class="line">  # DEBU[0000] Ping https:&#x2F;&#x2F;harbor.weiyigeek.top&#x2F;v2&#x2F; status 401</span><br><span class="line">  # DEBU[0000] GET https:&#x2F;&#x2F;harbor.weiyigeek.top&#x2F;service&#x2F;token?account&#x3D;WeiyiGeek&amp;scope&#x3D;repository%3Adevops%2Fbusybox%3A%2A&amp;service&#x3D;harbor-registry</span><br><span class="line">  # DEBU[0000] GET https:&#x2F;&#x2F;harbor.weiyigeek.top&#x2F;v2&#x2F;devops&#x2F;busybox&#x2F;manifests&#x2F;latest</span><br><span class="line">  # DEBU[0000] DELETE https:&#x2F;&#x2F;harbor.weiyigeek.top&#x2F;v2&#x2F;devops&#x2F;busybox&#x2F;manifests&#x2F;sha256:62ffc2ed7554e4c6d360bce40bbcf196573dd27c4ce080641a2c59867e732dee</span><br><span class="line">  # DEBU[0000] Deleting &#x2F;home&#x2F;weiyigeek&#x2F;.local&#x2F;share&#x2F;containers&#x2F;sigstore&#x2F;devops&#x2F;busybox@sha256&#x3D;62ffc2ed7554e4c6d360bce40bbcf196573dd27c4ce080641a2c59867e732dee&#x2F;signature-1</span><br><span class="line"></span><br><span class="line"># æ–¹å¼2.åˆ©ç”¨ curl å‘½ä»¤è¿›è¡Œ registery è¿›è¡Œåˆ é™¤ Tagã€‚</span><br><span class="line">$ curl --header &quot;Accept: application&#x2F;vnd.docker.distribution.manifest.v2+json&quot; -I -X GET http:&#x2F;&#x2F;192.168.12.111:5000&#x2F;v2&#x2F;busybox&#x2F;manifests&#x2F;latest</span><br><span class="line">  # HTTP&#x2F;1.1 200 OK</span><br><span class="line">  # Content-Length: 527</span><br><span class="line">  # Content-Type: application&#x2F;vnd.docker.distribution.manifest.v2+json</span><br><span class="line">  # Docker-Content-Digest: sha256:62ffc2ed7554e4c6d360bce40bbcf196573dd27c4ce080641a2c59867e732dee</span><br><span class="line">  # Docker-Distribution-Api-Version: registry&#x2F;2.0</span><br><span class="line">  # Etag: &quot;sha256:62ffc2ed7554e4c6d360bce40bbcf196573dd27c4ce080641a2c59867e732dee&quot;</span><br><span class="line">  # X-Content-Type-Options: nosniff</span><br><span class="line">  # Date: Thu, 20 Jan 2022 13:18:28 GMT</span><br><span class="line"></span><br><span class="line"># ä¸€æŠŠæ¢­ç»‡æå®š</span><br><span class="line">$ Docker-Content-Digest&#x3D;$(curl -s --header &quot;Accept: application&#x2F;vnd.docker.distribution.manifest.v2+json&quot; -I -X GET http:&#x2F;&#x2F;192.168.12.111:5000&#x2F;v2&#x2F;busybox&#x2F;manifests&#x2F;latest | grep &quot;Docker-Content-Digest&quot; | cut -d &#39; &#39; -f 2)</span><br><span class="line">$ curl -I -X DELETE http:&#x2F;&#x2F;192.168.12.111:5000&#x2F;v2&#x2F;busybox&#x2F;manifests&#x2F;$&#123;Docker-Content-Digest&#125;</span><br></pre></td></tr></table></figure><h2><span id="4-é•œåƒåŒæ­¥æœ€ä½³å®è·µ">4. é•œåƒåŒæ­¥æœ€ä½³å®è·µ</span></h2><p>æœ¬èŠ‚ï¼Œä¸»è¦å‚è€ƒæˆ‘å‰åŒäº‹æœ¨å­.å…¶åšå®¢åœ°å€(<a href="https://blog.k8s.li" target="_blank" rel="noopener">https://blog.k8s.li</a>)ã€‚</p><h3><span id="41-æŒ‡å®šæ–‡æœ¬ä¸­é•œåƒåŒæ­¥">4.1 æŒ‡å®šæ–‡æœ¬ä¸­é•œåƒåŒæ­¥</span></h3><p>å‡å¦‚,ç»™ä½ ä¸€ä¸ªé•œåƒåˆ—è¡¨ images-list.txt, å…¶æ ¼å¼å¦‚ä¸‹, æˆ‘ä»¬å¯ä»¥ç›´æ¥é‡‡ç”¨ shell è„šæœ¬è°ƒç”¨ skopeo è¿›è¡Œæ‰§è¡Œã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># images-list.txt</span><br><span class="line">cat &lt;&lt;&#39;EOF&#39; &gt; images-list.txt</span><br><span class="line">kubesphere&#x2F;kube-apiserver:v1.20.6</span><br><span class="line">kubesphere&#x2F;kube-scheduler:v1.20.6</span><br><span class="line">kubesphere&#x2F;kube-proxy:v1.20.6</span><br><span class="line">kubesphere&#x2F;kube-controller-manager:v1.20.6</span><br><span class="line">kubesphere&#x2F;kube-apiserver:v1.19.8</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><ul><li><strong>åŒæ­¥çš„ shell è„šæœ¬ <a href="http://skopeo-copy.sh" target="_blank" rel="noopener">skopeo-copy.sh</a></strong></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">GREEN_COL&#x3D;&quot;\\033[32;1m&quot;</span><br><span class="line">RED_COL&#x3D;&quot;\\033[1;31m&quot;</span><br><span class="line">NORMAL_COL&#x3D;&quot;\\033[0;39m&quot;</span><br><span class="line"></span><br><span class="line">SOURCE_REGISTRY&#x3D;$1</span><br><span class="line">TARGET_REGISTRY&#x3D;$2</span><br><span class="line"></span><br><span class="line"># shell å˜é‡èµ‹å€¼ï¼Œå½“æ²¡æœ‰ä»å‘½ä»¤è¡Œä¸­ä¼ é€’å€¼ç»™SOURCE_REGISTRYå’ŒTARGET_REGISTRYå˜é‡æ—¶ï¼Œä¾¿é‡‡ç”¨ä¸‹è¿°å€¼è¿›è¡Œè¦†ç›–ã€‚</span><br><span class="line">: $&#123;IMAGES_LIST_FILE:&#x3D;&quot;images-list.txt&quot;&#125;</span><br><span class="line">: $&#123;TARGET_REGISTRY:&#x3D;&quot;hub.k8s.li&quot;&#125;</span><br><span class="line">: $&#123;SOURCE_REGISTRY:&#x3D;&quot;docker.io&quot;&#125;</span><br><span class="line"></span><br><span class="line">BLOBS_PATH&#x3D;&quot;docker&#x2F;registry&#x2F;v2&#x2F;blobs&#x2F;sha256&quot;</span><br><span class="line">REPO_PATH&#x3D;&quot;docker&#x2F;registry&#x2F;v2&#x2F;repositories&quot;</span><br><span class="line"></span><br><span class="line">set -eo pipefail</span><br><span class="line"></span><br><span class="line">CURRENT_NUM&#x3D;0</span><br><span class="line">ALL_IMAGES&#x3D;&quot;$(sed -n &#39;&#x2F;#&#x2F;d;s&#x2F;:&#x2F;:&#x2F;p&#39; $&#123;IMAGES_LIST_FILE&#125; | sort -u)&quot;</span><br><span class="line">TOTAL_NUMS&#x3D;$(echo &quot;$&#123;ALL_IMAGES&#125;&quot; | wc -l)</span><br><span class="line"></span><br><span class="line"># shopeo æ‹·è´å‡½æ•°ï¼Œæ³¨æ„å…¶ä¼ é€’çš„å‚æ•°ï¼Œæ­¤å¤„å€¼å¾—å­¦ä¹ è®°å½•ã€‚</span><br><span class="line">skopeo_copy() &#123;</span><br><span class="line"> if skopeo copy --insecure-policy --src-tls-verify&#x3D;false --dest-tls-verify&#x3D;false \</span><br><span class="line"> --override-arch amd64 --override-os linux -q docker:&#x2F;&#x2F;$1 docker:&#x2F;&#x2F;$2; then</span><br><span class="line">  echo -e &quot;$GREEN_COL Progress: $&#123;CURRENT_NUM&#125;&#x2F;$&#123;TOTAL_NUMS&#125; sync $1 to $2 successful $NORMAL_COL&quot;</span><br><span class="line"> else</span><br><span class="line">  echo -e &quot;$RED_COL Progress: $&#123;CURRENT_NUM&#125;&#x2F;$&#123;TOTAL_NUMS&#125; sync $1 to $2 failed $NORMAL_COL&quot;</span><br><span class="line">  exit 2</span><br><span class="line"> fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># è°ƒç”¨æ‹·è´å‡½æ•°å¹¶è®°å½•å½“å‰æ‰§è¡Œåºå·ã€‚</span><br><span class="line">for image in $&#123;ALL_IMAGES&#125;; do</span><br><span class="line"> let CURRENT_NUM&#x3D;$&#123;CURRENT_NUM&#125;+1</span><br><span class="line"> skopeo_copy $&#123;SOURCE_REGISTRY&#125;&#x2F;$&#123;image&#125; $&#123;TARGET_REGISTRY&#125;&#x2F;$&#123;image&#125;</span><br><span class="line">done</span><br></pre></td></tr></table></figure><ul><li><strong>æ‰§è¡Œå‘½ä»¤å’Œç»“æœ:</strong></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ bash sync.sh docker.io localhost:5000</span><br><span class="line">Progress: 1&#x2F;143 sync docker.io&#x2F;alpine:3.14 to localhost:5000&#x2F;alpine:3.14 successful</span><br><span class="line">Progress: 2&#x2F;143 sync docker.io&#x2F;busybox:1.31.1 to localhost:5000&#x2F;busybox:1.31.1 successful</span><br><span class="line">....</span><br><span class="line">Progress: 142&#x2F;143 sync docker.io&#x2F;weaveworks&#x2F;scope:1.13.0 to localhost:5000&#x2F;weaveworks&#x2F;scope:1.13.0 successful</span><br><span class="line">Progress: 143&#x2F;143 sync docker.io&#x2F;wordpress:4.8-apache to localhost:5000&#x2F;wordpress:4.8-apache successful</span><br></pre></td></tr></table></figure><h3><span id="42-ä½¿ç”¨-registry-å­˜å‚¨ç‰¹æ€§åŒæ­¥">4.2 ä½¿ç”¨ registry å­˜å‚¨ç‰¹æ€§åŒæ­¥</span></h3><p>æè¿°: å°†é•œåƒä» registry ä¸­åŒæ­¥åˆ°æœ¬åœ°ç›®å½•ï¼Œä½¿ç”¨ registry å­˜å‚¨çš„ç‰¹æ€§ï¼Œå°†æœ¬åœ°ç›®å½•ä¸­çš„é•œåƒè½¬æ¢æˆ registry å­˜å‚¨çš„æ ¼å¼, è¿™æ ·çš„å¥½å¤„å°±æ˜¯å¯ä»¥å»é™¤ä¸€äº› skopeo dir ä¸­é‡å¤çš„ layersï¼Œå‡å°‘é•œåƒçš„æ€»å¤§å°ã€‚</p><ul><li><a href="http://convert-images.sh" target="_blank" rel="noopener">convert-images.sh</a></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">set -eo pipefail</span><br><span class="line"></span><br><span class="line">GREEN_COL&#x3D;&quot;\\033[32;1m&quot;</span><br><span class="line">RED_COL&#x3D;&quot;\\033[1;31m&quot;</span><br><span class="line">NORMAL_COL&#x3D;&quot;\\033[0;39m&quot;</span><br><span class="line"></span><br><span class="line"># å‘½ä»¤è¡Œå‚æ•°</span><br><span class="line">SOURCE_REGISTRY&#x3D;$1</span><br><span class="line">TARGET_REGISTRY&#x3D;$2</span><br><span class="line">IMAGES_DIR&#x3D;$2</span><br><span class="line"></span><br><span class="line">: $&#123;IMAGES_DIR:&#x3D;&quot;images&quot;&#125;</span><br><span class="line">: $&#123;IMAGES_LIST_FILE:&#x3D;&quot;images-list.txt&quot;&#125;</span><br><span class="line">: $&#123;SOURCE_REGISTRY:&#x3D;&quot;docker.io&quot;&#125;</span><br><span class="line">: $&#123;TARGET_REGISTRY:&#x3D;&quot;hub.k8s.li&quot;&#125;</span><br><span class="line"></span><br><span class="line"># hub.k8s.li ä»“åº“æœåŠ¡å™¨ä¸­çš„ç›®å½•</span><br><span class="line">BLOBS_PATH&#x3D;&quot;docker&#x2F;registry&#x2F;v2&#x2F;blobs&#x2F;sha256&quot;</span><br><span class="line">REPO_PATH&#x3D;&quot;docker&#x2F;registry&#x2F;v2&#x2F;repositories&quot;</span><br><span class="line"></span><br><span class="line"># è®°å½•å½“å‰æ•°å’Œæ€»é•œåƒæ•°</span><br><span class="line">CURRENT_NUM&#x3D;0</span><br><span class="line">ALL_IMAGES&#x3D;&quot;$(sed -n &#39;&#x2F;#&#x2F;d;s&#x2F;:&#x2F;:&#x2F;p&#39; $&#123;IMAGES_LIST_FILE&#125; | sort -u)&quot;</span><br><span class="line">TOTAL_NUMS&#x3D;$(echo &quot;$&#123;ALL_IMAGES&#125;&quot; | wc -l)</span><br><span class="line"></span><br><span class="line"># ä»è¿œç¨‹ä»“åº“åŒæ­¥æŒ‡å®šé•œåƒåˆ°æœ¬åœ°ç›®å½•ä¸­ã€‚</span><br><span class="line">skopeo_sync() &#123;</span><br><span class="line"> if skopeo sync --insecure-policy --src-tls-verify&#x3D;false --dest-tls-verify&#x3D;false \</span><br><span class="line"> --override-arch amd64 --override-os linux --src docker --dest dir $1 $2 &gt; &#x2F;dev&#x2F;null; then</span><br><span class="line">  echo -e &quot;$GREEN_COL Progress: $&#123;CURRENT_NUM&#125;&#x2F;$&#123;TOTAL_NUMS&#125; sync $1 to $2 successful $NORMAL_COL&quot;</span><br><span class="line"> else</span><br><span class="line">  echo -e &quot;$RED_COL Progress: $&#123;CURRENT_NUM&#125;&#x2F;$&#123;TOTAL_NUMS&#125; sync $1 to $2 failed $NORMAL_COL&quot;</span><br><span class="line">  exit 2</span><br><span class="line"> fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">convert_images() &#123;</span><br><span class="line"> rm -rf $&#123;IMAGES_DIR&#125;; mkdir -p $&#123;IMAGES_DIR&#125;</span><br><span class="line"> for image in $&#123;ALL_IMAGES&#125;; do</span><br><span class="line">  let CURRENT_NUM&#x3D;$&#123;CURRENT_NUM&#125;+1</span><br><span class="line">  </span><br><span class="line">  # å– images-list.txt æ–‡æœ¬ä¸­çš„æ¯ä¸€è¡Œï¼Œå¹¶åˆ†éš”å­˜å‚¨ã€‚</span><br><span class="line">  image_name&#x3D;$&#123;image%%:*&#125;</span><br><span class="line">  image_tag&#x3D;$&#123;image##*:&#125;</span><br><span class="line">  image_repo&#x3D;$&#123;image%%&#x2F;*&#125;</span><br><span class="line"></span><br><span class="line">  # å‡½æ•°è°ƒç”¨ ä»ä»“åº“åŒæ­¥é•œåƒåˆ°æœ¬åœ°imagesç›®å½•</span><br><span class="line">  skopeo_sync $&#123;SOURCE_REGISTRY&#125;&#x2F;$&#123;image&#125; $&#123;IMAGES_DIR&#125;&#x2F;$&#123;image_repo&#125;</span><br><span class="line"></span><br><span class="line">  # åœ¨æœ¬åœ°imagesç›®å½•ä¸­ï¼Œå–å¾—get image manifest sha256sum ä¿¡æ¯</span><br><span class="line">  manifest&#x3D;&quot;$&#123;IMAGES_DIR&#125;&#x2F;$&#123;image&#125;&#x2F;manifest.json&quot;</span><br><span class="line">  manifest_sha256&#x3D;$(sha256sum $&#123;manifest&#125; | awk &#39;&#123;print $1&#125;&#39;)      # 62ffc2ed7554e4c6d360bce40bbcf196573dd27c4ce080641a2c59867e732dee</span><br><span class="line">  mkdir -p $&#123;BLOBS_PATH&#125;&#x2F;$&#123;manifest_sha256:0:2&#125;&#x2F;$&#123;manifest_sha256&#125; # docker&#x2F;registry&#x2F;v2&#x2F;blobs&#x2F;sha256&#x2F;62&#x2F;62ffc2ed7554e4c6d360bce40bbcf196573dd27c4ce080641a2c59867e732dee</span><br><span class="line">  ln -f $&#123;manifest&#125; $&#123;BLOBS_PATH&#125;&#x2F;$&#123;manifest_sha256:0:2&#125;&#x2F;$&#123;manifest_sha256&#125;&#x2F;data  #  è¯¥ data æ–‡ä»¶å®é™…ä¸Šæ˜¯é•œåƒçš„ manifest.json æ–‡ä»¶ã€‚</span><br><span class="line"></span><br><span class="line">  # make image repositories dir</span><br><span class="line">  mkdir -p $&#123;REPO_PATH&#125;&#x2F;$&#123;image_name&#125;&#x2F;&#123;_uploads,_layers,_manifests&#125;</span><br><span class="line">  mkdir -p $&#123;REPO_PATH&#125;&#x2F;$&#123;image_name&#125;&#x2F;_manifests&#x2F;revisions&#x2F;sha256&#x2F;$&#123;manifest_sha256&#125;</span><br><span class="line">  mkdir -p $&#123;REPO_PATH&#125;&#x2F;$&#123;image_name&#125;&#x2F;_manifests&#x2F;tags&#x2F;$&#123;image_tag&#125;&#x2F;&#123;current,index&#x2F;sha256&#125;</span><br><span class="line">  mkdir -p $&#123;REPO_PATH&#125;&#x2F;$&#123;image_name&#125;&#x2F;_manifests&#x2F;tags&#x2F;$&#123;image_tag&#125;&#x2F;index&#x2F;sha256&#x2F;$&#123;manifest_sha256&#125;</span><br><span class="line"></span><br><span class="line">  # create image tag manifest link file</span><br><span class="line">  echo -n &quot;sha256:$&#123;manifest_sha256&#125;&quot; &gt; $&#123;REPO_PATH&#125;&#x2F;$&#123;image_name&#125;&#x2F;_manifests&#x2F;revisions&#x2F;sha256&#x2F;$&#123;manifest_sha256&#125;&#x2F;link  # sha256:62ffc2ed7554e4c6d360bce40bbcf196573dd27c4ce080641a2c59867e732deer</span><br><span class="line">  echo -n &quot;sha256:$&#123;manifest_sha256&#125;&quot; &gt; $&#123;REPO_PATH&#125;&#x2F;$&#123;image_name&#125;&#x2F;_manifests&#x2F;tags&#x2F;$&#123;image_tag&#125;&#x2F;current&#x2F;link</span><br><span class="line">  echo -n &quot;sha256:$&#123;manifest_sha256&#125;&quot; &gt; $&#123;REPO_PATH&#125;&#x2F;$&#123;image_name&#125;&#x2F;_manifests&#x2F;tags&#x2F;$&#123;image_tag&#125;&#x2F;index&#x2F;sha256&#x2F;$&#123;manifest_sha256&#125;&#x2F;link</span><br><span class="line"></span><br><span class="line">  # link image layers file to registry blobs dir</span><br><span class="line">  for layer in $(sed &#39;&#x2F;v1Compatibility&#x2F;d&#39; $&#123;manifest&#125; | grep -Eo &quot;\b[a-f0-9]&#123;64&#125;\b&quot;); do  # åŒ¹é… manifest.json ä¸­&quot;digest&quot;ä¸¤ä¸ªä¸å¸¦sha256çš„å€¼</span><br><span class="line">    mkdir -p $&#123;BLOBS_PATH&#125;&#x2F;$&#123;layer:0:2&#125;&#x2F;$&#123;layer&#125;                 # 5cc84ad355aaa64f46ea9c7bbcc319a9d808ab15088a27209c9e70ef86e5a2aa ã€ beae173ccac6ad749f76713cf4440fe3d21d1043fe616dfbe30775815d1d0f6a</span><br><span class="line">    mkdir -p $&#123;REPO_PATH&#125;&#x2F;$&#123;image_name&#125;&#x2F;_layers&#x2F;sha256&#x2F;$&#123;layer&#125;  # 5cc84ad355aaa64f46ea9c7bbcc319a9d808ab15088a27209c9e70ef86e5a2aa ã€ beae173ccac6ad749f76713cf4440fe3d21d1043fe616dfbe30775815d1d0f6a</span><br><span class="line">    echo -n &quot;sha256:$&#123;layer&#125;&quot; &gt; $&#123;REPO_PATH&#125;&#x2F;$&#123;image_name&#125;&#x2F;_layers&#x2F;sha256&#x2F;$&#123;layer&#125;&#x2F;link  # sha256:5cc84ad355aaa64f46ea9c7bbcc319a9d808ab15088a27209c9e70ef86e5a2aa</span><br><span class="line">    ln -f $&#123;IMAGES_DIR&#125;&#x2F;$&#123;image&#125;&#x2F;$&#123;layer&#125; $&#123;BLOBS_PATH&#125;&#x2F;$&#123;layer:0:2&#125;&#x2F;$&#123;layer&#125;&#x2F;data     # å¤åˆ¶imagesç›®å½•ä¸­ &quot;application&#x2F;vnd.docker.container.image.v1+json&quot; å®¹å™¨é…ç½® config ä¸ å¤šä¸ª &quot;application&#x2F;vnd.docker.image.rootfs.diff.tar.gzip&quot; layer </span><br><span class="line">  done</span><br><span class="line"> done</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">convert_images</span><br></pre></td></tr></table></figure><ul><li><a href="http://install.sh" target="_blank" rel="noopener">install.sh</a> : ä½¿ç”¨è¿™ä¸ªè„šæœ¬å°† registry å­˜å‚¨ä¸­çš„é•œåƒè½¬æ¢æˆ skopeo dir çš„æ–¹å¼ï¼Œç„¶åå†å°†é•œåƒåŒæ­¥åˆ° registry ä¸­ã€‚</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">REGISTRY_DOMAIN&#x3D;&quot;harbor.k8s.li&quot;</span><br><span class="line">REGISTRY_PATH&#x3D;&quot;&#x2F;var&#x2F;lib&#x2F;registry&quot;</span><br><span class="line"></span><br><span class="line"># åˆ‡æ¢åˆ° registry å­˜å‚¨ä¸»ç›®å½•ä¸‹</span><br><span class="line">cd $&#123;REGISTRY_PATH&#125;</span><br><span class="line">gen_skopeo_dir() &#123;</span><br><span class="line">   # å®šä¹‰ registry å­˜å‚¨çš„ blob ç›®å½• å’Œ repositories ç›®å½•ï¼Œæ–¹ä¾¿åé¢ä½¿ç”¨</span><br><span class="line">    BLOB_DIR&#x3D;&quot;docker&#x2F;registry&#x2F;v2&#x2F;blobs&#x2F;sha256&quot;</span><br><span class="line">    REPO_DIR&#x3D;&quot;docker&#x2F;registry&#x2F;v2&#x2F;repositories&quot;</span><br><span class="line">    # å®šä¹‰ç”Ÿæˆ skopeo ç›®å½•</span><br><span class="line">    SKOPEO_DIR&#x3D;&quot;docker&#x2F;skopeo&quot;</span><br><span class="line">    # é€šè¿‡ find å‡º current æ–‡ä»¶å¤¹å¯ä»¥å¾—åˆ°æ‰€æœ‰å¸¦ tag çš„é•œåƒï¼Œå› ä¸ºä¸€ä¸ª tag å¯¹åº”ä¸€ä¸ª current ç›®å½•</span><br><span class="line">    for image in $(find $&#123;REPO_DIR&#125; -type d -name &quot;current&quot;); do</span><br><span class="line">        # æ ¹æ®é•œåƒçš„ tag æå–é•œåƒçš„åå­—</span><br><span class="line">        name&#x3D;$(echo $&#123;image&#125; | awk -F &#39;&#x2F;&#39; &#39;&#123;print $5&quot;&#x2F;&quot;$6&quot;:&quot;$9&#125;&#39;)</span><br><span class="line">        link&#x3D;$(cat $&#123;image&#125;&#x2F;link | sed &#39;s&#x2F;sha256:&#x2F;&#x2F;&#39;)</span><br><span class="line">        mfs&#x3D;&quot;$&#123;BLOB_DIR&#125;&#x2F;$&#123;link:0:2&#125;&#x2F;$&#123;link&#125;&#x2F;data&quot;</span><br><span class="line">        # åˆ›å»ºé•œåƒçš„ç¡¬é“¾æ¥éœ€è¦çš„ç›®å½•</span><br><span class="line">        mkdir -p &quot;$&#123;SKOPEO_DIR&#125;&#x2F;$&#123;name&#125;&quot;</span><br><span class="line">        # ç¡¬é“¾æ¥é•œåƒçš„ manifests æ–‡ä»¶åˆ°ç›®å½•çš„ manifest æ–‡ä»¶</span><br><span class="line">        ln $&#123;mfs&#125; $&#123;SKOPEO_DIR&#125;&#x2F;$&#123;name&#125;&#x2F;manifest.json</span><br><span class="line">        # ä½¿ç”¨æ­£åˆ™åŒ¹é…å‡ºæ‰€æœ‰çš„ sha256 å€¼ï¼Œç„¶åæ’åºå»é‡</span><br><span class="line">        layers&#x3D;$(grep -Eo &quot;\b[a-f0-9]&#123;64&#125;\b&quot; $&#123;mfs&#125; | sort -n | uniq)</span><br><span class="line">        for layer in $&#123;layers&#125;; do</span><br><span class="line">          # ç¡¬é“¾æ¥ registry å­˜å‚¨ç›®å½•é‡Œçš„é•œåƒ layer å’Œ images config åˆ°é•œåƒçš„ dir ç›®å½•</span><br><span class="line">            ln $&#123;BLOB_DIR&#125;&#x2F;$&#123;layer:0:2&#125;&#x2F;$&#123;layer&#125;&#x2F;data $&#123;SKOPEO_DIR&#125;&#x2F;$&#123;name&#125;&#x2F;$&#123;layer&#125;</span><br><span class="line">        done</span><br><span class="line">    done</span><br><span class="line">&#125;</span><br><span class="line">sync_image() &#123;</span><br><span class="line">    # ä½¿ç”¨ skopeo sync å°† dir æ ¼å¼çš„é•œåƒåŒæ­¥åˆ° harbor</span><br><span class="line">    for project in $(ls $&#123;SKOPEO_DIR&#125;); do</span><br><span class="line">        skopeo sync --insecure-policy --src-tls-verify&#x3D;false --dest-tls-verify&#x3D;false \</span><br><span class="line">        --src dir --dest docker $&#123;SKOPEO_DIR&#125;&#x2F;$&#123;project&#125; $&#123;REGISTRY_DOMAIN&#125;&#x2F;$&#123;project&#125;</span><br><span class="line">    done</span><br><span class="line">&#125;</span><br><span class="line">gen_skopeo_dir</span><br></pre></td></tr></table></figure><blockquote><p>æ¸©é¦¨æç¤º: æ­¤ç§æ–¹å¼æ˜¯æœ‰äº›å¤æ‚å¯¹äºå¤§é•œåƒçš„å¤åˆ¶æ˜¯æ¨èçš„, è€Œå¯¹äºä¸€äº›å°é•œåƒä¸”æ˜¾å¾—å¤šä½™ã€‚</p></blockquote><h3><span id="43-ä»-registry-å­˜å‚¨ä¸­-select-å‡ºé•œåƒè¿›è¡ŒåŒæ­¥">4.3 ä» registry å­˜å‚¨ä¸­ select å‡ºé•œåƒè¿›è¡ŒåŒæ­¥</span></h3><p>æè¿°: å…ˆå°†é•œåƒåŒæ­¥åˆ°ä¸€ä¸ª registry ä¸­ï¼Œå†å°†é•œåƒä» registry å­˜å‚¨ä¸­æå‡ºæ¥ï¼Œè¯¥ registry å¯ä»¥å½“ä½œä¸€ä¸ªé•œåƒå­˜å‚¨çš„æ± å­ï¼Œæˆ‘ä»¬ä½¿ç”¨ Linux ä¸­ç¡¬é“¾æ¥çš„ç‰¹æ€§å°†é•œåƒ&quot;å¤åˆ¶&quot;ä¸€ä»½å‡ºæ¥ï¼Œç„¶åå†æ‰“ä¸€ä¸ª tar åŒ…, è¿™æ ·åšçš„å¥½å¤„å°±æ˜¯æ¯æ¬¡æ‰“åŒ…é•œåƒçš„æ—¶å€™éƒ½èƒ½å¤ç”¨å†å²çš„é•œåƒæ•°æ®ï¼Œè€Œä¸”æ€§èƒ½æå¿«ã€‚</p><ul><li>æ­¥éª¤ 01. å…ˆå°†é•œåƒåŒæ­¥åˆ°ä¸€ä¸ªå›ºå®šçš„ registry ä¸­ã€‚</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ bash skopeo-copy.sh docker.io localhost:5000</span><br></pre></td></tr></table></figure><ul><li>æ­¥éª¤ 02. ä½¿ç”¨è¯¥è„šæœ¬å°†é•œåƒä» registry å­˜å‚¨ä¸­æå‡ºæ¥</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">set -eo pipefail</span><br><span class="line"># å‘½ä»¤è¡Œå˜é‡</span><br><span class="line">IMAGES_LIST&#x3D;&quot;$1&quot;</span><br><span class="line">REGISTRY_PATH&#x3D;&quot;$2&quot;</span><br><span class="line">OUTPUT_DIR&#x3D;&quot;$3&quot;</span><br><span class="line"></span><br><span class="line"># Registry ä»“åº“æ•°æ®ç›®å½•</span><br><span class="line">BLOB_DIR&#x3D;&quot;docker&#x2F;registry&#x2F;v2&#x2F;blobs&#x2F;sha256&quot;</span><br><span class="line">REPO_DIR&#x3D;&quot;docker&#x2F;registry&#x2F;v2&#x2F;repositories&quot;</span><br><span class="line"></span><br><span class="line"># åˆ¤æ–­è¾“å‡ºç›®å½•æ˜¯å¦å­˜åœ¨å¦‚ä¸å­˜åœ¨åˆ™ç§»é™¤ã€‚</span><br><span class="line">if [ -d $&#123;OUTPUT_DIR&#125; ];then</span><br><span class="line">  rm -rf $&#123;OUTPUT_DIR&#125;;</span><br><span class="line">fi</span><br><span class="line">mkdir -p $&#123;OUTPUT_DIR&#125;</span><br><span class="line"></span><br><span class="line">for image in $(find $&#123;IMAGES_LIST&#125; -type f -name &quot;*.list&quot; | xargs grep -Ev &#39;^#|^&#x2F;&#39; | grep &#39;:&#39;); do</span><br><span class="line">  # é•œåƒåç§°å’ŒTag</span><br><span class="line">  image_name&#x3D;$&#123;image%%:*&#125;</span><br><span class="line">  image_tag&#x3D;$&#123;image##*:&#125;</span><br><span class="line"></span><br><span class="line">  # link è·¯å¾„è·å–</span><br><span class="line">  tag_link&#x3D;$&#123;REGISTRY_PATH&#125;&#x2F;$&#123;REPO_DIR&#125;&#x2F;$&#123;image_name&#125;&#x2F;_manifests&#x2F;tags&#x2F;$&#123;image_tag&#125;&#x2F;current&#x2F;link</span><br><span class="line">  manifest_sha256&#x3D;$(sed &#39;s&#x2F;sha256:&#x2F;&#x2F;&#39; $&#123;tag_link&#125;)</span><br><span class="line">  manifest&#x3D;$&#123;REGISTRY_PATH&#125;&#x2F;$&#123;BLOB_DIR&#125;&#x2F;$&#123;manifest_sha256:0:2&#125;&#x2F;$&#123;manifest_sha256&#125;&#x2F;data</span><br><span class="line">  mkdir -p $&#123;OUTPUT_DIR&#125;&#x2F;$&#123;BLOB_DIR&#125;&#x2F;$&#123;manifest_sha256:0:2&#125;&#x2F;$&#123;manifest_sha256&#125;</span><br><span class="line"></span><br><span class="line">  # å¼ºåˆ¶ç¡¬é“¾æ¥åˆ°æŒ‡å®šç›®å½•</span><br><span class="line">  ln -f $&#123;manifest&#125; $&#123;OUTPUT_DIR&#125;&#x2F;$&#123;BLOB_DIR&#125;&#x2F;$&#123;manifest_sha256:0:2&#125;&#x2F;$&#123;manifest_sha256&#125;&#x2F;data</span><br><span class="line"></span><br><span class="line">  # make image repositories dir</span><br><span class="line">  mkdir -p $&#123;OUTPUT_DIR&#125;&#x2F;$&#123;REPO_DIR&#125;&#x2F;$&#123;image_name&#125;&#x2F;&#123;_uploads,_layers,_manifests&#125;</span><br><span class="line">  mkdir -p $&#123;OUTPUT_DIR&#125;&#x2F;$&#123;REPO_DIR&#125;&#x2F;$&#123;image_name&#125;&#x2F;_manifests&#x2F;revisions&#x2F;sha256&#x2F;$&#123;manifest_sha256&#125;</span><br><span class="line">  mkdir -p $&#123;OUTPUT_DIR&#125;&#x2F;$&#123;REPO_DIR&#125;&#x2F;$&#123;image_name&#125;&#x2F;_manifests&#x2F;tags&#x2F;$&#123;image_tag&#125;&#x2F;&#123;current,index&#x2F;sha256&#125;</span><br><span class="line">  mkdir -p $&#123;OUTPUT_DIR&#125;&#x2F;$&#123;REPO_DIR&#125;&#x2F;$&#123;image_name&#125;&#x2F;_manifests&#x2F;tags&#x2F;$&#123;image_tag&#125;&#x2F;index&#x2F;sha256&#x2F;$&#123;manifest_sha256&#125;</span><br><span class="line"></span><br><span class="line">  # create image tag manifest link file  </span><br><span class="line">  echo -n &quot;sha256:$&#123;manifest_sha256&#125;&quot; &gt; $&#123;OUTPUT_DIR&#125;&#x2F;$&#123;REPO_DIR&#125;&#x2F;$&#123;image_name&#125;&#x2F;_manifests&#x2F;tags&#x2F;$&#123;image_tag&#125;&#x2F;current&#x2F;link</span><br><span class="line">  echo -n &quot;sha256:$&#123;manifest_sha256&#125;&quot; &gt; $&#123;OUTPUT_DIR&#125;&#x2F;$&#123;REPO_DIR&#125;&#x2F;$&#123;image_name&#125;&#x2F;_manifests&#x2F;revisions&#x2F;sha256&#x2F;$&#123;manifest_sha256&#125;&#x2F;link</span><br><span class="line">  echo -n &quot;sha256:$&#123;manifest_sha256&#125;&quot; &gt; $&#123;OUTPUT_DIR&#125;&#x2F;$&#123;REPO_DIR&#125;&#x2F;$&#123;image_name&#125;&#x2F;_manifests&#x2F;tags&#x2F;$&#123;image_tag&#125;&#x2F;index&#x2F;sha256&#x2F;$&#123;manifest_sha256&#125;&#x2F;link</span><br><span class="line"></span><br><span class="line">  # å¼ºåˆ¶åˆ›å»º &#x2F;docker&#x2F;registry&#x2F;v2&#x2F;blobs&#x2F; å„ layer data æ–‡ä»¶åˆ°æŒ‡å®šç›®å½•ä¹‹ä¸­</span><br><span class="line">  for layer in $(sed &#39;&#x2F;v1Compatibility&#x2F;d&#39; $&#123;manifest&#125; | grep -Eo &#39;\b[a-f0-9]&#123;64&#125;\b&#39; | sort -u); do</span><br><span class="line">      mkdir -p $&#123;OUTPUT_DIR&#125;&#x2F;$&#123;BLOB_DIR&#125;&#x2F;$&#123;layer:0:2&#125;&#x2F;$&#123;layer&#125;</span><br><span class="line">      mkdir -p $&#123;OUTPUT_DIR&#125;&#x2F;$&#123;REPO_DIR&#125;&#x2F;$&#123;image_name&#125;&#x2F;_layers&#x2F;sha256&#x2F;$&#123;layer&#125;</span><br><span class="line">      ln -f $&#123;BLOB_DIR&#125;&#x2F;$&#123;layer:0:2&#125;&#x2F;$&#123;layer&#125;&#x2F;data $&#123;OUTPUT_DIR&#125;&#x2F;$&#123;BLOB_DIR&#125;&#x2F;$&#123;layer:0:2&#125;&#x2F;$&#123;layer&#125;&#x2F;data</span><br><span class="line">      echo -n &quot;sha256:$&#123;layer&#125;&quot; &gt; $&#123;OUTPUT_DIR&#125;&#x2F;$&#123;REPO_DIR&#125;&#x2F;$&#123;image_name&#125;&#x2F;_layers&#x2F;sha256&#x2F;$&#123;layer&#125;&#x2F;link</span><br><span class="line">  done</span><br><span class="line">done</span><br></pre></td></tr></table></figure><p>è‡³æ­¤å®Œæ¯•ï¼</p><blockquote><p>æœ¬æ–‡è½¬è½½è‡ªï¼šã€Œ WeiyiGeek ã€ï¼ŒåŸæ–‡ï¼š<a href="https://url.hi-linux.com/xCmXo/" target="_blank" rel="noopener">https://url.hi-linux.com/xCmXo/</a> ï¼Œç‰ˆæƒå½’åŸä½œè€…æ‰€æœ‰ã€‚æ¬¢è¿æŠ•ç¨¿ï¼ŒæŠ•ç¨¿é‚®ç®±: <a href="mailto:editor@hi-linux.com">editor@hi-linux.com</a>ã€‚</p></blockquote></div><script src="https://my.openwrite.cn/js/readmore.js" type="text/javascript"></script><script>var isMobile = navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i);if (!isMobile) {    var btw = new BTWPlugin();    btw.init({        "id": "vip-container",        "blogId": "10135-1588830050631-449",        "name": "ã€Œå¥‡å¦™çš„ Linux ä¸–ç•Œã€",        "qrcode": "https://www.hi-linux.com/img/wechat/mp_qrcode_12.jpg",        "keyword": "VIP"    });}</script>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;1-åŸºç¡€ä»‹ç»&quot;&gt;1. åŸºç¡€ä»‹ç»&lt;/h2&gt;
&lt;p&gt;æè¿°: ä½œä¸ºå…¬å¸å†…éƒ¨ PaaS toB äº§å“çš„æ‰“åŒ…å‘å¸ƒäººå‘˜ï¼Œå®¹å™¨é•œåƒå¯¹æˆ‘ä»¬æ‰“å·¥äººè€Œè¨€å°±åƒæ˜¯å·¥åœ°ä¸Šçš„ç –å¤´ ğŸ§±ï¼Œè€Œæˆ‘çš„ä¸€éƒ¨åˆ†å·¥ä½œå°±æ˜¯å°†è¿™äº›ç –å¤´åœ¨å„ä¸ªä»“åº“ä¹‹é—´æ¬æ¥æ¬å»ï¼Œæœ€ç»ˆå°†è¿™äº›ç –å¤´æ‰“åŒ…æ”¾åœ¨äº§å“çš„å®‰è£…åŒ…ä¸­ï¼Œå½¢æˆä¸€ä¸ªå®Œæ•´çš„ PaaS äº§å“å®‰è£…åŒ…ã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Q: åœ¨ PaaS (å¹³å°å³æœåŠ¡)ä¸­çš„å¤§å®¶å¸¸è¯´çš„ ToB ä¸ ToC åˆ°åº•æ˜¯ä»€ä¹ˆ?&lt;/li&gt;
&lt;/ul&gt;
&lt;blockquote&gt;
&lt;p&gt;ToC é¢å‘æ™®é€šç”¨æˆ·æœåŠ¡, ä¸»è¦æ˜¯è®©ç”¨æˆ·ä½“éªŒæ„Ÿå¥½ï¼Œè§£å†³ç”¨æˆ·ä½¿ç”¨æ–¹é¢çš„é—®é¢˜è®°å½•ï¼Œå¹¶è¿”å›ç»™å‰åç«¯å¼€å‘ã€‚&lt;br&gt;
ToB æ˜¯é¢å‘ä¼ä¸šç”¨æˆ·æœåŠ¡, äº§å“å¯ç”¨ã€å…¶ä¸­æœ€å…³é”®æ˜¯è®©Bossä½¿ç”¨Happly!&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;Q: å‡å¦‚æœ‰å¦‚ä¸‹åœºæ™¯ï¼Œæˆ‘ä»¬ä» dockerhub å…¬å…±ä»“åº“ä¸­ä¸‹è½½ä¸€ä¸ª GB ä»¥ä¸Šçš„é•œåƒï¼Œåˆ°æœ¬åœ°çš„ç§æœ‰ä»“åº“ä¸­ï¼Œæˆ‘æƒ³é€šå¸¸ä½ ä¼šè¿™æ ·åšå…ˆ &lt;code&gt;docker pull&lt;/code&gt; åˆ°æœ¬åœ°ï¼Œç„¶åä½¿ç”¨ &lt;code&gt;docker tag&lt;/code&gt; æ›´æ”¹ä¸ºç§æœ‰ä»“åº“åœ°å€åŠ ä¸Šé•œåƒåç§°ç‰ˆæœ¬ï¼Œæœ€åå†ä½¿ç”¨&lt;code&gt;docker push&lt;/code&gt; ä¸Šä¼ é•œåƒåˆ°ç§æœ‰ä»“åº“ä¸­ï¼Œä»¥ä¾›å…¶å®ƒå†…ç½‘æœºå™¨æ‹‰å–å¹¶ä½¿ç”¨ã€‚è™½ç„¶è¯¥æ–¹æ³•æ˜¯å¯è¡Œï¼Œä½†æ˜¯å¦‚æœæœ‰å¤šä¸ªå¤§äº GB ä»¥ä¸Šçš„é•œåƒéœ€è¦ä¸Šä¼ åˆ°ç§æœ‰ä»“åº“ï¼Œæ¯æ¬¡éƒ½è¦å…ˆè§£å‹ layer åˆ°æœ¬åœ°ï¼Œç„¶åå†å‹ç¼© layer ä¸Šä¼ åˆ°ç§æœ‰ä»“åº“ä¸­ï¼Œä½ èƒ½æƒ³è±¡æ­¤è¿‡ç¨‹èŠ±è´¹çš„æ—¶é—´æœ‰å¤šä¹…å—? å¯¹äºæˆ‘ä»¬è¿ç»´å·¥ç¨‹å¸ˆæ¥è¯´æ—¶é—´å°±æ˜¯é‡‘é’±ï¼Œæ‰€ä»¥éœ€æƒ³å°½ä¸€åˆ‡æ–¹æ³•æ¥èŠ‚çº¦æ—¶é—´æˆæœ¬ï¼Œé‚£æœ‰æ²¡æœ‰ä¸€ç§åŠæ³•å¯ä»¥ç›´æ¥å°† registry ä¸Šçš„ blob å¤åˆ¶åˆ°å¦ä¸€ä¸ª registryï¼Œä¸­é—´è¿‡ç¨‹ä¸æ¶‰åŠå¯¹é•œåƒ layer çš„è§£å‹ç¼©ï¼Œè¿™å²‚ä¸ç¾å“‰ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;blockquote&gt;
&lt;p&gt;è§£å†³æ–¹æ¡ˆå½“ç„¶æ˜¯å­˜åœ¨çš„ï¼Œå¦‚æœä½ ä¸æƒ³ä½¿ç”¨dockerè¿›è¡Œimagesé•œåƒæ‹‰å–ä¸Šä¼ ï¼Œæˆ‘ä»¬å®Œæˆå¯ä»¥ä½¿ç”¨skopeå·¥å…·æ¥å®Œå…¨æ›¿ä»£ docker-cli æ¥æ¬è¿é•œåƒï¼Œskopeoæ˜¯ä¸€ä¸ªå‘½ä»¤è¡Œå®ç”¨ç¨‹åºï¼Œå¯å¯¹å®¹å™¨æ˜ åƒå’Œæ˜ åƒå­˜å‚¨åº“æ‰§è¡Œå„ç§æ“ä½œã€‚&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
    
      <category term="Linux" scheme="https://www.hi-linux.com/categories/Linux/"/>
    
    
      <category term="Linux" scheme="https://www.hi-linux.com/tags/Linux/"/>
    
      <category term="Docker" scheme="https://www.hi-linux.com/tags/Docker/"/>
    
      <category term="Skopeo" scheme="https://www.hi-linux.com/tags/Skopeo/"/>
    
  </entry>
  
  <entry>
    <title>è½»é‡çº§ Kubernetes é›†ç¾¤å‘è¡Œç‰ˆ K3s å®Œå…¨è¿›é˜¶æŒ‡å—</title>
    <link href="https://www.hi-linux.com/posts/907.html"/>
    <id>https://www.hi-linux.com/posts/907.html</id>
    <published>2022-05-20T01:00:00.000Z</published>
    <updated>2022-05-20T01:22:25.012Z</updated>
    
    <content type="html"><![CDATA[<div id="vip-container"><blockquote><p><strong>æ·±å…¥ç†è§£å®˜æ–¹æ–‡æ¡£ï¼Œè½»æ¾å­¦ä¼šä½¿ç”¨ K3S å·¥å…·ï¼</strong></p></blockquote><p><code>K3s</code> æ˜¯ä¸€ä¸ªè½»é‡çº§çš„ <code>Kubernetes</code> å‘è¡Œç‰ˆï¼Œå®ƒé’ˆå¯¹è¾¹ç¼˜è®¡ç®—ã€ç‰©è”ç½‘ç­‰åœºæ™¯è¿›è¡Œäº†é«˜åº¦ä¼˜åŒ–ã€‚</p><ul><li><code>CNCF</code> è®¤è¯çš„ <code>Kubernetes</code> å‘è¡Œç‰ˆ</li><li>æ”¯æŒ <code>X86_64</code>, <code>ARM64</code>, <code>ARMv7</code> å¹³å°</li><li>å•ä¸€è¿›ç¨‹åŒ…å« <code>Kubernetes master</code>ï¼Œ<code>kubelet</code> å’Œ <code>containerd</code></li></ul><a id="more"></a><h2><span id="1-k3s-å·¥å…·ä»‹ç»">1. K3S å·¥å…·ä»‹ç»</span></h2><blockquote><p><strong>ä¸ºä½ æä¾› k3s çš„äº§å“ä»‹ç»</strong></p></blockquote><p><code>K3s</code> æœ‰ä»¥ä¸‹å¢å¼ºåŠŸèƒ½ï¼š</p><ul><li>æ‰“åŒ…ä¸ºå•ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶<ul><li>æŠŠ <code>K8S</code> ç›¸å…³çš„ç»„ä»¶ï¼Œæ¯”å¦‚ <code>kube-api</code>/ <code>kube-manager</code> éƒ½æ‰“åŒ…åˆ°åŒä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶é‡Œé¢ï¼Œè¿™æ ·çš„è¯ï¼Œåªéœ€è¦å¯åŠ¨è¿™ä¸ªæ–‡ä»¶å°±å¯ä»¥å¿«é€Ÿçš„å¯åŠ¨å¯¹åº”çš„ç»„ä»¶ã€‚</li></ul></li><li>ä½¿ç”¨åŸºäº sqlite3 çš„é»˜è®¤å­˜å‚¨æœºåˆ¶<ul><li>åŒæ—¶æ”¯æŒä½¿ç”¨ <code>etcd3</code>ã€<code>MySQL</code> å’Œ <code>PostgreSQL</code> ä½œä¸ºå­˜å‚¨æœºåˆ¶ã€‚</li></ul></li><li>é»˜è®¤æƒ…å†µä¸‹æ˜¯å®‰å…¨çš„<ul><li>åœ¨ <code>K3s</code> ä¸­æœ‰ä¸€ä¸ªé»˜è®¤çš„è¯ä¹¦ç®¡ç†æœºåˆ¶(é»˜è®¤ä¸€å¹´æœ‰æ•ˆæœŸ)ï¼Œä¹Ÿæœ‰ä¸€ä¸ªå¯ä»¥è½®è½¬è¯ä¹¦çš„åŠŸèƒ½(å°±æ˜¯åœ¨å°äºä¹åå¤©ä¹‹å†…é‡å¯ <code>K3s</code> çš„è¯ï¼Œå°±ä¼šè‡ªåŠ¨ç»­ä¸€å¹´)ã€‚</li></ul></li><li>åŠŸèƒ½å¼ºå¤§çš„ <code>batteries-included</code> åŠŸèƒ½<ul><li>å°±æ˜¯è™½ç„¶æœ‰äº›æœåŠ¡æœ¬èº«è¿™ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶å¹¶æ²¡æœ‰æä¾›ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡å†…ç½®çš„æœåŠ¡ï¼Œå°†é…ç½®æ–‡ä»¶æ”¾åˆ°æŒ‡å®šçš„ç›®å½•ä¸‹é¢ï¼Œå°±å¯ä»¥åœ¨å¯åŠ¨çš„æ—¶å€™ä¸€å¹¶å°†è¯¥æœåŠ¡å¯åŠ¨æˆ–æ›¿æ¢é»˜è®¤ç»„ä»¶ã€‚</li></ul></li><li>æ‰€æœ‰ <code>K8S control-plane</code> ç»„ä»¶éƒ½å°è£…åœ¨å•ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶å’Œè¿›ç¨‹ä¸­<ul><li>å› ä¸ºå°è£…åœ¨äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ï¼Œæ‰€ä»¥å¯åŠ¨çš„æ—¶å€™åªæœ‰ä¸€ä¸ªè¿›ç¨‹ã€‚å¥½å¤„åœ¨äºåªéœ€è¦ç®¡ç†è¿™ä¸ªå•ä¸€è¿›ç¨‹å°±å¯ä»¥äº†ï¼ŒåŒæ—¶ä¹Ÿå…·å¤‡æ“ä½œå¤æ‚é›†ç¾¤çš„èƒ½åŠ›ã€‚</li></ul></li><li>æœ€å¤§ç¨‹åº¦å‡è½»äº†å¤–éƒ¨ä¾èµ–æ€§<ul><li>å³ç¨æ–°ä¸€ç‚¹çš„ <code>Linux</code> å†…æ ¸å°±å¯ä»¥äº†(éœ€è¦ <code>kernel</code> å’Œ <code>cgroup</code> æŒ‚è½½)ã€‚</li></ul></li></ul><p>ä¹‹æ‰€ä»¥å«åš <code>K3S</code> æ˜¯å› ä¸ºå¸Œæœ›å®‰è£…çš„ <code>K8S</code> åœ¨å†…å­˜å ç”¨æ–¹é¢åªæ˜¯ä¸€åŠçš„å¤§å°ï¼Œè€Œä¸€åŠå¤§çš„ä¸œè¥¿å°±æ˜¯ä¸€ä¸ª <code>5</code> ä¸ªå­—æ¯çš„å•è¯ï¼Œç®€å†™ä¸º <code>K3S</code>ã€‚</p><ul><li>ç”Ÿå‘½å‘¨æœŸ<ul><li>åŒæ—¶æ”¯æŒ <code>3</code> ä¸ª <code>K8s</code> ç‰ˆæœ¬ï¼Œæ”¯æŒçš„ç”Ÿå‘½å‘¨æœŸä¸ <code>K8s</code> ç›¸åŒ</li><li>å¯ä»¥å‚è€ƒ: <a href="https://kubernetes.io/zh/docs/setup/release/version-skew-policy/" target="_blank" rel="noopener">Kubernetes ç‰ˆæœ¬åŠç‰ˆæœ¬åå·®æ”¯æŒç­–ç•¥</a> è¿›è¡Œå­¦ä¹ </li></ul></li><li>æ›´æ–°å‘¨æœŸ<ul><li>å½“ <code>K8s</code> æ›´æ–°æ–°ç‰ˆæœ¬åï¼Œä¸€èˆ¬ <code>K3s</code> åœ¨ä¸€å‘¨å†…åŒæ­¥æ›´æ–°</li><li>å¯ä»¥é€šè¿‡ <a href="https://update.k3s.io/v1-release/channels" target="_blank" rel="noopener">è¿™ä¸ªé“¾æ¥</a> è·å– <strong><code>latest</code>/<code>stable</code>/<code>testing</code></strong> ç‰ˆæœ¬</li><li>æˆ‘ä»¬é»˜è®¤å®‰è£…çš„æ˜¯ <code>stable</code> ç‰ˆæœ¬ï¼Œå¯ä»¥è¿è¡Œé€šè¿‡å‘½ä»¤è¿›è¡ŒæŸ¥çœ‹</li></ul></li><li>å‘½åè§„èŒƒ<ul><li><strong>v1.20.4+k3s1</strong>: <code>v1.20.4</code> ä¸º <code>K8s</code> ç‰ˆæœ¬ï¼Œ<code>k3s1</code> ä¸ºè¡¥ä¸ç‰ˆæœ¬</li></ul></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># K3sè½¯ä»¶åŒ…éœ€è¦çš„ä¾èµ–é¡¹</span></span><br><span class="line">containerd  <span class="comment"># å®¹å™¨è¿è¡Œæ—¶(å¯ä»¥ä½¿ç”¨dockeræ›¿ä»£)</span></span><br><span class="line">Flannel     <span class="comment"># ç½‘ç»œ</span></span><br><span class="line">CoreDNS     <span class="comment"># DNS</span></span><br><span class="line">CNI         <span class="comment"># CNI</span></span><br><span class="line">Traefik     <span class="comment"># é»˜è®¤çš„controlleræœåŠ¡(apisix/ingress-controller)</span></span><br><span class="line">iptables    <span class="comment"># ä¸»æœºå®ç”¨ç¨‹åº</span></span><br><span class="line">service load balancer     <span class="comment"># åµŒå…¥å¼æœåŠ¡è´Ÿè½½å‡è¡¡å™¨</span></span><br><span class="line">network policy controller <span class="comment"># åµŒå…¥å¼ç½‘ç»œç­–ç•¥æ§åˆ¶å™¨</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># K3sé€‚ç”¨äºä»¥ä¸‹åœºæ™¯</span></span><br><span class="line">CI</span><br><span class="line">Development</span><br><span class="line">ARM</span><br><span class="line">åµŒå…¥ K8s</span><br><span class="line">ç‰©è”ç½‘-IoT</span><br><span class="line">è¾¹ç¼˜è®¡ç®—-Edge</span><br></pre></td></tr></table></figure><p>ä¸æ­¤åŒæ—¶ï¼Œ<code>Rancher</code> ä¸­å›½å›¢é˜Ÿæ¨å‡ºäº†ä¸€æ¬¾é’ˆå¯¹ <code>K3s</code> çš„æ•ˆç‡æå‡å·¥å…·ï¼š<strong>AutoK3s</strong>ã€‚åªéœ€è¦è¾“å…¥ä¸€è¡Œå‘½ä»¤ï¼Œå³å¯å¿«é€Ÿåˆ›å»º <code>K3s</code> é›†ç¾¤å¹¶æ·»åŠ æŒ‡å®šæ•°é‡çš„ <code>master</code> èŠ‚ç‚¹å’Œ <code>worker</code> èŠ‚ç‚¹ã€‚</p><h2><span id="2-k3s-å¿«é€Ÿå…¥é—¨">2. K3S å¿«é€Ÿå…¥é—¨</span></h2><blockquote><p><strong>åŸç†å°±æ˜¯ï¼Œå°† K8S çš„ç›¸å…³ç»„ä»¶å°è£…åˆ° K3S çš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸­å»ï¼</strong></p></blockquote><p>åŸç†å°±æ˜¯ï¼Œå°† <code>K8S</code> çš„ç›¸å…³ç»„ä»¶å°è£…åˆ° <code>K3S</code> çš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸­å»ï¼Œç„¶åå¯åŠ¨è¿™äºŒè¿›åˆ¶æ–‡ä»¶å°±å¯ä»¥å¯åŠ¨ä¸€ä¸ªæˆç†Ÿçš„ <code>K8S</code> é›†ç¾¤ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ° <code>K3S</code> å’Œ <code>K8S</code> çš„æ¶æ„åŸºæœ¬å·®ä¸å¤šï¼Œå…¶ä¸­ <code>k3s-server</code> å¯¹åº”è¿™ä¸ª <code>control-plane</code>ï¼Œè€Œ <code>k3s-agent</code> å¯¹åº”ç€ <code>node</code> èŠ‚ç‚¹ã€‚</p><p>å¯ä»¥çœ‹åˆ° <code>k3s</code> ä¸­ä½¿ç”¨çš„é»˜è®¤å­˜å‚¨æ˜¯ <code>SQLite</code>(è‡ªå¸¦)ï¼Œä¸”é»˜è®¤çš„ç½‘ç»œä½¿ç”¨çš„æ˜¯ <code>Flannel</code>(è‡ªå¸¦)ã€‚å½“æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯éƒ½å¯åŠ¨ä¹‹åï¼Œé€šè¿‡ <code>Tunnel-Proxy</code> è¿™ä¸ªç»„ä»¶è¿›è¡Œé€šä¿¡ï¼Œé€šè¿‡è¿™ä¸ªé€šé“å»ç®¡ç†ç½‘ç»œæµé‡ã€‚åœ¨ <code>agent</code> èŠ‚ç‚¹ä¸­ï¼Œé€šè¿‡ <code>kubelet</code> æ“ä½œ <code>contaninerd</code> æ¥åˆ›å»ºå¯¹åº” <code>Pod</code>ã€‚</p><ul><li>K3s æ¶æ„</li></ul><p><img src="https://img.hi-linux.com/staticfile/advance-k3s-tool-01-2022-05-19-1NJdKE.jpg" alt="K3Så·¥å…·è¿›é˜¶æŒ‡å—"></p><ul><li>K8s æ¶æ„</li></ul><p><img src="https://img.hi-linux.com/staticfile/advance-k3s-tool-02-20220519092405817-2022-05-19-tva27I.png" alt="K3Så·¥å…·è¿›é˜¶æŒ‡å—"></p><p>å›½å†…çš„è¯ï¼Œå»ºè®®ä½¿ç”¨å®˜æ–¹æä¾›çš„ <a href="https://mirror.rancher.cn/" target="_blank" rel="noopener">é•œåƒåœ°å€</a>ï¼Œè¿™æ ·ä¸ä½†å¯ä»¥åŠ é€Ÿæœ¬åœ° <code>K3s</code> çš„æ—¶å€™ï¼Œè€Œä¸”æ–¹ä¾¿éƒ¨ç½²å’Œæ›´æ–°æœåŠ¡ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆå»ºè®®å›½å†…ä½¿ç”¨ <code>k3s-install.sh</code> éƒ¨ç½²æœåŠ¡çš„åŸå› ï¼Œå› ä¸ºå…¶å†…éƒ¨ä½¿ç”¨çš„åœ°å€éƒ½æ˜¯ä»å›½å†…å»è·å–çš„ã€‚</p><h2><span id="3-k3s-å®‰è£…äº‹é¡¹">3. K3S å®‰è£…äº‹é¡¹</span></h2><h3><span id="31-å®‰è£…æŒ‡å—">3.1 å®‰è£…æŒ‡å—</span></h3><blockquote><p><strong>ç†è§£ Server èŠ‚ç‚¹çš„å®‰è£…ï¼Œä»¥åŠæ³¨å†Œ Agent èŠ‚ç‚¹çš„æ­¥éª¤ï¼</strong></p></blockquote><p>è™½ç„¶å¯ä»¥é€šè¿‡ä¸‹è½½äºŒè¿›åˆ¶æ–‡ä»¶è¿›è¡ŒæœåŠ¡ç«¯å’Œå·¥ä½œèŠ‚ç‚¹çš„è¿è¡Œ(<code>./k3s server</code>)ï¼Œä½†æ˜¯ä¸€æ—¦æˆ‘ä»¬é€€å‡ºè¿›ç¨‹ï¼Œä¹‹å‰åˆ›å»ºçš„èŠ‚ç‚¹ä¹Ÿå°±ç«‹å³é”€æ¯äº†ï¼Œæ‰€ä»¥è¿˜æ˜¯å»ºè®®ä½¿ç”¨è„šæœ¬è¿›è¡Œå®‰è£…ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¸»èŠ‚ç‚¹</span></span><br><span class="line">$ ./k3s server</span><br><span class="line"></span><br><span class="line"><span class="comment"># å·¥ä½œèŠ‚ç‚¹</span></span><br><span class="line">$ ./k3s agent K3S_URL=xxx K3S_TOKEN=xxx</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¸…é™¤åƒåœ¾æ–‡ä»¶</span></span><br><span class="line">$ rm -rf /etc/rancher /var/lib/rancher</span><br></pre></td></tr></table></figure><ul><li>é•œåƒåŠ é€Ÿ</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ·»åŠ é…ç½®</span></span><br><span class="line">$ cat &gt;&gt; /etc/rancher/k3s/registries.yaml &lt;&lt;EOF</span><br><span class="line">mirrors:</span><br><span class="line">  <span class="string">"docker.io"</span>:</span><br><span class="line">    endpoint:</span><br><span class="line">      - <span class="string">"https://fogjl973.mirror.aliyuncs.com"</span></span><br><span class="line">      - <span class="string">"https://registry-1.docker.io"</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># é‡å¯æœåŠ¡</span></span><br><span class="line">$ sudo systemctl restart k3s</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ˜¯å¦ç”Ÿæ•ˆ</span></span><br><span class="line">$ sudo crictl info | grep -A 2 <span class="string">"endpoint"</span></span><br></pre></td></tr></table></figure><p><code>K3s</code> æä¾›äº†ä¸€ä¸ªå®‰è£…è„šæœ¬ï¼Œå¯ä»¥æ–¹ä¾¿çš„åœ¨ <code>systemd</code> æˆ– <code>openrc</code> çš„ç³»ç»Ÿä¸Šå°†å…¶ä½œä¸ºæœåŠ¡å®‰è£…ã€‚è¿è¡Œæ­¤å®‰è£…åï¼Œ<code>K3s</code> æœåŠ¡å°†è¢«é…ç½®ä¸ºåœ¨èŠ‚ç‚¹é‡å¯åæˆ–è¿›ç¨‹å´©æºƒæˆ–è¢«æ€æ­»æ—¶è‡ªåŠ¨é‡å¯ã€‚</p><ul><li><p>å®‰è£…å†…å®¹</p><ul><li><code>kubectl</code>ã€<code>crictl</code>ã€<code>ctr</code></li><li><code>k3s-killall.sh</code>ã€<code>k3s-uninstall.sh</code></li></ul></li><li><p>æ‰§è¡Œæ“ä½œ</p><ul><li>å°† <code>kubeconfig</code> æ–‡ä»¶å†™å…¥åˆ° <code>/etc/rancher/k3s/k3s.yaml</code> é‡Œé¢</li><li>ç”± <code>K3s</code> å®‰è£…çš„ <code>kubectl</code> å·¥å…·å°†è‡ªåŠ¨ä½¿ç”¨è¯¥æ–‡ä»¶çš„é…ç½®æ¥è¿è¡Œ</li><li>å…¶ä»–æœºå™¨å¯ä»¥é€šè¿‡å¤åˆ¶è¿™ä¸ªé…ç½®æ–‡ä»¶å¹¶ä¿®æ”¹ <code>server</code> åœ°å€æ¥æ“ä½œ <code>K3s</code> é›†ç¾¤</li></ul></li><li><p>ä¸»èŠ‚ç‚¹ - 192.168.100.100</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®‰è£…è„šæœ¬</span></span><br><span class="line"><span class="comment"># https://get.k3s.io</span></span><br><span class="line">$ curl -sfL https://get.k3s.io | sh -</span><br><span class="line"></span><br><span class="line"><span class="comment"># å»ºè®®ä½¿ç”¨è¿™ä¸ªå®‰è£…è„šæœ¬(å›½å†…åŒ–äº†)</span></span><br><span class="line">$ curl -sfL https://rancher-mirror.rancher.cn/k3s/k3s-install.sh | \</span><br><span class="line">    INSTALL_K3S_MIRROR=cn K3S_NODE_NAME=k3s1 \</span><br><span class="line">    K3S_KUBECONFIG_OUTPUT=/home/escape/.kube/config \</span><br><span class="line">    INSTALL_K3S_EXEC=<span class="string">"--docker"</span> sh -</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥æ‰¾stableåˆ†æ”¯ç‰ˆæœ¬ä¿¡æ¯</span></span><br><span class="line">[INFO]  Finding release <span class="keyword">for</span> channel stable</span><br><span class="line">[INFO]  Using v1.23.6+k3s1 as release</span><br><span class="line"></span><br><span class="line"><span class="comment"># è·å–å›½å†…é•œåƒç‰ˆæœ¬åœ°å€</span></span><br><span class="line">[INFO]  Downloading <span class="built_in">hash</span> https://rancher-mirror.rancher.cn/k3s/v1.23.6-k3s1/sha256sum-amd64.txt</span><br><span class="line">[INFO]  Downloading binary https://rancher-mirror.rancher.cn/k3s/v1.23.6-k3s1/k3s</span><br><span class="line">[INFO]  Verifying binary download</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…k3säºŒè¿›åˆ¶å·¥å…·å¹¶é“¾æ¥ç›¸å…³å·¥å…·(å†…ç½®)</span></span><br><span class="line">[INFO]  Installing k3s to /usr/<span class="built_in">local</span>/bin/k3s</span><br><span class="line">[INFO]  Skipping installation of SELinux RPM</span><br><span class="line">[INFO]  Creating /usr/<span class="built_in">local</span>/bin/kubectl symlink to k3s</span><br><span class="line">[INFO]  Creating /usr/<span class="built_in">local</span>/bin/crictl symlink to k3s</span><br><span class="line">[INFO]  Skipping /usr/<span class="built_in">local</span>/bin/ctr symlink to k3s, <span class="built_in">command</span> exists <span class="keyword">in</span> PATH at /usr/bin/ctr</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…æ¸…é™¤å’Œå¸è½½k3sç”Ÿæˆçš„é…ç½®å’Œå·¥å…·</span></span><br><span class="line">[INFO]  Creating killall script /usr/<span class="built_in">local</span>/bin/k3s-killall.sh</span><br><span class="line">[INFO]  Creating uninstall script /usr/<span class="built_in">local</span>/bin/k3s-uninstall.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¸¸è§äº†ä¸¤ä¸ªsystemdçš„é…ç½®</span></span><br><span class="line">[INFO]  env: Creating environment file /etc/systemd/system/k3s.service.env</span><br><span class="line">[INFO]  systemd: Creating service file /etc/systemd/system/k3s.service</span><br><span class="line">[INFO]  systemd: Enabling k3s unit</span><br><span class="line">Created symlink /etc/systemd/system/multi-user.target.wants/k3s.service â†’ /etc/systemd/system/k3s.service.</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯åŠ¨k3sæœåŠ¡</span></span><br><span class="line">[INFO]  systemd: Starting k3s</span><br></pre></td></tr></table></figure><ul><li>å·¥ä½œèŠ‚ç‚¹ - 192.168.100.101</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å·¥ä½œèŠ‚ç‚¹ä¸Šå®‰è£…å¹¶å°†å®ƒä»¬æ·»åŠ åˆ°é›†ç¾¤</span></span><br><span class="line"><span class="comment"># https://docs.rancher.cn/docs/k3s/architecture/_index#æ³¨å†Œ-agent-èŠ‚ç‚¹</span></span><br><span class="line">$ curl -sfL https://get.k3s.io | \</span><br><span class="line">    K3S_URL=https://myserver:6443 \</span><br><span class="line">    K3S_TOKEN=mynodetoken sh -</span><br><span class="line"></span><br><span class="line"><span class="comment"># å»ºè®®ä½¿ç”¨è¿™ä¸ªå®‰è£…å‘½ä»¤(å›½å†…åŒ–äº†)</span></span><br><span class="line"><span class="comment"># K3S_URL: ä¼šä½¿K3sä»¥workeræ¨¡å¼è¿è¡Œ</span></span><br><span class="line"><span class="comment"># K3S_TOKEN: ä½¿ç”¨çš„å€¼å­˜å‚¨åœ¨ä½ çš„æœåŠ¡å™¨èŠ‚ç‚¹ä¸Š</span></span><br><span class="line"><span class="comment"># K3S_NODE_NAME: ä¸ºæ¯ä¸ªèŠ‚ç‚¹æä¾›ä¸€ä¸ªæœ‰æ•ˆä¸”å”¯ä¸€çš„ä¸»æœºå</span></span><br><span class="line">$ curl -sfL https://rancher-mirror.rancher.cn/k3s/k3s-install.sh | \</span><br><span class="line">    INSTALL_K3S_MIRROR=cn K3S_NODE_NAME=k3s2 \</span><br><span class="line">    K3S_KUBECONFIG_OUTPUT=/home/escape/.kube/config \</span><br><span class="line">    K3S_URL=https://192.168.100.100:6443 \</span><br><span class="line">    K3S_TOKEN=mynodetoken sh -</span><br><span class="line"></span><br><span class="line"><span class="comment"># mynodetoken</span></span><br><span class="line">$ sudo cat /var/lib/rancher/k3s/server/token</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥æ‰¾stableåˆ†æ”¯ç‰ˆæœ¬ä¿¡æ¯</span></span><br><span class="line">[INFO]  Finding release <span class="keyword">for</span> channel stable</span><br><span class="line">[INFO]  Using v1.23.6+k3s1 as release</span><br><span class="line"></span><br><span class="line"><span class="comment"># è·å–å›½å†…é•œåƒç‰ˆæœ¬åœ°å€</span></span><br><span class="line">[INFO]  Downloading <span class="built_in">hash</span> https://rancher-mirror.rancher.cn/k3s/v1.23.6-k3s1/sha256sum-amd64.txt</span><br><span class="line">[INFO]  Downloading binary https://rancher-mirror.rancher.cn/k3s/v1.23.6-k3s1/k3s</span><br><span class="line">[INFO]  Verifying binary download</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…k3säºŒè¿›åˆ¶å·¥å…·å¹¶é“¾æ¥ç›¸å…³å·¥å…·(å†…ç½®)</span></span><br><span class="line">[INFO]  Installing k3s to /usr/<span class="built_in">local</span>/bin/k3s</span><br><span class="line">[INFO]  Creating /usr/<span class="built_in">local</span>/bin/kubectl symlink to k3s</span><br><span class="line">[INFO]  Creating /usr/<span class="built_in">local</span>/bin/crictl symlink to k3s</span><br><span class="line">[INFO]  Skipping /usr/<span class="built_in">local</span>/bin/ctr symlink to k3s</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…æ¸…é™¤å’Œå¸è½½k3sç”Ÿæˆçš„é…ç½®å’Œå·¥å…·</span></span><br><span class="line">[INFO]  Creating killall script /usr/<span class="built_in">local</span>/bin/k3s-agent-killall.sh</span><br><span class="line">[INFO]  Creating uninstall script /usr/<span class="built_in">local</span>/bin/k3s-agent-uninstall.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¸¸è§äº†ä¸¤ä¸ªsystemdçš„é…ç½®</span></span><br><span class="line">[INFO]  env: Creating environment file /etc/systemd/system/k3s-agent.service.env</span><br><span class="line">[INFO]  systemd: Creating service file /etc/systemd/system/k3s-agent.service</span><br><span class="line">[INFO]  systemd: Enabling k3s-agent unit</span><br><span class="line">Created symlink /etc/systemd/system/multi-user.target.wants/k3s-agent.service â†’ /etc/systemd/system/k3s-agent.service.</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯åŠ¨k3sæœåŠ¡</span></span><br><span class="line">[INFO]  systemd: Starting k3s-agent</span><br></pre></td></tr></table></figure><h3><span id="32-é…ç½®è¦æ±‚">3.2 é…ç½®è¦æ±‚</span></h3><blockquote><p><strong>ç†è§£ Server èŠ‚ç‚¹çš„å®‰è£…ï¼Œä»¥åŠæ³¨å†Œ Agent èŠ‚ç‚¹çš„æ­¥éª¤ï¼</strong></p></blockquote><ul><li>[1] å…ˆå†³æ¡ä»¶<ul><li>é€‰æ‹©ä¸Šï¼Œä¸¤ä¸ªèŠ‚ç‚¹ä¸èƒ½æœ‰ç›¸åŒçš„ä¸»æœºå</li><li>ä¸ä¿®æ”¹ä¸»æœºåå¯ä»¥é€šè¿‡æ·»åŠ éšæœºåç¼€æˆ–æŒ‡å®šä¸»æœºå</li></ul></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¸ºæ¯ä¸ªèŠ‚ç‚¹æ·»åŠ éšæœºåç¼€</span></span><br><span class="line">$ curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh | \</span><br><span class="line">    INSTALL_K3S_MIRROR=cn K3S_URL=https://192.168.100.100:6443 \</span><br><span class="line">    K3S_TOKEN=xxx sh -s - --with-node-id</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸ºæ¯ä¸ªèŠ‚ç‚¹æŒ‡å®šä¸»æœºå</span></span><br><span class="line">$ curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh | \</span><br><span class="line">    K3S_NODE_NAME=<span class="string">"k3s2"</span> INSTALL_K3S_MIRROR=cn \</span><br><span class="line">    K3S_URL=https://192.168.64.3:6443 K3S_TOKEN=xxx sh -</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸ºæ¯ä¸ªèŠ‚ç‚¹æŒ‡å®šä¸»æœºå</span></span><br><span class="line">$ curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh | \</span><br><span class="line">    INSTALL_K3S_MIRROR=cn K3S_URL=https://192.168.64.3:6443 \</span><br><span class="line">    K3S_TOKEN=xxx sh -s - --node-name k3s2</span><br></pre></td></tr></table></figure><ul><li>[2] ç¡¬ä»¶ä¿¡æ¯<ul><li>æ“ä½œç³»ç»Ÿï¼šå¯ä»¥åœ¨å¤§å¤šæ•°ç°ä»£ <code>Linux</code> ç³»ç»Ÿä¸Šè¿è¡Œ</li><li>ç£ç›˜è®¾å¤‡ï¼š<code>K3s</code> çš„æ€§èƒ½å–å†³äºæ•°æ®åº“çš„æ€§èƒ½(å»ºè®®ä½¿ç”¨ <code>SSD</code> ç¡¬ç›˜)</li><li>ç½‘ç»œç›¸å…³ï¼š<code>K3s Server</code> èŠ‚ç‚¹çš„å…¥ç«™è§„åˆ™ï¼Œæ‰€æœ‰å‡ºç«™æµé‡éƒ½æ˜¯å…è®¸çš„</li></ul></li></ul><table><thead><tr><th style="text-align:left">åè®®</th><th style="text-align:left">ç«¯å£</th><th style="text-align:left">æº</th><th style="text-align:left">æè¿°</th></tr></thead><tbody><tr><td style="text-align:left">TCP</td><td style="text-align:left">6443</td><td style="text-align:left">K3s agent èŠ‚ç‚¹</td><td style="text-align:left">Kubernetes API Server</td></tr><tr><td style="text-align:left">UDP</td><td style="text-align:left">8472</td><td style="text-align:left">K3s server å’Œ agent èŠ‚ç‚¹</td><td style="text-align:left">ä»…å¯¹ Flannel VXLAN éœ€è¦</td></tr><tr><td style="text-align:left">TCP</td><td style="text-align:left">10250</td><td style="text-align:left">K3s server å’Œ agent èŠ‚ç‚¹</td><td style="text-align:left">Kubelet metrics</td></tr><tr><td style="text-align:left">TCP</td><td style="text-align:left">2379-2380</td><td style="text-align:left">K3s server èŠ‚ç‚¹</td><td style="text-align:left">åªæœ‰åµŒå…¥å¼ etcd é«˜å¯ç”¨æ‰éœ€è¦</td></tr></tbody></table><ul><li>[3] å®‰è£…é€‰é¡¹<ul><li><a href="https://docs.rancher.cn/docs/k3s/autok3s/_index" target="_blank" rel="noopener">å®˜æ–¹å®‰è£…å‚æ•°æ–‡æ¡£</a></li><li><a href="https://github.com/kingsd041/k3s-tutorial/blob/main/03-%E5%AE%89%E8%A3%85-%E8%A6%81%E6%B1%82%E5%8F%8A%E9%80%89%E9%A1%B9/README.md" target="_blank" rel="noopener">å®‰è£…é€‰é¡¹ç¤ºä¾‹æ¼”ç¤º</a></li></ul></li></ul><table><thead><tr><th style="text-align:left">Environment Variable</th><th style="text-align:left">Description</th></tr></thead><tbody><tr><td style="text-align:left"><code>INSTALL_K3S_EXEC</code></td><td style="text-align:left">ç”¨äºåœ¨æœåŠ¡ä¸­å¯åŠ¨ <code>K3s</code> çš„åç»­å­å‘½ä»¤</td></tr><tr><td style="text-align:left"><code>K3S_CONFIG_FILE</code></td><td style="text-align:left">æŒ‡å®šé…ç½®æ–‡ä»¶çš„ä½ç½®</td></tr><tr><td style="text-align:left"><code>K3S_TOKEN</code></td><td style="text-align:left">ç”¨äºå°† <code>server/agent</code> åŠ å…¥é›†ç¾¤çš„å…±äº« <code>secret</code> å€¼</td></tr><tr><td style="text-align:left"><code>K3S_TOKEN_FILE</code></td><td style="text-align:left">ç”¨äºå°† <code>server/agent</code> åŠ å…¥é›†ç¾¤çš„å…±äº« <code>secret</code> æ–‡ä»¶</td></tr><tr><td style="text-align:left"><code>INSTALL_K3S_VERSION</code></td><td style="text-align:left">æŒ‡å®šä¸‹è½½ <code>K3s</code> çš„ç‰ˆæœ¬</td></tr><tr><td style="text-align:left"><code>K3S_TOKEN_FILE</code></td><td style="text-align:left">æŒ‡å®š  <code>cluster-secret</code>/<code>token</code> çš„æ–‡ä»¶ç›®å½•</td></tr><tr><td style="text-align:left"><code>INSTALL_K3S_SKIP_START</code></td><td style="text-align:left">å°†ä¸ä¼šå¯åŠ¨ <code>K3s</code> æœåŠ¡</td></tr><tr><td style="text-align:left"><code>INSTALL_K3S_SKIP_DOWNLOAD</code></td><td style="text-align:left">ç”¨äºç¦»çº¿å®‰è£…ï¼›è®¾ç½®ä¹‹åä¸ä¼šä¸‹è½½è¿œç¨‹å·¥å…·</td></tr></tbody></table><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å…¶å®å°±æŠŠå¯¹åº”å‚æ•°åŠ åˆ°systemdé…ç½®æ–‡ä»¶é‡Œé¢å»äº†</span></span><br><span class="line">$ curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh | \</span><br><span class="line">    INSTALL_K3S_MIRROR=cn \</span><br><span class="line">    INSTALL_K3S_EXEC=<span class="string">"--docker"</span> sh -</span><br><span class="line"></span><br><span class="line"><span class="comment"># è‡ªåŠ¨åŒ–éƒ¨ç½²(ä¸ç”¨è·å–tokenå€¼äº†)</span></span><br><span class="line"><span class="comment"># ä¸»èŠ‚ç‚¹å’Œå·¥ä½œèŠ‚ç‚¹ä½¿ç”¨æˆ‘ä»¬æŒ‡å®šçš„keyæ¥é€šä¿¡</span></span><br><span class="line">$ curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh | \</span><br><span class="line">    INSTALL_K3S_MIRROR=cn \</span><br><span class="line">    K3S_TOKEN=rancher-k3s sh -</span><br><span class="line">$ sudo cat /var/lib/rancher/k3s/server/token</span><br></pre></td></tr></table></figure><ul><li>[4] å…¶ä»–è¯´æ˜<ul><li>è¿è¡Œ <code>agent</code> æ—¶è¿˜å¿…é¡»è®¾ç½® <code>K3S_TOKEN</code></li><li>ä»¥ <code>K3S_</code> å¼€å¤´çš„ç¯å¢ƒå˜é‡å°†è¢«ä¿ç•™ï¼Œä¾› <code>systemd/openrc</code> ä½¿ç”¨</li><li>æ²¡æœ‰æ˜ç¡®è®¾ç½® <code>exec</code> å¹¶è®¾ç½® <code>K3S_URL</code> çš„è¯ä¼šå°†å‘½ä»¤é»˜è®¤ä¸ºå·¥ä½œèŠ‚ç‚¹</li></ul></li></ul><h3><span id="33-å‘½ä»¤å‚æ•°">3.3 å‘½ä»¤å‚æ•°</span></h3><blockquote><p><strong>ç†è§£ Server èŠ‚ç‚¹çš„å®‰è£…ï¼Œä»¥åŠæ³¨å†Œ Agent èŠ‚ç‚¹çš„æ­¥éª¤ï¼</strong></p></blockquote><p>åœ¨æ•´ä¸ª K3s æ–‡æ¡£ä¸­ï¼Œä½ ä¼šçœ‹åˆ°ä¸€äº›é€‰é¡¹å¯ä»¥ä½œä¸ºå‘½ä»¤æ ‡å¿—å’Œç¯å¢ƒå˜é‡ä¼ é€’è¿›æ¥ï¼Œé‚£è¯¥å¦‚ä½•ä½¿ç”¨æ ‡å¿—å’Œç¯å¢ƒå˜é‡å‘¢ï¼Ÿ</p><ul><li>[1] ä½¿ç”¨æ ‡å¿—å’Œç¯å¢ƒå˜é‡</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨æ ‡å¿—</span></span><br><span class="line">$ curl -sfL https://get.k3s.io | K3S_KUBECONFIG_MODE=<span class="string">"644"</span> sh -s -</span><br><span class="line">$ curl -sfL https://get.k3s.io | sh -s - --write-kubeconfig-mode 644</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¯å¢ƒå˜é‡</span></span><br><span class="line">$ curl -sfL https://get.k3s.io | \</span><br><span class="line">    INSTALL_K3S_EXEC=<span class="string">"--flannel-backend none"</span> sh -s -</span><br><span class="line">$ curl -sfL https://get.k3s.io | \</span><br><span class="line">    sh -s - server --flannel-backend none</span><br></pre></td></tr></table></figure><ul><li>[2] K3s Server/Agent - å¸¸ç”¨é…ç½®</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># write-kubeconfig</span></span><br><span class="line"><span class="comment"># å°†ç®¡ç†å®¢æˆ·ç«¯çš„kubeconfigå†™å…¥è¿™ä¸ªæ–‡ä»¶</span></span><br><span class="line">$ curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh | \</span><br><span class="line">    INSTALL_K3S_MIRROR=cn \</span><br><span class="line">    K3S_KUBECONFIG_OUTPUT=/root/.kube/config \</span><br><span class="line">    sh -</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨dockerä½œä¸ºå®¹å™¨è¿è¡Œæ—¶</span></span><br><span class="line">$ curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh | \</span><br><span class="line">    INSTALL_K3S_MIRROR=cn \</span><br><span class="line">    INSTALL_K3S_EXEC=<span class="string">"--docker"</span> sh -</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŒ‡å®šè¿è¡Œæ—¶å·¥å…·</span></span><br><span class="line">$ curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh | \</span><br><span class="line">    INSTALL_K3S_MIRROR=cn \</span><br><span class="line">    INSTALL_K3S_EXEC=<span class="string">"--container-runtime-endpoint containerd"</span> \</span><br><span class="line">    sh -</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®ç§æœ‰é•œåƒä»“åº“é…ç½®æ–‡ä»¶</span></span><br><span class="line"><span class="comment"># é»˜è®¤é…ç½®æ–‡ä»¶: /etc/rancher/k3s/registries.yaml</span></span><br><span class="line">$ curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh | \</span><br><span class="line">    INSTALL_K3S_MIRROR=cn \</span><br><span class="line">    INSTALL_K3S_EXEC=<span class="string">"--private-registry xxx"</span> \</span><br><span class="line">    sh -</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># é’ˆå¯¹å¤šç½‘å¡ä¸»æœºå®‰è£…K3sé›†ç¾¤</span></span><br><span class="line"><span class="comment"># é»˜è®¤å¤šç½‘å¡ä¼šä½¿ç”¨é»˜è®¤ç½‘å…³çš„é‚£ä¸ªå¡</span></span><br><span class="line">$ rout -n</span><br><span class="line"></span><br><span class="line"><span class="comment"># K3s server</span></span><br><span class="line">$ curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh | \</span><br><span class="line">    INSTALL_K3S_MIRROR=cn \</span><br><span class="line">    INSTALL_K3S_EXEC=<span class="string">"--node-ip=192.168.100.100"</span> \</span><br><span class="line">    sh -</span><br><span class="line"></span><br><span class="line"><span class="comment"># K3s agent</span></span><br><span class="line">$ curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh | \</span><br><span class="line">    INSTALL_K3S_MIRROR=cn \</span><br><span class="line">    K3S_URL=https://192.168.99.211:6443 K3S_TOKEN=xxx \</span><br><span class="line">    INSTALL_K3S_EXEC=<span class="string">"--node-ip=192.168.100.100"</span> \</span><br><span class="line">    sh -</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># --tls-san</span></span><br><span class="line"><span class="comment"># åœ¨TLSè¯ä¹¦ä¸­æ·»åŠ å…¶ä»–ä¸»æœºåæˆ–IPä½œä¸ºä¸»æœºå¤‡ç”¨åç§°</span></span><br><span class="line"><span class="comment"># å³åœ¨å…¬ç½‘ç¯å¢ƒä¸‹å…è®¸é€šè¿‡å…¬ç½‘IPè®¿é—®æ§åˆ¶ã€æ“ä½œè¿œç¨‹é›†ç¾¤</span></span><br><span class="line"><span class="comment"># æˆ–è€…éƒ¨ç½²å¤šä¸ªServerå¹¶ä½¿ç”¨LBè¿›è¡Œè´Ÿè´£ï¼Œå°±éœ€è¦ä¿ç•™å…¬ç½‘åœ°å€</span></span><br><span class="line">$ curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh | \</span><br><span class="line">    INSTALL_K3S_MIRROR=cn \</span><br><span class="line">    INSTALL_K3S_EXEC=<span class="string">"--tls-san 1.1.1.1"</span>  \</span><br><span class="line">    sh -</span><br><span class="line"></span><br><span class="line"><span class="comment"># è·å–é…ç½®</span></span><br><span class="line">$ kubectl get secret k3s-serving -n kube-system -o yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç„¶åæœ¬æœºå¤åˆ¶å…¬ç½‘ä¸»èŠ‚ç‚¹å¯¹åº”çš„yamlæ–‡ä»¶å³å¯æœ¬åœ°æ“ä½œäº†</span></span><br><span class="line">$ scp ci@1.1.1.1:/etc/rancher/k3s/k3s.yaml ~/.kube/config</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¿®æ”¹å¯åŠ¨çš„æœåŠ¡å¯¹åº”é…ç½®(è°ƒæ•´èŠ‚ç‚¹çš„å¯åŠ¨çš„æœ€å¤§Podæ•°é‡)</span></span><br><span class="line">$ curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh | \</span><br><span class="line">    INSTALL_K3S_MIRROR=cn \</span><br><span class="line">    INSTALL_K3S_EXEC=<span class="string">'--kubelet-arg=max-pods=200'</span> \</span><br><span class="line">    sh -</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿®æ”¹å¯åŠ¨çš„æœåŠ¡å¯¹åº”é…ç½®(ä½¿ç”¨ipvsä½œä¸ºæœåŠ¡è°ƒåº¦å·¥å…·)</span></span><br><span class="line">$ curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh | \</span><br><span class="line">    INSTALL_K3S_MIRROR=cn \</span><br><span class="line">    INSTALL_K3S_EXEC=<span class="string">'--kube-proxy-arg=proxy-mode=ipvs'</span> \</span><br><span class="line">    sh -</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿®æ”¹å¯åŠ¨çš„æœåŠ¡å¯¹åº”é…ç½®(è°ƒæ•´æœåŠ¡å¯åŠ¨çš„ç«¯å£èŒƒå›´)</span></span><br><span class="line">$ curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh | \</span><br><span class="line">    INSTALL_K3S_MIRROR=cn \</span><br><span class="line">    INSTALL_K3S_EXEC=<span class="string">'--kube-apiserver-arg=service-node-port-range=40000-50000'</span> \</span><br><span class="line">    sh -</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubelet-arg     --kubelet-arg</span></span><br><span class="line"><span class="comment"># kube-apiserver  --kube-apiserver-arg</span></span><br><span class="line"><span class="comment"># kube-proxy-arg  --kube-proxy-arg</span></span><br><span class="line"><span class="comment"># kube-proxy-arg  --kube-proxy-arg=proxy-mode=ipvs</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># --data-dir</span></span><br><span class="line"><span class="comment"># ä¿®æ”¹K3sæ•°æ®å­˜å‚¨ç›®å½•</span></span><br><span class="line">$ curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh | \</span><br><span class="line">    INSTALL_K3S_MIRROR=cn \</span><br><span class="line">    INSTALL_K3S_EXEC=<span class="string">'--data-dir=/opt/k3s-data'</span> \</span><br><span class="line">    sh -</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç¦ç”¨ç»„ä»¶</span></span><br><span class="line">$ curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh | \</span><br><span class="line">    INSTALL_K3S_MIRROR=cn \</span><br><span class="line">    INSTALL_K3S_EXEC=<span class="string">'--disable traefik'</span> \</span><br><span class="line">    sh -</span><br><span class="line"></span><br><span class="line"><span class="comment"># è‡ªå·±åŠ è‡ªå·±éœ€è¦çš„æœåŠ¡</span></span><br><span class="line">$ ls /var/lib/rancher/k3s/server/manifests</span><br><span class="line">$ kubectl get pods -A | grep traefik</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ·»åŠ labelå’Œtaintæ ‡è¯†</span></span><br><span class="line">$ curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh | \</span><br><span class="line">    INSTALL_K3S_MIRROR=cn \</span><br><span class="line">    INSTALL_K3S_EXEC=<span class="string">'--node-label foo=bar,hello=world \</span></span><br><span class="line"><span class="string">        --node-taint key1=value1:NoExecute'</span></span><br><span class="line">    sh -</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹ä¸€ä¸‹</span></span><br><span class="line">$ kubectl describe nodes</span><br></pre></td></tr></table></figure><ul><li>[3] K3s Server/Agent - æ•°æ®åº“é€‰é¡¹</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŒ‡å®šæ•°æ®æºåç§°</span></span><br><span class="line"><span class="comment"># æ ‡å¿—ä½: --datastore-endpoint&amp;nbsp;value</span></span><br><span class="line"><span class="comment"># ç¯å¢ƒå˜é‡: K3S_DATASTORE_ENDPOINT</span></span><br><span class="line">$ curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh | \</span><br><span class="line">    INSTALL_K3S_MIRROR=cn \</span><br><span class="line">    INSTALL_K3S_EXEC=<span class="string">'--datastore-endpoint&amp;nbsp;etcd'</span> \</span><br><span class="line">    sh -</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cronè§„èŒƒä¸­çš„å¿«ç…§é—´éš”æ—¶é—´</span></span><br><span class="line"><span class="comment"># --etcd-snapshot-schedule-cron&amp;nbsp;value</span></span><br><span class="line">$ curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh | \</span><br><span class="line">    INSTALL_K3S_MIRROR=cn \</span><br><span class="line">    INSTALL_K3S_EXEC=<span class="string">'--etcd-snapshot-schedule-cron *&amp;nbsp;*/5&amp;nbsp;*&amp;nbsp;*&amp;nbsp;*'</span> \</span><br><span class="line">    sh -</span><br></pre></td></tr></table></figure><h3><span id="34-ç½‘ç»œé€‰é¡¹">3.4 ç½‘ç»œé€‰é¡¹</span></h3><blockquote><p><strong>ç†è§£ Server èŠ‚ç‚¹çš„å®‰è£…ï¼Œä»¥åŠæ³¨å†Œ Agent èŠ‚ç‚¹çš„æ­¥éª¤ï¼</strong></p></blockquote><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œ<code>K3s</code> å°†ä»¥ <code>flannel</code> ä½œä¸º <code>CNI</code> è¿è¡Œï¼Œä½¿ç”¨ <code>VXLAN</code> ä½œä¸ºé»˜è®¤åç«¯ï¼Œ<code>CNI</code> å’Œé»˜è®¤åç«¯éƒ½å¯ä»¥é€šè¿‡å‚æ•°ä¿®æ”¹ã€‚è¦å¯ç”¨åŠ å¯†ï¼Œè¯·ä½¿ç”¨ä¸‹é¢çš„ <code>IPSec</code> æˆ– <code>WireGuard</code> é€‰é¡¹ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># é»˜è®¤å®‰è£…K3sä¹‹åçš„ç½‘ç»œé…ç½®</span></span><br><span class="line">$ sudo cat /var/lib/rancher/k3s/agent/etc/flannel/net-conf.json</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"Network"</span>: <span class="string">"10.42.0.0/16"</span>,</span><br><span class="line">    <span class="string">"EnableIPv6"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">"EnableIPv4"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">"IPv6Network"</span>: <span class="string">"::/0"</span>,</span><br><span class="line">    <span class="string">"Backend"</span>: &#123;</span><br><span class="line">        <span class="string">"Type"</span>: <span class="string">"vxlan"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><table><thead><tr><th style="text-align:left">CLI Flag å’Œ Value</th><th style="text-align:left">æè¿°</th></tr></thead><tbody><tr><td style="text-align:left"><code>--flannel-backend=vxlan</code></td><td style="text-align:left">ä½¿ç”¨ <code>VXLAN</code> åç«¯(é»˜è®¤)</td></tr><tr><td style="text-align:left"><code>--flannel-backend=host-gw</code></td><td style="text-align:left">ä½¿ç”¨ <code>host-gw</code> åç«¯</td></tr><tr><td style="text-align:left"><code>--flannel-backend=ipsec</code></td><td style="text-align:left">ä½¿ç”¨ <code>IPSEC</code> åç«¯ï¼›å¯¹ç½‘ç»œæµé‡è¿›è¡ŒåŠ å¯†</td></tr><tr><td style="text-align:left"><code>--flannel-backend=wireguard</code></td><td style="text-align:left">ä½¿ç”¨ <code>WireGuard</code> åç«¯ï¼›å¯¹ç½‘ç»œæµé‡è¿›è¡ŒåŠ å¯†</td></tr></tbody></table><ul><li>é…ç½® Flannel é€‰é¡¹</li></ul><p>è¿™æ ·ï¼Œæˆ‘å°±å¯ä»¥åœ¨å®‰è£… <code>K3s</code> æˆ–è€…ä¹‹åä¿®æ”¹å¯¹åº”é…ç½®æ–‡ä»¶ï¼Œæ¥ä¿®æ”¹ <code>Flannel</code> é»˜è®¤çš„åç«¯ç½‘ç»œé…ç½®é€‰é¡¹(é‡å¯ä¼šè¦†ç›–ä¸ç”Ÿæ•ˆ)äº†ã€‚ä¸‹é¢ï¼Œæˆ‘ä»¬æ¼”ç¤ºä¸‹ï¼Œå¦‚ä½•ä¿®æ”¹ä¸º <code>host-gw</code> æ¨¡å¼ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¸»èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment"># flannel-backendä½¿ç”¨host-gw</span></span><br><span class="line"><span class="comment"># è¯¥æ¨¡å¼ä¼šæŠŠå¯¹ç«¯ä¸»æœºçš„IPå½“åšé»˜è®¤ç½‘ç®¡(å¤šServeræƒ…å†µ)</span></span><br><span class="line">$ curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh | \</span><br><span class="line">    INSTALL_K3S_MIRROR=cn \</span><br><span class="line">    INSTALL_K3S_EXEC=<span class="string">'--flannel-backend=host-gw'</span> \</span><br><span class="line">    sh -</span><br><span class="line"></span><br><span class="line"><span class="comment"># å·¥ä½œèŠ‚ç‚¹</span></span><br><span class="line">$ curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh | \</span><br><span class="line">    INSTALL_K3S_MIRROR=cn K3S_URL=https://192.168.100.100:6443 \</span><br><span class="line">    K3S_TOKEN=xxx sh -</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># é»˜è®¤çš„è·¯ç”±ä¿¡æ¯</span></span><br><span class="line">$ route -n</span><br><span class="line">0.0.0.0         172.16.64.1     0.0.0.0         UG    100    0        0 enp0s2</span><br><span class="line">10.42.1.0       172.16.64.9     255.255.255.0   UG    0      0        0 enp0s2</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹é…ç½®ä¹‹åçš„ç½‘ç»œé…ç½®</span></span><br><span class="line">$ sudo cat /var/lib/rancher/k3s/agent/etc/flannel/net-conf.json</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"Network"</span>: <span class="string">"10.42.0.0/16"</span>,</span><br><span class="line">    <span class="string">"Backend"</span>: &#123;</span><br><span class="line">        <span class="string">"Type"</span>: <span class="string">"host-gw"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å¯ç”¨ Directrouting ç‰¹æ€§</li></ul><p><strong>Flannel è‡ªèº«çš„ç‰¹æ€§</strong>ï¼šå½“ä¸»æœºåœ¨åŒä¸€å­ç½‘æ—¶ï¼Œå¯ç”¨ <code>direct routes</code>(å¦‚ <code>host-gw</code>)ã€‚<code>vxlan</code> åªç”¨äºå°†æ•°æ®åŒ…å°è£…åˆ°ä¸åŒå­ç½‘çš„ä¸»æœºä¸Šï¼ŒåŒå­ç½‘çš„ä¸»æœºä¹‹é—´ä½¿ç”¨  <code>host-gw</code>ï¼Œé»˜è®¤å€¼ä¸º  <code>false</code>ã€‚</p><p>è¦æ·»åŠ æˆ‘ä»¬å°±ä¸èƒ½ä¿®æ”¹å…¶å¯¹åº”çš„ç½‘ç»œé…ç½®æ–‡ä»¶ï¼Œå› ä¸ºé‡æ–°å®‰è£…æˆ–è€…é‡å¯éƒ½ä¼šæŠŠè¿™ä¸ªé…ç½®å†²æ‰(å˜æˆé»˜è®¤é…ç½®)ï¼Œæ‰€ä»¥éœ€è¦æŠ˜ä¸­ä¸‹ã€‚æˆ‘ä»¬è‡ªå»ºä¸€ä¸ªç½‘ç»œé…ç½®æ–‡ä»¶ï¼Œç„¶ååœ¨å¯åŠ¨çš„æ—¶å€™æ‰§è¡Œä»å“ªä¸ªé…ç½®æ–‡ä»¶é‡Œé¢åŠ è½½å¯¹åº”é…ç½®ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># k3sçš„masterå’Œagent</span></span><br><span class="line">$ sudo cat /etc/flannel/net-conf.json</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"Network"</span>: <span class="string">"10.42.0.0/16"</span>,</span><br><span class="line">    <span class="string">"Backend"</span>: &#123;</span><br><span class="line">        <span class="string">"Type"</span>: <span class="string">"vxlan"</span>,</span><br><span class="line">        <span class="string">"Directrouting"</span>: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># k3s master</span></span><br><span class="line">$ curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh | \</span><br><span class="line">    INSTALL_K3S_MIRROR=cn \</span><br><span class="line">    INSTALL_K3S_EXEC=<span class="string">'--flannel-backend=host-gw'</span> \</span><br><span class="line">    sh -</span><br></pre></td></tr></table></figure><ul><li>è‡ªå®šä¹‰ CNI</li></ul><p>ä½¿ç”¨  <code>--flannel-backend=none</code>(ç¦ç”¨) è¿è¡Œ <code>K3s</code>ï¼Œç„¶ååœ¨å®‰è£…ä½ é€‰æ‹©çš„ <code>CNI</code>ã€‚æŒ‰ç…§ <a href="https://docs.projectcalico.org/master/reference/cni-plugin/configuration" target="_blank" rel="noopener">Calico CNI æ’ä»¶æŒ‡å—</a> æ¥ä¿®æ”¹ <code>Calico</code> çš„ <code>YAML</code> é…ç½®æ–‡ä»¶ï¼Œåœ¨ <code>container_settings</code> éƒ¨åˆ†ä¸­å…è®¸ <code>IP</code> è½¬å‘ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åŠ åˆ°Calicoçš„YAMLæ–‡ä»¶ä¸­</span></span><br><span class="line"><span class="comment"># å…è®¸IPè½¬å‘(è¿™ä¸ªæ˜¯K3sçš„ä¸€ä¸ªé™åˆ¶ï¼›éœ€è¦å¼€å¯)</span></span><br><span class="line"><span class="string">"container_settings"</span>: &#123;</span><br><span class="line">    <span class="string">"allow_ip_forwarding"</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- name: CALICO_IPV4POOL_CIDR</span><br><span class="line">  value: <span class="string">"192.168.200.0/24"</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># é€šè¿‡åœ¨ä¸»æœºä¸Šè¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œç¡®ä¿è®¾ç½®å·²è¢«åº”ç”¨(true)</span></span><br><span class="line">$ sudo cat /etc/cni/net.d/10-canal.conflist</span><br><span class="line"></span><br><span class="line"><span class="comment"># calico</span></span><br><span class="line"><span class="comment"># å…¶ä¸­--cluster-cidrå¯ä¸è®¾ç½®</span></span><br><span class="line">$ curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh | \</span><br><span class="line">    INSTALL_K3S_MIRROR=cn \</span><br><span class="line">    INSTALL_K3S_EXEC=<span class="string">'--flannel-backend=none \</span></span><br><span class="line"><span class="string">        --cluster-cidr=192.168.200.0/24"'</span> \</span><br><span class="line">    sh -</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯åŠ¨ç½‘ç»œæœåŠ¡</span></span><br><span class="line">$ kubectl apply -f ./calico.yaml</span><br></pre></td></tr></table></figure><h3><span id="35-å¤–éƒ¨æ•°æ®åº“">3.5 å¤–éƒ¨æ•°æ®åº“</span></h3><blockquote><p><strong>ç†è§£ Server èŠ‚ç‚¹çš„å®‰è£…ï¼Œä»¥åŠæ³¨å†Œ Agent èŠ‚ç‚¹çš„æ­¥éª¤ï¼</strong></p></blockquote><ul><li>[1] ä½¿ç”¨å¤–éƒ¨æ•°æ®åº“å®ç°é«˜å¯ç”¨å®‰è£…<ul><li>ä¸¤ä¸ªæˆ–å¤šä¸ª<code>server</code> èŠ‚ç‚¹</li><li>é›¶ä¸ªæˆ–å¤šä¸ª<code>agent</code> èŠ‚ç‚¹</li><li>å¤–éƒ¨æ•°æ®å­˜å‚¨(<code>Etcd/MySQL/PostgRES</code>)</li><li>å›ºå®šçš„æ³¨å†Œåœ°å€(<code>LB</code>)</li><li><a href="https://mp.weixin.qq.com/s/0Wk2MzfWqMqt8DfUK_2ICA" target="_blank" rel="noopener">è¿™åº”è¯¥æ˜¯æœ€é€‚åˆå›½å†…ç”¨æˆ·çš„ K3s HA æ–¹æ¡ˆ</a></li></ul></li></ul><p>è™½ç„¶å•èŠ‚ç‚¹ <code>k3s server</code> é›†ç¾¤å¯ä»¥æ»¡è¶³å„ç§ç”¨ä¾‹ï¼Œä½†æ˜¯å¯¹äºéœ€è¦ç¨³å®šè¿è¡Œçš„é‡è¦ç¯å¢ƒï¼Œå¯ä»¥åœ¨ <code>HA</code> é…ç½®ä¸­è¿è¡Œ <code>K3s</code>ï¼Œå¦‚ä½•ä½¿ç”¨å¤–éƒ¨æ•°æ®åº“å®‰è£…ä¸€ä¸ªé«˜å¯ç”¨çš„ <code>K3s</code> é›†ç¾¤ï¼Ÿ</p><p><img src="https://img.hi-linux.com/staticfile/advance-k3s-tool-03-20220519092423240-2022-05-19-amkNto.png" alt="K3Så®‰è£…äº‹é¡¹ - å¤–éƒ¨æ•°æ®åº“"></p><table><thead><tr><th style="text-align:left">ä¸»æœºå</th><th style="text-align:left">è§’è‰²</th><th style="text-align:left">IP</th></tr></thead><tbody><tr><td style="text-align:left">k3s-server-1</td><td style="text-align:left">k3s master</td><td style="text-align:left">172.31.2.134</td></tr><tr><td style="text-align:left">k3s-server-2</td><td style="text-align:left">k3s master</td><td style="text-align:left">172.31.2.42</td></tr><tr><td style="text-align:left">k3s-db</td><td style="text-align:left">DB</td><td style="text-align:left">172.31.10.251</td></tr><tr><td style="text-align:left">k3s-lb</td><td style="text-align:left">LB</td><td style="text-align:left">172.31.13.97</td></tr><tr><td style="text-align:left">k3s-agent</td><td style="text-align:left">k3s agent</td><td style="text-align:left">172.31.15.130</td></tr></tbody></table><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.åˆ›å»ºä¸€ä¸ªå¤–éƒ¨æ•°æ®å­˜å‚¨</span></span><br><span class="line">$ docker run --name some-mysql \</span><br><span class="line">    --restart=unless-stopped -p 3306:3306 \</span><br><span class="line">    -e MYSQL_ROOT_PASSWORD=password -d mysql:5.7</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.å¯åŠ¨k3s-serverèŠ‚ç‚¹(æœ‰è¯»å†™æƒé™ä¸ç”¨åŠ åº“å)</span></span><br><span class="line"><span class="comment"># mysql://username:password@tcp(hostname:3306)/database-name</span></span><br><span class="line"><span class="comment"># å¯åŠ æ±¡ç‚¹ --node-taint CriticalAddonsOnly=true:NoExecute</span></span><br><span class="line">$ curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh | \</span><br><span class="line">    INSTALL_K3S_MIRROR=cn sh - server \</span><br><span class="line">    --datastore-endpoint=<span class="string">"mysql://root:password@ip:3306/k3s"</span> \</span><br><span class="line">    --tls-san 172.31.13.97</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 3.é…ç½®å›ºå®šçš„æ³¨å†Œåœ°å€(k3s-lbèŠ‚ç‚¹)</span></span><br><span class="line"><span class="comment"># AgentèŠ‚ç‚¹éœ€è¦ä¸€ä¸ªURLæ¥æ³¨å†Œ(LB)</span></span><br><span class="line">$ cat &gt;&gt; /etc/nginx.conf &lt;&lt;EOF</span><br><span class="line">worker_processes 4;</span><br><span class="line">worker_rlimit_nofile 40000;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections 8192;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">stream &#123;</span><br><span class="line">    upstream k3s_api &#123;</span><br><span class="line">        least_conn;</span><br><span class="line">        server 172.31.2.134:6443 max_fails=3 fail_timeout=5s;</span><br><span class="line">        server 172.31.2.42:6443 max_fails=3 fail_timeout=5s;</span><br><span class="line">    &#125;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen     6443;</span><br><span class="line">        proxy_pass k3s_api;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯åŠ¨æœåŠ¡</span></span><br><span class="line">$ docker run -d --restart=unless-stopped \</span><br><span class="line">  -p 6443:6443 \</span><br><span class="line">  -v /etc/nginx.conf:/etc/nginx/nginx.conf \</span><br><span class="line">  nginx:1.14</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 4.åŠ å…¥AgentèŠ‚ç‚¹</span></span><br><span class="line"><span class="comment"># Agentä¼šä¿å­˜LBèŠ‚ç‚¹å’Œæ¯ä¸ªServerèŠ‚ç‚¹çš„IPä¿¡æ¯</span></span><br><span class="line"><span class="comment"># cat /var/lib/rancher/k3s/agent/etc/k3s-agent-load-balancer.json</span></span><br><span class="line">$ curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh | \</span><br><span class="line">    INSTALL_K3S_MIRROR=cn</span><br><span class="line">    K3S_URL=https://172.31.13.97:6443 K3S_TOKEN=mynodetoken \</span><br><span class="line">    sh -</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5.é€šè¿‡kubeconfigè®¿é—®K3sé›†ç¾¤</span></span><br><span class="line">$ kubectl get nodes</span><br><span class="line">NAME           STATUS   ROLES                  AGE   VERSION</span><br><span class="line">k3s-server-1   Ready    control-plane,master   68s   v1.20.7+k3s1</span><br><span class="line">k3s-server-2   Ready    control-plane,master   66s   v1.20.7+k3s1</span><br></pre></td></tr></table></figure><ul><li>[2] åµŒå…¥å¼ DB çš„é«˜å¯ç”¨</li></ul><p>è¦åœ¨è¿™ç§æ¨¡å¼ä¸‹è¿è¡Œ <code>K3s</code>ï¼Œä½ å¿…é¡»æœ‰å¥‡æ•°çš„æœåŠ¡å™¨èŠ‚ç‚¹ï¼Œå»ºè®®ä»ä¸‰ä¸ªèŠ‚ç‚¹å¼€å§‹ã€‚åœ¨åµŒå…¥å¼ä¸­ï¼Œé»˜è®¤ä½¿ç”¨ <code>Etcd</code> ä½œä¸ºé«˜å¯ç”¨çš„æ•°æ®åº“ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æœåŠ¡å™¨èŠ‚ç‚¹(å¯åŠ¨etcdé›†ç¾¤)</span></span><br><span class="line"><span class="comment"># SECRETæˆ‘ä»¬é¢„å®šä¸€ä¸ªkeyå€¼</span></span><br><span class="line"><span class="comment"># ä½¿ç”¨cluster-initæ ‡å¿—æ¥å¯ç”¨é›†ç¾¤</span></span><br><span class="line"><span class="comment"># å¹¶ä½¿ç”¨ä¸€ä¸ªæ ‡è®°ä½œä¸ºå…±äº«çš„å¯†é’¥æ¥åŠ å…¥å…¶ä»–æœåŠ¡å™¨åˆ°é›†ç¾¤ä¸­</span></span><br><span class="line">$ curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh | \</span><br><span class="line">    INSTALL_K3S_MIRROR=cn K3S_TOKEN=SECRET \</span><br><span class="line">    sh -s - --cluster-init</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹ç±»å‹</span></span><br><span class="line">$ sudo  kubectl get nodes</span><br><span class="line">NAME    STATUS  ROLES                      AGE  VERSION</span><br><span class="line">ip-xxx  Ready   control-plane,etcd,master  19h  v1.23.6+k3s1</span><br><span class="line"></span><br><span class="line"><span class="comment"># å…¶ä»–æœåŠ¡å™¨èŠ‚ç‚¹(2/3)</span></span><br><span class="line">$ curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh | \</span><br><span class="line">    INSTALL_K3S_MIRROR=cn K3S_TOKEN=SECRET \</span><br><span class="line">    sh -s - --server https://&lt;ip-or-host-server&gt;:6443</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥è¯¢ETCDé›†ç¾¤çŠ¶æ€</span></span><br><span class="line"><span class="comment"># etcdè¯ä¹¦é»˜è®¤ç›®å½•ï¼š/var/lib/rancher/k3s/server/tls/etcd</span></span><br><span class="line"><span class="comment"># etcdæ•°æ®é»˜è®¤ç›®å½•ï¼š/var/lib/rancher/k3s/server/db/etcd</span></span><br><span class="line">$ ETCDCTL_ENDPOINTS=<span class="string">'https://172.31.12.136:2379,\</span></span><br><span class="line"><span class="string">    https://172.31.4.43:2379,\</span></span><br><span class="line"><span class="string">    https://172.31.4.190:2379'</span> \</span><br><span class="line">ETCDCTL_CACERT=<span class="string">'/var/lib/rancher/k3s/server/tls/etcd/server-ca.crt'</span> \</span><br><span class="line">ETCDCTL_CERT=<span class="string">'/var/lib/rancher/k3s/server/tls/etcd/server-client.crt'</span>\</span><br><span class="line">ETCDCTL_KEY=<span class="string">'/var/lib/rancher/k3s/server/tls/etcd/server-client.key'</span> \</span><br><span class="line">ETCDCTL_API=3 etcdctl endpoint status --write-out=table</span><br></pre></td></tr></table></figure><ul><li>[3] é›†ç¾¤æ•°æ®å­˜å‚¨é€‰é¡¹</li></ul><p>ä½¿ç”¨ <code>etcd</code> ä»¥å¤–çš„æ•°æ®å­˜å‚¨è¿è¡Œ <code>K8S</code> çš„èƒ½åŠ›ä½¿ <code>K3s</code> åŒºåˆ«äºå…¶ä»– <code>K8S</code> å‘è¡Œç‰ˆã€‚è¯¥åŠŸèƒ½ä¸º <code>K8S</code> æ“ä½œè€…æä¾›äº†çµæ´»æ€§ï¼Œå¯ç”¨çš„æ•°æ®å­˜å‚¨é€‰é¡¹å…è®¸ä½ é€‰æ‹©ä¸€ä¸ªæœ€é€‚åˆç”¨ä¾‹çš„æ•°æ®å­˜å‚¨ã€‚</p><p>å¦‚æœä½ çš„å›¢é˜Ÿæ²¡æœ‰æ“ä½œ <code>etcd</code> çš„ä¸“ä¸šçŸ¥è¯†ï¼Œå¯ä»¥é€‰æ‹© <code>MySQL</code> æˆ– <code>PostgreSQL</code> ç­‰ä¼ä¸šçº§ <code>SQL</code> æ•°æ®åº“ã€‚å¦‚æœæ‚¨éœ€è¦åœ¨ <code>CI/CD</code> ç¯å¢ƒä¸­è¿è¡Œä¸€ä¸ªç®€å•çš„ã€çŸ­æš‚çš„é›†ç¾¤ï¼Œå¯ä»¥ä½¿ç”¨åµŒå…¥å¼ <code>SQLite</code> æ•°æ®åº“</p><p>å¦‚æœä½ æƒ³ä½¿ç”¨å¤–éƒ¨æ•°æ®å­˜å‚¨ï¼Œå¦‚ <code>PostgreSQL</code>ã€<code>MySQL</code> æˆ– <code>etcd</code>ï¼Œä½ å¿…é¡»è®¾ç½® <code>datastore-endpoint</code> å‚æ•°ï¼Œä»¥ä¾¿ <code>K3s</code> çŸ¥é“å¦‚ä½•è¿æ¥åˆ°å®ƒï¼Œä¹Ÿå¯ä»¥æŒ‡å®šå‚æ•°æ¥é…ç½®è¿æ¥çš„è®¤è¯å’ŒåŠ å¯†ã€‚ä¸‹è¡¨æ€»ç»“äº†è¿™äº›å‚æ•°ï¼Œå®ƒä»¬å¯ä»¥ä½œä¸º <code>CLI</code> æ ‡å¿—æˆ–ç¯å¢ƒå˜é‡ä¼ é€’ã€‚</p><table><thead><tr><th style="text-align:left">CLI Flag</th><th style="text-align:left">ç¯å¢ƒå˜é‡</th><th style="text-align:left">æè¿°</th></tr></thead><tbody><tr><td style="text-align:left"><code>--datastore-endpoint</code></td><td style="text-align:left"><code>K3S_DATASTORE_ENDPOINT</code></td><td style="text-align:left">æŒ‡å®šä¸€ä¸ª PostgresSQLã€MySQL æˆ– etcd è¿æ¥å­—ç¬¦ä¸²ã€‚ç”¨äºæè¿°ä¸æ•°æ®å­˜å‚¨çš„è¿æ¥ã€‚è¿™ä¸ªå­—ç¬¦ä¸²çš„ç»“æ„æ˜¯ç‰¹å®šäºæ¯ä¸ªåç«¯çš„ï¼Œè¯¦æƒ…å¦‚ä¸‹ã€‚</td></tr><tr><td style="text-align:left"><code>--datastore-cafile</code></td><td style="text-align:left"><code>K3S_DATASTORE_CAFILE</code></td><td style="text-align:left">TLS è¯ä¹¦é¢å‘æœºæ„ï¼ˆCAï¼‰æ–‡ä»¶ï¼Œç”¨äºå¸®åŠ©ç¡®ä¿ä¸æ•°æ®å­˜å‚¨çš„é€šä¿¡å®‰å…¨ã€‚å¦‚æœä½ çš„æ•°æ®å­˜å‚¨é€šè¿‡ TLS æœåŠ¡è¯·æ±‚ï¼Œä½¿ç”¨ç”±è‡ªå®šä¹‰è¯ä¹¦é¢å‘æœºæ„ç­¾ç½²çš„è¯ä¹¦ï¼Œä½ å¯ä»¥ä½¿ç”¨è¿™ä¸ªå‚æ•°æŒ‡å®šè¯¥ CAï¼Œè¿™æ · K3s å®¢æˆ·ç«¯å°±å¯ä»¥æ­£ç¡®éªŒè¯è¯ä¹¦ã€‚</td></tr><tr><td style="text-align:left"><code>--datastore-certfile</code></td><td style="text-align:left"><code>K3S_DATASTORE_CERTFILE</code></td><td style="text-align:left">TLS è¯ä¹¦æ–‡ä»¶ï¼Œç”¨äºå¯¹æ•°æ®å­˜å‚¨è¿›è¡ŒåŸºäºå®¢æˆ·ç«¯è¯ä¹¦çš„éªŒè¯ã€‚è¦ä½¿ç”¨è¿™ä¸ªåŠŸèƒ½ï¼Œä½ çš„æ•°æ®å­˜å‚¨å¿…é¡»è¢«é…ç½®ä¸ºæ”¯æŒåŸºäºå®¢æˆ·ç«¯è¯ä¹¦çš„è®¤è¯ã€‚å¦‚æœä½ æŒ‡å®šäº†è¿™ä¸ªå‚æ•°ï¼Œä½ è¿˜å¿…é¡»æŒ‡å®š<code>datastore-keyfile</code>å‚æ•°ã€‚</td></tr><tr><td style="text-align:left"><code>--datastore-keyfile</code></td><td style="text-align:left"><code>K3S_DATASTORE_KEYFILE</code></td><td style="text-align:left">TLS å¯†é’¥æ–‡ä»¶ï¼Œç”¨äºå¯¹æ•°æ®å­˜å‚¨è¿›è¡ŒåŸºäºå®¢æˆ·ç«¯è¯ä¹¦çš„è®¤è¯ã€‚æ›´å¤šç»†èŠ‚è¯·å‚è§å‰é¢çš„<code>datastore-certfile</code>å‚æ•°ã€‚</td></tr></tbody></table><p>ä½œä¸ºæœ€ä½³å®è·µï¼Œæˆ‘ä»¬å»ºè®®å°†è¿™äº›å‚æ•°è®¾ç½®ä¸ºç¯å¢ƒå˜é‡ï¼Œè€Œä¸æ˜¯å‘½ä»¤è¡Œå‚æ•°ï¼Œè¿™æ ·ä½ çš„æ•°æ®åº“è¯ä¹¦æˆ–å…¶ä»–æ•æ„Ÿä¿¡æ¯å°±ä¸ä¼šä½œä¸ºè¿›ç¨‹ä¿¡æ¯çš„ä¸€éƒ¨åˆ†æš´éœ²å‡ºæ¥ã€‚</p><h3><span id="36-ç§æœ‰é•œåƒä»“åº“">3.6 ç§æœ‰é•œåƒä»“åº“</span></h3><blockquote><p><strong>ç†è§£ Server èŠ‚ç‚¹çš„å®‰è£…ï¼Œä»¥åŠæ³¨å†Œ Agent èŠ‚ç‚¹çš„æ­¥éª¤ï¼</strong></p></blockquote><p><code>K3s</code> é»˜è®¤ä½¿ç”¨ <code>containerd</code> ä½œä¸ºå®¹å™¨è¿è¡Œæ—¶ï¼Œæ‰€ä»¥åœ¨ <code>docker</code> ä¸Šé…ç½®é•œåƒä»“åº“æ˜¯ä¸ç”Ÿæ•ˆçš„ã€‚<code>K3s</code> é•œåƒä»“åº“é…ç½®æ–‡ä»¶ç”±ä¸¤å¤§éƒ¨åˆ†ç»„æˆï¼š<code>mirrors</code> å’Œ  <code>configs</code>ã€‚</p><ul><li><code>Mirrors</code> æ˜¯ä¸€ä¸ªç”¨äºå®šä¹‰ä¸“ç”¨é•œåƒä»“åº“çš„åç§°å’Œ <code>endpoint</code> çš„æŒ‡ä»¤</li><li><code>Configs</code> éƒ¨åˆ†å®šä¹‰äº†æ¯ä¸ª <code>mirror</code> çš„ <code>TLS</code> å’Œè¯ä¹¦é…ç½®</li><li>å¯¹äºæ¯ä¸ª <code>mirror</code>ï¼Œä½ å¯ä»¥å®šä¹‰ <code>auth</code> å’Œ <code>/</code> æˆ– <code>tls</code></li></ul><p><code>K3s registry</code> é…ç½®ç›®å½•ä¸ºï¼š <code>/etc/rancher/k3s/registries.yaml</code>ã€‚<code>K3s</code> å¯åŠ¨æ—¶ä¼šæ£€æŸ¥  <code>/etc/rancher/k3s/</code> ä¸­æ˜¯å¦å­˜åœ¨  <code>registries.yaml</code> æ–‡ä»¶ï¼Œå¹¶æŒ‡ç¤º <code>containerd</code> ä½¿ç”¨æ–‡ä»¶ä¸­å®šä¹‰çš„é•œåƒä»“åº“ã€‚å¦‚æœä½ æƒ³ä½¿ç”¨ä¸€ä¸ªç§æœ‰çš„é•œåƒä»“åº“ï¼Œé‚£ä¹ˆä½ éœ€è¦åœ¨æ¯ä¸ªä½¿ç”¨é•œåƒä»“åº“çš„èŠ‚ç‚¹ä¸Šä»¥ <code>root</code> èº«ä»½åˆ›å»ºè¿™ä¸ªæ–‡ä»¶ã€‚</p><p>è¯·æ³¨æ„ï¼Œ<code>server</code> èŠ‚ç‚¹é»˜è®¤æ˜¯å¯ä»¥è°ƒåº¦çš„ã€‚å¦‚æœä½ æ²¡æœ‰åœ¨ <code>server</code> èŠ‚ç‚¹ä¸Šè®¾ç½®æ±¡ç‚¹ï¼Œé‚£ä¹ˆå°†åœ¨å®ƒä»¬ä¸Šè¿è¡Œå·¥ä½œè´Ÿè½½ï¼Œè¯·ç¡®ä¿åœ¨æ¯ä¸ª <code>server</code> èŠ‚ç‚¹ä¸Šåˆ›å»º  <code>registries.yaml</code> æ–‡ä»¶ã€‚</p><p><code>containerd</code> ä½¿ç”¨äº†ç±»ä¼¼ <code>K8S</code> ä¸­ <code>svc</code> ä¸ <code>endpoint</code> çš„æ¦‚å¿µï¼Œ<code>svc</code> å¯ä»¥ç†è§£ä¸ºè®¿é—®åç§°ï¼Œè¿™ä¸ªåç§°ä¼šè§£æåˆ°å¯¹åº”çš„ <code>endpoint</code> ä¸Šã€‚ä¹Ÿå¯ä»¥ç†è§£ <code>mirror</code> é…ç½®å°±æ˜¯ä¸€ä¸ªåå‘ä»£ç†ï¼Œå®ƒæŠŠå®¢æˆ·ç«¯çš„è¯·æ±‚ä»£ç†åˆ° <code>endpoint</code> é…ç½®çš„åç«¯é•œåƒä»“åº“ã€‚<code>mirror</code> åç§°å¯ä»¥éšæ„å¡«å†™ï¼Œä½†æ˜¯å¿…é¡»ç¬¦åˆ <code>IP</code> æˆ–åŸŸåçš„å®šä¹‰è§„åˆ™ã€‚å¹¶ä¸”å¯ä»¥é…ç½®å¤šä¸ª <code>endpoint</code>ï¼Œé»˜è®¤è§£æåˆ°ç¬¬ä¸€ä¸ª <code>endpoint</code>ï¼Œå¦‚æœç¬¬ä¸€ä¸ª <code>endpoint</code> æ²¡æœ‰è¿”å›æ•°æ®ï¼Œåˆ™è‡ªåŠ¨åˆ‡æ¢åˆ°ç¬¬äºŒä¸ª <code>endpoint</code>ï¼Œä»¥æ­¤ç±»æ¨ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /etc/rancher/k3s/registries.yaml</span></span><br><span class="line"><span class="comment"># åŒæ—¶å¯ä»¥è®¾ç½®å¤šä¸ªmirrorsåœ°å€</span></span><br><span class="line"><span class="comment"># å¯ä»¥å¯¹mirrorsè®¾ç½®æƒé™å’Œè¯ä¹¦</span></span><br><span class="line"><span class="attr">mirrors:</span></span><br><span class="line">  <span class="attr">"172.31.6.200:5000":</span></span><br><span class="line">    <span class="attr">endpoint:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"http://172.31.6.200:5000"</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"http://x.x.x.x:5000"</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"http://y.y.y.y:5000"</span></span><br><span class="line">  <span class="attr">"rancher.ksd.top:5000":</span></span><br><span class="line">    <span class="attr">endpoint:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"http://172.31.6.200:5000"</span></span><br><span class="line">  <span class="attr">"docker.io":</span></span><br><span class="line">    <span class="attr">endpoint:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"https://fogjl973.mirror.aliyuncs.com"</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"https://registry-1.docker.io"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">configs:</span></span><br><span class="line">  <span class="attr">"172.31.6.200:5000":</span></span><br><span class="line">    <span class="attr">auth:</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">admin</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">Harbor@12345</span></span><br><span class="line">    <span class="attr">tls:</span></span><br><span class="line">      <span class="attr">cert_file:</span> <span class="string">/home/ubuntu/harbor2.escapelife.site.cert</span></span><br><span class="line">      <span class="attr">key_file:</span> <span class="string">/home/ubuntu/harbor2.escapelife.site.key</span></span><br><span class="line">      <span class="attr">ca_file:</span> <span class="string">/home/ubuntu/ca.crt</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># é•œåƒéƒ½æ˜¯ä»åŒä¸€ä¸ªä»“åº“è·å–åˆ°çš„</span></span><br><span class="line">$ sudo systemctl restart k3s.service</span><br><span class="line">$ sudo crictl pull 172.31.6.200:5000/library/alpine</span><br><span class="line">$ sudo crictl pull rancher.ksd.top:5000/library/alpine</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬ä»‹ç»ä¸‹ï¼Œå¦‚ä½•ä½¿ç”¨ <code>TLS</code> é…ç½®ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¯ä¹¦é¢å‘æœºæ„é¢å‘çš„è¯ä¹¦</span></span><br><span class="line">$ cat &gt;&gt; /etc/rancher/k3s/registries.yaml &lt;&lt;EOF</span><br><span class="line">mirrors:</span><br><span class="line">  <span class="string">"harbor.escapelife.site"</span>:</span><br><span class="line">    endpoint:</span><br><span class="line">      - <span class="string">"https://harbor.escapelife.site"</span></span><br><span class="line">configs:</span><br><span class="line">  <span class="string">"harbor.escapelife.site"</span>:</span><br><span class="line">    auth:</span><br><span class="line">      username: admin</span><br><span class="line">      password: Harbor@12345</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">$ sudo systemctl restart k3s</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è‡ªç­¾åè¯ä¹¦</span></span><br><span class="line">$ cat &gt;&gt; /etc/rancher/k3s/registries.yaml &lt;&lt;EOF</span><br><span class="line">mirrors:</span><br><span class="line">  <span class="string">"harbor2.escapelife.site"</span>:</span><br><span class="line">    endpoint:</span><br><span class="line">      - <span class="string">"https://harbor2.escapelife.site"</span></span><br><span class="line">configs:</span><br><span class="line">  <span class="string">"harbor2.escapelife.site"</span>:</span><br><span class="line">    auth:</span><br><span class="line">      username: admin</span><br><span class="line">      password: Harbor@12345</span><br><span class="line">    tls:</span><br><span class="line">      cert_file: /home/ubuntu/harbor2.escapelife.site.cert</span><br><span class="line">      key_file:  /home/ubuntu/harbor2.escapelife.site.key</span><br><span class="line">      ca_file:   /home/ubuntu/ca.crt</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">$ sudo systemctl restart k3s</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¸ä½¿ç”¨TLSè¯ä¹¦</span></span><br><span class="line">$ cat &gt;&gt; /etc/rancher/k3s/registries.yaml &lt;&lt;EOF</span><br><span class="line">mirrors:</span><br><span class="line">  <span class="string">"docker.io"</span>:</span><br><span class="line">    endpoint:</span><br><span class="line">      - <span class="string">"https://fogjl973.mirror.aliyuncs.com"</span></span><br><span class="line">      - <span class="string">"https://registry-1.docker.io"</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">$ sudo systemctl restart k3s</span><br></pre></td></tr></table></figure><p><code>K3s</code> å°†ä¼šåœ¨ <code>/var/lib/rancher/k3s/agent/etc/containerd/config.toml</code> ä¸­ä¸º <code>containerd</code> ç”Ÿæˆ  <code>config.toml</code>ã€‚å¦‚æœè¦å¯¹è¿™ä¸ªæ–‡ä»¶è¿›è¡Œé«˜çº§è®¾ç½®ï¼Œä½ å¯ä»¥åœ¨åŒä¸€ç›®å½•ä¸­åˆ›å»ºå¦ä¸€ä¸ªåä¸º  <code>config.toml.tmpl</code> çš„æ–‡ä»¶ï¼Œæ­¤æ–‡ä»¶å°†ä¼šä»£æ›¿é»˜è®¤è®¾ç½®ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®Œæ•´ç¤ºä¾‹</span></span><br><span class="line">$ cat &gt;&gt; /etc/rancher/k3s/registries.yaml</span><br><span class="line">mirrors:</span><br><span class="line">  <span class="string">"harbor.escapelife.site"</span>:</span><br><span class="line">     endpoint:</span><br><span class="line">     - <span class="string">"https://harbor.escapelife.site"</span></span><br><span class="line">  <span class="string">"harbor2.escapelife.site"</span>:</span><br><span class="line">     endpoint:</span><br><span class="line">     - <span class="string">"https://harbor2.escapelife.site"</span></span><br><span class="line">  <span class="string">"172.31.19.227:5000"</span>:</span><br><span class="line">     endpoint:</span><br><span class="line">     - <span class="string">"http://172.31.19.227:5000"</span></span><br><span class="line">  <span class="string">"docker.io"</span>:</span><br><span class="line">     endpoint:</span><br><span class="line">     - <span class="string">"https://fogjl973.mirror.aliyuncs.com"</span></span><br><span class="line">     - <span class="string">"https://registry-1.docker.io"</span></span><br><span class="line"></span><br><span class="line">configs:</span><br><span class="line">  <span class="string">"harbor.escapelife.site"</span>:</span><br><span class="line">     auth:</span><br><span class="line">       username: admin</span><br><span class="line">       password: Harbor@12345</span><br><span class="line"></span><br><span class="line">  <span class="string">"harbor2.escapelife.site"</span>:</span><br><span class="line">     auth:</span><br><span class="line">       username: admin</span><br><span class="line">       password: Harbor@12345</span><br><span class="line">     tls:</span><br><span class="line">       cert_file: /home/ubuntu/harbor2.escapelife.site.cert</span><br><span class="line">       key_file:  /home/ubuntu/harbor2.escapelife.site.key</span><br><span class="line">       ca_file:   /home/ubuntu/ca.crt</span><br></pre></td></tr></table></figure><h3><span id="37-ç¦»çº¿å®‰è£…">3.7 ç¦»çº¿å®‰è£…</span></h3><blockquote><p><strong>ç†è§£ Server èŠ‚ç‚¹çš„å®‰è£…ï¼Œä»¥åŠæ³¨å†Œ Agent èŠ‚ç‚¹çš„æ­¥éª¤ï¼</strong></p></blockquote><p>ç¦»çº¿å®‰è£…çš„è¿‡ç¨‹ä¸»è¦åˆ†ä¸ºä»¥ä¸‹ä¸¤ä¸ªæ­¥éª¤ï¼š</p><ul><li><p>æ­¥éª¤ 1ï¼šéƒ¨ç½²é•œåƒ</p><ul><li><strong>éƒ¨ç½²ç§æœ‰é•œåƒä»“åº“</strong></li><li><strong>æ‰‹åŠ¨éƒ¨ç½²é•œåƒ</strong></li></ul></li><li><p>æ­¥éª¤ 2ï¼šå®‰è£… <code>K3s</code> å·¥å…·</p><ul><li><strong>å•èŠ‚ç‚¹å®‰è£…</strong></li><li><strong>é«˜å¯ç”¨å®‰è£…</strong></li></ul></li><li><p>é€šè¿‡ç§æœ‰é•œåƒä»“åº“å®‰è£… K3s</p><ul><li><code>k3s-images.txt</code> åŒ…å«å¯¹äºç‰ˆæœ¬ä¾èµ–çš„é•œåƒæ–‡ä»¶</li><li><code>k3s-airgap-images-amd64.tar</code> åŒ…å«å¯¹äºç‰ˆæœ¬çš„é•œåƒæ–‡ä»¶</li></ul></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å°†æ‰€éœ€é•œåƒä¸Šä¼ åˆ°ç§æœ‰é•œåƒä»“åº“</span></span><br><span class="line"><span class="comment"># https://github.com/k3s-io/k3s/releases</span></span><br><span class="line">å¯ä»¥ä»K3sé•œåƒåˆ—è¡¨è·å–åˆ°ç‰ˆæœ¬ï¼Œä¸‹è½½ä¸Šä¼ åˆ°ç§æœ‰é•œåƒä»“åº“</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºé•œåƒä»“åº“(YAML)</span></span><br><span class="line"><span class="comment"># æŒ‰ç…§ç§æœ‰é•œåƒä»“åº“é…ç½®æŒ‡å—åˆ›å»ºå¹¶é…ç½®registry.yamlæ–‡ä»¶</span></span><br><span class="line">$ mkdir -p /etc/rancher/k3s/</span><br><span class="line">cat &gt;&gt; /etc/rancher/k3s/registries.yaml &lt;&lt;EOF</span><br><span class="line">mirrors:</span><br><span class="line">  <span class="string">"docker.io"</span>:</span><br><span class="line">    endpoint:</span><br><span class="line">      - <span class="string">"https://harbor.escapelife.site"</span></span><br><span class="line">configs:</span><br><span class="line">  <span class="string">"docker.io"</span>:</span><br><span class="line">    auth:</span><br><span class="line">      username: admin</span><br><span class="line">      password: Harbor@12345</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®‰è£…å•èŠ‚ç‚¹K3sé›†ç¾¤</span></span><br><span class="line"><span class="comment"># https://github.com/k3s-io/k3s/releases</span></span><br><span class="line">å¯ä»¥ä»K3sä»“åº“è·å–åˆ°ç‰ˆæœ¬(äºŒè¿›åˆ¶æ–‡ä»¶)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è·å–K3så®‰è£…è„šæœ¬</span></span><br><span class="line">$ wget https://get.k3s.io -o ./install.sh</span><br><span class="line">$ wget http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…K3s-server</span></span><br><span class="line">$ INSTALL_K3S_SKIP_DOWNLOAD=<span class="literal">true</span> ./install.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†agentåŠ å…¥åˆ°K3sé›†ç¾¤</span></span><br><span class="line">$ INSTALL_K3S_SKIP_DOWNLOAD=<span class="literal">true</span> \</span><br><span class="line">    K3S_URL=https://myserver:6443 K3S_TOKEN=mynodetoken \</span><br><span class="line">    ./install.sh</span><br></pre></td></tr></table></figure><ul><li>é€šè¿‡æ‰‹åŠ¨éƒ¨ç½²é•œåƒå®‰è£… K3s</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä»Githubé¡µé¢è·å–ä½ æ‰€è¿è¡Œçš„K3sç‰ˆæœ¬åŠæ–‡ä»¶</span></span><br><span class="line"><span class="comment"># https://github.com/rancher/k3s/releases</span></span><br><span class="line">k3säºŒè¿›åˆ¶æ–‡ä»¶+é•œåƒtaræ–‡ä»¶</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†taræ–‡ä»¶æ”¾åœ¨imagesç›®å½•ä¸‹</span></span><br><span class="line">$ sudo mkdir -p /var/lib/rancher/k3s/agent/images/</span><br><span class="line">$ sudo cp ./k3s-airgap-images-<span class="variable">$ARCH</span>.tar /var/lib/rancher/k3s/agent/images/</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†k3säºŒè¿›åˆ¶æ–‡ä»¶æ”¾åœ¨/usr/local/bin/k3sè·¯å¾„ä¸Š</span></span><br><span class="line">$ mv ./k3s /usr/<span class="built_in">local</span>/bin/</span><br><span class="line">$ chmod 755 /usr/<span class="built_in">local</span>/bin/k3s</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…K3s-server</span></span><br><span class="line">$ INSTALL_K3S_SKIP_DOWNLOAD=<span class="literal">true</span> ./install.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†agentåŠ å…¥åˆ°K3sé›†ç¾¤</span></span><br><span class="line">$ INSTALL_K3S_SKIP_DOWNLOAD=<span class="literal">true</span> \</span><br><span class="line">    K3S_URL=https://myserver:6443 K3S_TOKEN=mynodetoken \</span><br><span class="line">    ./install.sh</span><br></pre></td></tr></table></figure><p>ç¦»çº¿å‡çº§ <code>K3s</code> ç‰ˆæœ¬ï¼Œå®Œæˆç¦»çº¿å®‰è£… <code>K3s</code> åï¼Œè¿˜å¯ä»¥é€šè¿‡è„šæœ¬å‡çº§ <code>K3s</code> ç‰ˆæœ¬ï¼Œæˆ–å¯ç”¨è‡ªåŠ¨å‡çº§åŠŸèƒ½ï¼Œä»¥ä¿æŒç¦»çº¿ç¯å¢ƒä¸­çš„ <code>K3s</code> ç‰ˆæœ¬ä¸æœ€æ–°çš„ <code>K3s</code> ç‰ˆæœ¬åŒæ­¥ã€‚</p><ul><li>å‡çº§ K3s ç‰ˆæœ¬</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># é€šè¿‡è„šæœ¬å‡çº§</span></span><br><span class="line"><span class="comment"># https://github.com/rancher/k3s/releases</span></span><br><span class="line">ä»Githubé¡µé¢ä¸‹è½½è¦å‡çº§åˆ°çš„K3sç‰ˆæœ¬</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ›¿æ¢</span></span><br><span class="line"><span class="comment"># å¤åˆ¶å¹¶æ›¿æ¢æ¯ä¸ªèŠ‚ç‚¹ä¸Š/usr/local/binä¸­çš„æ—§K3säºŒè¿›åˆ¶æ–‡ä»¶</span></span><br><span class="line">$ mv ./k3s /usr/<span class="built_in">local</span>/bin/</span><br><span class="line">$ chmod 755 /usr/<span class="built_in">local</span>/bin/k3s</span><br><span class="line">$ wget http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># é‡å¯K3sæœåŠ¡</span></span><br><span class="line">$ sudo systemctl restart k3s.service</span><br></pre></td></tr></table></figure><h3><span id="38-ä»ªè¡¨ç›˜åŠå¸è½½">3.8 ä»ªè¡¨ç›˜åŠå¸è½½</span></h3><blockquote><p><strong>ç†è§£ Server èŠ‚ç‚¹çš„å®‰è£…ï¼Œä»¥åŠæ³¨å†Œ Agent èŠ‚ç‚¹çš„æ­¥éª¤ï¼</strong></p></blockquote><p>æ¨èä½¿ç”¨ä¸‰ç§ä»ªè¡¨ç›˜å·¥å…·ï¼Œåˆ†åˆ«æ˜¯å¯¹åº”æ˜¯ <code>Kubernetes Dashboard</code>ã€<code>kube-explorer</code> å’Œ <code>Rancher UI</code>ï¼Œå…¶å„è‡ªå„æœ‰ä¼˜åŠ£ã€‚</p><ul><li>[1] Kubernetes Dashboard</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># éƒ¨ç½²Kubernetesä»ªè¡¨ç›˜</span></span><br><span class="line">$ GITHUB_URL=https://github.com/kubernetes/dashboard/releases</span><br><span class="line">$ VERSION_KUBE_DASHBOARD=$(curl -w <span class="string">'%&#123;url_effective&#125;'</span> -I -L -s -S \</span><br><span class="line">    <span class="variable">$&#123;GITHUB_URL&#125;</span>/latest -o /dev/null | sed -e <span class="string">'s|.*/||'</span>)</span><br><span class="line">$ sudo k3s kubectl create -f https://raw.githubusercontent.com/kubernetes/dashboard/<span class="variable">$&#123;VERSION_KUBE_DASHBOARD&#125;</span>/aio/deploy/recommended.yaml</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä»ªè¡¨ç›˜RBACé…ç½®</span></span><br><span class="line"><span class="comment"># æœ¬æŒ‡å—ä¸­åˆ›å»ºçš„admin-userå°†åœ¨ä»ªè¡¨ç›˜ä¸­æ‹¥æœ‰ç®¡ç†æƒé™</span></span><br><span class="line">$ sudo k3s kubectl create \</span><br><span class="line">    -f dashboard.admin-user.yml \</span><br><span class="line">    -f dashboard.admin-user-role.yml</span><br><span class="line"></span><br><span class="line"><span class="comment"># dashboard.admin-user.yml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: admin-user</span><br><span class="line">  namespace: kubernetes-dashboard</span><br><span class="line"></span><br><span class="line"><span class="comment"># dashboard.admin-user-role.yml</span></span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: admin-user</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br><span class="line">subjects:</span><br><span class="line">  - kind: ServiceAccount</span><br><span class="line">    name: admin-user</span><br><span class="line">    namespace: kubernetes-dashboard</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è·å¾—Bearer-Token</span></span><br><span class="line">$ sudo k3s kubectl -n kubernetes-dashboard \</span><br><span class="line">    describe secret admin-user-token | grep <span class="string">'^token'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æœ¬åœ°è®¿é—®ä»ªè¡¨ç›˜</span></span><br><span class="line"><span class="comment"># https://192.168.100.100:8443</span></span><br><span class="line"><span class="comment"># https://www.escapelife.site/posts/180e93f1.html</span></span><br><span class="line"><span class="comment"># https://www.escapelife.site/posts/538ec6b1.html</span></span><br><span class="line">$ sudo k3s kubectl proxy</span><br><span class="line">$ sudo kubectl -n kubernetes-dashboard port-forward \</span><br><span class="line">    --address 0.0.0.0 svc/kubernets-dashboard 8443:443</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å‡çº§ä»ªè¡¨ç›˜</span></span><br><span class="line">$ sudo k3s kubectl delete ns kubernetes-dashboard</span><br><span class="line">$ GITHUB_URL=https://github.com/kubernetes/dashboard/releases</span><br><span class="line">$ VERSION_KUBE_DASHBOARD=$(curl -w <span class="string">'%&#123;url_effective&#125;'</span> -I -L -s -S <span class="variable">$&#123;GITHUB_URL&#125;</span>/latest -o /dev/null | sed -e <span class="string">'s|.*/||'</span>)</span><br><span class="line">$ sudo k3s kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/<span class="variable">$&#123;VERSION_KUBE_DASHBOARD&#125;</span>/aio/deploy/recommended.yaml -f dashboard.admin-user.yml -f dashboard.admin-user-role.yml</span><br><span class="line"></span><br><span class="line"><span class="comment"># ## åˆ é™¤ä»ªè¡¨ç›˜å’Œadmin-useré…ç½®</span></span><br><span class="line">$ sudo k3s kubectl delete ns kubernetes-dashboard</span><br><span class="line">$ sudo k3s kubectl delete clusterrolebinding kubernetes-dashboard</span><br><span class="line">$ sudo k3s kubectl delete clusterrole kubernetes-dashboard</span><br></pre></td></tr></table></figure><ul><li>[2] kube-explorer<ul><li><code>kube-explorer</code> æ˜¯ <code>K8S</code> çš„ä¾¿æºå¼èµ„æºç®¡ç†å™¨ï¼Œæ²¡æœ‰ä»»ä½•ä¾èµ–</li><li>å¹¶æä¾›äº†ä¸€ä¸ªå‡ ä¹å®Œå…¨æ— çŠ¶æ€çš„ <code>K8S</code> èµ„æºç®¡ç†å™¨</li></ul></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä»å‘å¸ƒé¡µé¢ä¸‹è½½äºŒè¿›åˆ¶æ–‡ä»¶</span></span><br><span class="line"><span class="comment"># https://github.com/cnrancher/kube-explorer</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿è¡Œ</span></span><br><span class="line"><span class="comment"># --kubeconfig å¯ä»¥ä¸é…ç½®(è‡ªå·±å¯ä»¥æ‰¾åˆ°)</span></span><br><span class="line">$ ./kube-explorer --kubeconfig=/etc/rancher/k3s/kube.yaml \</span><br><span class="line">    --http-listen-port=9898 \</span><br><span class="line">    --https-listen-port=0</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰“å¼€æµè§ˆå™¨è®¿é—®</span></span><br><span class="line">http://192.168.100.100:9898</span><br></pre></td></tr></table></figure><ul><li>[3] Rancher UI<ul><li>å¯ä»¥å°† <code>K3s</code> å¯¼å…¥åˆ° <code>Rancher UI</code> ä¸­å»ç®¡ç†</li><li>å®˜ç½‘ <a href="http://docs.rancher.cn/docs/rancher2/cluster-provisioning/imported-clusters/_index/#%E5%AF%BC%E5%85%A5-k3s-%E9%9B%86%E7%BE%A4" target="_blank" rel="noopener">å¯¼å…¥ K3s é›†ç¾¤</a> æŒ‡å¯¼æ–‡æ¡£</li></ul></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¯¼å…¥K3sé›†ç¾¤æ—¶ï¼ŒRancherä¼šå°†å…¶è¯†åˆ«ä¸ºK3sç±»å‹ï¼Œå¹¶ä¸”é™„ä»¶é¢å¤–åŠŸèƒ½</span></span><br><span class="line"><span class="comment"># 1.èƒ½å¤Ÿå‡çº§K3sç‰ˆæœ¬</span></span><br><span class="line"><span class="comment"># 2.å¯é…ç½®å‡çº§é›†ç¾¤æ—¶å‡çº§çš„æœ€å¤§èŠ‚ç‚¹æ•°</span></span><br><span class="line"><span class="comment"># 3.åœ¨ä¸»æœºè¯¦æƒ…é¡µèƒ½å¤ŸæŸ¥çœ‹å¯åŠ¨K3sé›†ç¾¤æ—¶æ¯ä¸ªèŠ‚ç‚¹çš„é…ç½®å‚æ•°å’Œç¯å¢ƒå˜é‡</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é…ç½®K3sé›†ç¾¤ä»¥å…è®¸å¯¼å…¥åˆ°Rancher</span></span><br><span class="line">$ curl -sfL https://rancher-mirror.rancher.cn/k3s/k3s-install.sh | \</span><br><span class="line">    INSTALL_K3S_MIRROR=cn sh -s - \</span><br><span class="line">    --write-kubeconfig-mode 644</span><br></pre></td></tr></table></figure><ul><li>[4] å¸è½½ K3s æœåŠ¡</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¸»èŠ‚ç‚¹</span></span><br><span class="line">$ /usr/<span class="built_in">local</span>/bin/k3s-uninstall.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># å·¥ä½œèŠ‚ç‚¹</span></span><br><span class="line">$ /usr/<span class="built_in">local</span>/bin/k3s-agent-uninstall.sh</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åŒ…æ‹¬dockerç­‰ä¿¡æ¯ä¸€å¹¶æ¸…ç†</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">KUBE_SVC=<span class="string">'</span></span><br><span class="line"><span class="string">kubelet</span></span><br><span class="line"><span class="string">kube-scheduler</span></span><br><span class="line"><span class="string">kube-proxy</span></span><br><span class="line"><span class="string">kube-controller-manager</span></span><br><span class="line"><span class="string">kube-apiserver</span></span><br><span class="line"><span class="string">'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> kube_svc <span class="keyword">in</span> <span class="variable">$&#123;KUBE_SVC&#125;</span>;</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  <span class="comment"># åœæ­¢æœåŠ¡</span></span><br><span class="line">  <span class="keyword">if</span> [[ `systemctl is-active <span class="variable">$&#123;kube_svc&#125;</span>` == <span class="string">'active'</span> ]]; <span class="keyword">then</span></span><br><span class="line">    systemctl stop <span class="variable">$&#123;kube_svc&#125;</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  <span class="comment"># ç¦æ­¢æœåŠ¡å¼€æœºå¯åŠ¨</span></span><br><span class="line">  <span class="keyword">if</span> [[ `systemctl is-enabled <span class="variable">$&#123;kube_svc&#125;</span>` == <span class="string">'enabled'</span> ]]; <span class="keyword">then</span></span><br><span class="line">    systemctl <span class="built_in">disable</span> <span class="variable">$&#123;kube_svc&#125;</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åœæ­¢æ‰€æœ‰å®¹å™¨</span></span><br><span class="line">docker stop $(docker ps -aq)</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ é™¤æ‰€æœ‰å®¹å™¨</span></span><br><span class="line">docker rm -f $(docker ps -qa)</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ é™¤æ‰€æœ‰å®¹å™¨å·</span></span><br><span class="line">docker volume rm $(docker volume ls -q)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¸è½½mountç›®å½•</span></span><br><span class="line"><span class="keyword">for</span> mount <span class="keyword">in</span> $(mount | grep tmpfs | grep <span class="string">'/var/lib/kubelet'</span> | awk <span class="string">'&#123; print $3 &#125;'</span>) /var/lib/kubelet /var/lib/rancher;</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  umount <span class="variable">$mount</span>;</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¤‡ä»½ç›®å½•</span></span><br><span class="line">mv /etc/kubernetes /etc/kubernetes-bak-$(date +<span class="string">"%Y%m%d%H%M"</span>)</span><br><span class="line">mv /var/lib/etcd /var/lib/etcd-bak-$(date +<span class="string">"%Y%m%d%H%M"</span>)</span><br><span class="line">mv /var/lib/rancher /var/lib/rancher-bak-$(date +<span class="string">"%Y%m%d%H%M"</span>)</span><br><span class="line">mv /opt/rke /opt/rke-bak-$(date +<span class="string">"%Y%m%d%H%M"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ é™¤æ®‹ç•™è·¯å¾„</span></span><br><span class="line">rm -rf /etc/ceph \</span><br><span class="line">    /etc/cni \</span><br><span class="line">    /opt/cni \</span><br><span class="line">    /run/secrets/kubernetes.io \</span><br><span class="line">    /run/calico \</span><br><span class="line">    /run/flannel \</span><br><span class="line">    /var/lib/calico \</span><br><span class="line">    /var/lib/cni \</span><br><span class="line">    /var/lib/kubelet \</span><br><span class="line">    /var/<span class="built_in">log</span>/containers \</span><br><span class="line">    /var/<span class="built_in">log</span>/kube-audit \</span><br><span class="line">    /var/<span class="built_in">log</span>/pods \</span><br><span class="line">    /var/run/calico \</span><br><span class="line">    /usr/libexec/kubernetes</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¸…ç†ç½‘ç»œæ¥å£</span></span><br><span class="line">no_del_net_inter=<span class="string">'</span></span><br><span class="line"><span class="string">lo</span></span><br><span class="line"><span class="string">docker0</span></span><br><span class="line"><span class="string">eth</span></span><br><span class="line"><span class="string">ens</span></span><br><span class="line"><span class="string">bond</span></span><br><span class="line"><span class="string">'</span></span><br><span class="line"></span><br><span class="line">network_interface=`ls /sys/class/net`</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> net_inter <span class="keyword">in</span> <span class="variable">$network_interface</span>;</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  <span class="keyword">if</span> ! <span class="built_in">echo</span> <span class="string">"<span class="variable">$&#123;no_del_net_inter&#125;</span>"</span> | grep -qE <span class="variable">$&#123;net_inter:0:3&#125;</span>; <span class="keyword">then</span></span><br><span class="line">    ip link delete <span class="variable">$net_inter</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¸…ç†æ®‹ç•™è¿›ç¨‹</span></span><br><span class="line">port_list=<span class="string">'</span></span><br><span class="line"><span class="string">80</span></span><br><span class="line"><span class="string">443</span></span><br><span class="line"><span class="string">6443</span></span><br><span class="line"><span class="string">2376</span></span><br><span class="line"><span class="string">2379</span></span><br><span class="line"><span class="string">2380</span></span><br><span class="line"><span class="string">8472</span></span><br><span class="line"><span class="string">9099</span></span><br><span class="line"><span class="string">10250</span></span><br><span class="line"><span class="string">10254</span></span><br><span class="line"><span class="string">'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> port <span class="keyword">in</span> <span class="variable">$port_list</span>;</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  pid=`netstat -atlnup | grep <span class="variable">$port</span> | awk <span class="string">'&#123;print $7&#125;'</span> | awk -F <span class="string">'/'</span> <span class="string">'&#123;print $1&#125;'</span> | grep -v - | sort -rnk2 | uniq`</span><br><span class="line">  <span class="keyword">if</span> [[ -n <span class="variable">$pid</span> ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">kill</span> -9 <span class="variable">$pid</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">kube_pid=`ps -ef | grep -v grep | grep kube | awk <span class="string">'&#123;print $2&#125;'</span>`</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ -n <span class="variable">$kube_pid</span> ]]; <span class="keyword">then</span></span><br><span class="line">  <span class="built_in">kill</span> -9 <span class="variable">$kube_pid</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¸…ç†Iptablesè¡¨</span></span><br><span class="line"><span class="comment">## æ³¨æ„ï¼šå¦‚æœèŠ‚ç‚¹Iptablesæœ‰ç‰¹æ®Šé…ç½®ï¼Œä»¥ä¸‹å‘½ä»¤è¯·è°¨æ…æ“ä½œ</span></span><br><span class="line">sudo iptables --flush</span><br><span class="line">sudo iptables --flush --table nat</span><br><span class="line">sudo iptables --flush --table filter</span><br><span class="line">sudo iptables --table nat --delete-chain</span><br><span class="line">sudo iptables --table filter --delete-chain</span><br><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure><h3><span id="39-æ³¨æ„äº‹é¡¹">3.9 æ³¨æ„äº‹é¡¹</span></h3><blockquote><p><strong>ç†è§£ Server èŠ‚ç‚¹çš„å®‰è£…ï¼Œä»¥åŠæ³¨å†Œ Agent èŠ‚ç‚¹çš„æ­¥éª¤ï¼</strong></p></blockquote><ul><li><strong>Helm</strong><ul><li>å¦‚æœéœ€è¦ä½¿ç”¨ <code>helm</code> æ“ä½œ <code>K3s</code> é›†ç¾¤ï¼Œéœ€è¦åˆ›å»º <code>~/.kube/conf</code> ç›®å½•</li><li>éœ€è¦æ‰§è¡Œ <code>cp /etc/rancher/k3s/k3s.yaml ~/.kube/config</code> å‘½ä»¤</li></ul></li><li><strong>è‡ªåŠ¨éƒ¨ç½²çš„æ¸…å•</strong><ul><li>å°†ç”± <code>rancher/helm-controller</code> åœ¨è¿è¡Œæ—¶å®‰è£…</li><li>ç›®å½•è·¯å¾„ï¼š<code>/var/lib/rancher/k3s/server/manifests</code></li><li>ç›®å½•ä¸‹é¢çš„æ¯ä¸ª <code>yaml</code> å°±ä»£è¡¨è¿™ä¸ªä¸€ä¸ªéœ€è¦å¯åŠ¨çš„æœåŠ¡</li></ul></li></ul><p>å¯¹äºæˆ‘ä»¬å¸Œæœ›ä½¿ç”¨çš„ç»„ä»¶ï¼Œå¯ä»¥åœ¨å¯åŠ¨çš„æ—¶å€™ç¦ç”¨é»˜è®¤ç»„ä»¶ï¼Œåœ¨æ‰‹åŠ¨éƒ¨ç½²ä½ éœ€è¦çš„ä¸€äº›ç»„ä»¶(é€šå¸¸æ˜¯æ”¾åˆ°ä¸€ä¸ªæŒ‡å®šç›®å½•ä¸‹é¢ï¼Œéšç€æœåŠ¡å¯åŠ¨è‡ªåŠ¨æ‹‰èµ·)ï¼Œä»è€Œè¾¾åˆ°çµæ´»ä½¿ç”¨çš„ç›®çš„ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹æ‰€æœ‰PodæœåŠ¡</span></span><br><span class="line"><span class="comment"># æ¯”å¦‚helm/corednsä¹Ÿä¸æ˜¯è‡ªå¸¦çš„å°±æ˜¯é€šè¿‡è¿™ä¸ªæ–¹å¼åˆ›å»ºçš„</span></span><br><span class="line">$ sudo kubectl get pods -A</span><br></pre></td></tr></table></figure><ul><li>æ³¨å†Œ Agent èŠ‚ç‚¹<ul><li>å·¥ä½œèŠ‚ç‚¹å¯†ç å­˜å‚¨ï¼š<code>/etc/rancher/node/password</code></li><li>ä¸»èŠ‚ç‚¹çš„å¯†ç å­˜å‚¨ï¼š<code>/var/lib/rancher/k3s/server/cred/node-passwd</code></li></ul></li></ul><p>åœ¨ <code>agent</code> èŠ‚ç‚¹è¿è¡Œæ³¨å†Œå‘½ä»¤ï¼Œä¼šå’Œ <code>server</code> èŠ‚ç‚¹å‘èµ· <code>websocket</code> è¿æ¥ï¼Œç„¶åä¼šåœ¨å·¥ä½œèŠ‚ç‚¹ä¸Šé¢åˆ›å»ºä¸€ä¸ªéšæœºçš„å¯†ç ã€‚ç„¶åä¼šæ‹¿ç€è¿™ä¸ªå¯†ç å’Œå·¥ä½œèŠ‚ç‚¹çš„ä¸»æœºåï¼Œå‘é€ç»™ä¸»èŠ‚ç‚¹ã€‚ç„¶åä¸»èŠ‚ç‚¹ä¼šå°†è¿™ä¸ªä¿¡æ¯åœ¨ä¿å­˜(<code>k8s secrets</code>)èµ·æ¥ï¼Œéšåçš„ä»»ä½•å°è¯•éƒ½å¿…é¡»ä½¿ç”¨ç›¸åŒçš„å¯†ç ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å·¥ä½œèŠ‚ç‚¹çš„å¯†ç ä¿¡æ¯(password+hostname)</span></span><br><span class="line">$ sudo cat /etc/rancher/node/password</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹ä¸»èŠ‚ç‚¹çš„å¯†ç ä¿¡æ¯</span></span><br><span class="line"><span class="comment"># https://docs.rancher.cn/docs/k3s/architecture/_index#æ³¨å†Œ-agent-èŠ‚ç‚¹</span></span><br><span class="line">$ sudo kubectl get secret k3s2.node-password.k3s -o yaml -n kube-system</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯ä»¥æŸ¥çœ‹æ—¥å¿—ä¿¡æ¯éªŒè¯è¿™ä¸ªä¿¡æ¯çš„å­˜åœ¨</span></span><br><span class="line">$ sudo tail -f 200 /var/<span class="built_in">log</span>/syslog | grep k3s</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å‘ç°èŠ‚ç‚¹ä¿¡æ¯æç¤ºNotReadyçŠ¶æ€</span></span><br><span class="line"><span class="comment"># å¯ä»¥å°è¯•åˆ é™¤èŠ‚ç‚¹çš„å¯†ç å­˜å‚¨ä¿¡æ¯ï¼Œä¹‹åä¼šè‡ªåŠ¨è·å–æ–°çš„</span></span><br><span class="line">$ sudo kubectl delete secret k3s2.node-password.k3s -n kube-system</span><br></pre></td></tr></table></figure><ul><li>è‡ªå®šä¹‰å­˜å‚¨ç±»å‹</li></ul><p>é›†ç¾¤å¯åŠ¨ä¹‹åï¼Œé»˜è®¤ä¼šå¯åŠ¨ä¸€ä¸ª <code>local-path</code> çš„ç»„ä»¶ï¼Œç”¨äºæä¾›æœåŠ¡æŒ‚è½½å­˜å‚¨ä½¿ç”¨ï¼Œå…¶é»˜è®¤ä»¥ <code>PVC</code> çš„å½¢å¼ã€‚ä¹‹åï¼Œå°†å…¶å­˜å‚¨åœ¨ <code>/var/lib/rancher/k3s/server/storageclass</code> ç›®å½•ä¸‹é¢ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹ç»„ä»¶</span></span><br><span class="line">$ sudo kubectl get pods -A</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹å¯¹åº”å­˜å‚¨</span></span><br><span class="line">$ sudo kubectl get storageclass</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯ä»¥ä½¿ç”¨å‚æ•°ä¿®æ”¹é»˜è®¤å­˜å‚¨åœ°å€</span></span><br><span class="line"><span class="comment"># --default-local-storage-path&amp;nbsp;value</span></span><br><span class="line">$ curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh | \</span><br><span class="line">    INSTALL_K3S_MIRROR=cn \</span><br><span class="line">    INSTALL_K3S_EXEC=<span class="string">'--etcd-snapshot-schedule-cron *&amp;nbsp;*/5&amp;nbsp;*&amp;nbsp;*&amp;nbsp;*'</span> \</span><br><span class="line">    sh -</span><br></pre></td></tr></table></figure><h2><span id="4-k3s-é›†ç¾¤å‡çº§">4. K3S é›†ç¾¤å‡çº§</span></h2><blockquote><p><strong>æ‰‹åŠ¨å‡çº§ + è‡ªåŠ¨å‡çº§</strong></p></blockquote><p>å½“å‡çº§ <code>K3s</code> æ—¶ï¼Œ<code>K3s</code> æœåŠ¡ä¼šé‡å¯æˆ–åœæ­¢ï¼Œä½† <code>K3s</code> å®¹å™¨ä¼šç»§ç»­è¿è¡Œã€‚ è¦åœæ­¢æ‰€æœ‰çš„ <code>K3s</code> å®¹å™¨å¹¶é‡ç½®å®¹å™¨çš„çŠ¶æ€ï¼Œå¯ä»¥ä½¿ç”¨  <code>k3s-killall.sh</code> è„šæœ¬ã€‚ <code>killall</code> è„šæœ¬æ¸…ç†å®¹å™¨ã€<code>K3s</code> ç›®å½•å’Œç½‘ç»œç»„ä»¶ï¼ŒåŒæ—¶ä¹Ÿåˆ é™¤äº† <code>iptables</code> é“¾å’Œæ‰€æœ‰ç›¸å…³è§„åˆ™ã€‚é›†ç¾¤æ•°æ®ä¸ä¼šè¢«åˆ é™¤ã€‚</p><ul><li>[1] æ‰‹åŠ¨å‡çº§ - ä½¿ç”¨å®‰è£…è„šæœ¬å‡çº§ K3s</li></ul><p>ä½ å¯ä»¥é€šè¿‡ä½¿ç”¨å®‰è£…è„šæœ¬å‡çº§ <code>K3s</code>ï¼Œæˆ–è€…æ‰‹åŠ¨å®‰è£…æ‰€éœ€ç‰ˆæœ¬çš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å‡çº§åˆ°æœ€æ–°stableç‰ˆæœ¬</span></span><br><span class="line">$ curl -sfL https://get.k3s.io | sh -</span><br><span class="line"></span><br><span class="line"><span class="comment"># å‡çº§åˆ°latestç‰ˆæœ¬</span></span><br><span class="line">$ curl -sfL https://get.k3s.io | INSTALL_K3S_CHANNEL=latest sh -</span><br><span class="line"></span><br><span class="line"><span class="comment"># å‡çº§åˆ°v1.20çš„æœ€æ–°ç‰ˆæœ¬</span></span><br><span class="line">$ curl -sfL https://get.k3s.io | INSTALL_K3S_CHANNEL=<span class="string">"v1.20"</span> sh -</span><br><span class="line"></span><br><span class="line"><span class="comment"># å‡çº§åˆ°æŒ‡å®šç‰ˆæœ¬</span></span><br><span class="line">$ curl -sfL https://get.k3s.io | INSTALL_K3S_VERSION=vX.Y.Z-rc1 sh -</span><br></pre></td></tr></table></figure><ul><li>[2] æ‰‹åŠ¨å‡çº§ - ä½¿ç”¨äºŒè¿›åˆ¶æ–‡ä»¶æ‰‹åŠ¨å‡çº§ K3s</li></ul><p>ä½ å¯ä»¥é€šè¿‡ä½¿ç”¨å®‰è£…è„šæœ¬å‡çº§ <code>K3s</code>ï¼Œæˆ–è€…æ‰‹åŠ¨å®‰è£…æ‰€éœ€ç‰ˆæœ¬çš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä»å‘å¸ƒä¸‹è½½æ‰€éœ€ç‰ˆæœ¬çš„K3säºŒè¿›åˆ¶æ–‡ä»¶</span></span><br><span class="line">https://github.com/rancher/k3s/releases</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†ä¸‹è½½çš„äºŒè¿›åˆ¶æ–‡ä»¶å¤åˆ¶åˆ°/usr/local/bin/k3s</span></span><br><span class="line">$ mv ./k3s /usr/<span class="built_in">local</span>/bin/k3s</span><br><span class="line"></span><br><span class="line"><span class="comment"># åœæ­¢æ—§çš„K3säºŒè¿›åˆ¶æ–‡ä»¶</span></span><br><span class="line">$ curl -sfL https://get.k3s.io | INSTALL_K3S_CHANNEL=<span class="string">"v1.20"</span> sh -</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯åŠ¨æ–°çš„K3säºŒè¿›åˆ¶æ–‡ä»¶</span></span><br><span class="line">$ curl -sfL https://get.k3s.io | INSTALL_K3S_VERSION=vX.Y.Z-rc1 sh -</span><br></pre></td></tr></table></figure><p>ä½ å¯ä»¥ä½¿ç”¨ <code>Rancher</code> çš„ <code>system-upgrad-controller</code> æ¥ç®¡ç† <code>K3s</code> é›†ç¾¤å‡çº§ã€‚è¿™æ˜¯ä¸€ç§ <code>Kubernetes</code> åŸç”Ÿçš„é›†ç¾¤å‡çº§æ–¹æ³•ã€‚å®ƒåˆ©ç”¨è‡ªå®šä¹‰èµ„æºå®šä¹‰(<code>CRD</code>)ã€è®¡åˆ’å’Œæ§åˆ¶å™¨ï¼Œæ ¹æ®é…ç½®çš„è®¡åˆ’å®‰æ’å‡çº§ã€‚</p><p>æ§åˆ¶å™¨é€šè¿‡ç›‘æ§è®¡åˆ’å’Œé€‰æ‹©è¦åœ¨å…¶ä¸Šè¿è¡Œå‡çº§ <code>job</code> çš„èŠ‚ç‚¹æ¥è°ƒåº¦å‡çº§ï¼Œè®¡åˆ’é€šè¿‡æ ‡ç­¾é€‰æ‹©å™¨å®šä¹‰å“ªäº›èŠ‚ç‚¹åº”è¯¥å‡çº§ã€‚å½“ä¸€ä¸ª <code>job</code> æˆåŠŸè¿è¡Œå®Œæˆåï¼Œæ§åˆ¶å™¨ä¼šç»™å®ƒè¿è¡Œçš„èŠ‚ç‚¹æ‰“ä¸Šç›¸åº”çš„æ ‡ç­¾ã€‚</p><ul><li>[3] è‡ªåŠ¨å‡çº§ - ä½¿ç”¨äºŒè¿›åˆ¶æ–‡ä»¶æ‰‹åŠ¨å‡çº§ K3s<ul><li><a href="https://github.com/rancher/k3s-upgrade" target="_blank" rel="noopener">k3s-upgrade</a></li><li><a href="https://github.com/rancher/system-upgrade-controller" target="_blank" rel="noopener">system-upgrade-controller</a></li></ul></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å°†system-upgrade-controllerå®‰è£…åˆ°æ‚¨çš„é›†ç¾¤ä¸­</span></span><br><span class="line">$ kubectl apply -f https://github.com/rancher/system-upgrade-controller/releases/download/v0.6.2/system-upgrade-controller.yaml</span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># é…ç½®è®¡åˆ’</span></span><br><span class="line"><span class="comment"># å»ºè®®æ‚¨æœ€å°‘åˆ›å»ºä¸¤ä¸ªè®¡åˆ’</span></span><br><span class="line"><span class="comment"># å‡çº§serverèŠ‚ç‚¹çš„è®¡åˆ’å’Œå‡çº§agentèŠ‚ç‚¹çš„è®¡åˆ’</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Server plan</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">upgrade.cattle.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Plan</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">server-plan</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">system-upgrade</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">concurrency:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">cordon:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">nodeSelector:</span></span><br><span class="line">    <span class="attr">matchExpressions:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">node-role.kubernetes.io/master</span> <span class="comment"># é€‰æ‹©ä¸»èŠ‚ç‚¹</span></span><br><span class="line">      <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">      <span class="attr">values:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"true"</span></span><br><span class="line">  <span class="attr">serviceAccountName:</span> <span class="string">system-upgrade</span></span><br><span class="line">  <span class="attr">upgrade:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">rancher/k3s-upgrade</span></span><br><span class="line">  <span class="attr">version:</span> <span class="string">v1.20.4+k3s1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Agent plan</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">upgrade.cattle.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Plan</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">agent-plan</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">system-upgrade</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">concurrency:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">cordon:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">nodeSelector:</span></span><br><span class="line">    <span class="attr">matchExpressions:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">node-role.kubernetes.io/master</span> <span class="comment"># é€‰æ‹©å·¥ä½œèŠ‚ç‚¹</span></span><br><span class="line">      <span class="attr">operator:</span> <span class="string">DoesNotExist</span></span><br><span class="line">  <span class="attr">prepare:</span></span><br><span class="line">    <span class="attr">args:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">prepare</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">server-plan</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">rancher/k3s-upgrade</span></span><br><span class="line">  <span class="attr">serviceAccountName:</span> <span class="string">system-upgrade</span></span><br><span class="line">  <span class="attr">upgrade:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">rancher/k3s-upgrade</span></span><br><span class="line">  <span class="attr">version:</span> <span class="string">v1.20.4+k3s1</span></span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è‡ªåŠ¨å‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬(ä¸æŒ‡å®šç‰ˆæœ¬)</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">upgrade.cattle.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Plan</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="string">...</span></span><br><span class="line">  <span class="attr">upgrade:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">rancher/k3s-upgrade</span></span><br><span class="line">  <span class="attr">channel:</span> <span class="string">https://update.k3s.io/v1-release/channels/stable</span></span><br></pre></td></tr></table></figure><p><img src="https://img.hi-linux.com/staticfile/advance-k3s-tool-04-20220519092442639-2022-05-19-XowxJZ.png" alt="K3Sé›†ç¾¤å‡çº§"></p><h2><span id="5-k3s-å¤‡ä»½æ¢å¤">5. K3S å¤‡ä»½æ¢å¤</span></h2><blockquote><p><strong>SQLite + etcd + å¤–éƒ¨æ•°æ®å­˜å‚¨</strong></p></blockquote><ul><li>[1] ä½¿ç”¨åµŒå…¥å¼ SQLite æ•°æ®å­˜å‚¨è¿›è¡Œå¤‡ä»½å’Œæ¢å¤</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ–¹å¼1ï¼šå¤‡ä»½/æ¢å¤æ•°æ®ç›®å½•</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¤‡ä»½</span></span><br><span class="line">$ cp -rf /var/lib/rancher/k3s/server/db /opt/db</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¢å¤</span></span><br><span class="line">$ systemctl stop k3s</span><br><span class="line">$ rm -rf /var/lib/rancher/k3s/server/db</span><br><span class="line">$ cp -rf /opt/db /var/lib/rancher/k3s/server/db</span><br><span class="line">$ systemctl start k3s</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ–¹å¼2ï¼šé€šè¿‡ SQLite cli</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¤‡ä»½</span></span><br><span class="line">sqlite3 /var/lib/rancher/k3s/server/db/state.db</span><br><span class="line">SQLite version 3.22.0 2018-01-22 18:45:57</span><br><span class="line">Enter <span class="string">".help"</span> <span class="keyword">for</span> usage hints.</span><br><span class="line">sqlite&gt; .backup <span class="string">"/opt/kine.db"</span></span><br><span class="line">sqlite&gt; .<span class="built_in">exit</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¢å¤</span></span><br><span class="line">$ sudo systemctl stop k3s</span><br><span class="line"></span><br><span class="line">sqlite3 /var/lib/rancher/k3s/server/db/state.db</span><br><span class="line">SQLite version 3.22.0 2018-01-22 18:45:57</span><br><span class="line">Enter <span class="string">".help"</span> <span class="keyword">for</span> usage hints.</span><br><span class="line">sqlite&gt; .restore <span class="string">'/opt/kine.db'</span></span><br><span class="line">sqlite&gt; .<span class="built_in">exit</span></span><br><span class="line"></span><br><span class="line">$ sudo systemctl start k3s</span><br></pre></td></tr></table></figure><p>å½“ä½¿ç”¨å¤–éƒ¨æ•°æ®å­˜å‚¨æ—¶ï¼Œå¤‡ä»½å’Œæ¢å¤æ“ä½œæ˜¯åœ¨ <code>K3s</code> ä¹‹å¤–å¤„ç†çš„ã€‚æ•°æ®åº“ç®¡ç†å‘˜éœ€è¦å¯¹å¤–éƒ¨æ•°æ®åº“è¿›è¡Œå¤‡ä»½ï¼Œæˆ–è€…ä»å¿«ç…§æˆ–è½¬å‚¨ä¸­è¿›è¡Œæ¢å¤ã€‚æˆ‘ä»¬å»ºè®®å°†æ•°æ®åº“é…ç½®ä¸ºæ‰§è¡Œå®šæœŸå¿«ç…§ã€‚</p><ul><li>[2] ä½¿ç”¨å¤–éƒ¨æ•°æ®å­˜å‚¨è¿›è¡Œå¤‡ä»½å’Œæ¢å¤</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¤‡ä»½</span></span><br><span class="line">$ mysqldump -uroot -p --all-databases --master-data &gt; k3s-dbdump.db</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¢å¤</span></span><br><span class="line">$ systemctl stop k3s</span><br><span class="line">$ mysql -uroot -p  &lt; k3s-dbdump.db</span><br><span class="line">$ systemctl start k3s</span><br></pre></td></tr></table></figure><ul><li>[3] ä½¿ç”¨åµŒå…¥å¼ etcd æ•°æ®å­˜å‚¨è¿›è¡Œå¤‡ä»½å’Œæ¢å¤</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºå¿«ç…§(K3sé»˜è®¤å¯ç”¨å¿«ç…§)</span></span><br><span class="line"><span class="comment"># å¿«ç…§ç›®å½•é»˜è®¤: /var/lib/rancher/k3s/server/db/snapshots</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¦é…ç½®å¿«ç…§é—´éš”æˆ–ä¿ç•™çš„å¿«ç…§æ•°é‡</span></span><br><span class="line">--etcd-disable-snapshots       ç¦ç”¨è‡ªåŠ¨etcdå¿«ç…§</span><br><span class="line">--etcd-snapshot-schedule-cron  å®šæ—¶å¿«ç…§çš„æ—¶é—´ç‚¹ï¼›è®¤å€¼ä¸ºæ¯12å°æ—¶è§¦å‘ä¸€æ¬¡</span><br><span class="line">--etcd-snapshot-retention      ä¿ç•™çš„å¿«ç…§æ•°é‡ï¼›é»˜è®¤å€¼ä¸º5</span><br><span class="line">--etcd-snapshot-dir            ä¿å­˜æ•°æ®åº“å¿«ç…§çš„ç›®å½•è·¯å¾„</span><br><span class="line">--cluster-reset                å¿˜è®°æ‰€æœ‰çš„å¯¹ç­‰ä½“ï¼›æˆä¸ºæ–°é›†ç¾¤çš„å”¯ä¸€æˆå‘˜</span><br><span class="line">--cluster-reset-restore-path   è¦æ¢å¤çš„å¿«ç…§æ–‡ä»¶çš„è·¯å¾„</span><br></pre></td></tr></table></figure><p>å½“ <code>K3s</code> ä»å¤‡ä»½ä¸­æ¢å¤æ—¶ï¼Œæ—§çš„æ•°æ®ç›®å½•å°†è¢«ç§»åŠ¨åˆ°<code>/var/lib/rancher/k3s/server/db/etcd-old/</code>ã€‚ç„¶å <code>K3s</code> ä¼šå°è¯•é€šè¿‡åˆ›å»ºä¸€ä¸ªæ–°çš„æ•°æ®ç›®å½•æ¥æ¢å¤å¿«ç…§ï¼Œç„¶åä»ä¸€ä¸ªå¸¦æœ‰ä¸€ä¸ª <code>etcd</code> æˆå‘˜çš„æ–° <code>K3s</code> é›†ç¾¤å¯åŠ¨ <code>etcd</code>ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä»å¿«ç…§æ¢å¤é›†ç¾¤</span></span><br><span class="line"><span class="comment"># ä½¿ç”¨--cluster-reseté€‰é¡¹è¿è¡ŒK3s</span></span><br><span class="line"><span class="comment"># åŒæ—¶ç»™å‡º--cluster-reset-restore-path</span></span><br><span class="line">$ ./k3s server \</span><br><span class="line">    --cluster-reset \</span><br><span class="line">    --cluster-reset-restore-path=&lt;PATH-TO-SNAPSHOT&gt;</span><br></pre></td></tr></table></figure><h2><span id="6-k3s-å·å’Œå­˜å‚¨">6. K3S å·å’Œå­˜å‚¨</span></h2><blockquote><p><strong>ä»‹ç»äº†å¦‚ä½•é€šè¿‡ local storage provider æˆ– Longhorn æ¥è®¾ç½®æŒä¹…å­˜å‚¨ã€‚</strong></p></blockquote><p>å½“éƒ¨ç½²ä¸€ä¸ªéœ€è¦ä¿ç•™æ•°æ®çš„åº”ç”¨ç¨‹åºæ—¶ï¼Œä½ éœ€è¦åˆ›å»ºæŒä¹…å­˜å‚¨ã€‚æŒä¹…å­˜å‚¨å…è®¸æ‚¨ä»è¿è¡Œåº”ç”¨ç¨‹åºçš„ <code>pod</code> å¤–éƒ¨å­˜å‚¨åº”ç”¨ç¨‹åºæ•°æ®ã€‚å³ä½¿åº”ç”¨ç¨‹åºçš„ <code>pod</code> å‘ç”Ÿæ•…éšœï¼Œè¿™ç§å­˜å‚¨æ–¹å¼ä¹Ÿå¯ä»¥ä½¿æ‚¨ç»´æŠ¤åº”ç”¨ç¨‹åºæ•°æ®ã€‚</p><ul><li>[1] è®¾ç½® Local Storage Provider æ”¯æŒ</li></ul><p><code>K3s</code> è‡ªå¸¦ <code>Rancher</code> çš„ <code>Local Path Provisioner</code>(<code>LPP</code>)ï¼Œè¿™ä½¿å¾—èƒ½å¤Ÿä½¿ç”¨å„è‡ªèŠ‚ç‚¹ä¸Šçš„æœ¬åœ°å­˜å‚¨æ¥å¼€ç®±å³ç”¨åœ°åˆ›å»º <code>pvc</code>ã€‚æ ¹æ®ç”¨æˆ·é…ç½®ï¼Œ<code>LPP</code> å°†è‡ªåŠ¨åœ¨èŠ‚ç‚¹ä¸Šåˆ›å»ºåŸºäº <code>hostPath</code> çš„æŒä¹…å·ã€‚å®ƒåˆ©ç”¨äº† <code>K8s</code> çš„ <code>Local Persistent Volume</code> ç‰¹æ€§å¼•å…¥çš„ç‰¹æ€§ï¼Œä½†å®ƒæ¯” <code>K8s</code> ä¸­å†…ç½®çš„  <code>local pv</code> ç‰¹æ€§æ›´ç®€å•çš„è§£å†³æ–¹æ¡ˆã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># pvc.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">local-path-pvc</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">local-path</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">2Gi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># pod.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">volume-test</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">volume-test</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:stable-alpine</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">volv</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/data</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">volv</span></span><br><span class="line">    <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">      <span class="attr">claimName:</span> <span class="string">local-path-pvc</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åº”ç”¨yamlæœåŠ¡</span></span><br><span class="line">$ kubectl create -f pvc.yaml pod.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¡®è®¤PVå’ŒPVCå·²åˆ›å»º</span></span><br><span class="line">$ kubectl get pv</span><br><span class="line">$ kubectl get pvc</span><br></pre></td></tr></table></figure><ul><li>[2] è®¾ç½® Longhorn æ”¯æŒ</li></ul><p><code>K3s</code> æ”¯æŒ <code>Longhorn</code>(æ˜¯ <code>K8s</code> çš„ä¸€ä¸ªå¼€æºåˆ†å¸ƒå¼å—å­˜å‚¨ç³»ç»Ÿ)ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®‰è£…Longhorn</span></span><br><span class="line"><span class="comment"># å°†è¢«å®‰è£…åœ¨å‘½åç©ºé—´longhorn-systemä¸­</span></span><br><span class="line">$ kubectl apply -f https://raw.githubusercontent.com/longhorn/longhorn/master/deploy/longhorn.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># pvc.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">metadata:</span><br><span class="line">  name: longhorn-volv-pvc</span><br><span class="line">spec:</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  storageClassName: longhorn</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 2Gi</span><br><span class="line"></span><br><span class="line"><span class="comment"># pod.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: volume-test</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: volume-test</span><br><span class="line">    image: nginx:stable-alpine</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: volv</span><br><span class="line">      mountPath: /data</span><br><span class="line">    ports:</span><br><span class="line">    - containerPort: 80</span><br><span class="line">  volumes:</span><br><span class="line">  - name: volv</span><br><span class="line">    persistentVolumeClaim:</span><br><span class="line">      claimName: longhorn-volv-pvc</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åº”ç”¨yamlæœåŠ¡</span></span><br><span class="line">$ kubectl create -f pvc.yaml pod.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¡®è®¤PVå’ŒPVCå·²åˆ›å»º</span></span><br><span class="line">$ kubectl get pv</span><br><span class="line">$ kubectl get pvc</span><br></pre></td></tr></table></figure><h2><span id="7-k3s-ç½‘ç»œç›¸å…³">7. K3S ç½‘ç»œç›¸å…³</span></h2><blockquote><p><strong>ç®€å•ä»‹ç»ä¸‹ K3s ç›¸å…³çš„ç½‘ç»œé…ç½®ç»„ä»¶ï¼</strong></p></blockquote><ul><li><strong>CoreDNS</strong></li></ul><p><code>CoreDNS</code> æ˜¯åœ¨ <code>agent</code> èŠ‚ç‚¹å¯åŠ¨æ—¶éƒ¨ç½²çš„ã€‚è¦ç¦ç”¨ï¼Œè¯·åœ¨æ¯å°æœåŠ¡å™¨ä¸Šè¿è¡Œ <code>--disable coredns</code> é€‰é¡¹ã€‚å¦‚æœä½ ä¸å®‰è£… <code>CoreDNS</code>ï¼Œä½ å°†éœ€è¦è‡ªå·±å®‰è£…ä¸€ä¸ªé›†ç¾¤ <code>DNS</code> æä¾›å•†ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¦‚ä½•ä¿®æ”¹corednså‚æ•°</span></span><br><span class="line"><span class="comment"># /var/lib/rancher/k3s/server/manifests/coredns.yaml</span></span><br><span class="line"><span class="comment"># è¯¥æ–‡ä»¶é‡å¯K3sæœåŠ¡çš„è¯ä¼šå¯¼è‡´corednsé…ç½®é‡æ–°åˆå§‹åŒ–</span></span><br><span class="line">1.å°†coredns.yamlä¿å­˜åˆ°å…¶ä»–ç›®å½•</span><br><span class="line">2.é€šè¿‡ --<span class="built_in">disable</span> coredns ç¦ç”¨coredns</span><br><span class="line">3.å¤åˆ¶coredns.yamlåˆ°/var/lib/rancher/k3s/server/manifests/ç›®å½•å¹¶ä¿®æ”¹å‚æ•°</span><br></pre></td></tr></table></figure><ul><li><strong>Traefik Ingress Controller</strong></li></ul><p>å¯åŠ¨ <code>server</code> æ—¶ï¼Œé»˜è®¤æƒ…å†µä¸‹ä¼šéƒ¨ç½² <code>Traefik</code>ï¼Œå¯¹è¯¥æ–‡ä»¶çš„ä»»ä½•ä¿®æ”¹éƒ½ä¼šä»¥ç±»ä¼¼ <code>kubectl apply</code> çš„æ–¹å¼è‡ªåŠ¨éƒ¨ç½²åˆ° <code>Kubernetes</code> ä¸­ï¼Œå°†ä½¿ç”¨ä¸»æœºä¸Šçš„ <code>80</code> å’Œ <code>443</code> ç«¯å£ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ“ä½œå’Œä¸Šé¢åŸºæœ¬æ˜¯ä¸€è‡´çš„</span></span><br><span class="line"><span class="comment"># è¯·ä½¿ç”¨ --disable traefik é€‰é¡¹å¯åŠ¨æ¯ä¸ªserver</span></span><br><span class="line"><span class="comment"># /var/lib/rancher/k3s/server/manifests/traefik.yaml</span></span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¦‚ä½•å¯ç”¨ treafik2 dashboard</span></span><br><span class="line"><span class="comment"># http://traefik.example.com/dashboard</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># <span class="doctag">Note:</span> in a kubernetes secret the string (e.g. generated by htpasswd) must be base64-encoded first.</span></span><br><span class="line"><span class="comment"># To create an encoded user:password pair, the following command can be used:</span></span><br><span class="line"><span class="comment"># htpasswd -nb admin admin | openssl base64</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">authsecret</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">users:</span> <span class="string">|2</span></span><br><span class="line">    <span class="string">YWRtaW46JGFwcjEkLkUweHd1Z0EkUjBmLi85WndJNXZWRFMyR2F2LmtELwoK</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">traefik.containo.us/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">IngressRoute</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">traefik-dashboard</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">routes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">match:</span> <span class="string">Host(`traefik.example.com`)</span> <span class="string">&amp;&amp;</span> <span class="string">(PathPrefix(`/api`)</span> <span class="string">||</span> <span class="string">PathPrefix(`/dashboard`))</span></span><br><span class="line">      <span class="attr">kind:</span> <span class="string">Rule</span></span><br><span class="line">      <span class="attr">services:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">api@internal</span></span><br><span class="line">          <span class="attr">kind:</span> <span class="string">TraefikService</span></span><br><span class="line">      <span class="attr">middlewares:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">auth</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">traefik.containo.us/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Middleware</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">auth</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">basicAuth:</span></span><br><span class="line">    <span class="attr">secret:</span> <span class="string">authsecret</span> <span class="comment"># Kubernetes secret named "secretName"</span></span><br></pre></td></tr></table></figure><ul><li>Service Load Balancer</li></ul><p><code>K3s</code> æä¾›äº†ä¸€ä¸ªåä¸º <code>Klipper Load Balancer</code> çš„è´Ÿè½½å‡è¡¡å™¨ï¼Œå®ƒå¯ä»¥ä½¿ç”¨å¯ç”¨çš„ä¸»æœºç«¯å£ã€‚ å…è®¸åˆ›å»º <code>LoadBalancer</code> ç±»å‹çš„ <code>Service</code>ï¼Œä½†ä¸åŒ…æ‹¬ <code>LB</code> çš„å®ç°ã€‚æŸäº› <code>LB</code> æœåŠ¡éœ€è¦äº‘æä¾›å•†ï¼Œä¾‹å¦‚ <code>Amazon EC2</code>ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼Œ<code>K3s service LB</code> ä½¿å¾—å¯ä»¥åœ¨æ²¡æœ‰äº‘æä¾›å•†çš„æƒ…å†µä¸‹ä½¿ç”¨ <code>LB</code> æœåŠ¡ã€‚</p><h2><span id="8-k3s-ä¸-helm">8. K3S ä¸ Helm</span></h2><p><code>Helm</code> æ˜¯ <code>Kubernetes</code> çš„åŒ…ç®¡ç†å·¥å…·ã€‚<code>Helm Chart</code> ä¸º <code>Kubernetes YAML</code> æ¸…å•æ–‡ä»¶æä¾›äº†æ¨¡æ¿åŒ–è¯­æ³•ï¼Œå¯ä»¥é€šè¿‡ <code>Helm</code> å®‰è£…å¯¹åº”çš„ <code>chart</code>ã€‚<code>K3s</code> ä¸éœ€è¦ä»»ä½•ç‰¹æ®Šçš„é…ç½®å°±å¯ä»¥ä½¿ç”¨ <code>Helm</code> å‘½ä»¤è¡Œå·¥å…·ã€‚</p><ul><li>è‡ªåŠ¨éƒ¨ç½² Helm charts</li></ul><p>åœ¨ <code>/var/lib/rancher/k3s/server/manifests</code> ä¸­æ‰¾åˆ°çš„ä»»ä½• <code>Kubernetes</code> æ¸…å•å°†ä»¥ç±»ä¼¼ <code>kubectl apply</code> çš„æ–¹å¼è‡ªåŠ¨éƒ¨ç½²åˆ° <code>K3s</code>ã€‚ä»¥è¿™ç§æ–¹å¼éƒ¨ç½²çš„ <code>manifests</code> æ˜¯ä½œä¸º <code>AddOn</code> è‡ªå®šä¹‰èµ„æºæ¥ç®¡ç†çš„ã€‚ä½ ä¼šå‘ç°æ‰“åŒ…ç»„ä»¶çš„ <code>AddOns</code>ï¼Œå¦‚ <code>CoreDNS</code>ã€<code>Local-Storage</code> ç­‰ã€‚<code>AddOns</code> æ˜¯ç”±éƒ¨ç½²æ§åˆ¶å™¨è‡ªåŠ¨åˆ›å»ºçš„ï¼Œå¹¶æ ¹æ®å®ƒä»¬åœ¨ <code>manifests</code> ç›®å½•ä¸‹çš„æ–‡ä»¶åå‘½åã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹è¿è¡ŒAddOnèµ„æº</span></span><br><span class="line">$ kubectl get addon -A</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¹Ÿå¯ä»¥å°†Helm-Chartä½œä¸ºAddOnséƒ¨ç½²</span></span><br><span class="line">https://github.com/rancher/helm-controller/</span><br></pre></td></tr></table></figure><ul><li>ä½¿ç”¨ Helm CRD</li></ul><p><code>HelmChart CRD</code> æ•è·äº†å¤§å¤šæ•°ä½ é€šå¸¸ä¼šä¼ é€’ç»™ <code>helm</code> å‘½ä»¤è¡Œå·¥å…·çš„é€‰é¡¹ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ï¼Œè¯´æ˜å¦‚ä½•ä»é»˜è®¤çš„ <code>Chart</code> èµ„æºåº“ä¸­éƒ¨ç½² <code>Grafana</code>ï¼Œè¦†ç›–ä¸€äº›é»˜è®¤çš„ <code>Chart</code> å€¼ã€‚è¯·æ³¨æ„ï¼Œ<code>HelmChart</code> èµ„æºæœ¬èº«åœ¨ <code>kube-system</code> å‘½åç©ºé—´ï¼Œä½† <code>Chart</code> èµ„æºå°†è¢«éƒ¨ç½²åˆ° <code>monitoring</code> å‘½åç©ºé—´ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">helm.cattle.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">HelmChart</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">grafana</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">chart:</span> <span class="string">stable/grafana</span></span><br><span class="line">  <span class="attr">targetNamespace:</span> <span class="string">monitoring</span></span><br><span class="line">  <span class="attr">set:</span></span><br><span class="line">    <span class="attr">adminPassword:</span> <span class="string">"NotVerySafePassword"</span></span><br><span class="line">  <span class="attr">valuesContent:</span> <span class="string">|-</span></span><br><span class="line">    <span class="attr">image:</span></span><br><span class="line">      <span class="attr">tag:</span> <span class="string">master</span></span><br><span class="line">    <span class="attr">env:</span></span><br><span class="line">      <span class="attr">GF_EXPLORE_ENABLED:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">adminUser:</span> <span class="string">admin</span></span><br><span class="line">    <span class="attr">sidecar:</span></span><br><span class="line">      <span class="attr">datasources:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><h2><span id="9-k3s-é«˜çº§é€‰é¡¹">9. K3S é«˜çº§é€‰é¡¹</span></h2><blockquote><p><strong><a href="https://github.com/kingsd041/k3s-tutorial/blob/main/17-%E9%AB%98%E7%BA%A7%E9%80%89%E9%A1%B9%E5%92%8C%E9%85%8D%E7%BD%AE/README.md" target="_blank" rel="noopener">åŒ…å«é«˜çº§é€‰é¡¹å’Œé…ç½®</a></strong></p></blockquote><ul><li>è¯ä¹¦è½®æ¢</li></ul><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œ<code>K3s</code> çš„è¯ä¹¦åœ¨ <code>12</code> ä¸ªæœˆå†…è¿‡æœŸã€‚å¦‚æœè¯ä¹¦å·²ç»è¿‡æœŸæˆ–å‰©ä½™çš„æ—¶é—´ä¸è¶³ <code>90</code> å¤©ï¼Œåˆ™åœ¨ <code>K3s</code> é‡å¯æ—¶è½®æ¢è¯ä¹¦ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥è¯¢K3sè¯ä¹¦è¿‡æœŸæ—¶é—´</span></span><br><span class="line">$ <span class="keyword">for</span> i <span class="keyword">in</span> `ls /var/lib/rancher/k3s/server/tls/*.crt`; \</span><br><span class="line">  <span class="keyword">do</span> \</span><br><span class="line">    <span class="built_in">echo</span> <span class="variable">$i</span>;\</span><br><span class="line">    openssl x509 -enddate -noout -<span class="keyword">in</span> <span class="variable">$i</span>; \</span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿®æ”¹ç³»ç»Ÿæ—¶é—´ä¸ºè¯ä¹¦è¿‡æœŸå‰90å¤©æˆ–è¯ä¹¦è¿‡æœŸå</span></span><br><span class="line">$ timedatectl <span class="built_in">set</span>-ntp no</span><br><span class="line">$ date -s 20220807</span><br><span class="line"></span><br><span class="line"><span class="comment"># é‡å¯K3sæœåŠ¡</span></span><br><span class="line">$ service k3s restart</span><br></pre></td></tr></table></figure><ul><li>Red Hat å’Œ CentOS çš„é¢å¤–å‡†å¤‡</li></ul><p>å»ºè®®è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œå…³é—­ <code>firewalld</code> é˜²ç«å¢™ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo systemctl <span class="built_in">disable</span> firewalld --now</span><br></pre></td></tr></table></figure><h2><span id="10-å‚è€ƒé“¾æ¥">10. å‚è€ƒé“¾æ¥</span></h2><blockquote><p><strong>é€äººç«ç‘°ï¼Œæ‰‹æœ‰ä½™é¦™ï¼</strong></p></blockquote><ul><li><strong>[1] æ–‡æ¡£æ•™ç¨‹</strong><ul><li><a href="http://mirror.cnrancher.com/" target="_blank" rel="noopener">K3s ä¸­æ–‡æ–‡æ¡£ - å›½å¤–</a></li><li><a href="https://docs.rancher.cn/k3s" target="_blank" rel="noopener">K3s ä¸­æ–‡æ–‡æ¡£ - å›½å†…</a></li><li><a href="https://mirror.rancher.cn/" target="_blank" rel="noopener">K3s å›½å†…é•œåƒç«™ - åŠ é€Ÿ</a></li><li><a href="https://github.com/kingsd041/k3s-tutorial" target="_blank" rel="noopener">K3s ç³»åˆ—æ•™ç¨‹ - å®˜æ–¹åˆ¶ä½œ</a></li></ul></li><li><strong>[2] ä»£ç åœ°å€</strong><ul><li><a href="https://github.com/k3s-io" target="_blank" rel="noopener">K3s ä»“åº“åœ°å€ - Github</a></li></ul></li><li><strong>[3] å‘¨è¾¹é¡¹ç›®</strong><ul><li>K3s å‘¨è¾¹é¡¹ç›® - k3os<ul><li>å®Œå…¨åŸºäº <code>K8S</code> ç®¡ç†çš„è½»é‡çº§æ“ä½œç³»ç»Ÿ</li></ul></li><li>K3s å‘¨è¾¹é¡¹ç›® - autok3s<ul><li>ç”¨äºç®€åŒ– <code>K3s</code> é›†ç¾¤éƒ¨ç½²å’Œç®¡ç†çš„è½»é‡çº§å·¥å…·</li><li>å³åœ¨é˜¿é‡Œäº‘å’Œ <code>aws</code> ç­‰äº‘æœåŠ¡å™¨ä¸Šé¢éƒ¨ç½² <code>k3s</code></li></ul></li><li>K3s å‘¨è¾¹é¡¹ç›® - k3d<ul><li>å¯ä»¥åœ¨ <code>k3d</code> åˆ›å»ºå®¹å™¨åŒ–çš„ <code>k3s</code> é›†ç¾¤</li><li>å¯ä»¥ä½¿ç”¨å®¹å™¨åœ¨å•å°è®¡ç®—æœºä¸Šå¯åŠ¨å¤šèŠ‚ç‚¹ <code>k3s</code> é›†ç¾¤</li></ul></li><li>K3s å‘¨è¾¹é¡¹ç›® - harvester<ul><li>åŸºäº <code>K8S</code> æ„å»ºçš„å¼€æºè¶…èåˆåŸºç¡€æ¶æ„(<code>HCI</code>)è½¯ä»¶</li><li>æ—¨åœ¨æ›¿æ¢ <code>vSphere</code> å’Œ <code>Nutanix</code> çš„å¼€æºæ›¿ä»£æ–¹æ¡ˆ</li></ul></li><li>K3s å‘¨è¾¹é¡¹ç›® - octopus<ul><li>ä¸»è¦ç”¨äºè¾¹ç¼˜è®¡ç®—ç›¸å…³</li><li>ç”¨äº <code>K8S</code> å’Œ <code>k3s</code> çš„è½»é‡çº§äº‘åŸç”Ÿè®¾å¤‡ç®¡ç†ç³»ç»Ÿ</li><li>é›†ç¾¤å¯ä»¥å°†è¾¹ç¼˜è®¾å¤‡ä½œä¸ºè‡ªå®šä¹‰ <code>k8s</code> èµ„æºè¿›è¡Œç®¡ç†</li></ul></li></ul></li></ul><blockquote><p>æœ¬æ–‡è½¬è½½è‡ªï¼šã€Œ Escape çš„åšå®¢ ã€ï¼ŒåŸæ–‡ï¼š<a href="https://url.hi-linux.com/ytP71" target="_blank" rel="noopener">https://url.hi-linux.com/ytP71</a> ï¼Œç‰ˆæƒå½’åŸä½œè€…æ‰€æœ‰ã€‚æ¬¢è¿æŠ•ç¨¿ï¼ŒæŠ•ç¨¿é‚®ç®±: <a href="mailto:editor@hi-linux.com">editor@hi-linux.com</a>ã€‚</p></blockquote></div><script src="https://my.openwrite.cn/js/readmore.js" type="text/javascript"></script><script>var isMobile = navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i);if (!isMobile) {    var btw = new BTWPlugin();    btw.init({        "id": "vip-container",        "blogId": "10135-1588830050631-449",        "name": "ã€Œå¥‡å¦™çš„ Linux ä¸–ç•Œã€",        "qrcode": "https://www.hi-linux.com/img/wechat/mp_qrcode_12.jpg",        "keyword": "VIP"    });}</script>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;æ·±å…¥ç†è§£å®˜æ–¹æ–‡æ¡£ï¼Œè½»æ¾å­¦ä¼šä½¿ç”¨ K3S å·¥å…·ï¼&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;code&gt;K3s&lt;/code&gt; æ˜¯ä¸€ä¸ªè½»é‡çº§çš„ &lt;code&gt;Kubernetes&lt;/code&gt; å‘è¡Œç‰ˆï¼Œå®ƒé’ˆå¯¹è¾¹ç¼˜è®¡ç®—ã€ç‰©è”ç½‘ç­‰åœºæ™¯è¿›è¡Œäº†é«˜åº¦ä¼˜åŒ–ã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;CNCF&lt;/code&gt; è®¤è¯çš„ &lt;code&gt;Kubernetes&lt;/code&gt; å‘è¡Œç‰ˆ&lt;/li&gt;
&lt;li&gt;æ”¯æŒ &lt;code&gt;X86_64&lt;/code&gt;, &lt;code&gt;ARM64&lt;/code&gt;, &lt;code&gt;ARMv7&lt;/code&gt; å¹³å°&lt;/li&gt;
&lt;li&gt;å•ä¸€è¿›ç¨‹åŒ…å« &lt;code&gt;Kubernetes master&lt;/code&gt;ï¼Œ&lt;code&gt;kubelet&lt;/code&gt; å’Œ &lt;code&gt;containerd&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
    
      <category term="Linux" scheme="https://www.hi-linux.com/categories/Linux/"/>
    
    
      <category term="Linux" scheme="https://www.hi-linux.com/tags/Linux/"/>
    
      <category term="Kubernetes" scheme="https://www.hi-linux.com/tags/Kubernetes/"/>
    
      <category term="K3s" scheme="https://www.hi-linux.com/tags/K3s/"/>
    
  </entry>
  
  <entry>
    <title>å†è§ Alfredï¼Œæ˜¯æ—¶å€™æ‹¥æŠ±ä¸‹ä¸€ä»£å¿«æ·å¯åŠ¨ç¥å™¨ Raycast äº†</title>
    <link href="https://www.hi-linux.com/posts/21309.html"/>
    <id>https://www.hi-linux.com/posts/21309.html</id>
    <published>2022-04-28T01:00:00.000Z</published>
    <updated>2022-04-28T04:21:29.798Z</updated>
    
    <content type="html"><![CDATA[<div id="vip-container"><blockquote><p><strong>ä¸€æ¬¾é€Ÿåº¦æå¿«ã€å®Œå…¨å¯æ‰©å±•çš„å¯åŠ¨å™¨ã€‚</strong></p></blockquote><p>ä»Šå¤©ç»™å¤§å®¶ä»‹ç»ä¸€æ¬¾å¯ä»¥å¸®åŠ©æˆ‘ä»¬æå‡ç”Ÿäº§åŠ›æˆ–è€…æ”¹å–„æ•ˆç‡çš„å·¥å…·ï¼Œé‚£å°±æ˜¯ <code>Raycast</code>ã€‚å®ƒçš„åŠŸèƒ½å’Œæˆ‘ä»¬çŸ¥é“çš„ <code>Spotlight</code> å’Œ <code>Alfred</code> å¾ˆç±»ä¼¼ï¼Œä½†æ˜¯å…¶ <code>UI</code> æ¶‰åŠå®Œå…¨å¯ä»¥èƒ½å¤Ÿé©¾é©­ <code>macOS</code> çš„å…¨æ–°çš„è§†è§‰é£æ ¼(å¦‚ä¸‹å›¾æ‰€ç¤º)ã€‚</p><p><img src="https://img.hi-linux.com/staticfile/raycast-terminal-tool-2022-04-28-WkhBCv.jpg" alt="Raycast ä¸‹ä¸€ä»£å¿«æ·å¯åŠ¨å™¨"></p><h2><span id="1-å·¥å…·ä»‹ç»">1. å·¥å…·ä»‹ç»</span></h2><blockquote><p><strong>ä½ çš„æ–°ä¸€ä»£å¿«æ·å¯åŠ¨å™¨</strong></p></blockquote><p><code>Raycast</code> æ˜¯ç›´åˆ° <code>10</code> æœˆ <code>29</code> æ—¥æ‰æ”¾å‡ºè¿™ç¬¬ä¸€ä¸ªå…¬æµ‹ç‰ˆæœ¬ï¼Œå…¶å¼€å‘è€…ä»‹ç» <code>Raycast</code> æ­£æ˜¯å—å‘½ä»¤è¡Œçš„å¯å‘ï¼Œä½œä¸ºè½¯ä»¶å·¥ç¨‹å¸ˆï¼Œä»–ä»¬æ³¨æ„åˆ°è‡ªå·±çœŸæ­£å†™ä»£ç çš„æ—¶é—´è¶Šæ¥è¶Šå°‘ï¼Œåè€Œéœ€è¦æ›´å¤šçš„æ—¶é—´æ¥ç®¡ç†è½¯ä»¶å¼€å‘ï¼Œä¾‹å¦‚è·Ÿè¸ª <code>bug</code> åé¦ˆã€ç®¡ç† <code>sprint</code>ã€å‘å¸ƒæ–°ç‰ˆæœ¬ç­‰ç­‰ï¼Œè¿™äº›éƒ½éœ€è¦å€ŸåŠ©ç½‘é¡µç«¯æˆ–è€…å…¶å®ƒçš„ä¸åŒå·¥å…·æ¥å®Œæˆã€‚</p><p>äºæ˜¯ï¼Œ<code>Raycast</code> æ­£æ˜¯ä¸ºäº†è§£å†³ä»–ä»¬çš„å›°æ‰°è€Œåˆ›å»ºï¼Œå°½å¯èƒ½å°†å¸¸ç”¨çš„ç®¡ç†å¼€å‘ã€å†…éƒ¨ä¼šè®®ã€ä»»åŠ¡è§„åˆ’ç­‰å†…å®¹é›†æˆåœ¨ä¸€èµ·ï¼Œè…¾å‡ºæ›´å¤šåœ°æ—¶é—´æ”¾åœ¨ç¼–å†™ä»£ç ä¸Šã€‚ç®€å•è¿‡ä¸€ä¸‹ <code>Raycast</code> ç›®å‰æ‰€èƒ½å®ç°çš„æ ¸å¿ƒåŠŸèƒ½ï¼š</p><ul><li>åœ¨ <code>macOS</code> ä¸Šå¯åŠ¨ç¨‹åºæˆ–è€…æœç´¢æ–‡ä»¶ï¼Œç›¸å½“äºèšç„¦ï¼›</li><li>åœ¨ <code>GitHub</code>ã€<code>Jira</code> ä¸­åˆ›å»ºã€æœç´¢å’Œå…³é—­ <code>issues</code>ï¼›</li><li>æ‰¹å‡†ã€åˆå¹¶å’Œå…³é—­ <code>GitHub</code> çš„æ‹‰å–è¯·æ±‚ï¼›</li><li>è°ƒç”¨ <code>Zoom</code> ç®¡ç†æ—¥å¸¸ä¼šè®®ï¼›</li><li>æ”¯æŒå¿«æ·è®¾ç½®æ—¥ç¨‹ã€å¾…åŠäº‹é¡¹ä»¥åŠå…¶å®ƒè¯¸å¤šç³»ç»Ÿè®¾ç½®ï¼›</li><li>æ”¯æŒè„šæœ¬æ‰©å±•ï¼›</li><li>â€¦â€¦</li></ul><p><img src="https://img.hi-linux.com/staticfile/raycast-terminal-tool-01-20220428092254655-2022-04-28-iV3UcV.png" alt="Raycast ä¸‹ä¸€ä»£å¿«æ·å¯åŠ¨å™¨"></p><a id="more"></a><h2><span id="2-é…ç½®è¯´æ˜">2. é…ç½®è¯´æ˜</span></h2><blockquote><p><strong>å¯å®Œå…¨å–ä»£èšç„¦</strong></p></blockquote><p>æ—¢ç„¶ <code>Raycast</code> åŒ…å«äº† <code>Spotlight</code> çš„åŠŸèƒ½ï¼Œæ„å‘³ç€ä½ å®Œå…¨å¯ä»¥ç”¨ <code>Raycast</code> æ›¿æ¢æ‰å®ƒã€‚é»˜è®¤å¿«æ·é”®ä¸º <strong>ã€Œoption + ç©ºæ ¼ã€</strong> ï¼Œå¯ä»¥å¯åŠ¨è¯¥å·¥å…·ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨è¾“å…¥æ¡†ä¸­è¾“å…¥ä¿¡æ¯æ¥å¾—åˆ°æˆ‘ä»¬æƒ³è¦çš„ä¸œè¥¿æˆ–å¯åŠ¨å¯¹åº”çš„åº”ç”¨æœåŠ¡ã€‚</p><ul><li>æ˜¾ç¤ºä¸€ä¸ªæœç´¢æ¡†<ul><li>æ¨èé¡¹ç›®(æ ¹æ®ä½¿ç”¨é¢‘ç‡)</li><li>æ‰‹åŠ¨æ”¶è—é¡¹ç›®ä»¥åŠå¿«æ·æ“ä½œ</li><li>ä¸‹æ»‘åˆ™èƒ½çœ‹åˆ°æ‰€æœ‰çš„é¡¹ç›®</li></ul></li></ul><p><img src="https://img.hi-linux.com/staticfile/raycast-terminal-tool-02-2022-04-28-9jsJYr.png" alt="Raycast ä¸‹ä¸€ä»£å¿«æ·å¯åŠ¨å™¨"></p><p>è½¯ä»¶å³ä¸‹è§’æœ‰å¿«æ·èœå•ï¼Œé™¤äº†æ‰“å¼€åº”ç”¨/æ–‡ä»¶ä¹‹å¤–ï¼Œè¿˜å¯ä»¥å¿«é€Ÿå®šä½æ–‡ä»¶ä½ç½®æˆ–è€…æ‰§è¡Œå…¶å®ƒæ“ä½œï¼Œè€Œä¸”è¿™äº›æ‰€æœ‰çš„ä¸€ç³»åˆ—æ“ä½œéƒ½å¯ä»¥ä½¿ç”¨å¿«æ·é”®å®Œæˆã€‚æ–‡ä»¶æœç´¢åŠŸèƒ½æ”¯æŒéƒ¨åˆ†å›¾ç‰‡ã€æ–‡æ¡£é¢„è§ˆï¼Œä¸”èƒ½æ˜¾ç¤ºæ–‡ä»¶è¯¦ç»†ä¿¡æ¯ï¼Œè¿™ä¸ªæ¯”èšç„¦å®ç”¨æ€§æ›´é«˜ã€‚</p><h2><span id="3-é«˜çº§ç‰¹æ€§">3. é«˜çº§ç‰¹æ€§</span></h2><blockquote><p><strong>æ”¯æŒç®¡ç†æ—¥ç¨‹ã€å¾…åŠäº‹é¡¹ã€å‰ªè´´æ¿å†å²</strong></p></blockquote><p><code>Raycast</code> å¯¹æ¥äº†ä¸å°‘ç¬¬ä¸‰æ–¹åº”ç”¨çš„åŠŸèƒ½æœåŠ¡ï¼Œä¹ŸåŒ…æ‹¬ <code>macOS</code> ç³»ç»Ÿè‡ªå¸¦çš„æ—¥ç¨‹æŸ¥çœ‹ä»¥åŠå¾…åŠäº‹é¡¹ç®¡ç†ï¼Œè¿™äº›æ‰€èƒ½å®ç°çš„æ“ä½œåœ¨è®¾ç½®ä¸­éƒ½å¯ä»¥ç›´æ¥çœ‹åˆ°ï¼Œå¯æ‰‹åŠ¨é€‰æ‹©å…³é—­ã€‚ä¸è¿‡åŒæ ·æ˜¯ç³»ç»Ÿåº”ç”¨ï¼Œé€šè¿‡ <code>Raycast</code> å¯ä»¥æŸ¥çœ‹ã€åˆ›å»ºå¾…åŠäº‹é¡¹ï¼Œè€Œæ—¥å†æ—¥ç¨‹å´åªèƒ½æŸ¥çœ‹ï¼Œæ— æ³•é€šè¿‡ <code>Raycast</code> æ–°å»ºã€‚</p><p><img src="https://img.hi-linux.com/staticfile/raycast-terminal-tool-03-20220428092302624-2022-04-28-TOPIrj.jpg" alt="Raycast ä¸‹ä¸€ä»£å¿«æ·å¯åŠ¨å™¨"></p><p>å‰ªè´´æ¿å†å²è®°å½•ç®—æ˜¯ <code>Raycast</code> ç»™æˆ‘çš„ä¸€ä¸ªå°å°æƒŠå–œï¼Œè¿™æ˜¯ <code>Raycast</code> æœ¬èº«è‡ªå¸¦çš„å°åŠŸèƒ½ã€‚è€Œé€šè¿‡ <code>Raycast</code> æœç´¢ã€Œ<code>Clipboard History</code>ã€ï¼Œèƒ½å¤Ÿç›´æ¥æŸ¥çœ‹è¿‘æœŸçš„å‰ªè´´æ¿è®°å½•ã€‚</p><p><img src="https://img.hi-linux.com/staticfile/raycast-terminal-tool-04-20220428092310098-2022-04-28-kXgJZZ.jpg" alt="Raycast ä¸‹ä¸€ä»£å¿«æ·å¯åŠ¨å™¨"></p><p>æ¥å…¥ç¬¬ä¸‰æ–¹æœåŠ¡é«˜æ•ˆåä½œï¼Œå·²ç»æ¥å…¥äº† <code>GitHub</code>ã€<code>Jira</code>ã€<code>Zoom</code> ç­‰æœåŠ¡ï¼Œèƒ½å¤Ÿå¿«é€Ÿå®Œæˆç‰¹å®šæ“ä½œã€‚ç”¨æˆ·éœ€è¦é€šè¿‡ <code>OAuth</code> åè®®ç™»å½•æŒ‡å®šæœåŠ¡ï¼Œå·²å®Œæˆè‡ªæœ‰è´¦å·å†…å®¹çš„åŒå‘åŒæ­¥ã€‚</p><p><img src="https://img.hi-linux.com/staticfile/raycast-terminal-tool-05-2022-04-28-qMZDRk.jpg" alt="Raycast ä¸‹ä¸€ä»£å¿«æ·å¯åŠ¨å™¨"></p><p>æ—¥å¸¸ä½¿ç”¨ç”µè„‘ï¼Œå¯èƒ½ç»å¸¸ä¼šéœ€è¦è°ƒæ•´ä¸€äº›ç³»ç»Ÿè®¾ç½®é¡¹ï¼Œä¾‹å¦‚éŸ³é‡è°ƒèŠ‚ã€ä¼‘çœ ã€é”å±æˆ–è€…æ·±è‰²æ¨¡å¼åˆ‡æ¢ç­‰ç­‰ã€‚ä¸å°‘ç”¨æˆ·ä¼šé€šè¿‡ç¬¬ä¸‰æ–¹å·¥å…·æ¥å®Œæˆï¼Œä¾‹å¦‚  <code>One Switch</code>ã€‚<code>Raycast</code> æœ¬èº«å†…ç½®äº†ä¸€äº›ç³»ç»ŸåŠŸèƒ½è°ƒèŠ‚ï¼ŒåŒæ—¶æ”¯æŒåŠ è½½å‘½ä»¤è„šæœ¬ï¼Œæ„å‘³ç€èƒ½å¤Ÿå°†å¾ˆå¤šè¾ƒä¸ºéšç§˜çš„ç³»ç»Ÿè®¾ç½®èå…¥ <code>Raycast</code> å®ç°å¿«æ·æ“ä½œã€‚</p><p><img src="https://img.hi-linux.com/staticfile/raycast-terminal-tool-06-2022-04-28-k0gQv8.jpg" alt="Raycast ä¸‹ä¸€ä»£å¿«æ·å¯åŠ¨å™¨"></p><h2><span id="4-æ’ä»¶">4. æ’ä»¶</span></h2><p>Raycast å®˜æ–¹æœ‰ç€ç›¸å½“ä¸°å¯Œçš„æ’ä»¶ç”Ÿæ€ï¼ŒåŒ…æ‹¬ <code>Vscode</code>ã€<code>Github</code>ã€<code>Google</code>ã€<code>Docker</code>ã€<code>Kubernetes</code> ç­‰å¸¸ç”¨æ’ä»¶ã€‚</p><p><img src="https://img.hi-linux.com/staticfile/image-20220428093840589-2022-04-28-uLVFIV.png" alt="Raycast ä¸‹ä¸€ä»£å¿«æ·å¯åŠ¨å™¨"></p><p><img src="https://img.hi-linux.com/staticfile/image-20220428093923976-2022-04-28-k9bfl4.png" alt="Raycast ä¸‹ä¸€ä»£å¿«æ·å¯åŠ¨å™¨"></p><p>ä¸‹é¢ä»¥ <a href="http://Ray.so" target="_blank" rel="noopener">Ray.so</a> ä¸ºä¾‹ï¼Œæ¥çœ‹çœ‹å…¶å¼ºå¤§çš„æ’ä»¶åŠŸèƒ½ï¼š</p><blockquote><p><strong>ä¸»è¦æ˜¯ä»‹ç»ç›¸å…³çš„ä¸€äº›é…ç½®é›†åˆæˆ‘ä»¬åº”è¯¥æ€ä¹ˆä½¿ç”¨</strong></p></blockquote><ul><li>[1] ç”Ÿæˆæ¼‚äº®çš„åˆ†äº«ä»£ç  - <a href="http://Raycast+Ray.so" target="_blank" rel="noopener">Raycast+Ray.so</a><ul><li>å®‰è£…ï¼š<code>Raycast</code> -&gt; <code>store</code> - <code>ray.so</code></li><li>ä½¿ç”¨ï¼šé€‰ä¸­ä»£ç  -&gt; æ‰“å¼€æœç´¢ <code>CI</code>(<code>Copy Image</code>) -&gt; ç”Ÿæˆ</li><li>å®šåˆ¶ï¼šæ‰“å¼€æœç´¢ <code>Create Image from Code</code> è¿›è¡Œè®¾ç½®</li></ul></li></ul><p><code>Ray.so</code> æ˜¯ä¸€æ¬¾æä¾›ä»£ç å›¾ç‰‡åˆ†äº«çš„ <code>Web</code> æœåŠ¡ï¼Œå¯ä»¥å°†ä»£ç æ–‡æœ¬è½¬åŒ–ä¸ºç¾è§‚çš„å›¾ç‰‡è¿›è¡Œåˆ†äº«ï¼Œç±»ä¼¼çš„ Web æœåŠ¡è¿˜æœ‰  <a href="https://carbon.now.sh/" target="_blank" rel="noopener">Carbon</a> ç­‰ã€‚</p><p><img src="https://img.hi-linux.com/staticfile/raycast-terminal-tool-07-20220428092319067-2022-04-28-xISHXC.png" alt="Raycast ä¸‹ä¸€ä»£å¿«æ·å¯åŠ¨å™¨"></p><p>æ›´å¤šå¥½ç”¨çš„æ’ä»¶å¯åˆ° Raycast Store æ¢ç´¢ã€‚</p><blockquote><p>Raycast Store å®˜æ–¹åœ°å€: <a href="https://www.raycast.com/store" target="_blank" rel="noopener">https://www.raycast.com/store</a></p></blockquote><p>å¦‚æœå®˜æ–¹ Raycast Store æä¾›çš„æ’ä»¶ä¹Ÿä¸èƒ½æ»¡è¶³ä½ æ›´å¤šç‹‚é‡çš„éœ€æ±‚ï¼Œä½ è¿˜å¯åˆ°å¼€æºç¤¾åŒºè·å–æ›´å¤šçš„è„šæœ¬æ’ä»¶ã€‚</p><p><img src="https://img.hi-linux.com/staticfile/dPV66e-2022-04-28-Ri7jvF.jpg" alt="Raycast ä¸‹ä¸€ä»£å¿«æ·å¯åŠ¨å™¨"></p><p><img src="https://img.hi-linux.com/staticfile/add-directory-2022-04-28-2Wqr2O.png" alt="Raycast ä¸‹ä¸€ä»£å¿«æ·å¯åŠ¨å™¨"></p><p>é™¤æ­¤ä¹‹å¤–ï¼Œä½ è¿˜å¯ä»¥æŒ‰è‡ªèº«éœ€æ±‚å®šåˆ¶ä¸“ç”¨çš„è„šæœ¬ï¼Œæ”¯æŒçš„è„šæœ¬è¯­è¨€æœ‰ï¼š<code>Bash</code>ï¼Œ<code>Python</code>ï¼Œ<code>Apple Script</code>ï¼Œ<code>Swift</code>ï¼Œ<code>Ruby</code>ï¼Œ<code>Node.js</code>ã€‚</p><p><img src="https://img.hi-linux.com/staticfile/Create-Script-Command-20220428114937278-2022-04-28-e1Y4Jy.png" alt="Raycast ä¸‹ä¸€ä»£å¿«æ·å¯åŠ¨å™¨"></p><blockquote><p>Raycast Script å®˜æ–¹åœ°å€: <a href="https://github.com/raycast/script-commands" target="_blank" rel="noopener">https://github.com/raycast/script-commands</a></p></blockquote><h2><span id="5-å‚è€ƒé“¾æ¥">5. å‚è€ƒé“¾æ¥</span></h2><ul><li><a href="https://sspai.com/post/63521" target="_blank" rel="noopener">Raycast å¿«æ·å¯åŠ¨å™¨ä¸­çš„ã€Œæ½œåŠ›è‚¡ã€</a></li><li><a href="https://sspai.com/post/72627" target="_blank" rel="noopener">Raycast åˆ†äº«è®©äººçœ¼å‰ä¸€äº®çš„ä»£ç </a></li><li><a href="https://github.com/raycast/script-commands" target="_blank" rel="noopener">Raycast è„šæœ¬å¤§é›†åˆ - å¯å‚è€ƒå’Œä½¿ç”¨</a></li><li><a href="https://www.notion.so/Raycast-Manual-d5c85a7694dc4e4088b8b93557ea6d2d" target="_blank" rel="noopener">Raycast å®˜æ–¹ä½¿ç”¨æ‰‹å†Œ - æ–°æ‰‹æŒ‡å—</a></li></ul><blockquote><p>æœ¬æ–‡è½¬è½½è‡ªï¼šã€Œ Escape çš„åšå®¢ ã€ï¼ŒåŸæ–‡ï¼š<a href="https://url.hi-linux.com/8wXQL" target="_blank" rel="noopener">https://url.hi-linux.com/8wXQL</a> ï¼Œç‰ˆæƒå½’åŸä½œè€…æ‰€æœ‰ã€‚æ¬¢è¿æŠ•ç¨¿ï¼ŒæŠ•ç¨¿é‚®ç®±: <a href="mailto:editor@hi-linux.com">editor@hi-linux.com</a>ã€‚</p></blockquote></div><script src="https://my.openwrite.cn/js/readmore.js" type="text/javascript"></script><script>var isMobile = navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i);if (!isMobile) {    var btw = new BTWPlugin();    btw.init({        "id": "vip-container",        "blogId": "10135-1588830050631-449",        "name": "ã€Œå¥‡å¦™çš„ Linux ä¸–ç•Œã€",        "qrcode": "https://www.hi-linux.com/img/wechat/mp_qrcode_12.jpg",        "keyword": "VIP"    });}</script>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;ä¸€æ¬¾é€Ÿåº¦æå¿«ã€å®Œå…¨å¯æ‰©å±•çš„å¯åŠ¨å™¨ã€‚&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;ä»Šå¤©ç»™å¤§å®¶ä»‹ç»ä¸€æ¬¾å¯ä»¥å¸®åŠ©æˆ‘ä»¬æå‡ç”Ÿäº§åŠ›æˆ–è€…æ”¹å–„æ•ˆç‡çš„å·¥å…·ï¼Œé‚£å°±æ˜¯ &lt;code&gt;Raycast&lt;/code&gt;ã€‚å®ƒçš„åŠŸèƒ½å’Œæˆ‘ä»¬çŸ¥é“çš„ &lt;code&gt;Spotlight&lt;/code&gt; å’Œ &lt;code&gt;Alfred&lt;/code&gt; å¾ˆç±»ä¼¼ï¼Œä½†æ˜¯å…¶ &lt;code&gt;UI&lt;/code&gt; æ¶‰åŠå®Œå…¨å¯ä»¥èƒ½å¤Ÿé©¾é©­ &lt;code&gt;macOS&lt;/code&gt; çš„å…¨æ–°çš„è§†è§‰é£æ ¼(å¦‚ä¸‹å›¾æ‰€ç¤º)ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://img.hi-linux.com/staticfile/raycast-terminal-tool-2022-04-28-WkhBCv.jpg&quot; alt=&quot;Raycast ä¸‹ä¸€ä»£å¿«æ·å¯åŠ¨å™¨&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;1-å·¥å…·ä»‹ç»&quot;&gt;1. å·¥å…·ä»‹ç»&lt;/h2&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;ä½ çš„æ–°ä¸€ä»£å¿«æ·å¯åŠ¨å™¨&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;code&gt;Raycast&lt;/code&gt; æ˜¯ç›´åˆ° &lt;code&gt;10&lt;/code&gt; æœˆ &lt;code&gt;29&lt;/code&gt; æ—¥æ‰æ”¾å‡ºè¿™ç¬¬ä¸€ä¸ªå…¬æµ‹ç‰ˆæœ¬ï¼Œå…¶å¼€å‘è€…ä»‹ç» &lt;code&gt;Raycast&lt;/code&gt; æ­£æ˜¯å—å‘½ä»¤è¡Œçš„å¯å‘ï¼Œä½œä¸ºè½¯ä»¶å·¥ç¨‹å¸ˆï¼Œä»–ä»¬æ³¨æ„åˆ°è‡ªå·±çœŸæ­£å†™ä»£ç çš„æ—¶é—´è¶Šæ¥è¶Šå°‘ï¼Œåè€Œéœ€è¦æ›´å¤šçš„æ—¶é—´æ¥ç®¡ç†è½¯ä»¶å¼€å‘ï¼Œä¾‹å¦‚è·Ÿè¸ª &lt;code&gt;bug&lt;/code&gt; åé¦ˆã€ç®¡ç† &lt;code&gt;sprint&lt;/code&gt;ã€å‘å¸ƒæ–°ç‰ˆæœ¬ç­‰ç­‰ï¼Œè¿™äº›éƒ½éœ€è¦å€ŸåŠ©ç½‘é¡µç«¯æˆ–è€…å…¶å®ƒçš„ä¸åŒå·¥å…·æ¥å®Œæˆã€‚&lt;/p&gt;
&lt;p&gt;äºæ˜¯ï¼Œ&lt;code&gt;Raycast&lt;/code&gt; æ­£æ˜¯ä¸ºäº†è§£å†³ä»–ä»¬çš„å›°æ‰°è€Œåˆ›å»ºï¼Œå°½å¯èƒ½å°†å¸¸ç”¨çš„ç®¡ç†å¼€å‘ã€å†…éƒ¨ä¼šè®®ã€ä»»åŠ¡è§„åˆ’ç­‰å†…å®¹é›†æˆåœ¨ä¸€èµ·ï¼Œè…¾å‡ºæ›´å¤šåœ°æ—¶é—´æ”¾åœ¨ç¼–å†™ä»£ç ä¸Šã€‚ç®€å•è¿‡ä¸€ä¸‹ &lt;code&gt;Raycast&lt;/code&gt; ç›®å‰æ‰€èƒ½å®ç°çš„æ ¸å¿ƒåŠŸèƒ½ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;åœ¨ &lt;code&gt;macOS&lt;/code&gt; ä¸Šå¯åŠ¨ç¨‹åºæˆ–è€…æœç´¢æ–‡ä»¶ï¼Œç›¸å½“äºèšç„¦ï¼›&lt;/li&gt;
&lt;li&gt;åœ¨ &lt;code&gt;GitHub&lt;/code&gt;ã€&lt;code&gt;Jira&lt;/code&gt; ä¸­åˆ›å»ºã€æœç´¢å’Œå…³é—­ &lt;code&gt;issues&lt;/code&gt;ï¼›&lt;/li&gt;
&lt;li&gt;æ‰¹å‡†ã€åˆå¹¶å’Œå…³é—­ &lt;code&gt;GitHub&lt;/code&gt; çš„æ‹‰å–è¯·æ±‚ï¼›&lt;/li&gt;
&lt;li&gt;è°ƒç”¨ &lt;code&gt;Zoom&lt;/code&gt; ç®¡ç†æ—¥å¸¸ä¼šè®®ï¼›&lt;/li&gt;
&lt;li&gt;æ”¯æŒå¿«æ·è®¾ç½®æ—¥ç¨‹ã€å¾…åŠäº‹é¡¹ä»¥åŠå…¶å®ƒè¯¸å¤šç³»ç»Ÿè®¾ç½®ï¼›&lt;/li&gt;
&lt;li&gt;æ”¯æŒè„šæœ¬æ‰©å±•ï¼›&lt;/li&gt;
&lt;li&gt;â€¦â€¦&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img src=&quot;https://img.hi-linux.com/staticfile/raycast-terminal-tool-01-20220428092254655-2022-04-28-iV3UcV.png&quot; alt=&quot;Raycast ä¸‹ä¸€ä»£å¿«æ·å¯åŠ¨å™¨&quot;&gt;&lt;/p&gt;
    
    </summary>
    
    
      <category term="Linux" scheme="https://www.hi-linux.com/categories/Linux/"/>
    
    
      <category term="Linux" scheme="https://www.hi-linux.com/tags/Linux/"/>
    
      <category term="Alfred" scheme="https://www.hi-linux.com/tags/Alfred/"/>
    
      <category term="Raycast" scheme="https://www.hi-linux.com/tags/Raycast/"/>
    
  </entry>
  
  <entry>
    <title>å¦‚ä½•å¿«é€Ÿçš„è‡ªå»º DoH ( DNS over HTTPS) æœåŠ¡</title>
    <link href="https://www.hi-linux.com/posts/34709.html"/>
    <id>https://www.hi-linux.com/posts/34709.html</id>
    <published>2022-04-19T01:00:00.000Z</published>
    <updated>2022-04-19T04:29:49.665Z</updated>
    
    <content type="html"><![CDATA[<div id="vip-container"><h2><span id="1-å‰è¨€">1. å‰è¨€</span></h2><p>DoHï¼ˆDNS over HTTPSï¼‰ï¼Œé¡¾åæ€ä¹‰ï¼Œä½¿ç”¨HTTPSåè®®æ‰§è¡ŒDNSæŸ¥è¯¢ï¼Œé™¤äº†æœ€å¸¸ç”¨çš„UDPå¤–ï¼Œè¿˜æœ‰DoTï¼ˆDNS over TLSï¼‰ï¼ŒDNS over HTTPï¼ˆæœåŠ¡æä¾›å•†è‡ªå®šä¹‰ï¼‰ç­‰æ–¹æ¡ˆï¼Œå¯¹æ¯”å¦‚ä¸‹ï¼š</p><table><thead><tr><th style="text-align:left">åè®®</th><th style="text-align:left">æ ‡å‡†</th><th style="text-align:left">æè¿°</th></tr></thead><tbody><tr><td style="text-align:left">DNS over HTTPS</td><td style="text-align:left"><a href="https://datatracker.ietf.org/doc/html/rfc8484" target="_blank" rel="noopener">RFC8484</a></td><td style="text-align:left">ä½¿ç”¨TLSåŠ å¯†çš„HTTP/2æ‰§è¡ŒDNSæŸ¥è¯¢</td></tr><tr><td style="text-align:left">DNS over TLS</td><td style="text-align:left"><a href="https://datatracker.ietf.org/doc/html/rfc7858" target="_blank" rel="noopener">RFC7858</a></td><td style="text-align:left">ä½¿ç”¨TLSåŠ å¯†çš„TCPæ‰§è¡ŒDNSæŸ¥è¯¢</td></tr><tr><td style="text-align:left">DNS over HTTP</td><td style="text-align:left">æœåŠ¡æä¾›å•†è‡ªå®šä¹‰</td><td style="text-align:left">ä½¿ç”¨è‡ªå®šä¹‰åŠ å¯†çš„HTTP/1.1æ‰§è¡ŒDNSæŸ¥è¯¢</td></tr></tbody></table><p>ç§»åŠ¨ç«¯çš„DNSä¼˜åŒ–å·²ç»æœ‰å¾ˆå¤šå®è·µï¼Œæœ€å¸¸è§çš„æ˜¯DNS over HTTPï¼Œé€šè¿‡åŠ å¯†çš„HTTPè¯·æ±‚è§„é¿è¿è¥å•†å¯¹DNSçš„UDPåŒ…åŠ«æŒï¼Œä»è€Œä¼˜åŒ–Appè®¿é—®æœåŠ¡å™¨çš„å»¶è¿Ÿã€‚ä½†è¿™ä¸ªæ–¹æ¡ˆå¹¶æ²¡æœ‰å½¢æˆç»Ÿä¸€çš„æ ‡å‡†ï¼Œé€šå¸¸éœ€è¦å†…åµŒDNSæœåŠ¡æä¾›å•†çš„SDKï¼Œé€šè¿‡è®¿é—®å›ºå®šçš„BGPæˆ–ä»»æ’­IPè·å–DNSå“åº”ã€‚</p><a id="more"></a><p>å¤§æ¦‚æ˜¯æ„è¯†åˆ°DNSåœ¨ç§»åŠ¨äº’è”ç½‘ä¸­çš„æ‰®æ¼”è¶Šæ¥è¶Šé‡è¦çš„è§’è‰²ï¼Œåœ¨DoTå’ŒDoHçš„è§„èŒƒç›¸ç»§æ¨å‡ºåï¼Œè®¸å¤šDNSæœåŠ¡æä¾›å•†éƒ½è·Ÿè¿›äº†éƒ¨ç½²ï¼Œå›½å†…çš„é˜¿é‡Œäº‘ã€DNSPodï¼Œå›½å¤–çš„è°·æ­Œã€Cloudflareç­‰ç›®å‰å·²ç»æ¨å‡ºäº†å…è´¹çš„DoTå’ŒDoHæœåŠ¡ã€‚</p><p>å®¢æˆ·ç«¯æ–¹é¢ï¼Œå¸¸ç”¨çš„Chromeã€FireFoxå·²ç»æ”¯æŒäº†è‡ªå®šä¹‰DoHæœåŠ¡å™¨ï¼ŒmacOSã€iOSä¹Ÿå¯é€šè¿‡é…ç½®æ–‡ä»¶è®¾ç½®ç³»ç»ŸèŒƒå›´çš„é»˜è®¤DoHæœåŠ¡å™¨ã€‚</p><p>ç¬”è€…ä¹Ÿæ­£å¥½æœ‰ä¸€ä¸ªè‡ªå®šä¹‰DNSçš„éœ€æ±‚ï¼š</p><ol><li>éœ€è¦é’ˆå¯¹ä¸€äº›åŸŸåçš„DNSæŸ¥è¯¢ä»…è¿”å›IPv4è®°å½•</li><li>ä½¿ç”¨çš„æŸæŸè·¯ç”±å™¨ç³»ç»Ÿçš„è‡ªå®šä¹‰DNSæœåŠ¡ä»…æ”¯æŒè®¾ç½®UDPå’ŒDoH</li><li>UDPæ¨¡å¼é»˜è®¤ä½¿ç”¨53ç«¯å£ï¼Œä¸å¯ä¿®æ”¹ï¼ŒUDPåŒ…å®¹æ˜“é­å—å¹²æ‰°</li><li>DoHå¯è‡ªå®šä¹‰åŸŸåã€ç«¯å£ä¸”ä½¿ç”¨HTTP2ä½œä¸ºä¼ è¾“åè®®ï¼Œç¨³å®šæ€§æ›´å¼º</li></ol><p>ç»¼ä¸Šï¼Œåªæœ‰è‡ªå»ºDoHæœåŠ¡äº†ï¼Œäºæ˜¯å°±æœ‰äº†ä¸‹é¢çš„æŠ˜è…¾ï¼Œæœ€åæµ‹è¯•æ—¶å‘ç°è¿™ä¸ªå‚»ç“œè·¯ç”±å™¨ç³»ç»Ÿåªæ”¯æŒä¸€äº›ç‰¹å®šçš„DoHæœåŠ¡å•†å¦‚é˜¿é‡Œäº‘DNSã€DNSPodç­‰ï¼Œä¸æ”¯æŒè‡ªå»ºçš„DoHæœåŠ¡ã€‚</p><h2><span id="2-éƒ¨ç½²æ–¹æ¡ˆ">2. éƒ¨ç½²æ–¹æ¡ˆ</span></h2><p>DoHæœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªHTTPè¯·æ±‚ï¼Œåªæ˜¯ç›®å‰åè®®å®šä¹‰è¦æ±‚å¯ç”¨TLSä¸HTTP/2ã€‚æœ€åˆæ²¡æœ‰è·‘é€šcorednsçš„DoHæ—¶ï¼Œä½¿ç”¨äº†nginxä½œä¸ºå‰ç«¯è½¬å‘DoHè¯·æ±‚åˆ°doh-serverï¼Œç„¶ådoh-serverä½¿ç”¨æœ¬åœ°çš„corednsæœåŠ¡ä½œä¸ºä¸Šæ¸¸ã€‚</p><p>æœ€è¿‘å†ä»”ç»†ç ”ç©¶äº†ä¸‹æ–‡æ¡£ï¼Œå‘ç°corednså·²ç»æ”¯æŒäº†DoHæœåŠ¡ï¼Œå¯ç›´æ¥å¯¹å¤–æš´éœ²æœåŠ¡ï¼Œæˆ–è€…é€šè¿‡nginxè½¬å‘æ¥å¤ç”¨å·²ç»éƒ¨ç½²å¥½çš„webæœåŠ¡ã€‚</p><h3><span id="21-nginx-doh-server-coredns">2.1 nginx + doh-server + coredns</span></h3><p><a href="https://github.com/m13253/dns-over-https" target="_blank" rel="noopener">https://github.com/m13253/dns-over-https</a> æ˜¯ä¸€ä¸ªæä¾› DNS over HTTP çš„æœåŠ¡ï¼Œéœ€è¦ä¸€ä¸ªwebå‰ç«¯å’Œä¸€ä¸ªDNSåç«¯ï¼Œå¯ç”¨çš„dockeré•œåƒåœ°å€ä¸ºï¼š<a href="https://hub.docker.com/r/satishweb/doh-server" target="_blank" rel="noopener">satishweb/doh-server</a>ï¼Œä½¿ç”¨doh-serveræ—¶ï¼ŒDNSè¯·æ±‚æµè½¬å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HTTP Service -&gt; doh-server -&gt; DNS Server</span><br></pre></td></tr></table></figure><p>RFC8484ä¸­æŒ‡å®šä½¿ç”¨/dns-queryè·¯å¾„ä½œä¸ºé»˜è®¤æŸ¥è¯¢è·¯å¾„ï¼Œå› æ­¤åªéœ€è¦å°†è¯¥è·¯å¾„å‰ç¼€çš„è¯·æ±‚è½¬å‘åˆ°doh-serverå³å¯ï¼Œå¦‚ä¸‹ï¼š</p><p><strong>nginxé…ç½®ï¼ˆå·²é…ç½®å¥½TLSä¸HTTP2ï¼‰</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 443 ssl http2 fastopen&#x3D;256 reuseport;</span><br><span class="line">    listen [::]:443 ssl http2 fastopen&#x3D;256 reuseport;</span><br><span class="line">    server_name doh.wbuntu.com</span><br><span class="line">    ...</span><br><span class="line">    location &#x2F;dns-query &#123;</span><br><span class="line">    proxy_redirect off;</span><br><span class="line">    proxy_http_version 1.1;</span><br><span class="line">    proxy_set_header Host $http_host;</span><br><span class="line">    # show real IP</span><br><span class="line">    proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">    proxy_pass http:&#x2F;&#x2F;127.0.0.1:8053;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>doh-server</strong></p><p>ä½¿ç”¨hostNetworkæ¨¡å¼å¯åŠ¨æœåŠ¡ï¼Œç›‘å¬8053ç«¯å£</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --restart unless-stopped --network host --name doh-server \</span><br><span class="line">  -e UPSTREAM_DNS_SERVER&#x3D;&quot;udp:127.0.0.1:53&quot; \</span><br><span class="line">  -e DOH_HTTP_PREFIX&#x3D;&quot;&#x2F;dns-query&quot; \</span><br><span class="line">  -e DOH_SERVER_LISTEN&#x3D;&quot;127.0.0.1:8053&quot; \</span><br><span class="line">  -e DOH_SERVER_TIMEOUT&#x3D;&quot;10&quot; \</span><br><span class="line">  -e DOH_SERVER_TRIES&#x3D;&quot;3&quot; \</span><br><span class="line">  -e DOH_SERVER_VERBOSE&#x3D;&quot;true&quot; \</span><br><span class="line">  satishweb&#x2F;doh-server</span><br></pre></td></tr></table></figure><p><strong>coredns</strong></p><p>corednsé…ç½®æ–‡ä»¶å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">âœ  ~ tree &#x2F;etc&#x2F;coredns&#x2F;</span><br><span class="line">&#x2F;etc&#x2F;coredns&#x2F;</span><br><span class="line">â””â”€â”€ Corefile</span><br><span class="line"></span><br><span class="line">0 directories, 1 files</span><br><span class="line">âœ  cat &#x2F;etc&#x2F;coredns&#x2F;Corefile</span><br><span class="line">.:53 &#123;</span><br><span class="line">    bind 127.0.0.1</span><br><span class="line">    forward . 1.1.1.1 1.0.0.1</span><br><span class="line">    log</span><br><span class="line">    errors</span><br><span class="line">    cache</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨hostNetworkæ¨¡å¼å¯åŠ¨æœåŠ¡ï¼Œç›‘å¬53ç«¯å£</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --restart unless-stopped --network host --name coredns \</span><br><span class="line">  -v &#x2F;etc&#x2F;coredns:&#x2F;etc&#x2F;coredns \</span><br><span class="line">  coredns&#x2F;coredns \</span><br><span class="line">  -conf &#x2F;etc&#x2F;coredns&#x2F;Corefile</span><br></pre></td></tr></table></figure><p>æœåŠ¡å¯åŠ¨åï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°ä¸€ä¸ªè‡ªå®šä¹‰çš„DoHæœåŠ¡ï¼š<a href="https://doh.wbuntu.com/dns-query" target="_blank" rel="noopener">https://doh.wbuntu.com/dns-query</a></p><h3><span id="22-coredns">2.2 coredns</span></h3><p>ç›®å‰corednsæ”¯æŒä½œä¸ºDoHæœåŠ¡ç«¯ï¼Œä¸æ”¯æŒè¿æ¥ä¸Šæ¸¸DoHæœåŠ¡å™¨ï¼Œä¸Šæ¸¸æœåŠ¡å™¨å¯ä½¿ç”¨UDPå’ŒDoTã€‚</p><p>ç›´æ¥å¯¹å¤–æš´éœ²æœåŠ¡éœ€è¦ä½¿ç”¨æœ‰æ•ˆçš„TLSè¯ä¹¦ï¼Œcorednsé…ç½®æ–‡ä»¶åŠè¯ä¹¦ä½ç½®å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">âœ  ~ tree &#x2F;etc&#x2F;coredns&#x2F;</span><br><span class="line">&#x2F;etc&#x2F;coredns&#x2F;</span><br><span class="line">â”œâ”€â”€ Corefile</span><br><span class="line">â”œâ”€â”€ tls.crt</span><br><span class="line">â””â”€â”€ tls.key</span><br><span class="line"></span><br><span class="line">0 directories, 3 files</span><br><span class="line">âœ  cat &#x2F;etc&#x2F;coredns&#x2F;Corefile</span><br><span class="line">https:&#x2F;&#x2F;.:443 &#123;</span><br><span class="line">    tls &#x2F;etc&#x2F;coredns&#x2F;tls.crt &#x2F;etc&#x2F;coredns&#x2F;tls.key</span><br><span class="line">    bind 0.0.0.0</span><br><span class="line">    forward . 1.1.1.1 1.0.0.1</span><br><span class="line">    log</span><br><span class="line">    errors</span><br><span class="line">    cache</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨hostNetworkæ¨¡å¼å¯åŠ¨æœåŠ¡ï¼Œç›‘å¬443ç«¯å£</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --restart unless-stopped --network host --name coredns \</span><br><span class="line">  -v &#x2F;etc&#x2F;coredns:&#x2F;etc&#x2F;coredns \</span><br><span class="line">  coredns&#x2F;coredns \</span><br><span class="line">  -conf &#x2F;etc&#x2F;coredns&#x2F;Corefile</span><br></pre></td></tr></table></figure><p>æœåŠ¡å¯åŠ¨åï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°ä¸€ä¸ªè‡ªå®šä¹‰çš„DoHæœåŠ¡ï¼š<a href="https://doh.wbuntu.com/dns-query" target="_blank" rel="noopener">https://doh.wbuntu.com/dns-query</a></p><h3><span id="23-nginx-coredns">2.3 nginx + coredns</span></h3><p>ç›´æ¥æš´éœ²corednsæœåŠ¡åˆ°å…¬ç½‘éœ€è¦å ç”¨ç«¯å£ï¼Œcorednsåœ¨æœªé…ç½®TLSè¯ä¹¦æ—¶ï¼Œå¯ä½¿ç”¨nginxä½œä¸ºå‰ç«¯æ¥å¤ç”¨webæœåŠ¡ï¼Œå¦‚ä¸‹ï¼š</p><p><strong>nginxé…ç½®ï¼ˆå·²é…ç½®å¥½TLSä¸HTTP2ï¼‰</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 443 ssl http2 fastopen&#x3D;256 reuseport;</span><br><span class="line">    listen [::]:443 ssl http2 fastopen&#x3D;256 reuseport;</span><br><span class="line">    server_name doh.wbuntu.com</span><br><span class="line">    ...</span><br><span class="line">    location &#x2F;dns-query &#123;</span><br><span class="line">    proxy_redirect off;</span><br><span class="line">    proxy_http_version 1.1;</span><br><span class="line">    proxy_set_header Host $http_host;</span><br><span class="line">    # show real IP</span><br><span class="line">    proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">    proxy_pass http:&#x2F;&#x2F;127.0.0.1:8053;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>coredns</strong></p><p>corednsé…ç½®æ–‡ä»¶å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">âœ  ~ tree &#x2F;etc&#x2F;coredns&#x2F;</span><br><span class="line">&#x2F;etc&#x2F;coredns&#x2F;</span><br><span class="line">â””â”€â”€ Corefile</span><br><span class="line"></span><br><span class="line">0 directories, 1 files</span><br><span class="line">âœ  cat &#x2F;etc&#x2F;coredns&#x2F;Corefile</span><br><span class="line">https:&#x2F;&#x2F;.:8053 &#123;</span><br><span class="line">    bind 127.0.0.1</span><br><span class="line">    forward . 1.1.1.1 1.0.0.1</span><br><span class="line">    log</span><br><span class="line">    errors</span><br><span class="line">    cache</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨hostNetworkæ¨¡å¼å¯åŠ¨æœåŠ¡ï¼Œç›‘å¬8053ç«¯å£</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --restart unless-stopped --network host --name coredns \</span><br><span class="line">  -v &#x2F;etc&#x2F;coredns:&#x2F;etc&#x2F;coredns \</span><br><span class="line">  coredns&#x2F;coredns \</span><br><span class="line">  -conf &#x2F;etc&#x2F;coredns&#x2F;Corefile</span><br></pre></td></tr></table></figure><p>æœåŠ¡å¯åŠ¨åï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°ä¸€ä¸ªè‡ªå®šä¹‰çš„DoHæœåŠ¡ï¼š<a href="https://doh.wbuntu.com/dns-query" target="_blank" rel="noopener">https://doh.wbuntu.com/dns-query</a></p><h2><span id="3-æµ‹è¯•">3. æµ‹è¯•</span></h2><p>ä½¿ç”¨è°·æ­Œæµè§ˆå™¨é…ç½®DoHæœåŠ¡ï¼šSettings -&gt; Secutiry and Privacy -&gt; Secutiry -&gt; Advanced -&gt; Use secure DNS</p><p><img src="https://img.hi-linux.com/staticfile/chrome-doh-settings-20220412111328635-2022-04-12-e3XoP6.png" alt></p><p>ä½¿ç”¨Goä»£ç æµ‹è¯•ï¼š<a href="https://github.com/mikumaycry/example/blob/main/2021/doh/main.go" target="_blank" rel="noopener">github.com/mikumaycry/example/blob/main/2021/doh/main.go</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">        &quot;encoding&#x2F;base64&quot;</span><br><span class="line">        &quot;fmt&quot;</span><br><span class="line">        &quot;github.com&#x2F;miekg&#x2F;dns&quot;</span><br><span class="line">        &quot;io&#x2F;ioutil&quot;</span><br><span class="line">        &quot;net&#x2F;http&quot;</span><br><span class="line">        &quot;os&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">       query :&#x3D; dns.Msg&#123;&#125;</span><br><span class="line">       query.SetQuestion(&quot;www.google.com.&quot;, dns.TypeA)</span><br><span class="line">       msg, _ :&#x3D; query.Pack()</span><br><span class="line">       b64 :&#x3D; base64.RawURLEncoding.EncodeToString(msg)</span><br><span class="line">       resp, err :&#x3D; http.Get(&quot;https:&#x2F;&#x2F;doh.wbuntu.com&#x2F;dns-query?dns&#x3D;&quot; + b64)</span><br><span class="line">       if err !&#x3D; nil &#123;</span><br><span class="line">            fmt.Printf(&quot;Send query error, err:%v\n&quot;, err)</span><br><span class="line">            os.Exit(1)</span><br><span class="line">       &#125;</span><br><span class="line">       defer resp.Body.Close()</span><br><span class="line">       bodyBytes, _ :&#x3D; ioutil.ReadAll(resp.Body)</span><br><span class="line">       response :&#x3D; dns.Msg&#123;&#125;</span><br><span class="line">       response.Unpack(bodyBytes)</span><br><span class="line">       fmt.Printf(&quot;Dns answer is :%v\n&quot;, response.String())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>æœ¬æ–‡è½¬è½½è‡ªï¼šã€Œ Wbuntu çš„åšå®¢ ã€ï¼ŒåŸæ–‡ï¼š<a href="https://wbuntu.com/deploy-a-doh-service/" target="_blank" rel="noopener">https://wbuntu.com/deploy-a-doh-service/</a> ï¼Œç‰ˆæƒå½’åŸä½œè€…æ‰€æœ‰ã€‚æ¬¢è¿æŠ•ç¨¿ï¼ŒæŠ•ç¨¿é‚®ç®±: <a href="mailto:editor@hi-linux.com">editor@hi-linux.com</a>ã€‚</p></blockquote></div><script src="https://my.openwrite.cn/js/readmore.js" type="text/javascript"></script><script>var isMobile = navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i);if (!isMobile) {    var btw = new BTWPlugin();    btw.init({        "id": "vip-container",        "blogId": "10135-1588830050631-449",        "name": "ã€Œå¥‡å¦™çš„ Linux ä¸–ç•Œã€",        "qrcode": "https://www.hi-linux.com/img/wechat/mp_qrcode_12.jpg",        "keyword": "VIP"    });}</script>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;1-å‰è¨€&quot;&gt;1. å‰è¨€&lt;/h2&gt;
&lt;p&gt;DoHï¼ˆDNS over HTTPSï¼‰ï¼Œé¡¾åæ€ä¹‰ï¼Œä½¿ç”¨HTTPSåè®®æ‰§è¡ŒDNSæŸ¥è¯¢ï¼Œé™¤äº†æœ€å¸¸ç”¨çš„UDPå¤–ï¼Œè¿˜æœ‰DoTï¼ˆDNS over TLSï¼‰ï¼ŒDNS over HTTPï¼ˆæœåŠ¡æä¾›å•†è‡ªå®šä¹‰ï¼‰ç­‰æ–¹æ¡ˆï¼Œå¯¹æ¯”å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style=&quot;text-align:left&quot;&gt;åè®®&lt;/th&gt;
&lt;th style=&quot;text-align:left&quot;&gt;æ ‡å‡†&lt;/th&gt;
&lt;th style=&quot;text-align:left&quot;&gt;æè¿°&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left&quot;&gt;DNS over HTTPS&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;&lt;a href=&quot;https://datatracker.ietf.org/doc/html/rfc8484&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;RFC8484&lt;/a&gt;&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;ä½¿ç”¨TLSåŠ å¯†çš„HTTP/2æ‰§è¡ŒDNSæŸ¥è¯¢&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left&quot;&gt;DNS over TLS&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;&lt;a href=&quot;https://datatracker.ietf.org/doc/html/rfc7858&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;RFC7858&lt;/a&gt;&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;ä½¿ç”¨TLSåŠ å¯†çš„TCPæ‰§è¡ŒDNSæŸ¥è¯¢&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left&quot;&gt;DNS over HTTP&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;æœåŠ¡æä¾›å•†è‡ªå®šä¹‰&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;ä½¿ç”¨è‡ªå®šä¹‰åŠ å¯†çš„HTTP/1.1æ‰§è¡ŒDNSæŸ¥è¯¢&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;ç§»åŠ¨ç«¯çš„DNSä¼˜åŒ–å·²ç»æœ‰å¾ˆå¤šå®è·µï¼Œæœ€å¸¸è§çš„æ˜¯DNS over HTTPï¼Œé€šè¿‡åŠ å¯†çš„HTTPè¯·æ±‚è§„é¿è¿è¥å•†å¯¹DNSçš„UDPåŒ…åŠ«æŒï¼Œä»è€Œä¼˜åŒ–Appè®¿é—®æœåŠ¡å™¨çš„å»¶è¿Ÿã€‚ä½†è¿™ä¸ªæ–¹æ¡ˆå¹¶æ²¡æœ‰å½¢æˆç»Ÿä¸€çš„æ ‡å‡†ï¼Œé€šå¸¸éœ€è¦å†…åµŒDNSæœåŠ¡æä¾›å•†çš„SDKï¼Œé€šè¿‡è®¿é—®å›ºå®šçš„BGPæˆ–ä»»æ’­IPè·å–DNSå“åº”ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Linux" scheme="https://www.hi-linux.com/categories/Linux/"/>
    
    
      <category term="æŠ€å·§" scheme="https://www.hi-linux.com/tags/%E6%8A%80%E5%B7%A7/"/>
    
      <category term="Linux" scheme="https://www.hi-linux.com/tags/Linux/"/>
    
      <category term="DNS" scheme="https://www.hi-linux.com/tags/DNS/"/>
    
  </entry>
  
  <entry>
    <title>24 ä¸ª å¸¸è§çš„ Docker ç–‘éš¾æ‚ç—‡å¤„ç†æŠ€å·§</title>
    <link href="https://www.hi-linux.com/posts/42601.html"/>
    <id>https://www.hi-linux.com/posts/42601.html</id>
    <published>2022-04-06T01:00:00.000Z</published>
    <updated>2022-04-06T02:24:56.310Z</updated>
    
    <content type="html"><![CDATA[<div id="vip-container"><blockquote><p><strong>è¿™é‡Œä¸»è¦æ˜¯ä¸ºäº†è®°å½•åœ¨ä½¿ç”¨ Docker çš„æ—¶å€™é‡åˆ°çš„é—®é¢˜åŠå…¶å¤„ç†è§£å†³æ–¹æ³•ã€‚</strong></p></blockquote><h2><span id="docker-è¿ç§»å­˜å‚¨ç›®å½•">Docker è¿ç§»å­˜å‚¨ç›®å½•</span></h2><blockquote><p><strong>é»˜è®¤æƒ…å†µç³»ç»Ÿä¼šå°† Docker å®¹å™¨å­˜æ”¾åœ¨ /var/lib/docker ç›®å½•ä¸‹</strong></p></blockquote><ul><li><strong>[é—®é¢˜èµ·å› ]</strong> ä»Šå¤©é€šè¿‡ç›‘æ§ç³»ç»Ÿï¼Œå‘ç°å…¬å¸å…¶ä¸­ä¸€å°æœåŠ¡å™¨çš„ç£ç›˜å¿«æ…¢ï¼Œéšå³ä¸Šå»çœ‹äº†ä¸‹ï¼Œå‘ç° <code>/var/lib/docker</code> è¿™ä¸ªç›®å½•ç‰¹åˆ«å¤§ã€‚ç”±ä¸Šè¿°åŸå› ï¼Œæˆ‘ä»¬éƒ½çŸ¥é“ï¼Œåœ¨ <code>/var/lib/docker</code> ä¸­å­˜å‚¨çš„éƒ½æ˜¯ç›¸å…³äºå®¹å™¨çš„å­˜å‚¨ï¼Œæ‰€ä»¥ä¹Ÿä¸èƒ½éšä¾¿çš„å°†å…¶åˆ é™¤æ‰ã€‚</li><li>é‚£å°±å‡†å¤‡è¿ç§» <code>docker</code> çš„å­˜å‚¨ç›®å½•å§ï¼Œæˆ–è€…å¯¹ <code>/var</code> è®¾å¤‡è¿›è¡Œæ‰©å®¹æ¥è¾¾åˆ°ç›¸åŒçš„ç›®çš„ã€‚æ›´å¤šå…³äº <code>dockerd</code> çš„è¯¦ç»†å‚æ•°ï¼Œè¯·ç‚¹å‡»æŸ¥çœ‹ <a href="https://docs.docker.com/engine/reference/commandline/dockerd/" target="_blank" rel="noopener"><strong>å®˜æ–¹æ–‡æ¡£</strong></a> åœ°å€ã€‚</li><li>ä½†æ˜¯éœ€è¦æ³¨æ„çš„ä¸€ç‚¹å°±æ˜¯ï¼Œå°½é‡ä¸è¦ç”¨è½¯é“¾ï¼Œ å› ä¸ºä¸€äº› <code>docker</code> å®¹å™¨ç¼–æ’ç³»ç»Ÿä¸æ”¯æŒè¿™æ ·åšï¼Œæ¯”å¦‚æˆ‘ä»¬æ‰€ç†ŸçŸ¥çš„ <code>k8s</code> å°±åœ¨å†…ã€‚</li></ul><a id="more"></a><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å‘ç°å®¹å™¨å¯åŠ¨ä¸äº†äº†</span></span><br><span class="line">ERRORï¼šcannot  create temporary directory!</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹ç³»ç»Ÿå­˜å‚¨æƒ…å†µ</span></span><br><span class="line">$ du -h --max-depth=1</span><br></pre></td></tr></table></figure><ul><li><strong>[è§£å†³æ–¹æ³• 1] æ·»åŠ è½¯é“¾æ¥</strong></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.åœæ­¢dockeræœåŠ¡</span></span><br><span class="line">$ sudo systemctl stop docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.å¼€å§‹è¿ç§»ç›®å½•</span></span><br><span class="line">$ sudo mv /var/lib/docker /data/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.æ·»åŠ è½¯é“¾æ¥</span></span><br><span class="line">$ sudo ln -s /data/docker /var/lib/docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.å¯åŠ¨dockeræœåŠ¡</span></span><br><span class="line">$ sudo systemctl start docker</span><br></pre></td></tr></table></figure><ul><li><strong>[è§£å†³æ–¹æ³• 2] æ”¹åŠ¨ docker é…ç½®æ–‡ä»¶</strong></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># [æ–¹å¼ä¸€] æ”¹åŠ¨dockerå¯åŠ¨é…ç½®æ–‡ä»¶</span></span><br><span class="line">$ sudo vim /lib/systemd/system/docker.service</span><br><span class="line">ExecStart=/usr/bin/dockerd --graph=/data/docker/</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># [æ–¹å¼äºŒ] æ”¹åŠ¨dockerå¯åŠ¨é…ç½®æ–‡ä»¶</span></span><br><span class="line">$ sudo vim /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"live-restore"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">"graph"</span>: [ <span class="string">"/data/docker/"</span> ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>[æ“ä½œæ³¨æ„äº‹é¡¹]</strong> åœ¨è¿ç§» <code>docker</code> ç›®å½•çš„æ—¶å€™æ³¨æ„ä½¿ç”¨çš„å‘½ä»¤ï¼Œè¦ä¹ˆä½¿ç”¨ <code>mv</code> å‘½ä»¤ç›´æ¥ç§»åŠ¨ï¼Œè¦ä¹ˆä½¿ç”¨ <code>cp</code> å‘½ä»¤å¤åˆ¶æ–‡ä»¶ï¼Œä½†æ˜¯éœ€è¦æ³¨æ„åŒæ—¶å¤åˆ¶æ–‡ä»¶æƒé™å’Œå¯¹åº”å±æ€§ï¼Œä¸ç„¶åœ¨ä½¿ç”¨çš„æ—¶å€™å¯èƒ½ä¼šå­˜åœ¨æƒé™é—®é¢˜ã€‚å¦‚æœå®¹å™¨ä¸­ï¼Œä¹Ÿæ˜¯ä½¿ç”¨ <code>root</code> ç”¨æˆ·ï¼Œåˆ™ä¸ä¼šå­˜åœ¨è¯¥é—®é¢˜ï¼Œä½†æ˜¯ä¹Ÿæ˜¯éœ€è¦æŒ‰ç…§æ­£ç¡®çš„æ“ä½œæ¥è¿ç§»ç›®å½•ã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨mvå‘½ä»¤</span></span><br><span class="line">$ sudo mv /var/lib/docker /data/docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨cpå‘½ä»¤</span></span><br><span class="line">$ sudo cp -arv /data/docker /data2/docker</span><br></pre></td></tr></table></figure><ul><li>ä¸‹å›¾ä¸­ï¼Œå°±æ˜¯å› ä¸ºå¯åŠ¨çš„å®¹å™¨ä½¿ç”¨çš„æ˜¯æ™®é€šç”¨æˆ·è¿è¡Œè¿›ç¨‹çš„ï¼Œä¸”åœ¨è¿è¡Œå½“ä¸­éœ€è¦ä½¿ç”¨ <code>/tmp</code> ç›®å½•ï¼Œç»“æœæç¤ºæ²¡æœ‰æƒé™ã€‚åœ¨æˆ‘ä»¬å¯¼å…¥å®¹å™¨é•œåƒçš„æ—¶å€™ï¼Œå…¶å®æ˜¯ä¼šå°†å®¹å™¨å¯åŠ¨æ—¶éœ€è¦çš„å„ä¸ªç›®å½•çš„æƒé™å’Œå±æ€§éƒ½èµ‹äºˆäº†ã€‚å¦‚æœæˆ‘ä»¬ç›´æ¥æ˜¯ <code>cp</code> å‘½ä»¤å•çº¯å¤åˆ¶æ–‡ä»¶å†…å®¹çš„è¯ï¼Œå°±ä¼šå‡ºç°å±æ€§ä¸ä¸€è‡´çš„æƒ…å†µï¼ŒåŒæ—¶è¿˜ä¼šæœ‰ä¸€å®šçš„å®‰å…¨é—®é¢˜ã€‚</li></ul><p><img src="https://img.hi-linux.com/staticfile/docker-have-some-trouble-3-20220329161818563-2022-03-29-j0jRk4.png" alt="Dockerè¿ç§»å­˜å‚¨ç›®å½•"></p><h2><span id="docker-è®¾å¤‡ç©ºé—´ä¸è¶³">Docker è®¾å¤‡ç©ºé—´ä¸è¶³</span></h2><blockquote><p><a href="https://stackoverflow.com/questions/50140939/increase-docker-container-size-from-default-10gb-on-rhel7/52971594#52971594" target="_blank" rel="noopener"><strong>Increase Docker container size from default 10GB on rhel7.</strong></a></p></blockquote><ul><li><strong>[é—®é¢˜èµ·å› ä¸€]</strong> å®¹å™¨åœ¨å¯¼å…¥æˆ–è€…å¯åŠ¨çš„æ—¶å€™ï¼Œå¦‚æœæç¤ºç£ç›˜ç©ºé—´ä¸è¶³çš„ï¼Œé‚£ä¹ˆå¤šåŠæ˜¯çœŸçš„å› ä¸ºç‰©ç†ç£ç›˜ç©ºé—´çœŸçš„æœ‰é—®é¢˜å¯¼è‡´çš„ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° <code>/</code> åˆ†åŒºç¡®å®æ»¡äº†ã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹ç‰©ç†ç£ç›˜ç©ºé—´</span></span><br><span class="line">$ df -Th</span><br><span class="line">Filesystem    Size    Used    Avail    Use%    Mounted on</span><br><span class="line">/dev/vda1      40G     40G       0G    100%    /</span><br><span class="line">tmpfs         7.8G       0     7.8G      0%    /dev/shm</span><br><span class="line">/dev/vdb1     493G    289G     179G     62%    /mnt</span><br></pre></td></tr></table></figure><ul><li>å¦‚æœå‘ç°çœŸçš„æ˜¯ç‰©ç†ç£ç›˜ç©ºé—´æ»¡äº†çš„è¯ï¼Œå°±éœ€è¦æŸ¥çœ‹åˆ°åº•æ˜¯ä»€ä¹ˆå æ®äº†å¦‚æ­¤å¤§çš„ç©ºé—´ï¼Œå¯¼è‡´å› ä¸ºå®¹å™¨æ²¡æœ‰ç©ºé—´æ— æ³•å¯åŠ¨ã€‚å…¶ä¸­ï¼Œ<code>docker</code> è‡ªå¸¦çš„å‘½ä»¤å°±æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„èƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬å‘ç°é—®é¢˜çš„å·¥å…·ã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹åŸºæœ¬ä¿¡æ¯</span></span><br><span class="line"><span class="comment"># ç¡¬ä»¶é©±åŠ¨ä½¿ç”¨çš„æ˜¯devicemapperï¼Œç©ºé—´æ± ä¸ºdocker-252</span></span><br><span class="line"><span class="comment"># ç£ç›˜å¯ç”¨å®¹é‡ä»…å‰©16.78MBï¼Œå¯ç”¨ä¾›æˆ‘ä»¬ä½¿ç”¨</span></span><br><span class="line">$ docker info</span><br><span class="line">Containers: 1</span><br><span class="line">Images: 28</span><br><span class="line">Storage Driver: devicemapper</span><br><span class="line"> Pool Name: docker-252:1-787932-pool</span><br><span class="line"> Pool Blocksize: 65.54 kB</span><br><span class="line"> Backing Filesystem: extfs</span><br><span class="line"> Data file: /dev/loop0</span><br><span class="line"> Metadata file: /dev/loop1</span><br><span class="line"> Data Space Used: 1.225 GB</span><br><span class="line"> Data Space Total: 107.4 GB</span><br><span class="line"> Data Space Available: 16.78 MB</span><br><span class="line"> Metadata Space Used: 2.073 MB</span><br><span class="line"> Metadata Space Total: 2.147 GB</span><br></pre></td></tr></table></figure><ul><li><strong>[è§£å†³æ–¹æ³•]</strong> é€šè¿‡æŸ¥çœ‹ä¿¡æ¯ï¼Œæˆ‘ä»¬çŸ¥é“æ­£æ˜¯å› ä¸º <code>docker</code> å¯ç”¨çš„ç£ç›˜ç©ºé—´ä¸è¶³ï¼Œæ‰€ä»¥å¯¼è‡´å¯åŠ¨çš„æ—¶å€™æ²¡æœ‰è¶³å¤Ÿçš„ç©ºé—´è¿›è¡ŒåŠ è½½å¯åŠ¨é•œåƒã€‚è§£å†³çš„æ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼Œç¬¬ä¸€å°±æ˜¯æ¸…ç†æ— æ•ˆæ•°æ®æ–‡ä»¶é‡Šæ”¾ç£ç›˜ç©ºé—´(<strong>æ¸…é™¤æ—¥å¿—</strong>)ï¼Œç¬¬äºŒå°±æ˜¯ä¿®æ”¹ <code>docker</code> æ•°æ®çš„å­˜æ”¾è·¯å¾„(<strong>å¤§åˆ†åŒº</strong>)ã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ˜¾ç¤ºå“ªäº›å®¹å™¨ç›®å½•å…·æœ‰æœ€å¤§çš„æ—¥å¿—æ–‡ä»¶</span></span><br><span class="line">$ du -d1 -h /var/lib/docker/containers | sort -h</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¸…é™¤æ‚¨é€‰æ‹©çš„å®¹å™¨æ—¥å¿—æ–‡ä»¶çš„å†…å®¹</span></span><br><span class="line">$ cat /dev/null &gt; /var/lib/docker/containers/container_id/container_log_name</span><br></pre></td></tr></table></figure><ul><li><strong>[é—®é¢˜èµ·å› äºŒ]</strong> æ˜¾ç„¶æˆ‘é‡åˆ°çš„ä¸æ˜¯ä¸Šä¸€ç§æƒ…å†µï¼Œè€Œæ˜¯åœ¨å¯åŠ¨å®¹å™¨çš„æ—¶å€™ï¼Œå®¹å™¨å¯åŠ¨ä¹‹åä¸ä¹…å°±æ˜¾ç¤ºæ˜¯ <code>unhealthy</code> çš„çŠ¶æ€ï¼Œé€šè¿‡å¦‚ä¸‹æ—¥å¿—å‘ç°ï¼ŒåŸæ¥æ˜¯å¤åˆ¶é…ç½®æ–‡ä»¶å¯åŠ¨çš„æ—¶å€™ï¼Œæç¤ºç£ç›˜ç©ºé—´ä¸è¶³ã€‚</li><li>åé¢å‘ç°æ˜¯å› ä¸º <code>CentOS7</code> çš„ç³»ç»Ÿä½¿ç”¨çš„ <code>docker</code> å®¹å™¨é»˜è®¤çš„åˆ›å»ºå¤§å°å°±æ˜¯ <code>10G</code> è€Œå·²ï¼Œç„¶è€Œæˆ‘ä»¬ä½¿ç”¨çš„å®¹å™¨å´è¶…è¿‡äº†è¿™ä¸ªé™åˆ¶ï¼Œå¯¼è‡´æ— æ³•å¯åŠ¨æ—¶æç¤ºç©ºé—´ä¸è¶³ã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">2019-08-16 11:11:15,816 INFO spawned: <span class="string">'app-demo'</span> with pid 835</span><br><span class="line">2019-08-16 11:11:16,268 INFO exited: app (<span class="built_in">exit</span> status 1; not expected)</span><br><span class="line">2019-08-16 11:11:17,270 INFO gave up: app entered FATAL state, too many start retries too quickly</span><br><span class="line">cp: cannot create regular file <span class="string">'/etc/supervisor/conf.d/grpc-app-demo.conf'</span>: No space left on device</span><br><span class="line">cp: cannot create regular file <span class="string">'/etc/supervisor/conf.d/grpc-app-demo.conf'</span>: No space left on device</span><br><span class="line">cp: cannot create regular file <span class="string">'/etc/supervisor/conf.d/grpc-app-demo.conf'</span>: No space left on device</span><br><span class="line">cp: cannot create regular file <span class="string">'/etc/supervisor/conf.d/grpc-app-demo.conf'</span>: No space left on device</span><br></pre></td></tr></table></figure><ul><li><strong>[è§£å†³æ–¹æ³• 1] æ”¹åŠ¨ docker å¯åŠ¨é…ç½®æ–‡ä»¶</strong></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /etc/docker/daemon.json</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"live-restore"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">"storage-opt"</span>: [ <span class="string">"dm.basesize=20G"</span> ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>[è§£å†³æ–¹æ³• 2] æ”¹åŠ¨ systemctl çš„ docker å¯åŠ¨æ–‡ä»¶</strong></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.stop the docker service</span></span><br><span class="line">$ sudo systemctl stop docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.rm exised container</span></span><br><span class="line">$ sudo rm -rf /var/lib/docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.edit your docker service file</span></span><br><span class="line">$ sudo vim /usr/lib/systemd/system/docker.service</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.find the execution line</span></span><br><span class="line">ExecStart=/usr/bin/dockerd</span><br><span class="line">and change it to:</span><br><span class="line">ExecStart=/usr/bin/dockerd --storage-opt dm.basesize=20G</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.start docker service again</span></span><br><span class="line">$ sudo systemctl start docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5.reload daemon</span></span><br><span class="line">$ sudo systemctl daemon-reload</span><br></pre></td></tr></table></figure><ul><li><strong>[é—®é¢˜èµ·å› ä¸‰]</strong> è¿˜æœ‰ä¸€ç§æƒ…å†µä¹Ÿä¼šè®©å®¹å™¨æ— æ³•å¯åŠ¨ï¼Œå¹¶æç¤ºç£ç›˜ç©ºé—´ä¸è¶³ï¼Œä½†æ˜¯ä½¿ç”¨å‘½ä»¤æŸ¥çœ‹å‘ç°å¹¶ä¸æ˜¯å› ä¸ºç‰©ç†ç£ç›˜çœŸçš„ä¸è¶³å¯¼è‡´çš„ã€‚è€Œæ˜¯ï¼Œå› ä¸ºå¯¹äºåˆ†åŒºçš„ <code>inode</code> èŠ‚ç‚¹æ•°æ»¡äº†å¯¼è‡´çš„ã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŠ¥é”™ä¿¡æ¯</span></span><br><span class="line">No space left on device</span><br></pre></td></tr></table></figure><ul><li><strong>[è§£å†³æ–¹æ³•]</strong> å› ä¸º <code>ext3</code> æ–‡ä»¶ç³»ç»Ÿä½¿ç”¨ <code>inode table</code> å­˜å‚¨ <code>inode</code> ä¿¡æ¯ï¼Œè€Œ <code>xfs</code> æ–‡ä»¶ç³»ç»Ÿä½¿ç”¨ <code>B+ tree</code> æ¥è¿›è¡Œå­˜å‚¨ã€‚è€ƒè™‘åˆ°æ€§èƒ½é—®é¢˜ï¼Œé»˜è®¤æƒ…å†µä¸‹è¿™ä¸ª <code>B+ tree</code> åªä¼šä½¿ç”¨å‰ <code>1TB</code> ç©ºé—´ï¼Œå½“è¿™ <code>1TB</code> ç©ºé—´è¢«å†™æ»¡åï¼Œå°±ä¼šå¯¼è‡´æ— æ³•å†™å…¥ <code>inode</code> ä¿¡æ¯ï¼ŒæŠ¥ç£ç›˜ç©ºé—´ä¸è¶³çš„é”™è¯¯ã€‚æˆ‘ä»¬å¯ä»¥åœ¨ <code>mount</code> æ—¶ï¼ŒæŒ‡å®š <code>inode64</code> å³å¯å°†è¿™ä¸ª <code>B+ tree</code> ä½¿ç”¨çš„ç©ºé—´æ‰©å±•åˆ°æ•´ä¸ªæ–‡ä»¶ç³»ç»Ÿã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹ç³»ç»Ÿçš„inodeèŠ‚ç‚¹ä½¿ç”¨æƒ…å†µ</span></span><br><span class="line">$ sudo df -i</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°è¯•é‡æ–°æŒ‚è½½</span></span><br><span class="line">$ sudo mount -o remount -o noatime,nodiratime,inode64,nobarrier /dev/vda1</span><br></pre></td></tr></table></figure><ul><li><strong>[è¡¥å……çŸ¥è¯†]</strong> æ–‡ä»¶å‚¨å­˜åœ¨ç¡¬ç›˜ä¸Šï¼Œç¡¬ç›˜çš„æœ€å°å­˜å‚¨å•ä½å«åš <strong>æ‰‡åŒº</strong>(<code>Sector</code>)ã€‚æ¯ä¸ªæ‰‡åŒºå‚¨å­˜ <code>512</code> å­—èŠ‚(ç›¸å½“äº<code>0.5KB</code>)ã€‚æ“ä½œç³»ç»Ÿè¯»å–ç¡¬ç›˜çš„æ—¶å€™ï¼Œä¸ä¼šä¸€ä¸ªä¸ªæ‰‡åŒºåœ°è¯»å–ï¼Œè¿™æ ·æ•ˆç‡å¤ªä½ï¼Œè€Œæ˜¯ä¸€æ¬¡æ€§è¿ç»­è¯»å–å¤šä¸ªæ‰‡åŒºï¼Œå³ä¸€æ¬¡æ€§è¯»å–ä¸€ä¸ª<strong>å—</strong>(<code>block</code>)ã€‚è¿™ç§ç”±å¤šä¸ªæ‰‡åŒºç»„æˆçš„<strong>å—</strong>ï¼Œæ˜¯æ–‡ä»¶å­˜å–çš„æœ€å°å•ä½ã€‚<strong>å—</strong>çš„å¤§å°ï¼Œæœ€å¸¸è§çš„æ˜¯<code>4KB</code>ï¼Œå³è¿ç»­å…«ä¸ª <code>sector</code> ç»„æˆä¸€ä¸ª <code>block</code> å—ã€‚æ–‡ä»¶æ•°æ®éƒ½å‚¨å­˜åœ¨<strong>å—</strong>ä¸­ï¼Œé‚£ä¹ˆå¾ˆæ˜¾ç„¶ï¼Œæˆ‘ä»¬è¿˜å¿…é¡»æ‰¾åˆ°ä¸€ä¸ªåœ°æ–¹å‚¨å­˜æ–‡ä»¶çš„å…ƒä¿¡æ¯ï¼Œæ¯”å¦‚æ–‡ä»¶çš„åˆ›å»ºè€…ã€æ–‡ä»¶çš„åˆ›å»ºæ—¥æœŸã€æ–‡ä»¶çš„å¤§å°ç­‰ç­‰ã€‚è¿™ç§å‚¨å­˜æ–‡ä»¶å…ƒä¿¡æ¯çš„åŒºåŸŸå°±å«åš<strong>ç´¢å¼•èŠ‚ç‚¹</strong>(<code>inode</code>)ã€‚æ¯ä¸€ä¸ªæ–‡ä»¶éƒ½æœ‰å¯¹åº”çš„ <code>inode</code>ï¼Œé‡Œé¢åŒ…å«äº†é™¤äº†æ–‡ä»¶åä»¥å¤–çš„æ‰€æœ‰æ–‡ä»¶ä¿¡æ¯ã€‚</li><li><code>inode</code> ä¹Ÿä¼šæ¶ˆè€—ç¡¬ç›˜ç©ºé—´ï¼Œæ‰€ä»¥ç¡¬ç›˜æ ¼å¼åŒ–çš„æ—¶å€™ï¼Œæ“ä½œç³»ç»Ÿè‡ªåŠ¨å°†ç¡¬ç›˜åˆ†æˆä¸¤ä¸ªåŒºåŸŸã€‚ä¸€ä¸ªæ˜¯æ•°æ®åŒºï¼Œå­˜æ”¾æ–‡ä»¶æ•°æ®ï¼›å¦ä¸€ä¸ªæ˜¯ <code>inode</code> åŒº(<code>inode table</code>)ï¼Œå­˜æ”¾ <code>inode</code> æ‰€åŒ…å«çš„ä¿¡æ¯ã€‚æ¯ä¸ª <code>inode</code> èŠ‚ç‚¹çš„å¤§å°ï¼Œä¸€èˆ¬æ˜¯ <code>128</code> å­—èŠ‚æˆ– <code>256</code> å­—èŠ‚ã€‚<code>inode</code> èŠ‚ç‚¹çš„æ€»æ•°ï¼Œåœ¨æ ¼å¼åŒ–æ—¶å°±ç»™å®šï¼Œä¸€èˆ¬æ˜¯æ¯<code>1KB</code>æˆ–æ¯<code>2KB</code>å°±è®¾ç½®ä¸€ä¸ª <code>inode</code> èŠ‚ç‚¹ã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ¯ä¸ªèŠ‚ç‚¹ä¿¡æ¯çš„å†…å®¹</span></span><br><span class="line">$ <span class="built_in">stat</span> check_port_live.sh</span><br><span class="line">  File: check_port_live.sh</span><br><span class="line">  Size: 225           Blocks: 8          IO Block: 4096   regular file</span><br><span class="line">Device: 822h/2082d    Inode: 99621663    Links: 1</span><br><span class="line">Access: (0755/-rwxr-xr-x)  Uid: ( 1006/  escape)   Gid: ( 1006/  escape)</span><br><span class="line">Access: 2019-07-29 14:59:59.498076903 +0800</span><br><span class="line">Modify: 2019-07-29 14:59:59.498076903 +0800</span><br><span class="line">Change: 2019-07-29 23:20:27.834866649 +0800</span><br><span class="line"> Birth: -</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç£ç›˜çš„inodeä½¿ç”¨æƒ…å†µ</span></span><br><span class="line">$ df -i</span><br><span class="line">Filesystem                 Inodes   IUsed     IFree IUse% Mounted on</span><br><span class="line">udev                     16478355     801  16477554    1% /dev</span><br><span class="line">tmpfs                    16487639    2521  16485118    1% /run</span><br><span class="line">/dev/sdc2               244162560 4788436 239374124    2% /</span><br><span class="line">tmpfs                    16487639       5  16487634    1% /dev/shm</span><br></pre></td></tr></table></figure><h2><span id="docker-ç¼ºå…±äº«é“¾æ¥åº“">Docker ç¼ºå…±äº«é“¾æ¥åº“</span></h2><blockquote><p><strong>Docker å‘½ä»¤éœ€è¦å¯¹/tmp ç›®å½•ä¸‹é¢æœ‰è®¿é—®æƒé™</strong></p></blockquote><ul><li><strong>[é—®é¢˜èµ·å› ]</strong> ç»™ç³»ç»Ÿå®‰è£…å®Œ <code>compose</code> ä¹‹åï¼ŒæŸ¥çœ‹ç‰ˆæœ¬çš„æ—¶å€™ï¼Œæç¤ºç¼ºå°‘ä¸€ä¸ªåä¸º <code>libz.so.1</code> çš„å…±äº«é“¾æ¥åº“ã€‚ç¬¬ä¸€ååº”å°±æ˜¯ï¼Œæ˜¯ä¸æ˜¯ç³»ç»Ÿå°‘å®‰è£…é‚£ä¸ªè½¯ä»¶åŒ…å¯¼è‡´çš„ã€‚éšå³ï¼Œæœç´¢äº†ä¸€ä¸‹ï¼Œå°†ç›¸å…³çš„ä¾èµ–åŒ…éƒ½ç»™å®‰è£…äº†ï¼Œå´è¿˜æ˜¯æç¤ºåŒæ ·çš„é—®é¢˜ã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æç¤ºé”™è¯¯ä¿¡æ¯</span></span><br><span class="line">$ docker-compose --version</span><br><span class="line">error <span class="keyword">while</span> loading shared libraries: libz.so.1: failed to map segment from shared object: Operation not permitted</span><br></pre></td></tr></table></figure><ul><li><strong>[è§£å†³æ–¹æ³•]</strong> åæ¥å‘ç°ï¼Œæ˜¯å› ä¸ºç³»ç»Ÿä¸­ <code>docker</code> æ²¡æœ‰å¯¹ <code>/tmp</code> ç›®å½•çš„è®¿é—®æƒé™å¯¼è‡´ï¼Œéœ€è¦é‡æ–°å°†å…¶æŒ‚è½½ä¸€æ¬¡ï¼Œå°±å¯ä»¥è§£å†³äº†ã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># é‡æ–°æŒ‚è½½</span></span><br><span class="line">$ sudo mount /tmp -o remount,<span class="built_in">exec</span></span><br></pre></td></tr></table></figure><h2><span id="docker-å®¹å™¨æ–‡ä»¶æŸå">Docker å®¹å™¨æ–‡ä»¶æŸå</span></h2><blockquote><p><strong>å¯¹ dockerd çš„é…ç½®æœ‰å¯èƒ½ä¼šå½±å“åˆ°ç³»ç»Ÿç¨³å®š</strong></p></blockquote><ul><li><strong>[é—®é¢˜èµ·å› ]</strong> å®¹å™¨æ–‡ä»¶æŸåï¼Œç»å¸¸ä¼šå¯¼è‡´å®¹å™¨æ— æ³•æ“ä½œã€‚æ­£å¸¸çš„ <code>docker</code> å‘½ä»¤å·²ç»æ— æ³•æ“æ§è¿™å°å®¹å™¨äº†ï¼Œæ— æ³•å…³é—­ã€é‡å¯ã€åˆ é™¤ã€‚æ­£å·§ï¼Œå‰å¤©å°±éœ€è¦è¿™ä¸ªçš„é—®é¢˜ï¼Œä¸»è¦çš„åŸå› æ˜¯å› ä¸ºé‡æ–°å¯¹ <code>docker</code> çš„é»˜è®¤å®¹å™¨è¿›è¡Œäº†é‡æ–°çš„åˆ†é…é™åˆ¶å¯¼è‡´çš„ã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ“ä½œå®¹å™¨é‡åˆ°ç±»ä¼¼çš„é”™è¯¯</span></span><br><span class="line">b<span class="string">'devicemapper: Error running deviceCreate (CreateSnapDeviceRaw) dm_task_run failed'</span></span><br></pre></td></tr></table></figure><ul><li><strong>[è§£å†³æ–¹æ³•]</strong> å¯ä»¥é€šè¿‡ä»¥ä¸‹æ“ä½œå°†å®¹å™¨åˆ é™¤/é‡å»ºã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.å…³é—­docker</span></span><br><span class="line">$ sudo systemctl stop docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.åˆ é™¤å®¹å™¨æ–‡ä»¶</span></span><br><span class="line">$ sudo rm -rf /var/lib/docker/containers</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.é‡æ–°æ•´ç†å®¹å™¨å…ƒæ•°æ®</span></span><br><span class="line">$ sudo thin_check /var/lib/docker/devicemapper/devicemapper/metadata</span><br><span class="line">$ sudo thin_check --clear-needs-check-flag /var/lib/docker/devicemapper/devicemapper/metadata</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.é‡å¯docker</span></span><br><span class="line">$ sudo systemctl start docker</span><br></pre></td></tr></table></figure><h2><span id="docker-å®¹å™¨ä¼˜é›…é‡å¯">Docker å®¹å™¨ä¼˜é›…é‡å¯</span></h2><blockquote><p><strong>ä¸åœæ­¢æœåŠ¡å™¨ä¸Šé¢è¿è¡Œçš„å®¹å™¨ï¼Œé‡å¯ dockerd æœåŠ¡æ˜¯å¤šä¹ˆå¥½çš„ä¸€ä»¶äº‹</strong></p></blockquote><ul><li><strong>[é—®é¢˜èµ·å› ]</strong> é»˜è®¤æƒ…å†µä¸‹ï¼Œå½“ <code>Docker</code> å®ˆæŠ¤ç¨‹åºç»ˆæ­¢æ—¶ï¼Œå®ƒä¼šå…³é—­æ­£åœ¨è¿è¡Œçš„å®¹å™¨ã€‚ä» <code>Docker-ce 1.12</code> å¼€å§‹ï¼Œå¯ä»¥åœ¨é…ç½®æ–‡ä»¶ä¸­æ·»åŠ  <code>live-restore</code> å‚æ•°ï¼Œä»¥ä¾¿åœ¨å®ˆæŠ¤ç¨‹åºå˜å¾—ä¸å¯ç”¨æ—¶å®¹å™¨ä¿æŒè¿è¡Œã€‚éœ€è¦æ³¨æ„çš„æ˜¯ <code>Windows</code> å¹³å°æš‚æ—¶è¿˜æ˜¯ä¸æ”¯æŒè¯¥å‚æ•°çš„é…ç½®ã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Keep containers alive during daemon downtime</span></span><br><span class="line">$ sudo vim /etc/docker/daemon.yaml</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"live-restore"</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨å®ˆæŠ¤è¿›ç¨‹åœæœºæœŸé—´ä¿æŒå®¹å™¨å­˜æ´»</span></span><br><span class="line">$ sudo dockerd --live-restore</span><br><span class="line"></span><br><span class="line"><span class="comment"># åªèƒ½ä½¿ç”¨reloadé‡è½½</span></span><br><span class="line"><span class="comment"># ç›¸å½“äºå‘é€SIGHUPä¿¡å·é‡ç»™dockerdå®ˆæŠ¤è¿›ç¨‹</span></span><br><span class="line">$ sudo systemctl reload docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½†æ˜¯å¯¹åº”ç½‘ç»œçš„è®¾ç½®éœ€è¦restartæ‰èƒ½ç”Ÿæ•ˆ</span></span><br><span class="line">$ sudo systemctl restart docker</span><br></pre></td></tr></table></figure><ul><li><strong>[è§£å†³æ–¹æ³•]</strong> å¯ä»¥é€šè¿‡ä»¥ä¸‹æ“ä½œå°†å®¹å™¨åˆ é™¤/é‡å»ºã€‚</li></ul><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># /etc/docker/daemon.yaml</span><br><span class="line">&#123;</span><br><span class="line">    "registry-mirrors": ["https://vec0xydj.mirror.aliyuncs.com"],  # é…ç½®è·å–å®˜æ–¹é•œåƒçš„ä»“åº“åœ°å€</span><br><span class="line">    "experimental": true,  # å¯ç”¨å®éªŒåŠŸèƒ½</span><br><span class="line">    "default-runtime": "nvidia",  # å®¹å™¨çš„é»˜è®¤OCIè¿è¡Œæ—¶(é»˜è®¤ä¸ºrunc)</span><br><span class="line">    "live-restore": true,  # é‡å¯dockerdæœåŠ¡çš„æ—¶å€™å®¹æ˜“ä¸ç»ˆæ­¢</span><br><span class="line">    "runtimes": &#123;  # é…ç½®å®¹å™¨è¿è¡Œæ—¶</span><br><span class="line">        "nvidia": &#123;</span><br><span class="line">            "path": "/usr/bin/nvidia-container-runtime",</span><br><span class="line">            "runtimeArgs": []</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    "default-address-pools": [  # é…ç½®å®¹å™¨ä½¿ç”¨çš„å­ç½‘åœ°å€æ± </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"scope"</span>: <span class="string">"local"</span>,</span><br><span class="line">            <span class="attr">"base"</span>:<span class="string">"172.17.0.0/12"</span>,</span><br><span class="line">            <span class="attr">"size"</span>:<span class="number">24</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ vim /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"default-address-pools"</span> : [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"base"</span> : <span class="string">"172.240.0.0/16"</span>,</span><br><span class="line">      <span class="string">"size"</span> : 24</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="docker-å®¹å™¨æ— æ³•åˆ é™¤">Docker å®¹å™¨æ— æ³•åˆ é™¤</span></h2><blockquote><p><strong>æ‰¾ä¸åˆ°å¯¹åº”å®¹å™¨è¿›ç¨‹æ˜¯æœ€å“äººçš„</strong></p></blockquote><ul><li><strong>[é—®é¢˜èµ·å› ]</strong> ä»Šå¤©é‡åˆ° <code>docker</code> å®¹å™¨æ— æ³•åœæ­¢/ç»ˆæ­¢/åˆ é™¤ï¼Œä»¥ä¸ºè¿™ä¸ªå®¹å™¨å¯èƒ½åˆå‡ºç°äº† <code>dockerd</code> å®ˆæŠ¤è¿›ç¨‹æ‰˜ç®¡çš„æƒ…å†µï¼Œä½†æ˜¯é€šè¿‡ <code>ps -ef &lt;container id&gt;</code> æ— æ³•æŸ¥åˆ°å¯¹åº”çš„è¿è¡Œè¿›ç¨‹ã€‚å“ï¼Œåæ¥å¼€å§‹å¼€å§‹æŸ¥ <code>supervisor</code> ä»¥åŠ <code>Dockerfile</code> ä¸­çš„è¿›ç¨‹ï¼Œéƒ½æ²¡æœ‰ã€‚è¿™ç§æƒ…å†µçš„å¯èƒ½åŸå› æ˜¯å®¹å™¨å¯åŠ¨ä¹‹åï¼Œä¸»æœºå› ä»»ä½•åŸå› é‡æ–°å¯åŠ¨å¹¶ä¸”æ²¡æœ‰ä¼˜é›…åœ°ç»ˆæ­¢å®¹å™¨ã€‚å‰©ä¸‹çš„æ–‡ä»¶ç°åœ¨é˜»æ­¢ä½ é‡æ–°ç”Ÿæˆæ—§åç§°çš„æ–°å®¹å™¨ï¼Œå› ä¸ºç³»ç»Ÿè®¤ä¸ºæ—§å®¹å™¨ä»ç„¶å­˜åœ¨ã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ é™¤å®¹å™¨</span></span><br><span class="line">$ sudo docker rm -f f8e8c3..</span><br><span class="line">Error response from daemon: Conflict, cannot remove the default name of the container</span><br></pre></td></tr></table></figure><ul><li><strong>[è§£å†³æ–¹æ³•]</strong> æ‰¾åˆ° <code>/var/lib/docker/containers/</code> ä¸‹çš„å¯¹åº”å®¹å™¨çš„æ–‡ä»¶å¤¹ï¼Œå°†å…¶åˆ é™¤ï¼Œç„¶åé‡å¯ä¸€ä¸‹ <code>dockerd</code> å³å¯ã€‚æˆ‘ä»¬ä¼šå‘ç°ï¼Œä¹‹å‰æ— æ³•åˆ é™¤çš„å®¹å™¨æ²¡æœ‰äº†ã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ é™¤å®¹å™¨æ–‡ä»¶</span></span><br><span class="line">$ sudo rm -rf /var/lib/docker/containers/f8e8c3...65720</span><br><span class="line"></span><br><span class="line"><span class="comment"># é‡å¯æœåŠ¡</span></span><br><span class="line">$ sudo systemctl restart docker.service</span><br></pre></td></tr></table></figure><h2><span id="docker-å®¹å™¨ä¸­æ–‡å¼‚å¸¸">Docker å®¹å™¨ä¸­æ–‡å¼‚å¸¸</span></h2><blockquote><p><strong>å®¹å™¨å­˜åœ¨é—®é¢˜è¯ï¼Œè®°å¾—ä¼˜å…ˆåœ¨å®˜ç½‘æŸ¥è¯¢</strong></p></blockquote><ul><li><strong>[é—®é¢˜èµ·å› ]</strong> ä»Šå¤©ç™»é™†ä¹‹å‰éƒ¨ç½²çš„ <code>MySQL</code> æ•°æ®åº“æŸ¥è¯¢ï¼Œå‘ç°ä½¿ç”¨ <code>SQL</code> è¯­å¥æ— æ³•æŸ¥è¯¢ä¸­æ–‡å­—æ®µï¼Œå³ä½¿ç›´æ¥è¾“å…¥ä¸­æ–‡éƒ½æ²¡æœ‰åŠæ³•æ˜¾ç¤ºã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹å®¹å™¨æ”¯æŒçš„å­—ç¬¦é›†</span></span><br><span class="line">root@b18f56aa1e15:<span class="comment"># locale -a</span></span><br><span class="line">C</span><br><span class="line">C.UTF-8</span><br><span class="line">POSIX</span><br></pre></td></tr></table></figure><ul><li><strong>[è§£å†³æ–¹æ³•]</strong> <code>Docker</code> éƒ¨ç½²çš„ <code>MySQL</code> ç³»ç»Ÿä½¿ç”¨çš„æ˜¯ <code>POSIX</code> å­—ç¬¦é›†ã€‚ç„¶è€Œ <code>POSIX</code> å­—ç¬¦é›†æ˜¯ä¸æ”¯æŒä¸­æ–‡çš„ï¼Œè€Œ <code>C.UTF-8</code> æ˜¯æ”¯æŒä¸­æ–‡çš„åªè¦æŠŠç³»ç»Ÿä¸­çš„ç¯å¢ƒ <code>LANG</code> æ”¹ä¸º <code>&quot;C.UTF-8&quot;</code> æ ¼å¼å³å¯è§£å†³é—®é¢˜ã€‚åŒç†ï¼Œåœ¨ <code>K8S</code> è¿›å…¥ <code>pod</code> ä¸èƒ½è¾“å…¥ä¸­æ–‡ä¹Ÿå¯ç”¨æ­¤æ–¹æ³•è§£å†³ã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¸´æ—¶è§£å†³</span></span><br><span class="line">docker <span class="built_in">exec</span> -it some-mysql env LANG=C.UTF-8 /bin/bash</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ°¸ä¹…è§£å†³</span></span><br><span class="line">docker run --name some-mysql \</span><br><span class="line">    -e MYSQL_ROOT_PASSWORD=my-secret-pw \</span><br><span class="line">    -d mysql:tag --character-set-server=utf8mb4 \</span><br><span class="line">    --collation-server=utf8mb4_unicode_ci</span><br></pre></td></tr></table></figure><h2><span id="docker-å®¹å™¨ç½‘ç»œäº’é€š">Docker å®¹å™¨ç½‘ç»œäº’é€š</span></h2><blockquote><p><strong>äº†è§£ Docker çš„å››ç§ç½‘ç»œæ¨¡å‹</strong></p></blockquote><ul><li><strong>[é—®é¢˜èµ·å› ]</strong> åœ¨æœ¬æœºéƒ¨ç½² <code>Nginx</code> å®¹å™¨æƒ³ä»£ç†æœ¬æœºå¯åŠ¨çš„ <code>Python</code> åç«¯æœåŠ¡ç¨‹åºï¼Œä½†æ˜¯å¯¹ä»£ç æœåŠ¡å¦‚ä¸‹çš„é…ç½®ï¼Œç»“æœè®¿é—®çš„æ—¶å€™ä¸€ç›´æç¤º <code>502</code> é”™è¯¯ã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¯åŠ¨NginxæœåŠ¡</span></span><br><span class="line">$ docker run -d -p 80:80 <span class="variable">$PWD</span>:/etc/nginx nginx</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    ...</span><br><span class="line">    location &#x2F;api &#123;</span><br><span class="line">        proxy_pass http:&#x2F;&#x2F;localhost:8080</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>[è§£å†³æ–¹æ³•]</strong> åé¢å‘ç°æ˜¯å› ä¸º <code>nginx.conf</code> é…ç½®æ–‡ä»¶ä¸­çš„ <code>localhost</code> é…ç½®çš„æœ‰é—®é¢˜ï¼Œç”±äº <code>Nginx</code> æ˜¯åœ¨å®¹å™¨ä¸­è¿è¡Œï¼Œæ‰€ä»¥ <code>localhost</code> ä¸ºå®¹å™¨ä¸­çš„ <code>localhost</code>ï¼Œè€Œéæœ¬æœºçš„ <code>localhost</code>ï¼Œæ‰€ä»¥å¯¼è‡´æ— æ³•è®¿é—®ã€‚</li><li>å¯ä»¥å°† <code>nginx.conf</code> ä¸­çš„ <code>localhost</code> æ”¹ä¸ºå®¿ä¸»æœºçš„ <code>IP</code> åœ°å€ï¼Œå°±å¯ä»¥è§£å†³ <code>502</code> çš„é”™è¯¯ã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥è¯¢å®¿ä¸»æœºIPåœ°å€ =&gt; 172.17.0.1</span></span><br><span class="line">$ ip addr show docker0</span><br><span class="line">docker0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default</span><br><span class="line">    link/ether 02:42:d5:4c:f2:1e brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.17.0.1/16 scope global docker0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::42:d5ff:fe4c:f21e/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    ...</span><br><span class="line">    location &#x2F;api &#123;</span><br><span class="line">        proxy_pass http:&#x2F;&#x2F;172.17.0.1:8080</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å½“å®¹å™¨ä½¿ç”¨ <code>host</code> ç½‘ç»œæ—¶ï¼Œå®¹å™¨ä¸å®¿ä¸»å…±ç”¨ç½‘ç»œï¼Œè¿™æ ·å°±èƒ½åœ¨å®¹å™¨ä¸­è®¿é—®å®¿ä¸»æœºç½‘ç»œï¼Œé‚£ä¹ˆå®¹å™¨çš„ <code>localhost</code> å°±æ˜¯å®¿ä¸»æœºçš„ <code>localhost</code> äº†ã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æœåŠ¡çš„å¯åŠ¨æ–¹å¼æœ‰æ‰€æ”¹å˜(æ²¡æœ‰æ˜ å°„å‡ºæ¥ç«¯å£)</span></span><br><span class="line"><span class="comment"># å› ä¸ºæœ¬èº«ä¸å®¿ä¸»æœºå…±ç”¨äº†ç½‘ç»œï¼Œå®¿ä¸»æœºæš´éœ²ç«¯å£ç­‰åŒäºå®¹å™¨ä¸­æš´éœ²ç«¯å£</span></span><br><span class="line">$ docker run -d -p 80:80 --network=host <span class="variable">$PWD</span>:/etc/nginx nginxx</span><br></pre></td></tr></table></figure><h2><span id="docker-å®¹å™¨æ€»çº¿é”™è¯¯">Docker å®¹å™¨æ€»çº¿é”™è¯¯</span></h2><blockquote><p><strong>æ€»çº¿é”™è¯¯çœ‹åˆ°çš„æ—¶å€™è¿˜æ˜¯æŒºå“äººäº†</strong></p></blockquote><ul><li><strong>[é—®é¢˜èµ·å› ]</strong> åœ¨ <code>docker</code> å®¹å™¨ä¸­è¿è¡Œç¨‹åºçš„æ—¶å€™ï¼Œæç¤º <code>bus error</code> é”™è¯¯ã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ€»çº¿æŠ¥é”™</span></span><br><span class="line">$ inv app.user_op --name=zhangsan</span><br><span class="line">Bus error (core dumped)</span><br></pre></td></tr></table></figure><ul><li><strong>[è§£å†³æ–¹æ³•]</strong> åŸå› æ˜¯åœ¨ <code>docker</code> è¿è¡Œçš„æ—¶å€™ï¼Œ<code>shm</code> åˆ†åŒºè®¾ç½®å¤ªå°å¯¼è‡´ <code>share memory</code> ä¸å¤Ÿã€‚ä¸è®¾ç½® <code>--shm-size</code> å‚æ•°æ—¶ï¼Œ<code>docker</code> ç»™å®¹å™¨é»˜è®¤åˆ†é…çš„ <code>shm</code> å¤§å°ä¸º <code>64M</code>ï¼Œå¯¼è‡´ç¨‹åºå¯åŠ¨æ—¶ä¸è¶³ã€‚å…·ä½“åŸå› è¿˜æ˜¯å› ä¸ºå®‰è£… <code>pytorch</code> åŒ…å¯¼è‡´äº†ï¼Œå¤šè¿›ç¨‹è·‘ä»»åŠ¡çš„æ—¶å€™ï¼Œ<code>docker</code> å®¹å™¨åˆ†é…çš„å…±äº«å†…å­˜å¤ªå°ï¼Œå¯¼è‡´ <code>torch</code> è¦åœ¨ <code>tmpfs</code> ä¸Šé¢æ”¾æ¨¡å‹æ•°æ®ç”¨äºå­çº¿ç¨‹çš„ <a href="https://github.com/pytorch/pytorch/issues/2244" target="_blank" rel="noopener">å…±äº«ä¸è¶³</a>ï¼Œå°±å‡ºç°æŠ¥é”™äº†ã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># é—®é¢˜åŸå› </span></span><br><span class="line">root@18...35:/opt/app<span class="comment"># df -TH</span></span><br><span class="line">Filesystem     Type     Size  Used Avail Use% Mounted on</span><br><span class="line">overlay        overlay  2.0T  221G  1.4T   3% /</span><br><span class="line">tmpfs          tmpfs     68M     0   68M   0% /dev</span><br><span class="line">shm            tmpfs     68M   41k   68M   1% /dev/shm</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯åŠ¨dockerçš„æ—¶å€™åŠ ä¸Š--shm-sizeå‚æ•°(å•ä½ä¸ºb,k,mæˆ–g)</span></span><br><span class="line">$ docker run -it --rm --shm-size=200m pytorch/pytorch:latest</span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨docker-composeæ·»åŠ å¯¹åº”é…ç½®</span></span><br><span class="line">$ shm_size: <span class="string">'2gb'</span></span><br></pre></td></tr></table></figure><ul><li><strong>[è§£å†³æ–¹æ³•]</strong> è¿˜æœ‰ä¸€ç§æƒ…å†µå°±æ˜¯å®¹å™¨å†…çš„ç£ç›˜ç©ºé—´ä¸è¶³ï¼Œä¹Ÿä¼šå¯¼è‡´ <code>bus error</code> è¿™æ ·çš„æŠ¥é”™ï¼Œæ‰€ä»¥å¦‚æœå‡ºç°äº†ï¼Œæ¸…é™¤å¤šä½™æ–‡ä»¶å’Œç›®å½•æˆ–è€…åˆ†é…ä¸€ä¸ªå¤§çš„ç£ç›˜ç©ºé—´ï¼Œå°±å¯ä»¥è§£å†³äº†ã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç£ç›˜ç©ºé—´ä¸è¶³</span></span><br><span class="line">$ df -Th</span><br><span class="line">Filesystem     Type     Size  Used Avail Use% Mounted on</span><br><span class="line">overlay        overlay    1T    1T    0G 100% /</span><br><span class="line">shm            tmpfs     64M   24K   64M   1% /dev/shm</span><br></pre></td></tr></table></figure><h2><span id="docker-nfs-æŒ‚è½½æŠ¥é”™">Docker NFS æŒ‚è½½æŠ¥é”™</span></h2><blockquote><p><strong>NFS æŒ‚è½½ä¹‹åå®¹å™¨ç¨‹åºä½¿ç”¨å¼‚å¸¸ä¸ºå†…æ ¸ç‰ˆæœ¬å¤ªä½å¯¼è‡´çš„</strong></p></blockquote><ul><li><strong>[é—®é¢˜èµ·å› ]</strong> æˆ‘ä»¬å°†æœåŠ¡éƒ¨ç½²åˆ° <code>openshift</code> é›†ç¾¤ä¸­ï¼Œå¯åŠ¨æœåŠ¡è°ƒç”¨èµ„æºæ–‡ä»¶çš„æ—¶å€™ï¼ŒæŠ¥é”™ä¿¡æ¯å¦‚ä¸‹æ‰€ç¤ºã€‚ä»æŠ¥é”™ä¿¡æ¯ä¸­ï¼Œå¾—çŸ¥æ˜¯åœ¨ <code>Python3</code> ç¨‹åºæ‰§è¡Œ <code>read_file()</code> è¯»å–æ–‡ä»¶çš„å†…å®¹ï¼Œç»™æ–‡ä»¶åŠ é”çš„æ—¶å€™æŠ¥é”™äº†ã€‚ä½†æ˜¯å¥‡æ€ªçš„æ˜¯ï¼Œæœ¬åœ°è°ƒè¯•çš„æ—¶å€™å‘ç°æœåŠ¡éƒ½æ˜¯å¯ä»¥æ­£å¸¸è¿è¡Œçš„ï¼Œæ–‡ä»¶åŠ é”ä¹Ÿæ˜¯æ²¡é—®é¢˜çš„ã€‚åæ¥å‘ç°ï¼Œåœ¨ <code>openshift</code> é›†ç¾¤ä¸­ä½¿ç”¨çš„æ˜¯ <code>NFS</code> æŒ‚è½½çš„å…±äº«ç£ç›˜ã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŠ¥é”™ä¿¡æ¯</span></span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">    ......</span><br><span class="line">    File <span class="string">"xxx/utils/storage.py"</span>, line 34, <span class="keyword">in</span> xxx.utils.storage.LocalStorage.read_file</span><br><span class="line">OSError: [Errno 9] Bad file descriptor</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># æ–‡ä»¶åŠ é”ä»£ç </span><br><span class="line">...</span><br><span class="line">    with open(self.mount(path), &#39;rb&#39;) as fileobj:</span><br><span class="line">        fcntl.flock(fileobj, fcntl.LOCK_EX)</span><br><span class="line">        data &#x3D; fileobj.read()</span><br><span class="line">    return data</span><br><span class="line">...</span><br></pre></td></tr></table></figure><ul><li><strong>[è§£å†³æ–¹æ³•]</strong> ä»ä¸‹é¢çš„ä¿¡æ¯å¾—çŸ¥ï¼Œè¦åœ¨ <code>Linux</code> ä¸­ä½¿ç”¨ <code>flock()</code> çš„è¯ï¼Œå°±éœ€è¦å‡çº§å†…æ ¸ç‰ˆæœ¬åˆ° <code>2.6.11+</code> æ‰è¡Œã€‚åæ¥æ‰å‘ç°ï¼Œè¿™å®é™…ä¸Šæ˜¯ç”± <code>RedHat</code> å…§æ ¸ä¸­çš„ä¸€ä¸ªé”™è¯¯å¼•èµ·çš„ï¼Œå¹¶åœ¨ <code>kernel-3.10.0-693.18.1.el7</code> ç‰ˆæœ¬ä¸­å¾—åˆ°ä¿®å¤ã€‚ æ‰€ä»¥å¯¹äº <code>NFSv3</code> å’Œ <code>NFSv4</code> æœåŠ¡è€Œå·²ï¼Œå°±éœ€è¦å‡çº§ <code>Linux</code> å†…æ ¸ç‰ˆæœ¬æ‰èƒ½å¤Ÿè§£å†³è¿™ä¸ªé—®é¢˜ã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># https://t.codebug.vip/questions-930901.htm</span></span><br><span class="line">$ In Linux kernels up to 2.6.11, flock() does not lock files over NFS (i.e.,</span><br><span class="line">the scope of locks was limited to the <span class="built_in">local</span> system). [...] Since Linux 2.6.12,</span><br><span class="line">NFS clients support flock() locks by emulating them as byte-range locks on the entire file.</span><br></pre></td></tr></table></figure><h2><span id="docker-ä½¿ç”¨é»˜è®¤ç½‘æ®µ">Docker ä½¿ç”¨é»˜è®¤ç½‘æ®µ</span></h2><blockquote><p><strong>å¯åŠ¨çš„å®¹å™¨ç½‘ç»œæ— æ³•ç›¸äº’é€šä¿¡ï¼Œå¾ˆæ˜¯å¥‡æ€ªï¼</strong></p></blockquote><ul><li><strong>[é—®é¢˜èµ·å› ]</strong> æˆ‘ä»¬åœ¨ä½¿ç”¨ <code>Docker</code> å¯åŠ¨æœåŠ¡çš„æ—¶å€™ï¼Œå‘ç°æœ‰æ—¶å€™æœåŠ¡ä¹‹å‰å¯ä»¥ç›¸äº’è¿é€šï¼Œè€Œæœ‰æ—¶å¯åŠ¨çš„å¤šä¸ªæœåŠ¡ä¹‹å‰å´å‡ºç°äº†æ— æ³•è®¿é—®çš„æƒ…å†µã€‚ç©¶å…¶åŸå› ï¼Œå‘ç°åŸæ¥æ˜¯å› ä¸ºä½¿ç”¨çš„å†…éƒ¨ç§æœ‰åœ°å€ç½‘æ®µä¸ä¸€è‡´å¯¼è‡´çš„ã€‚æœ‰çš„æœåŠ¡å¯åŠ¨åˆ°äº† <code>172.17 - 172.31</code> çš„ç½‘æ®µï¼Œæœ‰çš„æœåŠ¡è·‘åˆ°äº† <code>192.169.0 - 192.168.224</code> çš„ç½‘æ®µï¼Œè¿™æ ·å¯¼è‡´æœåŠ¡å¯åŠ¨ä¹‹åå‡ºç°æ— æ³•è®¿é—®çš„æƒ…å†µ(é»˜è®¤æƒ…å†µä¸‹ï¼Œæœ‰ä¸‹é¢è¿™ä¸ªä¸¤ä¸ªç½‘æ®µå¯ä¾›å…¶ä½¿ç”¨)ã€‚</li></ul><p><img src="https://img.hi-linux.com/staticfile/docker-have-some-trouble-2-2022-03-29-DlFT7v.png" alt="Dockeré»˜è®¤ä½¿ç”¨ç½‘æ®µ"></p><ul><li><strong>[è§£å†³æ–¹æ³•]</strong> ä¸Šè¿°é—®é¢˜çš„å¤„ç†æ–¹å¼ï¼Œå°±æ˜¯æ‰‹åŠ¨æŒ‡å®š <code>Docker</code> æœåŠ¡çš„å¯åŠ¨ç½‘æ®µï¼ŒäºŒé€‰ä¸€å°±å¯ä»¥äº†ã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹dockerå®¹å™¨é…ç½®</span></span><br><span class="line">$ cat /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"registry-mirrors"</span>: [<span class="string">"https://vec0xydj.mirror.aliyuncs.com"</span>],</span><br><span class="line">    <span class="string">"default-address-pools"</span>:[&#123;<span class="string">"base"</span>:<span class="string">"172.17.0.0/12"</span>, <span class="string">"size"</span>:24&#125;],</span><br><span class="line">    <span class="string">"experimental"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">"default-runtime"</span>: <span class="string">"nvidia"</span>,</span><br><span class="line">    <span class="string">"live-restore"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">"runtimes"</span>: &#123;</span><br><span class="line">        <span class="string">"nvidia"</span>: &#123;</span><br><span class="line">            <span class="string">"path"</span>: <span class="string">"/usr/bin/nvidia-container-runtime"</span>,</span><br><span class="line">            <span class="string">"runtimeArgs"</span>: []</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="docker-æœåŠ¡å¯åŠ¨ä¸²å°">Docker æœåŠ¡å¯åŠ¨ä¸²å°</span></h2><blockquote><p><strong>ä½¿ç”¨ docker-compose å‘½ä»¤å„è‡ªå¯åŠ¨ä¸¤ç»„æœåŠ¡ï¼Œå‘ç°æœåŠ¡ä¼šä¸²å°ï¼</strong></p></blockquote><ul><li><strong>[é—®é¢˜èµ·å› ]</strong> åœ¨ä¸¤ä¸ªä¸åŒåç§°çš„ç›®å½•ç›®å½•ä¸‹é¢ï¼Œä½¿ç”¨ <code>docker-compose</code> æ¥å¯åŠ¨æœåŠ¡ï¼Œå‘ç°å½“ <code>A</code> ç»„æœåŠ¡å¯åŠ¨å®Œæ¯•ä¹‹åï¼Œå†å¯åŠ¨ <code>B</code> ç»„æœåŠ¡çš„æ—¶å€™ï¼Œå‘ç° <code>A</code> ç»„å½“ä¸­å¯¹åº”çš„ä¸€éƒ¨åˆ†æœåŠ¡åˆé‡æ–°å¯åŠ¨äº†ä¸€æ¬¡ï¼Œè¿™å°±éå¸¸å¥‡æ€ªäº†ï¼å› ä¸ºè¿™ä¸ªé—®é¢˜çš„å­˜åœ¨ä¼šå¯¼è‡´ï¼Œ<code>A</code> ç»„æœåŠ¡å’Œ <code>B</code> ç»„æœåŠ¡æ— æ³•åŒæ—¶å¯åŠ¨ã€‚ä¹‹å‰è¿˜ä»¥ä¸ºæ˜¯å·¥å…·çš„ <code>Bug</code>ï¼Œåæ¥è¯·æ•™äº† <strong>â€œä¸Šå³°â€</strong>ï¼Œæ‰çŸ¥é“äº†åŸå› ï¼Œæç„¶å¤§æ‚Ÿã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æœåŠ¡ç›®å½•ç»“æ„å¦‚ä¸‹æ‰€ç¤º</span></span><br><span class="line">A: /data1/app/docker-compose.yml</span><br><span class="line">B: /data2/app/docker-compose.yml</span><br></pre></td></tr></table></figure><ul><li><strong>[è§£å†³æ–¹æ³•]</strong> å‘ç° <code>A</code> å’Œ <code>B</code> ä¸¤ç»„æœåŠ¡ä¼šä¸²å°çš„åŸå› ï¼ŒåŸæ¥æ˜¯ <code>docker-compose</code> ä¼šç»™å¯åŠ¨çš„å®¹å™¨åŠ  <code>label</code> æ ‡ç­¾ï¼Œç„¶åæ ¹æ®è¿™äº› <code>label</code> æ ‡ç­¾æ¥è¯†åˆ«å’Œåˆ¤æ–­å¯¹åº”çš„å®¹å™¨æœåŠ¡æ˜¯ç”±è°å¯åŠ¨çš„ã€è°æ¥ç®¡ç†çš„ï¼Œç­‰ç­‰ã€‚è€Œè¿™é‡Œï¼Œæˆ‘ä»¬éœ€è¦å…³æ³¨çš„ <code>label</code> å˜é‡æ˜¯ <code>com.docker.compose.project</code>ï¼Œå…¶å¯¹åº”çš„å€¼æ˜¯ä½¿ç”¨å¯åŠ¨é…ç½®æ–‡ä»¶çš„ç›®å½•çš„æœ€åº•å±‚å­ç›®å½•åç§°ï¼Œå³ä¸Šé¢çš„ <code>app</code> å°±æ˜¯å¯¹åº”çš„å€¼ã€‚æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œ <code>A</code> å’Œ <code>B</code> ä¸¤ç»„æœåŠ¡å¯¹åº”çš„å€¼éƒ½æ˜¯ <code>app</code>ï¼Œæ‰€ä»¥å¯åŠ¨çš„æ—¶å€™è¢«è®¤ä¸ºæ˜¯åŒä¸€ä¸ªï¼Œè¿™å°±å‡ºç°äº†ä¸Šè¿°çš„é—®é¢˜ã€‚å¦‚æœéœ€è¦æ·±å…¥äº†è§£çš„è¯ï¼Œå¯ä»¥å»çœ‹å¯¹åº”æºä»£ç ã€‚</li></ul><p><img src="https://img.hi-linux.com/staticfile/docker-have-some-trouble-4-20220329161418940-2022-03-29-Aqsd14.png" alt="DockeræœåŠ¡å¯åŠ¨ä¸²å°"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¯ä»¥å°†ç›®å½•ç»“æ„è°ƒæ•´ä¸ºå¦‚ä¸‹æ‰€ç¤º</span></span><br><span class="line">A: /data/app1/docker-compose.yml</span><br><span class="line">B: /data/app2/docker-compose.yml</span><br><span class="line"></span><br><span class="line">A: /data1/app-old/docker-compose.yml</span><br><span class="line">B: /data2/app-new/docker-compose.yml</span><br></pre></td></tr></table></figure><ul><li>æˆ–è€…ä½¿ç”¨ <code>docker-compose</code> å‘½ä»¤æä¾›çš„å‚æ•° <code>-p</code> æ‰‹åŠ¨æŒ‡å®šæ ‡ç­¾ï¼Œæ¥è§„é¿è¯¥é—®é¢˜çš„å‘ç”Ÿã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŒ‡å®šé¡¹ç›®é¡¹ç›®åç§°</span></span><br><span class="line">$ docker-compose -f ./docker-compose.yml -p app1 up -d</span><br></pre></td></tr></table></figure><h2><span id="docker-å‘½ä»¤è°ƒç”¨æŠ¥é”™">Docker å‘½ä»¤è°ƒç”¨æŠ¥é”™</span></h2><blockquote><p><strong>åœ¨ç¼–å†™è„šæœ¬çš„æ—¶å€™å¸¸å¸¸ä¼šæ‰§è¡Œ docker ç›¸å…³çš„å‘½ä»¤ï¼Œä½†æ˜¯éœ€è¦æ³¨æ„ä½¿ç”¨ç»†èŠ‚ï¼</strong></p></blockquote><ul><li><strong>[é—®é¢˜èµ·å› ]</strong> <code>CI</code> æ›´æ–°ç¯å¢ƒæ‰§è¡Œäº†ä¸€ä¸ªè„šæœ¬ï¼Œä½†æ˜¯è„šæœ¬æ‰§è¡Œè¿‡ç¨‹ä¸­æŠ¥é”™äº†ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚é€šè¿‡å¯¹åº”çš„è¾“å‡ºä¿¡æ¯ï¼Œå¯ä»¥çœ‹åˆ°æç¤ºè¯´æ­£åœ¨æ‰§è¡Œçš„è®¾å¤‡ä¸æ˜¯ä¸€ä¸ª <code>tty</code>ã€‚</li></ul><p><img src="https://img.hi-linux.com/staticfile/docker-have-some-trouble-5-2022-03-29-3hwPWX.png" alt="Dockerå‘½ä»¤è°ƒç”¨æŠ¥é”™"></p><ul><li>éšå³ï¼ŒæŸ¥çœ‹äº†è„šæœ¬å‘ç°æŠ¥é”™åœ°æ–¹æ˜¯æ‰§è¡Œäº†ä¸€ä¸ª <code>exec</code> çš„ <code>docker</code> å‘½ä»¤ï¼Œå¤§è‡´å¦‚ä¸‹æ‰€ç¤ºã€‚å¾ˆå¥‡æ€ªçš„æ˜¯ï¼Œæ‰‹åŠ¨æ‰§è¡Œæˆ–ç›´æ¥è°ƒè„šæœ¬çš„æ—¶å€™ï¼Œæ€ä¹ˆéƒ½æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œä½†æ˜¯ç­‰åˆ° <code>CI</code> è°ƒç”¨çš„æ—¶å€™æ€ä¹ˆéƒ½æ˜¯æœ‰é—®é¢˜ã€‚åæ¥å¥½å¥½çœ‹ä¸‹ï¼Œä¸‹é¢è¿™ä¸ªå‘½ä»¤ï¼Œæ³¨æ„åˆ° <code>-it</code> è¿™ä¸ªå‚æ•°äº†ã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è„šæœ¬è°ƒç”¨dockerå‘½ä»¤</span></span><br><span class="line">docker <span class="built_in">exec</span> -it &lt;container_name&gt; psql -Upostgres ......</span><br></pre></td></tr></table></figure><ul><li>æˆ‘ä»¬å¯ä»¥ä¸€èµ·çœ‹ä¸‹ <code>exec</code> å‘½ä»¤çš„è¿™ä¸¤ä¸ªå‚æ•°ï¼Œè‡ªç„¶å°±å·®ä¸å¤šç†è§£äº†ã€‚</li></ul><table><thead><tr><th style="text-align:left">ç¼–å·</th><th style="text-align:left">å‚æ•°</th><th style="text-align:left">è§£é‡Šè¯´æ˜</th></tr></thead><tbody><tr><td style="text-align:left">1</td><td style="text-align:left"><code>-i</code>/<code>-interactive</code></td><td style="text-align:left">å³ä½¿æ²¡æœ‰é™„åŠ ä¹Ÿä¿æŒ STDIN æ‰“å¼€ï¼›å¦‚æœä½ éœ€è¦æ‰§è¡Œå‘½ä»¤åˆ™éœ€è¦å¼€å¯è¿™ä¸ªé€‰é¡¹</td></tr><tr><td style="text-align:left">2</td><td style="text-align:left"><code>-t</code>/<code>â€“tty</code></td><td style="text-align:left">åˆ†é…ä¸€ä¸ªä¼ªç»ˆç«¯è¿›è¡Œæ‰§è¡Œï¼›ä¸€ä¸ªè¿æ¥ç”¨æˆ·çš„ç»ˆç«¯ä¸å®¹å™¨ stdin å’Œ stdout çš„æ¡¥æ¢</td></tr></tbody></table><ul><li><strong>[è§£å†³æ–¹æ³•]</strong> <code>docker exec</code> çš„å‚æ•° <code>-t</code> æ˜¯æŒ‡ <code>Allocate a pseudo-TTY</code> çš„æ„æ€ï¼Œè€Œ <code>CI</code> åœ¨æ‰§è¡Œ <code>job</code> çš„æ—¶å€™å¹¶ä¸æ˜¯åœ¨ <code>TTY</code> ç»ˆç«¯ä¸­æ‰§è¡Œï¼Œæ‰€ä»¥ <code>-t</code> è¿™ä¸ªå‚æ•°ä¼šæŠ¥é”™ã€‚åŒæ—¶åœ¨ ã€<a href="https://stackoverflow.com/questions/43099116/error-the-input-device-is-not-a-tty" target="_blank" rel="noopener">stackoverflow</a>ã€ä¹Ÿæœ‰äººç»™å‡ºåŸå› ï¼Œå¯ä»¥è‡ªè¡ŒæŸ¥çœ‹ã€‚</li></ul><p><img src="https://img.hi-linux.com/staticfile/docker-have-some-trouble-6-20220329162948314-2022-03-29-ECCkYH.png" alt="Dockerå‘½ä»¤è°ƒç”¨æŠ¥é”™"></p><h2><span id="docker-å®šæ—¶ä»»åŠ¡å¼‚å¸¸">Docker å®šæ—¶ä»»åŠ¡å¼‚å¸¸</span></h2><blockquote><p><strong>åœ¨ Crontab å®šæ—¶ä»»åŠ¡ä¸­ä¹Ÿå­˜åœ¨ Docker å‘½ä»¤æ‰§è¡Œå¼‚å¸¸çš„æƒ…å†µï¼</strong></p></blockquote><ul><li><strong>[é—®é¢˜èµ·å› ]</strong> ä»Šå¤©å‘ç°äº†ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯åœ¨å¤‡ä»½ <code>Mysql</code> æ•°æ®åº“çš„æ—¶å€™ï¼Œä½¿ç”¨ <code>docker</code> å®¹å™¨è¿›è¡Œå¤‡ä»½ï¼Œç„¶åä½¿ç”¨ <code>Crontab</code> å®šæ—¶ä»»åŠ¡æ¥è§¦å‘å¤‡ä»½ã€‚ä½†æ˜¯å‘ç°å¤‡ä»½çš„ <code>MySQL</code> æ•°æ®åº“å±…ç„¶æ˜¯ç©ºçš„ï¼Œä½†æ˜¯æ‰‹åŠ¨æ‰§è¡Œå¯¹åº”å‘½ä»¤åˆ‡æ˜¯å¥½çš„ï¼Œå¾ˆå¥‡æ€ªã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Crontabå®šæ—¶ä»»åŠ¡</span></span><br><span class="line">0 */6 * * * \</span><br><span class="line">    docker <span class="built_in">exec</span> -it &lt;container_name&gt; sh -c \</span><br><span class="line">        <span class="string">'exec mysqldump --all-databases -uroot -ppassword ......'</span></span><br></pre></td></tr></table></figure><ul><li><strong>[è§£å†³æ–¹æ³•]</strong> åæ¥å‘ç°æ˜¯å› ä¸ºæ‰§è¡Œçš„ <code>docker</code> å‘½ä»¤å¤šä¸ª <code>-i</code> å¯¼è‡´çš„ã€‚å› ä¸º <code>Crontab</code> å‘½ä»¤æ‰§è¡Œçš„æ—¶å€™ï¼Œå¹¶ä¸æ˜¯äº¤äº’å¼çš„ï¼Œæ‰€ä»¥éœ€è¦æŠŠè¿™ä¸ªå»æ‰æ‰å¯ä»¥ã€‚æ€»ç»“å°±æ˜¯ï¼Œå¦‚æœä½ éœ€è¦å›æ˜¾çš„è¯åˆ™éœ€è¦ <code>-t</code> é€‰é¡¹ï¼Œå¦‚æœéœ€è¦äº¤äº’å¼ä¼šè¯åˆ™éœ€è¦ <code>-i</code> é€‰é¡¹ã€‚</li></ul><table><thead><tr><th style="text-align:left">ç¼–å·</th><th style="text-align:left">å‚æ•°</th><th style="text-align:left">è§£é‡Šè¯´æ˜</th></tr></thead><tbody><tr><td style="text-align:left">1</td><td style="text-align:left"><code>-i</code>/<code>-interactive</code></td><td style="text-align:left">å³ä½¿æ²¡æœ‰é™„åŠ ä¹Ÿä¿æŒ STDIN æ‰“å¼€ï¼›å¦‚æœä½ éœ€è¦æ‰§è¡Œå‘½ä»¤åˆ™éœ€è¦å¼€å¯è¿™ä¸ªé€‰é¡¹</td></tr><tr><td style="text-align:left">2</td><td style="text-align:left"><code>-t</code>/<code>â€“tty</code></td><td style="text-align:left">åˆ†é…ä¸€ä¸ªä¼ªç»ˆç«¯è¿›è¡Œæ‰§è¡Œï¼›ä¸€ä¸ªè¿æ¥ç”¨æˆ·çš„ç»ˆç«¯ä¸å®¹å™¨ stdin å’Œ stdout çš„æ¡¥æ¢</td></tr></tbody></table><h2><span id="docker-å˜é‡ä½¿ç”¨å¼•å·">Docker å˜é‡ä½¿ç”¨å¼•å·</span></h2><blockquote><p><strong>compose é‡Œè¾¹ç¯å¢ƒå˜é‡å¸¦ä¸å¸¦å¼•å·çš„é—®é¢˜ï¼</strong></p></blockquote><ul><li><strong>[é—®é¢˜èµ·å› ]</strong> ä½¿ç”¨è¿‡ <code>compose</code> çš„æœ‹å‹å¯èƒ½éƒ½é‡åˆ°è¿‡ï¼Œåœ¨ç¼–å†™å¯æœåŠ¡å¯åŠ¨é…ç½®æ–‡ä»¶çš„æ—¶å€™ï¼Œæ·»åŠ ç¯å¢ƒå˜é‡æ—¶åˆ°åº•æ˜¯ä½¿ç”¨å•å¼•å·ã€åŒå¼•å·è¿˜æ˜¯ä¸ä½¿ç”¨å¼•å·çš„é—®é¢˜ï¼Ÿæ—¶é—´é•¿äº†ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šå°†ä¸‰è€…æ··ç”¨ï¼Œè®¤ä¸ºå…¶æ•ˆæœæ˜¯ä¸€æ ·çš„ã€‚ä½†æ˜¯åæ¥ï¼Œå‘ç°çš„å‘è¶Šæ¥è¶Šå¤šï¼Œæ‰å‘ç°å…¶è¶Šæ¥è¶Šéšæ™¦ã€‚</li><li>åæ­£æˆ‘æ˜¯é‡åˆ°è¿‡å¾ˆå¤šé—®é¢˜ï¼Œéƒ½æ˜¯å› ä¸ºæ·»åŠ å¼•å·å¯¼è‡´çš„æœåŠ¡å¯åŠ¨å¼‚å¸¸çš„ï¼Œåæ¥å¾—å‡ºçš„ç»“è®ºå°±æ˜¯ä¸€å¾‹ä¸ä½¿å¼•å·ã€‚è£¸å¥”ï¼Œä½“éªŒå‰æ‰€æœªæœ‰çš„çˆ½å¿«ï¼ç›´åˆ°ç°åœ¨çœ‹åˆ°äº† <code>Github</code> ä¸­å¯¹åº”çš„ <a href="https://github.com/docker/compose/issues/2854" target="_blank" rel="noopener">issus</a> ä¹‹åï¼Œæ‰ç»ˆäºç ´æ¡ˆäº†ã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åœ¨Composeä¸­è¿›è¡Œå¼•ç”¨TEST_VARå˜é‡ï¼Œæ— æ³•æ‰¾åˆ°</span></span><br><span class="line">TEST_VAR=<span class="string">"test"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨Composeä¸­è¿›è¡Œå¼•ç”¨TEST_VARå˜é‡ï¼Œå¯ä»¥æ‰¾åˆ°</span></span><br><span class="line">TEST_VAR=<span class="built_in">test</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åæ¥å‘ç°dockeræœ¬èº«å…¶å®å·²ç»æ­£ç¡®åœ°å¤„ç†äº†å¼•å·çš„ä½¿ç”¨</span></span><br><span class="line">docker run -it --rm -e TEST_VAR=<span class="string">"test"</span> <span class="built_in">test</span>:latest</span><br></pre></td></tr></table></figure><ul><li><strong>[è§£å†³æ–¹æ³•]</strong> å¾—åˆ°çš„ç»“è®ºå°±æ˜¯ï¼Œå› ä¸º <code>Compose</code> è§£æ <code>yaml</code> é…ç½®æ–‡ä»¶ï¼Œå‘ç°å¼•å·ä¹Ÿè¿›è¡Œäº†è§£é‡ŠåŒ…è£…ã€‚è¿™å°±å¯¼è‡´åŸæœ¬çš„ <code>TEST_VAR=&quot;test&quot;</code> è¢«è§£ææˆäº† <code>'TEST_VAR=&quot;test&quot;'</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨å¼•ç”¨çš„æ—¶å€™å°±æ— æ³•è·å–åˆ°å¯¹åº”çš„å€¼ã€‚ç°åœ¨è§£å†³æ–¹æ³•å°±æ˜¯ï¼Œä¸ç®¡æ˜¯æˆ‘ä»¬ç›´æ¥åœ¨é…ç½®æ–‡ä»¶æ·»åŠ ç¯å¢ƒå˜é‡æˆ–è€…ä½¿ç”¨ <code>env_file</code> é…ç½®æ–‡ä»¶ï¼Œèƒ½ä¸ä½¿ç”¨å¼•å·å°±ä¸é€‚ç”¨å¼•å·ã€‚</li><li>éœ€è¦æ³¨æ„çš„æ˜¯ç¯å¢ƒå˜é‡é…ç½®çš„æ˜¯æ—¥å¿—æ ¼å¼çš„è¯(<code>2022-01-01</code>)ï¼Œå¦‚æœä½¿ç”¨çš„æ˜¯ <code>Python</code> çš„ <code>yaml.load</code> æ¨¡å—çš„è¯ï¼Œä¼šè¢«å½“åšæ˜¯ <code>date</code> ç±»å‹çš„ï¼Œè¿™æ˜¯å¦‚æœå¸Œæœ›ä¿æŒåŸæ ·ä¿¡æ¯çš„è¯ï¼Œå¯ä»¥ä½¿ç”¨ <code>'</code>/<code>&quot;</code> å¼•èµ·æ¥å°†å…¶å˜æˆå­—ç¬¦ä¸²æ ¼å¼çš„ã€‚</li></ul><h2><span id="docker-åˆ é™¤é•œåƒæŠ¥é”™">Docker åˆ é™¤é•œåƒæŠ¥é”™</span></h2><blockquote><p><strong>æ— æ³•åˆ é™¤é•œåƒï¼Œå½’æ ¹åˆ°åº•è¿˜æ˜¯æœ‰åœ°æ–¹ç”¨åˆ°äº†ï¼</strong></p></blockquote><ul><li><strong>[é—®é¢˜èµ·å› ]</strong> æ¸…ç†æœå™¨ç£ç›˜ç©ºé—´çš„æ—¶å€™ï¼Œåˆ é™¤æŸä¸ªé•œåƒçš„æ—¶å€™æç¤ºå¦‚ä¸‹ä¿¡æ¯ã€‚æç¤ºéœ€è¦å¼ºåˆ¶åˆ é™¤ï¼Œä½†æ˜¯å‘ç°åŠæ—¶æ‰§è¡Œäº†å¼ºåˆ¶åˆ é™¤ä¾æ—§æ²¡æœ‰æ•ˆæœã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ é™¤é•œåƒ</span></span><br><span class="line">$ docker rmi 3ccxxxx2e862</span><br><span class="line">Error response from daemon: conflict: unable to delete 3ccxxxx2e862 (cannot be forced) - image has dependent child images</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¼ºåˆ¶åˆ é™¤</span></span><br><span class="line">$ dcoker rmi -f 3ccxxxx2e862</span><br><span class="line">Error response from daemon: conflict: unable to delete 3ccxxxx2e862 (cannot be forced) - image has dependent child images</span><br></pre></td></tr></table></figure><ul><li><strong>[è§£å†³æ–¹æ³•]</strong> åæ¥æ‰å‘ç°ï¼Œå‡ºç°è¿™ä¸ªåŸå› ä¸»è¦æ˜¯å› ä¸º <code>TAG</code>ï¼Œå³å­˜åœ¨å…¶ä»–é•œåƒå¼•ç”¨äº†è¿™ä¸ªé•œåƒã€‚è¿™é‡Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹å¯¹åº”é•œåƒæ–‡ä»¶çš„ä¾èµ–å…³ç³»ï¼Œç„¶åæ ¹æ®å¯¹åº” <code>TAG</code> æ¥åˆ é™¤é•œåƒã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥è¯¢ä¾èµ– - image_idè¡¨ç¤ºé•œåƒåç§°</span></span><br><span class="line">$ docker image inspect --format=<span class="string">'&#123;&#123;.RepoTags&#125;&#125; &#123;&#123;.Id&#125;&#125; &#123;&#123;.Parent&#125;&#125;'</span> $(docker image ls -q --filter since=&lt;image_id&gt;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ ¹æ®TAGåˆ é™¤é•œåƒ</span></span><br><span class="line">$ docker rmi -f c565xxxxc87f</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ é™¤æ‚¬ç©ºé•œåƒ</span></span><br><span class="line">$ docker rmi $(docker images --filter <span class="string">"dangling=true"</span> -q --no-trunc)</span><br></pre></td></tr></table></figure><h2><span id="docker-æ™®é€šç”¨æˆ·åˆ‡æ¢">Docker æ™®é€šç”¨æˆ·åˆ‡æ¢</span></h2><blockquote><p><strong>åˆ‡æ¢ Docker å¯åŠ¨ç”¨æˆ·çš„è¯ï¼Œè¿˜æ˜¯éœ€è¦æ³¨æ„ä¸‹æƒé™é—®é¢˜çš„ï¼</strong></p></blockquote><ul><li><strong>[é—®é¢˜èµ·å› ]</strong> æˆ‘ä»¬çŸ¥é“åœ¨ <code>Docker</code> å®¹å™¨é‡Œé¢ä½¿ç”¨ <code>root</code> ç”¨æˆ·çš„è¯ï¼Œæ˜¯ä¸å®‰å…¨çš„ï¼Œå¾ˆå®¹æ˜“å‡ºç°è¶Šæƒçš„å®‰å…¨é—®é¢˜ï¼Œæ‰€ä»¥ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éƒ½ä¼šä½¿ç”¨æ™®é€šç”¨æˆ·æ¥ä»£æ›¿ <code>root</code> è¿›è¡ŒæœåŠ¡çš„å¯åŠ¨å’Œç®¡ç†çš„ã€‚ä»Šå¤©ç»™ä¸€ä¸ªæœåŠ¡åˆ‡æ¢ç”¨æˆ·çš„æ—¶å€™ï¼Œå‘ç° <code>Nginx</code> æœåŠ¡ä¸€ç›´æ— æ³•å¯åŠ¨ï¼Œæç¤ºå¦‚ä¸‹æƒé™é—®é¢˜ã€‚å› ä¸ºå¯¹åº”çš„é…ç½®æ–‡ä»¶ä¹Ÿæ²¡æœ‰é…ç½® <code>var</code> ç›¸å…³çš„ç›®å½•ï¼Œæ— å¥ˆ ğŸ¤·â€â™€ ï¼ï¸</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># NginxæŠ¥é”™ä¿¡æ¯</span></span><br><span class="line">nginx: [alert] could not open error <span class="built_in">log</span> file: open() <span class="string">"/var/log/nginx/error.log"</span> failed (13: Permission denied)</span><br><span class="line">2020/11/12 15:25:47 [emerg] 23<span class="comment">#23: mkdir() "/var/cache/nginx/client_temp" failed (13: Permission denied)</span></span><br></pre></td></tr></table></figure><ul><li><strong>[è§£å†³æ–¹æ³•]</strong> åæ¥å‘ç°è¿˜æ˜¯ <code>nginx.conf</code> é…ç½®æ–‡ä»¶ï¼Œé…ç½®çš„æœ‰é—®é¢˜ï¼Œéœ€è¦å°† <code>Nginx</code> æœåŠ¡å¯åŠ¨æ—¶å€™éœ€è¦çš„æ–‡ä»¶éƒ½é…ç½®åˆ°ä¸€ä¸ªæ— æƒé™çš„ç›®å½•ï¼Œå³å¯è§£å†³ã€‚</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">user  www-data;</span><br><span class="line">worker_processes  1;</span><br><span class="line"></span><br><span class="line">error_log  &#x2F;data&#x2F;logs&#x2F;master_error.log warn;</span><br><span class="line">pid        &#x2F;dev&#x2F;shm&#x2F;nginx.pid;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       &#x2F;etc&#x2F;nginx&#x2F;mime.types;</span><br><span class="line">    default_type  application&#x2F;octet-stream;</span><br><span class="line"></span><br><span class="line">    gzip               on;</span><br><span class="line">    sendfile           on;</span><br><span class="line">    tcp_nopush         on;</span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">    client_body_temp_path  &#x2F;tmp&#x2F;client_body;</span><br><span class="line">    fastcgi_temp_path      &#x2F;tmp&#x2F;fastcgi_temp;</span><br><span class="line">    proxy_temp_path        &#x2F;tmp&#x2F;proxy_temp;</span><br><span class="line">    scgi_temp_path         &#x2F;tmp&#x2F;scgi_temp;</span><br><span class="line">    uwsgi_temp_path        &#x2F;tmp&#x2F;uwsgi_temp;</span><br><span class="line"></span><br><span class="line">    include &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;*.conf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="docker-ç»‘å®šåˆ°-ipv6-ä¸Š">Docker ç»‘å®šåˆ° IPv6 ä¸Š</span></h2><blockquote><p><strong>Docker æœåŠ¡åœ¨å¯åŠ¨çš„æ—¶å€™ï¼Œå°†åœ°å€ç»‘å®šåˆ° IPv6 åœ°å€ä¸Šé¢äº†ï¼Œæç¤ºæŠ¥é”™ä¿¡æ¯ï¼</strong></p></blockquote><ul><li><strong>[é—®é¢˜èµ·å› ]</strong> ç‰©ç†æœºå™¨æ›´æ–°äº†å¯¹åº”è¡¥ä¸ä¹‹åï¼Œé‡å¯äº†æœåŠ¡ï¼Œå¯¼è‡´åŸæœ¬å¯ä»¥æ­£å¸¸å¯åŠ¨çš„ <code>docker-compose</code> æœåŠ¡æç¤ºå¦‚ä¸‹æŠ¥é”™ä¿¡æ¯ã€‚ä¸æ¸…æ¥šæ˜¯å¦ä¿®æ”¹äº†æ“ä½œç³»ç»Ÿçš„ç›¸å…³é…ç½®ï¼Œè¿˜æ˜¯å¯¹åº” <code>docker</code> è¿›è¡Œçš„å…¶ä»–æ–¹é¢çš„é…ç½®ï¼Œæ¯”å¦‚ä¿®æ”¹ <code>/etc/docker/daemon.json</code> æˆ–è€… <code>docker</code> çš„ <code>service</code> å¯åŠ¨æ–‡ä»¶ã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Dockerçš„æŠ¥é”™ä¿¡æ¯</span></span><br><span class="line">docker run -p 80:80 nginx:alpine succeeds. Previously, this was failing with Error \</span><br><span class="line">starting userland proxy: listen tcp6 [::]:80: socket: address family not supported by protocol.</span><br></pre></td></tr></table></figure><ul><li><strong>[è§£å†³æ–¹æ³•]</strong> é€šè¿‡å¦‚ä¸Šæ‰€ç¤ºçš„æŠ¥é”™ä¿¡æ¯ï¼Œå¯ä»¥çœ‹åˆ°æœåŠ¡çš„å¯åŠ¨ç«¯å£ç»‘å®šåˆ°äº† <code>tcp6</code> ä¸Šé¢äº†ï¼Œä½†æ˜¯å¯¹åº”çš„ <code>socket</code> å‘ç°ç³»ç»Ÿæœ¬èº«å¹¶ä¸æ”¯æŒã€‚è¿™æ—¶ï¼Œæˆ‘ä»¬ä¸€çœ‹ä¸‹å¯¹åº”çš„æ“ä½œç³»ç»Ÿ <code>ipv6</code> çš„è®¾ç½®ï¼Œå‘ç°ç³»ç»Ÿç¦ç”¨äº†ï¼Œæ‰€æœ‰çš„ <code>ipv6</code> åœ°å€ã€‚éœ€è¦äº†è§£çš„æœ‹å‹ï¼Œå¯ä»¥å‚è€ƒ <a href="https://github.com/moby/moby/pull/42322" target="_blank" rel="noopener">fix port forwarding with ipv6.disable=1</a> å’Œ <a href="https://github.com/moby/moby/issues/42288" target="_blank" rel="noopener">cannot start if ipv6 is disabled on host</a> è¿™ä¸¤ä¸ª <code>issus</code> æ¥è·å–æ›´å¤šä¿¡æ¯ã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ“ä½œç³»ç»Ÿé…ç½®</span></span><br><span class="line">$ cat /etc/sysctl.conf | grep ipv6</span><br><span class="line">net.ipv6.conf.all.disable_ipv6=1</span><br></pre></td></tr></table></figure><ul><li><strong>[æ–¹æ³•ä¸€]</strong> æœ€ä¸ºç®€å•çš„è§£å†³æ–¹æ³•ï¼Œå°±æ˜¯åœ¨ <code>docker-compose.yml</code> æ–‡ä»¶ä¸­ï¼Œæ‰‹åŠ¨æŒ‡å®šå°†å¯¹åº”æœåŠ¡çš„ç«¯å£ç»‘å®šåˆ° <code>ipv4</code> ä¸Šé¢ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">version: &quot;3&quot;</span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">  app:</span><br><span class="line">    restart: on-failure</span><br><span class="line">    container_name: app_web</span><br><span class="line">    image: app:latest</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;0.0.0.0:80:80&#x2F;tcp&quot;</span><br><span class="line">    volumes:</span><br><span class="line">      - &quot;.&#x2F;app_web:&#x2F;data&quot;</span><br><span class="line">    networks:</span><br><span class="line">      - app_network</span><br><span class="line"></span><br><span class="line">networks:</span><br><span class="line">  app_network:</span><br></pre></td></tr></table></figure><ul><li><strong>[æ–¹æ³•äºŒ]</strong> æˆ–è€…ä¿®æ”¹ <code>/etc/docker/daemon.json</code> æ–‡ä»¶ï¼Œåœ¨é…ç½®ä¸­ï¼Œé˜»æ­¢ <code>Docker</code> é”™è¯¯çš„å°†ç«¯å£æ˜ å°„åˆ° <code>IPv6</code> ä¸Šï¼Œå³å¯è¾¾åˆ°åŒæ ·çš„æ•ˆæœï¼Œä¸”ä¸ç”¨å†æ¬¡ä¿®æ”¹å¤šä¸ªæœåŠ¡çš„å¯åŠ¨é…ç½®æ–‡ä»¶äº†ã€‚</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># ä¿®æ”¹é…ç½®</span><br><span class="line">$ vim &#x2F;etc&#x2F;docker&#x2F;daemon.json</span><br><span class="line">&#123;</span><br><span class="line">  &quot;ipv6&quot;: false,</span><br><span class="line">  &quot;fixed-cidr-v6&quot;: &quot;2001:db8:1::&#x2F;64&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># é‡å¯æœåŠ¡</span><br><span class="line">$ systemctl reload docker</span><br></pre></td></tr></table></figure><ul><li><strong>[æ–¹æ³•ä¸‰]</strong> <code>Docker</code> é»˜è®¤æƒ…å†µä¸‹ä¼šåŒæ—¶å°†ç«¯å£æ˜ å°„äº <code>IPv4</code> ä¸ <code>IPv6</code> ä¸¤è€…ä¸Šï¼Œè€Œä¸”æœ‰çš„æ—¶å€™ä¼šå‡ºç°åªç»‘å®šåˆ°äº† <code>IPv6</code>ï¼Œå¯¼è‡´æœåŠ¡æ— æ³•æ­£å¸¸è®¿é—®çš„æƒ…å†µã€‚ç°åœ¨é€šç”¨çš„å§‹ç»ˆè¿˜æ˜¯ <code>IPv4</code> åœ°å€ï¼Œå› æ­¤æœ€ç®€å•çš„åšæ³•å°±æ˜¯å…³é—­ <code>IPv6</code> åœ°å€ã€‚è¯¦ç»†çš„é…ç½®ï¼Œå¯ä»¥å‚è€ƒ <a href="https://github.com/moby/moby/issues/2174" target="_blank" rel="noopener">Port redirecting binding to IPv6 but not IPv4 interfaces</a> è¿™ä¸ª <code>issus</code> åœ°å€ã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¿®æ”¹ç³»ç»Ÿé…ç½®</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">'1'</span> &gt; /proc/sys/net/ipv6/conf/lo/disable_ipv6</span><br><span class="line"><span class="built_in">echo</span> <span class="string">'1'</span> &gt; /proc/sys/net/ipv6/conf/lo/disable_ipv6</span><br><span class="line"><span class="built_in">echo</span> <span class="string">'1'</span> &gt; /proc/sys/net/ipv6/conf/all/disable_ipv6</span><br><span class="line"><span class="built_in">echo</span> <span class="string">'1'</span> &gt; /proc/sys/net/ipv6/conf/default/disable_ipv6</span><br><span class="line"></span><br><span class="line"><span class="comment"># é‡å¯ç½‘ç»œ</span></span><br><span class="line">$ /etc/init.d/networking restart</span><br><span class="line"></span><br><span class="line"><span class="comment"># æœ€åæ£€æµ‹æ˜¯å¦å·²å…³é—­IPv6</span></span><br><span class="line">ip addr show | grep net6</span><br></pre></td></tr></table></figure><h2><span id="docker-å®¹å™¨å¯åŠ¨è¶…æ—¶">Docker å®¹å™¨å¯åŠ¨è¶…æ—¶</span></h2><blockquote><p><strong>Docker æœåŠ¡åœ¨å¯åŠ¨çš„æ—¶å€™ï¼Œæç¤ºè¶…æ—¶ï¼Œè¢«ç›´æ¥ç»ˆæ­¢äº†ï¼</strong></p></blockquote><ul><li><strong>[é—®é¢˜èµ·å› ]</strong> ä½¿ç”¨ <code>docker-compose</code> å¯åŠ¨å®¹å™¨çš„æ—¶å€™ï¼Œç­‰å¾…äº†å¾ˆä¹…çš„æ—¶å€™(å¤§çº¦ <code>2-3</code> åˆ†é’Ÿå·¦å³)ï¼Œä¹‹åæç¤ºå¦‚ä¸‹ä¿¡æ¯ã€‚é€šè¿‡é˜…è¯»ä¿¡æ¯å†…å®¹ï¼Œå¯ä»¥çœ‹åˆ°æ˜¯å› ä¸ºè¶…æ—¶å¯¼è‡´çš„ï¼Œæç¤ºå¯ä»¥é€šè¿‡è®¾ç½®ç¯å¢ƒå˜é‡ï¼ŒåŠ å¤§è¶…æ—¶çš„æ—¶é—´ã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ docker-compose up -d</span><br><span class="line">ERROR: <span class="keyword">for</span> xxx  UnixHTTPConnectionPool(host=<span class="string">'localhost'</span>, port=None): Read timed out. (<span class="built_in">read</span> timeout=70)</span><br><span class="line">ERROR: An HTTP request took too long to complete. Retry with --verbose to obtain debug information.</span><br><span class="line">If you encounter this issue regularly because of slow network conditions, consider setting COMPOSE_HTTP_TIMEOUT to a higher value (current value: 60).</span><br></pre></td></tr></table></figure><ul><li><strong>[è§£å†³æ–¹æ³•]</strong> æŒ‰ç…§æç¤ºè®¾ç½®çš„ç¯å¢ƒå˜é‡ä¹‹åï¼Œå†æ¬¡å¯åŠ¨å‘ç°ç¡®å®å¯ä»¥æ­£å¸¸å¯åŠ¨äº†ï¼Œä½†æ˜¯è¿˜æ˜¯èƒ½å¤Ÿæ„Ÿè§‰åˆ°æœ‰äº›æ…¢ã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo vim /etc/profile</span><br><span class="line"><span class="built_in">export</span> COMPOSE_HTTP_TIMEOUT=500</span><br><span class="line"><span class="built_in">export</span> DOCKER_CLIENT_TIMEOUT=500</span><br></pre></td></tr></table></figure><ul><li>æ’é™¤äº†ä¸‹å¯åŠ¨æµç¨‹ï¼Œå› ä¸ºå®¹å™¨å¯åŠ¨æœ‰æ˜ å°„ç›®å½•åˆ°å®¹å™¨é‡Œé¢ä¸”ç›®å½•å¤§å°æ¯”è¾ƒå¤§ï¼Œæ‰€ä»¥æ€€ç–‘æ˜¯å› ä¸º <code>i/o</code> å¯¼è‡´çš„ã€‚éšå³ä½¿ç”¨ <code>iotop</code> å‘½ä»¤æŸ¥çœ‹æœåŠ¡å™¨ç›®å‰çš„ <code>i/o</code> æƒ…å†µï¼Œå‘ç°å­˜åœ¨å¾ˆå¤šä¸ª <code>rg</code> å‘½ä»¤ï¼Œä¸”éƒ½å¤„äº <code>100%</code> å·¦å³ã€‚æŸ¥äº†ä¸‹ï¼Œå‘ç°æ˜¯ <code>vscode</code> è¿œç¨‹æœåŠ¡å™¨å¯åŠ¨çš„æœç´¢ç›®å½•ç»“æ„çš„è¿›ç¨‹ï¼Œè¥¿å…«ï¼Œæœ‰äº›å‘å‘€ï¼</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ sudo iotop</span><br><span class="line"> 4269 be/4 escape     15.64 K/s    0.00 B/s  0.00 % 98.36 % rg --files --hidden</span><br><span class="line"> 4270 be/4 escape     28.15 K/s    0.00 B/s  0.00 % 97.46 % rg --files --hidden</span><br><span class="line"> 4272 be/4 escape     31.27 K/s    0.00 B/s  0.00 % 97.39 % rg --files --hidden</span><br><span class="line"> 4276 be/4 escape     34.40 K/s    0.00 B/s  0.00 % 96.98 % rg --files --hidden</span><br></pre></td></tr></table></figure><h2><span id="docker-ç«¯å£ç½‘ç»œé™åˆ¶">Docker ç«¯å£ç½‘ç»œé™åˆ¶</span></h2><blockquote><p><strong>å¦‚æœå‘ç°æœåŠ¡éƒ½ä¸€åˆ‡æ­£å¸¸ï¼Œä½†æ˜¯æ— æ³•æ— æ³•è®¿é—®çš„è¯ï¼Œåˆ™å¤šä¸ºç½‘ç»œé—®é¢˜ï¼</strong></p></blockquote><ul><li><strong>[é—®é¢˜èµ·å› ]</strong> å¯ç”¨æœåŠ¡ä¹‹åï¼Œç™»å½•è·³è½¬å‘ç°ç›´æ¥ <code>502</code> æŠ¥é”™äº†ã€‚æ’é™¤äº†é…ç½®ç­‰ç›¸å…³åŸå› éƒ½æ²¡æœ‰ä»»ä½•é—®é¢˜(åšè¿‡ç›¸å…³æµ‹è¯•)ï¼Œè¿™å°±éå¸¸å¥‡æ€ªäº†ï¼</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># éƒ¨ç½²æœåŠ¡æ¶æ„</span></span><br><span class="line">nginx(80) -&gt; web1(8080)</span><br><span class="line">          -&gt; web2(8081)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŠ¥é”™ä¿¡æ¯å¦‚ä¸‹æ‰€ç¤º</span></span><br><span class="line">nginx connect() failed (113: No route to host) <span class="keyword">while</span> connecting to upstream</span><br></pre></td></tr></table></figure><ul><li><strong>[è§£å†³æ–¹æ³•]</strong> æ ¹æ®é”™è¯¯ä¿¡æ¯å¯çŸ¥ï¼Œæ˜¯å› ä¸ºæ²¡æœ‰è·¯ç”±åˆ°æŒ‡å®šçš„ <code>host</code> å¯¼è‡´äº†ï¼Œéšå³çœ‹äº†ä¸‹é˜²ç«å¢™æ˜¯å¼€ç€çš„ï¼Œçœ‹äº†æ—¥å¿—å‘ç°è¢«è¿‡æ»¤æ‰äº†ï¼Œè¥¿å…«ï¼é—®é¢˜æ‰¾åˆ°äº†ï¼Œç°åœ¨éœ€è¦åšçš„å°±æ˜¯ï¼Œè¦ä¹ˆæ·»åŠ é˜²ç«å¢™è§„åˆ™ï¼Œè¦ä¹ˆå…³é—­é˜²ç«å¢™ã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ£€æŸ¥å¼€æ”¾çš„ç«¯å£</span></span><br><span class="line">$ sudo firewall-cmd --permanent --zone=public --list-ports</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¼€å¯éœ€è¦è·¯ç”±çš„ç«¯å£</span></span><br><span class="line">$ sudo firewall-cmd --permanent --zone=public --add-port=8080/tcp</span><br><span class="line">$ sudo firewall-cmd --permanent --zone=public --add-port=8081/tcp</span><br><span class="line"></span><br><span class="line"><span class="comment"># é…ç½®ç«‹å³ç”Ÿæ•ˆ</span></span><br><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å…³é—­é˜²ç«å¢™</span></span><br><span class="line">$ sudo systemctl stop firewalld.service</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¦ç”¨è‡ªå¯åŠ¨</span></span><br><span class="line">$ sudo systemctl <span class="built_in">disable</span> firewalld.service</span><br></pre></td></tr></table></figure><h2><span id="docker-æ— æ³•è·å–é•œåƒ">Docker æ— æ³•è·å–é•œåƒ</span></h2><blockquote><p><strong>æ–°åˆå§‹åŒ–çš„æœºå™¨ï¼Œæ— æ³•è·å–ç§æœ‰ä»“åº“çš„é•œåƒæ–‡ä»¶ï¼</strong></p></blockquote><ul><li><strong>[é—®é¢˜èµ·å› ]</strong> æœºå™¨åˆå§‹åŒ–ä¹‹åï¼Œä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ç™»å½•ç§æœ‰ <code>docker</code> ä»“åº“ï¼Œå‘ç°æç¤ºæ— æ³•è·å–å¯¹åº”é•œåƒï¼Œä½†æ˜¯åœ¨å…¶ä»–æœºå™¨ä¸Šé¢è·å–è¯¥é•œåƒå°±å¯ä»¥æ‰§è¡ŒæˆåŠŸï¼Œè¿™å°±éå¸¸å¥‡æ€ªäº†ï¼</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç™»å½•ç§æœ‰ä»“åº“</span></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">'123456'</span> | docker login -u escape --password-stdin docker.escapelife.site</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¼‚å¸¸ä¿¡æ¯æç¤º</span></span><br><span class="line">$ sudo docker pull docker.escapelife.site/app:0.10</span><br><span class="line">Error response from daemon: manifest <span class="keyword">for</span> docker.escapelife.site/app:0.10 not found: manifest unknown: manifest unknown</span><br></pre></td></tr></table></figure><ul><li><strong>[è§£å†³æ–¹æ³•]</strong> å¤ªå‘äº†ï¼Œæˆ‘è¿˜ä»¥ä¸ºæˆ‘å‘ç°æŸä¸ªéšè—çš„ <code>bug</code> äº†ï¼Œå¯åŠ²çš„æ’æŸ¥ï¼Œæœ€åå‘ç°ï¼ŒåŸæ¥æ˜¯è‡ªå·±é•œåƒåŒ…åå­—å†™é”™äº†ï¼Œåº”è¯¥å†™æˆ <code>0.0.10</code> çš„ï¼Œè‡ªå·±å´å†™æˆäº† <code>0.10</code>ã€‚è¿™é‡Œï¼Œçºªå¿µä¸€ä¸‹ï¼Œä»¥åç¢°åˆ°ä¸Šè¿°æŠ¥é”™ï¼Œé‚£è‚¯å®šæ˜¯é•œåƒä¸å­˜åœ¨çš„ã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç™»å½•ç§æœ‰ä»“åº“ä¹‹åä¼šåœ¨ç”¨æˆ·å®¶ç›®å½•ä¸‹ç”Ÿæˆä¸€ä¸ªdockeré…ç½®</span></span><br><span class="line"><span class="comment"># å…¶ç”¨æ¥è®°å½•dockerç§æœ‰ä»“åº“çš„ç™»å½•è®¤è¯ä¿¡æ¯(æ˜¯åŠ å¯†è¿‡çš„ä¿¡æ¯ä½†ä¸å®‰å…¨) =&gt; base64</span></span><br><span class="line">$ cat .docker/config.json</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"auths"</span>: &#123;</span><br><span class="line">        <span class="string">"docker.escapelife.site"</span>: &#123;</span><br><span class="line">            <span class="string">"auth"</span>: <span class="string">"d00u11Fu22B3355VG2xasE12w=="</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="docker-ä½¿å®¹å™¨ä¸é€€å‡º">Docker ä½¿å®¹å™¨ä¸é€€å‡º</span></h2><blockquote><p><strong>å¦‚ä½•ä½¿ä½¿ç”¨ docker-compose å¯åŠ¨çš„å®¹å™¨æœåŠ¡ hang ä½è€Œä¸é€€å‡º</strong></p></blockquote><ul><li><strong>[é—®é¢˜èµ·å› ]</strong> æœ‰æ—¶å€™æˆ‘ä»¬å¯åŠ¨çš„æœåŠ¡ï¼Œå› ä¸ºæŸäº›é—®é¢˜(<code>bug</code>)å¯¼è‡´æœåŠ¡æ— æ³•æ­£å¸¸å¯åŠ¨ï¼Œå°±ä¼šå‡ºç°å®¹å™¨æ— é™é‡å¯(<code>restart: on-failure</code>)çš„æƒ…å†µï¼Œè¿™æ—¶å°±å¾ˆä¸åˆ©äºæ’é™¤é—®é¢˜ã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">âœ docker ps -a</span><br><span class="line">4e6xxx9a4   app:latest   <span class="string">"/xxx/â€¦"</span>   26 seconds ago   Restarting (1) 2 seconds ago</span><br></pre></td></tr></table></figure><ul><li><strong>[è§£å†³æ–¹æ³•]</strong> è¿™æ—¶æˆ‘ä»¬å°±éœ€è¦æ ¹æ®ï¼ŒæœåŠ¡æ„å»ºä½¿ç”¨å‘½ä»¤æ¥å†³å®šæ˜¯ç”¨ä»€ä¹ˆå‘½ä»¤æ¥ <code>hang</code> ä½æœåŠ¡ã€‚å¡ä½çš„åŸç†ï¼Œå°±ç±»ä¼¼äºä½¿ç”¨ <code>/bin/bash</code> è¿›å…¥å®¹å™¨æ˜¯ä¸€æ ·çš„ï¼Œè¿™é‡Œæˆ‘å°±ä¸è¿‡å¤šè§£é‡Šäº†ã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç±»ä¼¼åŸç†</span></span><br><span class="line">docker run -it --rm --entrypoint=/bin/bash xxx/app:latest</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨Commandå‘½ä»¤</span></span><br><span class="line">tty: <span class="literal">true</span></span><br><span class="line"><span class="built_in">command</span>: tail -f /dev/null</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨Entrypointå‘½ä»¤</span></span><br><span class="line">tty: <span class="literal">true</span></span><br><span class="line">entrypoint: tail -f /dev/null</span><br></pre></td></tr></table></figure><ul><li>åŒç†ï¼Œæˆ‘ä»¬åœ¨ä½¿ç”¨ <code>docker-compose</code> æˆ–è€… <code>k8s</code> å¹³å°éƒ¨ç½²æœåŠ¡çš„æ—¶å€™ï¼Œä¹Ÿæœ‰æ—¶ä¼šå› ä¸ºå¯åŠ¨é—®é¢˜éœ€è¦ï¼Œä½¿å¯åŠ¨çš„æœåŠ¡ä¸ç›´æ¥é€€å‡ºï¼Œæ¥æ‰‹åŠ¨è°ƒè¯•å’Œæ’æŸ¥é—®é¢˜åŸå› ã€‚æ‰€ä»¥ï¼Œæˆ‘è¿™é‡Œè®°å½•ä¸‹å…¶ä¸åŒéƒ¨ç½²æ–¹å¼çš„ï¼Œæš‚åœæ–¹å¼ã€‚</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># Compose</span><br><span class="line"></span><br><span class="line">version: &quot;3&quot;</span><br><span class="line">services:</span><br><span class="line">  app:</span><br><span class="line">    image: ubuntu:latest</span><br><span class="line">    tty: true</span><br><span class="line">    entrypoint: &#x2F;usr&#x2F;bin&#x2F;tail</span><br><span class="line">    command: &quot;-f &#x2F;dev&#x2F;null&quot;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># K8S</span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: ubuntu</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">    - name: ubuntu</span><br><span class="line">      image: ubuntu:latest</span><br><span class="line">      command: [&quot;&#x2F;bin&#x2F;bash&quot;, &quot;-c&quot;, &quot;--&quot;]</span><br><span class="line">      args: [&quot;while true; do sleep 30; done;&quot;]</span><br><span class="line">      # command: [&quot;sleep&quot;]</span><br><span class="line">      # args: [&quot;infinity&quot;]</span><br></pre></td></tr></table></figure><h2><span id="docker-ä¸ä½¿ç”¨é»˜è®¤ç½‘æ®µ">Docker ä¸ä½¿ç”¨é»˜è®¤ç½‘æ®µ</span></h2><blockquote><p><strong>æœ‰äº›æƒ…å†µï¼Œå†…éƒ¨è§„åˆ’çš„ç½‘æ®µå’Œå¯èƒ½å’Œ Dockerd é»˜è®¤çš„ç½‘æ®µæœ‰å†²çªï¼Œå¯¼è‡´å¼‚å¸¸å‡ºç°ï¼</strong></p></blockquote><ul><li><strong>[é—®é¢˜èµ·å› ]</strong> ä»Šå¤©åœ¨æ–°æœºå™¨ä¸Šé¢ï¼Œéƒ¨ç½²äº†ä¸€æ•´å¥—æœåŠ¡(å¤šå°æœºå™¨)ï¼ŒæœåŠ¡éƒ¨ç½²å®Œæ¯•ä¹‹åï¼Œé€šè¿‡å‰ç½® <code>Nginx</code> æœåŠ¡å‘ç°å¹¶ä¸èƒ½è®¿é—®ï¼Œåç½®æœºå™¨å¼€æ”¾çš„ç«¯å£ï¼Œå‘ç°å‘åˆ°å¯¹åº”ç«¯å£çš„è¯·æ±‚éƒ½æ²¡æœ‰è½¬å‘å‡ºå»ã€‚è¿™å°±æ¯”è¾ƒå¥‡æ€ªäº†ï¼Œå› ä¸ºç«¯å£æ§åˆ¶æ˜¯å·²ç»å¼€é€šäº†çš„ï¼Œä¸åº”è¯¥å‡ºç°ä¸é€šçš„æƒ…å†µã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">âœ nc -v 172.16.100.12 8000</span><br><span class="line">nc: connect to 172.16.100.12 port 8000 (tcp) failed: Connection refused</span><br></pre></td></tr></table></figure><ul><li><strong>[è§£å†³æ–¹æ³•]</strong> å‘ç°æœåŠ¡å™¨ç«¯å£ä¸é€šï¼Œæˆ‘è¿™é‡Œæ€€ç–‘å¯èƒ½æ˜¯ <code>dockerd</code> æœåŠ¡å¯åŠ¨å¯¼è‡´çš„ï¼Œæ‰€ä»¥æˆ‘å…ˆå°†æœåŠ¡éƒ½åœæ‰ï¼Œç›´æ¥åœ¨æœºå™¨ä¸Šé¢å¯åŠ¨äº† <code>Python</code> çš„æœåŠ¡ç«¯ç¨‹åº(<code>Linux</code> æœºå™¨è‡ªå¸¦ <code>Python2.7.x</code> çš„ç‰ˆæœ¬)ï¼Œç„¶ååœ¨å‰ç½® <code>Nginx</code> æœåŠ¡å‘ç°ï¼Œç«¯å£ç¡®å®æ˜¯é€šçš„ã€‚åæ¥ï¼Œæ’é™¤å‘ç°æ˜¯å†…éƒ¨æœåŠ¡é»˜è®¤ç½‘æ®µå’Œ <code>dockerd</code> æœåŠ¡å¯åŠ¨çš„é»˜è®¤ç½‘æ®µæ˜¯å†²çªçš„ï¼Œå¯¼è‡´é‡å†™äº†æœºå™¨çš„é˜²ç«å¢™è§„åˆ™ï¼Œå¯¼è‡´å‡ºç°ä¸Šè¿°å¼‚å¸¸çš„ã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ python -m SimpleHTTPServer 8000</span><br><span class="line">Serving HTTP on 0.0.0.0 port 8000 ...</span><br><span class="line"></span><br><span class="line">âœ nc -v 172.16.100.12 8000</span><br><span class="line">Connection to 172.16.100.12 8000 port [tcp/*] succeeded!</span><br></pre></td></tr></table></figure><ul><li>æ—¢ç„¶é—®é¢˜å·²ç»çŸ¥é“äº†ï¼Œç°åœ¨éœ€è¦åšçš„å°±æ˜¯éå¸¸ç®€å•äº†ï¼šä¸é€‚ç”¨é»˜è®¤ç½‘æ®µï¼é€šè¿‡ <a href="https://docs.mirantis.com/mke/3.4/install/plan-deployment/mcr-considerations/default-address-pools.html" target="_blank" rel="noopener">ã€mirantisã€</a> é‡Œé¢ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©è¿›è¡Œè®¾ç½®ï¼Œç„¶åé‡å¯æœåŠ¡ <code>dockerd</code> æœåŠ¡ï¼Œå³å¯ã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¿®æ”¹é…ç½®</span></span><br><span class="line">$ sudo cat /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"default-address-pools"</span>:[&#123;<span class="string">"base"</span>:<span class="string">"192.168.100.0/20"</span>,<span class="string">"size"</span>:24&#125;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># é‡å¯æœåŠ¡</span></span><br><span class="line">$ sudo systemctl restart docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯åŠ¨æœåŠ¡éªŒè¯æ˜¯å¦ç”Ÿæ•ˆ</span></span><br><span class="line">$ ip a</span><br><span class="line">$ docker network inspect app | grep Subnet</span><br></pre></td></tr></table></figure><p><img src="https://img.hi-linux.com/staticfile/docker-have-some-trouble-7-2022-03-29-Ddg8C6.png" alt="Docker ä¸ä½¿ç”¨é»˜è®¤ç½‘æ®µ"></p><ul><li>è¿™æ—¶ï¼Œå°±åˆ°äº†è€ƒéªŒæˆ‘ä»¬ç½‘ç»œçš„å­ç½‘åˆ’åˆ†çš„èƒ½åŠ›äº†ï¼šå¦‚ä½•åœ¨ç»™å®šçš„ç½‘æ®µä¸‹é¢åˆç†ä¸”é«˜æ•ˆçš„è¿›è¡Œåˆ’åˆ†å‘¢ï¼Ÿå’³å’³ï¼Œç¡®å®éš¾å€’æˆ‘äº†ï¼Œè¿™æ—¶æˆ‘ä»¬å¯ä»¥å†è¿™ä¸ªåœ¨çº¿ç½‘ç«™ä¸Šé¢ <a href="https://www.sojson.com/convert/subnetmask.html" target="_blank" rel="noopener">JSON åœ¨çº¿è§£æ</a> è¿›è¡Œåˆ’åˆ†ï¼Œç„¶åé€‰å®šåˆç†çš„ <code>base</code> å’Œ <code>size</code> å°±å¯ä»¥äº†ã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŠ¥é”™ä¿¡æ¯</span></span><br><span class="line">Error response from daemon: could not find an available, non-overlapping IPv4 address pool among the defaults to assign to the network</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŒ‰ç…§ä¸‹å›¾æˆ‘ä»¬å¯ä»¥å¯¹ pool è¿›è¡Œåˆç†åˆ’åˆ†</span></span><br><span class="line"><span class="comment"># ç»™å®š 10.210.200.0 + 255.255.255.0 çš„ç½‘æ®µæ¥åˆ’åˆ†å­ç½‘</span></span><br><span class="line">$ sudo cat /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"default-address-pools"</span>:[&#123;<span class="string">"base"</span>:<span class="string">"10.210.200.0/24"</span>,<span class="string">"size"</span>:28&#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å…¶ä¸­ï¼Œ<code>base</code> å‘Šè¯‰æˆ‘ä»¬åˆ’åˆ†å­ç½‘çš„ç½‘æ®µæ˜¯ä»€ä¹ˆ(ä»æ¥å¼€å§‹)ï¼Œæ˜¯ä»å‰ä¸¤ä½(<code>/16</code>)å¼€å§‹ï¼Œè¿˜æ˜¯ç¬¬ä¸‰ä½å¼€å§‹(<code>/24</code>)å‘¢ï¼Ÿè€Œ <code>size</code> åˆ™å‘Šè¯‰æˆ‘ä»¬åˆ’åˆ†çš„æ¯ä¸ªå­ç½‘æœ‰å¤šå°‘ <code>IP</code> åœ°å€å¯ä»¥ä½¿ç”¨å‘¢ï¼Ÿä» <code>&quot;10.210.200.0/24&quot;</code> æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œè¯¥ç½‘ç»œä¸‹é¢åªæœ‰ <code>254</code> ä¸ªå¯ç”¨çš„ <code>IP</code> åœ°å€(ç›´æ¥ä½¿ç”¨è‚¯å®šä¸å¤Ÿ)ï¼Œç„¶åæˆ‘ä»¬éœ€è¦ç»™ <code>docker</code> ä½¿ç”¨ï¼Œåˆ’åˆ†æ¯ä¸ªå­ç½‘å¯ç”¨ <code>16</code> ä¸ª <code>IP</code> åœ°å€ï¼Œæ‰€ä»¥å­ç½‘å°±åº”è¯¥å†™æˆ <code>28</code> äº†ã€‚</li></ul><p><img src="https://img.hi-linux.com/staticfile/docker-have-some-trouble-8-2022-03-29-tYKsQu.png" alt="Docker ä¸ä½¿ç”¨é»˜è®¤ç½‘æ®µ"></p><h2><span id="docker-æ·»åŠ ç§æœ‰ä»“åº“">Docker æ·»åŠ ç§æœ‰ä»“åº“</span></h2><blockquote><p><strong>æœ‰äº›æƒ…å†µï¼Œæˆ‘ä»¬æœåŠ¡å™¨ä¸Šé¢éœ€è¦ä½¿ç”¨å†…éƒ¨ç§æœ‰çš„å®¹å™¨é•œåƒåœ°å€ï¼</strong></p></blockquote><ul><li><strong>[é—®é¢˜èµ·å› ]</strong> å¦‚æœæ–°æœºå™¨ä¸Šé¢éœ€è¦ä½¿ç”¨ç§æœ‰ä»“åº“çš„è¯ï¼Œä½†æ˜¯åˆæ²¡æœ‰é…ç½®ï¼Œå†è·å–é•œåƒçš„æ—¶å€™å°±ä¼šå‡ºç°å¦‚ä¸‹æŠ¥é”™ä¿¡æ¯ã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ‹‰å–/ç™»é™†ç§åº“æ—¶æç¤º</span></span><br><span class="line">$ docker pull 192.168.31.191:5000/nginx:latest</span><br><span class="line">x509: certificate signed by unknown authority</span><br></pre></td></tr></table></figure><ul><li><strong>[è§£å†³æ–¹æ³•]</strong> è¯¥é—®é¢˜çš„å¤„ç†æ–¹å¼å¾ˆç®€å•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼Œé…ç½®ä¸€ä¸‹ä»“åº“åœ°å€ï¼Œé‡å¯æœåŠ¡å¹¶ç™»é™†ç§æœ‰ä»“åº“å°±å¯ä»¥äº†ã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ·»åŠ é…ç½®</span></span><br><span class="line">$ sudo cat /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"insecure-registries"</span>: [<span class="string">"192.168.31.191:5000"</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># é‡å¯docker</span></span><br><span class="line">$ sudo systemctl restart docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># é‡æ–°ç™»å½•å³å¯</span></span><br><span class="line">$ docker login ç§åº“åœ°å€ -u ç”¨æˆ·å -p å¯†ç </span><br></pre></td></tr></table></figure><blockquote><p>æœ¬æ–‡è½¬è½½è‡ªï¼šã€Œ escapelife çš„åšå®¢ ã€ï¼ŒåŸæ–‡ï¼š<a href="https://tinyurl.com/2p89skum" target="_blank" rel="noopener">https://tinyurl.com/2p89skum</a> ï¼Œç‰ˆæƒå½’åŸä½œè€…æ‰€æœ‰ã€‚æ¬¢è¿æŠ•ç¨¿ï¼ŒæŠ•ç¨¿é‚®ç®±: <a href="mailto:editor@hi-linux.com">editor@hi-linux.com</a>ã€‚</p></blockquote></div><script src="https://my.openwrite.cn/js/readmore.js" type="text/javascript"></script><script>var isMobile = navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i);if (!isMobile) {    var btw = new BTWPlugin();    btw.init({        "id": "vip-container",        "blogId": "10135-1588830050631-449",        "name": "ã€Œå¥‡å¦™çš„ Linux ä¸–ç•Œã€",        "qrcode": "https://www.hi-linux.com/img/wechat/mp_qrcode_12.jpg",        "keyword": "VIP"    });}</script>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;è¿™é‡Œä¸»è¦æ˜¯ä¸ºäº†è®°å½•åœ¨ä½¿ç”¨ Docker çš„æ—¶å€™é‡åˆ°çš„é—®é¢˜åŠå…¶å¤„ç†è§£å†³æ–¹æ³•ã€‚&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;Docker-è¿ç§»å­˜å‚¨ç›®å½•&quot;&gt;Docker è¿ç§»å­˜å‚¨ç›®å½•&lt;/h2&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;é»˜è®¤æƒ…å†µç³»ç»Ÿä¼šå°† Docker å®¹å™¨å­˜æ”¾åœ¨ /var/lib/docker ç›®å½•ä¸‹&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;[é—®é¢˜èµ·å› ]&lt;/strong&gt; ä»Šå¤©é€šè¿‡ç›‘æ§ç³»ç»Ÿï¼Œå‘ç°å…¬å¸å…¶ä¸­ä¸€å°æœåŠ¡å™¨çš„ç£ç›˜å¿«æ…¢ï¼Œéšå³ä¸Šå»çœ‹äº†ä¸‹ï¼Œå‘ç° &lt;code&gt;/var/lib/docker&lt;/code&gt; è¿™ä¸ªç›®å½•ç‰¹åˆ«å¤§ã€‚ç”±ä¸Šè¿°åŸå› ï¼Œæˆ‘ä»¬éƒ½çŸ¥é“ï¼Œåœ¨ &lt;code&gt;/var/lib/docker&lt;/code&gt; ä¸­å­˜å‚¨çš„éƒ½æ˜¯ç›¸å…³äºå®¹å™¨çš„å­˜å‚¨ï¼Œæ‰€ä»¥ä¹Ÿä¸èƒ½éšä¾¿çš„å°†å…¶åˆ é™¤æ‰ã€‚&lt;/li&gt;
&lt;li&gt;é‚£å°±å‡†å¤‡è¿ç§» &lt;code&gt;docker&lt;/code&gt; çš„å­˜å‚¨ç›®å½•å§ï¼Œæˆ–è€…å¯¹ &lt;code&gt;/var&lt;/code&gt; è®¾å¤‡è¿›è¡Œæ‰©å®¹æ¥è¾¾åˆ°ç›¸åŒçš„ç›®çš„ã€‚æ›´å¤šå…³äº &lt;code&gt;dockerd&lt;/code&gt; çš„è¯¦ç»†å‚æ•°ï¼Œè¯·ç‚¹å‡»æŸ¥çœ‹ &lt;a href=&quot;https://docs.docker.com/engine/reference/commandline/dockerd/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;&lt;strong&gt;å®˜æ–¹æ–‡æ¡£&lt;/strong&gt;&lt;/a&gt; åœ°å€ã€‚&lt;/li&gt;
&lt;li&gt;ä½†æ˜¯éœ€è¦æ³¨æ„çš„ä¸€ç‚¹å°±æ˜¯ï¼Œå°½é‡ä¸è¦ç”¨è½¯é“¾ï¼Œ å› ä¸ºä¸€äº› &lt;code&gt;docker&lt;/code&gt; å®¹å™¨ç¼–æ’ç³»ç»Ÿä¸æ”¯æŒè¿™æ ·åšï¼Œæ¯”å¦‚æˆ‘ä»¬æ‰€ç†ŸçŸ¥çš„ &lt;code&gt;k8s&lt;/code&gt; å°±åœ¨å†…ã€‚&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
    
      <category term="Linux" scheme="https://www.hi-linux.com/categories/Linux/"/>
    
    
      <category term="æŠ€å·§" scheme="https://www.hi-linux.com/tags/%E6%8A%80%E5%B7%A7/"/>
    
      <category term="Linux" scheme="https://www.hi-linux.com/tags/Linux/"/>
    
      <category term="Docker" scheme="https://www.hi-linux.com/tags/Docker/"/>
    
  </entry>
  
  <entry>
    <title>Tailscale å¼€æºç‰ˆä¸­æ–‡éƒ¨ç½²æŒ‡å—ï¼ˆæ”¯æŒæ— é™è®¾å¤‡æ•°ã€è‡ªå®šä¹‰å¤šç½‘æ®µ ã€è‡ªå»ºä¸­ç»§ç­‰é«˜çº§ç‰¹æ€§ï¼‰</title>
    <link href="https://www.hi-linux.com/posts/15561.html"/>
    <id>https://www.hi-linux.com/posts/15561.html</id>
    <published>2022-03-30T01:00:00.000Z</published>
    <updated>2022-03-30T02:18:16.728Z</updated>
    
    <content type="html"><![CDATA[<div id="vip-container"><p><img src="https://img.hi-linux.com/staticfile/2022-03-21-11-13-q1TRI3-2022-03-30-ooh4UE.png" alt></p><p>ç›®å‰å›½å®¶å·¥ä¿¡éƒ¨åœ¨å¤§åŠ›æ¨åŠ¨ä¸‰å¤§è¿è¥å•†å‘å±• IPv6ï¼Œå¯¹å®¶ç”¨å®½å¸¦è€Œè¨€ï¼Œå¯ä»¥ä½¿ç”¨çš„ IPv4 å…¬ç½‘ IP ä¼šè¶Šæ¥è¶Šå°‘ã€‚æœ‰éƒ¨åˆ†åœ°åŒºå³ä½¿æ‹¿åˆ°äº†å…¬ç½‘ IPv4 åœ°å€ï¼Œä¹Ÿæ˜¯ä¸ªå¤§å†…ç½‘åœ°å€ï¼Œæ ¹æœ¬ä¸æ˜¯çœŸæ­£çš„å…¬ç½‘ IPï¼Œè®¿é—®å®¶åº­å†…ç½‘çš„èµ„æºå°†ä¼šå˜å¾—è¶Šæ¥è¶Šå›°éš¾ã€‚</p><p>éƒ¨åˆ†å°ä¼™ä¼´å¯èƒ½ä¼šé€‰æ‹©ä½¿ç”¨ frp ç­‰é’ˆå¯¹ç‰¹å®šåè®®å’Œç«¯å£çš„å†…ç½‘ç©¿é€æ–¹æ¡ˆï¼Œä½†è¿™ç§æ–¹æ¡ˆè¿˜æ˜¯ä¸å¤Ÿé…¸çˆ½ï¼Œæ— æ³•è®¿é—®å®¶åº­å†…ç½‘ä»»æ„è®¾å¤‡çš„ä»»æ„ç«¯å£ã€‚æ›´ä½³çš„é€‰æ‹©è¿˜æ˜¯é€šè¿‡ VPN æ¥ç»„å»ºå¤§å†…ç½‘ã€‚è‡³äºè¯¥é€‰æ‹©å“ªç§ VPNï¼Œæ¯«æ— ç–‘é—®è‚¯å®šæ˜¯ WireGuardï¼ŒWireGuard å°±æ˜¯ VPN çš„æœªæ¥ã€‚<strong>æˆ‘å·²ç»ä¸æ­¢ä¸€æ¬¡å‘å¤§å®¶æ¨èä½¿ç”¨ WireGuard äº†ï¼Œæˆ‘ç´¯äº†ï¼Œä¸æƒ³å†è®²äº†ï¼Œä½ çˆ± JB ç”¨è¾£é¸¡ OpenVPN ä¹‹ç±»çš„å°±ç”¨å§ï¼Œä½ å¼€å¿ƒå°±å¥½ã€‚</strong></p><p>WireGuard ç›¸æ¯”äºä¼ ç»Ÿ VPN çš„æ ¸å¿ƒä¼˜åŠ¿æ˜¯æ²¡æœ‰ VPN ç½‘å…³ï¼Œæ‰€æœ‰èŠ‚ç‚¹ä¹‹é—´éƒ½å¯ä»¥ç‚¹å¯¹ç‚¹ï¼ˆP2Pï¼‰è¿æ¥ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä¹‹å‰æåˆ°çš„<a href="https://fuckcloudnative.io/posts/wireguard-full-mesh/#1-%E5%85%A8%E4%BA%92%E8%81%94%E6%A8%A1%E5%BC%8F%E6%9E%B6%E6%9E%84%E4%B8%8E%E9%85%8D%E7%BD%AE" target="_blank" rel="noopener">å…¨äº’è”æ¨¡å¼ï¼ˆfull meshï¼‰</a>ï¼Œæ•ˆç‡æ›´é«˜ï¼Œé€Ÿåº¦æ›´å¿«ï¼Œæˆæœ¬æ›´ä½ã€‚</p><p>WireGuard ç›®å‰æœ€å¤§çš„ç—›ç‚¹å°±æ˜¯ä¸Šå±‚åº”ç”¨çš„åŠŸèƒ½ä¸å¤Ÿå¥å…¨ï¼Œå› ä¸º WireGuard æ¨å´‡çš„æ˜¯ Unix çš„å“²å­¦ï¼ŒWireGuard æœ¬èº«åªæ˜¯ä¸€ä¸ªå†…æ ¸çº§åˆ«çš„æ¨¡å—ï¼Œåªæ˜¯ä¸€ä¸ªæ•°æ®å¹³é¢ï¼Œè‡³äºä¸Šå±‚çš„æ›´é«˜çº§çš„åŠŸèƒ½ï¼ˆæ¯”å¦‚ç§˜é’¥äº¤æ¢æœºåˆ¶ï¼ŒUDP æ‰“æ´ï¼ŒACL ç­‰ï¼‰ï¼Œéœ€è¦é€šè¿‡ç”¨æˆ·ç©ºé—´çš„åº”ç”¨æ¥å®ç°ã€‚</p><a id="more"></a><p>æ‰€ä»¥ä¸ºäº†åŸºäº WireGuard å®ç°æ›´å®Œç¾çš„ VPN å·¥å…·ï¼Œç°åœ¨å·²ç»æ¶Œç°å‡ºäº†å¾ˆå¤šé¡¹ç›®åœ¨äº’ç›¸å®æ€ã€‚ç¬”è€…å‰æ®µæ—¶é—´ä¸€ç›´åœ¨æ¨å´‡ <a href="https://fuckcloudnative.io/posts/configure-a-mesh-network-with-netmaker/" target="_blank" rel="noopener">Netmaker</a>ï¼Œå®ƒé€šè¿‡å¯è§†åŒ–ç•Œé¢æ¥é…ç½® WireGuard çš„å…¨äº’è”æ¨¡å¼ï¼Œå®ƒæ”¯æŒ UDP æ‰“æ´ã€å¤šç§Ÿæˆ·ç­‰å„ç§é«˜ç«¯åŠŸèƒ½ï¼Œå‡ ä¹é€‚é…æ‰€æœ‰å¹³å°ï¼Œéå¸¸å¼ºå¤§ã€‚ç„¶è€Œç°å®ä¸–ç•Œæ˜¯å¤æ‚çš„ï¼Œæ— æ³•ä¿è¯æ‰€æœ‰çš„ NAT éƒ½èƒ½æ‰“æ´æˆåŠŸï¼Œä¸” Netmaker ç›®å‰è¿˜æ²¡æœ‰ fallback æœºåˆ¶ï¼Œå¦‚æœæ‰“æ´å¤±è´¥ï¼Œæ— æ³• fallback æ”¹æˆèµ°ä¸­ç»§èŠ‚ç‚¹ã€‚Tailscale åœ¨è¿™ä¸€ç‚¹ä¸Šæ¯” Netmaker é«˜æ˜è®¸å¤šï¼Œå®ƒæ”¯æŒ fallback æœºåˆ¶ï¼Œå¯ä»¥å°½æœ€å¤§åŠªåŠ›å®ç°å…¨äº’è”æ¨¡å¼ï¼Œéƒ¨åˆ†èŠ‚ç‚¹å³ä½¿æ‰“æ´ä¸æˆåŠŸï¼Œä¹Ÿèƒ½é€šè¿‡ä¸­ç»§èŠ‚ç‚¹åœ¨è¿™ä¸ªè™šæ‹Ÿç½‘ç»œä¸­ç•…é€šæ— é˜»ã€‚</p><p>æ²¡é”™ï¼Œæˆ‘ç§»æƒ…åˆ«æ‹äº†ï¼Œä» Netmaker é˜µè¥è½¬å‘äº† Tailscaleï¼Œæ˜¯æ¸£ç”·æ²¡é”™äº†ã€‚</p><h2><span id="tailscale-æ˜¯ä»€ä¹ˆ">Tailscale æ˜¯ä»€ä¹ˆ</span></h2><p>Tailscale æ˜¯ä¸€ç§åŸºäº WireGuard çš„è™šæ‹Ÿç»„ç½‘å·¥å…·ï¼Œå’Œ Netmaker ç±»ä¼¼ï¼Œ<strong>æœ€å¤§çš„åŒºåˆ«åœ¨äº Tailscale æ˜¯åœ¨ç”¨æˆ·æ€å®ç°äº† WireGuard åè®®ï¼Œè€Œ Netmaker ç›´æ¥ä½¿ç”¨äº†å†…æ ¸æ€çš„ WireGuard</strong>ã€‚æ‰€ä»¥ Tailscale ç›¸æ¯”äºå†…æ ¸æ€ WireGuard æ€§èƒ½ä¼šæœ‰æ‰€æŸå¤±ï¼Œä½†ä¸ OpenVPN ä¹‹æµç›¸æ¯”è¿˜æ˜¯èƒ½ç”©å¥½å‡ åæ¡è¡—çš„ï¼ŒTailscale è™½ç„¶åœ¨æ€§èƒ½ä¸Šåšäº†äº›è®¸å–èˆï¼Œä½†åœ¨åŠŸèƒ½å’Œæ˜“ç”¨æ€§ä¸Šç»å¯¹æ˜¯å®Œçˆ†å…¶ä»–å·¥å…·ï¼š</p><ol><li>å¼€ç®±å³ç”¨</li></ol><ul><li>æ— éœ€é…ç½®é˜²ç«å¢™</li><li>æ²¡æœ‰é¢å¤–çš„é…ç½®</li></ul><ol><li>é«˜å®‰å…¨æ€§/ç§å¯†æ€§</li></ol><ul><li>è‡ªåŠ¨å¯†é’¥è½®æ¢</li><li>ç‚¹å¯¹ç‚¹è¿æ¥</li><li>æ”¯æŒç”¨æˆ·å®¡æŸ¥ç«¯åˆ°ç«¯çš„è®¿é—®è®°å½•</li></ul><ol><li>åœ¨åŸæœ‰çš„ ICEã€STUN ç­‰ UDP åè®®å¤–ï¼Œå®ç°äº† DERP TCP åè®®æ¥å®ç° NAT ç©¿é€</li><li>åŸºäºå…¬ç½‘çš„æ§åˆ¶æœåŠ¡å™¨ä¸‹å‘ ACL å’Œé…ç½®ï¼Œå®ç°èŠ‚ç‚¹åŠ¨æ€æ›´æ–°</li><li>é€šè¿‡ç¬¬ä¸‰æ–¹ï¼ˆå¦‚ Googleï¼‰ SSO æœåŠ¡ç”Ÿæˆç”¨æˆ·å’Œç§é’¥ï¼Œå®ç°èº«ä»½è®¤è¯</li></ol><p>ç®€è€Œè¨€ä¹‹ï¼Œæˆ‘ä»¬å¯ä»¥å°† Tailscale çœ‹æˆæ˜¯æ›´ä¸ºæ˜“ç”¨ã€åŠŸèƒ½æ›´å®Œå–„çš„ WireGuardã€‚</p><p><img src="https://img.hi-linux.com/staticfile/2022-03-20-14-50-Q4bWmK-2022-03-30-HyPo1B.png" alt></p><p>å…‰æœ‰è¿™äº›è¿˜ä¸å¤Ÿï¼Œä½œä¸ºä¸€ä¸ªç™½å«–å…šï¼Œå’±æ›´å…³å¿ƒçš„æ˜¯<strong>å…è´¹</strong>ä¸<strong>å¼€æº</strong>ã€‚</p><p>Tailscale æ˜¯ä¸€æ¬¾å•†ä¸šäº§å“ï¼Œä½†ä¸ªäººç”¨æˆ·æ˜¯å¯ä»¥ç™½å«–çš„ï¼Œä¸ªäººç”¨æˆ·åœ¨æ¥å…¥è®¾å¤‡ä¸è¶…è¿‡ 20 å°çš„æƒ…å†µä¸‹æ˜¯å¯ä»¥å…è´¹ä½¿ç”¨çš„ï¼ˆè™½ç„¶æœ‰ä¸€äº›é™åˆ¶ï¼Œæ¯”å¦‚å­ç½‘ç½‘æ®µæ— æ³•è‡ªå®šä¹‰ï¼Œä¸”æ— æ³•è®¾ç½®å¤šä¸ªå­ç½‘ï¼‰ã€‚é™¤ Windows å’Œ macOS çš„å›¾å½¢åº”ç”¨ç¨‹åºå¤–ï¼Œå…¶ä»– Tailscale å®¢æˆ·ç«¯çš„ç»„ä»¶ï¼ˆåŒ…å« Android å®¢æˆ·ç«¯ï¼‰æ˜¯åœ¨ BSD è®¸å¯ä¸‹ä»¥å¼€æºé¡¹ç›®çš„å½¢å¼å¼€å‘çš„ï¼Œä½ å¯ä»¥åœ¨ä»–ä»¬çš„ <a href="https://github.com/tailscale/" target="_blank" rel="noopener">GitHub ä»“åº“</a>æ‰¾åˆ°å„ä¸ªæ“ä½œç³»ç»Ÿçš„å®¢æˆ·ç«¯æºç ã€‚</p><p>å¯¹äºå¤§éƒ¨ä»½ç”¨æˆ·æ¥è¯´ï¼Œç™½å«– Tailscale å·²ç»è¶³å¤Ÿäº†ï¼Œå¦‚æœä½ æœ‰æ›´é«˜çš„éœ€æ±‚ï¼Œæ¯”å¦‚è‡ªå®šä¹‰ç½‘æ®µï¼Œå¯ä»¥é€‰æ‹©ä»˜è´¹ã€‚</p><p><strong>æˆ‘å°±ä¸æƒ³ä»˜è´¹è¡Œä¸è¡Œï¼Ÿè¡Œï¼Œä¸è¿‡å¾—å¾€ä¸‹çœ‹ã€‚</strong></p><h2><span id="headscale-æ˜¯ä»€ä¹ˆ">Headscale æ˜¯ä»€ä¹ˆ</span></h2><p>Tailscale çš„æ§åˆ¶æœåŠ¡å™¨æ˜¯ä¸å¼€æºçš„ï¼Œè€Œä¸”å¯¹å…è´¹ç”¨æˆ·æœ‰è¯¸å¤šé™åˆ¶ï¼Œè¿™æ˜¯äººå®¶çš„æ‘‡é’±æ ‘ï¼Œå¯ä»¥ç†è§£ã€‚å¥½åœ¨ç›®å‰æœ‰ä¸€æ¬¾å¼€æºçš„å®ç°å« <a href="https://github.com/juanfont/headscale" target="_blank" rel="noopener">Headscale</a>ï¼Œè¿™ä¹Ÿæ˜¯å”¯ä¸€çš„ä¸€æ¬¾ï¼Œå¸Œæœ›èƒ½å‘å±•å£®å¤§ã€‚</p><p>Headscale ç”±æ¬§æ´²èˆªå¤©å±€çš„ Juan Font ä½¿ç”¨ Go è¯­è¨€å¼€å‘ï¼Œåœ¨ BSD è®¸å¯ä¸‹å‘å¸ƒï¼Œå®ç°äº† Tailscale æ§åˆ¶æœåŠ¡å™¨çš„æ‰€æœ‰ä¸»è¦åŠŸèƒ½ï¼Œå¯ä»¥éƒ¨ç½²åœ¨ä¼ä¸šå†…éƒ¨ï¼Œæ²¡æœ‰ä»»ä½•è®¾å¤‡æ•°é‡çš„é™åˆ¶ï¼Œä¸”æ‰€æœ‰çš„ç½‘ç»œæµé‡éƒ½ç”±è‡ªå·±æ§åˆ¶ã€‚</p><p>ç›®å‰ Headscale è¿˜æ²¡æœ‰å¯è§†åŒ–ç•Œé¢ï¼ŒæœŸå¾…åç»­æ›´æ–°å§ã€‚</p><h2><span id="headscale-éƒ¨ç½²">Headscale éƒ¨ç½²</span></h2><p>Headscale éƒ¨ç½²å¾ˆç®€å•ï¼Œæ¨èç›´æ¥åœ¨ Linux ä¸»æœºä¸Šå®‰è£…ã€‚</p><blockquote><p>ç†è®ºä¸Šæ¥è¯´åªè¦ä½ çš„ Headscale æœåŠ¡å¯ä»¥æš´éœ²åˆ°å…¬ç½‘å‡ºå£å°±è¡Œï¼Œä½†æœ€å¥½ä¸è¦æœ‰ NATï¼Œæ‰€ä»¥æ¨èå°† Headscale éƒ¨ç½²åœ¨æœ‰å…¬ç½‘ IP çš„äº‘ä¸»æœºä¸Šã€‚</p></blockquote><p>é¦–å…ˆéœ€è¦åˆ°å…¶ GitHub ä»“åº“çš„ Release é¡µé¢ä¸‹è½½æœ€æ–°ç‰ˆçš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ wget --output-document=/usr/<span class="built_in">local</span>/bin/headscale \</span><br><span class="line">   https://github.com/juanfont/headscale/releases/download/v&lt;HEADSCALE VERSION&gt;/headscale_&lt;HEADSCALE VERSION&gt;_linux_&lt;ARCH&gt;</span><br><span class="line"></span><br><span class="line">$ chmod +x /usr/<span class="built_in">local</span>/bin/headscale</span><br></pre></td></tr></table></figure><p>åˆ›å»ºé…ç½®ç›®å½•ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir -p /etc/headscale</span><br></pre></td></tr></table></figure><p>åˆ›å»ºç›®å½•ç”¨æ¥å­˜å‚¨æ•°æ®ä¸è¯ä¹¦ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir -p /var/lib/headscale</span><br></pre></td></tr></table></figure><p>åˆ›å»ºç©ºçš„ SQLite æ•°æ®åº“æ–‡ä»¶ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ touch /var/lib/headscale/db.sqlite</span><br></pre></td></tr></table></figure><p>åˆ›å»º Headscale é…ç½®æ–‡ä»¶ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://github.com/juanfont/headscale/raw/main/config-example.yaml -O /etc/headscale/config.yaml</span><br></pre></td></tr></table></figure><ul><li><p>ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œå°† <code>server_url</code> æ”¹ä¸ºå…¬ç½‘ IP æˆ–åŸŸåã€‚<strong>å¦‚æœæ˜¯å›½å†…æœåŠ¡å™¨ï¼ŒåŸŸåå¿…é¡»è¦å¤‡æ¡ˆ</strong>ã€‚æˆ‘çš„åŸŸåæ— æ³•å¤‡æ¡ˆï¼Œæ‰€ä»¥æˆ‘å°±ç›´æ¥ç”¨å…¬ç½‘ IP äº†ã€‚</p></li><li><p>å¦‚æœæš‚æ—¶ç”¨ä¸åˆ° DNS åŠŸèƒ½ï¼Œå¯ä»¥å…ˆå°† <code>magic_dns</code> è®¾ä¸º falseã€‚</p></li><li><p><code>server_url</code> è®¾ç½®ä¸º <code>http://&lt;PUBLIC_IP&gt;:8080</code>ï¼Œå°† <code>&lt;PUBLIC_IP&gt;</code> æ›¿æ¢ä¸ºå…¬ç½‘ IP æˆ–è€…åŸŸåã€‚</p></li><li><p>å¯è‡ªå®šä¹‰ç§æœ‰ç½‘æ®µï¼Œä¹Ÿå¯åŒæ—¶å¼€å¯ IPv4 å’Œ IPv6ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ip_prefixes:</span></span><br><span class="line">  <span class="comment"># - fd7a:115c:a1e0::/48</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">10.1</span><span class="number">.0</span><span class="number">.0</span><span class="string">/16</span></span><br></pre></td></tr></table></figure></li></ul><p>åˆ›å»º SystemD service é…ç½®æ–‡ä»¶ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /etc/systemd/system/headscale.service</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=headscale controller</span><br><span class="line">After=syslog.target</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">User=headscale</span><br><span class="line">Group=headscale</span><br><span class="line">ExecStart=/usr/<span class="built_in">local</span>/bin/headscale serve</span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=5</span><br><span class="line"></span><br><span class="line"><span class="comment"># Optional security enhancements</span></span><br><span class="line">NoNewPrivileges=yes</span><br><span class="line">PrivateTmp=yes</span><br><span class="line">ProtectSystem=strict</span><br><span class="line">ProtectHome=yes</span><br><span class="line">ReadWritePaths=/var/lib/headscale /var/run/headscale</span><br><span class="line">AmbientCapabilities=CAP_NET_BIND_SERVICE</span><br><span class="line">RuntimeDirectory=headscale</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><p>åˆ›å»º headscale ç”¨æˆ·ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ useradd headscale -d /home/headscale -m</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹ /var/lib/headscale ç›®å½•çš„ ownerï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ chown -R headscale:headscale /var/lib/headscale</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹é…ç½®æ–‡ä»¶ä¸­çš„ <code>unix_socket</code>ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">unix_socket:</span> <span class="string">/var/run/headscale/headscale.sock</span></span><br></pre></td></tr></table></figure><p>Reload SystemD ä»¥åŠ è½½æ–°çš„é…ç½®æ–‡ä»¶ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ systemctl daemon-reload</span><br></pre></td></tr></table></figure><p>å¯åŠ¨ Headscale æœåŠ¡å¹¶è®¾ç½®å¼€æœºè‡ªå¯ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ systemctl <span class="built_in">enable</span> --now headscale</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹è¿è¡ŒçŠ¶æ€ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ systemctl status headscale</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹å ç”¨ç«¯å£ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ ss -tulnp|grep headscale</span><br><span class="line"></span><br><span class="line">tcp LISTEN 0 1024 [::]:9090 [::]:* users:((<span class="string">"headscale"</span>,pi</span><br><span class="line"></span><br><span class="line">d=10899,fd=13))</span><br><span class="line"></span><br><span class="line">tcp LISTEN 0 1024 [::]:50443 [::]:* users:((<span class="string">"headscale"</span>,pi</span><br><span class="line"></span><br><span class="line">d=10899,fd=10))</span><br><span class="line"></span><br><span class="line">tcp LISTEN 0 1024 [::]:8080 [::]:* users:((<span class="string">"headscale"</span>,pi</span><br><span class="line"></span><br><span class="line">d=10899,fd=12))</span><br></pre></td></tr></table></figure><p>Tailscale ä¸­æœ‰ä¸€ä¸ªæ¦‚å¿µå« tailnetï¼Œä½ å¯ä»¥ç†è§£æˆç§Ÿæˆ·ï¼Œç§Ÿæˆ·ä¸ç§Ÿæˆ·ä¹‹é—´æ˜¯ç›¸äº’éš”ç¦»çš„ï¼Œå…·ä½“çœ‹å‚è€ƒ Tailscale çš„å®˜æ–¹æ–‡æ¡£ï¼š<a href="https://tailscale.com/kb/1136/tailnet/" target="_blank" rel="noopener">What is a tailnet</a>ã€‚Headscale ä¹Ÿæœ‰ç±»ä¼¼çš„å®ç°å« namespaceï¼Œå³å‘½åç©ºé—´ã€‚æˆ‘ä»¬éœ€è¦å…ˆåˆ›å»ºä¸€ä¸ª namespaceï¼Œä»¥ä¾¿åç»­å®¢æˆ·ç«¯æ¥å…¥ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ headscale namespaces create default</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹å‘½åç©ºé—´ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ headscale namespaces list</span><br><span class="line"></span><br><span class="line">ID | Name | Created</span><br><span class="line"></span><br><span class="line">1 | default | 2022-03-09 06:12:06</span><br></pre></td></tr></table></figure><h2><span id="tailscale-å®¢æˆ·ç«¯æ¥å…¥">Tailscale å®¢æˆ·ç«¯æ¥å…¥</span></h2><p>ç›®å‰é™¤äº† iOS å®¢æˆ·ç«¯ï¼Œå…¶ä»–å¹³å°çš„å®¢æˆ·ç«¯éƒ½æœ‰åŠæ³•è‡ªå®šä¹‰ Tailscale çš„æ§åˆ¶æœåŠ¡å™¨ã€‚</p><table><thead><tr><th style="text-align:left">OS</th><th style="text-align:left">æ˜¯å¦æ”¯æŒ Headscale</th></tr></thead><tbody><tr><td style="text-align:left">Linux</td><td style="text-align:left">Yes</td></tr><tr><td style="text-align:left">OpenBSD</td><td style="text-align:left">Yes</td></tr><tr><td style="text-align:left">FreeBSD</td><td style="text-align:left">Yes</td></tr><tr><td style="text-align:left">macOS</td><td style="text-align:left">Yes</td></tr><tr><td style="text-align:left">Windows</td><td style="text-align:left">Yes å‚è€ƒ <a href="https://github.com/juanfont/headscale/blob/main/docs/windows-client.md" target="_blank" rel="noopener">Windows å®¢æˆ·ç«¯æ–‡æ¡£</a></td></tr><tr><td style="text-align:left">Android</td><td style="text-align:left"><a href="https://github.com/juanfont/headscale/issues/58#issuecomment-950386833" target="_blank" rel="noopener">éœ€è¦è‡ªå·±ç¼–è¯‘å®¢æˆ·ç«¯</a></td></tr><tr><td style="text-align:left">iOS</td><td style="text-align:left">æš‚ä¸æ”¯æŒ</td></tr></tbody></table><p>æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹ Linux å¹³å°çš„æ¥å…¥ã€‚</p><h3><span id="linux">Linux</span></h3><p>Tailscale å®˜æ–¹æä¾›äº†å„ç§ Linux å‘è¡Œç‰ˆçš„è½¯ä»¶åŒ…ï¼Œä½†å›½å†…çš„ç½‘ç»œä½ æ‡‚å¾—ï¼Œè½¯ä»¶æºæ ¹æœ¬ç”¨ä¸äº†ã€‚å¥½åœ¨å®˜æ–¹è¿˜æä¾›äº†<a href="https://tailscale.com/download/linux/static" target="_blank" rel="noopener">é™æ€ç¼–è¯‘çš„äºŒè¿›åˆ¶æ–‡ä»¶</a>ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä¸‹è½½ã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://pkgs.tailscale.com/stable/tailscale_1.22.2_amd64.tgz</span><br></pre></td></tr></table></figure><p>è§£å‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ tar zxvf tailscale_1.22.2_amd64.tgz</span><br><span class="line">x tailscale_1.22.2_amd64/</span><br><span class="line">x tailscale_1.22.2_amd64/tailscale</span><br><span class="line">x tailscale_1.22.2_amd64/tailscaled</span><br><span class="line">x tailscale_1.22.2_amd64/systemd/</span><br><span class="line">x tailscale_1.22.2_amd64/systemd/tailscaled.defaults</span><br><span class="line">x tailscale_1.22.2_amd64/systemd/tailscaled.service</span><br></pre></td></tr></table></figure><p>å°†äºŒè¿›åˆ¶æ–‡ä»¶å¤åˆ¶åˆ°å®˜æ–¹è½¯ä»¶åŒ…é»˜è®¤çš„è·¯å¾„ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cp tailscale_1.22.2_amd64/tailscaled /usr/sbin/tailscaled</span><br><span class="line">$ cp tailscale_1.22.2_amd64/tailscale /usr/bin/tailscale</span><br></pre></td></tr></table></figure><p>å°† systemD service é…ç½®æ–‡ä»¶å¤åˆ¶åˆ°ç³»ç»Ÿè·¯å¾„ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ cp tailscale_1.22.2_amd64/systemd/tailscaled.service /lib/systemd/system/tailscaled.service</span><br></pre></td></tr></table></figure><p>å°†ç¯å¢ƒå˜é‡é…ç½®æ–‡ä»¶å¤åˆ¶åˆ°ç³»ç»Ÿè·¯å¾„ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ cp tailscale_1.22.2_amd64/systemd/tailscaled.defaults /etc/default/tailscaled</span><br></pre></td></tr></table></figure><p>å¯åŠ¨ tailscaled.service å¹¶è®¾ç½®å¼€æœºè‡ªå¯ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ systemctl <span class="built_in">enable</span> --now tailscaled</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹æœåŠ¡çŠ¶æ€ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ systemctl status tailscaled</span><br></pre></td></tr></table></figure><p>Tailscale æ¥å…¥ Headscaleï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å°† &lt;HEADSCALE_PUB_IP&gt; æ¢æˆä½ çš„ Headscale å…¬ç½‘ IP æˆ–åŸŸå</span></span><br><span class="line">$ tailscale up --login-server=http://&lt;HEADSCALE_PUB_IP&gt;:8080 --accept-routes=<span class="literal">true</span> --accept-dns=<span class="literal">false</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œæ¨èå°† DNS åŠŸèƒ½å…³é—­ï¼Œå› ä¸ºå®ƒä¼šè¦†ç›–ç³»ç»Ÿçš„é»˜è®¤ DNSã€‚å¦‚æœä½ å¯¹ DNS æœ‰éœ€æ±‚ï¼Œå¯è‡ªå·±ç ”ç©¶å®˜æ–¹æ–‡æ¡£ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚</p><p>æ‰§è¡Œå®Œä¸Šé¢çš„å‘½ä»¤åï¼Œä¼šå‡ºç°ä¸‹é¢çš„ä¿¡æ¯ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">To authenticate, visit:</span><br><span class="line"></span><br><span class="line">http://xxxxxx:8080/register?key=905cf165204800247fbd33989dbc22be95c987286c45aac303393704</span><br><span class="line"></span><br><span class="line">1150d846</span><br></pre></td></tr></table></figure><p>åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€è¯¥é“¾æ¥ï¼Œå°±ä¼šå‡ºç°å¦‚ä¸‹çš„ç•Œé¢ï¼š</p><p><img src="https://img.hi-linux.com/staticfile/2022-03-20-17-06-08qWbz-2022-03-30-omWdbc.png" alt></p><p>å°†å…¶ä¸­çš„å‘½ä»¤å¤åˆ¶ç²˜è´´åˆ° headscale æ‰€åœ¨æœºå™¨çš„ç»ˆç«¯ä¸­ï¼Œå¹¶å°† NAMESPACE æ›¿æ¢ä¸ºå‰é¢æ‰€åˆ›å»ºçš„ namespaceã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ headscale -n default nodes register --key 905cf165204800247fbd33989dbc22be95c987286c45aac3033937041150d846</span><br><span class="line">Machine register</span><br></pre></td></tr></table></figure><p>æ³¨å†ŒæˆåŠŸï¼ŒæŸ¥çœ‹æ³¨å†Œçš„èŠ‚ç‚¹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ headscale nodes list</span><br><span class="line"></span><br><span class="line">ID | Name | NodeKey | Namespace | IP addresses | Ephemeral | Last seen | Onlin</span><br><span class="line"></span><br><span class="line">e | Expired</span><br><span class="line"></span><br><span class="line">1 | coredns | [Ew3RB] | default | 10.1.0.1 | <span class="literal">false</span> | 2022-03-20 09:08:58 | onlin</span><br><span class="line"></span><br><span class="line">e | no</span><br></pre></td></tr></table></figure><p>å›åˆ° Tailscale å®¢æˆ·ç«¯æ‰€åœ¨çš„ Linux ä¸»æœºï¼Œå¯ä»¥çœ‹åˆ° Tailscale ä¼šè‡ªåŠ¨åˆ›å»ºç›¸å…³çš„è·¯ç”±è¡¨å’Œ iptables è§„åˆ™ã€‚è·¯ç”±è¡¨å¯é€šè¿‡ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ip route show table 52</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹ iptables è§„åˆ™ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ iptables -S</span><br><span class="line">-P INPUT DROP</span><br><span class="line">-P FORWARD ACCEPT</span><br><span class="line">-P OUTPUT ACCEPT</span><br><span class="line">-N ts-forward</span><br><span class="line">-N ts-input</span><br><span class="line">-A INPUT -j ts-input</span><br><span class="line">-A FORWARD -j ts-forward</span><br><span class="line">-A ts-forward -i tailscale0 -j MARK --<span class="built_in">set</span>-xmark 0x40000/0xffffffff</span><br><span class="line">-A ts-forward -m mark --mark 0x40000 -j ACCEPT</span><br><span class="line">-A ts-forward -s 100.64.0.0/10 -o tailscale0 -j DROP</span><br><span class="line">-A ts-forward -o tailscale0 -j ACCEPT</span><br><span class="line">-A ts-input -s 10.1.0.5/32 -i lo -j ACCEPT</span><br><span class="line">-A ts-input -s 100.115.92.0/23 ! -i tailscale0 -j RETURN</span><br><span class="line">-A ts-input -s 100.64.0.0/10 ! -i tailscale0 -j DROP</span><br><span class="line"></span><br><span class="line">$ iptables -S -t nat</span><br><span class="line">-P PREROUTING ACCEPT</span><br><span class="line">-P INPUT ACCEPT</span><br><span class="line">-P OUTPUT ACCEPT</span><br><span class="line">-P POSTROUTING ACCEPT</span><br><span class="line">-A ts-postrouting -m mark --mark 0x40000 -j MASQUERADE</span><br></pre></td></tr></table></figure><h3><span id="macos">macOS</span></h3><p>macOS å®¢æˆ·ç«¯çš„å®‰è£…ç›¸å¯¹æ¥è¯´å°±ç®€å•å¤šäº†ï¼Œåªéœ€è¦åœ¨åº”ç”¨å•†åº—å®‰è£… APP å³å¯ï¼Œå‰ææ˜¯ä½ <strong>éœ€è¦ä¸€ä¸ªç¾åŒº ID</strong>ã€‚ã€‚ã€‚</p><p><img src="https://img.hi-linux.com/staticfile/2022-03-20-17-33-3uRFwF-20220330100846245-2022-03-30-UU0DC4.png" alt></p><p>å®‰è£…å®Œæˆåè¿˜éœ€è¦åšä¸€äº›éªšæ“ä½œï¼Œæ‰èƒ½è®© Tailscale ä½¿ç”¨ Headscale ä½œä¸ºæ§åˆ¶æœåŠ¡å™¨ã€‚å½“ç„¶ï¼ŒHeadscale å·²ç»ç»™æˆ‘ä»¬æä¾›äº†è¯¦ç»†çš„æ“ä½œæ­¥éª¤ï¼Œä½ åªéœ€è¦åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ URLï¼š<code>http://&lt;HEADSCALE_PUB_IP&gt;:8080/apple</code>ï¼Œä¾¿ä¼šå‡ºç°å¦‚ä¸‹çš„ç•Œé¢ï¼š</p><p><img src="https://img.hi-linux.com/staticfile/2022-03-20-17-39-arYdfv-20220330100854600-2022-03-30-QA5zoK.png" alt></p><p>ä½ åªéœ€è¦æŒ‰ç…§å›¾ä¸­æ‰€è¿°çš„æ­¥éª¤æ“ä½œå³å¯ï¼Œæœ¬æ–‡å°±ä¸å†èµ˜è¿°äº†ã€‚</p><p>ä¿®æ”¹å®Œæˆåé‡å¯ Tailscale å®¢æˆ·ç«¯ï¼Œåœ¨ macOS é¡¶éƒ¨çŠ¶æ€æ ä¸­æ‰¾åˆ° Tailscale å¹¶ç‚¹å‡»ï¼Œç„¶åå†ç‚¹å‡» <code>Log in</code>ã€‚</p><p><img src="https://img.hi-linux.com/staticfile/2022-03-20-17-43-pTW3r7-2022-03-30-lici7s.png" alt></p><p>ç„¶åç«‹é©¬å°±ä¼šè·³è½¬åˆ°æµè§ˆå™¨å¹¶æ‰“å¼€ä¸€ä¸ªé¡µé¢ã€‚</p><p><img src="https://img.hi-linux.com/staticfile/2022-03-20-17-46-AbzngB-2022-03-30-I0Dftb.png" alt></p><p>æ¥ä¸‹æ¥ä¸ä¹‹å‰ Linux å®¢æˆ·ç«¯ç›¸åŒï¼Œå›åˆ° Headscale æ‰€åœ¨çš„æœºå™¨æ‰§è¡Œæµè§ˆå™¨ä¸­çš„å‘½ä»¤å³å¯ï¼Œæ³¨å†ŒæˆåŠŸï¼š</p><p><img src="https://img.hi-linux.com/staticfile/2022-03-20-17-51-Gcjcmy-2022-03-30-kfN06l.png" alt></p><p>å›åˆ° Headscale æ‰€åœ¨ä¸»æœºï¼ŒæŸ¥çœ‹æ³¨å†Œçš„èŠ‚ç‚¹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ headscale nodes list</span><br><span class="line"></span><br><span class="line">ID | Name | NodeKey | Namespace | IP addresses | Ephemeral | Last seen | Onlin</span><br><span class="line"></span><br><span class="line">e | Expired</span><br><span class="line"></span><br><span class="line">1 | coredns | [Ew3RB] | default | 10.1.0.1 | <span class="literal">false</span> | 2022-03-20 09:08:58 | onlin</span><br><span class="line"></span><br><span class="line">e | no</span><br><span class="line">2 | carsondemacbook-pro | [k7bzX] | default   | 10.1.0.2     | <span class="literal">false</span>     | 2022-03-20 09:48:30 | online  | no</span><br></pre></td></tr></table></figure><p>å›åˆ° macOSï¼Œæµ‹è¯•æ˜¯å¦èƒ½ ping é€šå¯¹ç«¯èŠ‚ç‚¹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ ping -c 2 10.1.0.1</span><br><span class="line">PING 10.1.0.1 (10.1.0.1): 56 data bytes</span><br><span class="line">64 bytes from 10.1.0.1: icmp_seq=0 ttl=64 time=37.025 ms</span><br><span class="line">64 bytes from 10.1.0.1: icmp_seq=1 ttl=64 time=38.181 ms</span><br><span class="line"></span><br><span class="line">--- 10.1.0.1 ping statistics ---</span><br><span class="line">2 packets transmitted, 2 packets received, 0.0% packet loss</span><br><span class="line">round-trip min/avg/max/stddev = 37.025/37.603/38.181/0.578 ms</span><br></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥ä½¿ç”¨ Tailscale CLI æ¥æµ‹è¯•ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ /Applications/Tailscale.app/Contents/MacOS/Tailscale ping 10.1.0.1</span><br><span class="line">pong from coredns (10.1.0.1) via xxxx:41641 <span class="keyword">in</span> 36ms</span><br></pre></td></tr></table></figure><p>å¦‚æœä½ æ²¡æœ‰ç¾åŒº IDï¼Œæ— æ³•å®‰è£… Appï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨å‘½ä»¤è¡Œç‰ˆæœ¬ï¼Œé€šè¿‡ Homebrew å®‰è£…å³å¯ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ brew install tailscale</span><br></pre></td></tr></table></figure><h3><span id="android">Android</span></h3><p>Android å®¢æˆ·ç«¯å°±æ¯”è¾ƒéº»çƒ¦äº†ï¼Œéœ€è¦è‡ªå·±ä¿®æ”¹æºä»£ç ç¼–è¯‘ Appï¼Œå…·ä½“å¯å‚è€ƒ<a href="https://github.com/juanfont/headscale/issues/58#issuecomment-950386833" target="_blank" rel="noopener">è¿™ä¸ª issue</a>ã€‚ç¼–è¯‘è¿‡ç¨‹è¿˜æ˜¯æ¯”è¾ƒéº»çƒ¦çš„ï¼Œéœ€è¦å…ˆä¿®æ”¹æºç ï¼Œç„¶åæ„å»ºä¸€ä¸ªåŒ…å«ç¼–è¯‘ç¯å¢ƒçš„ Docker é•œåƒï¼Œæœ€ååœ¨é€šè¿‡è¯¥é•œåƒå¯åŠ¨å®¹å™¨ç¼–è¯‘ apkã€‚</p><p>æˆ‘çŸ¥é“å¾ˆå¤šäººä¸€çœ‹éº»çƒ¦å°±ä¸æƒ³æäº†ï¼Œè¿™ä¸ªé—®é¢˜ä¸å¤§ï¼Œæˆ‘é€ä½›é€åˆ°è¥¿ï¼Œæä¾›äº†ä¸€æ¡é¾™æœåŠ¡ï¼Œä½ åªéœ€ fork æˆ‘çš„ GitHub ä»“åº“ <a href="https://github.com/yangchuansheng/tailscale-android" target="_blank" rel="noopener">tailscale-android</a>ï¼š</p><p><img src="https://img.hi-linux.com/staticfile/2022-03-20-21-25-utX9zr-20220330100913552-2022-03-30-oLXzfj.png" alt></p><p>ç„¶ååœ¨ä½ çš„ä»“åº“ä¸­ç‚¹å‡» <strong>Settings</strong> æ ‡ç­¾ï¼Œæ‰¾åˆ° <strong>Secrets</strong> ä¸‹æ‹‰æ¡†ä¸­çš„ Actions é€‰é¡¹ï¼š</p><p><img src="https://img.hi-linux.com/staticfile/2022-03-20-21-32-OQT9m7-2022-03-30-X3WXc1.jpg" alt></p><p>é€‰æ‹© <strong>New repository secret</strong> æ·»åŠ ä¸€ä¸ª secret å« <code>HEADSCALE_URL</code>ï¼Œå°†ä½ çš„ Headscale æœåŠ¡å…¬ç½‘åœ°å€å¡«å…¥å…¶ä¸­ï¼š</p><p><img src="https://img.hi-linux.com/staticfile/2022-03-20-21-35-ep7qXR-20220330100925768-2022-03-30-wX3Vxc.png" alt></p><p><strong>æ·»åŠ åœ¨è¿™é‡Œçš„é…ç½®ï¼Œå°†åªå¯¹ä½ å¯è§ï¼Œä¸ç”¨æ‹…å¿ƒä¼šæ³„éœ²ç»™ä»–äººã€‚</strong></p><p>ç„¶åç‚¹å‡» <strong>Actions</strong> æ ‡ç­¾ï¼Œé€‰æ‹© <strong>Release</strong> Workflowã€‚</p><p><img src="https://img.hi-linux.com/staticfile/2022-03-20-21-53-CXAfAl-20220330100934764-2022-03-30-N045W9.png" alt></p><p>ä½ ä¼šçœ‹åˆ°ä¸€ä¸ª <strong>Run workflow</strong> æŒ‰é’®ï¼Œç‚¹å‡»å®ƒï¼Œç„¶ååœ¨ä¸‹æ‹‰æ¡†ä¸­ç‚¹å‡» <strong>Run workflow</strong>ã€‚</p><p><img src="https://img.hi-linux.com/staticfile/2022-03-20-22-02-SaxiiT-20220330100941082-2022-03-30-jMUwEO.png" alt></p><p>æµæ°´çº¿å°±ä¼šå¼€å§‹æ‰§è¡Œï¼Œæ‰§è¡ŒæˆåŠŸåå°±ä¼šåœ¨ Release é¡µé¢çœ‹åˆ°ç¼–è¯‘å¥½çš„ apkã€‚</p><p><img src="https://img.hi-linux.com/staticfile/2022-03-20-22-05-wxjatP-20220330100947763-2022-03-30-XNDPE9.png" alt></p><p>æ¥ä¸‹æ¥çš„äº‹æƒ…å°±ç®€å•äº†ï¼Œä¸‹è½½è¿™ä¸ª apk åˆ°ä½ çš„ Android æ‰‹æœºä¸Šå®‰è£…å°±å¥½äº†ã€‚å®‰è£…å®Œæˆåæ‰“å¼€ Tailscale Appï¼Œé€‰æ‹© <strong>Sign in with other</strong>ã€‚</p><p><img src="https://img.hi-linux.com/staticfile/2022-03-20-22-14-34ZnDn-20220330100954238-2022-03-30-OgX2LV.jpeg" alt></p><p>ç„¶åå°±ä¼šè·³å‡ºè¿™ä¸ªé¡µé¢ï¼š</p><p><img src="https://img.hi-linux.com/staticfile/2022-03-21-11-10-jbk5KL-2022-03-30-s7wFak-2022-03-30-MhBzl0.jpeg" alt></p><p>å°†å…¶ä¸­çš„å‘½ä»¤ç²˜è´´åˆ° Headscale æ‰€åœ¨ä¸»æœºçš„ç»ˆç«¯ï¼Œå°† <strong>NAMESPACE</strong> æ›¿æ¢ä¸ºä¹‹å‰åˆ›å»ºçš„ namespaceï¼Œç„¶åæ‰§è¡Œå‘½ä»¤å³å¯ã€‚æ³¨å†ŒæˆåŠŸåå¯å°†è¯¥é¡µé¢å…³é—­ï¼Œå›åˆ° App ä¸»é¡µï¼Œæ•ˆæœå¦‚å›¾ï¼š</p><p><img src="https://img.hi-linux.com/staticfile/2022-03-20-22-19-GET2os-20220330101008543-2022-03-30-1Wfo84.jpeg" alt></p><p>å›åˆ°ä¹‹å‰çš„ GitHub ä»“åº“ï¼Œåˆšæ‰æˆ‘ä»¬æ˜¯é€šè¿‡æ‰‹åŠ¨è§¦å‘ Workflow æ¥ç¼–è¯‘ apk çš„ï¼Œæœ‰æ²¡æœ‰åŠæ³•è‡ªåŠ¨ç¼–è¯‘å‘¢ï¼Ÿ<strong>åªè¦ Tailscale å®˜æ–¹ä»“åº“æœ‰æ›´æ–°ï¼Œå°±ç«‹å³è§¦å‘ Workflow å¼€å§‹ç¼–è¯‘ã€‚</strong></p><p>é‚£å½“ç„¶æ˜¯å¯ä»¥å®ç°çš„ï¼Œè€Œä¸”æˆ‘å·²ç»å®ç°äº†ï¼Œä»”ç»†çœ‹ GitHub Actions çš„ç¼–æ’æ–‡ä»¶ï¼š</p><p><img src="https://img.hi-linux.com/staticfile/2022-03-20-22-29-QJvXwt-20220330101015867-2022-03-30-0Sh9T7.png" alt></p><p>çº¢æ¡†åœˆå‡ºæ¥çš„éƒ¨åˆ†è¡¨ç¤ºåªè¦ä»“åº“çš„ <code>main</code> åˆ†æ”¯æœ‰æ›´æ–°ï¼Œä¾¿ä¼šè§¦å‘ Workflowã€‚<strong>ç°åœ¨çš„é—®é¢˜æ˜¯å¦‚ä½•è®© main åˆ†æ”¯å’Œä¸Šæ¸¸å®˜æ–¹ä»“åº“ä¸€è‡´ï¼Œä¸€ç›´ä¿æŒåœ¨æœ€æ–°çŠ¶æ€ã€‚</strong></p><p>è¿™ä¸ªé—®é¢˜ä½¿ç”¨ç¬¬ä¸‰æ–¹ Github App å°±å¯ä»¥è§£å†³ï¼Œè¿™ä¸ª App åå­—ç®€å•ç²—æš´ï¼Œå°±å« <a href="https://github.com/apps/pull" target="_blank" rel="noopener">Pull</a>ï¼Œå®ƒçš„ä½œç”¨éä¹Ÿå¾ˆç®€å•ç²—æš´ï¼šä¿æŒä½ çš„ Fork åœ¨æœ€æ–°çŠ¶æ€ã€‚</p><p>Pull çš„ä½¿ç”¨æ–¹æ³•å¾ˆç®€å•ï¼š</p><ol><li>æ‰“å¼€ <a href="https://github.com/apps/pull" target="_blank" rel="noopener">Pull App</a> é¡µé¢</li><li>ç‚¹å‡»å³ä¸Šè§’ç»¿è‰²çš„ install æŒ‰é’®</li></ol><p><img src="https://img.hi-linux.com/staticfile/2022-03-20-22-44-fRwr6j-20220330101027005-2022-03-30-FKoCBW.png" alt></p><ol><li>åœ¨é€‰é¡¹é¡µé¢ï¼Œä½¿ç”¨é»˜è®¤çš„ <strong>All repositories</strong> å³å¯ï¼ˆä½ ä¹Ÿå¯ä»¥é€‰æ‹©æŒ‡å®šçš„ä»“åº“ï¼Œæ¯”å¦‚ tailscale-androidï¼‰ï¼Œç„¶åç‚¹å‡»ç»¿è‰²çš„ <strong>install</strong> æŒ‰é’®ï¼š</li></ol><p><img src="https://img.hi-linux.com/staticfile/2022-03-20-22-46-flOKJW-2022-03-30-LfAe4V-2022-03-30-m2esZD.png" alt></p><p>ç®€å•ä¸‰æ­¥ï¼ŒPull App å°±å®‰è£…å¥½äº†ã€‚æ¥ä¸‹æ¥ Pull App ä¼šæ¯å¤©å®šæ—¶å¸®ä½ æ›´æ–°ä»£ç åº“ï¼Œä½¿ä½  fork çš„ä»£ç å§‹ç»ˆæ˜¯æœ€æ–°ç‰ˆçš„ã€‚</p><h3><span id="windows">Windows</span></h3><p>Windows Tailscale å®¢æˆ·ç«¯æƒ³è¦ä½¿ç”¨ Headscale ä½œä¸ºæ§åˆ¶æœåŠ¡å™¨ï¼Œåªéœ€åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ URLï¼š<code>http://&lt;HEADSCALE_PUB_IP&gt;:8080/windows</code>ï¼Œä¾¿ä¼šå‡ºç°å¦‚ä¸‹çš„ç•Œé¢ï¼š</p><p><img src="https://img.hi-linux.com/staticfile/2022-03-20-23-30-zcQX3F-2022-03-30-OUQVcT.png" alt></p><p>æŒ‰ç…§å…¶ä¸­çš„æ­¥éª¤æ“ä½œå³å¯ã€‚</p><h3><span id="å…¶ä»–-linux-å‘è¡Œç‰ˆ">å…¶ä»– Linux å‘è¡Œç‰ˆ</span></h3><p>é™¤äº†å¸¸è§„çš„ Linux å‘è¡Œç‰ˆä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€äº›ç‰¹æ®Šåœºæ™¯çš„ Linux å‘è¡Œç‰ˆï¼Œæ¯”å¦‚ OpenWrtã€å¨è”é€šï¼ˆQNAPï¼‰ã€ç¾¤æ™–ç­‰ï¼Œè¿™äº›å‘è¡Œç‰ˆçš„å®‰è£…æ–¹æ³•å·²ç»æœ‰äººå†™å¥½äº†ï¼Œè¿™é‡Œå°±ä¸è¯¦ç»†æè¿°äº†ï¼Œæˆ‘åªç»™å‡ºç›¸å…³çš„ GitHub ä»“åº“ï¼Œå¤§å®¶å¦‚æœè‡ªå·±æœ‰éœ€æ±‚ï¼Œç›´æ¥å»çœ‹ç›¸å…³ä»“åº“çš„æ–‡æ¡£å³å¯ã€‚</p><ul><li>OpenWrtï¼š<a href="https://github.com/adyanth/openwrt-tailscale-enabler" target="_blank" rel="noopener">https://github.com/adyanth/openwrt-tailscale-enabler</a></li><li>ç¾¤æ™–ï¼š<a href="https://github.com/tailscale/tailscale-synology" target="_blank" rel="noopener">https://github.com/tailscale/tailscale-synology</a></li><li>å¨è”é€šï¼š<a href="https://github.com/ivokub/tailscale-qpkg" target="_blank" rel="noopener">https://github.com/ivokub/tailscale-qpkg</a></li></ul><h3><span id="ios">iOS</span></h3><p>Tailscale iOS å®¢æˆ·ç«¯æºä»£ç æ²¡æœ‰å¼€æºï¼Œç›®å‰è¿˜æ— æ³•ç ´è§£ä½¿å…¶ä½¿ç”¨ç¬¬ä¸‰æ–¹æ§åˆ¶æœåŠ¡å™¨ï¼Œé—æ†¾~~</p><h2><span id="æ‰“é€šå±€åŸŸç½‘">æ‰“é€šå±€åŸŸç½‘</span></h2><p>åˆ°ç›®å‰ä¸ºæ­¢æˆ‘ä»¬åªæ˜¯æ‰“é€ äº†ä¸€ä¸ªç‚¹å¯¹ç‚¹çš„ Mesh ç½‘ç»œï¼Œå„ä¸ªèŠ‚ç‚¹ä¹‹é—´éƒ½å¯ä»¥é€šè¿‡ WireGuard çš„ç§æœ‰ç½‘ç»œ IP è¿›è¡Œç›´è¿ã€‚ä½†æˆ‘ä»¬å¯ä»¥æ›´å¤§èƒ†ä¸€ç‚¹ï¼Œè¿˜è®°å¾—æˆ‘åœ¨æ–‡ç« å¼€å¤´æåˆ°çš„è®¿é—®å®¶åº­å†…ç½‘çš„èµ„æºå—ï¼Ÿæˆ‘ä»¬å¯ä»¥é€šè¿‡é€‚å½“çš„é…ç½®è®©æ¯ä¸ªèŠ‚ç‚¹éƒ½èƒ½è®¿é—®å…¶ä»–èŠ‚ç‚¹çš„å±€åŸŸç½‘ IPã€‚è¿™ä¸ªä½¿ç”¨åœºæ™¯å°±æ¯”è¾ƒå¤šäº†ï¼Œä½ å¯ä»¥ç›´æ¥è®¿é—®å®¶åº­å†…ç½‘çš„ NASï¼Œæˆ–è€…å†…ç½‘çš„ä»»ä½•ä¸€ä¸ªæœåŠ¡ï¼Œ<strong>æ›´é«˜çº§çš„ç©å®¶å¯ä»¥ä½¿ç”¨è¿™ä¸ªæ–¹æ³•æ¥è®¿é—®äº‘ä¸Š Kubernetes é›†ç¾¤çš„ Pod IP å’Œ Service IPã€‚</strong></p><p>å‡è®¾ä½ çš„å®¶åº­å†…ç½‘æœ‰ä¸€å° Linux ä¸»æœºï¼ˆæ¯”å¦‚ OpenWrtï¼‰å®‰è£…äº† Tailscale å®¢æˆ·ç«¯ï¼Œæˆ‘ä»¬å¸Œæœ›å…¶ä»– Tailscale å®¢æˆ·ç«¯å¯ä»¥ç›´æ¥é€šè¿‡å®¶ä¸­çš„å±€åŸŸç½‘ IPï¼ˆä¾‹å¦‚ <strong>192.168.100.0/24</strong>ï¼‰ è®¿é—®å®¶åº­å†…ç½‘çš„ä»»ä½•ä¸€å°è®¾å¤‡ã€‚</p><p>é…ç½®æ–¹æ³•å¾ˆç®€å•ï¼Œé¦–å…ˆéœ€è¦è®¾ç½® IPv4 ä¸ IPv6 è·¯ç”±è½¬å‘ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">'net.ipv4.ip_forward = 1'</span> | tee /etc/sysctl.d/ipforwarding.conf</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">'net.ipv6.conf.all.forwarding = 1'</span> | tee -a /etc/sysctl.d/ipforwarding.conf</span><br><span class="line">$ sysctl -p /etc/sysctl.d/ipforwarding.conf</span><br></pre></td></tr></table></figure><p>å®¢æˆ·ç«¯ä¿®æ”¹æ³¨å†ŒèŠ‚ç‚¹çš„å‘½ä»¤ï¼Œåœ¨åŸæ¥å‘½ä»¤çš„åŸºç¡€ä¸ŠåŠ ä¸Šå‚æ•° <code>--advertise-routes=192.168.100.0/24</code>ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ tailscale up --login-server=http://&lt;HEADSCALE_PUB_IP&gt;:8080 --accept-routes=<span class="literal">true</span> --accept-dns=<span class="literal">false</span> --advertise-routes=192.168.100.0/24</span><br></pre></td></tr></table></figure><p>åœ¨ Headscale ç«¯æŸ¥çœ‹è·¯ç”±ï¼Œå¯ä»¥çœ‹åˆ°ç›¸å…³è·¯ç”±æ˜¯å…³é—­çš„ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ headscale nodes list|grep openwrt</span><br><span class="line"></span><br><span class="line">6 | openwrt | [7LdVc] | default | 10.1.0.6 | <span class="literal">false</span> | 2022-03-20 15:50:46 | onlin</span><br><span class="line"></span><br><span class="line">e | no</span><br><span class="line"></span><br><span class="line">$ headscale routes list -i 6</span><br><span class="line"></span><br><span class="line">Route | Enabled</span><br><span class="line"></span><br><span class="line">192.168.100.0/24 | <span class="literal">false</span></span><br></pre></td></tr></table></figure><p>å¼€å¯è·¯ç”±ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ headscale routes <span class="built_in">enable</span> -i 6 -r <span class="string">"192.168.100.0/24"</span></span><br><span class="line"></span><br><span class="line">Route | Enabled</span><br><span class="line"></span><br><span class="line">192.168.100.0/24 | <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>å…¶ä»–èŠ‚ç‚¹æŸ¥çœ‹è·¯ç”±ç»“æœï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ip route show table 52|grep <span class="string">"192.168.100.0/24"</span></span><br><span class="line">192.168.100.0/24 dev tailscale0</span><br></pre></td></tr></table></figure><p>ç°åœ¨ä½ åœ¨ä»»ä½•ä¸€ä¸ª Tailscale å®¢æˆ·ç«¯æ‰€åœ¨çš„èŠ‚ç‚¹éƒ½å¯ä»¥ ping é€šå®¶åº­å†…ç½‘çš„æœºå™¨äº†ï¼Œä½ åœ¨å…¬å¸æˆ–è€…æ˜Ÿå·´å…‹ä¹Ÿå¯ä»¥åƒåœ¨å®¶é‡Œä¸€æ ·ç”¨åŒæ ·çš„ IP éšæ„è®¿é—®å®¶ä¸­çš„ä»»ä½•ä¸€ä¸ªè®¾å¤‡ï¼Œå°±é—®ä½ é¦™ä¸é¦™ï¼Ÿ</p><h2><span id="æ€»ç»“">æ€»ç»“</span></h2><p>ç›®å‰ä»ç¨³å®šæ€§æ¥çœ‹ï¼ŒTailscale æ¯” Netmaker ç•¥èƒœä¸€ç­¹ï¼ŒåŸºæœ¬ä¸Šä¸ä¼šåƒ Netmaker ä¸€æ ·æ—¶ä¸æ—¶å‡ºç° ping ä¸é€šçš„æƒ…å†µï¼Œè¿™å–å†³äº Tailscale åœ¨ç”¨æˆ·æ€å¯¹ NAT ç©¿é€æ‰€åšçš„ç§ç§ä¼˜åŒ–ï¼Œä»–ä»¬è¿˜ä¸“é—¨å†™äº†ä¸€ç¯‡æ–‡ç« ä»‹ç» <a href="https://tailscale.com/blog/how-nat-traversal-works/" target="_blank" rel="noopener">NAT ç©¿é€çš„åŸç†</a>ï¼Œ<a href="https://arthurchiao.art/blog/how-nat-traversal-works-zh/" target="_blank" rel="noopener">ä¸­æ–‡ç‰ˆ</a>ç¿»è¯‘è‡ªå›½å†…çš„ eBPF å¤§ä½¬èµµäºšæ¥ ï¼Œå¢™è£‚æ¨èå¤§å®¶é˜…è¯»ã€‚æ”¾ä¸€å¼ å›¾ç»™å¤§å®¶æ„Ÿå—ä¸€ä¸‹ï¼š</p><p><img src="https://img.hi-linux.com/staticfile/2022-03-21-10-52-TzXGEZ-20220330101049526-2022-03-30-9Eqg5N.png" alt></p><p>æœ¬æ–‡ç»™å¤§å®¶ä»‹ç»äº† Tailscale å’Œ Headscaleï¼ŒåŒ…æ‹¬ Headscale çš„å®‰è£…éƒ¨ç½²å’Œå„ä¸ªå¹³å°å®¢æˆ·ç«¯çš„æ¥å…¥ï¼Œä»¥åŠå¦‚ä½•æ‰“é€šå„ä¸ªèŠ‚ç‚¹æ‰€åœ¨çš„å±€åŸŸç½‘ã€‚ä¸‹ç¯‡æ–‡ç« å°†ä¼šç»™å¤§å®¶ä»‹ç»å¦‚ä½•è®© Tailscale ä½¿ç”¨è‡ªå®šä¹‰çš„ DERP Serversï¼ˆä¹Ÿå°±æ˜¯ä¸­ç»§æœåŠ¡å™¨ï¼‰ï¼ŒSee you~~</p><p>ä¸Šé¢æˆ‘ä»¬ä»‹ç»äº†å¦‚ä½•ä½¿ç”¨ <code>Headscale</code> æ›¿ä»£ Tailscale å®˜æ–¹çš„æ§åˆ¶æœåŠ¡å™¨ï¼Œå¹¶æ¥å…¥å„ä¸ªå¹³å°çš„å®¢æˆ·ç«¯ã€‚æœ¬æ–‡å°†ä¼šä»‹ç»å¦‚ä½•è®© Tailscale ä½¿ç”¨è‡ªå®šä¹‰çš„ DERP Serversã€‚å¯èƒ½å¾ˆå¤šäººéƒ½ä¸çŸ¥é“ <code>DERP</code> æ˜¯ä¸ªå•¥ç©æ„å„¿ï¼Œæ²¡å…³ç³»ï¼Œæˆ‘å…ˆä»<strong>ä¸­ç»§æœåŠ¡å™¨</strong>å¼€å§‹è®²èµ·ã€‚</p><h2><span id="stun-æ˜¯ä»€ä¹ˆ">STUN æ˜¯ä»€ä¹ˆ</span></h2><p>Tailscale çš„ç»ˆæç›®æ ‡æ˜¯è®©ä¸¤å°<strong>å¤„äºç½‘ç»œä¸Šçš„ä»»ä½•ä½ç½®</strong>çš„æœºå™¨å»ºç«‹<strong>ç‚¹å¯¹ç‚¹è¿æ¥</strong>ï¼ˆç›´è¿ï¼‰ï¼Œä½†ç°å®ä¸–ç•Œæ˜¯å¤æ‚çš„ï¼Œå¤§éƒ¨ä»½æƒ…å†µä¸‹æœºå™¨éƒ½ä½äº NAT å’Œé˜²ç«å¢™åé¢ï¼Œè¿™æ—¶å€™å°±éœ€è¦é€šè¿‡æ‰“æ´æ¥å®ç°ç›´è¿ï¼Œä¹Ÿå°±æ˜¯ NAT ç©¿é€ã€‚</p><p>NAT æŒ‰ç…§ <strong>NAT æ˜ å°„è¡Œä¸º</strong>å’Œ<strong>æœ‰çŠ¶æ€é˜²ç«å¢™è¡Œä¸º</strong>å¯ä»¥åˆ†ä¸ºå¤šç§ç±»å‹ï¼Œä½†å¯¹äº NAT ç©¿é€æ¥è¯´æ ¹æœ¬ä¸éœ€è¦å…³å¿ƒè¿™ä¹ˆå¤šç±»å‹ï¼Œåªéœ€è¦çœ‹ <strong>NAT æˆ–è€…æœ‰çŠ¶æ€é˜²ç«å¢™æ˜¯å¦ä¼šä¸¥æ ¼æ£€æŸ¥ç›®æ ‡ Endpoint</strong>ï¼Œæ ¹æ®è¿™ä¸ªå› ç´ ï¼Œå¯ä»¥å°† NAT åˆ†ä¸º <strong>Easy NAT</strong> å’Œ <strong>Hard NAT</strong>ã€‚</p><ul><li><strong>Easy NAT</strong> åŠå…¶å˜ç§ç§°ä¸º â€œEndpoint-Independent Mappingâ€ (<strong>EIMï¼Œç»ˆç‚¹æ— å…³çš„æ˜ å°„</strong>)<br>è¿™é‡Œçš„ Endpoint æŒ‡çš„æ˜¯ç›®æ ‡ Endpointï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæœ‰çŠ¶æ€é˜²ç«å¢™åªè¦çœ‹åˆ°æœ‰å®¢æˆ·ç«¯è‡ªå·±å‘èµ·çš„å‡ºå‘åŒ…ï¼Œå°±ä¼šå…è®¸ç›¸åº”çš„å…¥å‘åŒ…è¿›å…¥ï¼Œ<strong>ä¸ç®¡è¿™ä¸ªå…¥å‘åŒ…æ˜¯è°å‘è¿›æ¥çš„éƒ½å¯ä»¥</strong>ã€‚</li><li><strong>hard NAT</strong> ä»¥åŠå˜ç§ç§°ä¸º â€œEndpoint-Dependent Mappingâ€ï¼ˆ<strong>EDMï¼Œç»ˆç‚¹ç›¸å…³çš„æ˜ å°„</strong>ï¼‰<br>è¿™ç§ NAT ä¼šé’ˆå¯¹æ¯ä¸ªç›®æ ‡ Endpoint æ¥ç”Ÿæˆä¸€æ¡ç›¸åº”çš„æ˜ å°„å…³ç³»ã€‚ åœ¨è¿™æ ·çš„è®¾å¤‡ä¸Šï¼Œå¦‚æœå®¢æˆ·ç«¯å‘æŸä¸ªç›®æ ‡ Endpoint å‘èµ·äº†å‡ºå‘åŒ…ï¼Œå‡è®¾å®¢æˆ·ç«¯çš„å…¬ç½‘ IP æ˜¯ 2.2.2.2ï¼Œé‚£ä¹ˆæœ‰çŠ¶æ€é˜²ç«å¢™å°±ä¼šæ‰“å¼€ä¸€ä¸ªç«¯å£ï¼Œå‡è®¾æ˜¯ 4242ã€‚é‚£ä¹ˆåªæœ‰æ¥è‡ªè¯¥ç›®æ ‡ Endpoint çš„å…¥å‘åŒ…æ‰å…è®¸é€šè¿‡ <code>2.2.2.2:4242</code>ï¼Œå…¶ä»–å®¢æˆ·ç«¯ä¸€å¾‹ä¸å…è®¸ã€‚è¿™ç§ NAT æ›´åŠ ä¸¥æ ¼ï¼Œæ‰€ä»¥å« Hard NATã€‚</li></ul><p>å¯¹äº Easy NATï¼Œæˆ‘ä»¬åªéœ€è¦æä¾›ä¸€ä¸ªç¬¬ä¸‰æ–¹çš„æœåŠ¡ï¼Œå®ƒèƒ½å¤Ÿå‘Šè¯‰å®¢æˆ·ç«¯â€œå®ƒçœ‹åˆ°çš„å®¢æˆ·ç«¯çš„å…¬ç½‘ ip:port æ˜¯ä»€ä¹ˆâ€ï¼Œç„¶åå°†è¿™ä¸ªä¿¡æ¯ä»¥æŸç§æ–¹å¼å‘Šè¯‰é€šä¿¡å¯¹ç«¯ï¼ˆpeerï¼‰ï¼Œåè€…å°±çŸ¥é“è¯¥å’Œå“ªä¸ªåœ°å€å»ºè¿äº†ï¼è¿™ç§æœåŠ¡å°±å« <strong>STUN</strong> (Session Traversal Utilities for NATï¼ŒNATä¼šè¯ç©¿è¶Šåº”ç”¨ç¨‹åº)ã€‚å®ƒçš„å·¥ä½œæµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><ul><li>ç¬”è®°æœ¬å‘ STUN æœåŠ¡å™¨å‘é€ä¸€ä¸ªè¯·æ±‚ï¼šâ€œä»ä½ çš„è§’åº¦çœ‹ï¼Œæˆ‘çš„åœ°å€ä»€ä¹ˆï¼Ÿâ€</li><li>STUN æœåŠ¡å™¨è¿”å›ä¸€ä¸ªå“åº”ï¼šâ€œæˆ‘çœ‹åˆ°ä½ çš„ UDP åŒ…æ˜¯ä»è¿™ä¸ªåœ°å€æ¥çš„ï¼š<code>ip:port</code>â€ã€‚</li></ul><p><img src="https://img.hi-linux.com/staticfile/2022-03-26-17-27-yqHlMG-20220330101057816-2022-03-30-PeORYt.jpg" alt></p><h2><span id="ä¸­ç»§æ˜¯ä»€ä¹ˆ">ä¸­ç»§æ˜¯ä»€ä¹ˆ</span></h2><p>å¯¹äº <strong>Hard NAT</strong> æ¥è¯´ï¼ŒSTUN å°±ä¸å¥½ä½¿äº†ï¼Œå³ä½¿ STUN æ‹¿åˆ°äº†å®¢æˆ·ç«¯çš„å…¬ç½‘ <code>ip:port</code> å‘Šè¯‰é€šä¿¡å¯¹ç«¯ä¹Ÿäºäº‹æ— è¡¥ï¼Œå› ä¸ºé˜²ç«å¢™æ˜¯å’Œ STUN é€šä¿¡æ‰æ‰“å¼€çš„ç¼ºå£ï¼Œè¿™ä¸ªç¼ºå£åªå…è®¸ STUN çš„å…¥å‘åŒ…è¿›å…¥ï¼Œå…¶ä»–é€šä¿¡å¯¹ç«¯çŸ¥é“äº†è¿™ä¸ªç¼ºå£ä¹Ÿè¿›ä¸æ¥ã€‚é€šå¸¸ä¼ä¸šçº§ NAT éƒ½å±äº Hard NATã€‚</p><p>è¿™ç§æƒ…å†µä¸‹æ‰“æ´æ˜¯ä¸å¯èƒ½äº†ï¼Œä½†ä¹Ÿä¸èƒ½å°±æ­¤æ”¾å¼ƒï¼Œå¯ä»¥é€‰æ‹©ä¸€ç§æŠ˜è¡·çš„æ–¹å¼ï¼šåˆ›å»ºä¸€ä¸ªä¸­ç»§æœåŠ¡å™¨ï¼ˆrelay serverï¼‰ï¼Œå®¢æˆ·ç«¯ä¸ä¸­ç»§æœåŠ¡å™¨è¿›è¡Œé€šä¿¡ï¼Œä¸­ç»§æœåŠ¡å™¨å†å°†åŒ…ä¸­ç»§ï¼ˆrelayï¼‰ç»™é€šä¿¡å¯¹ç«¯ã€‚</p><p>è‡³äºä¸­ç»§çš„æ€§èƒ½ï¼Œé‚£è¦çœ‹å…·ä½“æƒ…å†µäº†ï¼š</p><ul><li>å¦‚æœèƒ½ç›´è¿ï¼Œé‚£æ˜¾ç„¶æ²¡å¿…è¦ç”¨ä¸­ç»§æ–¹å¼ï¼›</li><li>ä½†å¦‚æœæ— æ³•ç›´è¿ï¼Œè€Œä¸­ç»§è·¯å¾„åˆéå¸¸æ¥è¿‘åŒæ–¹ç›´è¿çš„çœŸå®è·¯å¾„ï¼Œå¹¶ä¸”å¸¦å®½è¶³å¤Ÿå¤§ï¼Œé‚£ä¸­ç»§æ–¹å¼å¹¶ä¸ä¼šæ˜æ˜¾é™ä½é€šä¿¡è´¨é‡ã€‚å»¶è¿Ÿè‚¯å®šä¼šå¢åŠ ä¸€ç‚¹ï¼Œå¸¦å®½ä¼šå ç”¨ä¸€äº›ï¼Œä½†<strong>ç›¸æ¯”å®Œå…¨è¿æ¥ä¸ä¸Šï¼Œè¿˜æ˜¯å¯ä»¥æ¥å—çš„</strong>ã€‚</li></ul><p>äº‹å®ä¸Šå¯¹äºå¤§éƒ¨åˆ†ç½‘ç»œè€Œè¨€ï¼ŒTailscale éƒ½å¯ä»¥é€šè¿‡å„ç§é»‘ç§‘æŠ€æ‰“æ´æˆåŠŸï¼Œåªæœ‰æå°‘æ•°æƒ…å†µä¸‹æ‰ä¼šé€‰æ‹©ä¸­ç»§ï¼Œä¸­ç»§åªæ˜¯ä¸€ç§ fallback æœºåˆ¶ã€‚</p><h2><span id="ä¸­ç»§åè®®ç®€ä»‹">ä¸­ç»§åè®®ç®€ä»‹</span></h2><p>ä¸­ç»§åè®®æœ‰å¤šç§å®ç°æ–¹å¼ã€‚</p><h3><span id="turn">TURN</span></h3><p>TURN å³ Traversal Using Relays around NATï¼Œè¿™æ˜¯ä¸€ç§ç»å…¸çš„ä¸­ç»§å®ç°æ–¹å¼ï¼Œæ ¸å¿ƒç†å¿µæ˜¯ï¼š</p><ul><li><strong>ç”¨æˆ·</strong>ï¼ˆäººï¼‰å…ˆå»å…¬ç½‘ä¸Šçš„ TURN æœåŠ¡å™¨è®¤è¯ï¼ŒæˆåŠŸååè€…ä¼šå‘Šè¯‰ä½ ï¼šâ€œæˆ‘å·²ç»ä¸ºä½ åˆ†é…äº† ip:portï¼Œæ¥ä¸‹æ¥å°†ä¸ºä½ ä¸­ç»§æµé‡â€ï¼Œ</li><li>ç„¶åå°†è¿™ä¸ª ip:port åœ°å€å‘Šè¯‰å¯¹æ–¹ï¼Œè®©å®ƒå»è¿æ¥è¿™ä¸ªåœ°å€ï¼Œæ¥ä¸‹å»å°±æ˜¯éå¸¸ç®€å•çš„å®¢æˆ·ç«¯/æœåŠ¡å™¨é€šä¿¡æ¨¡å‹äº†ã€‚</li></ul><p>ä¸ STUN ä¸åŒï¼Œè¿™ç§åè®®æ²¡æœ‰çœŸæ­£çš„äº¤äº’æ€§ï¼Œä¸æ˜¯å¾ˆå¥½ç”¨ï¼Œå› æ­¤ Tailscale å¹¶æ²¡æœ‰é‡‡ç”¨ TURN ä½œä¸ºä¸­ç»§åè®®ã€‚</p><h3><span id="derp">DERP</span></h3><p>DERP å³ Detoured Encrypted Routing Protocolï¼Œè¿™æ˜¯ Tailscale è‡ªç ”çš„ä¸€ä¸ªåè®®ï¼š</p><ul><li>å®ƒæ˜¯ä¸€ä¸ª<strong>é€šç”¨ç›®çš„åŒ…ä¸­ç»§åè®®ï¼Œè¿è¡Œåœ¨ HTTP ä¹‹ä¸Š</strong>ï¼Œè€Œå¤§éƒ¨åˆ†ç½‘ç»œéƒ½æ˜¯å…è®¸ HTTP é€šä¿¡çš„ã€‚</li><li>å®ƒæ ¹æ®ç›®çš„å…¬é’¥ï¼ˆdestinationâ€™s public keyï¼‰æ¥ä¸­ç»§åŠ å¯†çš„æµé‡ï¼ˆencrypted payloadsï¼‰ã€‚</li></ul><p><img src="https://img.hi-linux.com/staticfile/2022-03-26-19-02-zLDv51-2022-03-30-KTRx7G.svg" alt="Tailscale ä¼šè‡ªåŠ¨é€‰æ‹©ç¦»ç›®æ ‡èŠ‚ç‚¹æœ€è¿‘çš„ DERP server æ¥ä¸­ç»§æµé‡"></p><p>Tailscale ä½¿ç”¨çš„ç®—æ³•å¾ˆæœ‰è¶£ï¼Œ<strong>æ‰€æœ‰å®¢æˆ·ç«¯ä¹‹é—´çš„è¿æ¥éƒ½æ˜¯å…ˆé€‰æ‹© DERP æ¨¡å¼ï¼ˆä¸­ç»§æ¨¡å¼ï¼‰ï¼Œè¿™æ„å‘³ç€è¿æ¥ç«‹å³å°±èƒ½å»ºç«‹ï¼ˆä¼˜å…ˆçº§æœ€ä½ä½† 100% èƒ½æˆåŠŸçš„æ¨¡å¼ï¼‰ï¼Œç”¨æˆ·ä¸ç”¨ä»»ä½•ç­‰å¾…</strong>ã€‚ç„¶åå¼€å§‹å¹¶è¡Œåœ°è¿›è¡Œè·¯å¾„å‘ç°ï¼Œé€šå¸¸å‡ ç§’é’Ÿä¹‹åï¼Œæˆ‘ä»¬å°±èƒ½å‘ç°ä¸€æ¡æ›´ä¼˜è·¯å¾„ï¼Œç„¶åå°†ç°æœ‰è¿æ¥é€æ˜å‡çº§ï¼ˆupgradeï¼‰è¿‡å»ï¼Œå˜æˆç‚¹å¯¹ç‚¹è¿æ¥ï¼ˆç›´è¿ï¼‰ã€‚</p><p>å› æ­¤ï¼ŒDERP æ—¢æ˜¯ Tailscale åœ¨ NAT ç©¿é€å¤±è´¥æ—¶çš„ä¿åº•é€šä¿¡æ–¹å¼ï¼ˆæ­¤æ—¶çš„è§’è‰²ä¸ TURN ç±»ä¼¼ï¼‰ï¼Œä¹Ÿæ˜¯åœ¨å…¶ä»–ä¸€äº›åœºæ™¯ä¸‹å¸®åŠ©æˆ‘ä»¬å®Œæˆ NAT ç©¿é€çš„æ—è·¯ä¿¡é“ã€‚ æ¢å¥è¯è¯´ï¼Œå®ƒæ—¢æ˜¯æˆ‘ä»¬çš„ä¿åº•æ–¹å¼ï¼Œä¹Ÿæ˜¯æœ‰æ›´å¥½çš„ç©¿é€é“¾è·¯æ—¶ï¼Œå¸®åŠ©æˆ‘ä»¬è¿›è¡Œè¿æ¥å‡çº§ï¼ˆupgrade to a peer-to-peer connectionï¼‰çš„åŸºç¡€è®¾æ–½ã€‚</p><h2><span id="è‡ªå»ºç§æœ‰-derp-server">è‡ªå»ºç§æœ‰ DERP server</span></h2><p>Tailscale çš„ç§é’¥åªä¼šä¿å­˜åœ¨å½“å‰èŠ‚ç‚¹ï¼Œå› æ­¤ DERP server æ— æ³•è§£å¯†æµé‡ï¼Œå®ƒåªèƒ½å’Œäº’è”ç½‘ä¸Šçš„å…¶ä»–è·¯ç”±å™¨ä¸€æ ·ï¼Œå‘†å‘†åœ°å°†åŠ å¯†çš„æµé‡ä»ä¸€ä¸ªèŠ‚ç‚¹è½¬å‘åˆ°å¦ä¸€ä¸ªèŠ‚ç‚¹ï¼Œåªä¸è¿‡ DERP ä½¿ç”¨äº†ä¸€ä¸ªç¨å¾®é«˜çº§ä¸€ç‚¹çš„åè®®æ¥é˜²æ­¢æ»¥ç”¨ã€‚</p><p>Tailscale å¼€æºäº† DERP æœåŠ¡å™¨çš„ä»£ç ï¼Œå¦‚æœä½ æ„Ÿå…´è¶£ï¼Œå¯ä»¥é˜…è¯» <a href="https://github.com/tailscale/tailscale/tree/main/derp" target="_blank" rel="noopener">DERP çš„æºä»£ç </a>ã€‚</p><p>Tailscale å®˜æ–¹å†…ç½®äº†å¾ˆå¤š DERP æœåŠ¡å™¨ï¼Œåˆ†æ­¥åœ¨å…¨çƒå„åœ°ï¼Œ<strong>æƒŸç‹¬ä¸åŒ…å«ä¸­å›½å¤§é™†</strong>ï¼ŒåŸå› ä½ æ‡‚å¾—ã€‚è¿™å°±å¯¼è‡´äº†ä¸€æ—¦æµé‡é€šè¿‡ DERP æœåŠ¡å™¨è¿›è¡Œä¸­ç»§ï¼Œå»¶æ—¶å°±ä¼šéå¸¸é«˜ã€‚è€Œä¸”å®˜æ–¹æä¾›çš„ DERP æœåŠ¡å™¨æ˜¯ä¸‡äººéª‘ï¼Œå­˜åœ¨å®‰å…¨éšæ‚£ã€‚</p><p>ä¸ºäº†å®ç°ä½å»¶è¿Ÿã€é«˜å®‰å…¨æ€§ï¼Œæˆ‘ä»¬å¯ä»¥å‚è€ƒ <a href="https://tailscale.com/kb/1118/custom-derp-servers/" target="_blank" rel="noopener">Tailscale å®˜æ–¹æ–‡æ¡£</a>è‡ªå»ºç§æœ‰çš„ DERP æœåŠ¡å™¨ã€‚æœ‰ä¸¤ç§éƒ¨ç½²æ¨¡å¼ï¼Œä¸€ç§æ˜¯åŸºäºåŸŸåï¼Œå¦å¤–ä¸€ç§ä¸éœ€è¦åŸŸåï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ IPï¼Œä¸è¿‡éœ€è¦ä¸€ç‚¹é»‘ç§‘æŠ€ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹æœ€ç®€å•çš„ä½¿ç”¨åŸŸåçš„æ–¹æ¡ˆã€‚</p><h3><span id="ä½¿ç”¨åŸŸå">ä½¿ç”¨åŸŸå</span></h3><p>è¿™ç§æ–¹æ¡ˆéœ€è¦æ»¡è¶³ä»¥ä¸‹å‡ ä¸ªæ¡ä»¶ï¼š</p><ul><li>è¦æœ‰è‡ªå·±çš„åŸŸåï¼Œå¹¶ä¸”ç”³è¯·äº† SSL è¯ä¹¦</li><li>éœ€è¦å‡†å¤‡ä¸€å°æˆ–å¤šå°äº‘ä¸»æœº</li><li>å¦‚æœæœåŠ¡å™¨åœ¨å›½å†…ï¼ŒåŸŸåéœ€è¦å¤‡æ¡ˆ</li><li>å¦‚æœæœåŠ¡å™¨åœ¨å›½å¤–ï¼Œåˆ™ä¸éœ€è¦å¤‡æ¡ˆ</li></ul><p>å¦‚æœä»¥ä¸Šæ¡ä»¶éƒ½ä¿±å¤‡ï¼Œå°±å¯ä»¥æŒ‰ç…§ä¸‹é¢çš„æ­¥éª¤å¼€å§‹éƒ¨ç½²äº†ã€‚</p><p>æ¨èç›´æ¥ä½¿ç”¨ Docker æ¥éƒ¨ç½²ï¼Œæˆ‘å·²ç»æ„å»ºå¥½äº† Docker é•œåƒï¼Œç›´æ¥éƒ¨ç½²å°±å¯ä»¥äº†ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ğŸ³  â†’ docker run --restart always \</span><br><span class="line">  --name derper -p 12345:12345 -p 3478:3478/udp \</span><br><span class="line">  -v /root/.acme.sh/xxxx/:/app/certs \</span><br><span class="line">  -e DERP_CERT_MODE=manual \</span><br><span class="line">  -e DERP_ADDR=:12345 \</span><br><span class="line">  -e DERP_DOMAIN=xxxx \</span><br><span class="line">  -d ghcr.io/yangchuansheng/derper:latest</span><br></pre></td></tr></table></figure><p>æœ‰å‡ ç‚¹éœ€è¦æ³¨æ„ï¼š</p><ul><li>èƒ½ç”¨ 443 ç«¯å£å°½é‡ç”¨ 443 ç«¯å£ï¼Œå®åœ¨ä¸è¡Œå†ç”¨åˆ«çš„ç«¯å£ï¼›</li><li>é»˜è®¤æƒ…å†µä¸‹ä¹Ÿä¼šå¼€å¯ STUN æœåŠ¡ï¼ŒUDP ç«¯å£æ˜¯ <code>3478</code>ï¼›</li><li>é˜²ç«å¢™éœ€è¦æ”¾è¡Œç«¯å£ 12345 å’Œ 3478ï¼›</li><li>å‡†å¤‡å¥½ SSL è¯ä¹¦ï¼›</li><li>åŸŸåéƒ¨åˆ†æˆ‘æ‰“äº†ç ï¼Œè¯·æ¢æˆä½ è‡ªå·±çš„åŸŸåã€‚</li></ul><p>å…³äºè¯ä¹¦éƒ¨åˆ†éœ€è¦é‡ç‚¹è¯´æ˜ï¼š<strong>å‡è®¾ä½ çš„åŸŸåæ˜¯ <code>xxx.com</code>ï¼Œé‚£ä¹ˆè¯ä¹¦çš„åç§°å¿…é¡»æ˜¯ <code>xxx.com.crt</code>ï¼Œä¸€ä¸ªå­—ç¬¦éƒ½ä¸èƒ½é”™ï¼åŒç†ï¼Œç§é’¥åç§°å¿…é¡»æ˜¯ <code>xxx.com.key</code>ï¼Œä¸€ä¸ªå­—ç¬¦éƒ½ä¸èƒ½é”™ï¼</strong></p><p>æŸ¥çœ‹å®¹å™¨æ—¥å¿—ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ğŸ³  â†’ docker logs -f derper</span><br><span class="line">2022/03/26 11:36:28 no config path specified; using /var/lib/derper/derper.key</span><br><span class="line">2022/03/26 11:36:28 derper: serving on :12345 with TLS</span><br><span class="line">2022/03/26 11:36:28 running STUN server on [::]:3478</span><br></pre></td></tr></table></figure><p>ç›®å‰ derper è¿è¡Œä¸€æ®µæ—¶é—´å°±ä¼šå´©æºƒï¼Œæš‚æ—¶è¿˜æ²¡æœ‰æ›´å¥½çš„è§£å†³æ–¹æ¡ˆï¼Œåªèƒ½é€šè¿‡å®šæ—¶é‡å¯æ¥è§£å†³ï¼Œæ¯”å¦‚é€šè¿‡ crontab æ¥è®¾ç½®æ¯ä¸¤å°æ—¶é‡å¯ä¸€æ¬¡å®¹å™¨ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 */2 * * * docker restart derper &amp;&gt; /dev/null</span><br></pre></td></tr></table></figure><p>å…·ä½“å¯å‚è€ƒè¿™ä¸ª issueï¼š<a href="https://github.com/tailscale/tailscale/issues/4082" target="_blank" rel="noopener">Derper TLS handshake error: remote error: tls: internal error</a></p><p>éƒ¨ç½²å¥½ derper ä¹‹åï¼Œå°±å¯ä»¥ä¿®æ”¹ Headscale çš„é…ç½®æ¥ä½¿ç”¨è‡ªå®šä¹‰çš„ DERP æœåŠ¡å™¨äº†ã€‚Headscale å¯ä»¥é€šè¿‡ä¸¤ç§å½¢å¼çš„é…ç½®æ¥ä½¿ç”¨è‡ªå®šä¹‰ DERPï¼š</p><ul><li>ä¸€ç§æ˜¯åœ¨çº¿ URLï¼Œæ ¼å¼æ˜¯ <code>JSON</code>ï¼Œä¸ Tailscale å®˜æ–¹æ§åˆ¶æœåŠ¡å™¨ä½¿ç”¨çš„æ ¼å¼å’Œè¯­æ³•ç›¸åŒã€‚</li><li>å¦ä¸€ç§æ˜¯æœ¬åœ°æ–‡ä»¶ï¼Œæ ¼å¼æ˜¯ <code>YAML</code>ã€‚</li></ul><p>æˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨æœ¬åœ°çš„ YAML é…ç½®æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /etc/headscale/derp.yaml</span></span><br><span class="line"><span class="attr">regions:</span></span><br><span class="line">  <span class="attr">900:</span></span><br><span class="line">    <span class="attr">regionid:</span> <span class="number">900</span></span><br><span class="line">    <span class="attr">regioncode:</span> <span class="string">thk</span> </span><br><span class="line">    <span class="attr">regionname:</span> <span class="string">Tencent</span> <span class="string">Hongkong</span> </span><br><span class="line">    <span class="attr">nodes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">900a</span></span><br><span class="line">        <span class="attr">regionid:</span> <span class="number">900</span></span><br><span class="line">        <span class="attr">hostname:</span> <span class="string">xxxx</span></span><br><span class="line">        <span class="attr">ipv4:</span> <span class="string">xxxx</span></span><br><span class="line">        <span class="attr">stunport:</span> <span class="number">3478</span></span><br><span class="line">        <span class="attr">stunonly:</span> <span class="literal">false</span></span><br><span class="line">        <span class="attr">derpport:</span> <span class="number">12345</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">900b</span></span><br><span class="line">        <span class="attr">regionid:</span> <span class="number">900</span></span><br><span class="line">        <span class="attr">hostname:</span> <span class="string">xxxx</span></span><br><span class="line">        <span class="attr">ipv4:</span> <span class="string">xxxx</span></span><br><span class="line">        <span class="attr">stunport:</span> <span class="number">3478</span></span><br><span class="line">        <span class="attr">stunonly:</span> <span class="literal">false</span></span><br><span class="line">        <span class="attr">derpport:</span> <span class="number">12345</span></span><br><span class="line">  <span class="attr">901:</span></span><br><span class="line">    <span class="attr">regionid:</span> <span class="number">901</span></span><br><span class="line">    <span class="attr">regioncode:</span> <span class="string">hs</span> </span><br><span class="line">    <span class="attr">regionname:</span> <span class="string">Huawei</span> <span class="string">Shanghai</span> </span><br><span class="line">    <span class="attr">nodes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">901a</span></span><br><span class="line">        <span class="attr">regionid:</span> <span class="number">901</span></span><br><span class="line">        <span class="attr">hostname:</span> <span class="string">xxxx</span></span><br><span class="line">        <span class="attr">ipv4:</span> <span class="string">xxxx</span></span><br><span class="line">        <span class="attr">stunport:</span> <span class="number">3478</span></span><br><span class="line">        <span class="attr">stunonly:</span> <span class="literal">false</span></span><br><span class="line">        <span class="attr">derpport:</span> <span class="number">12345</span></span><br></pre></td></tr></table></figure><p>é…ç½®è¯´æ˜ï¼š</p><ul><li><code>regions</code> æ˜¯ YAML ä¸­çš„<strong>å¯¹è±¡</strong>ï¼Œä¸‹é¢çš„æ¯ä¸€ä¸ªå¯¹è±¡è¡¨ç¤ºä¸€ä¸ª<strong>å¯ç”¨åŒº</strong>ï¼Œæ¯ä¸ª<strong>å¯ç”¨åŒº</strong>é‡Œé¢å¯è®¾ç½®å¤šä¸ª DERP èŠ‚ç‚¹ï¼Œå³ <code>nodes</code>ã€‚</li><li>æ¯ä¸ªå¯ç”¨åŒºçš„ <code>regionid</code> ä¸èƒ½é‡å¤ã€‚</li><li>æ¯ä¸ª <code>node</code> çš„ <code>name</code> ä¸èƒ½é‡å¤ã€‚</li><li><code>regionname</code> ä¸€èˆ¬ç”¨æ¥æè¿°å¯ç”¨åŒºï¼Œ<code>regioncode</code> ä¸€èˆ¬è®¾ç½®æˆå¯ç”¨åŒºçš„ç¼©å†™ã€‚</li><li><code>ipv4</code> å­—æ®µä¸æ˜¯å¿…é¡»çš„ï¼Œå¦‚æœä½ çš„åŸŸåå¯ä»¥é€šè¿‡å…¬ç½‘è§£æåˆ°ä½ çš„ DERP æœåŠ¡å™¨åœ°å€ï¼Œè¿™é‡Œå¯ä»¥ä¸å¡«ã€‚å¦‚æœä½ ä½¿ç”¨äº†ä¸€ä¸ªäºŒçº§åŸŸåï¼Œè€Œè¿™ä¸ªåŸŸåä½ å¹¶æ²¡æœ‰åœ¨å…¬å…± DNS server ä¸­æ·»åŠ ç›¸å…³çš„è§£æè®°å½•ï¼Œé‚£ä¹ˆè¿™é‡Œå°±éœ€è¦æŒ‡å®š IPï¼ˆå‰ææ˜¯ä½ çš„è¯ä¹¦åŒ…å«äº†è¿™ä¸ªäºŒçº§åŸŸåï¼Œè¿™ä¸ªå¾ˆå¥½æ”¯æŒï¼Œæä¸ªæ³›åŸŸåè¯ä¹¦å°±è¡Œäº†ï¼‰ã€‚</li><li><code>stunonly: false</code> è¡¨ç¤ºé™¤äº†ä½¿ç”¨ STUN æœåŠ¡ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ DERP æœåŠ¡ã€‚</li><li>ä¸Šé¢çš„é…ç½®ä¸­åŸŸåå’Œ IP éƒ¨åˆ†æˆ‘éƒ½æ‰“ç äº†ï¼Œä½ éœ€è¦æ ¹æ®ä½ çš„å®é™…æƒ…å†µå¡«å†™ã€‚</li></ul><p>æ¥ä¸‹æ¥è¿˜éœ€è¦ä¿®æ”¹ Headscale çš„é…ç½®æ–‡ä»¶ï¼Œå¼•ç”¨ä¸Šé¢çš„è‡ªå®šä¹‰ DERP é…ç½®æ–‡ä»¶ã€‚éœ€è¦ä¿®æ”¹çš„é…ç½®é¡¹å¦‚ä¸‹ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /etc/headscale/config.yaml</span></span><br><span class="line"><span class="attr">derp:</span></span><br><span class="line">  <span class="comment"># List of externally available DERP maps encoded in JSON</span></span><br><span class="line">  <span class="attr">urls:</span></span><br><span class="line">  <span class="comment">#  - https://controlplane.tailscale.com/derpmap/default</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Locally available DERP map files encoded in YAML</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># This option is mostly interesting for people hosting</span></span><br><span class="line">  <span class="comment"># their own DERP servers:</span></span><br><span class="line">  <span class="comment"># https://tailscale.com/kb/1118/custom-derp-servers/</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># paths:</span></span><br><span class="line">  <span class="comment">#   - /etc/headscale/derp-example.yaml</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/etc/headscale/derp.yaml</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># If enabled, a worker will be set up to periodically</span></span><br><span class="line">  <span class="comment"># refresh the given sources and update the derpmap</span></span><br><span class="line">  <span class="comment"># will be set up.</span></span><br><span class="line">  <span class="attr">auto_update_enabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># How often should we check for DERP updates?</span></span><br><span class="line">  <span class="attr">update_frequency:</span> <span class="string">24h</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥æŠŠ Tailscale å®˜æ–¹çš„ DERP æœåŠ¡å™¨ç¦ç”¨ï¼Œæ¥æµ‹è¯•è‡ªå»ºçš„ DERP æœåŠ¡å™¨æ˜¯å¦èƒ½æ­£å¸¸å·¥ä½œã€‚</p><p>ä¿®æ”¹å®Œé…ç½®åï¼Œé‡å¯ headscale æœåŠ¡ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ systemctl restart headscale</span><br></pre></td></tr></table></figure><p>åœ¨ Tailscale å®¢æˆ·ç«¯ä¸Šä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹ç›®å‰å¯ä»¥ä½¿ç”¨çš„ DERP æœåŠ¡å™¨ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ tailscale netcheck</span><br><span class="line"></span><br><span class="line">Report:</span><br><span class="line">        * UDP: <span class="literal">true</span></span><br><span class="line">        * IPv4: yes, xxxxx:57068</span><br><span class="line">        * IPv6: no</span><br><span class="line">        * MappingVariesByDestIP: <span class="literal">false</span></span><br><span class="line">        * HairPinning: <span class="literal">false</span></span><br><span class="line">        * PortMapping: </span><br><span class="line">        * Nearest DERP: Tencent Hongkong</span><br><span class="line">        * DERP latency:</span><br><span class="line">                - thk: 39.7ms (Tencent Hongkong)</span><br></pre></td></tr></table></figure><p><code>tailscale netcheck</code> å®é™…ä¸Šåªæ£€æµ‹ <code>3478/udp</code> çš„ç«¯å£ï¼Œ å°±ç®— netcheck æ˜¾ç¤ºèƒ½è¿ï¼Œä¹Ÿä¸ä¸€å®šä»£è¡¨ 12345 ç«¯å£å¯ä»¥è½¬å‘æµé‡ã€‚æœ€ç®€å•çš„åŠæ³•æ˜¯ç›´æ¥æ‰“å¼€ DERP æœåŠ¡å™¨çš„ URLï¼š<a href="https://xxxx:12345" target="_blank" rel="noopener">https://xxxx:12345</a>ï¼Œå¦‚æœçœ‹åˆ°å¦‚ä¸‹é¡µé¢ï¼Œä¸”åœ°å€æ çš„ SSL è¯ä¹¦æ ‡ç­¾æ˜¾ç¤ºæ­£å¸¸å¯ç”¨ï¼Œé‚£æ‰æ˜¯çœŸæ²¡é—®é¢˜äº†ã€‚</p><p><img src="https://img.hi-linux.com/staticfile/2022-03-27-11-21-dZ5dtZ-2022-03-30-jkEw4r.png" alt></p><p>æŸ¥çœ‹ä¸é€šä¿¡å¯¹ç«¯çš„è¿æ¥æ–¹å¼ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ tailscale status</span><br><span class="line">10.1.0.5        coredns              default      linux   -</span><br><span class="line">                carsondemacbook-pro  default      macOS   active; direct xxxx:2756; offline, tx 50424 rx 34056</span><br><span class="line">                oneplus-8t           default      android active; relay <span class="string">"thk"</span>; offline, tx 1608 rx 1552</span><br><span class="line">                openwrt              default      linux   active; direct xxxx:2834; offline, tx 1403688 rx 1217620</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå®¢æˆ·ç«¯æ˜¯ä¸€å°äº‘ä¸»æœºï¼Œæœ‰ 3 ä¸ªé€šä¿¡å¯¹ç«¯ï¼Œåˆ†åˆ«æ˜¯ macOSã€OpenWRT ä¸ Android æ‰‹æœºï¼ŒmacOS å’Œ OpenWRT éƒ½å¤„äºç”µä¿¡å®¶åº­å†…ç½‘ä¸­ï¼ŒAndroid æ‰‹æœºä½¿ç”¨çš„æ˜¯ç”µä¿¡æµé‡ã€‚å¯ä»¥çœ‹åˆ°åªæœ‰ Android æ‰‹æœºæ˜¯é€šè¿‡è‡ªå®šä¹‰çš„ DERP æœåŠ¡å™¨æ¥ä¸­ç»§æµé‡çš„ï¼Œæ‰“æ´æˆåŠŸç‡ç›¸å½“é«˜ã€‚ä½¿ç”¨ ping æ¥æµ‹è¯•è¿é€šæ€§ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ ping 10.1.0.8</span><br><span class="line">PING 10.1.0.8 (10.1.0.8) 56(84) bytes of data.</span><br><span class="line">64 bytes from 10.1.0.8: icmp_seq=1 ttl=64 time=150 ms</span><br><span class="line">64 bytes from 10.1.0.8: icmp_seq=2 ttl=64 time=131 ms</span><br><span class="line">64 bytes from 10.1.0.8: icmp_seq=3 ttl=64 time=161 ms</span><br><span class="line">64 bytes from 10.1.0.8: icmp_seq=4 ttl=64 time=137 ms</span><br><span class="line">64 bytes from 10.1.0.8: icmp_seq=5 ttl=64 time=156 ms</span><br><span class="line">64 bytes from 10.1.0.8: icmp_seq=6 ttl=64 time=169 ms</span><br><span class="line">^C</span><br><span class="line">--- 10.1.0.8 ping statistics ---</span><br><span class="line">6 packets transmitted, 6 received, 0% packet loss, time 5005ms</span><br><span class="line">rtt min/avg/max/mdev = 131.728/151.154/169.627/13.193 ms</span><br></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥ä½¿ç”¨ Tailscale å‘½ä»¤è¡Œå·¥å…·æ¥æµ‹è¯•ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ tailscale ping 10.1.0.8</span><br><span class="line">pong from oneplus-8t (10.1.0.8) via DERP(thk) <span class="keyword">in</span> 104ms</span><br><span class="line">pong from oneplus-8t (10.1.0.8) via DERP(thk) <span class="keyword">in</span> 111ms</span><br><span class="line">pong from oneplus-8t (10.1.0.8) via DERP(thk) <span class="keyword">in</span> 105ms</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ›´åŠ å‹å¥½ä¸€ç‚¹ï¼Œä¼šç›´æ¥å‘Šè¯‰ä½ æ˜¯é€šè¿‡ DERP ä¸­ç»§æœåŠ¡å™¨æ¥å’Œå¯¹æ–¹é€šä¿¡çš„ã€‚</p><p>å¦‚æœå½“å‰ Tailscale å®¢æˆ·ç«¯æ‰€åœ¨ä¸»æœºå¼€å¯äº† IPv6ï¼Œé‚£ä¹ˆä¸æ‰‹æœºä¾¿å¯ä»¥ç›´æ¥é€šè¿‡ IPv6 ç‚¹å¯¹ç‚¹è¿æ¥ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ /Applications/Tailscale.app/Contents/MacOS/Tailscale status</span><br><span class="line">                coredns              default      linux   active; direct xxxx:45986; offline, tx 124352 rx 185736</span><br><span class="line">                oneplus-8t           default      android active; direct [240e:472:da0:24a2:a07f:2a67:2a1e:4475]:37237; offline, tx 125216 rx 20052</span><br><span class="line">                openwrt              default      linux   active; direct [240e:390:caf:1870:c02c:e8ff:feb9:b0b]:41641; offline, tx 181992 rx 3910120</span><br><span class="line"></span><br><span class="line">$ /Applications/Tailscale.app/Contents/MacOS/Tailscale ping 10.1.0.8</span><br><span class="line">pong from oneplus-8t (10.1.0.8) via [240e:472:da0:24a2:a07f:2a67:2a1e:4475]:37237 <span class="keyword">in</span> 62ms</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥å¦‚æœä½ å¼€å¯äº† IPv6ï¼Œå¯ä»¥å¤§å¤§å¢åŠ <strong>ç‚¹å¯¹ç‚¹è¿æ¥</strong>çš„æˆåŠŸç‡ã€‚</p><h3><span id="ä½¿ç”¨çº¯-ip">ä½¿ç”¨çº¯ IP</span></h3><p>æˆ‘çŸ¥é“ï¼Œå¤§éƒ¨åˆ†äººæ˜¯æ²¡æœ‰è‡ªå·±çš„åŸŸåçš„ã€‚å†é€€ä¸€æ­¥ï¼Œå°±ç®—æœ‰è‡ªå·±çš„åŸŸåï¼Œå¦‚æœæ²¡æœ‰å¤‡æ¡ˆï¼Œä¹Ÿæ˜¯æ²¡åŠæ³•éƒ¨ç½²åœ¨å›½å†…æœåŠ¡å™¨ä¸Šä½¿ç”¨çš„ã€‚</p><p>è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±åªèƒ½ä» derper æºç ä¸ŠåŠ¨æ‰‹è„šäº†ï¼Œæ‰¾åˆ° tailscale ä»“åº“ä¸­çš„ <code>cmd/derper/cert.go</code> æ–‡ä»¶ï¼Œå°†ä¸åŸŸåéªŒè¯ç›¸å…³çš„å†…å®¹åˆ é™¤æˆ–æ³¨é‡Šï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *manualCertManager)</span> <span class="title">getCertificate</span><span class="params">(hi *tls.ClientHelloInfo)</span> <span class="params">(*tls.Certificate, error)</span></span> &#123;</span><br><span class="line"><span class="comment">//if hi.ServerName != m.hostname &#123;</span></span><br><span class="line"><span class="comment">//return nil, fmt.Errorf("cert mismatch with hostname: %q", hi.ServerName)</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"><span class="keyword">return</span> m.cert, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿˜éœ€è¦åˆ›å»ºè‡ªç­¾åè¯ä¹¦ï¼Œå¯ä»¥é€šè¿‡è„šæœ¬æ¥åˆ›å»ºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># build_cert.sh</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">CERT_HOST=<span class="variable">$1</span></span><br><span class="line">CERT_DIR=<span class="variable">$2</span></span><br><span class="line">CONF_FILE=<span class="variable">$3</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"[req]</span></span><br><span class="line"><span class="string">default_bits  = 2048</span></span><br><span class="line"><span class="string">distinguished_name = req_distinguished_name</span></span><br><span class="line"><span class="string">req_extensions = req_ext</span></span><br><span class="line"><span class="string">x509_extensions = v3_req</span></span><br><span class="line"><span class="string">prompt = no</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[req_distinguished_name]</span></span><br><span class="line"><span class="string">countryName = XX</span></span><br><span class="line"><span class="string">stateOrProvinceName = N/A</span></span><br><span class="line"><span class="string">localityName = N/A</span></span><br><span class="line"><span class="string">organizationName = Self-signed certificate</span></span><br><span class="line"><span class="string">commonName = <span class="variable">$CERT_HOST</span>: Self-signed certificate</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[req_ext]</span></span><br><span class="line"><span class="string">subjectAltName = @alt_names</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[v3_req]</span></span><br><span class="line"><span class="string">subjectAltName = @alt_names</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[alt_names]</span></span><br><span class="line"><span class="string">IP.1 = <span class="variable">$CERT_HOST</span></span></span><br><span class="line"><span class="string">"</span> &gt; <span class="string">"<span class="variable">$CONF_FILE</span>"</span></span><br><span class="line"></span><br><span class="line">mkdir -p <span class="string">"<span class="variable">$CERT_DIR</span>"</span></span><br><span class="line">openssl req -x509 -nodes -days 730 -newkey rsa:2048 -keyout <span class="string">"<span class="variable">$CERT_DIR</span>/<span class="variable">$CERT_HOST</span>.key"</span> -out <span class="string">"<span class="variable">$CERT_DIR</span>/<span class="variable">$CERT_HOST</span>.crt"</span> -config <span class="string">"<span class="variable">$CONF_FILE</span>"</span></span><br></pre></td></tr></table></figure><p>é‡æ–°ç¼–å†™ Dockerfileï¼Œå°† derper çš„åŸŸåè®¾ç½®ä¸º <code>127.0.0.1</code>ï¼š</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> golang:latest AS builder</span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /app</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ========= CONFIG =========</span></span><br><span class="line"><span class="comment"># - download links</span></span><br><span class="line"><span class="keyword">ENV</span> MODIFIED_DERPER_GIT=https://github.com/yangchuansheng/ip_derper.git</span><br><span class="line"><span class="keyword">ENV</span> BRANCH=ip_derper</span><br><span class="line"><span class="comment"># ==========================</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># build modified derper</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> git <span class="built_in">clone</span> -b <span class="variable">$BRANCH</span> <span class="variable">$MODIFIED_DERPER_GIT</span> tailscale --depth 1 &amp;&amp; \</span></span><br><span class="line"><span class="bash">    <span class="built_in">cd</span> /app/tailscale/cmd/derper &amp;&amp; \</span></span><br><span class="line"><span class="bash">    /usr/<span class="built_in">local</span>/go/bin/go build -ldflags <span class="string">"-s -w"</span> -o /app/derper &amp;&amp; \</span></span><br><span class="line"><span class="bash">    <span class="built_in">cd</span> /app &amp;&amp; \</span></span><br><span class="line"><span class="bash">    rm -rf /app/tailscale</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">20.04</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /app</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ========= CONFIG =========</span></span><br><span class="line"><span class="comment"># - derper args</span></span><br><span class="line"><span class="keyword">ENV</span> DERP_HOST=<span class="number">127.0</span>.<span class="number">0.1</span></span><br><span class="line"><span class="keyword">ENV</span> DERP_CERTS=/app/certs/</span><br><span class="line"><span class="keyword">ENV</span> DERP_STUN true</span><br><span class="line"><span class="keyword">ENV</span> DERP_VERIFY_CLIENTS false</span><br><span class="line"><span class="comment"># ==========================</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># apt</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update &amp;&amp; \</span></span><br><span class="line"><span class="bash">    apt-get install -y openssl curl</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> build_cert.sh /app/</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> --from=builder /app/derper /app/derper</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># build self-signed certs &amp;&amp; start derper</span></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> bash /app/build_cert.sh <span class="variable">$DERP_HOST</span> <span class="variable">$DERP_CERTS</span> /app/san.conf &amp;&amp; \</span></span><br><span class="line"><span class="bash">    /app/derper --hostname=<span class="variable">$DERP_HOST</span> \</span></span><br><span class="line"><span class="bash">    --certmode=manual \</span></span><br><span class="line"><span class="bash">    --certdir=<span class="variable">$DERP_CERTS</span> \</span></span><br><span class="line"><span class="bash">    --stun=<span class="variable">$DERP_STUN</span>  \</span></span><br><span class="line"><span class="bash">    --verify-clients=<span class="variable">$DERP_VERIFY_CLIENTS</span></span></span><br></pre></td></tr></table></figure><p>æ„å»ºå¥½é•œåƒåï¼Œå°±å¯ä»¥åœ¨ä½ æƒ³éƒ¨ç½² derper çš„ä¸»æœºä¸Šç›´æ¥é€šè¿‡è¯¥é•œåƒå¯åŠ¨ derper å®¹å™¨äº†ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ğŸ³  â†’ docker run --restart always --net host --name derper -d ghcr.io/yangchuansheng/ip_derper</span><br></pre></td></tr></table></figure><p>å’Œä½¿ç”¨åŸŸåçš„æ–¹æ¡ˆä¸€æ ·ï¼Œé˜²ç«å¢™éœ€è¦æ”¾è¡Œç›¸åº”ç«¯å£ï¼ˆ12345 ä¸ 3478ï¼‰ã€‚</p><p>æŸ¥çœ‹å®¹å™¨æ—¥å¿—ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ğŸ³  â†’ docker logs -f derper</span><br><span class="line">Generating a RSA private key</span><br><span class="line">.......................................+++++</span><br><span class="line">..............+++++</span><br><span class="line">writing new private key to <span class="string">'/app/certs//127.0.0.1.key'</span></span><br><span class="line">-----</span><br><span class="line">2022/03/26 14:30:31 no config path specified; using /var/lib/derper/derper.key</span><br><span class="line">2022/03/26 14:30:31 derper: serving on :443 with TLS</span><br><span class="line">2022/03/26 14:30:31 running STUN server on [::]:3478</span><br></pre></td></tr></table></figure><p>å¦‚æœä½ æƒ³è‡ªå·±æ„å»º derper é•œåƒï¼Œå¯ä»¥å‚è€ƒ<a href="https://github.com/yangchuansheng/ip_derper" target="_blank" rel="noopener">æˆ‘çš„ GitHub ä»“åº“</a>ã€‚</p><p>ä¸‹é¢å°±æ˜¯éªšæ“ä½œäº†ï¼Œæˆ‘ä»¬åœ¨ Headscale çš„é…ç½®ä¸­éœ€è¦<strong>å°† DERP çš„åŸŸåè®¾ç½®ä¸º IP</strong>ï¼ä¸ç†è§£çš„å¯ä»¥å†æ¶ˆåŒ–ä¸€ä¸‹ï¼Œç„¶åç»§ç»­å¾€ä¸‹çœ‹å“ˆå“ˆ~~</p><p>é™¤äº† derper ä¹‹å¤–ï¼ŒTailscale å®¢æˆ·ç«¯è¿˜éœ€è¦<strong>è·³è¿‡åŸŸåéªŒè¯</strong>ï¼Œè¿™ä¸ªéœ€è¦åœ¨ DERP çš„é…ç½®ä¸­è®¾ç½®ã€‚è€Œ Headscale çš„æœ¬åœ° YAML æ–‡ä»¶ç›®å‰è¿˜ä¸æ”¯æŒè¿™ä¸ªé…ç½®é¡¹ï¼Œæ‰€ä»¥æ²¡åŠæ³•ï¼Œå’±åªèƒ½ä½¿ç”¨åœ¨çº¿ URL äº†ã€‚JSON é…ç½®å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"Regions"</span>: &#123;</span><br><span class="line">    <span class="attr">"901"</span>: &#123;</span><br><span class="line">      <span class="attr">"RegionID"</span>: <span class="number">901</span>,</span><br><span class="line">      <span class="attr">"RegionCode"</span>: <span class="string">"ali-sh"</span>,</span><br><span class="line">      <span class="attr">"RegionName"</span>: <span class="string">"Aliyun Shanghai"</span>,</span><br><span class="line">      <span class="attr">"Nodes"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">"Name"</span>: <span class="string">"901a"</span>,</span><br><span class="line">          <span class="attr">"RegionID"</span>: <span class="number">901</span>,</span><br><span class="line">          <span class="attr">"DERPPort"</span>: <span class="number">443</span>,</span><br><span class="line">          <span class="attr">"HostName"</span>: <span class="string">"xxxx"</span>,</span><br><span class="line">          <span class="attr">"IPv4"</span>: <span class="string">"xxxx"</span>,</span><br><span class="line">          <span class="attr">"InsecureForTests"</span>: <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é…ç½®è§£æï¼š</p><ul><li><code>HostName</code> ç›´æ¥å¡« derper çš„å…¬ç½‘ IPï¼Œå³å’Œ <code>IPv4</code> çš„å€¼ç›¸åŒã€‚</li><li><code>InsecureForTests</code> ä¸€å®šè¦è®¾ç½®ä¸º trueï¼Œä»¥è·³è¿‡åŸŸåéªŒè¯ã€‚</li></ul><p>ä½ éœ€è¦æŠŠè¿™ä¸ª JSON æ–‡ä»¶å˜æˆ Headscale æœåŠ¡å™¨å¯ä»¥è®¿é—®çš„ URLï¼Œæ¯”å¦‚åœ¨ Headscale ä¸»æœºä¸Šæ­ä¸ª Nginxï¼Œæˆ–è€…ä¸Šä¼ åˆ°å¯¹è±¡å­˜å‚¨ï¼ˆæ¯”å¦‚é˜¿é‡Œäº‘ OSSï¼‰ã€‚</p><p>æ¥ä¸‹æ¥è¿˜éœ€è¦ä¿®æ”¹ Headscale çš„é…ç½®æ–‡ä»¶ï¼Œå¼•ç”¨ä¸Šé¢çš„è‡ªå®šä¹‰ DERP çš„ URLã€‚éœ€è¦ä¿®æ”¹çš„é…ç½®é¡¹å¦‚ä¸‹ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /etc/headscale/config.yaml</span></span><br><span class="line"><span class="attr">derp:</span></span><br><span class="line">  <span class="comment"># List of externally available DERP maps encoded in JSON</span></span><br><span class="line">  <span class="attr">urls:</span></span><br><span class="line">  <span class="comment">#  - https://controlplane.tailscale.com/derpmap/default</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">https://xxxxx/derp.json</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Locally available DERP map files encoded in YAML</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># This option is mostly interesting for people hosting</span></span><br><span class="line">  <span class="comment"># their own DERP servers:</span></span><br><span class="line">  <span class="comment"># https://tailscale.com/kb/1118/custom-derp-servers/</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># paths:</span></span><br><span class="line">  <span class="comment">#   - /etc/headscale/derp-example.yaml</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/etc/headscale/derp.yaml</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># If enabled, a worker will be set up to periodically</span></span><br><span class="line">  <span class="comment"># refresh the given sources and update the derpmap</span></span><br><span class="line">  <span class="comment"># will be set up.</span></span><br><span class="line">  <span class="attr">auto_update_enabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># How often should we check for DERP updates?</span></span><br><span class="line">  <span class="attr">update_frequency:</span> <span class="string">24h</span></span><br></pre></td></tr></table></figure><p>ä¿®æ”¹å®Œé…ç½®åï¼Œé‡å¯ headscale æœåŠ¡ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ systemctl restart headscale</span><br></pre></td></tr></table></figure><p>åœ¨ Tailscale å®¢æˆ·ç«¯ä¸Šä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹ç›®å‰å¯ä»¥ä½¿ç”¨çš„ DERP æœåŠ¡å™¨ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ tailscale netcheck</span><br><span class="line"></span><br><span class="line">Report:</span><br><span class="line">* UDP: <span class="literal">true</span></span><br><span class="line">* IPv4: yes, 192.168.100.1:49656</span><br><span class="line">* IPv6: no</span><br><span class="line">* MappingVariesByDestIP: <span class="literal">true</span></span><br><span class="line">* HairPinning: <span class="literal">false</span></span><br><span class="line">* PortMapping: UPnP</span><br><span class="line">* Nearest DERP: Home Hangzhou</span><br><span class="line">* DERP latency:</span><br><span class="line">- home: 9.7ms   (Home Hangzhou)</span><br><span class="line">-  hs: 25.2ms  (Huawei Shanghai)</span><br><span class="line">- thk: 43.5ms  (Tencent Hongkong)</span><br></pre></td></tr></table></figure><p>å†æ¬¡æŸ¥çœ‹ä¸é€šä¿¡å¯¹ç«¯çš„è¿æ¥æ–¹å¼ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ tailscale status</span><br><span class="line">                coredns              default      linux   active; direct xxxx:45986; offline, tx 131012 rx 196020</span><br><span class="line">                oneplus-8t           default      android active; relay <span class="string">"home"</span>; offline, tx 211900 rx 22780</span><br><span class="line">                openwrt              default      linux   active; direct 192.168.100.254:41641; offline, tx 189868 rx 4074772</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¿™ä¸€æ¬¡ Tailscale è‡ªåŠ¨é€‰æ‹©äº†ä¸€ä¸ªçº¿è·¯æœ€ä¼˜çš„<strong>å›½å†…çš„</strong> DERP æœåŠ¡å™¨ä½œä¸ºä¸­ç»§ï¼Œå¯ä»¥æµ‹è¯•ä¸€ä¸‹å»¶è¿Ÿï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ tailscale ping 10.1.0.8</span><br><span class="line">pong from oneplus-8t (10.1.0.8) via DERP(home) <span class="keyword">in</span> 30ms</span><br><span class="line">pong from oneplus-8t (10.1.0.8) via DERP(home) <span class="keyword">in</span> 45ms</span><br><span class="line">pong from oneplus-8t (10.1.0.8) via DERP(home) <span class="keyword">in</span> 30ms</span><br></pre></td></tr></table></figure><p>å®Œç¾ï¼è¿™é‡Œçš„ home å½“ç„¶æ˜¯æˆ‘çš„å®¶åº­å®½å¸¦ï¼Œéƒ¨ç½²æ–¹å¼ä¸ä¸Šé¢æ‰€è¯´çš„å›½å†…äº‘ä¸»æœºç±»ä¼¼ï¼Œä½ éœ€è¦é¢å¤–å¼€å¯å…¬ç½‘çš„ç«¯å£æ˜ å°„ï¼ˆ12345/tcp, 3478/udpï¼‰ã€‚è¿˜æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„çš„æ˜¯é…ç½®å†…å®¹ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"Regions"</span>: &#123;</span><br><span class="line">    <span class="attr">"901"</span>: &#123;</span><br><span class="line">      <span class="attr">"RegionID"</span>: <span class="number">901</span>,</span><br><span class="line">      <span class="attr">"RegionCode"</span>: <span class="string">"ali-sh"</span>,</span><br><span class="line">      <span class="attr">"RegionName"</span>: <span class="string">"Aliyun Shanghai"</span>,</span><br><span class="line">      <span class="attr">"Nodes"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">"Name"</span>: <span class="string">"901a"</span>,</span><br><span class="line">          <span class="attr">"RegionID"</span>: <span class="number">901</span>,</span><br><span class="line">          <span class="attr">"DERPPort"</span>: <span class="number">443</span>,</span><br><span class="line">          <span class="attr">"HostName"</span>: <span class="string">"xxxx"</span>,</span><br><span class="line">          <span class="attr">"IPv4"</span>: <span class="string">"xxxx"</span>,</span><br><span class="line">          <span class="attr">"InsecureForTests"</span>: <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"902"</span>: &#123;</span><br><span class="line">      <span class="attr">"RegionID"</span>: <span class="number">902</span>,</span><br><span class="line">      <span class="attr">"RegionCode"</span>: <span class="string">"home"</span>,</span><br><span class="line">      <span class="attr">"RegionName"</span>: <span class="string">"Home Hangzhou"</span>,</span><br><span class="line">      <span class="attr">"Nodes"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">"Name"</span>: <span class="string">"902a"</span>,</span><br><span class="line">          <span class="attr">"RegionID"</span>: <span class="number">902</span>,</span><br><span class="line">          <span class="attr">"DERPPort"</span>: <span class="number">12345</span>,</span><br><span class="line">          <span class="attr">"HostName"</span>: <span class="string">"xxxx"</span>,</span><br><span class="line">          <span class="attr">"InsecureForTests"</span>: <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸å›½å†…äº‘ä¸»æœºç›¸æ¯”ï¼Œå®¶åº­å®½å¸¦çš„é…ç½®æœ‰ä¸¤ç‚¹ä¸åŒï¼š</p><ul><li>éœ€è¦åˆ é™¤ <code>IPv4</code> é…ç½®é¡¹ã€‚å› ä¸ºå®¶ç”¨å®½å¸¦çš„å…¬ç½‘ IP æ˜¯åŠ¨æ€å˜åŒ–çš„ï¼Œæ‰€ä»¥ä½ éœ€è¦ä½¿ç”¨ <strong>DDNS</strong> æ¥åŠ¨æ€è§£æå…¬ç½‘ IPã€‚</li><li><code>HostName</code> æœ€å¥½å¡«åŸŸåï¼Œå› ä¸ºä½ çš„å…¬ç½‘ IP æ˜¯åŠ¨æ€å˜åŒ–çš„ï¼Œæ²¡æ³•å¡«å†™ IPï¼Œé™¤éä½ ä¸åœåœ°ä¿®æ”¹é…ç½®æ–‡ä»¶ã€‚å¡«åŸŸåä¹Ÿæ²¡å…³ç³»å•¦ï¼Œåæ­£ä¸ä¼šéªŒè¯åŸŸåçš„ï¼Œä¹Ÿä¸ç”¨å…³å¿ƒè¯ä¹¦çš„äº‹æƒ…ï¼Œ<strong>åªè¦åŸŸåèƒ½è§£æåˆ°ä½ çš„å…¬ç½‘ IP å³å¯ã€‚</strong></li></ul><h2><span id="é˜²æ­¢-derp-è¢«ç™½å«–">é˜²æ­¢ DERP è¢«ç™½å«–</span></h2><p>é»˜è®¤æƒ…å†µä¸‹ DERP æœåŠ¡å™¨æ˜¯å¯ä»¥è¢«ç™½å«–çš„ï¼Œåªè¦åˆ«äººçŸ¥é“äº†ä½ çš„ DERP æœåŠ¡å™¨çš„åœ°å€å’Œç«¯å£ï¼Œå°±å¯ä»¥ä¸ºä»–æ‰€ç”¨ã€‚å¦‚æœä½ çš„æœåŠ¡å™¨æ˜¯ä¸ªå°æ°´ç®¡ï¼Œç”¨çš„äººå¤šäº†å¯èƒ½ä¼šæŠŠä½ æ’‘çˆ†ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ä¿®æ”¹é…ç½®æ¥é˜²æ­¢è¢«ç™½å«–ã€‚</p><blockquote><p>ç‰¹åˆ«å£°æ˜ï¼šåªæœ‰ä½¿ç”¨åŸŸåçš„æ–¹å¼æ‰å¯ä»¥é€šè¿‡è®¤è¯é˜²æ­¢è¢«ç™½å«–ï¼Œä½¿ç”¨çº¯ IP çš„æ–¹å¼æ— æ³•é˜²ç™½å«–ï¼Œä½ åªèƒ½å°å¿ƒç¿¼ç¿¼åœ°éšè—å¥½ä½ çš„ IP å’Œç«¯å£ï¼Œä¸èƒ½è®©åˆ«äººçŸ¥é“ã€‚</p></blockquote><p>åªéœ€è¦åšä¸¤ä»¶äº‹æƒ…ï¼š</p><p><strong>1ã€åœ¨ DERP æœåŠ¡å™¨ä¸Šå®‰è£… Tailscaleã€‚</strong></p><p>ç¬¬ä¸€æ­¥éœ€è¦åœ¨ DERP æœåŠ¡æ‰€åœ¨çš„ä¸»æœºä¸Šå®‰è£… Tailscale å®¢æˆ·ç«¯ï¼Œ<strong>å¯åŠ¨ tailscaled è¿›ç¨‹</strong>ã€‚</p><p><strong>2ã€derper å¯åŠ¨æ—¶åŠ ä¸Šå‚æ•° <code>--verify-clients</code>ã€‚</strong></p><p>æœ¬æ–‡æ¨èçš„æ˜¯é€šè¿‡å®¹å™¨å¯åŠ¨ï¼Œ<a href="https://github.com/yangchuansheng/docker-image/blob/master/derper/Dockerfile" target="_blank" rel="noopener">Dockerfile å†…å®¹</a>å¦‚ä¸‹ï¼š</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> golang:latest AS builder</span><br><span class="line"></span><br><span class="line"><span class="keyword">LABEL</span><span class="bash"> org.opencontainers.image.source https://github.com/yangchuansheng/docker-image</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /app</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># https://tailscale.com/kb/1118/custom-derp-servers/</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> go install tailscale.com/cmd/derper@main</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> ubuntu</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /app</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ARG</span> DEBIAN_FRONTEND=noninteractive</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update &amp;&amp; \</span></span><br><span class="line"><span class="bash">    apt-get install -y --no-install-recommends apt-utils &amp;&amp; \</span></span><br><span class="line"><span class="bash">    apt-get install -y ca-certificates &amp;&amp; \</span></span><br><span class="line"><span class="bash">    mkdir /app/certs</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> DERP_DOMAIN your-hostname.com</span><br><span class="line"><span class="keyword">ENV</span> DERP_CERT_MODE letsencrypt</span><br><span class="line"><span class="keyword">ENV</span> DERP_CERT_DIR /app/certs</span><br><span class="line"><span class="keyword">ENV</span> DERP_ADDR :<span class="number">443</span></span><br><span class="line"><span class="keyword">ENV</span> DERP_STUN true</span><br><span class="line"><span class="keyword">ENV</span> DERP_HTTP_PORT <span class="number">80</span></span><br><span class="line"><span class="keyword">ENV</span> DERP_VERIFY_CLIENTS false</span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> --from=builder /go/bin/derper .</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> /app/derper --hostname=<span class="variable">$DERP_DOMAIN</span> \</span></span><br><span class="line"><span class="bash">    --certmode=<span class="variable">$DERP_CERT_MODE</span> \</span></span><br><span class="line"><span class="bash">    --certdir=<span class="variable">$DERP_CERT_DIR</span> \</span></span><br><span class="line"><span class="bash">    --a=<span class="variable">$DERP_ADDR</span> \</span></span><br><span class="line"><span class="bash">    --stun=<span class="variable">$DERP_STUN</span>  \</span></span><br><span class="line"><span class="bash">    --http-port=<span class="variable">$DERP_HTTP_PORT</span> \</span></span><br><span class="line"><span class="bash">    --verify-clients=<span class="variable">$DERP_VERIFY_CLIENTS</span></span></span><br></pre></td></tr></table></figure><p>é»˜è®¤æƒ…å†µä¸‹ <code>--verify-clients</code> å‚æ•°è®¾ç½®çš„æ˜¯ <code>false</code>ã€‚æˆ‘ä»¬ä¸éœ€è¦å¯¹ Dockerfile å†…å®¹åšä»»ä½•æ”¹åŠ¨ï¼Œåªéœ€åœ¨å®¹å™¨å¯åŠ¨æ—¶åŠ ä¸Šç¯å¢ƒå˜é‡å³å¯ï¼Œå°†ä¹‹å‰çš„å¯åŠ¨å‘½ä»¤ä¿®æ”¹ä¸€ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ğŸ³  â†’ docker run --restart always \</span><br><span class="line">  --name derper -p 12345:12345 -p 3478:3478/udp \</span><br><span class="line">  -v /root/.acme.sh/xxxx/:/app/certs \</span><br><span class="line">  -e DERP_CERT_MODE=manual \</span><br><span class="line">  -e DERP_ADDR=:12345 \</span><br><span class="line">  -e DERP_DOMAIN=xxxx \</span><br><span class="line">  -e DERP_VERIFY_CLIENTS=<span class="literal">true</span> \</span><br><span class="line">  -d ghcr.io/yangchuansheng/derper:latest</span><br></pre></td></tr></table></figure><p>è¿™æ ·å°±å¤§åŠŸå‘Šæˆäº†ï¼Œåˆ«äººå³ä½¿çŸ¥é“äº†ä½ çš„ DERP æœåŠ¡å™¨åœ°å€ä¹Ÿæ— æ³•ä½¿ç”¨ï¼Œä½†è¿˜æ˜¯è¦è¯´æ˜ä¸€ç‚¹ï¼Œå³ä¾¿å¦‚æ­¤ï¼Œä½ ä¹Ÿåº”è¯¥å°½é‡ä¸è®©åˆ«äººçŸ¥é“ä½ çš„æœåŠ¡å™¨åœ°å€ï¼Œé˜²æ­¢åˆ«äººæœ‰å¯è¶ä¹‹æœºã€‚</p><h2><span id="æ€»ç»“">æ€»ç»“</span></h2><p>æœ¬æ–‡ç»™å¤§å®¶ä»‹ç»äº† STUN å¯¹äºè¾…åŠ© NAT ç©¿é€çš„æ„ä¹‰ï¼Œç§‘æ™®äº†å‡ ç§å¸¸è§çš„ä¸­ç»§åè®®ï¼ŒåŒ…å« Tailscale è‡ªç ”çš„ DERP åè®®ã€‚æœ€åæ‰‹æŠŠæ‰‹æ•™å¤§å®¶å¦‚ä½•è‡ªå»ºç§æœ‰çš„ DERP æœåŠ¡å™¨ï¼Œå¹¶è®© Tailscale ä½¿ç”¨æˆ‘ä»¬è‡ªå»ºçš„ DERP æœåŠ¡å™¨ã€‚</p><h2><span id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</span></h2><ul><li><a href="https://arthurchiao.art/blog/how-nat-traversal-works-zh/" target="_blank" rel="noopener">NAT ç©¿é€æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼šæŠ€æœ¯åŸç†åŠä¼ä¸šçº§å®è·µ</a></li><li><a href="https://tailscale.com/kb/1118/custom-derp-servers/" target="_blank" rel="noopener">Custom DERP Servers</a></li><li><a href="https://tailscale.com/blog/how-tailscale-works/#encrypted-tcp-relays-derp" target="_blank" rel="noopener">Encrypted TCP relays (DERP)</a></li></ul><blockquote><p>æœ¬æ–‡è½¬è½½è‡ªï¼šã€Œ äº‘åŸç”Ÿå®éªŒå®¤ ã€ï¼ŒåŸæ–‡ï¼š<a href="https://tinyurl.com/588mv65u" target="_blank" rel="noopener">https://tinyurl.com/588mv65u</a> ï¼Œç‰ˆæƒå½’åŸä½œè€…æ‰€æœ‰ã€‚æ¬¢è¿æŠ•ç¨¿ï¼ŒæŠ•ç¨¿é‚®ç®±: <a href="mailto:editor@hi-linux.com">editor@hi-linux.com</a>ã€‚</p></blockquote></div><script src="https://my.openwrite.cn/js/readmore.js" type="text/javascript"></script><script>var isMobile = navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i);if (!isMobile) {    var btw = new BTWPlugin();    btw.init({        "id": "vip-container",        "blogId": "10135-1588830050631-449",        "name": "ã€Œå¥‡å¦™çš„ Linux ä¸–ç•Œã€",        "qrcode": "https://www.hi-linux.com/img/wechat/mp_qrcode_12.jpg",        "keyword": "VIP"    });}</script>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://img.hi-linux.com/staticfile/2022-03-21-11-13-q1TRI3-2022-03-30-ooh4UE.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;ç›®å‰å›½å®¶å·¥ä¿¡éƒ¨åœ¨å¤§åŠ›æ¨åŠ¨ä¸‰å¤§è¿è¥å•†å‘å±• IPv6ï¼Œå¯¹å®¶ç”¨å®½å¸¦è€Œè¨€ï¼Œå¯ä»¥ä½¿ç”¨çš„ IPv4 å…¬ç½‘ IP ä¼šè¶Šæ¥è¶Šå°‘ã€‚æœ‰éƒ¨åˆ†åœ°åŒºå³ä½¿æ‹¿åˆ°äº†å…¬ç½‘ IPv4 åœ°å€ï¼Œä¹Ÿæ˜¯ä¸ªå¤§å†…ç½‘åœ°å€ï¼Œæ ¹æœ¬ä¸æ˜¯çœŸæ­£çš„å…¬ç½‘ IPï¼Œè®¿é—®å®¶åº­å†…ç½‘çš„èµ„æºå°†ä¼šå˜å¾—è¶Šæ¥è¶Šå›°éš¾ã€‚&lt;/p&gt;
&lt;p&gt;éƒ¨åˆ†å°ä¼™ä¼´å¯èƒ½ä¼šé€‰æ‹©ä½¿ç”¨ frp ç­‰é’ˆå¯¹ç‰¹å®šåè®®å’Œç«¯å£çš„å†…ç½‘ç©¿é€æ–¹æ¡ˆï¼Œä½†è¿™ç§æ–¹æ¡ˆè¿˜æ˜¯ä¸å¤Ÿé…¸çˆ½ï¼Œæ— æ³•è®¿é—®å®¶åº­å†…ç½‘ä»»æ„è®¾å¤‡çš„ä»»æ„ç«¯å£ã€‚æ›´ä½³çš„é€‰æ‹©è¿˜æ˜¯é€šè¿‡ VPN æ¥ç»„å»ºå¤§å†…ç½‘ã€‚è‡³äºè¯¥é€‰æ‹©å“ªç§ VPNï¼Œæ¯«æ— ç–‘é—®è‚¯å®šæ˜¯ WireGuardï¼ŒWireGuard å°±æ˜¯ VPN çš„æœªæ¥ã€‚&lt;strong&gt;æˆ‘å·²ç»ä¸æ­¢ä¸€æ¬¡å‘å¤§å®¶æ¨èä½¿ç”¨ WireGuard äº†ï¼Œæˆ‘ç´¯äº†ï¼Œä¸æƒ³å†è®²äº†ï¼Œä½ çˆ± JB ç”¨è¾£é¸¡ OpenVPN ä¹‹ç±»çš„å°±ç”¨å§ï¼Œä½ å¼€å¿ƒå°±å¥½ã€‚&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;WireGuard ç›¸æ¯”äºä¼ ç»Ÿ VPN çš„æ ¸å¿ƒä¼˜åŠ¿æ˜¯æ²¡æœ‰ VPN ç½‘å…³ï¼Œæ‰€æœ‰èŠ‚ç‚¹ä¹‹é—´éƒ½å¯ä»¥ç‚¹å¯¹ç‚¹ï¼ˆP2Pï¼‰è¿æ¥ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä¹‹å‰æåˆ°çš„&lt;a href=&quot;https://fuckcloudnative.io/posts/wireguard-full-mesh/#1-%E5%85%A8%E4%BA%92%E8%81%94%E6%A8%A1%E5%BC%8F%E6%9E%B6%E6%9E%84%E4%B8%8E%E9%85%8D%E7%BD%AE&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;å…¨äº’è”æ¨¡å¼ï¼ˆfull meshï¼‰&lt;/a&gt;ï¼Œæ•ˆç‡æ›´é«˜ï¼Œé€Ÿåº¦æ›´å¿«ï¼Œæˆæœ¬æ›´ä½ã€‚&lt;/p&gt;
&lt;p&gt;WireGuard ç›®å‰æœ€å¤§çš„ç—›ç‚¹å°±æ˜¯ä¸Šå±‚åº”ç”¨çš„åŠŸèƒ½ä¸å¤Ÿå¥å…¨ï¼Œå› ä¸º WireGuard æ¨å´‡çš„æ˜¯ Unix çš„å“²å­¦ï¼ŒWireGuard æœ¬èº«åªæ˜¯ä¸€ä¸ªå†…æ ¸çº§åˆ«çš„æ¨¡å—ï¼Œåªæ˜¯ä¸€ä¸ªæ•°æ®å¹³é¢ï¼Œè‡³äºä¸Šå±‚çš„æ›´é«˜çº§çš„åŠŸèƒ½ï¼ˆæ¯”å¦‚ç§˜é’¥äº¤æ¢æœºåˆ¶ï¼ŒUDP æ‰“æ´ï¼ŒACL ç­‰ï¼‰ï¼Œéœ€è¦é€šè¿‡ç”¨æˆ·ç©ºé—´çš„åº”ç”¨æ¥å®ç°ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Linux" scheme="https://www.hi-linux.com/categories/Linux/"/>
    
    
      <category term="Linux" scheme="https://www.hi-linux.com/tags/Linux/"/>
    
      <category term="Tailscale" scheme="https://www.hi-linux.com/tags/Tailscale/"/>
    
      <category term="WireGuard" scheme="https://www.hi-linux.com/tags/WireGuard/"/>
    
  </entry>
  
  <entry>
    <title>é›¶ä»£ç å˜æ›´ï¼Œå·§ç”¨ Reloader å¿«é€Ÿå®ç° Kubernetes çš„ Configmap å’Œ Secret çƒ­æ›´æ–°</title>
    <link href="https://www.hi-linux.com/posts/24272.html"/>
    <id>https://www.hi-linux.com/posts/24272.html</id>
    <published>2022-03-15T01:00:00.000Z</published>
    <updated>2022-03-25T07:06:58.507Z</updated>
    
    <content type="html"><![CDATA[<div id="vip-container"><h2><span id="èƒŒæ™¯">èƒŒæ™¯</span></h2><h3><span id="11-é…ç½®ä¸­å¿ƒé—®é¢˜">1.1 é…ç½®ä¸­å¿ƒé—®é¢˜</span></h3><p>åœ¨äº‘åŸç”Ÿä¸­é…ç½®ä¸­å¿ƒï¼Œä¾‹å¦‚ï¼š<code>Configmap</code>å’Œ<code>Secret</code>å¯¹è±¡ï¼Œè™½ç„¶å¯ä»¥è¿›è¡Œç›´æ¥æ›´æ–°èµ„æºå¯¹è±¡</p><ul><li>å¯¹äºå¼•ç”¨è¿™äº›æœ‰äº›ä¸å˜çš„é…ç½®æ˜¯å¯ä»¥æ‰“åŒ…åˆ°é•œåƒä¸­çš„ï¼Œé‚£å¯å˜çš„é…ç½®å‘¢ï¼Ÿ</li><li>ä¿¡æ¯æ³„æ¼ï¼Œå¾ˆå®¹æ˜“å¼•å‘å®‰å…¨é£é™©ï¼Œå°¤å…¶æ˜¯ä¸€äº›æ•æ„Ÿä¿¡æ¯ï¼Œæ¯”å¦‚å¯†ç ã€å¯†é’¥ç­‰ã€‚</li><li>æ¯æ¬¡é…ç½®æ›´æ–°åï¼Œéƒ½è¦é‡æ–°æ‰“åŒ…ä¸€æ¬¡ï¼Œå‡çº§åº”ç”¨ã€‚é•œåƒç‰ˆæœ¬è¿‡å¤šï¼Œä¹Ÿç»™é•œåƒç®¡ç†å’Œé•œåƒä¸­å¿ƒå­˜å‚¨å¸¦æ¥å¾ˆå¤§çš„è´Ÿæ‹…ã€‚</li><li>å®šåˆ¶åŒ–å¤ªä¸¥é‡ï¼Œå¯æ‰©å±•èƒ½åŠ›å·®ï¼Œä¸”ä¸å®¹æ˜“å¤ç”¨ã€‚</li></ul><a id="more"></a><h3><span id="12-ä½¿ç”¨æ–¹å¼">1.2 ä½¿ç”¨æ–¹å¼</span></h3><p><code>Configmap</code>æˆ–<code>Secret</code>ä½¿ç”¨æœ‰ä¸¤ç§æ–¹å¼ï¼Œä¸€ç§æ˜¯<code>env</code>ç³»ç»Ÿå˜é‡èµ‹å€¼ï¼Œä¸€ç§æ˜¯<code>volume</code>æŒ‚è½½èµ‹å€¼ï¼Œenvå†™å…¥ç³»ç»Ÿçš„configmapæ˜¯ä¸ä¼šçƒ­æ›´æ–°çš„ï¼Œè€Œvolumeå†™å…¥çš„æ–¹å¼æ”¯æŒçƒ­æ›´æ–°ï¼</p><ul><li>å¯¹äºenvç¯å¢ƒçš„ï¼Œå¿…é¡»è¦æ»šåŠ¨æ›´æ–°podæ‰èƒ½ç”Ÿæ•ˆï¼Œä¹Ÿå°±æ˜¯åˆ é™¤è€çš„podï¼Œé‡æ–°ä½¿ç”¨é•œåƒæ‹‰èµ·æ–°podåŠ è½½ç¯å¢ƒå˜é‡æ‰èƒ½ç”Ÿæ•ˆã€‚</li><li>å¯¹äºvolumeçš„æ–¹å¼ï¼Œè™½ç„¶å†…å®¹å˜äº†ï¼Œä½†æ˜¯éœ€è¦æˆ‘ä»¬çš„åº”ç”¨ç›´æ¥ç›‘æ§configmapçš„å˜åŠ¨ï¼Œæˆ–è€…ä¸€ç›´å»æ›´æ–°ç¯å¢ƒå˜é‡æ‰èƒ½åœ¨è¿™ç§æƒ…å†µä¸‹è¾¾åˆ°çƒ­æ›´æ–°çš„ç›®çš„ã€‚</li></ul><p>åº”ç”¨ä¸æ”¯æŒçƒ­æ›´æ–°ï¼Œå¯ä»¥åœ¨ä¸šåŠ¡å®¹å™¨ä¸­å¯åŠ¨ä¸€ä¸ªsidercarå®¹å™¨ï¼Œç›‘æ§configmapçš„å˜åŠ¨ï¼Œæ›´æ–°é…ç½®æ–‡ä»¶ï¼Œæˆ–è€…ä¹Ÿæ»šåŠ¨æ›´æ–°podè¾¾åˆ°æ›´æ–°é…ç½®çš„æ•ˆæœã€‚</p><h2><span id="è§£å†³æ–¹æ¡ˆ">è§£å†³æ–¹æ¡ˆ</span></h2><p>ConfigMap å’Œ Secret æ˜¯ Kubernetes å¸¸ç”¨çš„ä¿å­˜é…ç½®æ•°æ®çš„å¯¹è±¡ï¼Œä½ å¯ä»¥æ ¹æ®éœ€è¦é€‰æ‹©åˆé€‚çš„å¯¹è±¡å­˜å‚¨æ•°æ®ã€‚é€šè¿‡ Volume æ–¹å¼æŒ‚è½½åˆ° Pod å†…çš„ï¼Œkubelet éƒ½ä¼šå®šæœŸè¿›è¡Œæ›´æ–°ã€‚ä½†æ˜¯é€šè¿‡ç¯å¢ƒå˜é‡æ³¨å…¥åˆ°å®¹å™¨ä¸­ï¼Œè¿™æ ·æ— æ³•æ„ŸçŸ¥åˆ° ConfigMap æˆ– Secret çš„å†…å®¹æ›´æ–°ã€‚</p><p>ç›®å‰å¦‚ä½•è®© Pod å†…çš„ä¸šåŠ¡æ„ŸçŸ¥åˆ° ConfigMap æˆ– Secret çš„å˜åŒ–ï¼Œè¿˜æ˜¯ä¸€ä¸ªå¾…è§£å†³çš„é—®é¢˜ã€‚ä½†æ˜¯æˆ‘ä»¬è¿˜æ˜¯æœ‰ä¸€äº› Workaround çš„ã€‚</p><p>å¦‚æœä¸šåŠ¡è‡ªèº«æ”¯æŒ reload é…ç½®çš„è¯ï¼Œæ¯”å¦‚nginx -s reloadï¼Œå¯ä»¥é€šè¿‡ inotify æ„ŸçŸ¥åˆ°æ–‡ä»¶æ›´æ–°ï¼Œæˆ–è€…ç›´æ¥å®šæœŸè¿›è¡Œ reloadï¼ˆè¿™é‡Œå¯ä»¥é…åˆæˆ‘ä»¬çš„ readinessProbe ä¸€èµ·ä½¿ç”¨ï¼‰ã€‚</p><p>å¦‚æœæˆ‘ä»¬çš„ä¸šåŠ¡æ²¡æœ‰è¿™ä¸ªèƒ½åŠ›ï¼Œè€ƒè™‘åˆ°ä¸å¯å˜åŸºç¡€è®¾æ–½çš„æ€æƒ³ï¼Œæˆ‘ä»¬æ˜¯ä¸æ˜¯å¯ä»¥é‡‡ç”¨æ»šåŠ¨å‡çº§çš„æ–¹å¼è¿›è¡Œï¼Ÿæ²¡é”™ï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„æ–¹æ³•ã€‚ç›®å‰æœ‰ä¸ªå¼€æºå·¥å…·Reloaderï¼Œå®ƒå°±æ˜¯é‡‡ç”¨è¿™ç§æ–¹å¼ï¼Œé€šè¿‡ watch ConfigMap å’Œ Secretï¼Œä¸€æ—¦å‘ç°å¯¹è±¡æ›´æ–°ï¼Œå°±è‡ªåŠ¨è§¦å‘å¯¹ Deployment æˆ– StatefulSet ç­‰å·¥ä½œè´Ÿè½½å¯¹è±¡è¿›è¡Œæ»šåŠ¨å‡çº§ã€‚</p><h2><span id="reloaderç®€ä»‹">reloaderç®€ä»‹</span></h2><h3><span id="31-reloaderç®€ä»‹">3.1 reloaderç®€ä»‹</span></h3><p><code>Reloader</code> å¯ä»¥è§‚å¯Ÿ ConfigMap å’Œ Secret ä¸­çš„å˜åŒ–ï¼Œå¹¶é€šè¿‡ç›¸å…³çš„ deploymentconfiggsã€ deploymentconfiggsã€ deploymonset å’Œ statefulset å¯¹ Pods è¿›è¡Œæ»šåŠ¨å‡çº§ã€‚</p><h3><span id="32-reloaderå®‰è£…">3.2 reloaderå®‰è£…</span></h3><ul><li>helmå®‰è£…</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ helm repo add stakater https:&#x2F;&#x2F;stakater.github.io&#x2F;stakater-charts</span><br><span class="line">$ helm repo update</span><br><span class="line">$ helm install stakater&#x2F;reloader</span><br></pre></td></tr></table></figure><ul><li>Kustomize</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -k https:&#x2F;&#x2F;github.com&#x2F;stakater&#x2F;Reloader&#x2F;deployments&#x2F;kubernetes</span><br></pre></td></tr></table></figure><ul><li>èµ„æºæ¸…å•å®‰è£…</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;stakater&#x2F;Reloader&#x2F;master&#x2F;deployments&#x2F;kubernetes&#x2F;reloader.yaml</span><br><span class="line"></span><br><span class="line"># åœ¨æ­¤å®‰è£…åœ¨common-service åç§°ç©ºé—´ä¸‹ï¼Œ</span><br><span class="line">[root@master reloader]# kubectl apply -f reloader.yaml </span><br><span class="line">clusterrole.rbac.authorization.k8s.io&#x2F;reloader-reloader-role created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io&#x2F;reloader-reloader-role-binding created</span><br><span class="line">deployment.apps&#x2F;reloader-reloader created</span><br><span class="line">serviceaccount&#x2F;reloader-reloader created</span><br><span class="line">[root@master reloader]# kubectl get all -n common-service </span><br><span class="line">NAME                                     READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod&#x2F;reloader-reloader-66d46d5885-nx64t   1&#x2F;1     Running   0          15s</span><br><span class="line"></span><br><span class="line">NAME                                READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps&#x2F;reloader-reloader   1&#x2F;1     1            1           16s</span><br><span class="line"></span><br><span class="line">NAME                                           DESIRED   CURRENT   READY   AGE</span><br><span class="line">replicaset.apps&#x2F;reloader-reloader-66d46d5885   1         1         1       16s</span><br></pre></td></tr></table></figure><ul><li>é…ç½®å¿½ç•¥</li></ul><p><code>reloader</code> èƒ½å¤Ÿé…ç½®å¿½ç•¥cmæˆ–è€…secretsèµ„æºï¼Œå¯ä»¥é€šè¿‡é…ç½®åœ¨reader deployä¸­çš„spec.template.spec.containers.argsï¼Œå¦‚æœä¸¤ä¸ªéƒ½å¿½ç•¥ï¼Œé‚£å°±ç¼©å°deployä¸º0ï¼Œæˆ–è€…ä¸éƒ¨ç½²reoaderã€‚</p><table><thead><tr><th style="text-align:left">Args</th><th style="text-align:left">Description</th></tr></thead><tbody><tr><td style="text-align:left">â€“resources-to-ignore=configMaps</td><td style="text-align:left">To ignore configMaps</td></tr><tr><td style="text-align:left">â€“resources-to-ignore=secrets</td><td style="text-align:left">To ignore secrets</td></tr></tbody></table><h3><span id="33-é…ç½®">3.3 é…ç½®</span></h3><h4><span id="331-è‡ªåŠ¨æ›´æ–°">3.3.1 è‡ªåŠ¨æ›´æ–°</span></h4><p><code>reloader.stakater.com/search</code> å’Œ <code>reloader.stakater.com/auto</code> å¹¶ä¸åœ¨ä¸€èµ·å·¥ä½œã€‚å¦‚æœä½ åœ¨ä½ çš„éƒ¨ç½²ä¸Šæœ‰ä¸€ä¸ª <a href="http://reloader.stakater.com/auto" target="_blank" rel="noopener">reloader.stakater.com/auto</a> : &quot;true&quot;çš„æ³¨é‡Šï¼Œè¯¥èµ„æºå¯¹è±¡å¼•ç”¨çš„æ‰€æœ‰configmapæˆ–è¿™secretçš„æ”¹å˜éƒ½ä¼šé‡å¯è¯¥èµ„æºï¼Œä¸ç®¡ä»–ä»¬æ˜¯å¦æœ‰ <a href="http://reloader.stakater.com/match" target="_blank" rel="noopener">reloader.stakater.com/match</a> : &quot;true&quot;çš„æ³¨é‡Šã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    reloader.stakater.com&#x2F;auto: &quot;true&quot;</span><br><span class="line">spec:</span><br><span class="line">  template: metadata:</span><br></pre></td></tr></table></figure><h4><span id="332-æŒ‡å®šæ›´æ–°">3.3.2 æŒ‡å®šæ›´æ–°</span></h4><p>æŒ‡å®šä¸€ä¸ªç‰¹å®šçš„configmapæˆ–è€…secretï¼Œåªæœ‰åœ¨æˆ‘ä»¬æŒ‡å®šçš„é…ç½®å›¾æˆ–ç§˜å¯†è¢«æ”¹å˜æ—¶æ‰ä¼šè§¦å‘æ»šåŠ¨å‡çº§ï¼Œè¿™æ ·ï¼Œå®ƒä¸ä¼šè§¦å‘æ»šåŠ¨å‡çº§æ‰€æœ‰é…ç½®å›¾æˆ–ç§˜å¯†åœ¨éƒ¨ç½²ï¼Œåå°ç™»å½•æˆ–çŠ¶æ€è®¾ç½®ä¸­ä½¿ç”¨ã€‚</p><p>ä¸€ä¸ªæŒ‡å®šdeploymentèµ„æºå¯¹è±¡ï¼Œåœ¨å¼•ç”¨çš„configmapæˆ–è€…secretç§ï¼Œåªæœ‰<code>reloader.stakater.com/match: &quot;true&quot;</code>ä¸ºtrueæ‰ä¼šå‡ºå‘æ›´æ–°ï¼Œä¸ºfalseæˆ–è€…ä¸è¿›è¡Œæ ‡è®°ï¼Œè¯¥èµ„æºå¯¹è±¡éƒ½ä¸ä¼šç›‘è§†é…ç½®çš„å˜åŒ–è€Œé‡å¯ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    reloader.stakater.com&#x2F;search: &quot;true&quot;</span><br><span class="line">spec:</span><br><span class="line">  template:</span><br></pre></td></tr></table></figure><p>cm é…ç½®</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    reloader.stakater.com&#x2F;match: &quot;true&quot;</span><br><span class="line">data:</span><br><span class="line">  key: value</span><br></pre></td></tr></table></figure><h4><span id="333-æŒ‡å®šcm">3.3.3 æŒ‡å®šcm</span></h4><p>å¦‚æœä¸€ä¸ªdeploymentæŒ‚è½½æœ‰å¤šä¸ªcmæˆ–è€…çš„åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬åªå¸Œæœ›æ›´æ–°ç‰¹å®šä¸€ä¸ªcmåï¼Œdeployå‘ç”Ÿæ»šåŠ¨æ›´æ–°ï¼Œæ›´æ–°å…¶ä»–çš„cmï¼Œdeployä¸æ›´æ–°ï¼Œè¿™ç§åœºæ™¯å¯ä»¥å°†cmåœ¨deployä¸­æŒ‡å®šä¸ºå•ä¸ªæˆ–ç€åˆ—è¡¨å®ç°ã€‚</p><p>ä¾‹å¦‚ï¼šä¸€ä¸ªdeployæœ‰æŒ‚è½½nginx-cm1å’Œnginx-cm2ä¸¤ä¸ªconfigmapï¼Œåªæƒ³nginx-cm1æ›´æ–°çš„æ—¶å€™deployæ‰å‘ç”Ÿæ»šåŠ¨æ›´æ–°ï¼Œæ­¤æ—¶æ— éœ€åœ¨ä¸¤ä¸ªcmä¸­é…ç½®æ³¨è§£ï¼Œåªéœ€è¦åœ¨deployä¸­å†™å…¥<code>configmap.reloader.stakater.com/reload:nginx-cm1</code>ï¼Œå…¶ä¸­nginx-cm1å¦‚æœå‘ç”Ÿæ›´æ–°ï¼Œdeployå°±ä¼šè§¦å‘æ»šåŠ¨æ›´æ–°ã€‚</p><p>å¦‚æœå¤šä¸ªcmç›´æ¥ç”¨é€—å·éš”å¼€</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># configmapå¯¹è±¡</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    configmap.reloader.stakater.com&#x2F;reload: &quot;nginx-cm1&quot;</span><br><span class="line">spec:</span><br><span class="line">  template: metadata:</span><br><span class="line"></span><br><span class="line"># secretå¯¹è±¡</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    secret.reloader.stakater.com&#x2F;reload: &quot;foo-secret&quot;</span><br><span class="line">spec:</span><br><span class="line">  template: metadata:</span><br></pre></td></tr></table></figure><blockquote><p>æ— éœ€åœ¨cmæˆ–secretä¸­æ·»åŠ æ³¨è§£ï¼Œåªéœ€è¦åœ¨å¼•ç”¨èµ„æºå¯¹è±¡ä¸­æ·»åŠ æ³¨è§£å³å¯ã€‚</p></blockquote><h2><span id="æµ‹è¯•">æµ‹è¯•</span></h2><h3><span id="41-deploy">4.1 deploy</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps&#x2F;v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">   # reloader.stakater.com&#x2F;auto: &quot;true&quot;</span><br><span class="line">    reloader.stakater.com&#x2F;search: &quot;true&quot;</span><br><span class="line">  labels:</span><br><span class="line">    run: nginx</span><br><span class="line">  name: nginx</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      run: nginx</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        run: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: nginx</span><br><span class="line">        name: nginx</span><br><span class="line">        volumeMounts:</span><br><span class="line">        # å¿…é¡»åŒ¹é…volumesçš„åç§°,å®šä¹‰configmap</span><br><span class="line">        - name: nginx-cm</span><br><span class="line">          mountPath: &#x2F;data&#x2F;cfg</span><br><span class="line">          readOnly: true</span><br><span class="line">      volumes:</span><br><span class="line">      # å®šä¹‰é€»è¾‘å·çš„åç§°</span><br><span class="line">      - name: nginx-cm</span><br><span class="line">        configMap:</span><br><span class="line">          # ä½¿ç”¨configmapèµ„æºçš„åç§°</span><br><span class="line">          name: nginx-cm</span><br><span class="line">          items:</span><br><span class="line">          # ä½¿ç”¨configmapä¸­åˆ°é‚£ä¸ªkey</span><br><span class="line">          - key: config.yaml</span><br><span class="line">            # ä½¿ç”¨configmapä¸­åˆ°keyæ˜ å°„åˆ°å®¹å™¨ä¸­åˆ°æ–‡ä»¶åç§°</span><br><span class="line">            path: config.yaml</span><br><span class="line">            mode: 0644</span><br></pre></td></tr></table></figure><h3><span id="42-configmap">4.2 configmap</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  config.yaml: |</span><br><span class="line">    # project settings</span><br><span class="line"></span><br><span class="line">    # go2cloud_api service config</span><br><span class="line">    DEFAULT_CONF:</span><br><span class="line">      port: 8888</span><br><span class="line">    # data disk api</span><br><span class="line">    UNITTEST_TENCENT_ZONE: ap-chongqing-1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-cm</span><br><span class="line">  annotations:</span><br><span class="line">    reloader.stakater.com&#x2F;match: &quot;true&quot;</span><br></pre></td></tr></table></figure><h3><span id="43-æµ‹è¯•">4.3 æµ‹è¯•</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@master ns-default]# kubectl  get po</span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-68c9bf4ff7-9gmg6   1&#x2F;1     Running   0          10m</span><br><span class="line">[root@master ns-default]# kubectl  get cm</span><br><span class="line">NAME       DATA   AGE</span><br><span class="line">nginx-cm   1      28m</span><br><span class="line"># æ›´æ–°cmå†…å®¹</span><br><span class="line">[root@master ns-default]# kubectl edit cm nginx-cm </span><br><span class="line">configmap&#x2F;nginx-cm edited</span><br><span class="line"># æŸ¥çœ‹poå‘ç”Ÿäº†æ»šåŠ¨æ›´æ–°ï¼Œé‡æ–°åŠ è½½é…ç½®æ–‡ä»¶</span><br><span class="line">[root@master ns-default]# kubectl get po</span><br><span class="line">NAME                     READY   STATUS              RESTARTS   AGE</span><br><span class="line">nginx-66c758b548-9dllm   0&#x2F;1     ContainerCreating   0          4s</span><br><span class="line">nginx-68c9bf4ff7-9gmg6   1&#x2F;1     Running             0          10m</span><br></pre></td></tr></table></figure><h2><span id="reloader-ä½¿ç”¨æ³¨æ„äº‹é¡¹">Reloader ä½¿ç”¨æ³¨æ„äº‹é¡¹</span></h2><ul><li>Reloader ä¸ºå…¨å±€èµ„æºå¯¹è±¡ï¼Œå»ºè®®éƒ¨ç½²åœ¨ä¸€ä¸ªå…¬å…±æœåŠ¡çš„nsä¸‹ï¼Œç„¶åå…¶ä»–nsä¹Ÿå¯ä»¥æ­£å¸¸ä½¿ç”¨reloaderç‰¹æ€§ã€‚</li><li><a href="http://Reloader.stakater.com/auto" target="_blank" rel="noopener">Reloader.stakater.com/auto</a> : å¦‚æœé…ç½®configmapæˆ–è€…secretåœ¨ deploymentconfigmap/deployment/daemonsets/Statefulsets</li><li><a href="http://secret.reloader.stakater.com/reload" target="_blank" rel="noopener">secret.reloader.stakater.com/reload</a> æˆ–è€… <a href="http://configmap.reloader.stakater.com/reload" target="_blank" rel="noopener">configmap.reloader.stakater.com/reload</a> æ³¨é‡Šä¸­è¢«ä½¿ç”¨ï¼Œé‚£ä¹ˆ true åªä¼šé‡æ–°åŠ è½½ podï¼Œä¸ç®¡ä½¿ç”¨çš„æ˜¯ configmap è¿˜æ˜¯ secretã€‚</li><li><a href="http://reloader.stakater.com/search" target="_blank" rel="noopener">reloader.stakater.com/search</a> å’Œ <a href="http://reloader.stakater.com/auto" target="_blank" rel="noopener">reloader.stakater.com/auto</a> ä¸èƒ½åŒæ—¶ä½¿ç”¨ã€‚å¦‚æœä½ åœ¨ä½ çš„éƒ¨ç½²ä¸Šæœ‰ä¸€ä¸ª <a href="http://reloader.stakater.com/auto" target="_blank" rel="noopener">reloader.stakater.com/auto</a> : &quot;true&quot;çš„æ³¨é‡Šï¼Œé‚£ä¹ˆå®ƒæ€»æ˜¯ä¼šåœ¨ä½ ä¿®æ”¹äº† configmaps æˆ–è€…ä½¿ç”¨äº†æœºå¯†ä¹‹åé‡æ–°å¯åŠ¨ï¼Œä¸ç®¡ä»–ä»¬æ˜¯å¦æœ‰ <a href="http://reloader.stakater.com/match" target="_blank" rel="noopener">reloader.stakater.com/match</a> : &quot;true&quot;çš„æ³¨é‡Šã€‚</li></ul><h2><span id="åæ€">åæ€</span></h2><p>Reloaderé€šè¿‡ watch ConfigMap å’Œ Secretï¼Œä¸€æ—¦å‘ç°å¯¹è±¡æ›´æ–°ï¼Œå°±è‡ªåŠ¨è§¦å‘å¯¹ Deployment æˆ– StatefulSet ç­‰å·¥ä½œè´Ÿè½½å¯¹è±¡è¿›è¡Œæ»šåŠ¨å‡çº§ã€‚</p><p>å¦‚æœæˆ‘ä»¬çš„åº”ç”¨å†…éƒ¨æ²¡æœ‰å»å®æ—¶ç›‘æ§é…ç½®æ–‡ä»¶ï¼Œåˆ©ç”¨è¯¥æ–¹å¼å¯ä»¥éå¸¸æ–¹ä¾¿çš„å®ç°é…ç½®çš„çƒ­æ›´æ–°ã€‚</p><h2><span id="å‚è€ƒé“¾æ¥">å‚è€ƒé“¾æ¥</span></h2><ul><li><a href="https://github.com/stakater/Reloader" target="_blank" rel="noopener">https://github.com/stakater/Reloader</a></li></ul><blockquote><p>æœ¬æ–‡è½¬è½½è‡ªï¼šã€Œ æ˜é‡‘ ã€ï¼ŒåŸæ–‡ï¼š<a href="https://tinyurl.com/6w4ukjrb" target="_blank" rel="noopener">https://tinyurl.com/6w4ukjrb</a> ï¼Œç‰ˆæƒå½’åŸä½œè€…æ‰€æœ‰ã€‚æ¬¢è¿æŠ•ç¨¿ï¼ŒæŠ•ç¨¿é‚®ç®±: <a href="mailto:editor@hi-linux.com">editor@hi-linux.com</a>ã€‚</p></blockquote></div><script src="https://my.openwrite.cn/js/readmore.js" type="text/javascript"></script><script>var isMobile = navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i);if (!isMobile) {    var btw = new BTWPlugin();    btw.init({        "id": "vip-container",        "blogId": "10135-1588830050631-449",        "name": "ã€Œå¥‡å¦™çš„ Linux ä¸–ç•Œã€",        "qrcode": "https://www.hi-linux.com/img/wechat/mp_qrcode_12.jpg",        "keyword": "VIP"    });}</script>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;èƒŒæ™¯&quot;&gt;èƒŒæ™¯&lt;/h2&gt;
&lt;h3 id=&quot;1-1-é…ç½®ä¸­å¿ƒé—®é¢˜&quot;&gt;1.1 é…ç½®ä¸­å¿ƒé—®é¢˜&lt;/h3&gt;
&lt;p&gt;åœ¨äº‘åŸç”Ÿä¸­é…ç½®ä¸­å¿ƒï¼Œä¾‹å¦‚ï¼š&lt;code&gt;Configmap&lt;/code&gt;å’Œ&lt;code&gt;Secret&lt;/code&gt;å¯¹è±¡ï¼Œè™½ç„¶å¯ä»¥è¿›è¡Œç›´æ¥æ›´æ–°èµ„æºå¯¹è±¡&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å¯¹äºå¼•ç”¨è¿™äº›æœ‰äº›ä¸å˜çš„é…ç½®æ˜¯å¯ä»¥æ‰“åŒ…åˆ°é•œåƒä¸­çš„ï¼Œé‚£å¯å˜çš„é…ç½®å‘¢ï¼Ÿ&lt;/li&gt;
&lt;li&gt;ä¿¡æ¯æ³„æ¼ï¼Œå¾ˆå®¹æ˜“å¼•å‘å®‰å…¨é£é™©ï¼Œå°¤å…¶æ˜¯ä¸€äº›æ•æ„Ÿä¿¡æ¯ï¼Œæ¯”å¦‚å¯†ç ã€å¯†é’¥ç­‰ã€‚&lt;/li&gt;
&lt;li&gt;æ¯æ¬¡é…ç½®æ›´æ–°åï¼Œéƒ½è¦é‡æ–°æ‰“åŒ…ä¸€æ¬¡ï¼Œå‡çº§åº”ç”¨ã€‚é•œåƒç‰ˆæœ¬è¿‡å¤šï¼Œä¹Ÿç»™é•œåƒç®¡ç†å’Œé•œåƒä¸­å¿ƒå­˜å‚¨å¸¦æ¥å¾ˆå¤§çš„è´Ÿæ‹…ã€‚&lt;/li&gt;
&lt;li&gt;å®šåˆ¶åŒ–å¤ªä¸¥é‡ï¼Œå¯æ‰©å±•èƒ½åŠ›å·®ï¼Œä¸”ä¸å®¹æ˜“å¤ç”¨ã€‚&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
    
      <category term="Kubernetes" scheme="https://www.hi-linux.com/categories/kubernetes/"/>
    
    
      <category term="æŠ€å·§" scheme="https://www.hi-linux.com/tags/%E6%8A%80%E5%B7%A7/"/>
    
      <category term="Linux" scheme="https://www.hi-linux.com/tags/Linux/"/>
    
      <category term="Kubernetes" scheme="https://www.hi-linux.com/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>å¦‚ä½•åœ¨å‘½ä»¤è¡Œå¿«é€Ÿè·å–å…¬ç½‘åŠ¨æ€ IP åœ°å€</title>
    <link href="https://www.hi-linux.com/posts/39230.html"/>
    <id>https://www.hi-linux.com/posts/39230.html</id>
    <published>2022-03-04T01:00:00.000Z</published>
    <updated>2022-03-25T06:57:04.579Z</updated>
    
    <content type="html"><![CDATA[<div id="vip-container"><p>å¦‚ä½•ç¡®å®šå…¬ç½‘IPåœ°å€æ˜¯ä¸€ä¸ªè®©å¾ˆå¤šå®¶ç”¨å®½å¸¦æœ‹å‹ä»¬ç»å¸¸é‡åˆ°çš„é—®é¢˜ï¼Œæ¯•ç«Ÿå›ºå®šIPåœ°å€æ€»æ˜¯ä»·æ ¼ä¸è²å› è€Œä¸é€‚ç”¨äºå®¶åº­å®½å¸¦ï¼Œè€Œæˆ‘ä»¬çš„ç”µä¿¡å®½å¸¦è¿è¥å•†ï¼ˆISPï¼‰å¾€å¾€ç»™æˆ‘ä»¬åˆ†é…çš„æ˜¯åŠ¨æ€IPåœ°å€ï¼Œä¹‹æ‰€ä»¥ç§°ä½œä¸ºåŠ¨æ€IPåœ°å€ï¼Œæ˜¯å› ä¸ºæ¯æ¬¡æ‹¨å·å¾—åˆ°çš„IPåœ°å€å¯èƒ½ä¼šä¸ä¸€æ ·ï¼Œè¿˜æœ‰æ›´éªšçš„æ“ä½œå°±æ˜¯æœ‰çš„è¿è¥å•†æ¯å¤©æˆ–ä¸å®šæœŸåœ¨æŸä¸ªæ—¶é—´åˆ·æ–°IPåœ°å€æ± ï¼Œè¿™æ ·å·²ç»è·å¾—çš„IPåœ°å€å°†ä¼šè¢«å¼ºåˆ¶é‡Šæ”¾å¹¶åˆ†é…æ–°çš„IPåœ°å€ã€‚</p><p>è¿™å¯¹äºæˆ‘ä»¬ä¸€äº›è¿è¡Œåœ¨å®¶ç”¨å¸¦å®½ä¸‹çš„æœåŠ¡å¸¦æ¥äº†å½±å“â€”â€”éœ€è¦é‡æ–°è®¾ç½®æœåŠ¡ç«¯ IP åœ°å€ï¼Œæ¯”å¦‚ç›‘æ§ã€ç½‘ç»œå­˜å‚¨ç­‰ç­‰ï¼Œè¿™æ—¶å€™ DDNS å°±å‘æŒ¥ä½œç”¨çš„ï¼Œç°åœ¨å¤§éƒ¨åˆ†è·¯ç”±å™¨å†…ç½®äº† DDNS å®¢æˆ·ç«¯ï¼Œæ¯”å¦‚èŠ±ç”Ÿå£³ç­‰æœåŠ¡å®¢æˆ·ç«¯ï¼Œä½†æ˜¯è¿™äº›å®¢æˆ·ç«¯å­˜åœ¨æ”¶è´¹ã€ä¸ç¨³å®šä»¥åŠåˆ·æ–°é—´éš”å°ç­‰é—®é¢˜ï¼Œå¯¹äºè‡ªå·±æœ‰åŸŸåçš„æœ‹å‹å¯ä»¥ä½¿ç”¨ DNS æœåŠ¡å•†çš„ API è‡ªå·±å®ç° IP æ›´æ–°æ“ä½œï¼Œæ¯”å¦‚é˜¿é‡Œäº‘ï¼ˆAliyunï¼‰ã€Cloudflare å‡å¯ä»¥å®ç°ã€‚</p><p>å¯¹äº DDNS å¦‚ä½•ä½¿ç”¨ API æ›´æ–°ä¸åœ¨æœ¬æ–‡å™è¿°èŒƒå›´å†…ï¼Œä½†è°ƒç”¨ API æœ‰ä¸ªå…³é”®å‚æ•°é‚£å°±æ˜¯å…¬ç½‘IPåœ°å€ï¼Œå¦‚ä½•è·å–å½“å‰è¿è¥å•†åˆ†é…çš„å…¬ç½‘ IPåœ°å€å‘¢ï¼Ÿé™¤äº†é—®è·¯ç”±å™¨å¤–ï¼ˆæ‰“å¼€è·¯ç”±å™¨ç®¡ç†ç•Œé¢æ‰¾åˆ° WAN å£ä¿¡æ¯ï¼‰æˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡ä¸€äº›ç½‘ç»œæœåŠ¡è¿›è¡Œæ£€æµ‹ã€‚</p><a id="more"></a><h2><span id="ä½¿ç”¨-shell-å‘½ä»¤è·å–å…¬ç½‘-ip-åœ°å€">ä½¿ç”¨ Shell å‘½ä»¤è·å–å…¬ç½‘ IP åœ°å€</span></h2><h3><span id="æµè§ˆå™¨æ–¹å¼">æµè§ˆå™¨æ–¹å¼</span></h3><p>å¦‚æœæˆ‘ä»¬ä½¿ç”¨æµè§ˆå™¨æ‰“å¼€è¿™ä¸ªåœ°å€<a href="https://checkip.amazonaws.com/" target="_blank" rel="noopener">checkip.amazonaws.com</a>ä½ å°±ä¼šå‘ç°ä½ çš„å…¬ç½‘IPåœ°å€èµ«ç„¶åœ¨ç›®ï¼Œäº’è”ç½‘ä¸Šçš„æœåŠ¡å™¨æ€»æ˜¯èƒ½å¤ŸçŸ¥é“æ˜¯ä»€ä¹ˆ IPåœ°å€çš„å®¢æˆ·ç«¯å‘èµ·äº†è¿æ¥ï¼Œå½“ç„¶å°±å¯ä»¥é€šè¿‡è¿™ç§æ–¹å¼è·å–å…¬ç½‘ IPï¼ŒåŒæ ·åŠŸèƒ½çš„ç½‘ç«™æœ‰å¾ˆå¤šï¼Œè¿™é‡Œåˆ—ä¸¾éƒ¨åˆ†æˆ‘æ”¶é›†åˆ°çš„ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;checkip.amazonaws.com</span><br><span class="line">https:&#x2F;&#x2F;api.ipify.org</span><br><span class="line">https:&#x2F;&#x2F;ifconfig.me&#x2F;ip</span><br><span class="line">https:&#x2F;&#x2F;icanhazip.com</span><br><span class="line">https:&#x2F;&#x2F;ipinfo.io&#x2F;ip</span><br><span class="line">https:&#x2F;&#x2F;ipecho.net&#x2F;plain</span><br><span class="line">https:&#x2F;&#x2F;checkipv4.dedyn.io</span><br></pre></td></tr></table></figure><h3><span id="curl-æ–¹å¼">cURL æ–¹å¼</span></h3><p>åœ¨å‘½ä»¤è¡Œä¸‹æˆ‘ä»¬å½“ç„¶ä¸èƒ½ä¸ºè¿™ç‚¹å°äº‹éšä¾¿å¯åŠ¨æµè§ˆå™¨ï¼Œæˆ‘ä»¬å¯ä»¥è¯·å‡ºå¦å¤–ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„å·¥å…·ï¼Œé‚£å°±æ˜¯<a href="https://curl.se/" target="_blank" rel="noopener">curl</a>ï¼ŒcURL æ˜¯ä¸€ä¸ªåˆ©ç”¨URLè¯­æ³•åœ¨å‘½ä»¤è¡Œä¸‹å·¥ä½œçš„æ–‡ä»¶ä¼ è¾“å·¥å…·ï¼Œå…³äºcURLçš„å¿«é€Ÿç”¨æ³•å¯ä»¥å‚è€ƒé˜®ä¸€å³°çš„ç½‘ç»œæ—¥å¿—<a href="https://www.ruanyifeng.com/blog/2019/09/curl-reference.html" target="_blank" rel="noopener">ã€Šcurl çš„ç”¨æ³•æŒ‡å—ã€‹</a>ï¼Œè¿™é‡Œä¸å†è¯¦è¿°ï¼Œæœ€ç®€å•çš„ç”¨æ³•å°±æ˜¯<code>curl ä½ è¦è¯·æ±‚çš„ç½‘å€</code>ï¼Œæ¯”å¦‚<code>curl checkip.amazonaws.com</code>ã€‚</p><h3><span id="ä½¿ç”¨-dig-å‘½ä»¤">ä½¿ç”¨ dig å‘½ä»¤</span></h3><p>é¦–æ¬¡åœ¨åˆ«äººè„šæœ¬ä¸­çœ‹åˆ°è¿™ä¸ªæ–¹å¼è·å–å…¬ç½‘IPè§‰å¾—æ¯”è¾ƒæ–°å¥‡ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dig +short myip.opendns.com @resolver1.opendns.com</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ˜¯ç”±OpenDNSæä¾›çš„æœåŠ¡ï¼Œå¦‚æœä½ çš„ä¸»æœºä¸Šæ²¡æœ‰å®‰è£…digå‘½ä»¤ï¼Œå¯¹äºDebianç³»åˆ—ç³»ç»Ÿå¯ä»¥é€šè¿‡<code>apt-get install dnsutils</code>å®‰è£…ï¼Œè¿™ä¸ªå‘½ä»¤çš„åŸç†æ˜¯æŒ‡å®š<code>resolver1.opendns.com</code>ä¸ºåŸŸå<code>myip.opendns.com</code>çš„è§£ææœåŠ¡å™¨ï¼Œä¸ºä»€ä¹ˆè¦æŒ‡å®šï¼Œä¸»è¦æ˜¯é¿å… DNS ä¸‹æ¸¸æœåŠ¡å™¨ç¼“å­˜ï¼Œå¦å¤–è¿™ä¸ªæŒ‡å®šçš„è§£ææœåŠ¡å™¨è¢« OpenDNS è¿›è¡Œäº†ç‰¹æ®Šé…ç½®ï¼Œå…¶å§‹ç»ˆå°†åŸŸå<code>myip.opendns.com</code>è§£æä¸ºå‘èµ· DNS è¯·æ±‚çš„å®¢æˆ·ç«¯ IP åœ°å€ï¼Œè¿™æ ·ä¹Ÿå°±å®ç°äº†æŸ¥æ‰¾å…¬ç½‘ IPçš„åŠŸèƒ½ã€‚</p><p>è¿™ä¸ªå’Œ cURL æ–¹å¼æ¯”æœ‰ä»€ä¹ˆä¼˜åŠ¿å‘¢ï¼Ÿå½“ç„¶æ˜¯æ•°æ®é‡æ›´å°ä¼ è¾“æ›´å¿«ï¼Œæ¯•ç«Ÿä½¿ç”¨ cURL å‘èµ· HTTP è¯·æ±‚å¿…ç„¶ä¼šå¯¼è‡´åè®®å¤´ç­‰æ— å…³ä¿¡æ¯çš„äº¤æ¢ï¼Œå¦‚æœå¯ç”¨äº† HTTPS/TLS é‚£ä¹ˆè¿˜è¦è¿›è¡ŒåŠ å¯†åå•†ï¼Œæ•ˆç‡ä¼šæ¯”è¾ƒä½ï¼Œå½“ç„¶è¿™ç§æ–¹å¼çš„ç¼ºç‚¹å°±æ˜¯ DNS æŸ¥è¯¢å®¹æ˜“è¢«è¿è¥å•†å®¡è®¡å’Œè¿‡æ»¤ï¼Œç¨³å®šæ€§ç•¥å·®ï¼Œä¸è¿‡æˆ‘æµ‹è¯•ä¸‹æ¥é™¤äº†å¶å°”æŸ¥è¯¢å¤±è´¥å¤–å…¶ä½™æƒ…å†µæ˜¯å®Œå…¨ OK çš„ã€‚</p><h2><span id="ä½¿ç”¨-shell-è„šæœ¬è·å–å…¬ç½‘-ip-åœ°å€">ä½¿ç”¨ Shell è„šæœ¬è·å–å…¬ç½‘ IP åœ°å€</span></h2><p>è‡³æ­¤æˆ‘æœ‰ä¸ªæ–°çš„ä¸»æ„ï¼Œé‚£å°±æ˜¯é¦–å…ˆé‡‡ç”¨ dig å‘½ä»¤å¿«é€Ÿæ£€ç´¢å…¬ç½‘ IP åœ°å€ï¼Œå¦‚æœå¤±è´¥åˆ™åˆ‡æ¢åˆ° cURL çš„æ–¹å¼ï¼Œä¸ºäº†é¿å… cURL å•ä¸€æœåŠ¡å™¨å¤±è´¥ï¼Œé‡‡ç”¨è½®è¯¢æˆ–è€…éšæœºçš„æ–¹å¼ï¼Œå°½å¯èƒ½æé«˜æˆåŠŸç‡ã€‚</p><p>ä½¿ç”¨ Bash Shell è„šæœ¬ do itï¼Œæ¯”å¦‚è·å–å…¬ç½‘ IPv4 çš„è„šæœ¬å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># This script try to ensure gets the current IP address (as assigned by the ISP) from</span></span><br><span class="line"><span class="comment"># OpenDNS and other online services as fallbacks</span></span><br><span class="line"></span><br><span class="line">hosts=(<span class="string">"checkip.amazonaws.com"</span> <span class="string">"api.ipify.org"</span> <span class="string">"ifconfig.me/ip"</span> <span class="string">"icanhazip.com"</span> <span class="string">"ipinfo.io/ip"</span> <span class="string">"ipecho.net/plain"</span> <span class="string">"checkipv4.dedyn.io"</span>)</span><br><span class="line"></span><br><span class="line">CURL=`<span class="built_in">which</span> curl`</span><br><span class="line">DIG=`<span class="built_in">which</span> dig`</span><br><span class="line"></span><br><span class="line">check=$(<span class="variable">$DIG</span> +short myip.opendns.com @resolver1.opendns.com A) </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ ! $? -eq 0 ] || [ -z <span class="string">"<span class="variable">$check</span>"</span> ] || [[ ! <span class="variable">$check</span> =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"Unable to get your public IP address by OpenDNS service, try to another way."</span></span><br><span class="line">    count=<span class="variable">$&#123;#hosts[@]&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> [ -z <span class="string">"<span class="variable">$check</span>"</span> ] &amp;&amp; [[ <span class="variable">$count</span> -ne 0 ]]; <span class="keyword">do</span></span><br><span class="line">        selectedhost=<span class="variable">$&#123;hosts[ $RANDOM % $&#123;#hosts[@]&#125;</span> ]&#125;</span><br><span class="line">        check=$(<span class="variable">$CURL</span> -4s https://<span class="variable">$selectedhost</span> | grep <span class="string">'[^[:blank:]]'</span>) &amp;&amp; &#123;</span><br><span class="line">            <span class="keyword">if</span> [ -n <span class="string">"<span class="variable">$check</span>"</span> ] &amp;&amp; [[ <span class="variable">$check</span> =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; <span class="keyword">then</span></span><br><span class="line">                <span class="built_in">break</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                check=<span class="string">""</span></span><br><span class="line">                count=$(expr <span class="variable">$count</span> - 1)</span><br><span class="line">                <span class="built_in">echo</span> <span class="string">"The host <span class="variable">$selectedhost</span> returned an invalid IP address."</span></span><br><span class="line">            <span class="keyword">fi</span></span><br><span class="line">        &#125; || &#123;</span><br><span class="line">            check=<span class="string">""</span></span><br><span class="line">            count=$(expr <span class="variable">$count</span> - 1)</span><br><span class="line">            <span class="built_in">echo</span> <span class="string">"The host <span class="variable">$selectedhost</span> did not respond."</span></span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">"<span class="variable">$check</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"Unable to get your public IP address. Please check your internet connection."</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Your public IP address is <span class="variable">$check</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span> 0</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°è„šæœ¬å¯ä»¥çœ‹å‡ºé¦–å…ˆæˆ‘ä½¿ç”¨ dig æ–¹å¼æŸ¥è¯¢ OpenDNSï¼Œå¦‚æœæŸ¥è¯¢å¤±è´¥æˆ–è€…è¿”å›ä¸ºç©ºæˆ–è€…ä¸æ˜¯ IP åœ°å€ï¼Œé‚£ä¹ˆè¿›å…¥cURLæ¨¡å¼ï¼Œè¿™é‡Œå°†å¯ç”¨æœåŠ¡å™¨æ·»åŠ åˆ° hosts åˆ—è¡¨ï¼Œå¹¶ä¸”éšæœºæŠ½å–ä¸€ä¸ªè¿›è¡ŒcURLï¼Œè¿™é‡Œä½¿ç”¨äº†<code>curl -4s</code>å‚æ•°<code>-4s</code>åˆ†åˆ«è¡¨ç¤ºä»…ä½¿ç”¨ IPv4 æ–¹å¼è¿æ¥ï¼ˆç¡®ä¿è·å– IPv4 åœ°å€ï¼‰å’ŒæŠ‘åˆ¶è¿›åº¦æ¡å’Œé”™è¯¯ä¿¡æ¯ï¼Œå¦‚æœæŠ½å–çš„æœåŠ¡å‘ç”Ÿé”™è¯¯ï¼Œé‚£ä¹ˆè¿›å…¥å¾ªç¯å†æŠ½å–ä¸€ä¸ªï¼Œç›´åˆ°å¾ªç¯æ»¡æœ€å¤§ hosts æ•°åœæ­¢ã€‚</p><h2><span id="æ€»ç»“">æ€»ç»“</span></h2><p>å¤§éƒ¨åˆ†è„šæœ¬ç”šè‡³ä¸€äº›ç¨‹åºä»…ä½¿ç”¨äº†ä¸€ç§æ–¹å¼è·å–å…¬ç½‘ IPï¼Œä½†æ˜¯äº’è”ç½‘ä¸Šè¿™äº›æœåŠ¡å¾€å¾€æ˜¯ä¸å¯é çš„ï¼Œå¦‚æœä½ æ‰€é€‰ç”¨çš„æœåŠ¡å‡ºç°æ•…éšœï¼Œé‚£ä¹ˆå°†ä¼šå½±å“åˆ°ä½ åç»­ä¸šåŠ¡çš„å¼€å±•ï¼Œæ‰€ä»¥æœ¬æ–‡çš„æ ¸å¿ƒæ€æƒ³è¿˜æ˜¯å¤šä¸ªå¤‡ä»½ï¼Œå¦å¤–å¯¹äº cURL æ–¹å¼é‡‡ç”¨éšæœºç¡®ä¿æ‰€è°“çš„â€œè´Ÿè½½å¹³è¡¡â€ï¼Œé¿å… fallback æ—¶è¿‡åº¦è¯·æ±‚æŸä¸ªæœåŠ¡å¯¼è‡´ IP è¢« Banã€‚</p><blockquote><p>æœ¬æ–‡è½¬è½½è‡ªï¼šã€Œ ç‹æ™”çš„åšå®¢ ã€ï¼ŒåŸæ–‡ï¼š<a href="https://tinyurl.com/2p95wpue" target="_blank" rel="noopener">https://tinyurl.com/2p95wpue</a> ï¼Œç‰ˆæƒå½’åŸä½œè€…æ‰€æœ‰ã€‚æ¬¢è¿æŠ•ç¨¿ï¼ŒæŠ•ç¨¿é‚®ç®±: <a href="mailto:editor@hi-linux.com">editor@hi-linux.com</a>ã€‚</p></blockquote></div><script src="https://my.openwrite.cn/js/readmore.js" type="text/javascript"></script><script>var isMobile = navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i);if (!isMobile) {    var btw = new BTWPlugin();    btw.init({        "id": "vip-container",        "blogId": "10135-1588830050631-449",        "name": "ã€Œå¥‡å¦™çš„ Linux ä¸–ç•Œã€",        "qrcode": "https://www.hi-linux.com/img/wechat/mp_qrcode_12.jpg",        "keyword": "VIP"    });}</script>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å¦‚ä½•ç¡®å®šå…¬ç½‘IPåœ°å€æ˜¯ä¸€ä¸ªè®©å¾ˆå¤šå®¶ç”¨å®½å¸¦æœ‹å‹ä»¬ç»å¸¸é‡åˆ°çš„é—®é¢˜ï¼Œæ¯•ç«Ÿå›ºå®šIPåœ°å€æ€»æ˜¯ä»·æ ¼ä¸è²å› è€Œä¸é€‚ç”¨äºå®¶åº­å®½å¸¦ï¼Œè€Œæˆ‘ä»¬çš„ç”µä¿¡å®½å¸¦è¿è¥å•†ï¼ˆISPï¼‰å¾€å¾€ç»™æˆ‘ä»¬åˆ†é…çš„æ˜¯åŠ¨æ€IPåœ°å€ï¼Œä¹‹æ‰€ä»¥ç§°ä½œä¸ºåŠ¨æ€IPåœ°å€ï¼Œæ˜¯å› ä¸ºæ¯æ¬¡æ‹¨å·å¾—åˆ°çš„IPåœ°å€å¯èƒ½ä¼šä¸ä¸€æ ·ï¼Œè¿˜æœ‰æ›´éªšçš„æ“ä½œå°±æ˜¯æœ‰çš„è¿è¥å•†æ¯å¤©æˆ–ä¸å®šæœŸåœ¨æŸä¸ªæ—¶é—´åˆ·æ–°IPåœ°å€æ± ï¼Œè¿™æ ·å·²ç»è·å¾—çš„IPåœ°å€å°†ä¼šè¢«å¼ºåˆ¶é‡Šæ”¾å¹¶åˆ†é…æ–°çš„IPåœ°å€ã€‚&lt;/p&gt;
&lt;p&gt;è¿™å¯¹äºæˆ‘ä»¬ä¸€äº›è¿è¡Œåœ¨å®¶ç”¨å¸¦å®½ä¸‹çš„æœåŠ¡å¸¦æ¥äº†å½±å“â€”â€”éœ€è¦é‡æ–°è®¾ç½®æœåŠ¡ç«¯ IP åœ°å€ï¼Œæ¯”å¦‚ç›‘æ§ã€ç½‘ç»œå­˜å‚¨ç­‰ç­‰ï¼Œè¿™æ—¶å€™ DDNS å°±å‘æŒ¥ä½œç”¨çš„ï¼Œç°åœ¨å¤§éƒ¨åˆ†è·¯ç”±å™¨å†…ç½®äº† DDNS å®¢æˆ·ç«¯ï¼Œæ¯”å¦‚èŠ±ç”Ÿå£³ç­‰æœåŠ¡å®¢æˆ·ç«¯ï¼Œä½†æ˜¯è¿™äº›å®¢æˆ·ç«¯å­˜åœ¨æ”¶è´¹ã€ä¸ç¨³å®šä»¥åŠåˆ·æ–°é—´éš”å°ç­‰é—®é¢˜ï¼Œå¯¹äºè‡ªå·±æœ‰åŸŸåçš„æœ‹å‹å¯ä»¥ä½¿ç”¨ DNS æœåŠ¡å•†çš„ API è‡ªå·±å®ç° IP æ›´æ–°æ“ä½œï¼Œæ¯”å¦‚é˜¿é‡Œäº‘ï¼ˆAliyunï¼‰ã€Cloudflare å‡å¯ä»¥å®ç°ã€‚&lt;/p&gt;
&lt;p&gt;å¯¹äº DDNS å¦‚ä½•ä½¿ç”¨ API æ›´æ–°ä¸åœ¨æœ¬æ–‡å™è¿°èŒƒå›´å†…ï¼Œä½†è°ƒç”¨ API æœ‰ä¸ªå…³é”®å‚æ•°é‚£å°±æ˜¯å…¬ç½‘IPåœ°å€ï¼Œå¦‚ä½•è·å–å½“å‰è¿è¥å•†åˆ†é…çš„å…¬ç½‘ IPåœ°å€å‘¢ï¼Ÿé™¤äº†é—®è·¯ç”±å™¨å¤–ï¼ˆæ‰“å¼€è·¯ç”±å™¨ç®¡ç†ç•Œé¢æ‰¾åˆ° WAN å£ä¿¡æ¯ï¼‰æˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡ä¸€äº›ç½‘ç»œæœåŠ¡è¿›è¡Œæ£€æµ‹ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Linux" scheme="https://www.hi-linux.com/categories/Linux/"/>
    
    
      <category term="æŠ€å·§" scheme="https://www.hi-linux.com/tags/%E6%8A%80%E5%B7%A7/"/>
    
      <category term="Linux" scheme="https://www.hi-linux.com/tags/Linux/"/>
    
      <category term="Shell" scheme="https://www.hi-linux.com/tags/Shell/"/>
    
  </entry>
  
  <entry>
    <title>å¦‚ä½•è®©ä¸€ä¸ªåˆ›ä¸šå…¬å¸ä¼˜é›…çš„è¿›è¡Œäº‘åŸç”Ÿä¹‹æ—…</title>
    <link href="https://www.hi-linux.com/posts/7852.html"/>
    <id>https://www.hi-linux.com/posts/7852.html</id>
    <published>2022-02-27T01:00:00.000Z</published>
    <updated>2022-03-25T06:57:04.581Z</updated>
    
    <content type="html"><![CDATA[<div id="vip-container"><h2><span id="å‰è¨€">å‰è¨€</span></h2><p>ITæ˜¯ä¸€åº§é“åœºï¼</p><p><img src="https://img.hi-linux.com/staticfile/1617155792725-55dca530-a3c3-4d4a-9ae6-3fad2df5755e-2021-09-26-eAvwbl.png" alt></p><p>2020å¹´5æœˆä¸­æ—¬æœ¬ç§‘æ¯•ä¸šåï¼Œè¿›å…¥ä¸¥æ ¼æ„ä¹‰ä¸Šçš„ç¬¬ä¸€å®¶å…¬å¸ã€‚å½“æ—¶å¸¦æˆ‘çš„æ˜¯é˜¿é‡Œäº‘çš„MVPï¼Œä¹Ÿæ˜¯å…¬å¸çš„CTOï¼Œè·Ÿç€ä»–(çŸ³è€å¤§)å­¦åˆ°äº†å¾ˆå¤šå¾ˆå¤šï¼Œå¸¦é¢†æˆ‘ç»è¿‡äº†å…¥é“(æœºä¼šï¼Œä¸æ˜¯äººäººéƒ½æœ‰ï¼Œè¯·æ„Ÿæ©ï¼Œç»™ä½ æœºä¼šå’Œå¸®åŠ©çš„äººï¼‰ã€‚ä¸‰ä¸ªæœˆåä»–ç¦»èŒäº†ï¼Œæ„Ÿè°¢çŸ³è€å¤§ï¼Œæ­£æ˜¯ä»–çš„ç¦»èŒç»™äº†æˆ‘ç‹¬è‡ªé—¯é“çš„æœºä¼šã€‚</p><p>2020å¹´9æœˆå¼€å§‹è¿›å…¥äº†é—¯é“(å­¤ç‹¬ï¼Œç—›è‹¦å’Œç…ç†¬ä¼šæ—¶å¸¸ä¸ä½ å…±èˆ)ã€ä¿®é“(åˆ«å¿˜äº†ï¼Œç»™é£é›¨ä¸­çš„è‡ªå·±ä¸€ä¸ªé¼“åŠ±)ã€æ‚Ÿé“(è®¤çŸ¥å’Œæ€æƒ³ï¼Œæ˜¯æ‹‰å¼€äººä¸äººä¹‹é—´çš„é‡è¦å·®è·)é˜¶æ®µã€‚å¯ä»¥è¯´è‡ªçŸ³è€å¤§èµ°åï¼Œæˆ‘çš„ä»»åŠ¡éƒ½æ˜¯è‡ªæˆ‘å®‰æ’ï¼ŒæŠ€æœ¯éƒ½æ˜¯è‡ªæˆ‘é©±åŠ¨å®ç°çš„ã€‚</p><p>2019å¹´7æœˆç¦»å¼€å­¦æ ¡æ—¶ï¼Œå‘Šè¯‰è‡ªå·±ï¼šæˆ‘çš„è·¯æ˜¯ä¸€æ¡è¿½é€äº‘åŸç”Ÿçš„è·¯ã€‚è‡ª2018å¹´8æœˆæ¥è§¦Kubernetesæ—¶å°±æ·±æ·±çˆ±ä¸Šäº†è¿™æ¡è·¯ã€‚</p><p>2020å¹´6æœˆåˆè¿›å…¥å…¬å¸åï¼Œå®å®åœ¨åœ¨æ„Ÿå—åˆ°äº†åˆ›ä¸šå…¬å¸çš„é›†ç¾¤ç¯å¢ƒä¹‹ä¹±(åªæœ‰å‰ç«¯ä¸šåŠ¡KubernetesåŒ–ä¸”æµ‹è¯•å’Œç”Ÿäº§é€šè¿‡namespaceåŒºåˆ†ã€ç”Ÿäº§Kubernetesèµ„æºç‰¹åˆ«ä½ä¸”æœåŠ¡å‰¯æœ¬æ•°åªæœ‰2ä¸ªã€gitlabä»£ç ä»“åº“æ˜¯éƒ¨ç½²åœ¨Kubernetesç¯å¢ƒä¸Šçš„ã€æƒé™æ··ä¹±ç­‰)ã€‚æå‡ºäº†ä¸€äº›è‡ªå·±çš„è§£å†³æ–¹æ¡ˆï¼š<a href="https://www.cnblogs.com/zisefeizhu/p/13692782.html" target="_blank" rel="noopener">https://www.cnblogs.com/zisefeizhu/p/13692782.html</a></p><a id="more"></a><p>2020å¹´6æœˆæ„å»ºä»¥ELFKä¸ºæŠ€æœ¯æ ¸å¿ƒçš„æ—¥å¿—ç³»ç»Ÿ(åªæ”¶é›†ç½‘å…³æ—¥å¿—å³nginx-ingressæ—¥å¿—ä¸ºå”¯ä¸€æ”¶é›†æº)ã€‚</p><p>2020å¹´7æœˆå›´ç»•ä¸šåŠ¡å…¨é¢KubernetesåŒ–å±•å¼€ï¼Œä¸»å¯¼äº†ä¸šåŠ¡ä»ä¸€åˆ°é›¶å†åˆ°ä¸€çš„è¿‡ç¨‹ã€‚</p><p>2020å¹´8æœˆå’Œ9æœˆå¿™äºé›†ç¾¤å’ŒCI|CDé‡æ„ã€‚æ–°å¢äº†æµ‹è¯•ç¯å¢ƒã€é¢„å‘ç¯å¢ƒï¼Œå°†ç½‘å…³ç”±nginx-ingressæ”¹ä¸ºkong-ingressï¼Œå°†gitlabä»Kubernetesç¯å¢ƒä¸­å‰¥ç¦»å‡ºæ¥ï¼Œå€ŸåŠ©cert-managerå®ç°è¯ä¹¦çš„è‡ªåŠ¨ç”³è¯·å’Œç»­ç­¾ï¼Œå¢åŠ å ¡å’æœºæ›´æ­£æƒé™æ··ä¹±é—®é¢˜ï¼Œä½¿ç”¨gitlab-runnerå®ç°å¤šKubernetesé›†ç¾¤çš„è‡ªåŠ¨åŒ–éƒ¨ç½²ç­‰ã€‚</p><p>2020å¹´10æœˆä¸“æ”»äº&quot;ç›‘æ§é¢„è­¦ç³»ç»Ÿ&quot;ï¼Œå®ç°ä¸‰ä¸ªçº¬åº¦çš„ç›‘æ§ï¼ŒæœŸé—´ç¬¬ä¸€æ¬¡å‚ä¸å¹¶ä¸»å¯¼ç§æœ‰åŒ–é¡¹ç›®çš„éƒ¨ç½²ã€‚</p><p>2020å¹´11æœˆä»¥&quot;ISTIOæœåŠ¡æ²»ç†&quot;ä¸ºé‡å¿ƒï¼Œåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯äº†è¿æ¥ã€å®‰å…¨ã€æµæ§ã€å¯è§†ï¼ŒæœŸé—´å¼€å‘äº†envoyfilteræ’ä»¶å¯¹æ¥é‰´æƒæœåŠ¡ã€‚</p><p>2020å¹´12æœˆå’Œ1æœˆå›´ç»•&quot;kubernetesä¸‹å¾®æœåŠ¡çš„æ—¥å¿—ç³»ç»Ÿ&quot;å±•å¼€ï¼Œå®ç°äº†å¤šKubernetesé›†ç¾¤æœåŠ¡å’Œè£¸æœºæœåŠ¡çš„æ—¥å¿—ç»Ÿä¸€åˆ°ä¸€ä¸ªç®¡ç†å¹³å°ã€‚</p><p>2021å¹´1æœˆå’Œ2æœˆå®ç°äº†å°†é¢„å‘ç¯å¢ƒçš„kong-ingressè¿‡åº¦åˆ°istioã€‚å¹¶å¯¹æ¥äº†è¯ä¹¦æœåŠ¡ã€ç›‘æ§é¢„è­¦ç³»ç»Ÿå’Œæ—¥å¿—ç³»ç»Ÿã€‚</p><p>2021å¹´3æœˆå¿™äºç§æœ‰åŒ–éƒ¨ç½²å’Œistioå‡†å¤‡ä¸Šç”Ÿäº§ç¯å¢ƒçš„éªŒè¯ã€‚</p><p>2021å¹´4æœˆå¿™äºæ—§æœåŠ¡å™¨æ²»ç†ã€ç§æœ‰åŒ–éƒ¨ç½²ã€èšçŸ³å¡”æ–¹é¢çš„æœ‰å…³å·¥ä½œã€‚</p><p>2021å¹´5æœˆå¿™äºistioç”Ÿäº§å¯ç”¨ã€èšçŸ³å¡”å’Œç§æœ‰åŒ–éƒ¨ç½²çš„å·¥ä½œã€‚</p><p>åœ¨å…¬å¸è¿‘1å¹´ä¸­åˆ›å»ºäº†13ä¸ªä»£ç ä»“åº“ï¼Œå†™äº†130ä½™ç¯‡æŠ€æœ¯æ–‡æ¡£ï¼Œ</p><p>2020å¹´6æœˆåˆç»è¿‡è§„åˆ’äº†ä¸€å¼ &quot;åŸºäºKUBERNETESçš„ä¼ä¸šçº§é›†ç¾¤æ¶æ„&quot;ï¼Œç»è¿‡å’ŒCTOåŠå‘æœ‰å…³äººå‘˜çš„é˜è¿°ï¼Œå‡†å¤‡å®æ–½æ­¤æ¶æ„</p><p><img src="https://img.hi-linux.com/staticfile/1617176613827-8f78dfb2-78b9-411e-9879-6461df0a20f7-2021-09-26-Yqe8Vf.png" alt></p><p>æ­¤æ¶æ„è§„åˆ’äº†ä¸‰ä¸ªé›†ç¾¤ç¯å¢ƒï¼šç”Ÿäº§ç¯å¢ƒã€é¢„å‘ç¯å¢ƒã€æµ‹è¯•ç¯å¢ƒ</p><p>æ­¤æ¶æ„é™¤ä¸šåŠ¡å’Œé¡¹ç›®å¤–è¿˜å¢åŠ äº†è¾¹ç•ŒæœåŠ¡ï¼šç»Ÿä¸€æ—¥å¿—ç®¡ç†å¹³å°ã€ç›‘æ§é¢„è­¦ç³»ç»Ÿã€é“¾è·¯è¿½è¸ªã€ç»Ÿä¸€ç®¡ç†å¹³å°ã€è¯ä¹¦è‡ªåŠ¨ç»­ç­¾ã€æµæ§ç­‰ï¼Œä¸‹é¢å°†é‡ç‚¹å›´ç»•æ­¤å±•å¼€</p><h2><span id="åŸºäº-kubernetes-çš„ä¼ä¸šçº§é›†ç¾¤æ¶æ„é‡ç‚¹éƒ¨åˆ†æµ…è§£">åŸºäº KUBERNETES çš„ä¼ä¸šçº§é›†ç¾¤æ¶æ„é‡ç‚¹éƒ¨åˆ†æµ…è§£</span></h2><h3><span id="é‡æ„é›†ç¾¤æ¶æ„-ä¸šåŠ¡å…¨é¢å®¹å™¨åŒ–">é‡æ„é›†ç¾¤æ¶æ„ã€ä¸šåŠ¡å…¨é¢å®¹å™¨åŒ–</span></h3><p>è¿™æ˜¯ä¸€ä¸ªä»ä¸€åˆ°é›¶å†åˆ°ä¸€çš„è¿‡ç¨‹ï¼Œåˆšæ¯•ä¸šå³æ¥è§¦æ­¤ç±»é¡¹ç›®ï¼Œå®å±å¹¸è¿</p><p>å¤§è‡´é‡æ„æ­¥éª¤å¦‚ä¸‹ï¼š</p><blockquote><ul><li>æ ¹æ®åŸæœ‰ä¸šåŠ¡è®¾è®¡å®¹å™¨åŒ–æ¶æ„æ–¹æ¡ˆï¼›</li><li>æ–°å¢å ¡å’æœºJumpserverï¼›</li><li>åˆ¶ä½œå‰åç«¯ä¸šåŠ¡é•œåƒï¼›</li><li>æ–°å¢æµ‹è¯•ç¯å¢ƒKubernetesé›†ç¾¤ã€é¢„å‘ç¯å¢ƒKubernetesé›†ç¾¤ã€æ”¹é€ åŸç”Ÿäº§ç¯å¢ƒKubernetesé›†ç¾¤ï¼›</li><li>å€ŸåŠ©Gitlab-Runnerã€Gitlabã€Kustomizeç­‰å®ç°å¤šé›†ç¾¤çš„CI|CDï¼›</li><li>å’Œæœ‰å…³åŒäº‹ä¸€èµ·å®šä¹‰å‰åç«¯æ—¥å¿—å­—æ®µå’Œè¾“å‡ºå½¢å¼ï¼›</li><li>ååŠ©åç«¯å›¢é˜Ÿå¾®è°ƒåŸè£¸æœºä¸šåŠ¡æºç ï¼›</li><li>å€ŸåŠ©Rancherå®ç°å¯¹å¤šKubernetesé›†ç¾¤çš„ç»Ÿä¸€ç®¡ç†ï¼›</li><li>ç”¨Cert-Managerå®ç°åŸŸåè¯ä¹¦çš„è‡ªåŠ¨ç”³è¯·å’Œç»­æœŸï¼›</li><li>å†™Shellè„šæœ¬å¯¹Gitlabå¤‡ä»½è¿›è¡Œæ£€æŸ¥ã€è£¸æœºæœåŠ¡å¤‡ä»½è¿›è¡Œæ£€æŸ¥ã€å¯¹åŸŸåæœ‰æ•ˆæœŸè¿›è¡Œæ£€æŸ¥ã€‚</li></ul></blockquote><h3><span id="ç»Ÿä¸€æ—¥å¿—ç®¡ç†å¹³å°">ç»Ÿä¸€æ—¥å¿—ç®¡ç†å¹³å°</span></h3><p>æ­¤é¡¹ç›®åº”æ˜¯æˆ‘è¿‘ä¸€å¹´çš„æœ€å¤§æ”¶è·äº†ï¼Œæ€æƒ³ä¸Šã€‚</p><p>å¤§è‡´å®ç°æ€è·¯ï¼šå¤škubernetesé›†ç¾¤çš„namespaceç»å¯¹ä¸èƒ½é‡å¤ï¼Œelasticsearchã€kibanaã€logstashã€kafkaç‹¬ç«‹äºé›†ç¾¤ç¯å¢ƒå¤–ä¸”å…±ç”¨ä¸€å¥—ï¼Œfilebeatã€metricbeatã€kube-state-metricséœ€è¦åœ¨æ¯ä¸ªkubernetesé›†ç¾¤ä¸­éƒ½å­˜åœ¨ä¸€å¥—ã€metricbeatå’Œtagéœ€è¦æ ‡å‡†æ¸…æ™°æ˜äº†ã€æ—¥å¿—ä»¥jsonæ ¼å¼è¾“å‡ºä¸”ä¸å…è®¸å¤šè¡Œæ—¥å¿—å‡ºç°</p><p>ä¸€æä¹‹ä¸¾åœ¨ï¼š</p><blockquote><ul><li>å®ç°äº†å¤šé›†ç¾¤ã€å¤šç¯å¢ƒæ—¥å¿—çš„ç»Ÿä¸€åŒ–ç®¡ç†</li></ul></blockquote><h3><span id="cicd">CI|CD</span></h3><p>åŸºäºæˆ‘å¸ç›®å‰çš„ç ”å‘ç°çŠ¶ï¼Œé€‰æ‹©çš„è‡ªåŠ¨åŒ–éƒ¨ç½²å·¥å…·ä¸º<code>gitlab-runner</code>ã€‚ä»£ç ä»“åº“åˆ›å»ºè§„èŒƒå¯ä»¥å‚è€ƒï¼š<a href="https://www.cnblogs.com/zisefeizhu/p/13621797.html%E3%80%82" target="_blank" rel="noopener">https://www.cnblogs.com/zisefeizhu/p/13621797.htmlã€‚</a></p><p>å¤§è‡´å®ç°æ€è·¯ï¼šç ”å‘æäº¤ä»£ç ä»£ç åˆ°ç‰¹å®šåˆ†æ”¯(åˆ†æ”¯åŒºåˆ†ç¯å¢ƒï¼Œç”Ÿäº§åˆ†æ”¯éœ€è¦é¡¹ç›®æ€»ç›‘merge) --&gt; é•œåƒæ‰“åŒ…(ç”±é¢„å‘Kubernetesé›†ç¾¤çš„ä¸€å°ç‰¹å®šèŠ‚ç‚¹æ‰§è¡Œ) --&gt; æ ¹æ®<code>.gitlab-ci.yml</code> è§„åˆ™è¿›è¡Œä¸šåŠ¡podåŒ–ã€‚</p><p>ä¸€æä¹‹ä¸¾åœ¨ï¼š</p><blockquote><ul><li>é€šè¿‡åˆ†æ”¯åŒºåˆ†ç¯å¢ƒ</li><li>é•œåƒæ‰“åŒ…åªåœ¨ä¸€å°é¢„å‘ç¯å¢ƒçš„ç‰¹å®šèŠ‚ç‚¹æ‰§è¡Œï¼Œå‡å°‘å› æ‰“åŒ…é•œåƒè€Œå¯¹ç”Ÿäº§ç¯å¢ƒå¸¦æ¥çš„æ³¢åŠ¨ï¼Œä¸”å¯ä»¥å­˜åœ¨é•œåƒåˆ©ç”¨</li><li>å¤§é‡å€ŸåŠ©å†…ç½®å˜é‡é€šè¿‡æå‰å†™çš„è„šæœ¬æé«˜Kubernetes éƒ¨ç½²éƒ¨åˆ†çš„èµ„æºæ¸…å•çš„é‡å¤å¯ç”¨æ€§</li></ul></blockquote><h3><span id="ç›‘æ§é¢„è­¦ç³»ç»Ÿ">ç›‘æ§é¢„è­¦ç³»ç»Ÿ</span></h3><p>å®ç°ä¸‰ä¸ªçº¬åº¦(ä¸šåŠ¡ç›‘æ§ã€åº”ç”¨ç›‘æ§ã€æ“ä½œç³»ç»Ÿ)çš„ç›‘æ§é¢„è­¦ç³»ç»Ÿã€‚</p><p>å…¶ä¸­ä¸šåŠ¡ç›‘æ§ä¸»è¦æ˜¯ç ”å‘æä¾›ä¸€äº›ä¸šåŠ¡æŒ‡æ ‡ã€ä¸šåŠ¡æ•°æ®ã€‚å¯¹å…¶å¢ä¸Šç‡ã€é”™è¯¯ç‡ç­‰è¿›è¡Œå‘Šè­¦æˆ–å±•ç¤ºï¼Œéœ€è¦æå‰å®šä¹‰è§„èŒƒç”šè‡³åŸ‹ç‚¹ã€‚</p><p>åº”ç”¨ç¨‹åºçš„ç›‘æ§ä¸»è¦æœ‰æ¢é’ˆå’Œå†…çœã€‚å…¶ä¸­æ¢é’ˆä¸»è¦æ˜¯ä»å¤–éƒ¨æ¢æµ‹åº”ç”¨ç¨‹åºçš„ç‰¹å¾ï¼Œæ¯”å¦‚ç›‘å¬ç«¯å£æ˜¯å¦æœ‰å“åº”ã€‚å†…çœä¸»è¦æ˜¯æŸ¥çœ‹åº”ç”¨ç¨‹åºå†…éƒ¨çš„å†…å®¹ï¼Œåº”ç”¨ç¨‹åºé€šè¿‡æ£€æµ‹å¹¶è¿”å›å…¶å†…éƒ¨çš„çŠ¶æ€ã€å†…éƒ¨çš„ç»„ä»¶ï¼Œäº‹åŠ¡å’Œæ€§èƒ½ç­‰åº¦é‡ï¼Œå®ƒå¯ä»¥ç›´æ¥å°†äº‹ä»¶ã€æ—¥å¿—å’ŒæŒ‡æ ‡ç›´æ¥å‘é€ç»™ç›‘æ§å·¥å…·ã€‚</p><p>æ“ä½œç³»ç»Ÿä¸»è¦æ˜¯ç›‘æ§ä¸»è¦ç»„ä»¶çš„ä½¿ç”¨ç‡ã€é¥±å’Œåº¦ä»¥åŠé”™è¯¯ï¼Œæ¯”å¦‚CPUçš„ä½¿ç”¨ç‡ã€CPUçš„è´Ÿè½½ç­‰ã€‚</p><p>ä¸€æä¹‹ä¸¾åœ¨ï¼š</p><blockquote><ul><li>ä¸‰ä¸ªçº¬åº¦</li><li>è£¸æœºä¹Ÿè¿›è¡Œç›‘æ§</li><li>windowsä¹Ÿè¿›è¡Œç›‘æ§</li></ul></blockquote><h3><span id="æœåŠ¡æ²»ç†">æœåŠ¡æ²»ç†</span></h3><p>éšç€ä¸šåŠ¡çš„ä¸æ–­å¾®æœåŠ¡åŒ–ã€å¯¹äºæœåŠ¡çš„è¿è¡Œçš„å¤±æ§æ„Ÿè¶Šæ¥è¶Šå¼ºã€ä¸”å¯¹ä¸œè¥¿å‘æµé‡çš„ç®¡ç†æˆä¸ºäº†æ€¥éœ€è§£å†³çš„ç—›ç‚¹ã€è€ŒKongç½‘å…³çš„ab testæ˜¯ä»˜è´¹ç‰ˆçš„å¼€ç®±å³ç”¨åŠŸèƒ½ï¼Œè€Œæˆ‘å¸æ°æ°å¼€å§‹éœ€è¦æ­¤åŠŸèƒ½ã€‚åŸºäºä¸ŠæœåŠ¡æ²»ç†å¼€å§‹è¿›è¡Œè§†é‡ã€‚</p><p>æˆ‘å¸å¯¹äºæœåŠ¡æ²»ç†çš„ä½¿ç”¨åº”ç®—ä¸­åº¦ä¾èµ–ï¼Œä¸»è¦ä½¿ç”¨åˆ°å¦‚ä¸‹ç‚¹ï¼š</p><blockquote><ul><li>è´Ÿè½½å‡è¡¡ï¼šåŸºç¡€æœåŠ¡ä½¿ç”¨æœ€å°‘è¿æ¥ç­–ç•¥ï¼Œä¸šåŠ¡å±‚æœåŠ¡ä½¿ç”¨ä¸€è‡´æ€§å“ˆå¸Œè´Ÿè½½å‡è¡¡ã€‚</li><li>å¥åº·æ£€æµ‹ï¼šè¾“å‡ºå¥åº·æ£€æµ‹å…·ä½“é…ç½®æ–¹æ¡ˆã€‚ï¼ˆå¦‚ï¼šåŸºç¡€ç§»å‡ºæ—¶é—´30ç§’ï¼Œ10ç§’å†…å‡ºç°3æ¬¡é”™è¯¯ç§»å‡ºï¼Œæ£€æµ‹æ—¶é—´é—´éš”ä¸º10ç§’â€¦ï¼‰</li><li>è¿æ¥æ± ï¼šåˆ›å»ºè¿æ¥æ± ï¼Œæ¯ä¸ªå®ä¾‹æœ€å¤§å¤„ç†è¯·æ±‚æ•°ä¸º10ï¼Œæ¯ä¸ªè¿æ¥å¤„ç†2ä¸ªè¯·æ±‚åå…³é—­ï¼Œé‡è¯•æ¬¡æ•°ä¸º3æ¬¡ï¼Œè¿æ¥è¶…æ—¶æ—¶é—´ä¸º500msã€‚</li><li>ç†”æ–­ç­–ç•¥ï¼šæ ¹æ®å¥åº·æ£€æµ‹å’Œè¿æ¥æ± ç­–ç•¥å®ç°ç†”æ–­ç­–ç•¥</li><li>é‡è¯•ç­–ç•¥ï¼šæœ€å¤šé‡è¯•3æ¬¡ï¼Œæ¯æ¬¡è°ƒç”¨è¶…æ—¶ä¸º2ç§’ã€‚</li><li>é™æµç­–ç•¥ï¼šåæœŸç”¨æˆ·æ•°æé«˜åå†å®è¡Œã€‚</li><li>é“¾è·¯è¿½è¸ª</li></ul></blockquote><p>ä¸€æä¹‹ä¸¾åœ¨ï¼š</p><blockquote><ul><li>åŸºäºenvoyfilter å’Œluaå¼€å‘å¯¹æ¥é‰´æƒæœåŠ¡å’Œistio</li></ul></blockquote><h3><span id="ç§æœ‰åŒ–éƒ¨ç½²">ç§æœ‰åŒ–éƒ¨ç½²</span></h3><p>å› æˆ‘å¸ä¸»æ‰“äº§å“ä¸º3Dç¼–è¾‘å™¨ï¼Œæ•°æ®ä¿å¯†æ€§è¦æ±‚æé«˜ï¼Œå¤§å‹ä¼ä¸šæ›´åœ¨æ„æ•°æ®ç”±è‡ªå·±æŒæ¡ï¼Œæ‰€ä»¥åœ¨è¿™è¿‘ä¸€å¹´ä¸­åšäº†å¥½å‡ ä¸ªç§æœ‰åŒ–éƒ¨ç½²é¡¹ç›®ã€‚</p><p>åœ¨åšç§æœ‰åŒ–éƒ¨ç½²é¡¹ç›®ä¸­å­¦åˆ°äº†å¾ˆå¤šï¼š</p><blockquote><ul><li>ä¸šåŠ¡ï¼šéœ€è¦çŸ¥é“å®¢æˆ·éœ€æ±‚ç‰µæ‰¯åˆ°çš„æœåŠ¡æœ‰é‚£äº›ï¼Œä½œå‡ºè·¯ç”±è§„åˆ’è¡¨ã€‚</li><li>é›†ç¾¤ï¼šæ ¹æ®å®¢æˆ·çš„éœ€æ±‚ï¼Œä¼°ç®—å‡ºèµ„æºéœ€æ±‚ã€‚</li><li>æ²Ÿé€šï¼šéœ€è¦å’Œå®¢æˆ·(åŸºæœ¬æ˜¯éæŠ€æœ¯ç±»)ã€æˆ‘å¸è¿è¥ç­‰äººäºå•Šè¿›è¡ŒæŠ€æœ¯ä¸Šçš„æ²Ÿé€šï¼Œéœ€è¦å°†ç¹ççš„æŠ€æœ¯é€šä¿—åŒ–ã€‚</li><li>æ—¶é—´ï¼šæ ¹æ®å®¢æˆ·çš„è§„å®šæ—¶é—´å’Œæˆ‘å¸çš„å®é™…ç°çŠ¶è§„åˆ’å‡ºå‡†å¤‡ã€éƒ¨ç½²ã€æµ‹è¯•ã€äº¤ä»˜çš„æ—¶é—´æ®µï¼Œè€ƒéªŒé¡¹ç›®æ—¶é—´æŠŠæ¡åº¦ã€‚</li><li>åè°ƒï¼šåœ¨é¡¹ç›®éƒ¨ç½²ä¸­éš¾å…ä¼šå‡ºç°ä¸€äº›é…ç½®ç±»çš„é—®é¢˜ï¼Œéœ€è¦åç«¯äººå‘˜ä»‹å…¥ã€‚</li></ul></blockquote><p>ä¸€æä¹‹ä¸¾åœ¨ï¼š</p><blockquote><ul><li>ç§æœ‰åŒ–éƒ¨ç½²ä¸¥é‡è€ƒéªŒå¯¹ä¸šåŠ¡ã€é›†ç¾¤çš„ç†Ÿæ‚‰åº¦ï¼Œæ˜¯è€ƒéªŒä¸€ä¸ªè¿ç»´äººå‘˜çš„æŠ€èƒ½ä¿®å…»çš„ã€‚</li></ul></blockquote><h2><span id="æ€»ç»“">æ€»ç»“</span></h2><p>å§‹ç»ˆè®¤ä¸ºITæ˜¯ä¸€åº§é“åœºï¼Œä¿®é“ï¼Œä¿®é“ï¼Œä¿®ä¸€åº§è‡ªå·±çš„é“åœºã€‚åœ¨æ¯•ä¸šçš„è¿‘1å¹´ä¸­ï¼Œç»å†äº†å…¥é“ã€é—¯é“ã€ä¿®é“é˜¶æ®µï¼Œåˆ°ç›®å‰çš„æ‚Ÿé“é˜¶æ®µã€‚</p><p>éœ€è¦æå‡å’ŒæŒæ¡çš„çŸ¥è¯†è¿˜æœ‰å¾ˆå¤šï¼ŒæŠ€æœ¯æ²¡æœ‰æ­¢å¢ƒï¼Œä¾ç„¶åœ¨è·¯ä¸Šã€‚äº‘åŸç”Ÿæ˜¯ä¸€æ¡å……æ»¡æœºé‡çš„è·¯ï¼ŒåšæŒä¸ä¸æ–­è¿½æ±‚æ‰èƒ½ç¿»è¿‡ä¸€åº§åˆä¸€åº§é«˜å±±ã€‚</p><h2><span id="å±•æœ›">å±•æœ›</span></h2><p>æ‚Ÿé“(è®¤çŸ¥å’Œæ€æƒ³ï¼Œæ˜¯æ‹‰å¼€äººä¸äººä¹‹é—´çš„é‡è¦å·®è·)</p><p>è¯•é“(å‡ºé“ä¸‹å±±ã€ä¸–ç•Œè¿™ä¹ˆå¤§)</p><p>å›´ç»• Kubernetes å±•å¼€äº‘åŸç”Ÿçš„æ¶‰çŒï¼Œæ›´å¿«çš„å‚ä¸äºŒå¼€å’Œç¤¾åŒºã€‚</p><p>è¿‡æ‰‹å¦‚ç™»å±±ï¼Œä¸€æ­¥ä¸€é‡å¤©</p><blockquote><p>æœ¬æ–‡è½¬è½½è‡ªï¼šã€Œ åšå®¢å›­ ã€ï¼ŒåŸæ–‡ï¼š<a href="https://tinyurl.com/hc9vn8hf" target="_blank" rel="noopener">https://tinyurl.com/hc9vn8hf</a> ï¼Œç‰ˆæƒå½’åŸä½œè€…æ‰€æœ‰ã€‚æ¬¢è¿æŠ•ç¨¿ï¼ŒæŠ•ç¨¿é‚®ç®±: <a href="mailto:editor@hi-linux.com">editor@hi-linux.com</a>ã€‚</p></blockquote></div><script src="https://my.openwrite.cn/js/readmore.js" type="text/javascript"></script><script>var isMobile = navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i);if (!isMobile) {    var btw = new BTWPlugin();    btw.init({        "id": "vip-container",        "blogId": "10135-1588830050631-449",        "name": "ã€Œå¥‡å¦™çš„ Linux ä¸–ç•Œã€",        "qrcode": "https://www.hi-linux.com/img/wechat/mp_qrcode_12.jpg",        "keyword": "VIP"    });}</script>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;å‰è¨€&quot;&gt;å‰è¨€&lt;/h2&gt;
&lt;p&gt;ITæ˜¯ä¸€åº§é“åœºï¼&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://img.hi-linux.com/staticfile/1617155792725-55dca530-a3c3-4d4a-9ae6-3fad2df5755e-2021-09-26-eAvwbl.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;2020å¹´5æœˆä¸­æ—¬æœ¬ç§‘æ¯•ä¸šåï¼Œè¿›å…¥ä¸¥æ ¼æ„ä¹‰ä¸Šçš„ç¬¬ä¸€å®¶å…¬å¸ã€‚å½“æ—¶å¸¦æˆ‘çš„æ˜¯é˜¿é‡Œäº‘çš„MVPï¼Œä¹Ÿæ˜¯å…¬å¸çš„CTOï¼Œè·Ÿç€ä»–(çŸ³è€å¤§)å­¦åˆ°äº†å¾ˆå¤šå¾ˆå¤šï¼Œå¸¦é¢†æˆ‘ç»è¿‡äº†å…¥é“(æœºä¼šï¼Œä¸æ˜¯äººäººéƒ½æœ‰ï¼Œè¯·æ„Ÿæ©ï¼Œç»™ä½ æœºä¼šå’Œå¸®åŠ©çš„äººï¼‰ã€‚ä¸‰ä¸ªæœˆåä»–ç¦»èŒäº†ï¼Œæ„Ÿè°¢çŸ³è€å¤§ï¼Œæ­£æ˜¯ä»–çš„ç¦»èŒç»™äº†æˆ‘ç‹¬è‡ªé—¯é“çš„æœºä¼šã€‚&lt;/p&gt;
&lt;p&gt;2020å¹´9æœˆå¼€å§‹è¿›å…¥äº†é—¯é“(å­¤ç‹¬ï¼Œç—›è‹¦å’Œç…ç†¬ä¼šæ—¶å¸¸ä¸ä½ å…±èˆ)ã€ä¿®é“(åˆ«å¿˜äº†ï¼Œç»™é£é›¨ä¸­çš„è‡ªå·±ä¸€ä¸ªé¼“åŠ±)ã€æ‚Ÿé“(è®¤çŸ¥å’Œæ€æƒ³ï¼Œæ˜¯æ‹‰å¼€äººä¸äººä¹‹é—´çš„é‡è¦å·®è·)é˜¶æ®µã€‚å¯ä»¥è¯´è‡ªçŸ³è€å¤§èµ°åï¼Œæˆ‘çš„ä»»åŠ¡éƒ½æ˜¯è‡ªæˆ‘å®‰æ’ï¼ŒæŠ€æœ¯éƒ½æ˜¯è‡ªæˆ‘é©±åŠ¨å®ç°çš„ã€‚&lt;/p&gt;
&lt;p&gt;2019å¹´7æœˆç¦»å¼€å­¦æ ¡æ—¶ï¼Œå‘Šè¯‰è‡ªå·±ï¼šæˆ‘çš„è·¯æ˜¯ä¸€æ¡è¿½é€äº‘åŸç”Ÿçš„è·¯ã€‚è‡ª2018å¹´8æœˆæ¥è§¦Kubernetesæ—¶å°±æ·±æ·±çˆ±ä¸Šäº†è¿™æ¡è·¯ã€‚&lt;/p&gt;
&lt;p&gt;2020å¹´6æœˆåˆè¿›å…¥å…¬å¸åï¼Œå®å®åœ¨åœ¨æ„Ÿå—åˆ°äº†åˆ›ä¸šå…¬å¸çš„é›†ç¾¤ç¯å¢ƒä¹‹ä¹±(åªæœ‰å‰ç«¯ä¸šåŠ¡KubernetesåŒ–ä¸”æµ‹è¯•å’Œç”Ÿäº§é€šè¿‡namespaceåŒºåˆ†ã€ç”Ÿäº§Kubernetesèµ„æºç‰¹åˆ«ä½ä¸”æœåŠ¡å‰¯æœ¬æ•°åªæœ‰2ä¸ªã€gitlabä»£ç ä»“åº“æ˜¯éƒ¨ç½²åœ¨Kubernetesç¯å¢ƒä¸Šçš„ã€æƒé™æ··ä¹±ç­‰)ã€‚æå‡ºäº†ä¸€äº›è‡ªå·±çš„è§£å†³æ–¹æ¡ˆï¼š&lt;a href=&quot;https://www.cnblogs.com/zisefeizhu/p/13692782.html&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://www.cnblogs.com/zisefeizhu/p/13692782.html&lt;/a&gt;&lt;/p&gt;
    
    </summary>
    
    
      <category term="Kubernetes" scheme="https://www.hi-linux.com/categories/kubernetes/"/>
    
    
      <category term="Linux" scheme="https://www.hi-linux.com/tags/Linux/"/>
    
      <category term="Kubernetes" scheme="https://www.hi-linux.com/tags/Kubernetes/"/>
    
      <category term="äº‘åŸç”Ÿ" scheme="https://www.hi-linux.com/tags/%E4%BA%91%E5%8E%9F%E7%94%9F/"/>
    
  </entry>
  
  <entry>
    <title>ä½¿ç”¨ Nginx ä¸‰æ–¹æ‰©å±• ngx_waf å¿«é€Ÿå®ç°ä¸€ä¸ªé«˜æ€§èƒ½çš„ Web åº”ç”¨é˜²ç«å¢™</title>
    <link href="https://www.hi-linux.com/posts/36520.html"/>
    <id>https://www.hi-linux.com/posts/36520.html</id>
    <published>2022-02-23T01:00:00.000Z</published>
    <updated>2022-02-23T05:13:47.620Z</updated>
    
    <content type="html"><![CDATA[<div id="vip-container"><blockquote><p><strong>ngx_wafï¼šæ–¹ä¾¿ä¸”é«˜æ€§èƒ½çš„ Nginx é˜²ç«å¢™æ¨¡å—</strong></p></blockquote><p>ç¼“å­˜ç­–ç•¥ä¸º <code>LRU</code>ï¼Œ<code>IP</code> æ£€æŸ¥å’Œ <code>CC</code> é˜²å¾¡èŠ±è´¹å¸¸æ•°æ—¶é—´ï¼Œå…¶å®ƒçš„æ£€æŸ¥èŠ±è´¹ <code>O(nm)</code> çš„æ—¶é—´ï¼Œå…¶ä¸­ <code>n</code> æ˜¯ç›¸å…³è§„åˆ™çš„æ¡æ•°ï¼Œ<code>m</code> ä¸ºæ‰§è¡Œæ­£åˆ™åŒ¹é…çš„æ—¶é—´å¤æ‚åº¦ï¼Œä½†æ˜¯æ¯æ¬¡æ£€æŸ¥è¿‡åä¼šè‡ªåŠ¨ç¼“å­˜æœ¬æ¬¡æ£€æŸ¥çš„ç»“æœï¼Œä¸‹æ¬¡æ£€æŸ¥ç›¸åŒçš„ç›®æ ‡æ—¶å°±å¯ä»¥ä½¿ç”¨ç¼“å­˜è€Œä¸æ˜¯æ£€æŸ¥å…¨éƒ¨çš„è§„åˆ™ã€‚ä¸ä¼šç¼“å­˜ <code>POST</code> è¯·æ±‚ä½“çš„æ£€æŸ¥ç»“æœã€‚</p><a id="more"></a><h2><span id="å·¥å…·ç‰¹ç‚¹">å·¥å…·ç‰¹ç‚¹</span></h2><blockquote><p><strong>ä»‹ç»äº†è¯¥å·¥å…·çš„ä¸»è¦ç‰¹ç‚¹ä»¥åŠæ ¸å¿ƒåŠŸèƒ½ï¼</strong></p></blockquote><p>è¯¥ <code>Nginx</code> çš„ç¬¬ä¸‰æ–¹æ‰©å±•å·¥å…·ï¼Œå¯ä»¥é˜²å¾¡ <code>CC</code> æ”»å‡»(è¶…å‡ºé™åˆ¶åè‡ªåŠ¨æ‹‰é»‘å¯¹åº” <code>IP</code> ä¸€æ®µæ—¶é—´æˆ–è€…ä½¿ç”¨éªŒè¯ç åšäººæœºè¯†åˆ«)ï¼Œå¯ä»¥æ”¯æŒå¤šç§é»‘ç™½åå•(<code>IP</code>/<code>POST</code>/<code>URL</code>/<code>UA</code>ç­‰ç­‰)ï¼Œè¿˜å¯ä»¥æä¾›é˜²æŠ¤ <code>SQL</code> æ³¨å…¥å’Œ <code>XSS</code> å·¥å…·ã€‚</p><ul><li>ä½¿ç”¨ç®€å•<ul><li>é…ç½®æ–‡ä»¶å’Œè§„åˆ™æ–‡ä»¶ä¹¦å†™ç®€å•ï¼Œå¯è¯»æ€§å¼º</li></ul></li><li>åŸºç¡€é˜²æŠ¤<ul><li>å¦‚ <code>IP</code> æˆ– <code>IP</code> ç½‘æ®µçš„é»‘ç™½åå•ã€<code>URI</code> é»‘ç™½åå•å’Œè¯·æ±‚ä½“é»‘åå•ç­‰</li></ul></li><li>é«˜æ€§èƒ½<ul><li>ä½¿ç”¨é«˜æ•ˆçš„ <code>IP</code> æ£€æŸ¥ç®—æ³•å’Œç¼“å­˜æœºåˆ¶ï¼Œæ”¯æŒ <code>IPV4</code> å’Œ <code>IPV6</code></li></ul></li><li>é«˜çº§é˜²æŠ¤<ul><li>å…¼å®¹ <a href="https://github.com/SpiderLabs/ModSecurity" target="_blank" rel="noopener"><code>ModSecurity</code></a> çš„è§„åˆ™ï¼Œä½ å¯ä»¥ä½¿ç”¨ <code>OWASP</code> çš„æ ¸å¿ƒè§„åˆ™åº“</li></ul></li><li>å‹å¥½çˆ¬è™«éªŒè¯<ul><li>æ”¯æŒéªŒè¯ <code>Google</code>ã€<code>Bing</code>ã€<code>Baidu</code> å’Œ <code>Yandex</code> çš„çˆ¬è™«å¹¶è‡ªåŠ¨æ”¾è¡Œï¼Œé¿å…é”™è¯¯æ‹¦æˆªï¼Œä¸»è¦æ˜¯åŸºäº <code>User-Agent</code> å’Œ <code>IP</code> çš„è¯†åˆ«è§„åˆ™</li></ul></li><li>éªŒè¯ç <ul><li>æ”¯æŒä¸‰ç§éªŒè¯ç ï¼š<code>hCaptcha</code>ã€<code>reCAPTCHAv2</code> å’Œ <code>reCAPTCHAv3</code></li></ul></li></ul><h2><span id="æ¨¡å—å®‰è£…">æ¨¡å—å®‰è£…</span></h2><blockquote><p><strong>ç¬¬ä¸‰æ–¹æ¨¡å—æˆ‘ä»¬åº”è¯¥æ€ä¹ˆå®‰è£…å‘¢ï¼Ÿ</strong></p></blockquote><p><code>Nginx</code> æä¾›ä¸¤ç§å®‰è£…æ¨¡å—çš„æ–¹å¼ï¼Œå³ã€Œé™æ€é“¾æ¥ã€å’Œã€ŒåŠ¨æ€åŠ è½½ã€ï¼Œé€šè¿‡ä¸¤ç§æ–¹å¼å®‰è£…çš„æ¨¡å—ä¹Ÿåˆ†åˆ«ç§°ä¸ºã€Œé™æ€æ¨¡å—ã€å’Œã€ŒåŠ¨æ€æ¨¡å—ã€ï¼Œå¯ä»¥é€šè¿‡è¿è¡Œè„šæœ¬ <code>assets/guide.sh</code> æ¥é€‰æ‹©ä½¿ç”¨é™æ€æ¨¡å—è¿˜æ˜¯åŠ¨æ€æ¨¡å—ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤</span></span><br><span class="line">$ sh assets/guide.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¦‚æœè¾“å‡ºä¸‹é¢è¿™è¡Œï¼Œåˆ™å»ºè®®ä½¿ç”¨åŠ¨æ€æ¨¡å—</span></span><br><span class="line"><span class="comment"># It is recommended that you use dynamic modules.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¦‚æœè¾“å‡ºä¸‹é¢è¿™è¡Œï¼Œåˆ™å»ºè®®ä½¿ç”¨é™æ€æ¨¡å—</span></span><br><span class="line"><span class="comment"># It is recommended that you use static modules.</span></span><br></pre></td></tr></table></figure><ul><li><strong>[1] é™æ€æ¨¡å—</strong></li></ul><p>ç¼–è¯‘å®‰è£…ä¸€ä¸ªæ–°çš„æ¨¡å—éœ€è¦çŸ¥é“å½“å‰çš„ <code>Nginx</code> çš„ <code>configure</code> è„šæœ¬çš„å‚æ•°ï¼Œæ‚¨å¯ä»¥é€šè¿‡è¿è¡Œ <code>nginx -V</code> æ¥è·å–ï¼ŒåŠ¡å¿…è®°ä½ <code>configure arguments:</code> åé¢çš„å†…å®¹ã€‚å®‰è£…é™æ€æ¨¡å—éœ€è¦é‡æ–°ç¼–è¯‘æ•´ä¸ª <code>Nginx</code>ï¼ŒèŠ±è´¹çš„æ—¶é—´ç›¸å¯¹äºå®‰è£…åŠ¨æ€æ¨¡å—æ¯”è¾ƒé•¿ã€‚å¦‚æœä¸æƒ³åœ¨æ›¿æ¢äºŒè¿›åˆ¶æ–‡ä»¶æ—¶ï¼Œå…³é—­ <code>Nginx</code> æœåŠ¡çš„è¯ï¼Œå¯ä»¥å‚è€ƒ<a href="https://nginx.org/en/docs/control.html" target="_blank" rel="noopener">å®˜æ–¹æ–‡æ¡£çš„çƒ­éƒ¨ç½²æ–¹æ¡ˆ</a>ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¸‹è½½å¯¹åº”çš„Nginxç‰ˆæœ¬</span></span><br><span class="line"><span class="comment"># http://nginx.org/en/download.html</span></span><br><span class="line">$ <span class="built_in">cd</span> /usr/<span class="built_in">local</span>/src</span><br><span class="line">$ wget https://nginx.org/download/nginx-1.20.1.tar.gz</span><br><span class="line">$ tar -zxf nginx-1.20.1.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨ç¨³å®šç‰ˆçš„æºç </span></span><br><span class="line">$ <span class="built_in">cd</span> /usr/<span class="built_in">local</span>/src</span><br><span class="line">$ git <span class="built_in">clone</span> -b lts https://github.com/ADD-SP/ngx_waf.git</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿è¡Œé…ç½®è„šæœ¬</span></span><br><span class="line">$ <span class="built_in">cd</span> /usr/<span class="built_in">local</span>/src/nginx-1.20.1</span><br><span class="line">$ ./configure ARG --add-module=/usr/<span class="built_in">local</span>/src/ngx_waf</span><br><span class="line">$ sed -i <span class="string">'s/^\(CFLAGS.*\)/\1 \</span></span><br><span class="line"><span class="string">    -fstack-protector-strong -Wno-sign-compare/'</span> \</span><br><span class="line">    objs/Makefile</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¼–è¯‘(éå¹¶è¡Œ/å¹¶è¡Œ)</span></span><br><span class="line">$ make</span><br><span class="line">$ make -j$(nproc)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ›¿æ¢NginxäºŒè¿›åˆ¶æ–‡ä»¶(å‡è®¾å·²ç»å®‰è£…è¿‡)</span></span><br><span class="line">$ cp objs/nginx /usr/<span class="built_in">local</span>/nginx/sbin/nginx</span><br></pre></td></tr></table></figure><ul><li><strong>[2] åŠ¨æ€æ¨¡å— - ä¸‹è½½é¢„æ„å»ºçš„æ¨¡å—</strong></li></ul><p>é€šè¿‡æ‰§è¡Œè„šæœ¬ <code>assets/download.sh</code> æ¥ä¸‹è½½åŠ¨æ€æ¨¡å—ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç”¨äºnginx-1.20.1çš„LTSç‰ˆçš„æ¨¡å—</span></span><br><span class="line">$ sh assets/download.sh 1.20.1 lts</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”¨äºnginx-1.20.1çš„æœ€æ–°ç‰ˆçš„æ¨¡å—</span></span><br><span class="line">$ sh assets/download.sh 1.20.1 current</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰§è¡ŒæˆåŠŸåä¼šæœ‰å¦‚ä¸‹è¾“å‡º</span></span><br><span class="line">checking <span class="keyword">for</span> <span class="built_in">command</span> ... yes</span><br><span class="line">checking <span class="keyword">for</span> libc implementation ... yes</span><br><span class="line"> + GNU C libary</span><br><span class="line">Pulling remote image addsp/ngx_waf-prebuild:ngx-1.20.1-module-beta-glibc</span><br><span class="line">......</span><br><span class="line">Download complete!</span><br></pre></td></tr></table></figure><p>å¦‚æœçœ‹åˆ° <code>Download complete!</code> çš„è¯ï¼Œåˆ™è¯´æ˜ä¸‹è½½æˆåŠŸï¼Œæ¨¡å—ä¼šè¢«ä¿å­˜åœ¨å½“å‰ç›®å½•ä¸‹ã€‚ä½ å¯ä»¥å°†å…¶æ‹·è´åˆ°ä¸€ä¸ªç›®å½•ä¸‹ï¼Œç„¶ååœ¨ <code>nginx.conf</code> çš„é¡¶éƒ¨æ·»åŠ ä¸€è¡Œã€‚ç„¶åå…³é—­ <code>Nginx</code> æœåŠ¡å¹¶è¿è¡Œ <code>nginx -t</code>ã€‚å¦‚æœæ²¡æœ‰å‡ºé”™åˆ™è¯´æ˜æ¨¡å—è¢«æ­£å¸¸åŠ è½½ï¼Œåä¹‹åˆ™è¯´æ˜æ‚¨çš„ <code>Nginx</code> ä¸æ”¯æŒé¢„æ„å»ºçš„æ¨¡å—ï¼Œè¯·ç¼–è¯‘å®‰è£…æ¨¡å—ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">load_module &quot;&#x2F;path&#x2F;to&#x2F;ngx_http_waf_module.so&quot;;</span><br></pre></td></tr></table></figure><ul><li><strong>[3] åŠ¨æ€æ¨¡å— - ç¼–è¯‘åŠ¨æ€æ¨¡å—</strong></li></ul><p>ç¼–è¯‘å®‰è£…åŠ¨æ€æ¨¡å—å¹¶ä¸éœ€è¦é‡æ–°ç¼–è¯‘æ•´ä¸ª <code>Nginx</code>ï¼Œåªéœ€è¦é‡æ–°ç¼–è¯‘æ‰€æœ‰çš„æ¨¡å—ï¼Œæ‰€ä»¥é€Ÿåº¦ç›¸å¯¹é™æ€æ¨¡å—å¿«ä¸€äº›ï¼Œè¿™ä¹Ÿæ˜¯æœ¬æ–‡æ¡£æ¨èçš„æ–¹å¼ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¸‹è½½å¯¹åº”çš„Nginxç‰ˆæœ¬</span></span><br><span class="line"><span class="comment"># http://nginx.org/en/download.html</span></span><br><span class="line">$ <span class="built_in">cd</span> /usr/<span class="built_in">local</span>/src</span><br><span class="line">$ wget https://nginx.org/download/nginx-1.20.1.tar.gz</span><br><span class="line">$ tar -zxf nginx-1.20.1.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨ç¨³å®šç‰ˆçš„æºç </span></span><br><span class="line">$ <span class="built_in">cd</span> /usr/<span class="built_in">local</span>/src</span><br><span class="line">$ git <span class="built_in">clone</span> -b lts https://github.com/ADD-SP/ngx_waf.git</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿è¡Œé…ç½®è„šæœ¬</span></span><br><span class="line">$ <span class="built_in">cd</span> /usr/<span class="built_in">local</span>/src/nginx-1.20.1</span><br><span class="line">$ ./configure --add-dynamic-module=/usr/<span class="built_in">local</span>/src/ngx_waf --with-compat</span><br><span class="line">$ sed -i <span class="string">'s/^\(CFLAGS.*\)/\1 \</span></span><br><span class="line"><span class="string">    -fstack-protector-strong -Wno-sign-compare/'</span> \</span><br><span class="line">    objs/Makefile</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¼€å§‹ç¼–è¯‘åŠ¨æ€æ¨¡å—</span></span><br><span class="line">$ make modules</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†åŠ¨æ€æ¨¡å—æ‹·è´åˆ°æ¨¡å—ç›®å½•(å…³é—­æœåŠ¡)</span></span><br><span class="line">$ cp objs/*.so /usr/<span class="built_in">local</span>/nginx/modules</span><br></pre></td></tr></table></figure><p>æœ€åï¼Œåœ¨ <code>Nginx</code> çš„é…ç½®æ–‡ä»¶é¡¶éƒ¨æ·»åŠ ä¸€è¡Œï¼Œè¡¨ç¤ºåŠ è½½è¿™ä¸ªç¼–è¯‘å¥½çš„æ¨¡å—ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">load_module &quot;&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;modules&#x2F;ngx_http_waf_module.so&quot;;</span><br></pre></td></tr></table></figure><h2><span id="æ¨¡å—ä½¿ç”¨">æ¨¡å—ä½¿ç”¨</span></h2><blockquote><p><strong>ç¬¬ä¸‰æ–¹æ¨¡å—æˆ‘ä»¬åº”è¯¥æ€ä¹ˆä½¿ç”¨å‘¢ï¼Ÿæ›´å¤šå‚æ•°å‚è€ƒ <a href="https://docs.addesp.com/ngx_waf/zh-cn/advance/directive.html" target="_blank" rel="noopener">é…ç½®è¯­æ³•</a></strong></p></blockquote><p>ç°åœ¨å°±å¯ä»¥åœ¨ <code>nginx.conf</code> å†…çš„ä¸€ä¸ª <code>server</code> å—ä¸­æ·»åŠ é…ç½®æ¥å¼€å¯ <code>ngx_waf</code> æ¨¡å—æ¥é…ç½®æœåŠ¡çš„é˜²ç«å¢™äº†ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ã€‚</p><ul><li><strong>[1] LTS ç‰ˆæœ¬</strong></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">    ...</span><br><span class="line">    server &#123;</span><br><span class="line">        ...</span><br><span class="line">        # on&#x2F;off è¡¨ç¤ºå¯ç”¨å’Œå…³é—­</span><br><span class="line">        waf on;</span><br><span class="line"></span><br><span class="line">        # è§„åˆ™æ–‡ä»¶æ‰€åœ¨ç›®å½•çš„ç»å¯¹è·¯å¾„ï¼Œå¿…é¡»ä»¥&#x2F;ç»“å°¾</span><br><span class="line">        waf_rule_path &#x2F;usr&#x2F;local&#x2F;src&#x2F;ngx_waf&#x2F;assets&#x2F;rules&#x2F;;</span><br><span class="line"></span><br><span class="line">        # é˜²ç«å¢™å·¥ä½œæ¨¡å¼ï¼ŒSTDè¡¨ç¤ºæ ‡å‡†æ¨¡å¼</span><br><span class="line">        waf_mode STD;</span><br><span class="line"></span><br><span class="line">        # CCé˜²å¾¡å‚æ•°</span><br><span class="line">        # 1000è¡¨ç¤ºæ¯åˆ†é’Ÿè¯·æ±‚æ¬¡æ•°ä¸Šé™ï¼Œè¶…å‡ºä¸Šé™åå°ç¦å¯¹åº”ipåœ°å€60åˆ†é’Ÿ</span><br><span class="line">        waf_cc_deny rate&#x3D;1000r&#x2F;m duration&#x3D;60m;</span><br><span class="line"></span><br><span class="line">        # æœ€å¤šç¼“å­˜50ä¸ªæ£€æµ‹ç›®æ ‡çš„æ£€æµ‹ç»“æœ</span><br><span class="line">        # å¯¹é™¤äº†IPé»‘ç™½åå•æ£€æµ‹ã€CCé˜²æŠ¤å’ŒPOSTæ£€æµ‹ä»¥å¤–çš„æ‰€æœ‰æ£€æµ‹ç”Ÿæ•ˆ</span><br><span class="line">        waf_cache capacity&#x3D;50;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>[2] Current ç‰ˆæœ¬</strong></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">    # å£°æ˜ä¸€å—å…±äº«å†…å­˜</span><br><span class="line">    waf_zone name&#x3D;waf size&#x3D;20m;</span><br><span class="line">    ...</span><br><span class="line">    server &#123;</span><br><span class="line">        ...</span><br><span class="line">        # on&#x2F;off è¡¨ç¤ºå¯ç”¨å’Œå…³é—­</span><br><span class="line">        waf on;</span><br><span class="line"></span><br><span class="line">        # è§„åˆ™æ–‡ä»¶æ‰€åœ¨ç›®å½•çš„ç»å¯¹è·¯å¾„ï¼Œå¿…é¡»ä»¥&#x2F;ç»“å°¾</span><br><span class="line">        waf_rule_path &#x2F;usr&#x2F;local&#x2F;src&#x2F;ngx_waf&#x2F;assets&#x2F;rules&#x2F;;</span><br><span class="line"></span><br><span class="line">        # é˜²ç«å¢™å·¥ä½œæ¨¡å¼ï¼ŒSTDè¡¨ç¤ºæ ‡å‡†æ¨¡å¼</span><br><span class="line">        waf_mode STD;</span><br><span class="line"></span><br><span class="line">        # CCé˜²å¾¡å‚æ•°</span><br><span class="line">        # 1000è¡¨ç¤ºæ¯åˆ†é’Ÿè¯·æ±‚æ¬¡æ•°ä¸Šé™ï¼Œè¶…å‡ºä¸Šé™åå°ç¦å¯¹åº”ipåœ°å€60åˆ†é’Ÿ</span><br><span class="line">        waf_cc_deny on rate&#x3D;1000r&#x2F;m duration&#x3D;60m zone&#x3D;waf:cc;</span><br><span class="line"></span><br><span class="line">        # å¯¹é™¤äº†IPé»‘ç™½åå•æ£€æµ‹ã€CCé˜²æŠ¤å’ŒPOSTæ£€æµ‹ä»¥å¤–çš„æ‰€æœ‰æ£€æµ‹ç”Ÿæ•ˆ</span><br><span class="line">        waf_cache on capacity&#x3D;50;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="å¸¸ç”¨è®¾ç½®">å¸¸ç”¨è®¾ç½®</span></h2><blockquote><p><strong>åˆ—å‡ºä¸€äº› <a href="https://docs.addesp.com/ngx_waf/zh-cn/practice/overview.html" target="_blank" rel="noopener">å¸¸ç”¨çš„è®¾ç½®</a>ï¼Œæ‹¿æ¥ç›´æ¥å°±å¯ä»¥ä½¿ç”¨ï¼</strong></p></blockquote><p>å› ä¸ºæ¨¡å—çš„é…ç½®æ¯”è¾ƒå¤æ‚ï¼Œä¸ºäº†é™ä½ä½¿ç”¨éš¾åº¦ï¼Œåœ¨è¿™é‡Œåˆ—å‡ºäº†ä¸€äº›å¸¸è§ç”¨æ³•ã€‚</p><ul><li><strong>[1] é’ˆå¯¹è·¯å¾„æˆ–æ–‡ä»¶é™æµ</strong></li></ul><p>æœ‰æ—¶ä½ å¯èƒ½æƒ³è¦é™åˆ¶ä¸åŒçš„è·¯å¾„æˆ–æ–‡ä»¶çš„è¯·æ±‚é€Ÿç‡ï¼Œæ¯”å¦‚é™æ€èµ„æºå’ŒåŠ¨æ€èµ„æºä½¿ç”¨ä¸åŒçš„é€Ÿç‡é™åˆ¶ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># LTS</span><br><span class="line"></span><br><span class="line"># å°†é™æ€èµ„æºçš„è¯·æ±‚é€Ÿç‡é™åˆ¶åˆ°10,000æ¬¡&#x2F;åˆ†é’Ÿ</span><br><span class="line">location &#x2F;static&#x2F; &#123;</span><br><span class="line">    waf_cc_deny rate&#x3D;10000r&#x2F;m duration&#x3D;1h;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># å°†åŠ¨æ€èµ„æºçš„è¯·æ±‚é€Ÿç‡é™åˆ¶åˆ°2,000æ¬¡&#x2F;åˆ†é’Ÿ</span><br><span class="line">location &#x2F;dynamic&#x2F; &#123;</span><br><span class="line">    waf_cc_deny rate&#x3D;2000r&#x2F;m duration&#x3D;1h;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># Current</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    waf_zone name&#x3D;waf size&#x3D;20m;</span><br><span class="line">    server &#123;</span><br><span class="line">        # å°†é™æ€èµ„æºçš„è¯·æ±‚é€Ÿç‡é™åˆ¶åˆ°10,000æ¬¡&#x2F;åˆ†é’Ÿ</span><br><span class="line">        location &#x2F;static&#x2F; &#123;</span><br><span class="line">            waf_cc_deny rate&#x3D;10000r&#x2F;m duration&#x3D;1h zone&#x3D;waf:cc_static;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        # å°†åŠ¨æ€èµ„æºçš„è¯·æ±‚é€Ÿç‡é™åˆ¶åˆ°2,000æ¬¡&#x2F;åˆ†é’Ÿ</span><br><span class="line">        location &#x2F;dynamic&#x2F; &#123;</span><br><span class="line">            waf_cc_deny rate&#x3D;2000r&#x2F;m duration&#x3D;1h zone&#x3D;waf:cc_dynamic;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>[2] å¼€å¯éªŒè¯ç <ul><li><a href="https://www.hcaptcha.com/" target="_blank" rel="noopener">hCaptcha</a></li><li><a href="https://developers.google.com/recaptcha" target="_blank" rel="noopener">reCAPTCHAv2</a></li><li><a href="https://developers.google.com/recaptcha" target="_blank" rel="noopener">reCAPTCHAv3</a></li></ul></li></ul><p>å½“ä½ çš„ç«™ç‚¹å—åˆ° <code>CC</code> æ”»å‡»æ—¶å¼€å¯éªŒè¯ç æ˜¯ä¸é”™çš„é€‰æ‹©ï¼Œå› ä¸ºéªŒè¯ç å¯ä»¥å¸®åŠ©ä½ è¿›è¡Œäººæœºè¯†åˆ«ã€‚æœ¬æ¨¡å—ç›®å‰æ”¯æŒä¸‰ç§éªŒè¯ç ï¼Œä½ åº”è¯¥é€‰æ‹©ä¸€ä¸ªå¹¶ä»å…¶ç½‘ç«™ä¸Šç”³è¯·åˆ° <code>Sitekey</code> å’Œ <code>Secret</code>ã€‚é…ç½®å®Œæˆä¹‹åï¼Œé‡å¯ <code>nginx</code> æœåŠ¡ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># æ•´ä¸ªç«™ç‚¹å¼€å¯éªŒè¯ç </span><br><span class="line">server &#123;</span><br><span class="line">    waf_captcha on prov&#x3D;hCaptcha secret&#x3D;your_secret sitekey&#x3D;your_sitekey;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># ä¸ºæŸä¸ªè·¯å¾„å¼€å¯éªŒè¯ç </span><br><span class="line">location &#123;</span><br><span class="line">    waf_captcha on prov&#x3D;hCaptcha secret&#x3D;your_secret sitekey&#x3D;your_sitekey;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># å½“è®¿é—®é¢‘ç‡è¿‡é«˜æ—¶å¼€å¯éªŒè¯ç </span><br><span class="line">http &#123;</span><br><span class="line">    waf_zone name&#x3D;waf size&#x3D;20m;</span><br><span class="line">    server &#123;</span><br><span class="line">        waf_cc_deny on rate&#x3D;1000r&#x2F;m duration&#x3D;1h zone&#x3D;waf:cc;</span><br><span class="line">        waf_captcha off prov&#x3D;hCaptcha secret&#x3D;your_secret sitekey&#x3D;your_sitekey;</span><br><span class="line">        waf_action cc_deny&#x3D;CAPTCHA zone&#x3D;waf:action;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>[3] æ‹¦æˆªè¯·æ±‚æ—¶å¯ç”¨éªŒè¯ç </strong></li></ul><p>å¦‚ä»Šï¼Œè®¸å¤šæ”»å‡»è€…éƒ½ä¼šä½¿ç”¨è‡ªåŠ¨å·¥å…·æ”»å‡»æœåŠ¡å™¨ï¼Œè¿™äº›è‡ªåŠ¨å·¥å…·ä¼šå°è¯•æ¯ä¸€ä¸ªæ¼æ´ï¼Œæœ‰çš„ä¼šè¢«å®‰å…¨æªæ–½æ‰€æ‹¦æˆªï¼Œæœ‰çš„åˆ™å¯ä»¥èº²é¿æ£€æµ‹ã€‚ å¦‚æœæ”»å‡»è€…è§‰å¾—ä½ çš„ä»·å€¼æ¯”è¾ƒé«˜ï¼Œå¯èƒ½ä¼šæ‰‹åŠ¨æ”»å‡»ä½ çš„æœåŠ¡ã€‚æˆ‘ä»¬å¹¶ä¸èƒ½å®Œç¾åœ°é˜²å¾¡è¿™äº›æ”»å‡»ï¼Œä½†å´èƒ½å¾ˆç®€å•åœ°æé«˜æ”»å‡»çš„æˆæœ¬ã€‚</p><p>å½“ä¸€ä¸ªè¯·æ±‚è¢«æ‹¦æˆªæ—¶ï¼Œ<code>ngx_waf</code> ä¼šå¯¹è¯¥ <code>IP</code> å¯ç”¨éªŒè¯ç ï¼Œæ­¤æ—¶è¯¥ <code>IP</code> æƒ³è¦ç»§ç»­è®¿é—®å°±å¿…é¡»å®ŒæˆéªŒè¯ç ã€‚è¿™åŸºæœ¬å¯ä»¥åºŸæ‰å¤šæ•°çš„è‡ªåŠ¨æ”»å‡»å·¥å…·ï¼Œå› ä¸ºè¿™äº›å·¥å…·ä¼šå°è¯•æ¯ä¸€ä¸ªæ¼æ´ï¼Œè€Œæˆ‘ä»¬æ€»èƒ½è¯†åˆ«ä¸€äº›æ˜æ˜¾çš„æ”»å‡»è¯·æ±‚å¹¶å¯ç”¨éªŒè¯ç ï¼Œè€Œè‡ªåŠ¨å·¥å…·æ—¶éš¾ä»¥é€šè¿‡éªŒè¯çš„ã€‚å¯¹äºæ‰‹åŠ¨æ”»å‡»è€…ï¼Œè¿™ä¹Ÿèƒ½æé«˜ä»–ä»¬çš„æ—¶é—´æˆæœ¬ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">    waf_zone name&#x3D;waf size&#x3D;20m;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        waf_captcha off prov&#x3D;xxx sitekey&#x3D;xxx secret&#x3D;xxx;</span><br><span class="line">        waf_action blacklist&#x3D;CAPTCHA zone&#x3D;waf:action;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>[4] è¢«æ”»å‡»æ—¶é™ä½å¸¦å®½å ç”¨</strong></li></ul><p>å½“ä½ å—åˆ° <code>CC</code> æ”»å‡»æ—¶ï¼Œæ”»å‡»è€…çš„ <code>IP</code> å·²ç»è¢« <code>CC</code> é˜²æŠ¤æ‹‰é»‘ï¼Œä½†æ˜¯ä½ çš„ä¸Šä¸‹è¡Œå¸¦å®½ä¾ç„¶å¾ˆé«˜ï¼Œ è¿™æ˜¯å› ä¸º <code>CC</code> é˜²æŠ¤ä¼šè¿”å›ä¸€ä¸ª <code>503</code> çŠ¶æ€ç ï¼Œå› æ­¤å ç”¨äº†ä½ çš„å¸¦å®½ï¼Œä½ å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„é…ç½®æ¥é™ä½å¸¦å®½å ç”¨ã€‚</p><p><code>444</code> çŠ¶æ€ç æ˜¯ <code>nginx </code>å®šä¹‰çš„ä¸€ä¸ªéæ ‡å‡†çš„ <code>HTTP</code> çŠ¶æ€ç ï¼Œå…¶ä½œç”¨å°±æ˜¯ç›´æ¥å…³é—­è¿æ¥ï¼Œä¸å†å‘é€ä»»ä½•æ•°æ®ã€‚å¦‚æœä½ ä½¿ç”¨äº† <code>444</code> çŠ¶æ€ç ï¼Œé‚£ä¹ˆåœ¨ç”¨æˆ·çœ‹æ¥ä½ çš„ç½‘ç«™å°±åƒæ˜¯ä¸å­˜åœ¨ä¸€æ ·ã€‚è¿™æ˜¯å› ä¸ºç½‘ç«™å‡ºé”™ä¸€èˆ¬éƒ½ä¼šæœ‰ <code>HTTP</code> çŠ¶æ€ç ç”¨æ¥æç¤ºé”™è¯¯ï¼Œ å¦‚æœè®¿é—®ä¸€ä¸ªç½‘ç«™è¿é”™è¯¯æç¤ºéƒ½æ²¡æœ‰ï¼Œé‚£ä¹ˆå¤§æ¦‚ç‡æ˜¯è¿™ä¸ªç½‘ç«™ä¸å­˜åœ¨ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># LTS</span><br><span class="line">waf_http_status cc_deny&#x3D;444;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># Current</span><br><span class="line">waf_action cc_deny&#x3D;444;</span><br></pre></td></tr></table></figure><ul><li><strong>[5] æŠµå¾¡åˆ†å¸ƒå¼ CC æ”»å‡»</strong></li></ul><p><code>CC</code> æ”»å‡»(<code>HTTP</code> æ´ªæ°´)æ˜¯æŒ‡å‘é€å¤§é‡çš„ <code>HTTP</code> è¯·æ±‚æ¥è€—å°½æœåŠ¡å™¨çš„èµ„æºã€‚å¦‚æœæ”»å‡»è€…ä½¿ç”¨çš„ <code>IP</code> è¾ƒå°‘åˆ™é˜²å¾¡è¾ƒä¸ºç®€å•ï¼Œå› ä¸ºåªéœ€è¦é™åˆ¶ <code>IP</code> çš„è¯·æ±‚é¢‘ç‡ï¼Œä½†æ˜¯å¦‚æœæ”»å‡»è€…ä½¿ç”¨å¤§é‡çš„ <code>IP</code> è¿›è¡Œæ”»å‡»ï¼Œä»…ä»…é™åˆ¶ <code>IP</code> çš„è¯·æ±‚é¢‘ç‡æ˜¯æ— æµäºäº‹çš„ã€‚è¿™ç§ä½¿ç”¨å¤§é‡ <code>IP</code> è¿›è¡Œ <code>CC</code> æ”»å‡»çš„æ–¹å¼ç§°ä¸ºåˆ†å¸ƒå¼ <code>CC</code> æ”»å‡»æˆ–åˆ†å¸ƒå¼ <code>HTTP</code> æ´ªæ°´ã€‚</p><p>æœ¬æ¨¡å—æä¾›äº†ä¸€äº›ç¼“è§£æ–¹å¼ï¼Œç¬¬ä¸€ç§å¼€å¯éªŒè¯ç æ¥ç¼“è§£ï¼Œç¬¬äºŒç§ä½¿ç”¨é™ä½å¸¦å®½å ç”¨ï¼Œç¬¬ä¸‰ç§ä½¿ç”¨äº”ç§’ç›¾æ¥ç¼“è§£ã€‚ä½ å¯èƒ½å¬è¯´è¿‡ <code>Cloudflare</code> çš„äº”ç§’ç›¾ï¼Œæœ¬æ¨¡å—çš„äº”ç§’ç›¾å’Œ <code>Cloudflare</code> çš„å®Œå…¨ä¸åŒã€‚å®ƒçš„åŠŸèƒ½æ˜¯æ£€æµ‹å®¢æˆ·ç«¯æ˜¯å¦èƒ½å¤Ÿæ­£ç¡®åœ°æ”¯æŒ <code>Cookie</code>ï¼Œæ¯”å¦‚å‘é€ <code>Cookie</code> å’Œæ­£ç¡®åœ°å¤„ç† <code>Set-Cookie</code> å“åº”å¤´ã€‚ä½ å¯ä»¥ä»æœ¬é¡¹ç›®çš„ <code>assets/</code> ç›®å½•ä¸‹æ‰¾åˆ° <code>under-attack.html</code> å¹¶å°†å…¶æ‹·è´åˆ°æŸä¸ªè·¯å¾„ä¸‹ï¼Œç„¶åé€šè¿‡ä¿®æ”¹ <code>nginx</code> çš„é…ç½®æ–‡ä»¶æ¥å¼€å¯äº”ç§’ç›¾ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># LTS</span><br><span class="line"></span><br><span class="line"># ä¸ºæ•´ä¸ªç½‘ç«™å¼€å¯äº”ç§’ç›¾</span><br><span class="line">server &#123;</span><br><span class="line">    waf_under_attack on file&#x3D;&#x2F;path&#x2F;to&#x2F;under_attack.html;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># ä¸ºæŸä¸ªè·¯å¾„å¼€å¯äº”ç§’ç›¾</span><br><span class="line">location &#x2F;path &#123;</span><br><span class="line">    waf_under_attack on file&#x3D;&#x2F;path&#x2F;to&#x2F;under_attack.html;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># Current</span><br><span class="line"></span><br><span class="line"># ä¸ºæ•´ä¸ªç½‘ç«™å¼€å¯äº”ç§’ç›¾</span><br><span class="line">server &#123;</span><br><span class="line">    waf_under_attack on;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># ä¸ºæŸä¸ªè·¯å¾„å¼€å¯äº”ç§’ç›¾</span><br><span class="line">location &#x2F;path &#123;</span><br><span class="line">    waf_under_attack on;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="æ•ˆæœæµ‹è¯•">æ•ˆæœæµ‹è¯•</span></h2><blockquote><p><strong>å¦‚éœ€æ›´å¤šå¸®åŠ©ï¼Œå¯ä»¥å‚è€ƒ <a href="https://docs.addesp.com/ngx_waf/zh-cn/guide/test.html#%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95" target="_blank" rel="noopener">å¦‚ä½•æµ‹è¯•</a>ï¼</strong></p></blockquote><p>å½“æˆ‘ä»¬éƒ¨ç½²å’Œé…ç½®æœåŠ¡å®Œæˆä¹‹åï¼Œéœ€è¦æµ‹è¯•ä¸‹é˜²ç«å¢™æ˜¯å¦æ­£å¸¸èµ·ä½œç”¨äº†ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼è¿›è¡Œç®€å•çš„æµ‹è¯•æ¥åˆ¤æ–­è§„åˆ™æ˜¯å¦æ­£å¸¸è¿è¡Œã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"># æµ‹è¯•æ—¶çš„é…ç½®</span><br><span class="line">master_process on;</span><br><span class="line">worker_processes  1;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen 80;</span><br><span class="line">        server_name  localhost;</span><br><span class="line"></span><br><span class="line">        access_log off;</span><br><span class="line"></span><br><span class="line">        waf on;</span><br><span class="line">        waf_mode DYNAMIC !CC !POST;</span><br><span class="line">        waf_rule_path &#x2F;usr&#x2F;local&#x2F;src&#x2F;ngx_waf&#x2F;rules&#x2F;;</span><br><span class="line">        waf_cache capacity&#x3D;6000 interval&#x3D;1h percent&#x3D;50;</span><br><span class="line"></span><br><span class="line">        location &#x2F; &#123;</span><br><span class="line">            default_type text&#x2F;html;</span><br><span class="line">            return 200 &#39;hello&#39;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>[1] ç®€æ˜“æµ‹è¯•<ul><li>è¿è¡Œä¸‹åˆ—å‘½ä»¤ï¼Œå¦‚æœè¾“å‡º <code>403</code> åˆ™è¡¨ç¤ºæ¨¡å—æ­£å¸¸å·¥ä½œ</li></ul></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ curl -I -o /dev/null --user-agent bench \</span><br><span class="line">    -s -w <span class="string">"%&#123;http_code&#125;\\n"</span> https://example.com</span><br></pre></td></tr></table></figure><ul><li>[2] è‡ªåŠ¨æµ‹è¯•<ul><li>é¡¹ç›®é™„å¸¦äº†è®¸å¤šæµ‹è¯•ç”¨ä¾‹ï¼Œä½ å¯ä»¥é€šè¿‡ä¸‹é¢çš„æŒ‡ä»¤æ¥è¿è¡Œå…¨éƒ¨çš„ç”¨ä¾‹</li></ul></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¿™è¡Œå‘½ä»¤çš„æ‰§è¡Œæ—¶é—´æ¯”è¾ƒé•¿</span></span><br><span class="line">$ cpan Test::Nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¦‚æœç›®å½•å·²ç»å­˜åœ¨åˆ™ä¼šå…ˆåˆ é™¤å†åˆ›å»º</span></span><br><span class="line">$ <span class="built_in">export</span> MODULE_TEST_PATH=/path/to/temp/dir</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¦‚æœä½ å®‰è£…äº†åŠ¨æ€æ¨¡å—åˆ™éœ€è¦æŒ‡å®šåŠ¨æ€æ¨¡å—çš„ç»å¯¹è·¯å¾„ï¼Œåä¹‹åˆ™æ— éœ€æ‰§è¡Œè¿™è¡Œå‘½ä»¤</span></span><br><span class="line">$ <span class="built_in">export</span> MODULE_PATH=/path/to/ngx_http_waf_module.so</span><br><span class="line"></span><br><span class="line"><span class="comment"># è‡ªåŠ¨åŒ–æµ‹è¯•</span></span><br><span class="line">$ <span class="built_in">cd</span> ./<span class="built_in">test</span>/<span class="built_in">test</span>-nginx</span><br><span class="line">$ sh ./init.sh</span><br><span class="line">$ sh ./start.sh ./t/*.t</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¯ä»¥ä½¿ç”¨WRKå·¥å…·æµ‹è¯•</span></span><br><span class="line">$ wrk -c 100 -d 30m -t 1 -s <span class="built_in">test</span>/wrk/rand.lua --latency \</span><br><span class="line">    http://localhost/ -- /path/to/rand-str.txt</span><br></pre></td></tr></table></figure><h2><span id="æ³¨æ„äº‹é¡¹">æ³¨æ„äº‹é¡¹</span></h2><blockquote><p><strong>å¦‚éœ€æ›´å¤šå¸®åŠ©ï¼Œå¯ä»¥å‚è€ƒ <a href="https://docs.addesp.com/ngx_waf/zh-cn/guide/faq.html" target="_blank" rel="noopener">å¸¸è§é—®é¢˜ä¸è§£ç­”</a>ï¼</strong></p></blockquote><p>æœ¬æ¨¡å—åªä¿è¯å¯¹ <code>nginx-1.18.0</code> æˆ–æ›´æ–°çš„ç‰ˆæœ¬çš„å…¼å®¹æ€§ï¼Œä¸”ä¸ä¿è¯ä¸ <code>Linux</code> ä»¥å¤–çš„æ“ä½œç³»ç»Ÿçš„å…¼å®¹æ€§ã€‚è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ¨¡å—ä¸ <a href="https://nginx.org/en/docs/http/ngx_http_rewrite_module.html" target="_blank" rel="noopener">ngx_http_rewrite_module</a> å­˜åœ¨å…¼å®¹æ€§é—®é¢˜ã€‚</p><ul><li>å½“ <code>return</code> æŒ‡ä»¤ç”Ÿæ•ˆæ—¶ï¼Œè¯¥æ¨¡å—ä¸ä¼šç”Ÿæ•ˆ</li><li>å½“ <code>rewrite</code> æŒ‡ä»¤é€ æˆäº†è¿”å›(å¦‚ <code>302</code> é‡å®šå‘)æ—¶ï¼Œè¯¥æ¨¡å—ä¸ä¼šç”Ÿæ•ˆ</li><li>æ‰€ä»¥å¯ä»¥ä½¿ç”¨ <a href="https://nginx.org/en/docs/http/ngx_http_core_module.html#try_files" target="_blank" rel="noopener"><code>try_files</code></a> ä»£æ›¿ <a href="https://nginx.org/en/docs/http/ngx_http_rewrite_module.html#rewrite" target="_blank" rel="noopener"><code>rewrite</code></a> æŒ‡ä»¤ï¼Œé¿å…ä¸Šè¿°é—®é¢˜çš„å‡ºç°</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># rewrite</span><br><span class="line">if (!-e $request_filename) &#123;</span><br><span class="line">    rewrite (.*) &#x2F;index.php</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># try_files</span><br><span class="line">try_files $uri $uri&#x2F; &#x2F;index.php;</span><br></pre></td></tr></table></figure><h2><span id="å‚è€ƒé“¾æ¥">å‚è€ƒé“¾æ¥</span></h2><ul><li><a href="https://github.com/ADD-SP/ngx_waf" target="_blank" rel="noopener">Github ä»£ç ä»“åº“</a></li><li><a href="https://docs.addesp.com/ngx_waf/zh-cn/advance/rule.html" target="_blank" rel="noopener">é»‘ç™½åå•è§„åˆ™è¯´æ˜</a></li><li><a href="https://docs.addesp.com/ngx_waf/zh-cn/advance/priority.html" target="_blank" rel="noopener">æ£€æµ‹é¡¹ç›®è§„åˆ™ä¼˜å…ˆçº§</a></li><li><a href="https://docs.addesp.com/ngx_waf/zh-cn/advance/variable.html" target="_blank" rel="noopener">æ¨¡å—çš„å†…ç½®å˜é‡</a></li><li><a href="https://docs.addesp.com/ngx_waf/zh-cn/advance/log.html" target="_blank" rel="noopener">æ—¥å¿—ç›¸å…³çš„é…ç½®è¯´æ˜</a></li></ul><blockquote><p>æœ¬æ–‡è½¬è½½è‡ªï¼šã€Œ Escape çš„åšå®¢ ã€ï¼ŒåŸæ–‡ï¼š<a href="https://tinyurl.com/2p979waj" target="_blank" rel="noopener">https://tinyurl.com/2p979waj</a> ï¼Œç‰ˆæƒå½’åŸä½œè€…æ‰€æœ‰ã€‚æ¬¢è¿æŠ•ç¨¿ï¼ŒæŠ•ç¨¿é‚®ç®±: <a href="mailto:editor@hi-linux.com">editor@hi-linux.com</a>ã€‚</p></blockquote></div><script src="https://my.openwrite.cn/js/readmore.js" type="text/javascript"></script><script>var isMobile = navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i);if (!isMobile) {    var btw = new BTWPlugin();    btw.init({        "id": "vip-container",        "blogId": "10135-1588830050631-449",        "name": "ã€Œå¥‡å¦™çš„ Linux ä¸–ç•Œã€",        "qrcode": "https://www.hi-linux.com/img/wechat/mp_qrcode_12.jpg",        "keyword": "VIP"    });}</script>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;ngx_wafï¼šæ–¹ä¾¿ä¸”é«˜æ€§èƒ½çš„ Nginx é˜²ç«å¢™æ¨¡å—&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;ç¼“å­˜ç­–ç•¥ä¸º &lt;code&gt;LRU&lt;/code&gt;ï¼Œ&lt;code&gt;IP&lt;/code&gt; æ£€æŸ¥å’Œ &lt;code&gt;CC&lt;/code&gt; é˜²å¾¡èŠ±è´¹å¸¸æ•°æ—¶é—´ï¼Œå…¶å®ƒçš„æ£€æŸ¥èŠ±è´¹ &lt;code&gt;O(nm)&lt;/code&gt; çš„æ—¶é—´ï¼Œå…¶ä¸­ &lt;code&gt;n&lt;/code&gt; æ˜¯ç›¸å…³è§„åˆ™çš„æ¡æ•°ï¼Œ&lt;code&gt;m&lt;/code&gt; ä¸ºæ‰§è¡Œæ­£åˆ™åŒ¹é…çš„æ—¶é—´å¤æ‚åº¦ï¼Œä½†æ˜¯æ¯æ¬¡æ£€æŸ¥è¿‡åä¼šè‡ªåŠ¨ç¼“å­˜æœ¬æ¬¡æ£€æŸ¥çš„ç»“æœï¼Œä¸‹æ¬¡æ£€æŸ¥ç›¸åŒçš„ç›®æ ‡æ—¶å°±å¯ä»¥ä½¿ç”¨ç¼“å­˜è€Œä¸æ˜¯æ£€æŸ¥å…¨éƒ¨çš„è§„åˆ™ã€‚ä¸ä¼šç¼“å­˜ &lt;code&gt;POST&lt;/code&gt; è¯·æ±‚ä½“çš„æ£€æŸ¥ç»“æœã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Nginx" scheme="https://www.hi-linux.com/categories/nginx/"/>
    
    
      <category term="Linux" scheme="https://www.hi-linux.com/tags/Linux/"/>
    
      <category term="Nginx" scheme="https://www.hi-linux.com/tags/Nginx/"/>
    
      <category term="å®‰å…¨" scheme="https://www.hi-linux.com/tags/%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>è¶…ç»™åŠ›ï¼Œ100+ äº’è”ç½‘å¤§å‚äº§å“å¼€æºä»£ç åˆé›†ï¼</title>
    <link href="https://www.hi-linux.com/posts/56314.html"/>
    <id>https://www.hi-linux.com/posts/56314.html</id>
    <published>2022-01-28T01:00:00.000Z</published>
    <updated>2022-02-09T03:03:37.728Z</updated>
    
    <content type="html"><![CDATA[<div id="vip-container"><p>å­¦ä¹ äº’è”ç½‘å¤§å‚äº§å“çš„æºç æ˜¯éå¸¸å¥½æé«˜è‡ªèº«æŠ€æœ¯æ°´å¹³çš„æ–¹æ³•ï¼Œä½†æ˜¯é—®é¢˜æ¥äº†ï¼Œæºç ä¸ä¸€å®šå¼€æºå•Šï¼Œæƒ³å­¦ä¹Ÿæ²¡åŠæ³•ã€‚ä½†æ˜¯å°±æ˜¯æœ‰è¿™æ ·ä¸€äº›æŠ€æœ¯å¤§ç‰›ï¼Œé€šè¿‡ç ”ç©¶å¤§å‚çš„äº§å“ï¼Œå¼€æºå‡ºæ¥äº†å„ç§å…‹éš†çš„å®ç°ã€‚</p><p>ä»Šå¤©è¦æ¨èçš„å¼€æºé¡¹ç›®æ˜¯ <code>Clone-Wars</code>ï¼Œæ”¶é›†äº† 100+ äº’è”ç½‘å¤§å‚äº§å“çš„å¼€æºå®ç°ï¼ŒåŒ…æ‹¬ <code>Airbnb</code>ã€<code>Amazon</code>ã€<code>Instagram</code>ã€<code>Netflix</code>ã€<code>Tiktok</code>ã€<code>Spotify</code>ã€<code>Whatsapp</code>ã€<code>Youtube</code> ç­‰éå¸¸å¤šï¼Œå…¶ä¸­å†…å®¹åŒ…å«äº†æºç ã€Demo é“¾æ¥ã€æŠ€æœ¯æ ˆä»‹ç»ç­‰ã€‚æœ‰ä¸€è¯´ä¸€ï¼Œè¿™ä¸ªçœŸçš„å¤ªå…¨äº†ï¼Œéƒ¨åˆ†äº§å“è¿˜è‡ªå¸¦æ•™å­¦è§†é¢‘ã€‚</p><p><img src="https://img.hi-linux.com/staticfile/og-2021-07-15-3ikq76.png" alt></p><a id="more"></a><p>ä»¥ä¸‹æ˜¯éƒ¨åˆ†æ¯”è¾ƒè‘—åçš„ç½‘ç«™å®ç°ï¼š</p><p><img src="https://img.hi-linux.com/staticfile/image-20210715160217277-2021-07-15-rSLbMK.png" alt></p><p>å¾ˆå¤šäº§å“è¿˜ä¸åªä¸€ä¸ªå¼€æºçš„å…‹éš†å®ç°å‘¢ã€‚</p><p><img src="https://img.hi-linux.com/staticfile/image-20210715160423005-2021-07-15-OqJHWD.png" alt></p><p>æˆ‘ä»¬æ¥çœ‹ä¸‹å…¶ä¸­ä¸€ä¸ª HackerNews çš„å¼€æºå…‹éš†å®ç°ï¼Œä½œè€…è¿˜åšäº†éƒ¨åˆ†çš„é‡æ–°è®¾è®¡ï¼Œçœ‹ä¸Šå»è¦æ¯”åŸç‰ˆè§†è§‰æ•ˆæœè¦å¥½ä¸€ç‚¹ã€‚</p><p><img src="https://img.hi-linux.com/staticfile/image-20210715160536681-2021-07-15-js5y1j.png" alt></p><p>æ›´å¤šé¡¹ç›®è¯¦æƒ…è¯·æŸ¥çœ‹é¡¹ç›®åœ°å€ï¼š<a href="https://github.com/GorvGoyl/Clone-Wars" target="_blank" rel="noopener">https://github.com/GorvGoyl/Clone-Wars</a></p><blockquote><p>æœ¬æ–‡è½¬è½½è‡ªï¼šã€Œ GitHub ç²¾é€‰ ã€ï¼ŒåŸæ–‡ï¼š<a href="https://tinyurl.com/4f7crwf4" target="_blank" rel="noopener">https://tinyurl.com/4f7crwf4</a> ï¼Œç‰ˆæƒå½’åŸä½œè€…æ‰€æœ‰ã€‚æ¬¢è¿æŠ•ç¨¿ï¼ŒæŠ•ç¨¿é‚®ç®±: <a href="mailto:editor@hi-linux.com">editor@hi-linux.com</a>ã€‚</p></blockquote></div><script src="https://my.openwrite.cn/js/readmore.js" type="text/javascript"></script><script>var isMobile = navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i);if (!isMobile) {    var btw = new BTWPlugin();    btw.init({        "id": "vip-container",        "blogId": "10135-1588830050631-449",        "name": "ã€Œå¥‡å¦™çš„ Linux ä¸–ç•Œã€",        "qrcode": "https://www.hi-linux.com/img/wechat/mp_qrcode_12.jpg",        "keyword": "VIP"    });}</script>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å­¦ä¹ äº’è”ç½‘å¤§å‚äº§å“çš„æºç æ˜¯éå¸¸å¥½æé«˜è‡ªèº«æŠ€æœ¯æ°´å¹³çš„æ–¹æ³•ï¼Œä½†æ˜¯é—®é¢˜æ¥äº†ï¼Œæºç ä¸ä¸€å®šå¼€æºå•Šï¼Œæƒ³å­¦ä¹Ÿæ²¡åŠæ³•ã€‚ä½†æ˜¯å°±æ˜¯æœ‰è¿™æ ·ä¸€äº›æŠ€æœ¯å¤§ç‰›ï¼Œé€šè¿‡ç ”ç©¶å¤§å‚çš„äº§å“ï¼Œå¼€æºå‡ºæ¥äº†å„ç§å…‹éš†çš„å®ç°ã€‚&lt;/p&gt;
&lt;p&gt;ä»Šå¤©è¦æ¨èçš„å¼€æºé¡¹ç›®æ˜¯ &lt;code&gt;Clone-Wars&lt;/code&gt;ï¼Œæ”¶é›†äº† 100+ äº’è”ç½‘å¤§å‚äº§å“çš„å¼€æºå®ç°ï¼ŒåŒ…æ‹¬ &lt;code&gt;Airbnb&lt;/code&gt;ã€&lt;code&gt;Amazon&lt;/code&gt;ã€&lt;code&gt;Instagram&lt;/code&gt;ã€&lt;code&gt;Netflix&lt;/code&gt;ã€&lt;code&gt;Tiktok&lt;/code&gt;ã€&lt;code&gt;Spotify&lt;/code&gt;ã€&lt;code&gt;Whatsapp&lt;/code&gt;ã€&lt;code&gt;Youtube&lt;/code&gt; ç­‰éå¸¸å¤šï¼Œå…¶ä¸­å†…å®¹åŒ…å«äº†æºç ã€Demo é“¾æ¥ã€æŠ€æœ¯æ ˆä»‹ç»ç­‰ã€‚æœ‰ä¸€è¯´ä¸€ï¼Œè¿™ä¸ªçœŸçš„å¤ªå…¨äº†ï¼Œéƒ¨åˆ†äº§å“è¿˜è‡ªå¸¦æ•™å­¦è§†é¢‘ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://img.hi-linux.com/staticfile/og-2021-07-15-3ikq76.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
    
    </summary>
    
    
      <category term="å¼€æº" scheme="https://www.hi-linux.com/categories/%E5%BC%80%E6%BA%90/"/>
    
    
      <category term="Linux" scheme="https://www.hi-linux.com/tags/Linux/"/>
    
      <category term="å¼€æº" scheme="https://www.hi-linux.com/tags/%E5%BC%80%E6%BA%90/"/>
    
      <category term="ç¨‹åºå‘˜" scheme="https://www.hi-linux.com/tags/%E7%A8%8B%E5%BA%8F%E5%91%98/"/>
    
  </entry>
  
  <entry>
    <title>WireGuard ä¸­æ–‡æ•™ç¨‹ï¼šä½¿ç”¨ Netmaker å¿«é€Ÿç»„å»º WireGuard å…¨äº’è” (Full Mesh) ç½‘ç»œ</title>
    <link href="https://www.hi-linux.com/posts/40657.html"/>
    <id>https://www.hi-linux.com/posts/40657.html</id>
    <published>2022-01-14T01:00:00.000Z</published>
    <updated>2022-01-14T01:27:32.617Z</updated>
    
    <content type="html"><![CDATA[<div id="vip-container"><h2><span id="ä»€ä¹ˆæ˜¯-netmaker">ä»€ä¹ˆæ˜¯ Netmaker</span></h2><p><a href="https://github.com/gravitl/netmaker" target="_blank" rel="noopener">Netmaker</a> æ˜¯ä¸€ä¸ªå¼€æºçš„ã€åŸºäº [[WireGuard]] çš„ç½‘ç»œï¼ˆoverlay network) æ§åˆ¶å·¥å…·ï¼Œå¯ä»¥éå¸¸å¿«é€Ÿçš„ç”¨æ¥ç»„å»º WireGuard ç½‘ç»œã€‚</p><p>å¦‚æœä½ æœ‰ä¸¤å°è¿æ¥äº’è”ç½‘çš„è®¾å¤‡ï¼Œé‚£ä¹ˆ Netmaker å¯ä»¥ç»„å»ºä¸€ä¸ªå®‰å…¨çš„ç½‘ç»œï¼Œå¹¶æ‰“é€šä¸€ä¸ªå®‰å…¨çš„éš§é“æä¾›ç»™ä¸¤å°æœºå™¨é€šä¿¡ã€‚è€Œå¦‚æœä½ æœ‰æ•°åƒå°æœºå™¨åˆ†å¸ƒåœ¨ä¸åŒçš„åœ°åŒºï¼Œä¸åŒçš„æ•°æ®ä¸­å¿ƒï¼Œä¸åŒçš„ç½‘ç»œä¸­ï¼Œé‚£ä¹ˆ Netmaker ä¹Ÿå¯ä»¥ç»„å»ºä¸€ä¸ªç½‘ç»œæ¥æä¾›ç»™è¿™äº›ä¸åŒçš„èŠ‚ç‚¹é€šä¿¡ã€‚</p><p>å¦‚æœç†Ÿæ‚‰ AWSï¼Œé‚£ä¹ˆ Netmaker å°±åƒ VPC ä¸€æ ·ï¼Œä¸è¿‡ Netmaker å¯ä»¥åº”ç”¨åœ¨ä»»æ„çš„æœºå™¨ä¸­ã€‚ä» Netmaker ç½‘ç»œä¸­çš„æœºå™¨æ¥çœ‹ï¼ŒåŒä¸€ä¸ªç½‘ç»œä¸­çš„æœºå™¨å°½ç®¡åœ¨ä¸–ç•Œå„åœ°ï¼Œä½†å…¶ç›¸äº’é€šä¿¡å°±åƒæ˜¯åœ¨åŒä¸€ä¸ªå±€åŸŸç½‘ä¸­ä¸€æ ·ã€‚</p><a id="more"></a><p>Netmaker å’Œå…¶ä»–ä¸€äº›äº§å“éå¸¸ç›¸ä¼¼ï¼Œæ¯”å¦‚ [[Tailscale]], [[ZeroTier]]ï¼Œ[[Nebula]] ä½†ä¸åŒäºè¿™äº›äº§å“çš„æ˜¯ï¼ŒNetmaker è¿æ¥æ›´å¿«ï¼Œæ›´åŠ çµæ´»ã€‚Netmaker ä½¿ç”¨ [[WireGuard]] æ‰€ä»¥æ›´å¿«ï¼ŒNetmaker ä¸­çš„èŠ‚ç‚¹ä¸ç®¡æ˜¯æœåŠ¡ç«¯è¿˜æ˜¯Agentéƒ½å®Œå…¨å¯é…ç½®ï¼Œæ‰€ä»¥æä¾›äº†æ›´å¤§çš„çµæ´»æ€§ã€‚</p><p>Netmaker ä¼˜äº [[Tailscale]] çš„åœ°æ–¹è¿˜åœ¨äº ï¼ŒNetmaker ä¸éœ€è¦ Google, Microsoft æˆ–è€… GitHub è´¦å·ã€‚Netmaker å¯ä»¥è®¤ä¸ºæ˜¯ä¸€ä¸ªå¯ä»¥è‡ªè¡Œæ‰˜ç®¡çš„ Tailscaleã€‚</p><h2><span id="netmaker-å·¥ä½œåŸç†">Netmaker å·¥ä½œåŸç†</span></h2><p>Netmaker ä¾èµ–äº WireGuard æ¥åœ¨æœºå™¨é—´åˆ›å»ºéš§é“ï¼ˆtunnel), Netmaker é€šè¿‡ç®¡ç†ä¸åŒæœºå™¨çš„ WireGuard æ¥åˆ›å»ºç½‘ç»œã€‚ç®€å•æ¥è¯´ï¼ŒNetmaker å®ç° Client/Server æ¶æ„ï¼š</p><ul><li>the admin server ç®¡ç†ç«¯ï¼Œç§°ä¸º Netmakerï¼Œç®¡ç†ç½‘ç»œçš„ç•Œé¢</li><li>the agentï¼Œå®¢æˆ·ç«¯ï¼Œç§°ä¸º Netclientï¼Œå®¢æˆ·ç«¯é€šè¿‡ gRPC ä¸æœåŠ¡ç«¯é€šä¿¡</li></ul><p>ä½œä¸º Network ç®¡ç†ç«¯ï¼Œä½ å¯ä»¥é€šè¿‡ç®¡ç†ç«¯æ¥åˆ›å»ºç½‘ç»œï¼Œç®¡ç†è¿æ¥çš„è®¾å¤‡ã€‚æœåŠ¡ç«¯ä¼šä¿å­˜æ‰€æœ‰ç½‘ç»œå’Œè®¾å¤‡çš„é…ç½®ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯ä¼šè¢« netclient (agent) æ¥è·å–ä½¿ç”¨ã€‚</p><p>å®¢æˆ·ç«¯ï¼ˆnetclient) æ˜¯ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œnetclient ä¼šåœ¨èŠ‚ç‚¹è¢«æ·»åŠ åˆ°ç½‘ç»œä¸­çš„æ—¶å€™å®‰è£…åˆ°ä¸åŒçš„æœºå™¨ä¸­ï¼Œnetclient å¯ä»¥åœ¨å¤§å¤šæ•°ç³»ç»Ÿä¸­è¿è¡Œï¼Œä¸ç®¡æ˜¯è™šæ‹Ÿæœºï¼Œç‰©ç†æœºï¼Œæˆ–è€… IoT è®¾å¤‡éƒ½å¯ä»¥è¿è¡Œ netclientã€‚netclient ä¼šè¿æ¥æœåŠ¡ç«¯ï¼Œé€šè¿‡æœåŠ¡ç«¯çš„é…ç½®æ¥è‡ªåŠ¨ç®¡ç† WireGuardï¼ŒåŠ¨æ€æ›´æ–° Peersã€‚é€šè¿‡ä¸æ–­å‘ç½‘ç»œä¸­æ·»åŠ èŠ‚ç‚¹çš„æ–¹å¼ï¼Œå¯ä»¥åˆ›å»ºä¸€ä¸ªåŠ¨æ€çš„ï¼Œå®Œå…¨å¯ä»¥é…ç½®çš„è™šæ‹Ÿç½‘ç»œã€‚</p><p>Netmaker server ä¸ä¼šè·¯ç”±ç½‘ç»œæµé‡ï¼Œå¦åˆ™è¿™ä¸ªç½‘ç»œå°±å˜æˆäº†ä¸€ä¸ªä¸­å¿ƒè¾å°„æ¨¡å‹ï¼ˆhub-and-spoke modelï¼‰ï¼Œè¿™ä¼šä½¿å¾—ä¸­å¿ƒæœåŠ¡å™¨å˜æˆç“¶é¢ˆï¼Œå¹¶ä¸”æ‹–æ…¢ç½‘ç»œã€‚ç›¸åï¼ŒNetwork ä¼šå‘Šè¯‰ç½‘ç»œä¸­çš„èŠ‚ç‚¹ä»–ä»¬ä¹‹é—´å¯ä»¥ç›¸äº’ç›´æ¥é€šä¿¡ï¼Œè¿™è¢«ç§°ä¸º full mesh networkï¼ˆç½‘çŠ¶ç½‘ç»œï¼‰ï¼Œè¿™ä¼šè®©èŠ‚ç‚¹å’ŒèŠ‚ç‚¹çš„è¿æ¥æ›´å¿«ã€‚å³ä½¿ç®¡ç†ç«¯å®•æœºï¼Œåªè¦ç°å­˜çš„èŠ‚ç‚¹æ²¡æœ‰å˜åŒ–ï¼Œé‚£ä¹ˆè¿™ä¸ªç½‘ç»œä¾ç„¶å¯ä»¥æ­£å¸¸å·¥ä½œã€‚</p><h2><span id="åº”ç”¨åœºæ™¯-use-cases">åº”ç”¨åœºæ™¯ Use Cases</span></h2><p>Netmaker æœ‰éå¸¸å¤šçš„åº”ç”¨åœºæ™¯ï¼Œäº‹å®ä¸Šï¼Œç°åœ¨å¯èƒ½å°±å·²ç»åœ¨ä½¿ç”¨äº†ã€‚</p><p>ç”¨ä¾‹ï¼š</p><ul><li>è‡ªåŠ¨åˆ›å»º WireGuard mesh network</li><li>åœ¨äº‘ç¯å¢ƒå’Œæ•°æ®ä¸­å¿ƒä¹‹é—´åˆ›å»º flat, secure ç½‘ç»œ</li><li>ç»™ IoT è®¾å¤‡æä¾›æ›´å®‰å…¨çš„ç½‘ç»œè®¿é—®</li><li>å¢å¼ºå®¶åº­ï¼Œæˆ–åŠå…¬ç½‘ç»œçš„å®‰å…¨æ€§</li><li>åœ¨ç°å­˜ç½‘ç»œä¸Šå¢åŠ ä¸€å±‚åŠ å¯†</li><li>å®‰å…¨çš„ site-to-site è¿æ¥</li><li>ç®¡ç† cryptocurrency proof-of-stake æœºå™¨</li><li>åˆ›å»ºåŠ¨æ€çš„å®‰å…¨çš„ Kubernetes underlay network</li></ul><p>æ›´å¤šçš„ç”¨ä¾‹ä¹Ÿå¯ä»¥å‚è€ƒ<a href="https://docs.netmaker.org/usage.html" target="_blank" rel="noopener">å®˜ç½‘</a>ã€‚</p><h2><span id="æ¶æ„">æ¶æ„</span></h2><p><img src="https://img.hi-linux.com/staticfile/netmaker-architecture-20211212101049-2022-01-13-uWAKsc.png" alt="Netmaker çš„æ¶æ„å›¾"></p><h2><span id="æ¦‚å¿µ">æ¦‚å¿µ</span></h2><p>ç†Ÿæ‚‰ä¸€ä¸‹ Netmaker ä¸­å¸¸å¸¸è¢«æåˆ°çš„æ¦‚å¿µï¼Œæœ‰åŠ©äºç†è§£ã€‚</p><h3><span id="wireguard">WireGuard</span></h3><p>[[WireGuard]] ç›¸å¯¹æ¯”è¾ƒæ–°ï¼Œä½†éå¸¸å¼ºå¤§ï¼ŒWireGuard è¢«åŠ å…¥åˆ°äº† Linux kernelã€‚WireGuard å¯ä»¥éå¸¸ç®€å•å¿«é€Ÿåœ°åœ¨è®¾å¤‡ä¹‹é—´åˆ›å»ºåŠ å¯†é€šé“ã€‚ä» <a href="https://www.wireguard.com/" target="_blank" rel="noopener">WireGuard</a> å®˜ç½‘çš„ä»‹ç»ä¸­å¯ä»¥çœ‹åˆ°ï¼Œâ€œWireGuard å¯ä»¥è¢«è®¤ä¸ºæ˜¯å·¥ä¸šç•Œæœ€å®‰å…¨ï¼Œæœ€æ–¹ä¾¿ä½¿ç”¨ï¼Œæœ€ç®€å•çš„ VPN è§£å†³æ–¹æ¡ˆâ€ã€‚</p><p>ä¹‹å‰çš„è§£å†³æ–¹æ¡ˆï¼Œæ¯”å¦‚ OpenVPNï¼Œæˆ–è€… IPSec éƒ½è¢«è®¤ä¸ºåˆé‡åˆå¤æ‚ï¼Œå¹¶ä¸”æ€§èƒ½ä¹Ÿä¸æ˜¯å¾ˆå¥½ã€‚æ‰€æœ‰ç°å­˜çš„ VPN tunneling æ–¹æ¡ˆéƒ½ä¼šå¯¼è‡´ç½‘ç»œå»¶è¿Ÿå¢å¤§ã€‚WireGuard æ˜¯ç¬¬ä¸€ä¸ªå®ç°äº†å‡ ä¹æ¥è¿‘æœ‰çº¿è¿æ¥ç½‘ç»œé€Ÿåº¦çš„ VPNï¼Œå¯ä»¥çœ‹åˆ° WireGuard å¯¹ç°æœ‰ç½‘ç»œè¿æ¥å‡ ä¹æ²¡æœ‰å½±å“ã€‚éšç€ WireGuard çš„å‘å¸ƒï¼Œæ²¡æœ‰ä»»ä½•ç†ç”±å»ä½¿ç”¨å…¶ä»–éš§é“åŠ å¯†æŠ€æœ¯äº†ã€‚</p><h3><span id="mesh-network">Mesh Network</span></h3><p>å½“æåˆ° mesh network ï¼ˆç½‘çŠ¶ç½‘ç»œï¼‰çš„æ—¶å€™é€šå¸¸ä¹Ÿä¼šè¯´ ã€Œfull meshã€ã€‚ä¸€ä¸ª full <a href="https://www.bbc.co.uk/bitesize/guides/zr3yb82/revision/2" target="_blank" rel="noopener">mesh network</a> æŒ‡çš„æ˜¯ç½‘ç»œä¸­çš„ä»»ä½•èŠ‚ç‚¹éƒ½å¯ä»¥ç›¸äº’ç›´æ¥è¿æ¥ã€‚</p><p><img src="https://img.hi-linux.com/staticfile/full-mesh-network-20211212102133-2022-01-13-2gL9FB.png" alt></p><p>æ¯”å¦‚åœ¨è·¯ç”±å™¨åé¢çš„å®¶åº­ç½‘ç»œï¼Œæ‰€æœ‰çš„ç”µè„‘éƒ½ä¼šé€šè¿‡ç§æœ‰å±€åŸŸç½‘åœ°å€ç›¸äº’è¿æ¥ã€‚</p><p>Mesh network é€šå¸¸ä¼šå’Œ hub-and-spoke (ä¸­å¿ƒè¾å°„) ç½‘ç»œæ”¾åˆ°ä¸€èµ·å¯¹æ¯”ï¼Œä¸­å¿ƒè¾å°„çš„ç½‘ç»œä¸­ï¼Œä¸€ä¸ªèŠ‚ç‚¹å¿…é¡»é€šè¿‡ relay server æ‰èƒ½å’Œå¦å¤–ä¸€ä¸ªèŠ‚ç‚¹è¿›è¡Œé€šä¿¡ã€‚</p><p>åœ¨ä¸€äº›åœºæ™¯ä¸­ï¼Œä½ å¯ä»¥éœ€è¦éƒ¨åˆ†çš„ mesh networkï¼Œç½‘ç»œä¸­åªæœ‰éƒ¨åˆ†è®¾å¤‡éœ€è¦ç›¸äº’ç›´æ¥é€šä¿¡ï¼Œè€Œå…¶ä»–è®¾å¤‡éƒ½éœ€è¦å°†æµé‡è½¬å‘ç»™ä¸€ä¸ª relay/gateway ã€‚Netmaker åœ¨æŸäº›æ—¶å€™ä¹Ÿå¯ä»¥å®ç°è¿™ç±»æ¨¡å‹ã€‚åœ¨ç¬¬ä¸€å¼ å›¾ç‰‡ä¸­ï¼Œè¿™ä¸ªè®¾ç½®å°±æ˜¯ä¸€ä¸ªéƒ¨åˆ†çš„ mesh networkï¼Œå› ä¸ºèŠ‚ç‚¹A-D æ˜¯ç½‘çŠ¶ç½‘ç»œï¼Œè€Œå…¶ä»–çš„å®¢æˆ·ç«¯é€šè¿‡ gateway è¿æ¥ã€‚</p><p>Mesh networks é€šå¸¸æ¯”å…¶ä»–æ‹“æ‰‘çš„ç½‘ç»œæ›´å¿«ï¼Œä½†é€šå¸¸è®¾ç½®ä¹Ÿä¼šæ›´åŠ å¤æ‚ã€‚WireGuard æä¾›äº†åœ¨è®¾å¤‡ä¹‹é—´åˆ›å»ºåŠ å¯†éš§é“çš„æ–¹æ³•ï¼Œä½†æ˜¯å®ƒä¸æä¾›è®¾ç½®å®Œæ•´ç½‘ç»œçš„æ–¹æ³•ã€‚è¿™æ˜¯ Netmaker è¯ç”Ÿçš„ç†ç”±ã€‚</p><h3><span id="netmaker">Netmaker</span></h3><p>Netmaker æ˜¯ä¸€ä¸ªå»ºç«‹åœ¨ WireGuard ä¸Šçš„å¹³å°ï¼Œå…è®¸ç”¨æˆ·åœ¨è®¾å¤‡ä¹‹é—´æ„å»º mesh networksã€‚Netmaker å¯ä»¥æ ¹æ®éœ€è¦åˆ›å»ºå®Œå…¨çš„ã€æˆ–éƒ¨åˆ†çš„ mesh networkã€‚</p><p>å½“æˆ‘ä»¬æåŠ Netmaker æ•´ä½“çš„æ—¶å€™ï¼Œé€šå¸¸æŒ‡çš„æ˜¯ Netmaker ä»¥åŠ netclient, ä»¥åŠå…¶ä»–è¾…åŠ©çš„æœåŠ¡ï¼Œæ¯”å¦‚ CoreDNSï¼Œrqlite å’Œ UI æœåŠ¡ã€‚</p><p>ä»ç»ˆç«¯ç”¨æˆ·æ¥çœ‹ï¼Œé€šå¸¸ä¼šå’Œ Netmaker UI äº¤äº’ï¼Œæˆ–ä¼šç›´æ¥åœ¨ç»ˆç«¯èŠ‚ç‚¹ä¸­ç›´æ¥è¿è¡Œè„šæœ¬ã€‚è€Œå…¶ä»–éƒ¨åˆ†éƒ½ä¼šåœ¨åå°é»˜é»˜åœ°æ‰§è¡Œã€‚</p><p>Netmaker åšäº†éå¸¸å¤šçš„é…ç½®ç›¸å…³çš„å·¥ä½œï¼Œç®€åŒ–äº†ç”¨æˆ·çš„é…ç½®ã€‚åŒ…æ‹¬äº† WireGuard çš„ç«¯å£ï¼Œendpoints( ç»ˆç«¯) , public IPsï¼ˆå…¬ç½‘IPï¼‰ï¼Œkeys(å¯†é’¥) å’Œ peers(èŠ‚ç‚¹)ã€‚Netmaker å°½å¯èƒ½å¤šåœ°æŠ½è±¡äº†ç½‘ç»œç®¡ç†ï¼Œåªéœ€ç®€å•çš„åœ¨ç•Œé¢ç‚¹å‡»åˆ›å»ºç½‘ç»œï¼Œç„¶åç‚¹å‡»å°†è®¡ç®—æœºæ·»åŠ åˆ°ç½‘ç»œã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ¯ä¸€ä¸ªæœºå™¨éƒ½æ˜¯ä¸åŒçš„ï¼Œå¯èƒ½éœ€è¦ä¸åŒçš„é…ç½®ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆï¼ŒNetmaker ä½¿ç”¨ä¸€å¥—é»˜è®¤è®¾ç½®ï¼Œåˆ™ç½‘æ ¼å†…çš„æ‰€æœ‰å†…å®¹éƒ½æ˜¯å®Œå…¨å¯é…ç½®çš„ã€‚</p><h3><span id="systemd">SystemD</span></h3><p>SystemD æ˜¯ä¸€ä¸ªè¢« Linux å¹¿æ³›ä½¿ç”¨çš„ç³»ç»ŸæœåŠ¡å™¨ç®¡ç†å™¨ã€‚å°½ç®¡æ²¡æœ‰è¢«æ‰€æœ‰å‘è¡Œç‰ˆé‡‡ç”¨ï¼Œä½†æ˜¯ä¸ç®¡å¦‚ä½•ï¼Œå®ƒå·²ç»æˆä¸ºäº† Linux ä¸–ç•Œçš„äº‹å®æ ‡å‡†ã€‚é Linux å¯èƒ½æ²¡æœ‰ systemdï¼Œè€Œ Linux/Unix å‘è¡Œç‰ˆæœ‰å¯ä»£æ›¿çš„ system service managersã€‚</p><p>Netmaker çš„ netclient (å®¢æˆ·ç«¯) ä¼šæ§åˆ¶èŠ‚ç‚¹ä¸Šçš„ç½‘ç»œï¼Œå¯ä»¥é€šè¿‡å‘½ä»¤è¡Œè¿è¡Œï¼Œæˆ–è€…é€šè¿‡ä½œä¸º system å®ˆæŠ¤è¿›ç¨‹ï¼ˆdaemonï¼‰ï¼Œåœ¨ Linux ä¸Šä¼šé»˜è®¤ä»¥ daemon è¿è¡Œï¼ˆä¾èµ–äº systemd)ã€‚</p><p>ä» 0.8 ç‰ˆæœ¬å¼€å§‹ï¼Œæ”¯æŒäº† macOS å’Œ Windowsï¼Œåœ¨è¿™äº›æ“ä½œç³»ç»Ÿä¸­ï¼Œnetclient ä½¿ç”¨ LaunchD æ¥å¯åŠ¨ netclient å®ˆæŠ¤è¿›ç¨‹ã€‚</p><h3><span id="ingress-gateways">Ingress Gateways</span></h3><p>åœ¨ Netmaker ç½‘ç»œä¸­çš„ä»»ä½•èŠ‚ç‚¹éƒ½å¯ä»¥æˆä¸º Ingress Gatewayï¼ŒIngress Gateway å¯ä»¥æ¥å— Netmakerï¼ˆWireGuardï¼‰ç½‘ç»œå¤–éƒ¨çš„æµé‡ã€‚</p><h3><span id="egress-gateways">Egress Gateways</span></h3><p>Egress Gateway å‡ºå£ç½‘å…³ï¼Œå…è®¸å°†å†…éƒ¨ç½‘ç»œæµé‡è½¬å‘åˆ°å¤–éƒ¨æŒ‡å®š IPã€‚</p><h2><span id="netmaker-å®‰è£…">Netmaker å®‰è£…</span></h2><h3><span id="ç¡¬ä»¶è¦æ±‚">ç¡¬ä»¶è¦æ±‚</span></h3><p>æœåŠ¡å™¨ï¼š</p><ul><li>ä¸€å°å¯ç”¨çš„ VPSï¼ˆæœ€å¥½æ¯”è¾ƒå¹²å‡€ï¼Œæ²¡æœ‰å ç”¨ç«¯å£ï¼Œå¦åˆ™éœ€è¦æ ¹æ®è‡ªå·±çš„éœ€è¦è‡ªè¡Œè°ƒæ•´ï¼‰ã€‚</li><li>å…¬å¼€çš„ IP åœ°å€</li><li>è‡³å°‘ 1GB RAMï¼Œ1CPUï¼ˆ4GB RAMï¼Œ2 CPU ç”Ÿäº§ç¯å¢ƒï¼‰</li><li>2GB+ å­˜å‚¨</li><li>Ubuntu 20.04</li></ul><h3><span id="è½¯ä»¶è¦æ±‚">è½¯ä»¶è¦æ±‚</span></h3><p>åŸŸåï¼š</p><ul><li>ä¸€ä¸ªå¯ç”¨çš„åŸŸåï¼ˆå¯é€‰ï¼‰</li><li>å¯ä»¥æ“ä½œç®¡ç† DNS æœåŠ¡(53ç«¯å£)</li><li>ä¿è¯ 443(tcp)ï¼Œ 53(tcp udp), 51821-518XX(udp) ç«¯å£å¯ç”¨<ul><li>443 ç«¯å£ï¼ŒDashboardï¼ŒREST API å’Œ gRPC</li><li>53 ç«¯å£ï¼ŒCoreDNS</li><li>51821-518XXï¼ŒWireGuardï¼Œæ¯ä¸€ä¸ªç½‘ç»œéœ€è¦ä¸€ä¸ªç«¯å£ï¼Œèµ·å§‹ç«¯å£ä¼šä½¿ç”¨ 51821ï¼Œå¯ä»¥æ ¹æ®è‡ªå·±çš„ç½‘ç»œç«¯æ•°é‡éœ€è¦è®¾å®šç«¯å£èŒƒå›´</li><li>å…è®¸é˜²ç«å¢™ <code>sudo ufw allow proto tcp from any to any port 443 &amp;&amp; sudo ufw allow 53/udp &amp;&amp; sudo ufw allow 53/tcp &amp;&amp; sudo ufw allow 51821:51830/udp</code></li></ul></li></ul><h3><span id="ä¸€é”®å®‰è£…">ä¸€é”®å®‰è£…</span></h3><p>å¦‚æœæƒ³ä½¿ç”¨è‡ªå·±çš„åŸŸåï¼Œæ¯”å¦‚ <code>dashboard.netmaker.example.com</code> è¿™æ ·ï¼Œå¯ä»¥å‚è€ƒ<a href="https://docs.netmaker.org/quick-start.html" target="_blank" rel="noopener">å®˜ç½‘</a>ã€‚è¿™é‡Œä¸ºäº†æ¼”ç¤ºæ–¹ä¾¿ï¼Œå°±ä½¿ç”¨ä¸€é”®è„šæœ¬ã€‚</p><p>Netmaker å®˜æ–¹å·²ç»æä¾›äº†ä¸€ä¸ª Docker é•œåƒï¼Œå¹¶ä¸”ä¹Ÿæä¾›äº†å®‰è£…è„šæœ¬ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo wget -qO - https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;gravitl&#x2F;netmaker&#x2F;master&#x2F;scripts&#x2F;nm-quick.sh | bash</span><br></pre></td></tr></table></figure><p>å¦‚æœæ²¡æœ‰ä½¿ç”¨è‡ªå·±çš„åŸŸåï¼Œä¸€é”®è„šæœ¬ä¼šä½¿ç”¨ä¸€ä¸ª <a href="http://nip.io" target="_blank" rel="noopener">nip.io</a> çš„æ³›åŸŸåè§£ææ˜ å°„å·¥å…·æ ¹æ® IP è‡ªåŠ¨è·å–ä¸€ä¸ªåŸŸåï¼Œç”¨æ¥è®¿é—®åå°åœ°å€ã€‚</p><p>é¦–æ¬¡ç™»å½•åå°ä¼šè¦æ±‚è®¾å®šç”¨æˆ·åå’Œå¯†ç ã€‚ç™»å½•åå°ä¹‹åï¼Œå·¦ä¾§çš„ Networksã€ Nodesã€ Access Keys æ˜¯æ¯”è¾ƒé‡è¦çš„èœå•ã€‚</p><p><img src="https://img.hi-linux.com/staticfile/netmaker-dashboard-20211212154245-2022-01-13-E1wl5F.png" alt></p><p>åœ¨ Network é€‰é¡¹ä¸­é€‰æ‹©åˆ›å»º Networkï¼Œè®¾å®š IP æ®µèŒƒå›´ï¼Œç„¶ååœ¨å…¶ä»–æœºå™¨ä¸Šä¾æ¬¡å®‰è£…å®¢æˆ·ç«¯ï¼Œæ·»åŠ èŠ‚ç‚¹åˆ°ç½‘ç»œä¸­å³å¯ã€‚</p><p>åœ¨æ·»åŠ åˆ°ä¹‹åç½‘ç»œä¹‹åï¼Œå¯ä»¥è¿è¡Œ <code>sudo wg show</code> æŸ¥çœ‹ä¿¡æ¯ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">â¯ sudo wg show</span><br><span class="line">interface: nm-k3s</span><br><span class="line">  public key: PGeGQKOlJt4zZJX2axf15dRsWvs6QaFRF&#x2F;j&#x2F;fJUfnjw&#x3D;</span><br><span class="line">  private key: (hidden)</span><br><span class="line">  listening port: 51821</span><br><span class="line"></span><br><span class="line">peer: Cjbp&#x2F;IeTEFgPEJpOldjkaleUvlNjqg+y75hiI&#x2F;Sq61Q&#x3D;</span><br><span class="line">  endpoint: 140.XXX.XXX.XXX:51821</span><br><span class="line">  allowed ips: 10.10.11.8&#x2F;32</span><br><span class="line">  latest handshake: 2 seconds ago</span><br><span class="line">  transfer: 6.74 KiB received, 1.88 KiB sent</span><br><span class="line">  persistent keepalive: every 20 seconds</span><br></pre></td></tr></table></figure><p>é€šå¸¸ä¼šçœ‹åˆ° interface å’Œ peer ä¿¡æ¯ã€‚</p><h3><span id="æ‰‹åŠ¨å®‰è£…">æ‰‹åŠ¨å®‰è£…</span></h3><p>å¦‚æœéœ€è¦æ‰‹åŠ¨å®‰è£…ï¼Œä¹Ÿä¸æ˜¯ç‰¹åˆ«éº»çƒ¦ï¼Œä»å®˜ç½‘ä¸‹è½½ docker-compose.yml æ–‡ä»¶ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ wget -O docker-compose.yml https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;gravitl&#x2F;netmaker&#x2F;master&#x2F;compose&#x2F;docker-compose.contained.yml</span><br><span class="line">$ sed -i &#39;s&#x2F;NETMAKER_BASE_DOMAIN&#x2F;&lt;your base domain&gt;&#x2F;g&#39; docker-compose.yml</span><br><span class="line">$ sed -i &#39;s&#x2F;SERVER_PUBLIC_IP&#x2F;&lt;your server ip&gt;&#x2F;g&#39; docker-compose.yml</span><br><span class="line">$ sed -i &#39;s&#x2F;COREDNS_IP&#x2F;&lt;default interface ip&gt;&#x2F;g&#39; docker-compose.yml</span><br></pre></td></tr></table></figure><ul><li>ç”Ÿæˆå”¯ä¸€çš„ master key:</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ tr -dc A-Za-z0-9 &lt;&#x2F;dev&#x2F;urandom | head -c 30 ; echo &#39;&#39;</span><br><span class="line">$ sed -i &#39;s&#x2F;REPLACE_MASTER_KEY&#x2F;&lt;your generated key&gt;&#x2F;g&#39; docker-compose.yml</span><br></pre></td></tr></table></figure><ul><li>é…ç½® Caddy</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ wget -O &#x2F;root&#x2F;Caddyfile https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;gravitl&#x2F;netmaker&#x2F;master&#x2F;docker&#x2F;Caddyfile</span><br><span class="line">$ sed -i &#39;s&#x2F;NETMAKER_BASE_DOMAIN&#x2F;&lt;your base domain&gt;&#x2F;g&#39; &#x2F;root&#x2F;Caddyfile</span><br><span class="line">$ sed -i &#39;s&#x2F;YOUR_EMAIL&#x2F;&lt;your email&gt;&#x2F;g&#39; &#x2F;root&#x2F;Caddyfile</span><br></pre></td></tr></table></figure><ul><li>ç„¶åå¯åŠ¨ï¼š</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker-compose up -d</span><br></pre></td></tr></table></figure><p>ç„¶åå¯ä»¥è®¿é—® <code>dashboard.nm.example.com</code> åå°ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœä½¿ç”¨è‡ªå·±çš„åŸŸåéœ€è¦æ·»åŠ ä¸€ä¸ªæ³›åŸŸå A è®°å½•ï¼ˆwildcard A record)ï¼Œæ¯”å¦‚æƒ³è¦åå°è®¿é—®åœ°å€æ˜¯ <code>dashboard.nm.example.com</code> é‚£ä¹ˆéœ€è¦æ·»åŠ  <code>*.nm.example.com</code>ã€‚</p><p>Caddy ä¼šåˆ›å»ºä¸‰ä¸ªå­åŸŸåï¼š</p><ul><li><a href="http://dashboard.nm.example.com" target="_blank" rel="noopener">dashboard.nm.example.com</a></li><li><a href="http://api.nm.example.com" target="_blank" rel="noopener">api.nm.example.com</a></li><li><a href="http://grpc.nm.example.com" target="_blank" rel="noopener">grpc.nm.example.com</a></li></ul><h2><span id="netclient-ä½¿ç”¨">netclient ä½¿ç”¨</span></h2><p><code>netclient</code> æ˜¯ä¸€ä¸ªç®€å•çš„ CLIï¼Œç”¨äºåˆ›å»º WireGuard é…ç½®å’Œæ¥å£ã€‚netclient å¯ä»¥ç®¡ç†ä»»æ„ç§æœ‰ç½‘ç»œã€‚</p><h3><span id="å®‰è£…-netclient-ä¾èµ–">å®‰è£… netclient ä¾èµ–</span></h3><p>ä»¥ macOS ä¸ºä¾‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ brew install wireguard-tools</span><br></pre></td></tr></table></figure><h3><span id="å®‰è£…-netclient">å®‰è£… netclient</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ wget https:&#x2F;&#x2F;github.com&#x2F;gravitl&#x2F;netmaker&#x2F;releases&#x2F;download&#x2F;v0.9.3&#x2F;netclient-darwin</span><br><span class="line">$ mv netclient-darwin netclient</span><br><span class="line">$ chmod +x netclient</span><br></pre></td></tr></table></figure><h3><span id="ä½¿ç”¨-netclient-å°†èŠ‚ç‚¹åŠ å…¥ç½‘ç»œ">ä½¿ç”¨ netclient å°†èŠ‚ç‚¹åŠ å…¥ç½‘ç»œ</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ .&#x2F;netclient join --dnson no --name &lt;HOSTNAME&gt; --network demo --apiserver &lt;Netmaker_IP&gt;:8081 --grpcserver &lt;Netmaker_IP&gt;:50051</span><br></pre></td></tr></table></figure><h2><span id="å¤–å»¶">å¤–å»¶</span></h2><p>Nebula æ˜¯å¦å¤–ä¸€ä¸ªé€‰æ‹©ï¼ŒåŒæ ·åŸºäº WireGuardã€‚</p><p>æ›´å¤šèµ„æ–™å¯ä»¥æŸ¥çœ‹ Gravitl å®˜ç½‘ï¼š<a href="https://gravitl.com/resources" target="_blank" rel="noopener">https://gravitl.com/resources</a></p><h2><span id="reference">reference</span></h2><ul><li><a href="https://docs.netmaker.org/" target="_blank" rel="noopener">å®˜æ–¹æ–‡æ¡£</a></li><li><a href="https://afeiszli.medium.com/how-to-enable-secure-access-to-your-hosted-services-using-netmaker-and-wireguard-1b3282d4b7aa" target="_blank" rel="noopener">ä½¿ç”¨ Netmaker å’Œ WireGuard è®¿é—®å†…ç½‘æœåŠ¡</a></li><li><a href="https://netmaker.readthedocs.io/en/master/getting-started.html" target="_blank" rel="noopener">Netmaker Getting Started</a></li><li><a href="https://itnext.io/getting-started-with-netmaker-a-wireguard-virtual-networking-platform-3d563fbd87f0" target="_blank" rel="noopener">Getting started with netmaker</a></li></ul><blockquote><p>æœ¬æ–‡è½¬è½½è‡ªï¼šã€Œ Verne in GitHub ã€ï¼ŒåŸæ–‡ï¼š<a href="https://tinyurl.com/5yuj4xbu" target="_blank" rel="noopener">https://tinyurl.com/5yuj4xbu</a> ï¼Œç‰ˆæƒå½’åŸä½œè€…æ‰€æœ‰ã€‚æ¬¢è¿æŠ•ç¨¿ï¼ŒæŠ•ç¨¿é‚®ç®±: <a href="mailto:editor@hi-linux.com">editor@hi-linux.com</a>ã€‚</p></blockquote></div><script src="https://my.openwrite.cn/js/readmore.js" type="text/javascript"></script><script>var isMobile = navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i);if (!isMobile) {    var btw = new BTWPlugin();    btw.init({        "id": "vip-container",        "blogId": "10135-1588830050631-449",        "name": "ã€Œå¥‡å¦™çš„ Linux ä¸–ç•Œã€",        "qrcode": "https://www.hi-linux.com/img/wechat/mp_qrcode_12.jpg",        "keyword": "VIP"    });}</script>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;ä»€ä¹ˆæ˜¯-Netmaker&quot;&gt;ä»€ä¹ˆæ˜¯ Netmaker&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/gravitl/netmaker&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Netmaker&lt;/a&gt; æ˜¯ä¸€ä¸ªå¼€æºçš„ã€åŸºäº [[WireGuard]] çš„ç½‘ç»œï¼ˆoverlay network) æ§åˆ¶å·¥å…·ï¼Œå¯ä»¥éå¸¸å¿«é€Ÿçš„ç”¨æ¥ç»„å»º WireGuard ç½‘ç»œã€‚&lt;/p&gt;
&lt;p&gt;å¦‚æœä½ æœ‰ä¸¤å°è¿æ¥äº’è”ç½‘çš„è®¾å¤‡ï¼Œé‚£ä¹ˆ Netmaker å¯ä»¥ç»„å»ºä¸€ä¸ªå®‰å…¨çš„ç½‘ç»œï¼Œå¹¶æ‰“é€šä¸€ä¸ªå®‰å…¨çš„éš§é“æä¾›ç»™ä¸¤å°æœºå™¨é€šä¿¡ã€‚è€Œå¦‚æœä½ æœ‰æ•°åƒå°æœºå™¨åˆ†å¸ƒåœ¨ä¸åŒçš„åœ°åŒºï¼Œä¸åŒçš„æ•°æ®ä¸­å¿ƒï¼Œä¸åŒçš„ç½‘ç»œä¸­ï¼Œé‚£ä¹ˆ Netmaker ä¹Ÿå¯ä»¥ç»„å»ºä¸€ä¸ªç½‘ç»œæ¥æä¾›ç»™è¿™äº›ä¸åŒçš„èŠ‚ç‚¹é€šä¿¡ã€‚&lt;/p&gt;
&lt;p&gt;å¦‚æœç†Ÿæ‚‰ AWSï¼Œé‚£ä¹ˆ Netmaker å°±åƒ VPC ä¸€æ ·ï¼Œä¸è¿‡ Netmaker å¯ä»¥åº”ç”¨åœ¨ä»»æ„çš„æœºå™¨ä¸­ã€‚ä» Netmaker ç½‘ç»œä¸­çš„æœºå™¨æ¥çœ‹ï¼ŒåŒä¸€ä¸ªç½‘ç»œä¸­çš„æœºå™¨å°½ç®¡åœ¨ä¸–ç•Œå„åœ°ï¼Œä½†å…¶ç›¸äº’é€šä¿¡å°±åƒæ˜¯åœ¨åŒä¸€ä¸ªå±€åŸŸç½‘ä¸­ä¸€æ ·ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Linux" scheme="https://www.hi-linux.com/categories/Linux/"/>
    
    
      <category term="Linux" scheme="https://www.hi-linux.com/tags/Linux/"/>
    
      <category term="WireGuard" scheme="https://www.hi-linux.com/tags/WireGuard/"/>
    
      <category term="Netmaker" scheme="https://www.hi-linux.com/tags/Netmaker/"/>
    
  </entry>
  
  <entry>
    <title>ä¸–ç•Œæ˜¯ Container çš„ï¼Œä¹Ÿæ˜¯ Microservice çš„ï¼Œä½†æœ€ç»ˆè¿˜æ˜¯ Serverless çš„</title>
    <link href="https://www.hi-linux.com/posts/32279.html"/>
    <id>https://www.hi-linux.com/posts/32279.html</id>
    <published>2022-01-03T01:00:00.000Z</published>
    <updated>2022-01-13T05:34:07.912Z</updated>
    
    <content type="html"><![CDATA[<div id="vip-container"><p>ä¸–ç•Œä¸Šæœ‰ä¸¤ç§åŸºç¡€è®¾æ–½ï¼Œä¸€ç§æ˜¯æ‹¿æ¥ä¸»ä¹‰ï¼Œå¦ä¸€ç§æ˜¯è‡ªä¸»å¯æ§ã€‚</p><p>åŸè°…æˆ‘ä¹Ÿè¹­ä¸ªå·²ç»è¢«æµ‡ç­çš„ã€æ²¡æ€ä¹ˆç«èµ·æ¥çš„çƒ­ç‚¹ã€‚ä¸è¿‡æˆ‘ä»¬å–œæ¬¢çš„æ˜¯æ‹¿æ¥ä¸»ä¹‰ï¼Œ<strong>å¤Ÿç”¨å°±è¡Œï¼Œä¸æƒ³ä¹Ÿä¸éœ€è¦è¿‡å¤šçš„æ§åˆ¶ï¼Œä¹Ÿä¸æƒ³æƒ¹è¿‡å¤šçš„éº»çƒ¦</strong>ï¼Œä¹Ÿå°±æ˜¯ fully managedã€‚</p><p>ä¹‹æ‰€ä»¥æƒ³åˆ°å†™è¿™ç¯‡æ–‡ç« ï¼Œæºäºå‰å‡ å¤©çœ‹åˆ°çš„è¿™ç¯‡æ¥è‡ªå¾®è½¯ Azure çš„åšå®¢å†…å®¹ï¼š <a href="https://thenewstack.io/the-future-of-Kubernetes-is-serverless/" target="_blank" rel="noopener">The Future of Kubernetes Is Serverless</a> ï¼Œç„¶ååˆé¡ºæ‰‹æ¸©ä¹ äº†ä¸€é AWS CTO æ‰€æ’°å†™çš„ <a href="https://www.allthingsdistributed.com/2018/04/changing-calculus-containers-cloud.html" target="_blank" rel="noopener">Changing the calculus of containers in the cloud</a> è¿™ç¯‡æ–‡ç« ã€‚è¿™ä¸¤ç¯‡æ–‡ç« ä½ è§‰å¾—æœ‰å¯èƒ½æœ‰å¹¿å‘Šçš„å«Œç–‘ï¼Œéƒ½æ˜¯åœ¨æ¨é”€è‡ªå®¶çš„å…±æœ‰äº‘æœåŠ¡ï¼Œä½†æ˜¯ä»”ç»†å“å‘³æ¯ä¸€å¥è¯ï¼Œæˆ‘å´è§‰å¾—å‡ ä¹æ²¡æœ‰å‡ å¥åºŸè¯ï¼Œéƒ½å¾ˆè¯´åˆ°ç‚¹å­ä¸Šï¼Œä½ å¯ä»¥ç‚¹å‡»è¿›å»çœ‹ä¸‹åŸæ–‡ã€‚</p><p>æœ‰ä¸ªå‰æéœ€è¦è¯´æ˜çš„æ˜¯ï¼Œè¿™é‡Œçš„ Serverless æŒ‡çš„æ˜¯ Serverless infrastructureï¼Œè€Œä¸æ˜¯æˆ‘ä»¬å¸¸å¬åˆ°çš„ AWS Lambdaï¼ŒMicrosoft Azure Functions æˆ– Google Cloud Functions ç­‰å‡½æ•°ï¼ˆåŠŸèƒ½ï¼‰å³æœåŠ¡ï¼ˆFaaSï¼‰æŠ€æœ¯ï¼Œä¸ºäº†ä¾¿äºåŒºåˆ†ï¼Œæˆ‘ä»¬å°†è¿™äº› FaaS ç§°ä¸ºæ— æœåŠ¡å™¨è®¡ç®—ï¼Œå’Œæˆ‘ä»¬æœ¬æ–‡è¦ä»‹ç»çš„æ— æœåŠ¡å™¨åŸºç¡€è®¾æ–½è¿˜æ˜¯ä¸ä¸€æ ·çš„ã€‚</p><a id="more"></a><h2><span id="iaaså˜é©çš„å¼€å§‹">IaaSï¼šå˜é©çš„å¼€å§‹</span></h2><p>è¯´åˆ°åŸºç¡€è®¾æ–½ï¼Œé¦–å…ˆæ¥ä»‹ç»ä¸‹æœ€å…ˆå‡ºç°çš„ IaaSï¼Œå³åŸºç¡€è®¾æ–½å³æœåŠ¡ã€‚IaaS å…é™¤äº†å¤§éƒ¨åˆ†ç¡¬ä»¶çš„ provision å·¥ä½œï¼Œæ²¡äººå†å…³å¿ƒæœºæ¶ã€ç”µæºå’ŒæœåŠ¡å™¨é—®é¢˜ï¼Œä½¿å¾—è¿ç»´å·¥ä½œæ›´å¿«æ·ï¼Œæ›´è½»æ¾ï¼Œæ„Ÿè§‰è§£æ”¾äº†å¾ˆå¤šäººï¼Œè®©å¤§å®¶èµ°ä¸Šäº†å¯Œè£•ä¹‹è·¯ã€‚</p><p>å½“ç„¶è¿™ä¸€ä»£çš„äº‘è®¡ç®—æœåŠ¡ï¼Œå¯ä¸åªæ˜¯å¯ä»¥å‡ åˆ†é’Ÿå¯åŠ¨ä¸€å°è™šæ‹Ÿæœºé‚£ä¹ˆç®€å•ã€‚</p><p>é™¤äº† VM ä¹‹å¤–ï¼Œ IaaS å‚å•†è¿˜æä¾›äº†å¾ˆå¤šå…¶ä»–åŸºç¡€è®¾æ–½å’Œä¸­é—´ä»¶æœåŠ¡ï¼Œè¿™äº›ç»„ä»¶è¢«ç§°ä¸º building block ï¼Œæ¯”å¦‚ç½‘ç»œå’Œé˜²ç«å¢™ã€æ•°æ®åº“ã€ç¼“å­˜ç­‰è€ä¸‰æ ·ï¼Œæœ€è¿‘è¿˜å‡ºç°äº†éå¸¸å¤šéå¸¸å¤šçš„ä¸šåŠ¡åœºæ™¯æœåŠ¡ï¼Œå¤§æ•°æ®ã€æœºå™¨å­¦ä¹ å’Œç®—æ³•ï¼Œä»¥åŠIoTç­‰ï¼Œçœ‹èµ·æ¥å°±åƒä¸ªç™¾è´§å•†åº—ï¼Œä½¿ç”¨äº‘è®¡ç®—å°±åƒè´­ç‰©ï¼Œæ¶æ„è®¾è®¡å°±æ˜¯è´­ç‰©æ¸…å•ï¼Œæ¶æ„é‡Œçš„ç»„ä»¶éƒ½å¯ä»¥åœ¨å•†åº—é‡Œä¹°åˆ°ã€‚</p><p>åŸºç¡€è®¾æ–½åˆ™ä½¿ç”¨ IaaS æœåŠ¡å•†æ‰€æä¾›çš„å„ç§æœåŠ¡ï¼Œç¼–å†™åº”ç”¨ç¨‹åºå¯ä»¥æ›´ä¸“æ³¨äºä¸šåŠ¡ã€‚è¿™èƒ½å¸¦æ¥å¾ˆå¤šå¥½å¤„ï¼š</p><ul><li>å°†ç²¾åŠ›é›†ä¸­æŠ•å…¥åˆ°æ ¸å¿ƒä¸šåŠ¡</li><li>åŠ å¿«ä¸Šçº¿é€Ÿåº¦</li><li>æé«˜å¯ç”¨æ€§</li><li>å¿«é€Ÿæ‰©ç¼©å®¹</li><li>ä¸å¿…å…³å¿ƒä¸­é—´ä»¶çš„åº•å±‚åŸºç¡€è®¾æ–½</li><li>å…å»ç¹æ‚çš„å®‰è£…ã€é…ç½®ã€å¤‡ä»½å’Œå®‰å…¨ç®¡ç†ç­‰è¿ç»´å·¥ä½œ</li></ul><p>åœ¨ AWS æˆä¸ºä¸šç•Œæ ‡å‡†ä¹‹åï¼Œå„å¤§è½¯ä»¶å…¬å¸ï¼Œä¸ç®¡æ˜¯æ–°å…´çš„è¿˜æ˜¯è€ç‰Œçš„ï¼Œéƒ½å¼€å§‹ç€æ‰‹æ‰“é€ è‡ªå·±çš„äº‘ï¼Œå›½å¤–æœ‰å¾®è½¯ã€è°·æ­Œã€IBMç­‰ï¼Œå›½å†…çš„ BAT ä¹Ÿéƒ½æœ‰è‡ªå·±çš„äº‘ï¼Œä»¥åŠäº¬ä¸œå’Œç¾å›¢è¿™æ ·çš„ç”µå•†ç±»å…¬å¸ä¹Ÿæœ‰è‡ªå·±çš„äº‘äº§å“ï¼Œç‹¬ç«‹çš„å‚å•†ç±»ä¼¼ UCloud å’Œé’äº‘ç­‰å…¬å¸ä¹Ÿå‘å±•çš„ä¸é”™ï¼Œç”šè‡³æœ‰å¼€é¥­é¦†çš„ä¹Ÿè¦å‡ºæ¥å‡‘çƒ­é—¹ã€‚è€Œå¼€æºè½¯ä»¶ OpenStack å’ŒåŸºäº OS çš„åˆ›ä¸šå…¬å¸å’Œäº§å“ä¹Ÿå±‚å‡ºä¸ç©·ã€‚</p><p>å…¨æ°‘çš†äº‘ã€‚</p><h2><span id="å®¹å™¨äº‘è®¡ç®—çš„æ·±å…¥äººå¿ƒ">å®¹å™¨ï¼šäº‘è®¡ç®—çš„æ·±å…¥äººå¿ƒ</span></h2><p>ä¹‹ååœ¨ 2013 å¹´ï¼Œå®¹å™¨æŠ€æœ¯å¼€å§‹é¢å‘å¤§ä¼—æ™®åŠäº†ã€‚åœ¨ LXC ä¹‹å‰ï¼Œå®¹å™¨å¯¹æ™®é€šå¼€å‘äººå‘˜ç”šè‡³ IT ä¸šè€…æ¥è¯´å‡ ä¹ä¸æ˜¯åŒä¸€ä¸ªç»´åº¦çš„æœ¯è¯­ï¼Œé‚£æ˜¯äº›ä¸“ä¸šäººå‘˜æ‰èƒ½æŒæ§çš„æ™¦æ¶©çš„æœ¯è¯­å’Œç¹æ‚çš„å‘½ä»¤é›†ï¼Œå¤§éƒ¨åˆ†äººéƒ½æ²¡æœ‰ç”¨è¿‡å®¹å™¨æŠ€æœ¯ï¼›ä½†æ˜¯éšç€ Docker çš„å‡ºç°ï¼Œå®¹å™¨æŠ€æœ¯çš„é—¨æ§›é™ä½ï¼Œä¹Ÿåœ¨è½¯ä»¶è¡Œä¸šå˜å¾—æ™®åŠã€‚éšç€å‡ å¹´çš„å‘å±•ï¼ŒåŸºæœ¬å¯ä»¥è¯´å®¹å™¨æŠ€æœ¯å·²ç»éå¸¸æˆç†Ÿï¼Œå·²æˆä¸ºäº†å¼€å‘çš„æ ‡é…ã€‚</p><p>éšç€å®¹å™¨æŠ€æœ¯çš„æˆç†Ÿå’Œæ™®åŠï¼Œåº”ç”¨ç¨‹åºæ¶æ„ä¹Ÿå‡ºç°äº†æ–°çš„å˜åŒ–ï¼Œå¯ä»¥è¯´è½¯ä»¶å’ŒåŸºç¡€è®¾æ–½çš„è¿›åŒ–ç›¸è¾…ç›¸æˆã€‚äººä»¬è¶Šæ¥è¶Šå¤šçš„è®¤è¯†åˆ°å¯¹æŠ€æœ¯æ ˆçš„åˆ†å±‚å’Œè§£è€¦æ›´åŠ é‡è¦ï¼Œä¸åŒå±‚ä¹‹é—´çš„æŠ€æœ¯å’Œè´£ä»»ã€æ‰€æœ‰æƒç­‰ç•Œé™æ¸…æ™°æ˜äº†ï¼Œè¿™ä¹Ÿå’Œè½¯ä»¶è®¾è®¡ä¸­çš„æ¨¡å—æ¾è€¦åˆåŸåˆ™å¾ˆç›¸åƒã€‚</p><p>åœ¨æœ‰äº†è´£æƒæ˜æ™°çš„åˆ†å±‚ç»“æ„ä¹‹åï¼Œæ¯ä¸ªäººå¯ä»¥æ›´å®¹æ˜“é›†ä¸­åœ¨è‡ªå·±æ‰€å…³æ³¨çš„é‡ç‚¹ä¸Šã€‚å¼€å‘äººå‘˜æ›´å…³æ³¨åº”ç”¨ç¨‹åºæœ¬èº«äº†ï¼Œåœ¨ Docker ç«äº†çš„åŒæ—¶ï¼Œä¹Ÿå‡ºç°äº† app-centric çš„æ¦‚å¿µã€‚ç”šè‡³ CoreOS è¿˜å°†è‡ªå·±å¯¹æŠ— OCI/runc çš„æ ‡å‡†ç§°ä¸º appc ã€‚å½“ç„¶ç°åœ¨çš„ Docker ä¹Ÿä¸æ˜¯åŸæ¥çš„ Docker ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªç»„ä»¶åŒ–çš„ä¸œè¥¿ï¼Œå¾ˆå¤šç»„ä»¶ï¼Œå°¤å…¶æ˜¯ runtime ï¼Œéƒ½å¯ä»¥æ›¿æ¢ä¸ºå…¶ä»–è¿è¡Œæ—¶ã€‚</p><p>å’Œä»¥åº”ç”¨ç¨‹åºä¸ºé‡å¿ƒç›¸å¯¹åº”çš„æ˜¯ä¼ ç»Ÿçš„ä»¥åŸºç¡€è®¾æ–½ä¸ºä¸­å¿ƒï¼Œå³å…ˆæœ‰åŸºç¡€è®¾æ–½ï¼Œå›´ç»•åŸºç¡€è®¾æ–½åšæ¶æ„è®¾è®¡å’Œå¼€å‘ã€éƒ¨ç½²ï¼Œå—åŸºç¡€è®¾æ–½çš„é™åˆ¶è¾ƒå¤šã€‚è€Œéšç€ IaaS ç­‰æœåŠ¡çš„å…´èµ·ï¼ŒåŸºç¡€è®¾æ–½è¶Šæ¥è¶Šç®€å•ï¼Œè¶Šæ¥è¶Šå¤šå®¹æ˜“å…¥æ‰‹ï¼Œè€Œä¸”è¿˜æä¾›äº†ç¼–ç¨‹åŒ–çš„æ¥å£ï¼Œå¼€å‘äººå‘˜ä¹Ÿå¯ä»¥éå¸¸æ–¹ä¾¿çš„å¯¹åŸºç¡€è®¾æ–½è¿›è¡Œç®¡ç†ï¼Œå¯ä»¥è¯´äº‘è®¡ç®—çš„å‡ºç°ä¹Ÿä½¿å¾—å¼€å‘äººå‘˜æŠ¢äº†ä¸€éƒ¨åˆ†è¿ç»´äººå‘˜çš„é¥­ç¢—ï¼ˆé—æ†¾çš„æ˜¯è¿™ç§è¶‹åŠ¿å¤ª high äº†åœä¸ä¸‹æ¥ã€‚ã€‚ã€‚ï¼‰ã€‚</p><p>å½“ç„¶ï¼Œç°åœ¨ä»¥åº”ç”¨ä¸ºä¸­å¿ƒè¿™ä¸€æ¦‚å¿µä¹Ÿå·²ç»æ·±å…¥äººå¿ƒã€‚ç‰¹åˆ«æ˜¯è¿›åŒ–åˆ°æè‡´çš„ FaaS ï¼Œè‡ªå·±åªéœ€è¦å†™å‡ è¡Œä»£ç ï¼Œå…¶ä»–å¹³å°å…¨ç»™æå®šäº†ã€‚</p><h2><span id="ç¼–æ’å…µå®¶å¿…äº‰ä¹‹åœ°">ç¼–æ’ï¼šå…µå®¶å¿…äº‰ä¹‹åœ°</span></h2><p>å®¹å™¨è§£å†³äº†ä»£ç çš„å¯ç§»æ¤æ€§çš„é—®é¢˜ï¼Œä¹Ÿä½¿å¾—åœ¨äº‘è®¡ç®—ä¸­å‡ºç°æ–°çš„åŸºç¡€è®¾æ–½åº”ç”¨æ¨¡å¼æˆä¸ºå¯èƒ½ã€‚ä½¿ç”¨ä¸€ä¸ªä¸€è‡´çš„ã€ä¸å¯å˜çš„éƒ¨ç½²åˆ¶å“ï¼Œæ¯”å¦‚é•œåƒï¼Œå¯ä»¥è®©æˆ‘ä»¬ä»å¤æ‚çš„æœåŠ¡å™¨éƒ¨ç½²ä¸­è§£è„±å‡ºæ¥ï¼Œä¹Ÿå¯ä»¥éå¸¸æ–¹ä¾¿çš„éƒ¨ç½²åˆ°ä¸åŒçš„è¿è¡Œç¯å¢ƒä¸­ï¼ˆå¯ç§»æ¤æ€§ï¼‰ã€‚</p><p>ä½†æ˜¯å®¹å™¨çš„å‡ºç°ä¹Ÿå¢åŠ äº†æ–°çš„å·¥ä½œå†…å®¹ï¼Œè¦æƒ³ä½¿ç”¨å®¹å™¨è¿è¡Œæˆ‘ä»¬çš„ä»£ç ï¼Œå°±éœ€è¦ä¸€å¥—å®¹å™¨ç®¡ç†ç³»ç»Ÿï¼Œåœ¨æˆ‘ä»¬ç¼–å†™å®Œä»£ç ï¼Œæ‰“åŒ…åˆ°å®¹å™¨ä¹‹åï¼Œéœ€è¦é€‰æ‹©åˆé€‚çš„è¿è¡Œç¯å¢ƒï¼Œè®¾ç½®å¥½æ­£ç¡®çš„æ‰©å®¹é…ç½®ï¼Œç›¸å…³çš„ç½‘ç»œè¿æ¥ï¼Œå®‰å…¨ç­–ç•¥å’Œè®¿é—®æ§åˆ¶ï¼Œä»¥åŠç›‘æ§ã€æ—¥å¿—å’Œåˆ†å¸ƒå¼è¿½è¸ªç³»ç»Ÿã€‚</p><p>ä¹‹æ‰€ä»¥å‡ºç°ç¼–æ’ç³»ç»Ÿï¼Œå°±æ˜¯å› ä¸ºä¸€å°æœºå™¨å·²ç»ä¸å¤Ÿç”¨äº†ï¼Œæˆ‘ä»¬è¦å‡†å¤‡å¾ˆå¤šæœºå™¨ï¼Œåœ¨ä¸Šé¢è·‘å®¹å™¨ï¼Œè€Œä¸”æˆ‘ä¸å…³å¿ƒå®¹å™¨è·‘åœ¨å“ªå°æœºå™¨ä¸Šï¼Œè¿™ä¸ªäº¤ç»™è°ƒåº¦ç³»ç»Ÿå°±è¡Œäº†ã€‚å¯ä»¥è¯´ï¼Œä»ä¸€å®šå±‚é¢ä¸Šï¼Œç¼–æ’ç³»ç»Ÿé€æ¸æ·¡åŒ–äº†ä¸»æœºè¿™ä¸€æ¦‚å¿µï¼Œæˆ‘ä»¬é¢å¯¹çš„æ˜¯ä¸€ä¸ªèµ„æºæ± ï¼Œæ˜¯ä¸€ç»„æœºå™¨ï¼Œæœ‰å¤šå°‘ä¸ª CPU å’Œå¤šå°‘çš„å†…å­˜ç­‰è®¡ç®—èµ„æºå¯ç”¨ã€‚</p><p>rkt vs Docker çš„æˆ˜äº‰ä»å¼€å§‹å…¶å®å°±å¯ä»¥é¢„æ–™åˆ°ç»“å±€ï¼Œä½†åœ¨ç¼–æ’ç³»ç»Ÿ/é›†ç¾¤ç®¡ç†ä¸Šï¼Œè¿™åœºâ€œæˆ˜äº‰â€åˆ™æœ‰ç€æ›´å¤šçš„ä¸ç¡®å®šæ€§ã€‚</p><p>Mesosï¼ˆDC/OSï¼‰å‡ºæ¥çš„æœ€æ—©ï¼Œè¿˜æœ‰ Twitter ç­‰å…¬å¸åšæ¡ˆä¾‹ï¼Œä¹Ÿæ˜¯æ—©æœŸå®¹å™¨è°ƒåº¦ç³»ç»Ÿçš„æ ‡é…ï¼›Swarm å€ŸåŠ©å…¶æ ¹æ­£è‹—çº¢ä»¥åŠç®€å•æ€§ã€å’Œ Docker çš„äº²å’Œæ€§ï¼Œä¹Ÿè¦äº‰ä¸€åˆ†åœ°ç›˜ï¼›ä¸è¿‡ç°åœ¨çœ‹æ¥èµ¢å®¶åº”è¯¥æ˜¯ K8sï¼ŒK8s æœ‰ Google åšé å±±ï¼Œæœ‰ Google å¤šå¹´è°ƒåº¦çš„ç»éªŒï¼ŒåŠ ä¸Š RedHat/CoreOS è¿™äº›å Docker å…¬å¸çš„ç«™é˜Ÿï¼Œç¤¾åŒºåˆåšå¾—çº¢çº¢ç«ç«ï¼Œæ€»ä¹‹æ˜¯èµ¢äº†ã€‚</p><p>æ®è¯´ä»Šå¹´åœ¨å“¥æœ¬å“ˆæ ¹ä¸¾åŠçš„ Kubecon æœ‰ 4300 äººå‚åŠ ã€‚ä¸è¿‡å½“åˆ Dockercon ä¹Ÿæ˜¯è¿™å£°åŠ¿ï¼Œè€Œç°åœ¨å½±å“åŠ›å·²ç»æ²¡é‚£ä¹ˆå¤§äº†ï¼Œæœ‰ç§æ˜¨æ—¥é»„èŠ±ã€äººè€è‰²è¡°çš„æ„Ÿè§‰ï¼Œä¸çŸ¥é“å‡ å¹´ä¹‹åçš„ Kubernetes å°†æ¥ä¼šå¦‚ä½•ï¼Œæ˜¯å¦ä¼šå‡ºç°æ–°çš„äº§å“æˆ–æœåŠ¡æ¥æ’¼åŠ¨ Kubernetes ç°åœ¨çš„åœ°ä½ï¼Ÿè™½ç„¶ä¸ä¸€å®šï¼Œä½†æ˜¯æˆ‘ä»¬æœŸå¾…å•Šã€‚</p><h2><span id="serverless-infrastructureè¿›åŒ–çš„ç»“æœ">Serverless infrastructureï¼šè¿›åŒ–çš„ç»“æœ</span></h2><p>ä½†æ˜¯å‘¢ï¼Œæ·¡åŒ–ä¸»æœºçš„å­˜åœ¨æ€§ä¹Ÿåªæ˜¯æ·¡åŒ–è€Œå·²ï¼Œå¹¶æ²¡æœ‰å®Œå…¨æ¶ˆé™¤ä¸»æœºçš„æ¦‚å¿µï¼Œåªæ˜¯æˆ‘ä»¬ç›´æ¥é¢å‘ä¸»æœºçš„æœºä¼šé™ä½äº†ï¼Œä¸å†ç›´æ¥é¢å‘ä¸»æœºè¿›è¡Œéƒ¨ç½²ï¼Œä¹Ÿä¸ä¼šä¸ºæŸäº›éƒ¨é—¨åˆ†é…ç‹¬å çš„ä¸»æœºç­‰ã€‚ä¸»æœºå‡ºäº†é—®é¢˜è¿˜å¾—é‡å¯ï¼Œèµ„æºä¸å¤Ÿäº†è¿˜å¾—æ·»åŠ æ–°çš„ä¸»æœºï¼Œç®¡ç†å·¥ä½œå¹¶æ²¡æœ‰å®Œå…¨æ¶ˆå¤±ã€‚</p><p>ä½†æ˜¯ç®¡ç†ä¸€å¥—é›†ç¾¤å¸¦æ¥äº†å¾ˆå¤§çš„å¤æ‚æ€§ï¼Œè¿™ä¹Ÿå’Œä½¿ç”¨äº‘è®¡ç®—çš„åˆè¡·ç›¸åï¼Œæ›´ç§°ä¸ä¸Šäº‘åŸç”Ÿã€‚</p><p>ä»ç”¨æˆ·çš„è§’åº¦å†æ¬¡å®¡è§†ä¸€ä¸‹ï¼Œå¯ä»¥å‘ç°ä¸€ä¸ªé•¿æ—¶é—´è¢«æˆ‘ä»¬å¿½ç•¥çš„é—®é¢˜ï¼šä¸ºä»€ä¹ˆåªæ˜¯æƒ³è¿è¡Œå®¹å™¨ï¼Œéå¾—å…ˆä¹°ä¸€å° VM è£…å¥½ Dockerï¼Œæˆ–è€…è‡ªå·±æ­å»ºä¸€å¥— Kubernetes é›†ç¾¤ï¼Œæˆ–è€…ä½¿ç”¨ç±»ä¼¼ EKS è¿™æ ·çš„æœåŠ¡ï¼Œä¹æ­¤ä¸ç–²çš„è¿›è¡Œå„ç§é…ç½®å’Œè°ƒè¯•ï¼Œä¸ä»…èŠ±è´¹å›ºå®šçš„èµ„äº§è´¹ï¼Œè¿˜å¢åŠ äº†å¾ˆå¤šå¹¶æ²¡æœ‰ä»»ä½•ä»·å€¼çš„è¿ç»´ç®¡ç†å·¥ä½œã€‚</p><p>æ—¢ç„¶æˆ‘ä»¬å«Œå¼ƒæ‰‹åŠ¨åœ¨å¤šå°ä¸»æœºä¸­éƒ¨ç½²å®¹å™¨è¿‡äºéº»çƒ¦ï¼Œå°†å…¶äº¤ç»™é›†ç¾¤ç®¡ç†å’Œè°ƒåº¦ç³»ç»Ÿå»åšï¼Œé‚£ä¹ˆç»´æŠ¤è°ƒåº¦ç³»ç»ŸåŒæ ·ç¹æ‚çš„å·¥ä½œï¼Œæ˜¯ä¸æ˜¯ä¹Ÿå¯ä»¥äº¤ç»™åˆ«äººæ¥åšï¼Œå¤–åŒ…å‡ºå»å‘¢ï¼Ÿ</p><p>æŒ‰ç…§ç²¾ç›Šæ€æƒ³ï¼Œè¿™äº›å’Œæ ¸å¿ƒä¸šåŠ¡ç›®æ ‡æ— å…³ï¼Œä¸èƒ½å¸¦æ¥ä»»ä½•ç”¨æˆ·ä»·å€¼çš„è¿‡ç¨‹ï¼Œéƒ½å±äºæµªè´¹è¡Œä¸ºï¼Œéƒ½éœ€è¦æå‡ºã€‚</p><p>è¿™æ—¶å€™ï¼Œå‡ºç°äº† Serverless infrastructure æœåŠ¡ï¼Œæœ€æ—©çš„æ¯”å¦‚å›½å†…çš„ <a href="https://hyper.sh/" target="_blank" rel="noopener">hyper.sh</a> ï¼ˆ2016.8 GAï¼‰ï¼Œä»¥åŠå»å¹´å‘å¸ƒçš„ AWS çš„ Fargateï¼ˆ2017.12ï¼‰ï¼Œå¾®è½¯çš„ ACIï¼ˆAzure Container Instanceï¼Œ2017.7ï¼‰ ç­‰ã€‚</p><p>ä»¥ <a href="http://hyper.sh" target="_blank" rel="noopener">hyper.sh</a> ä¸ºä¾‹ï¼Œä½¿ç”¨èµ·æ¥å’Œ Docker éå¸¸ç±»ä¼¼ï¼Œå¯ä»¥å°†æœ¬åœ°çš„ Docker ä½“éªŒåŸå°ä¸åŠ¨çš„æ¬åˆ°äº‘ç«¯ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ brew install hyper  </span><br><span class="line">$ hyper pull mysql  </span><br><span class="line">$ hyper run mysql  </span><br><span class="line">MySQL is running...  </span><br><span class="line">$ hyper run --link mysql wordpress  </span><br><span class="line">WordPress is running...  </span><br><span class="line">$ hyper fip attach 22.33.44.55 wordpress  </span><br><span class="line">22.33.44.55 </span><br><span class="line">$ open 22.33.44.55</span><br></pre></td></tr></table></figure><p>å¤§éƒ¨åˆ†å‘½ä»¤ä» <code>docker</code> æ¢æˆ <code>hyper</code> å°±å¯ä»¥äº†ï¼Œä½“éªŒå¦‚åŒä½¿ç”¨ Docker ä¸€æ¨¡ä¸€æ ·ï¼Œç¬¬ä¸€æ¬¡çœ‹åˆ°è¿™æ ·çš„åº”ç”¨ç»™äººçš„æ–°å¥‡æ„Ÿï¼Œå¹¶ä¸äºšäºå½“åˆçš„ Docker ã€‚</p><p>ä½¿ç”¨ Serverless infrastructureï¼Œæˆ‘ä»¬å¯ä»¥å†ä¸å¿…ä¸ºå¦‚ä¸‹äº‹æƒ…çƒ¦æ¼ï¼š</p><ul><li>ä¸å¿…å†å»è´¹å¿ƒé€‰æ‹© VM å®ä¾‹çš„ç±»å‹ï¼Œéœ€è¦å¤šå°‘ CPU å’Œå†…å­˜</li><li>ä¸å¿…å†æ‹…å¿ƒä½¿ç”¨ä»€ä¹ˆç‰ˆæœ¬çš„ Docker å’Œé›†ç¾¤ç®¡ç†è½¯ä»¶</li><li>ä¸å¿…æ‹…å¿ƒ VM å†…ä¸­é—´ä»¶çš„å®‰å…¨æ¼æ´</li><li>ä¸å¿…æ‹…å¿ƒé›†ç¾¤èµ„æºåˆ©ç”¨ç‡å¤ªä½</li><li>ä»ä¸ºèµ„æºæ± ä»˜è´¹å˜ä¸ºä¸ºè¿è¡Œä¸­çš„å®¹å™¨ä»˜è´¹</li><li>å®Œå…¨ä¸å¯å˜åŸºç¡€è®¾æ–½</li><li>ä¸ç”¨å› ä¸º ps æ—¶çœ‹åˆ°å„ç§æ— èŠçš„ agent è€Œå¿ƒç†è†ˆåº”</li></ul><p>æˆ‘ä»¬éœ€è¦åšçš„å°±æ˜¯å®‰å¿ƒå†™è‡ªå·±çš„ä¸šåŠ¡åº”ç”¨ï¼Œæ„å»ºè‡ªå·±çš„é•œåƒï¼Œé€‰æ‹©åˆé€‚çš„å®¹å™¨å¤§å°ï¼Œä»˜é’±ç»™ cloud å‚å•†ï¼Œè®©ä»–ä»¬æŠŠç³»ç»Ÿåšå¥½ï¼Œè‚¡ç¥¨æ¶¨é«˜é«˜ã€‚</p><h2><span id="fargateæ­¤å¤„ä¹Ÿå¯ä»¥æ¢åš-aci-å¤§å‚è¡¨æ€">Fargateï¼ˆæ­¤å¤„ä¹Ÿå¯ä»¥æ¢åš ACI ï¼‰ï¼šå¤§å‚è¡¨æ€</span></h2><p>å°½ç®¡ AWS ä¸åƒ GCP é‚£æ ·â€œçƒ­è¡·â€äºå®¹å™¨ï¼Œä½†æ˜¯ AWS ä¹Ÿè¿˜æ˜¯æ—©å°±æä¾›äº† ECSï¼ˆElastic Container Serviceï¼‰æœåŠ¡ã€‚</p><p>å»å¹´å‘å¸ƒçš„ AWS Fargate åˆ™æ˜¯ä¸ªæ— æœåŠ¡å™¨çš„å®¹å™¨æœåŠ¡ï¼ŒFargate æ˜¯ä¸ºäº†å®ç° AWS çš„å®¹å™¨æœåŠ¡ï¼Œæ¯”å¦‚ ECSï¼ˆElastic Container Serviceï¼‰ å’Œ EKSï¼ˆElastic Kubernetes Serviceï¼‰ ç­‰ï¼Œå°†å®¹å™¨è¿è¡Œæ‰€éœ€è¦çš„åŸºç¡€è®¾æ–½è¿›è¡ŒæŠ½è±¡åŒ–çš„æŠ€æœ¯ï¼Œå¹¶ä¸”ç°åœ¨ ECS å·²ç»å¯ä»¥ç›´æ¥ä½¿ç”¨ Fargateã€‚</p><p>å’Œæä¾›è™šæ‹Ÿæœºçš„ EC2 ä¸åŒï¼ŒFargate æä¾›çš„æ˜¯å®¹å™¨è¿è¡Œå®ä¾‹ï¼Œç”¨æˆ·ä»¥å®¹å™¨ä½œä¸ºåŸºæœ¬çš„è¿ç®—å•ä½ï¼Œè€Œä¸å¿…æ‹…å¿ƒåº•å±‚ä¸»æœºå®ä¾‹çš„ç®¡ç†ï¼Œç”¨æˆ·åªéœ€å»ºç«‹å®¹å™¨é•œåƒï¼ŒæŒ‡å®šæ‰€éœ€è¦çš„ CPU å’Œå†…å­˜å¤§å°ï¼Œè®¾ç½®ç›¸åº”çš„ç½‘ç»œå’ŒIAMï¼ˆèº«åˆ†ç®¡ç†ï¼‰ç­–ç•¥å³å¯ã€‚</p><p>å¯¹äºå‰é¢æˆ‘ä»¬çš„ç–‘é—®ï¼ŒAWS çš„ç­”æ¡ˆæ˜¯åŸºç¡€è®¾æ–½çš„å‘æˆ‘ä»¬æ¥å¡«ï¼Œä½ ä»¬åªéœ€è¦ä¸“å¿ƒå†™å¥½è‡ªå·±çš„åº”ç”¨ç¨‹åºå°±è¡Œäº†ï¼Œä½ ä¸å¿…æ‹…å¿ƒå¯åŠ¨å¤šå°‘èµ„æºï¼Œæˆ‘ä»¬æ¥å¸®ä½ è¿›è¡Œå®¹é‡ç®¡ç†ï¼Œä½ åªéœ€è¦ä¸ºä½ çš„ä½¿ç”¨ä»˜è´¹å°±è¡Œäº†ã€‚</p><p>å¯ä»¥è¯´ Fargate å’Œ Lambda ç­‰äº§å“éƒ½è¯ç”Ÿäºæ­¤å“²å­¦ä¹‹ä¸‹ã€‚</p><p>ç»ˆäºå¯ä»¥ä¸“å¿ƒç¼–å†™è‡ªå·±æœ€æ“…é•¿çš„ CRUD äº†ï¼Œhappyï¼Œhappyã€‚</p><h2><span id="serverless-infrastructure-vs-serverless-compute">Serverless infrastructure vs Serverless compute</span></h2><p>å†å¤šè¯´å‡ å¥ï¼Œä¸»è¦æ˜¯ä¸ºäº†å¸®åŠ©å¤§å®¶è¾¨åˆ«ä¸¤ç§ä¸åŒçš„æ— æœåŠ¡å™¨æ¶æ„ï¼šæ— æœåŠ¡å™¨è®¡ç®—å’Œæ— æœåŠ¡å™¨åŸºç¡€è®¾æ–½ã€‚</p><p>è¯´å®è¯ä¸€ä¸‹å­ä» EC2 è¿ç§»åˆ° Lambda ï¼Œè¿™æ­¥å­ç¡®å®æœ‰ç‚¹å¤§ã€‚</p><p>Lambda ç­‰ FaaS äº§å“è™½ç„¶æ›´åŠ ç®€å•ï¼Œä½†æ˜¯å­˜åœ¨æœ‰å¦‚ä¸‹å¾ˆå¤šç¼ºç‚¹ï¼š</p><ul><li>ä½¿ç”¨åœºæ™¯ï¼šLambda æ›´é€‚åˆç”¨æˆ·æ“ä½œæˆ–äº‹ä»¶é©±åŠ¨ï¼Œä¸é€‚åˆåšå®ˆæŠ¤æœåŠ¡ã€æ‰¹å¤„ç†ç­‰ä¸šåŠ¡</li><li>çµæ´»æ€§ï¼šå›ºå®šçš„å†…æ ¸ã€AMIç­‰ï¼Œæ— æ³•å®šåˆ¶</li><li>èµ„æºé™åˆ¶ï¼šæ–‡ä»¶ç³»ç»Ÿã€å†…å­˜ã€è¿›ç¨‹çº¿ç¨‹æ•°ã€è¯·æ±‚ body å¤§å°ä»¥åŠæ‰§è¡Œæ—¶é—´ç­‰å¾ˆå¤šé™åˆ¶</li><li>ç¼–ç¨‹è¯­è¨€é™åˆ¶</li><li>å¾ˆéš¾åšæœåŠ¡æ²»ç†</li><li>ä¸æ–¹ä¾¿è°ƒè¯•å’Œæµ‹è¯•</li></ul><p>Lambda å’Œå®¹å™¨ç›¸æ¯”æœ€å¤§çš„ä¼˜åŠ¿å°±æ˜¯è¿ç»´å·¥ä½œæ›´å°‘ï¼ŒåŸºæœ¬æ²¡æœ‰ï¼Œè€Œä¸”è®¡è´¹æ›´ç²¾ç¡®ï¼Œä¸éœ€è¦ä¸ºæµªè´¹çš„è®¡ç®—èµ„æºä¹°å•ï¼Œè€Œä¸” Lambda å“åº”æ›´å¿«ï¼Œæ‰©å®¹æ•ˆç‡ä¼šé«˜ä¸€äº›ã€‚</p><p>å¯ä»¥è®¤ä¸º Fargate ç­‰å®¹å™¨å®ä¾‹ï¼Œå°±æ˜¯ç»“åˆäº† EC2 å®ä¾‹å’Œ Lambda ä¼˜ç‚¹çš„äº§å“ï¼Œæ—¢åƒ Lambda ä¸€æ ·è½»é‡ï¼Œæ›´å…³æ³¨æ ¸å¿ƒçš„åº”ç”¨ç¨‹åºï¼Œè¿˜èƒ½åƒ EC2 ä¸€æ ·å¸¦æ¥å¾ˆå¤§çš„çµæ´»æ€§å’Œå¯æ§æ€§ã€‚</p><p>äº‘åŸç”Ÿä¼šç»™ç”¨æˆ·æ›´å¤šçš„æ§åˆ¶ï¼Œä½†æ˜¯éœ€è¦ç”¨æˆ·æ›´å°‘çš„æŠ•å…¥å’Œè´Ÿæ‹…ã€‚</p><p>Serverless infrastructure å¯ä»¥è®©å®¹å™¨æ›´åŠ  cloud nativeã€‚</p><h2><span id="fully-managedå¤§åŠ¿æ‰€è¶‹">fully managedï¼šå¤§åŠ¿æ‰€è¶‹</span></h2><p>æ‰€è°“çš„ fully managedï¼Œå¯ä»¥ç†è§£ä¸ºç”¨æˆ·èŠ±è´¹å¾ˆå°‘çš„æˆæœ¬ï¼Œå°±å¯ä»¥è·å¾—æƒ³è¦çš„äº§å“ã€æœåŠ¡å¹¶å¯ä»¥è¿›è¡Œç›¸åº”çš„æ§åˆ¶ã€‚</p><p>è¿™ä¸¤å¤©ï¼Œé˜¿é‡Œäº‘å‘å¸ƒäº† Serverless Kubernetes ï¼ŒServerless Kubernetes ä¸åŸç”Ÿçš„ Kubernetes å®Œå…¨å…¼å®¹ï¼Œå¯ä»¥é‡‡ç”¨æ ‡å‡†çš„ APIã€CLI æ¥éƒ¨ç½²å’Œç®¡ç†åº”ç”¨ï¼Œè¿˜å¯ä»¥ç»§ç»­ä½¿ç”¨å„ç§ä¼ ç»Ÿèµ„äº§ï¼Œå¹¶ä¸”è¿˜èƒ½è·å¾—ä¼ä¸šçº§çš„é«˜å¯ç”¨å’Œå®‰å…¨æ€§ä¿éšœã€‚éš¾é“ä»¥åæˆ‘ä»¬è¿ Kubernetes ä¹Ÿä¸ç”¨è‡ªå·±è£…äº†ï¼Œå¤§éƒ¨åˆ†äººåªéœ€è¦æŒæ¡ kubectl å‘½ä»¤å°±å¥½äº†ã€‚</p><p>IaaS çš„å‡ºç°ï¼Œè®©æˆ‘ä»¬ä¸¢å¼ƒäº†å„ç§ provision å·¥å…·ï¼ŒåŒæ—¶ï¼Œå„ç§ configuration management å·¥å…·å¦‚é›¨åæ˜¥ç¬‹èˆ¬çš„å‡ºç°å’Œæ™®åŠï¼›å®¹å™¨çš„å‡ºç°ï¼Œåˆè®©æˆ‘ä»¬æ‰”æ‰äº†åˆšä¹°è¿˜æ²¡çœ‹å‡ é¡µçš„å„ç§ Chef/Puppet å…¥é—¨/åœ£ç»ï¼ŒåŒ†å¿™å­¦èµ· Kubernetesï¼›æœ‰äº† Serverless infrastructureï¼Œä¹Ÿå·®ä¸å¤šå¯ä»¥å’Œå„ç§ç¼–æ’å·¥å…·è¯´æ‹œæ‹œäº†ã€‚</p><p>ä¸ç®¡ä½ ä»¬æ˜¯åœ¨å•ä½“è½¬å¾®æœåŠ¡ï¼Œè¿˜æ˜¯åœ¨ä¼ ç»Ÿä¸Šäº‘ã€è½¬å®¹å™¨ï¼Œä¼°è®¡å¤§å®¶éƒ½ä¼šå–œæ¬¢ä¸Š fully managed çš„æœåŠ¡ï¼Œäººäººéƒ½åš Opsï¼Œå¾ˆå¤šè¿ç»´å·¥ä½œéƒ½å¯ä»¥å…±åŒåˆ†æ‹…ã€‚å½“ç„¶ï¼Œä¹Ÿä¼šæœ‰ä¸€éƒ¨åˆ†è¿ç»´å·¥ç¨‹å¸ˆæ©é¢è€Œé€ƒã€‚</p><blockquote><p>æœ¬æ–‡è½¬è½½è‡ªï¼šã€Œ äººé—´æŒ‡å— ã€ï¼ŒåŸæ–‡ï¼š<a href="https://tinyurl.com/exvzu9tb" target="_blank" rel="noopener">https://tinyurl.com/exvzu9tb</a> ï¼Œç‰ˆæƒå½’åŸä½œè€…æ‰€æœ‰ã€‚æ¬¢è¿æŠ•ç¨¿ï¼ŒæŠ•ç¨¿é‚®ç®±: <a href="mailto:editor@hi-linux.com">editor@hi-linux.com</a>ã€‚</p></blockquote></div><script src="https://my.openwrite.cn/js/readmore.js" type="text/javascript"></script><script>var isMobile = navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i);if (!isMobile) {    var btw = new BTWPlugin();    btw.init({        "id": "vip-container",        "blogId": "10135-1588830050631-449",        "name": "ã€Œå¥‡å¦™çš„ Linux ä¸–ç•Œã€",        "qrcode": "https://www.hi-linux.com/img/wechat/mp_qrcode_12.jpg",        "keyword": "VIP"    });}</script>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä¸–ç•Œä¸Šæœ‰ä¸¤ç§åŸºç¡€è®¾æ–½ï¼Œä¸€ç§æ˜¯æ‹¿æ¥ä¸»ä¹‰ï¼Œå¦ä¸€ç§æ˜¯è‡ªä¸»å¯æ§ã€‚&lt;/p&gt;
&lt;p&gt;åŸè°…æˆ‘ä¹Ÿè¹­ä¸ªå·²ç»è¢«æµ‡ç­çš„ã€æ²¡æ€ä¹ˆç«èµ·æ¥çš„çƒ­ç‚¹ã€‚ä¸è¿‡æˆ‘ä»¬å–œæ¬¢çš„æ˜¯æ‹¿æ¥ä¸»ä¹‰ï¼Œ&lt;strong&gt;å¤Ÿç”¨å°±è¡Œï¼Œä¸æƒ³ä¹Ÿä¸éœ€è¦è¿‡å¤šçš„æ§åˆ¶ï¼Œä¹Ÿä¸æƒ³æƒ¹è¿‡å¤šçš„éº»çƒ¦&lt;/strong&gt;ï¼Œä¹Ÿå°±æ˜¯ fully managedã€‚&lt;/p&gt;
&lt;p&gt;ä¹‹æ‰€ä»¥æƒ³åˆ°å†™è¿™ç¯‡æ–‡ç« ï¼Œæºäºå‰å‡ å¤©çœ‹åˆ°çš„è¿™ç¯‡æ¥è‡ªå¾®è½¯ Azure çš„åšå®¢å†…å®¹ï¼š &lt;a href=&quot;https://thenewstack.io/the-future-of-Kubernetes-is-serverless/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;The Future of Kubernetes Is Serverless&lt;/a&gt; ï¼Œç„¶ååˆé¡ºæ‰‹æ¸©ä¹ äº†ä¸€é AWS CTO æ‰€æ’°å†™çš„ &lt;a href=&quot;https://www.allthingsdistributed.com/2018/04/changing-calculus-containers-cloud.html&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Changing the calculus of containers in the cloud&lt;/a&gt; è¿™ç¯‡æ–‡ç« ã€‚è¿™ä¸¤ç¯‡æ–‡ç« ä½ è§‰å¾—æœ‰å¯èƒ½æœ‰å¹¿å‘Šçš„å«Œç–‘ï¼Œéƒ½æ˜¯åœ¨æ¨é”€è‡ªå®¶çš„å…±æœ‰äº‘æœåŠ¡ï¼Œä½†æ˜¯ä»”ç»†å“å‘³æ¯ä¸€å¥è¯ï¼Œæˆ‘å´è§‰å¾—å‡ ä¹æ²¡æœ‰å‡ å¥åºŸè¯ï¼Œéƒ½å¾ˆè¯´åˆ°ç‚¹å­ä¸Šï¼Œä½ å¯ä»¥ç‚¹å‡»è¿›å»çœ‹ä¸‹åŸæ–‡ã€‚&lt;/p&gt;
&lt;p&gt;æœ‰ä¸ªå‰æéœ€è¦è¯´æ˜çš„æ˜¯ï¼Œè¿™é‡Œçš„ Serverless æŒ‡çš„æ˜¯ Serverless infrastructureï¼Œè€Œä¸æ˜¯æˆ‘ä»¬å¸¸å¬åˆ°çš„ AWS Lambdaï¼ŒMicrosoft Azure Functions æˆ– Google Cloud Functions ç­‰å‡½æ•°ï¼ˆåŠŸèƒ½ï¼‰å³æœåŠ¡ï¼ˆFaaSï¼‰æŠ€æœ¯ï¼Œä¸ºäº†ä¾¿äºåŒºåˆ†ï¼Œæˆ‘ä»¬å°†è¿™äº› FaaS ç§°ä¸ºæ— æœåŠ¡å™¨è®¡ç®—ï¼Œå’Œæˆ‘ä»¬æœ¬æ–‡è¦ä»‹ç»çš„æ— æœåŠ¡å™¨åŸºç¡€è®¾æ–½è¿˜æ˜¯ä¸ä¸€æ ·çš„ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="å¾®æœåŠ¡" scheme="https://www.hi-linux.com/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/"/>
    
    
      <category term="æŠ€å·§" scheme="https://www.hi-linux.com/tags/%E6%8A%80%E5%B7%A7/"/>
    
      <category term="Linux" scheme="https://www.hi-linux.com/tags/Linux/"/>
    
      <category term="å¾®æœåŠ¡" scheme="https://www.hi-linux.com/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/"/>
    
  </entry>
  
  <entry>
    <title>GitHub æ˜Ÿæ ‡ 2.1 Kï¼Œå¯èƒ½æ˜¯æœ€ç®€å•å¥½ç”¨çš„çº¯æ–‡æœ¬æµç¨‹å›¾åˆ¶ä½œå·¥å…·</title>
    <link href="https://www.hi-linux.com/posts/16328.html"/>
    <id>https://www.hi-linux.com/posts/16328.html</id>
    <published>2022-01-02T01:00:00.000Z</published>
    <updated>2022-01-13T05:34:07.910Z</updated>
    
    <content type="html"><![CDATA[<div id="vip-container"><p>ä»Šå¤©è¦æ¨èä¸€ä¸ªå¯èƒ½æ˜¯æœ€ç®€å•çš„æµç¨‹å›¾åˆ¶ä½œå·¥å…·äº†ï¼Œå°ç¼–ç¬¬ä¸€æ¬¡ä½¿ç”¨å°±æœ‰ç‚¹ä¸Šå¤´ï¼Œçˆ±ä¸é‡Šæ‰‹ï¼Œå¿…é¡»è¦æ¨èç»™å¤§å®¶ã€‚</p><p>è¿™æ¬¾å·¥å…·å« <code>flowchart-fun</code>ï¼Œç»å¯¹æ˜¯æˆ‘è§è¿‡æœ€ç®€å•çš„æµç¨‹å›¾åˆ¶ä½œå·¥å…·ï¼Œä»»ä½•äººéƒ½å¯ä»¥ç®€å•çš„ä¸Šæ‰‹ã€‚æˆ‘ä»¬çœ‹ä¸€ä¸‹æ“ä½œç•Œé¢å¦‚ä¸‹ï¼š</p><p><img src="https://img.hi-linux.com/staticfile/image-20210813122631680-2021-08-13-Xxy5KF.png" alt></p><a id="more"></a><p>æµç¨‹å›¾çš„åˆ¶ä½œåŸç†å¾ˆç®€å•ï¼Œå›¾è¡¨ä¾æ¬¡ä»å·¦åˆ°å³ç”»ï¼Œæ¯ä¸€è¡Œä¸ºä¸€ä¸ªæ–¹å—ï¼Œç¼©è¿›å°±ä»£è¡¨å‘å³ç§»åŠ¨ï¼ŒåŒæ—¶ä¼šå¸¦æœ‰æ–¹å‘çš„ç®­å¤´ã€‚æ‰€ä»¥ä½¿ç”¨çš„è§„åˆ™å¾ˆç®€å•ï¼Œå°±è·Ÿæ­£å¸¸å†™ä½œä¸€æ ·ï¼Œç¼©è¿›å³å¯ã€‚è¿™ä¸ªå·¥å…·ä¸ç®¡æ˜¯ç”¨æ¥åšæ€ç»´å¯¼å›¾ï¼Œæˆ–è€…æ˜¯åšæµç¨‹å›¾éƒ½å¾ˆç®€å•ï¼Œå¯¹äºæˆ‘è¿™ç§ä¸å–œæ¬¢å»æ‹–æ‹½æ–¹å—çš„äººæ¥è¯´ï¼Œç®€ç›´å°±æ˜¯ç¥å™¨ã€‚</p><p>æ–‡å­—æè¿°ä½¿ç”¨æ–¹å¼å¯èƒ½æ¯”è¾ƒè‹ç™½ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹ç¤ºä¾‹ï¼Œæ¯•ç«Ÿæµç¨‹å›¾ä¸€èˆ¬æ˜¯ä¸€äº›æŒ‡å‘æ€§çš„ç»“æ„ã€‚</p><p><img src="https://img.hi-linux.com/staticfile/image-20210813123002512-2021-08-13-OPu5Bf.png" alt></p><p>ä»¥ä¸Šç¤ºä¾‹æ˜¯ä¸æ˜¯è¿˜æŒºç®€å•çš„ã€‚</p><p>å¦å¤–ä¸€ä¸ªå¥½å¤„ï¼Œç”¨æ–‡å­—è¡¨ç¤ºæµç¨‹å›¾çš„è¯ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„è¿½æº¯æ›´æ”¹çš„å†å²ã€‚åŒæ—¶åªè¦æŒ‰è§„åˆ™ä¹Ÿå¯ä»¥å¾ˆæ–¹ä¾¿è‡ªåŠ¨å»ç”Ÿæˆå¯¹åº”çš„æ–‡å­—è¡¨ç¤ºã€‚</p><blockquote><p>è¯•ç”¨ç½‘å€ï¼š<a href="https://flowchart.fun/" target="_blank" rel="noopener">https://flowchart.fun/</a></p></blockquote><p>æ›´å¤šé¡¹ç›®è¯¦æƒ…è¯·æŸ¥çœ‹å¼€æºé¡¹ç›®åœ°å€ï¼š<a href="https://github.com/tone-row/flowchart-fun" target="_blank" rel="noopener">https://github.com/tone-row/flowchart-fun</a></p><blockquote><p>æœ¬æ–‡è½¬è½½è‡ªï¼šã€Œ GitHubç²¾é€‰ ã€ï¼ŒåŸæ–‡ï¼š<a href="https://tinyurl.com/25htjd93" target="_blank" rel="noopener">https://tinyurl.com/25htjd93</a> ï¼Œç‰ˆæƒå½’åŸä½œè€…æ‰€æœ‰ã€‚æ¬¢è¿æŠ•ç¨¿ï¼ŒæŠ•ç¨¿é‚®ç®±: <a href="mailto:editor@hi-linux.com">editor@hi-linux.com</a>ã€‚</p></blockquote></div><script src="https://my.openwrite.cn/js/readmore.js" type="text/javascript"></script><script>var isMobile = navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i);if (!isMobile) {    var btw = new BTWPlugin();    btw.init({        "id": "vip-container",        "blogId": "10135-1588830050631-449",        "name": "ã€Œå¥‡å¦™çš„ Linux ä¸–ç•Œã€",        "qrcode": "https://www.hi-linux.com/img/wechat/mp_qrcode_12.jpg",        "keyword": "VIP"    });}</script>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä»Šå¤©è¦æ¨èä¸€ä¸ªå¯èƒ½æ˜¯æœ€ç®€å•çš„æµç¨‹å›¾åˆ¶ä½œå·¥å…·äº†ï¼Œå°ç¼–ç¬¬ä¸€æ¬¡ä½¿ç”¨å°±æœ‰ç‚¹ä¸Šå¤´ï¼Œçˆ±ä¸é‡Šæ‰‹ï¼Œå¿…é¡»è¦æ¨èç»™å¤§å®¶ã€‚&lt;/p&gt;
&lt;p&gt;è¿™æ¬¾å·¥å…·å« &lt;code&gt;flowchart-fun&lt;/code&gt;ï¼Œç»å¯¹æ˜¯æˆ‘è§è¿‡æœ€ç®€å•çš„æµç¨‹å›¾åˆ¶ä½œå·¥å…·ï¼Œä»»ä½•äººéƒ½å¯ä»¥ç®€å•çš„ä¸Šæ‰‹ã€‚æˆ‘ä»¬çœ‹ä¸€ä¸‹æ“ä½œç•Œé¢å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://img.hi-linux.com/staticfile/image-20210813122631680-2021-08-13-Xxy5KF.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
    
    </summary>
    
    
      <category term="Docker" scheme="https://www.hi-linux.com/categories/docker/"/>
    
    
      <category term="Linux" scheme="https://www.hi-linux.com/tags/Linux/"/>
    
      <category term="å·¥å…·" scheme="https://www.hi-linux.com/tags/%E5%B7%A5%E5%85%B7/"/>
    
      <category term="å¼€æº" scheme="https://www.hi-linux.com/tags/%E5%BC%80%E6%BA%90/"/>
    
  </entry>
  
  <entry>
    <title>æ¨èä¸€æ¬¾ GitHub æ˜Ÿæ ‡ 15.6K çš„ç¥å™¨ï¼Œå¯ä¸€é”®å°† MySQLã€PostgreSQLã€SQL Server ç­‰æ•°æ®åº“è½¬æ¢ä¸ºæ™ºèƒ½ç”µå­è¡¨æ ¼ï¼</title>
    <link href="https://www.hi-linux.com/posts/15719.html"/>
    <id>https://www.hi-linux.com/posts/15719.html</id>
    <published>2022-01-02T01:00:00.000Z</published>
    <updated>2022-01-13T05:34:07.914Z</updated>
    
    <content type="html"><![CDATA[<div id="vip-container"><p>ä¸çŸ¥é“å¤§å®¶äº†è§£ Airtable ä¹ˆï¼ŸAirtable æ˜¯æµ·å¤–å¤§åé¼é¼çš„åœ¨çº¿è¡¨æ ¼åº”ç”¨å·¥å…·ï¼ŒAirtable å»ºç«‹åœ¨è¿™æ ·ä¸€ä¸ªä¿¡å¿µä¸Šï¼šè½¯ä»¶ä¸åº”è¯¥å†³å®šä½ çš„å·¥ä½œæ–¹å¼ï¼Œè€Œåº”è¯¥ç”±ä½ å†³å®šè½¯ä»¶çš„å·¥ä½œæ–¹å¼ã€‚æˆ‘ä»¬çš„ä½¿å‘½æ˜¯ä½¿ä»»ä½•äººéƒ½èƒ½æ„å»ºå‡ºæ»¡è¶³è‡ªå·±éœ€æ±‚çš„å·¥å…·ï¼Œä»è€Œä½¿è½¯ä»¶å……åˆ†ä¸ªæ€§åŒ–ã€‚</p><a id="more"></a><p>ä»Šå¤©æ¨èä¸€ä¸ªå¯¹æ ‡ Airtable çš„å¼€æºäº§å“ NocoDBï¼Œç›®å‰æ”¯æŒå°† MySQLã€PostgreSQLã€SQL Serverã€SQLite å’Œ MariaDB è½¬æ¢ä¸ºä¸€ä¸ªæ™ºèƒ½çš„åœ¨çº¿ç”µå­è¡¨æ ¼ã€‚å®ƒä¸ä»…å¯ä»¥æŠŠæ•°æ®åº“å’Œå›¾ç‰‡ç­‰æ•°æ®è½¬åŒ–æˆè¡¨æ ¼çš„æ–¹å¼å±•ç°ï¼Œè¿˜æä¾›äº†å›¢é˜Ÿåä½œã€å·¥ä½œæµæ¥å…¥ä»¥åŠæ›´åŠ å¼€æ”¾ API æœåŠ¡ã€‚è®©å›¢é˜Ÿåœ¨æ•°æ®ä¸Šå·¥ä½œï¼Œæ•°æ®å°±åœ¨æ‰‹è¾¹ â€œå³è§†å³ç”¨â€ã€‚</p><p><img src="https://img.hi-linux.com/staticfile/OpenSourceAirtableAlternative-2021-07-30-9Ag2f4.png" alt></p><p>NocoDB ç›®å‰æ”¯æŒä¸°å¯Œçš„ç”µå­è¡¨æ ¼æ¥å£ï¼Œç®€å•æ˜“ç”¨ã€‚æ¯”å¦‚æœç´¢ã€æ’åºã€åˆ›å»º/åˆ†äº«è§†å›¾ç­‰åŠŸèƒ½éƒ½æ”¯æŒã€‚</p><p><img src="https://img.hi-linux.com/staticfile/image-20210730154904436-2021-07-30-4i4Q9Q.png" alt></p><p>å¦å¤–è¿˜æ”¯æŒä¸å…¶ä»–çš„ç¬¬ä¸‰æ–¹åº”ç”¨è¿›è¡Œè‡ªåŠ¨åŒ–çš„æµç¨‹è”åŠ¨ï¼Œæ¯”å¦‚èŠå¤©è½¯ä»¶ã€é‚®ä»¶ç­‰ã€‚åŒæ—¶æ”¯æŒä¸°å¯Œçš„ API ç”¨äºä¸ä½ ç°æœ‰çš„ç³»ç»Ÿå¯¹æ¥ï¼Œä»¥æ­¤ä¹Ÿèƒ½çœ‹å‡º NocoDB æ˜¯å®Œå…¨ä»¥å¼€æ”¾çš„ç”Ÿæ€æ¥å»ºè®¾çš„ã€‚</p><p><img src="https://img.hi-linux.com/staticfile/image-20210730154959452-2021-07-30-XACrDF.png" alt></p><p>ä¸‹å›¾æ˜¯ NocoDB ä¸ºä»€ä¹ˆå¼€å‘ä»¥åŠä½œè€…å¸Œæœ›è¾¾æˆçš„æ„¿æ™¯ã€‚å¤§æ¦‚æ„æ€æ˜¯ç°åœ¨ä½¿ç”¨ç”µå­è¡¨æ ¼çš„ç”¨æˆ·å¤ªå¤šäº†ï¼Œæ¯å¤©æœ‰è¶…è¿‡ 10 äº¿ï¼Œä½†æ˜¯ä¸ªäººç”µè„‘å®‰è£…çš„ç”µå­è¡¨æ ¼è®¡ç®—èƒ½åŠ›æœ‰é™ï¼Œè€Œè¿™äº›äººå¹¶ä¸ä¼šä½¿ç”¨åƒæ•°æ®åº“ä¸€æ ·çš„å·¥å…·ï¼Œè€Œç°çŠ¶ä¸€äº› SaaS å·¥å…·åœ¨ä½¿ç”¨ä½“éªŒä¸Šå¹¶ä¸æ˜¯å¾ˆå‹å¥½ã€‚nocodb å¸Œæœ›æä¾›ä¸€ä¸ªå¼€æ”¾çš„æ— ä»£ç çš„å¹³å°ï¼Œä»¥åœ¨çº¿ç”µå­è¡¨æ ¼çš„æ˜“æ“ä½œä¸ºåŸºç¡€ï¼Œå¸®åŠ©è¿™äº›åœ¨å•†ä¸šä¸Šæœ‰ç±»ä¼¼æ•°æ®è®¡ç®—éœ€æ±‚çš„ç”¨æˆ·ï¼Œäººäººéƒ½å¯ä½¿ç”¨ã€‚</p><p><img src="https://img.hi-linux.com/staticfile/image-20210730155031980-2021-07-30-cpjuKB.png" alt></p><p>æ›´å¤šé¡¹ç›®è¯¦æƒ…è¯·æŸ¥çœ‹é¡¹ç›®åœ°å€ï¼š<a href="https://github.com/nocodb/nocodb" target="_blank" rel="noopener">https://github.com/nocodb/nocodb</a></p><blockquote><p>æœ¬æ–‡è½¬è½½è‡ªï¼šã€Œ GitHubç²¾é€‰ ã€ï¼ŒåŸæ–‡ï¼š<a href="https://tinyurl.com/2h4t5sn3" target="_blank" rel="noopener">https://tinyurl.com/2h4t5sn3</a> ï¼Œç‰ˆæƒå½’åŸä½œè€…æ‰€æœ‰ã€‚æ¬¢è¿æŠ•ç¨¿ï¼ŒæŠ•ç¨¿é‚®ç®±: <a href="mailto:editor@hi-linux.com">editor@hi-linux.com</a>ã€‚</p></blockquote></div><script src="https://my.openwrite.cn/js/readmore.js" type="text/javascript"></script><script>var isMobile = navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i);if (!isMobile) {    var btw = new BTWPlugin();    btw.init({        "id": "vip-container",        "blogId": "10135-1588830050631-449",        "name": "ã€Œå¥‡å¦™çš„ Linux ä¸–ç•Œã€",        "qrcode": "https://www.hi-linux.com/img/wechat/mp_qrcode_12.jpg",        "keyword": "VIP"    });}</script>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä¸çŸ¥é“å¤§å®¶äº†è§£ Airtable ä¹ˆï¼ŸAirtable æ˜¯æµ·å¤–å¤§åé¼é¼çš„åœ¨çº¿è¡¨æ ¼åº”ç”¨å·¥å…·ï¼ŒAirtable å»ºç«‹åœ¨è¿™æ ·ä¸€ä¸ªä¿¡å¿µä¸Šï¼šè½¯ä»¶ä¸åº”è¯¥å†³å®šä½ çš„å·¥ä½œæ–¹å¼ï¼Œè€Œåº”è¯¥ç”±ä½ å†³å®šè½¯ä»¶çš„å·¥ä½œæ–¹å¼ã€‚æˆ‘ä»¬çš„ä½¿å‘½æ˜¯ä½¿ä»»ä½•äººéƒ½èƒ½æ„å»ºå‡ºæ»¡è¶³è‡ªå·±éœ€æ±‚çš„å·¥å…·ï¼Œä»è€Œä½¿è½¯ä»¶å……åˆ†ä¸ªæ€§åŒ–ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Linux" scheme="https://www.hi-linux.com/categories/Linux/"/>
    
    
      <category term="Linux" scheme="https://www.hi-linux.com/tags/Linux/"/>
    
      <category term="å¼€æº" scheme="https://www.hi-linux.com/tags/%E5%BC%80%E6%BA%90/"/>
    
      <category term="NocoDB" scheme="https://www.hi-linux.com/tags/NocoDB/"/>
    
  </entry>
  
  <entry>
    <title>15 ä¸ªå®ç”¨çš„ Kubernetes é›†ç¾¤èµ„æºæ¸…ç†å‘½ä»¤</title>
    <link href="https://www.hi-linux.com/posts/2396.html"/>
    <id>https://www.hi-linux.com/posts/2396.html</id>
    <published>2021-12-20T01:00:00.000Z</published>
    <updated>2021-12-20T06:21:52.466Z</updated>
    
    <content type="html"><![CDATA[<div id="vip-container"><blockquote><p>é•¿æ—¶é—´è¿è¡Œçš„é›†ç¾¤ï¼Œå¸¸ä¼šé¢ä¸´å„ç§èµ„æºè€—å°½çš„é—®é¢˜ï¼Œå¦å¤–ç£ç›˜ä¸è¶³æ—¶ Kubelet è¿˜ä¼šä¸»åŠ¨æ¸…ç†é•œåƒå¢åŠ ä¸ç¡®å®šå› ç´ ï¼Œæœ¬æ–‡æä¾›äº†ä¸€äº›å‘½ä»¤ç‰‡æ®µç”¨äºæ¸…ç†å·¥ä½œã€‚</p></blockquote><h2><span id="kubernetes-åŸºç¡€å¯¹è±¡æ¸…ç†">Kubernetes åŸºç¡€å¯¹è±¡æ¸…ç†</span></h2><ul><li>æ¸…ç† Evicted çŠ¶æ€çš„ Pod</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods --all-namespaces -o wide | grep Evicted | awk &#39;&#123;print $1,$2&#125;&#39; | xargs -L1 kubectl delete pod -n</span><br></pre></td></tr></table></figure><ul><li>æ¸…ç† Error çŠ¶æ€çš„ Pod</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods --all-namespaces -o wide | grep Error | awk &#39;&#123;print $1,$2&#125;&#39; | xargs -L1 kubectl delete pod -n</span><br></pre></td></tr></table></figure><ul><li>æ¸…ç† Completed çŠ¶æ€çš„ Pod</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods --all-namespaces -o wide | grep Completed | awk &#39;&#123;print $1,$2&#125;&#39; | xargs -L1 kubectl delete pod -n</span><br></pre></td></tr></table></figure><a id="more"></a><ul><li>æ¸…ç†æ²¡æœ‰è¢«ä½¿ç”¨çš„ PV</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl describe -A pvc | grep -E &quot;^Name:.*$|^Namespace:.*$|^Used By:.*$&quot; | grep -B 2 &quot;&lt;none&gt;&quot; | grep -E &quot;^Name:.*$|^Namespace:.*$&quot; | cut -f2 -d: | paste -d &quot; &quot; - - | xargs -n2 bash -c &#39;kubectl -n $&#123;1&#125; delete pvc $&#123;0&#125;&#39;</span><br></pre></td></tr></table></figure><ul><li>æ¸…ç†æ²¡æœ‰è¢«ç»‘å®šçš„ PVC</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pvc --all-namespaces | tail -n +2 | grep -v Bound | awk &#39;&#123;print $1,$2&#125;&#39; | xargs -L1 kubectl delete pvc -n</span><br></pre></td></tr></table></figure><ul><li>æ¸…ç†æ²¡æœ‰è¢«ç»‘å®šçš„ PV</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pv | tail -n +2 | grep -v Bound | awk &#39;&#123;print $1&#125;&#39; | xargs -L1 kubectl delete pv</span><br></pre></td></tr></table></figure><h2><span id="linux-æ¸…ç†">Linux æ¸…ç†</span></h2><ul><li>æŸ¥çœ‹ç£ç›˜å…¨éƒ¨ç©ºé—´</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ df -hl &#x2F;</span><br><span class="line"></span><br><span class="line">Filesystem      Size  Used Avail Use% Mounted on</span><br><span class="line">&#x2F;dev&#x2F;sda2       100G   47G   54G  47% &#x2F;</span><br></pre></td></tr></table></figure><ul><li>æŸ¥çœ‹æŒ‡å®šç›®å½•å ç”¨</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ du -sh .</span><br><span class="line"></span><br><span class="line">24G.</span><br></pre></td></tr></table></figure><ul><li>åˆ é™¤æŒ‡å®šå‰ç¼€çš„æ–‡ä»¶å¤¹</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cd &#x2F;nfsdata</span><br><span class="line">$ ls | grep archived- |xargs -L1 rm -r</span><br></pre></td></tr></table></figure><ul><li>æ¸…ç†åƒµå°¸è¿›ç¨‹</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ps -A -ostat,ppid | grep -e &#39;^[Zz]&#39; | awk &#39;&#123;print &#125;&#39; | xargs kill -HUP &gt; &#x2F;dev&#x2F;null 2&gt;&amp;1</span><br></pre></td></tr></table></figure><h2><span id="docker-æ¸…ç†">Docker æ¸…ç†</span></h2><ul><li>æŸ¥çœ‹ç£ç›˜ä½¿ç”¨æƒ…å†µ</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ docker system df</span><br><span class="line"></span><br><span class="line">TYPE                TOTAL               ACTIVE              SIZE                RECLAIMABLE</span><br><span class="line">Images              361                 23                  178.5GB             173.8GB (97%)</span><br><span class="line">Containers          29                  9                   6.682GB             6.212GB (92%)</span><br><span class="line">Local Volumes       4                   0                   3.139MB             3.139MB (100%)</span><br><span class="line">Build Cache         0                   0                   0B                  0B</span><br></pre></td></tr></table></figure><ul><li>æ¸…ç† none é•œåƒ</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker images | grep none | awk &#39;&#123;print $3&#125;&#39; | xargs docker rmi</span><br></pre></td></tr></table></figure><ul><li>æ¸…ç†ä¸å†ä½¿ç”¨çš„æ•°æ®å·</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker volume rm $(docker volume ls -q)</span><br></pre></td></tr></table></figure><p>æˆ–è€…</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker volume prune</span><br></pre></td></tr></table></figure><ul><li>æ¸…ç†ç¼“å­˜</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker builder prune</span><br></pre></td></tr></table></figure><ul><li>å…¨é¢æ¸…ç†</li></ul><p>åˆ é™¤å…³é—­çš„å®¹å™¨ã€æ— ç”¨çš„å­˜å‚¨å·ã€æ— ç”¨çš„ç½‘ç»œã€dangling é•œåƒï¼ˆæ—  tag é•œåƒï¼‰</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker system prune -f</span><br></pre></td></tr></table></figure><ul><li>æ¸…ç†æ­£åˆ™åŒ¹é…ä¸Šçš„é•œåƒ</li></ul><p>è¿™é‡Œæ¸…ç†çš„æ˜¯ <code>master-8bcf8d7-20211206-111155163</code> æ ¼å¼çš„é•œåƒã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker images |grep -E &quot;([0-9a-z]*[-])&#123;3,&#125;[0-9]&#123;9&#125;&quot; |awk &#39;&#123;print $3&#125;&#39; | xargs docker rmi</span><br></pre></td></tr></table></figure><h2><span id="è®¾ç½®å®šæ—¶">è®¾ç½®å®šæ—¶</span></h2><ul><li>æŸ¥çœ‹å®šæ—¶ä»»åŠ¡</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ crontab -l</span><br></pre></td></tr></table></figure><ul><li>è®¾ç½®å®šæ—¶ä»»åŠ¡</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ crontab -e</span><br></pre></td></tr></table></figure><p>æ–‡æœ¬æ–°å¢å®šæ—¶ä»»åŠ¡</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">*&#x2F;35 *&#x2F;6 * * *  docker images | grep none | awk &#39;&#123;print $3&#125;&#39; | xargs docker rmi</span><br><span class="line">45 1 * * * docker system prune -f</span><br></pre></td></tr></table></figure><p>è¿™é‡Œç¬¬ä¸€ä¸ªä»»åŠ¡æ˜¯æ¯éš”å…­ä¸ªå°æ—¶çš„ç¬¬ 35 åˆ†é’Ÿæ‰§è¡Œï¼Œç¬¬äºŒä¸ªä»»åŠ¡æ¯å¤©çš„ 1 æ—¶ 45 åˆ†æ‰§è¡Œã€‚</p><ul><li>å®šæ—¶ä»»åŠ¡çš„æ ¼å¼</li></ul><p>è®¾ç½®å®šæ—¶æ ¼å¼: <code>* * * * * shell</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ç¬¬ä¸€ä¸ªæ˜Ÿå·ï¼Œminuteï¼Œåˆ†é’Ÿï¼Œå€¼ä¸º 0-59</span><br><span class="line">ç¬¬äºŒä¸ªæ˜Ÿå·ï¼Œhourï¼Œå°æ—¶ï¼Œå€¼ä» 0-23</span><br><span class="line">ç¬¬ä¸‰ä¸ªæ˜Ÿå·ï¼Œdayï¼Œå¤©ï¼Œå€¼ä¸ºä» 1-31</span><br><span class="line">ç¬¬å››ä¸ªæ˜Ÿå·ï¼Œmonthï¼Œæœˆï¼Œå€¼ä¸ºä» 1-12 æœˆï¼Œæˆ–è€…ç®€å†™çš„è‹±æ–‡ï¼Œæ¯”å¦‚ Novã€Feb ç­‰</span><br><span class="line">ç¬¬äº”ä¸ªæ˜Ÿå·ï¼Œweek å‘¨ï¼Œå€¼ä¸ºä» 0-6 æˆ–è€…ç®€å†™çš„è‹±æ–‡ï¼ŒWenã€Tur ç­‰ï¼Œä»£è¡¨å‘¨å‡ ï¼Œå…¶ä¸­ 0 ä»£è¡¨å‘¨æœ«</span><br></pre></td></tr></table></figure><blockquote><p>æœ¬æ–‡è½¬è½½è‡ªï¼šã€Œ é™ˆå°‘æ–‡çš„ç½‘ç«™ ã€ï¼ŒåŸæ–‡ï¼š<a href="https://tinyurl.com/yckjyedn" target="_blank" rel="noopener">https://tinyurl.com/yckjyedn</a> ï¼Œç‰ˆæƒå½’åŸä½œè€…æ‰€æœ‰ã€‚æ¬¢è¿æŠ•ç¨¿ï¼ŒæŠ•ç¨¿é‚®ç®±: <a href="mailto:editor@hi-linux.com">editor@hi-linux.com</a>ã€‚</p></blockquote></div><script src="https://my.openwrite.cn/js/readmore.js" type="text/javascript"></script><script>var isMobile = navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i);if (!isMobile) {    var btw = new BTWPlugin();    btw.init({        "id": "vip-container",        "blogId": "10135-1588830050631-449",        "name": "ã€Œå¥‡å¦™çš„ Linux ä¸–ç•Œã€",        "qrcode": "https://www.hi-linux.com/img/wechat/mp_qrcode_12.jpg",        "keyword": "VIP"    });}</script>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;é•¿æ—¶é—´è¿è¡Œçš„é›†ç¾¤ï¼Œå¸¸ä¼šé¢ä¸´å„ç§èµ„æºè€—å°½çš„é—®é¢˜ï¼Œå¦å¤–ç£ç›˜ä¸è¶³æ—¶ Kubelet è¿˜ä¼šä¸»åŠ¨æ¸…ç†é•œåƒå¢åŠ ä¸ç¡®å®šå› ç´ ï¼Œæœ¬æ–‡æä¾›äº†ä¸€äº›å‘½ä»¤ç‰‡æ®µç”¨äºæ¸…ç†å·¥ä½œã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;Kubernetes-åŸºç¡€å¯¹è±¡æ¸…ç†&quot;&gt;Kubernetes åŸºç¡€å¯¹è±¡æ¸…ç†&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;æ¸…ç† Evicted çŠ¶æ€çš„ Pod&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ kubectl get pods --all-namespaces -o wide | grep Evicted | awk &amp;#39;&amp;#123;print $1,$2&amp;#125;&amp;#39; | xargs -L1 kubectl delete pod -n&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;ul&gt;
&lt;li&gt;æ¸…ç† Error çŠ¶æ€çš„ Pod&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ kubectl get pods --all-namespaces -o wide | grep Error | awk &amp;#39;&amp;#123;print $1,$2&amp;#125;&amp;#39; | xargs -L1 kubectl delete pod -n&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;ul&gt;
&lt;li&gt;æ¸…ç† Completed çŠ¶æ€çš„ Pod&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ kubectl get pods --all-namespaces -o wide | grep Completed | awk &amp;#39;&amp;#123;print $1,$2&amp;#125;&amp;#39; | xargs -L1 kubectl delete pod -n&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
      <category term="å¾®æœåŠ¡" scheme="https://www.hi-linux.com/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/"/>
    
    
      <category term="æŠ€å·§" scheme="https://www.hi-linux.com/tags/%E6%8A%80%E5%B7%A7/"/>
    
      <category term="Linux" scheme="https://www.hi-linux.com/tags/Linux/"/>
    
      <category term="Kubernetes" scheme="https://www.hi-linux.com/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>äº‘åŸç”Ÿåˆ†å¸ƒå¼æ–‡ä»¶å­˜å‚¨ MinIO ä¿å§†çº§ä¸­æ–‡æ•™ç¨‹</title>
    <link href="https://www.hi-linux.com/posts/43710.html"/>
    <id>https://www.hi-linux.com/posts/43710.html</id>
    <published>2021-12-07T01:00:00.000Z</published>
    <updated>2021-12-08T03:11:30.366Z</updated>
    
    <content type="html"><![CDATA[<div id="vip-container"><blockquote><p><strong>MinIO - æ„å»ºé«˜æ€§èƒ½çš„äº‘åŸç”Ÿæ•°æ®çš„å¤šäº‘å¯¹è±¡å­˜å‚¨</strong></p></blockquote><p><code>MinIO</code> æä¾›å¼€æºã€é«˜æ€§èƒ½ã€å…¼å®¹ <code>s3</code> çš„å¯¹è±¡å­˜å‚¨ï¼Œä¸ºæ¯ä¸ªå…¬å…±äº‘ã€æ¯ä¸ª <code>Kubernetes</code> å‘è¡Œç‰ˆã€ç§æœ‰äº‘å’Œè¾¹ç¼˜äº‘ä¸­æ— ç¼è¿è¡Œï¼Œä½¿å…¶æˆä¸ºæ··åˆäº‘å’Œå¤šäº‘å¯¹è±¡å­˜å‚¨çš„é¢†å¯¼è€…ã€‚</p><ul><li><a href="https://min.io/" target="_blank" rel="noopener">MinIO è‹±æ–‡å®˜ç½‘åœ°å€</a></li><li><a href="http://www.minio.org.cn/" target="_blank" rel="noopener">MinIO ä¸­æ–‡å®˜ç½‘åœ°å€</a></li></ul><h2><span id="1-minio-çš„åº”ç”¨åœºæ™¯">1. MinIO çš„åº”ç”¨åœºæ™¯</span></h2><blockquote><p><strong>MinIO æ˜¯ä¸€ä¸ªéå¸¸è½»é‡çš„æœåŠ¡ï¼Œå¯ä»¥å¾ˆç®€å•çš„å’Œå…¶ä»–åº”ç”¨çš„ç»“åˆã€‚</strong></p></blockquote><p><code>MinIO</code> æ˜¯ä¸€ä¸ªåŸºäº <code>Apache License v2.0</code> å¼€æºåè®®çš„å¯¹è±¡å­˜å‚¨æœåŠ¡ã€‚å®ƒå…¼å®¹äºšé©¬é€Š <code>S3</code> äº‘å­˜å‚¨æœåŠ¡æ¥å£ï¼Œéå¸¸é€‚åˆäºå­˜å‚¨å¤§å®¹é‡éç»“æ„åŒ–çš„æ•°æ®ï¼Œä¾‹å¦‚å›¾ç‰‡ã€è§†é¢‘ã€æ—¥å¿—æ–‡ä»¶ã€å¤‡ä»½æ•°æ®å’Œå®¹å™¨/è™šæ‹Ÿæœºé•œåƒç­‰ï¼Œè€Œä¸€ä¸ªå¯¹è±¡æ–‡ä»¶å¯ä»¥æ˜¯ä»»æ„å¤§å°ï¼Œä» <code>KB</code> åˆ°æœ€å¤§ <code>TB</code> ä¸ç­‰ã€‚</p><ul><li>ç½‘ç›˜ : æµ·é‡æ–‡ä»¶</li><li>ç¤¾äº¤ç½‘ç«™ï¼šæµ·é‡å›¾ç‰‡</li><li>ç”µå•†ç½‘ç«™ï¼šæµ·é‡å•†å“å›¾ç‰‡</li><li>è§†é¢‘ç½‘ç«™ï¼šæµ·é‡è§†é¢‘æ–‡ä»¶</li></ul><p>å¯¹äºä¸­å°å‹ä¼ä¸šï¼Œå¦‚æœä¸é€‰æ‹©å­˜å‚¨ä¸Šäº‘ï¼Œé‚£ä¹ˆ <code>MinIO</code> æ˜¯ä¸ªä¸é”™çš„é€‰æ‹©ï¼Œéº»é›€è™½å°ï¼Œäº”è„ä¿±å…¨ã€‚å½“ç„¶ <code>MinIO</code> é™¤äº†ç›´æ¥ä½œä¸ºå¯¹è±¡å­˜å‚¨ä½¿ç”¨ï¼Œè¿˜å¯ä»¥ä½œä¸ºäº‘ä¸Šå¯¹è±¡å­˜å‚¨æœåŠ¡çš„ç½‘å…³å±‚ï¼Œæ— ç¼å¯¹æ¥åˆ° <code>Amazon S3</code> ç­‰ã€‚</p><a id="more"></a><h2><span id="2-minio-çš„ç³»ç»Ÿç‰¹ç‚¹">2. MinIO çš„ç³»ç»Ÿç‰¹ç‚¹</span></h2><blockquote><p><strong>ä»‹ç» MinIO æœåŠ¡çš„ä¸»è¦ç‰¹ç‚¹å’Œç‰¹æ€§</strong></p></blockquote><ul><li>[1] é«˜æ€§èƒ½<ul><li><code>MinIO</code> æ˜¯å…¨çƒé¢†å…ˆçš„å¯¹è±¡å­˜å‚¨å…ˆé”‹ï¼Œåœ¨æ ‡å‡†ç¡¬ä»¶ä¸Šï¼Œè¯»/å†™é€Ÿåº¦ä¸Šé«˜è¾¾ <code>183GB/s</code> å’Œ<code> 171GB/s</code>ï¼Œå·²ç»æˆä¸º <code>Hadoop HDFS</code> çš„æ›¿ä»£å“ã€‚</li><li><code>MinIO</code> ç”¨ä½œäº‘åŸç”Ÿåº”ç”¨ç¨‹åºçš„ä¸»è¦å­˜å‚¨ï¼Œä¸ä¼ ç»Ÿå¯¹è±¡å­˜å‚¨ç›¸æ¯”ï¼Œäº‘åŸç”Ÿåº”ç”¨ç¨‹åºéœ€è¦æ›´é«˜çš„ååé‡å’Œæ›´ä½çš„å»¶è¿Ÿã€‚è€Œè¿™äº›éƒ½æ˜¯ <code>MinIO</code> èƒ½å¤Ÿè¾¾æˆçš„æ€§èƒ½æŒ‡æ ‡ã€‚</li></ul></li></ul><p><img src="https://img.hi-linux.com/staticfile/minio-file-storage-01-2021-12-06-g5KIqw.png" alt="MinIOåˆ†å¸ƒå¼æ–‡ä»¶å­˜å‚¨ - é«˜æ€§èƒ½"></p><ul><li>[2] å¯æ‰©å±•æ€§<ul><li><code>MinIO</code> ä¸€ç›´ç§‰æ‰¿ç€ â€œç®€å•å¯æ‰©å±•â€ çš„ç†å¿µï¼Œä¸ºå¯¹è±¡å­˜å‚¨å¸¦æ¥äº†ä¸€ä¸ªç®€å•çš„ç¼©æ”¾æ¨¡å‹ã€‚å€ŸåŠ©åœ¨æ­¤åŸºç¡€ä¹‹ä¸Šï¼Œå¯ä»¥å®ç° <code>MinIO</code> ä»å•ä¸ªç¾¤é›†åˆ°å…¶ä»– <code>MinIO</code> ç¾¤é›†è”åˆä½¿ç”¨çš„æƒ…å†µï¼Œå¹¶ä¸”åœ¨éœ€è¦æ—¶å¯ä»¥è·¨è¶Šå¤šä¸ªä¸åŒçš„æ•°æ®ä¸­å¿ƒã€‚</li></ul></li></ul><p><img src="https://img.hi-linux.com/staticfile/minio-file-storage-02-2021-12-06-SDx7Q3.png" alt="MinIOåˆ†å¸ƒå¼æ–‡ä»¶å­˜å‚¨ - å¯æ‰©å±•æ€§"></p><ul><li>[3] å¼€æ”¾å…¨éƒ¨æºä»£ç  + ä¼ä¸šçº§æ”¯æŒ<ul><li><code>MinIO</code> åŸºäº <code>Apache V2 license</code> çš„ <code>100%</code> å¼€æ”¾æºä»£ç çš„äº§å“ã€‚</li><li>å®¢æˆ·èƒ½å¤Ÿè‡ªåŠ¨çš„ã€æ— é™åˆ¶ã€è‡ªç”±å…è´¹ä½¿ç”¨å’Œé›†æˆ MinIOã€è‡ªç”±çš„åˆ›æ–°å’Œåˆ›é€ ã€ è‡ªç”±çš„å»ä¿®æ”¹ã€è‡ªç”±çš„å†æ¬¡å‘è¡Œæ–°çš„ç‰ˆæœ¬å’Œè½¯ä»¶ã€‚å…¶éƒ¨ç½²çš„å¤šæ ·æ€§ä½¿è½¯ä»¶å˜å¾—æ›´åŠ åšå›ºï¼Œè¿™æ˜¯ä¸“æœ‰è½¯ä»¶æ— æ³•æä¾›çš„ã€‚</li></ul></li></ul><p><img src="https://img.hi-linux.com/staticfile/minio-file-storage-03-20211206173811532-2021-12-06-kKFztU.png" alt="MinIOåˆ†å¸ƒå¼æ–‡ä»¶å­˜å‚¨ - å¼€æ”¾å…¨éƒ¨æºä»£ç +ä¼ä¸šçº§æ”¯æŒ"></p><ul><li>[4] æ··åˆäº‘å’Œå¤šäº‘<ul><li>äºšé©¬é€Šäº‘çš„ <code>S3 API</code> æ˜¯åœ¨å…¨çƒèŒƒå›´å†…è¾¾åˆ°å…±è¯†çš„å¯¹è±¡å­˜å‚¨çš„åè®®ã€‚</li><li>å½“æ·»åŠ åˆ°æ•°ä»¥ç™¾ä¸‡è®¡çš„ç§æœ‰äº‘å®ä¾‹å’Œå¹¿æ³›çš„è¾¹ç¼˜éƒ¨ç½²æ—¶ï¼ŒMinIO æ˜¯æ··åˆäº‘çš„é¢†å¯¼è€…ã€‚</li></ul></li></ul><p><img src="https://img.hi-linux.com/staticfile/minio-file-storage-04-2021-12-06-Z6G0QE.png" alt="MinIOåˆ†å¸ƒå¼æ–‡ä»¶å­˜å‚¨ - æ··åˆäº‘å’Œå¤šäº‘"></p><p><strong>MinIOåˆ†å¸ƒå¼æ–‡ä»¶å­˜å‚¨ - æ··åˆäº‘å’Œå¤šäº‘</strong></p><ul><li>[5] ç®€å•è€Œå¼ºå¤§<ul><li>æç®€ä¸»ä¹‰æ˜¯ <code>MinIO</code> çš„æŒ‡å¯¼æ€§è®¾è®¡åŸåˆ™ã€‚ç®€å•æ€§å‡å°‘äº†å‡ºé”™çš„æœºä¼šï¼Œæé«˜äº†æ­£å¸¸è¿è¡Œæ—¶é—´ï¼Œæä¾›äº†å¯é æ€§ï¼ŒåŒæ—¶ç®€å•æ€§åˆæ˜¯æ€§èƒ½çš„åŸºç¡€ã€‚</li><li>åªéœ€ä¸‹è½½ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ç„¶åæ‰§è¡Œï¼Œå³å¯åœ¨å‡ åˆ†é’Ÿå†…å®‰è£…å’Œé…ç½® <code>MinIO</code>ã€‚<code>MinIO</code> å‡çº§æ˜¯é€šè¿‡ä¸€ä¸ªç®€å•å‘½ä»¤å®Œæˆçš„ï¼Œè¿™ä¸ªå‘½ä»¤å¯ä»¥æ— ä¸­æ–­çš„å®Œæˆ <code>MinIO</code> çš„å‡çº§ï¼Œå¹¶ä¸”ä¸éœ€è¦åœæœºå³å¯å®Œæˆå‡çº§æ“ä½œã€‚</li></ul></li></ul><p><img src="https://img.hi-linux.com/staticfile/minio-file-storage-05-20211206173756926-2021-12-06-dKfVuA.gif" alt="MinIOåˆ†å¸ƒå¼æ–‡ä»¶å­˜å‚¨ - ç®€å•è€Œå¼ºå¤§"></p><h2><span id="3-minio-çš„åŸºç¡€æ¦‚å¿µ">3. MinIO çš„åŸºç¡€æ¦‚å¿µ</span></h2><blockquote><p><strong>äº†è§£å¦‚ä¸‹åŸºç¡€æ¦‚å¿µï¼Œå¯ä»¥æ–¹ä¾¿çš„ç†è§£å…¶ä½¿ç”¨æ–¹å¼ã€‚</strong></p></blockquote><ul><li>å­˜å‚¨ç›¸å…³çš„æ¦‚å¿µ<ul><li>ä¸€ä¸ªå¯¹è±¡å­˜å‚¨åœ¨ä¸€ä¸ª <code>Set</code></li><li>ä¸€ä¸ªé›†ç¾¤åˆ’åˆ†ä¸ºå¤šä¸ª <code>Set</code></li><li>ä¸€ä¸ª <code>Set</code> ä¸­çš„ <code>Drive</code> å°½å¯èƒ½åˆ†å¸ƒåœ¨ä¸åŒçš„èŠ‚ç‚¹ä¸Š</li><li>ä¸€ä¸ª <code>Set</code> åŒ…å«çš„ <code>Drive</code> æ•°é‡æ˜¯å›ºå®šçš„ï¼Œé»˜è®¤ç”±ç³»ç»Ÿæ ¹æ®é›†ç¾¤è§„æ¨¡è‡ªåŠ¨è®¡ç®—</li></ul></li></ul><table><thead><tr><th style="text-align:left">æ¦‚å¿µåç§°</th><th style="text-align:left">å¯¹åº”å«ä¹‰è§£é‡Š</th></tr></thead><tbody><tr><td style="text-align:left"><code>Object</code></td><td style="text-align:left">å­˜å‚¨çš„åŸºæœ¬å¯¹è±¡ï¼›æ¯”å¦‚æ–‡ä»¶ã€å›¾ç‰‡ç­‰ç­‰</td></tr><tr><td style="text-align:left"><code>Bucket</code></td><td style="text-align:left">ç”¨äºå­˜å‚¨ <code>Object</code> çš„é€»è¾‘ç©ºé—´ï¼›ç›¸äº’ä¹‹é—´äº’ç›¸éš”ç¦»ï¼›ç±»ä¼¼äºç³»ç»Ÿä¸­çš„é¡¶å±‚æ–‡ä»¶å¤¹</td></tr><tr><td style="text-align:left"><code>Drive</code></td><td style="text-align:left">å³å­˜å‚¨æ•°æ®çš„ç£ç›˜ï¼›æ‰€æœ‰çš„å¯¹è±¡æ•°æ®éƒ½ä¼šå­˜å‚¨åœ¨ <code>Drive</code> é‡Œé¢</td></tr><tr><td style="text-align:left"><code>Set</code></td><td style="text-align:left">å³ä¸€ç»„ <code>Drive</code> çš„é›†åˆï¼›åˆ†å¸ƒå¼éƒ¨ç½²æ ¹æ®é›†ç¾¤è§„æ¨¡è‡ªåŠ¨åˆ’åˆ†ä¸€ä¸ªæˆ–å¤šä¸ª <code>Set</code></td></tr></tbody></table><ul><li><strong>çº åˆ ç  - EC - Erasure Code</strong></li></ul><p><code>MinIO</code> ä½¿ç”¨ <strong>çº åˆ ç å’Œæ ¡éªŒå’Œ</strong> æœºåˆ¶æ¥ä¿è¯é«˜å¯é æ€§ï¼Œå³ä¾¿ä¸¢å¤±ä¸€åŠæ•°é‡(<code>N/2</code>)çš„ç¡¬ç›˜ï¼Œä»ç„¶å¯ä»¥æ¢å¤æ•°æ®ã€‚çº åˆ ç æ˜¯ä¸€ç§æ¢å¤ä¸¢å¤±å’ŒæŸåæ•°æ®çš„æ•°å­¦ç®—æ³•ï¼Œ<code>MinIO</code> é‡‡ç”¨ <code>Reed-Solomon code</code> å°†å¯¹è±¡æ‹†åˆ†æˆ <code>N/2</code> æ•°æ®å’Œ <code>N/2</code> å¥‡å¶æ ¡éªŒå—ã€‚è¿™å°±æ„å‘³ç€å¦‚æœæ˜¯ <code>12</code> å—ç›˜ï¼Œä¸€ä¸ªå¯¹è±¡ä¼šè¢«åˆ†æˆ <code>6</code> ä¸ªæ•°æ®å—ã€<code>6</code> ä¸ªå¥‡å¶æ ¡éªŒå—ï¼Œä½ å¯ä»¥ä¸¢å¤±ä»»æ„ <code>6</code> å—ç›˜ï¼Œä»å¯ä»¥ä»å‰©ä¸‹çš„ç›˜ä¸­çš„æ•°æ®è¿›è¡Œæ¢å¤ã€‚</p><p>çº åˆ ç çš„å·¥ä½œåŸç†å’Œ <code>RAID</code> æˆ–è€…å¤åˆ¶ä¸åŒï¼Œåƒ <code>RAID6</code> å¯ä»¥åœ¨æŸå¤±ä¸¤å—ç›˜çš„æƒ…å†µä¸‹ä¸ä¸¢æ•°æ®ï¼Œè€Œ <code>MinIO</code> çº åˆ ç å¯ä»¥åœ¨ä¸¢å¤±ä¸€åŠçš„ç›˜çš„æƒ…å†µä¸‹ï¼Œä»å¯ä»¥ä¿è¯æ•°æ®å®‰å…¨ã€‚è€Œä¸” <code>MinIO</code> çº åˆ ç æ˜¯ä½œç”¨åœ¨å¯¹è±¡çº§åˆ«ï¼Œå¯ä»¥ä¸€æ¬¡æ¢å¤ä¸€ä¸ªå¯¹è±¡ï¼Œè€Œ <code>RAID</code> æ˜¯ä½œç”¨åœ¨å·çº§åˆ«ï¼Œæ•°æ®æ¢å¤æ—¶é—´å¾ˆé•¿ã€‚<code>MinIO</code> å¯¹æ¯ä¸ªå¯¹è±¡å•ç‹¬ç¼–ç ï¼Œå­˜å‚¨æœåŠ¡ä¸€ç»éƒ¨ç½²ï¼Œé€šå¸¸æƒ…å†µä¸‹æ˜¯ä¸éœ€è¦æ›´æ¢ç¡¬ç›˜æˆ–è€…ä¿®å¤ã€‚<code>MinIO</code> çº åˆ ç çš„è®¾è®¡ç›®æ ‡æ˜¯ä¸ºäº†æ€§èƒ½å’Œå°½å¯èƒ½çš„ä½¿ç”¨ç¡¬ä»¶åŠ é€Ÿã€‚</p><p><img src="https://img.hi-linux.com/staticfile/minio-file-storage-06-2021-12-06-ytxrnO.jpg" alt="MinIOåˆ†å¸ƒå¼æ–‡ä»¶å­˜å‚¨ - å¯¹è±¡çš„å­˜å‚¨å½¢å¼"></p><ul><li><strong>å¯¹è±¡çš„å­˜å‚¨å½¢å¼</strong></li></ul><p>æ–‡ä»¶å¯¹è±¡ä¸Šä¼ åˆ° <code>MinIO</code> ä¸Šé¢ï¼Œä¼šåœ¨å¯¹åº”çš„ç£ç›˜å½“ä¸­ï¼Œä»¥ <code>Bucket</code> åç§°ä¸ºç›®å½•ï¼Œæ–‡ä»¶åç§°ä¸ºä¸‹ä¸€çº§ç›®å½•ï¼Œæ–‡ä»¶åä¸‹æ˜¯ <code>part.1</code> å’Œ <code>xl.meta</code>ï¼Œå‰è€…æ˜¯ç¼–ç æ•°æ®å—åŠæ£€éªŒå—ï¼Œåè€…æ˜¯å…ƒæ•°æ®æ–‡ä»¶ã€‚</p><p><img src="https://img.hi-linux.com/staticfile/minio-file-storage-07-20211206173827530-2021-12-06-p2Otij.png" alt="MinIOåˆ†å¸ƒå¼æ–‡ä»¶å­˜å‚¨ - å¯¹è±¡çš„å­˜å‚¨å½¢å¼(ç½‘ç»œé‡‡é›†çš„å›¾ç‰‡)"></p><ul><li><strong>å¸¸è§çš„ä½¿ç”¨æ–¹æ¡ˆ</strong></li></ul><p><img src="https://img.hi-linux.com/staticfile/minio-file-storage-08-2021-12-06-QGpa3P.png" alt="MinIOåˆ†å¸ƒå¼æ–‡ä»¶å­˜å‚¨ - å¸¸è§çš„ä½¿ç”¨æ–¹æ¡ˆ(ç½‘ç»œé‡‡é›†çš„å›¾ç‰‡)"></p><h2><span id="4-minio-çš„å®‰è£…éƒ¨ç½²-å•æœº">4. MinIO çš„å®‰è£…éƒ¨ç½² - å•æœº</span></h2><blockquote><p><strong>å»ºè®®ä½¿ç”¨å®¹å™¨åŒ–å®‰è£…å’Œéƒ¨ç½²æ–¹å¼ - ç®€å•å’Œå¥½ç”¨</strong></p></blockquote><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå•æœºç‰ˆæœ¬æ— æ³•ä½¿ç”¨ï¼Œç‰ˆæœ¬æ§åˆ¶ã€å¯¹è±¡é”å®šå’Œå­˜å‚¨æ¡¶å¤åˆ¶ç­‰åŠŸèƒ½ã€‚å¦‚æœéœ€è¦ä½¿ç”¨ï¼Œæ˜¯éœ€è¦éƒ¨ç½² <strong>å¸¦æœ‰çº åˆ ç çš„åˆ†å¸ƒå¼ MinIO</strong>ã€‚</p><ul><li>å•æœºç‰ˆ - å®¹å™¨å®‰è£… - æ²¡æœ‰çº é”™ç ç‰ˆæœ¬<ul><li><code>9000</code> ç«¯å£ä¸ºè‡ªå¸¦çš„ <code>Web</code> ç½‘é¡µå…¥åº“</li><li><code>9001</code> ç«¯å£ä¸ºä½¿ç”¨ <code>API</code> å’Œå®¢æˆ·ç«¯çš„è¿æ¥å£</li></ul></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># å†…åµŒäº†ä¸€ä¸ªMinIOçš„å¯¹è±¡æœåŠ¡</span><br><span class="line"># http:&#x2F;&#x2F;127.0.0.1:9000 (minioadmin:minioadmin)</span><br><span class="line">$ docker run --name&#x3D;minio-test \</span><br><span class="line">    -p 9000:9000 -p 9001:9001 \</span><br><span class="line">    quay.io&#x2F;minio&#x2F;minio server &#x2F;data --console-address &quot;:9001&quot;</span><br><span class="line"></span><br><span class="line"># å¯åŠ¨æ—¶è‡ªå®šä¹‰ç”¨æˆ·å’Œå¯†ç </span><br><span class="line">$ docker run --name&#x3D;minio-test \</span><br><span class="line">    -p 9000:9000 -p 9001:9001 \</span><br><span class="line">    -e &quot;MINIO_ROOT_USER&#x3D;admin&quot; \</span><br><span class="line">    -e &quot;MINIO_ROOT_PASSWORD&#x3D;123456&quot; \</span><br><span class="line">    quay.io&#x2F;minio&#x2F;minio server &#x2F;data --console-address &quot;:9001&quot;</span><br><span class="line"></span><br><span class="line"># Windowsç³»ç»Ÿå¯åŠ¨</span><br><span class="line">$ docker run --name&#x3D;minio-test \</span><br><span class="line">    -p 9000:9000 -p 9001:9001 \</span><br><span class="line">    -v D:\data:&#x2F;data \</span><br><span class="line">    -e &quot;MINIO_ROOT_USER&#x3D;admin&quot; \</span><br><span class="line">    -e &quot;MINIO_ROOT_PASSWORD&#x3D;123456&quot; \</span><br><span class="line">    quay.io&#x2F;minio&#x2F;minio server &#x2F;data --console-address &quot;:9001&quot;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># è®¾ç½®å®‰å…¨ç§˜é’¥å¯åŠ¨</span><br><span class="line">$ echo &quot;admin&quot; | docker secret create access_key -</span><br><span class="line">$ echo &quot;123456&quot; | docker secret create secret_key -</span><br><span class="line"></span><br><span class="line"># ä½¿ç”¨docker-serviceçš„å®‰å…¨ç§˜é’¥å¯åŠ¨</span><br><span class="line">$ docker service create --name&#x3D;&quot;minio-service&quot; \</span><br><span class="line">    --secret&#x3D;&quot;access_key&quot; --secret&#x3D;&quot;secret_key&quot; \</span><br><span class="line">    --env&#x3D;&quot;MINIO_ROOT_USER_FILE&#x3D;my_access_key&quot; \</span><br><span class="line">    --env&#x3D;&quot;MINIO_ROOT_PASSWORD_FILE&#x3D;my_secret_key&quot; \</span><br><span class="line">    quay.io&#x2F;minio&#x2F;minio server &#x2F;data</span><br></pre></td></tr></table></figure><ul><li>å•æœºç‰ˆ - å®¹å™¨å®‰è£… - å¸¦æœ‰çº é”™ç ç‰ˆæœ¬<ul><li><code>9000</code> ç«¯å£ä¸ºè‡ªå¸¦çš„ <code>Web</code> ç½‘é¡µå…¥åº“</li><li><code>9001</code> ç«¯å£ä¸ºä½¿ç”¨ <code>API</code> å’Œå®¢æˆ·ç«¯çš„è¿æ¥å£</li></ul></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># å‘½ä»¤è¡Œå¯åŠ¨</span><br><span class="line">$ minio server \</span><br><span class="line">    &#x2F;data1 &#x2F;data2 &#x2F;data3 &#x2F;data4 \</span><br><span class="line">    &#x2F;data5 &#x2F;data6 &#x2F;data7 &#x2F;data8</span><br><span class="line"></span><br><span class="line"># å®¹å™¨å¯åŠ¨</span><br><span class="line">$ docker run --name&#x3D;minio-test \</span><br><span class="line">  -p 9000:9000 -p 9001:9001 \</span><br><span class="line">  -v &#x2F;mnt&#x2F;data1:&#x2F;data1 \</span><br><span class="line">  -v &#x2F;mnt&#x2F;data2:&#x2F;data2 \</span><br><span class="line">  -v &#x2F;mnt&#x2F;data3:&#x2F;data3 \</span><br><span class="line">  -v &#x2F;mnt&#x2F;data4:&#x2F;data4 \</span><br><span class="line">  -v &#x2F;mnt&#x2F;data5:&#x2F;data5 \</span><br><span class="line">  -v &#x2F;mnt&#x2F;data6:&#x2F;data6 \</span><br><span class="line">  -v &#x2F;mnt&#x2F;data7:&#x2F;data7 \</span><br><span class="line">  -v &#x2F;mnt&#x2F;data8:&#x2F;data8 \</span><br><span class="line">  quay.io&#x2F;minio&#x2F;minio server &#x2F;data&#123;1...8&#125; --console-address &quot;:9001&quot;</span><br></pre></td></tr></table></figure><ul><li>å•æœºç‰ˆ - å‘½ä»¤å®‰è£…<ul><li><code>9000</code> ç«¯å£ä¸ºè‡ªå¸¦çš„ <code>Web</code> ç½‘é¡µå…¥åº“</li><li><code>9001</code> ç«¯å£ä¸ºä½¿ç”¨ <code>API</code> å’Œå®¢æˆ·ç«¯çš„è¿æ¥å£</li></ul></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># MacOS</span><br><span class="line">$ brew install minio&#x2F;stable&#x2F;minio</span><br><span class="line">$ minio server &#x2F;data</span><br><span class="line"></span><br><span class="line"># linux</span><br><span class="line">$ apt install minio</span><br><span class="line">$ minio server &#x2F;data</span><br></pre></td></tr></table></figure><ul><li>å•æœºç‰ˆ - äºŒè¿›åˆ¶å®‰è£…<ul><li><code>9000</code> ç«¯å£ä¸ºè‡ªå¸¦çš„ <code>Web</code> ç½‘é¡µå…¥åº“</li><li><code>9001</code> ç«¯å£ä¸ºä½¿ç”¨ <code>API</code> å’Œå®¢æˆ·ç«¯çš„è¿æ¥å£</li></ul></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># MacOS</span><br><span class="line">$ wget https:&#x2F;&#x2F;dl.min.io&#x2F;server&#x2F;minio&#x2F;release&#x2F;darwin-amd64&#x2F;minio</span><br><span class="line">$ chmod +x minio</span><br><span class="line">$ .&#x2F;minio server &#x2F;data</span><br><span class="line"></span><br><span class="line"># Windows</span><br><span class="line">$ wget https:&#x2F;&#x2F;dl.min.io&#x2F;server&#x2F;minio&#x2F;release&#x2F;windows-amd64&#x2F;minio.exe</span><br><span class="line">$ minio.exe server D:\</span><br><span class="line"></span><br><span class="line"># Linux</span><br><span class="line">$ wget https:&#x2F;&#x2F;dl.min.io&#x2F;server&#x2F;minio&#x2F;release&#x2F;linux-amd64&#x2F;minio</span><br><span class="line">$ chmod +x minio</span><br><span class="line">$ .&#x2F;minio server &#x2F;data</span><br><span class="line"></span><br><span class="line">$ ufw allow 9000:9010&#x2F;tcp</span><br><span class="line">$ firewall-cmd --get-active-zones</span><br><span class="line">$ firewall-cmd --zone&#x3D;public --add-port&#x3D;9000&#x2F;tcp --permanent</span><br><span class="line">$ firewall-cmd --reload</span><br></pre></td></tr></table></figure><h2><span id="5-minio-çš„å®‰è£…éƒ¨ç½²-åˆ†å¸ƒå¼">5. MinIO çš„å®‰è£…éƒ¨ç½² - åˆ†å¸ƒå¼</span></h2><blockquote><p><strong>å»ºè®®ä½¿ç”¨å®¹å™¨åŒ–å®‰è£…å’Œéƒ¨ç½²æ–¹å¼ - ç®€å•å’Œå¥½ç”¨</strong></p></blockquote><p>åœ¨å¤§æ•°æ®é¢†åŸŸï¼Œé€šå¸¸çš„è®¾è®¡ç†å¿µéƒ½æ˜¯æ— ä¸­å¿ƒå’Œåˆ†å¸ƒå¼ã€‚<code>MinIO</code> ä¹Ÿæä¾›äº†åˆ†å¸ƒå¼éƒ¨ç½²çš„æ–¹å¼ï¼Œå…¶å¥½å¤„åœ¨äºï¼Œå¯ä»¥æä¾›ä¸€ä¸ªé«˜å¯ç”¨çš„å¯¹è±¡å­˜å‚¨æœåŠ¡ï¼Œç¡®ä¿æ•°æ®ä¸ä¼šä¸¢å¤±å’Œä¸€è‡´ã€‚<code>MinIO</code> åœ¨åˆ†å¸ƒå¼å’Œå•æœºæ¨¡å¼ä¸‹ï¼Œæ‰€æœ‰è¯»å†™æ“ä½œéƒ½ä¸¥æ ¼éµå®ˆ <code>read-after-write</code> ä¸€è‡´æ€§æ¨¡å‹ã€‚</p><p><img src="https://img.hi-linux.com/staticfile/minio-file-storage-09-2021-12-06-WIfj1H.png" alt="MinIOåˆ†å¸ƒå¼æ–‡ä»¶å­˜å‚¨ - åˆ†å¸ƒå¼æ¶æ„å›¾"></p><ul><li><strong>å‘½ä»¤è¡Œæ–¹å¼å¯åŠ¨ - client</strong></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># è®¾ç½®å˜é‡</span><br><span class="line">$ export MINIO_ROOT_USER&#x3D;&lt;ACCESS_KEY&gt;</span><br><span class="line">$ export MINIO_ROOT_PASSWORD&#x3D;&lt;SECRET_KEY&gt;</span><br><span class="line"></span><br><span class="line"># å‘½ä»¤è¡Œå¯åŠ¨æ–¹å¼æ ¼å¼</span><br><span class="line">$ minio server http:&#x2F;&#x2F;host&#123;1...n&#125;&#x2F;export&#123;1...m&#125;</span><br><span class="line">$ minio server http:&#x2F;&#x2F;host&#123;1...n&#125;&#x2F;export&#123;1...m&#125; http:&#x2F;&#x2F;host&#123;o...z&#125;&#x2F;export&#123;1...m&#125;</span><br><span class="line"></span><br><span class="line"># å‘½ä»¤è¡Œå¯åŠ¨æ–¹å¼ç¤ºä¾‹</span><br><span class="line">minio server http:&#x2F;&#x2F;192.168.1.11&#x2F;export1 http:&#x2F;&#x2F;192.168.1.12&#x2F;export2 \</span><br><span class="line">             http:&#x2F;&#x2F;192.168.1.13&#x2F;export3 http:&#x2F;&#x2F;192.168.1.14&#x2F;export4 \</span><br><span class="line">             http:&#x2F;&#x2F;192.168.1.15&#x2F;export5 http:&#x2F;&#x2F;192.168.1.16&#x2F;export6 \</span><br><span class="line">             http:&#x2F;&#x2F;192.168.1.17&#x2F;export7 http:&#x2F;&#x2F;192.168.1.18&#x2F;export8</span><br></pre></td></tr></table></figure><ul><li><strong>å®¹å™¨æ–¹å¼å¯åŠ¨ - docker</strong></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">version: &#39;3.7&#39;</span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">  minio:</span><br><span class="line">    restart: on-failure</span><br><span class="line">    container_name: app_minio</span><br><span class="line">    image: quay.io&#x2F;minio&#x2F;minio:RELEASE.2021-11-09T03-21-45Z</span><br><span class="line">    command: server &#x2F;data --console-address &quot;:9001&quot;</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;80:9000&quot;</span><br><span class="line">      - &quot;81:9001&quot;</span><br><span class="line">    volumes:</span><br><span class="line">      - &quot;&#x2F;app_minio&#x2F;data:&#x2F;data&quot;</span><br><span class="line">    environment:</span><br><span class="line">      MINIO_ROOT_USER: admin</span><br><span class="line">      MINIO_ROOT_PASSWORD: 123456</span><br><span class="line">    healthcheck:</span><br><span class="line">      test: [&quot;CMD&quot;, &quot;curl&quot;, &quot;-f&quot;, &quot;http:&#x2F;&#x2F;localhost:9000&#x2F;minio&#x2F;health&#x2F;live&quot;]</span><br><span class="line">      interval: 30s</span><br><span class="line">      timeout: 20s</span><br><span class="line">      retries: 3</span><br><span class="line">    networks:</span><br><span class="line">      - app_minio_network</span><br><span class="line"></span><br><span class="line">networks:</span><br><span class="line">  app_minio_network:</span><br></pre></td></tr></table></figure><ul><li>å®¹å™¨æ–¹å¼å¯åŠ¨ - kubernetes<ul><li><a href="https://github.com/minio/charts" target="_blank" rel="noopener">helm minio charts</a></li></ul></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># å®‰è£…MinIOçš„chart</span><br><span class="line">$ helm install stable&#x2F;minio</span><br><span class="line"></span><br><span class="line"># å®¹å™¨å¹³å°ä¸Šé¢å¯åŠ¨æœåŠ¡ - å•æœº</span><br><span class="line">$ helm install --name minio-release \</span><br><span class="line">    --namespace minio</span><br><span class="line">    --set rootUser&#x3D;rootuser,rootPassword&#x3D;rootpass123</span><br><span class="line">    --set persistence.size&#x3D;100Gi \</span><br><span class="line">    stable&#x2F;minio</span><br><span class="line"></span><br><span class="line">#  å®¹å™¨å¹³å°ä¸Šé¢å¯åŠ¨æœåŠ¡ - åˆ†å¸ƒå¼</span><br><span class="line">$ helm install --set mode&#x3D;distributed stable&#x2F;minio</span><br><span class="line">$ helm install --set mode&#x3D;distributed,numberOfNodes&#x3D;8 stable&#x2F;minio</span><br><span class="line">$ helm install --set mode&#x3D;shared,numberOfNodes&#x3D;8 stable&#x2F;minio</span><br><span class="line">$ helm install --set persistence.enabled&#x3D;false stable&#x2F;minio</span><br></pre></td></tr></table></figure><h2><span id="6-minio-çš„å®‰è£…éƒ¨ç½²-å¤šç§Ÿæˆ·">6. MinIO çš„å®‰è£…éƒ¨ç½² - å¤šç§Ÿæˆ·</span></h2><blockquote><p><strong>å»ºè®®ä½¿ç”¨å®¹å™¨åŒ–å®‰è£…å’Œéƒ¨ç½²æ–¹å¼ - ç®€å•å’Œå¥½ç”¨</strong></p></blockquote><ul><li><strong>[1] å•ä¸»æœº + å•ç£ç›˜</strong></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ minio server --address :9001 &#x2F;data&#x2F;tenant1</span><br><span class="line">$ minio server --address :9002 &#x2F;data&#x2F;tenant2</span><br><span class="line">$ minio server --address :9003 &#x2F;data&#x2F;tenant3</span><br></pre></td></tr></table></figure><p><img src="https://img.hi-linux.com/staticfile/minio-file-storage-10-2021-12-06-qGORMY.jpg" alt="MinIOåˆ†å¸ƒå¼æ–‡ä»¶å­˜å‚¨ - å¤šç§Ÿæˆ·"></p><ul><li><strong>[2] å•ä¸»æœº + å—ç£ç›˜ (æœ‰çº é”™ç )</strong></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ minio server --address :9001 &#x2F;disk&#123;1...4&#125;&#x2F;data&#x2F;tenant1</span><br><span class="line">$ minio server --address :9002 &#x2F;disk&#123;1...4&#125;&#x2F;data&#x2F;tenant2</span><br><span class="line">$ minio server --address :9003 &#x2F;disk&#123;1...4&#125;&#x2F;data&#x2F;tenant3</span><br></pre></td></tr></table></figure><p><img src="https://img.hi-linux.com/staticfile/minio-file-storage-11-2021-12-06-j2cFg2.jpg" alt="MinIOåˆ†å¸ƒå¼æ–‡ä»¶å­˜å‚¨ - å¤šç§Ÿæˆ·"></p><ul><li><strong>[3] å¤šä¸»æœº + å¤šå—ç£ç›˜ (åˆ†å¸ƒå¼+çº é”™ç )</strong></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ export MINIO_ROOT_USER&#x3D;&lt;TENANT1_ACCESS_KEY&gt;</span><br><span class="line">$ export MINIO_ROOT_PASSWORD&#x3D;&lt;TENANT1_SECRET_KEY&gt;</span><br><span class="line">$ minio server --address :9001 http:&#x2F;&#x2F;192.168.10.1&#123;1...4&#125;&#x2F;data&#x2F;tenant1</span><br><span class="line"></span><br><span class="line">$ export MINIO_ROOT_USER&#x3D;&lt;TENANT2_ACCESS_KEY&gt;</span><br><span class="line">$ export MINIO_ROOT_PASSWORD&#x3D;&lt;TENANT2_SECRET_KEY&gt;</span><br><span class="line">$ minio server --address :9002 http:&#x2F;&#x2F;192.168.10.1&#123;1...4&#125;&#x2F;data&#x2F;tenant2</span><br><span class="line"></span><br><span class="line">$ export MINIO_ROOT_USER&#x3D;&lt;TENANT3_ACCESS_KEY&gt;</span><br><span class="line">$ export MINIO_ROOT_PASSWORD&#x3D;&lt;TENANT3_SECRET_KEY&gt;</span><br><span class="line">$ minio server --address :9003 http:&#x2F;&#x2F;192.168.10.1&#123;1...4&#125;&#x2F;data&#x2F;tenant3</span><br></pre></td></tr></table></figure><p><img src="https://img.hi-linux.com/staticfile/minio-file-storage-12-20211206174412358-2021-12-06-0zVHNj.jpg" alt="MinIOåˆ†å¸ƒå¼æ–‡ä»¶å­˜å‚¨ - å¤šç§Ÿæˆ·"></p><h2><span id="7-minio-çš„ç½‘é¡µä½¿ç”¨">7. MinIO çš„ç½‘é¡µä½¿ç”¨</span></h2><blockquote><p><strong>å®‰è£…éƒ¨ç½²å®Œæˆä¹‹åï¼Œå»ºè®®ä½¿ç”¨ç•Œé¢æ“ä½œï¼Œç®€å•å¥½ç”¨ï¼</strong></p></blockquote><ul><li>[1] è¿è¡ŒæœåŠ¡ - docker-compose<ul><li><a href="https://raw.githubusercontent.com/minio/minio/master/docs/orchestration/docker-compose/docker-compose.yaml" target="_blank" rel="noopener"><code>docker-compose.yaml</code></a></li><li><a href="https://raw.githubusercontent.com/minio/minio/master/docs/orchestration/docker-compose/nginx.conf" target="_blank" rel="noopener"><code>nginx.conf</code></a></li></ul></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">version: &quot;3.7&quot;</span><br><span class="line"></span><br><span class="line">x-minio-common: &amp;minio-common</span><br><span class="line">  image: quay.io&#x2F;minio&#x2F;minio:RELEASE.2021-11-24T23-19-33Z</span><br><span class="line">  command: server --console-address &quot;:9001&quot; http:&#x2F;&#x2F;minio&#123;1...4&#125;&#x2F;data&#123;1...2&#125;</span><br><span class="line">  expose:</span><br><span class="line">    - &quot;9000&quot;</span><br><span class="line">    - &quot;9001&quot;</span><br><span class="line">  environment:</span><br><span class="line">    MINIO_ROOT_USER: minio</span><br><span class="line">    MINIO_ROOT_PASSWORD: minio123</span><br><span class="line">  healthcheck:</span><br><span class="line">    test: [&quot;CMD&quot;, &quot;curl&quot;, &quot;-f&quot;, &quot;http:&#x2F;&#x2F;localhost:9000&#x2F;minio&#x2F;health&#x2F;live&quot;]</span><br><span class="line">    interval: 30s</span><br><span class="line">    timeout: 20s</span><br><span class="line">    retries: 3</span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">  minio1:</span><br><span class="line">    &lt;&lt;: *minio-common</span><br><span class="line">    hostname: minio1</span><br><span class="line">    volumes:</span><br><span class="line">      - data1-1:&#x2F;data1</span><br><span class="line">      - data1-2:&#x2F;data2</span><br><span class="line"></span><br><span class="line">  minio2:</span><br><span class="line">    &lt;&lt;: *minio-common</span><br><span class="line">    hostname: minio2</span><br><span class="line">    volumes:</span><br><span class="line">      - data2-1:&#x2F;data1</span><br><span class="line">      - data2-2:&#x2F;data2</span><br><span class="line"></span><br><span class="line">  minio3:</span><br><span class="line">    &lt;&lt;: *minio-common</span><br><span class="line">    hostname: minio3</span><br><span class="line">    volumes:</span><br><span class="line">      - data3-1:&#x2F;data1</span><br><span class="line">      - data3-2:&#x2F;data2</span><br><span class="line"></span><br><span class="line">  minio4:</span><br><span class="line">    &lt;&lt;: *minio-common</span><br><span class="line">    hostname: minio4</span><br><span class="line">    volumes:</span><br><span class="line">      - data4-1:&#x2F;data1</span><br><span class="line">      - data4-2:&#x2F;data2</span><br><span class="line"></span><br><span class="line">  nginx:</span><br><span class="line">    image: nginx:1.19.2-alpine</span><br><span class="line">    hostname: nginx</span><br><span class="line">    volumes:</span><br><span class="line">      - .&#x2F;nginx.conf:&#x2F;etc&#x2F;nginx&#x2F;nginx.conf:ro</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;9000:9000&quot;</span><br><span class="line">      - &quot;9001:9001&quot;</span><br><span class="line">    depends_on:</span><br><span class="line">      - minio1</span><br><span class="line">      - minio2</span><br><span class="line">      - minio3</span><br><span class="line">      - minio4</span><br><span class="line"></span><br><span class="line">volumes:</span><br><span class="line">  data1-1:</span><br><span class="line">  data1-2:</span><br><span class="line">  data2-1:</span><br><span class="line">  data2-2:</span><br><span class="line">  data3-1:</span><br><span class="line">  data3-2:</span><br><span class="line">  data4-1:</span><br><span class="line">  data4-2:</span><br></pre></td></tr></table></figure><ul><li><strong>[2] å¯åŠ¨æœåŠ¡</strong></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># docker-compose</span><br><span class="line">$ docker stack deploy --compose-file docker-compose.yaml minio</span><br></pre></td></tr></table></figure><ul><li><strong>[3] ç•Œé¢ç™»å½•</strong></li></ul><p><img src="https://img.hi-linux.com/staticfile/minio-file-storage-13-20211206174432974-2021-12-06-k00IiE.png" alt="MinIOåˆ†å¸ƒå¼æ–‡ä»¶å­˜å‚¨ - ç½‘é¡µåœ°å€"></p><p><img src="https://img.hi-linux.com/staticfile/minio-file-storage-14-2021-12-06-2dPHBS.png" alt="MinIOåˆ†å¸ƒå¼æ–‡ä»¶å­˜å‚¨ - ç½‘é¡µåœ°å€"></p><h2><span id="8-minio-å®¢æˆ·ç«¯ä½¿ç”¨">8. MinIO å®¢æˆ·ç«¯ä½¿ç”¨</span></h2><blockquote><p><strong>MinIO Client (mc) provides a modern alternative to UNIX commands</strong></p></blockquote><ul><li><strong>[1] MC å‘½ä»¤è¡Œå·¥å…·å®‰è£…</strong></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># å®¹å™¨å®‰è£…</span><br><span class="line">$ docker pull minio&#x2F;mc</span><br><span class="line">$ docker run minio&#x2F;mc ls play</span><br><span class="line">$ docker run -it --entrypoint&#x3D;&#x2F;bin&#x2F;sh minio&#x2F;mc</span><br><span class="line"></span><br><span class="line"># MacOS</span><br><span class="line">brew install minio&#x2F;stable&#x2F;mc</span><br><span class="line"></span><br><span class="line"># Linux</span><br><span class="line">$ wget http:&#x2F;&#x2F;dl.minio.org.cn&#x2F;client&#x2F;mc&#x2F;release&#x2F;linux-amd64&#x2F;mc</span><br><span class="line">chmod +x mc</span><br><span class="line"></span><br><span class="line"># è‡ªåŠ¨è¡¥å…¨</span><br><span class="line">mc --autocompletion</span><br></pre></td></tr></table></figure><ul><li>[2] MC å‘½ä»¤è¡Œå‚æ•°ä»‹ç»<ul><li><code>mc xxx</code></li></ul></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">alias        è®¾ç½®&#x2F;ç§»é™¤&#x2F;åˆ—å‡ºè‡ªå®šä¹‰çš„åˆ«å</span><br><span class="line">ls           åˆ—å‡ºæ–‡ä»¶å’Œæ–‡ä»¶å¤¹</span><br><span class="line">mb           åˆ›å»ºä¸€ä¸ªå­˜å‚¨æ¡¶æˆ–ä¸€ä¸ªæ–‡ä»¶å¤¹</span><br><span class="line">rb           ç§»é™¤ä¸€ä¸ªæ¡¶</span><br><span class="line">cp           æ‹·è´æ–‡ä»¶å’Œå¯¹è±¡</span><br><span class="line">mirror       ç»™å­˜å‚¨æ¡¶å’Œæ–‡ä»¶å¤¹åšé•œåƒ</span><br><span class="line">cat          æ˜¾ç¤ºæ–‡ä»¶å’Œå¯¹è±¡å†…å®¹</span><br><span class="line">head         æ˜¾ç¤ºå¯¹è±¡çš„ç¬¬nè¡Œ</span><br><span class="line">pipe         å°†ä¸€ä¸ªSTDINé‡å®šå‘åˆ°ä¸€ä¸ªå¯¹è±¡æˆ–è€…æ–‡ä»¶æˆ–è€…STDOUT</span><br><span class="line">share        ç”Ÿæˆç”¨äºå…±äº«çš„URL</span><br><span class="line">find         åŸºäºå‚æ•°æŸ¥æ‰¾æ–‡ä»¶</span><br><span class="line">sql          åœ¨å¯¹è±¡ä¸Šè¿è¡ŒSQLæŸ¥è¯¢</span><br><span class="line">stat         æ˜¾ç¤ºå¯¹è±¡å…ƒä¿¡æ¯</span><br><span class="line">mv           ç§»åŠ¨æ–‡ä»¶å’Œå¯¹è±¡</span><br><span class="line">tree         ä»¥æ ‘çš„æ ¼å¼åˆ—å‡ºæ¡¶å’Œå¯¹è±¡</span><br><span class="line">du           ç»Ÿè®¡ç£ç›˜ä½¿ç”¨æƒ…å†µ</span><br><span class="line">retention    è®¾ç½®å¯¹è±¡å’Œæ¡¶çš„ä¿ç•™</span><br><span class="line">legalhold    è®¾ç½®å¯¹è±¡çš„åˆæ³•æŒæœ‰</span><br><span class="line">diff         å¯¹ä¸¤ä¸ªæ–‡ä»¶å¤¹æˆ–è€…å­˜å‚¨æ¡¶æ¯”è¾ƒå·®å¼‚</span><br><span class="line">rm           åˆ é™¤æ–‡ä»¶å’Œå¯¹è±¡</span><br><span class="line">encrypt      ç®¡ç†æ¡¶åŠ å¯†é…ç½®</span><br><span class="line">events       ç®¡ç†å¯¹è±¡é€šçŸ¥</span><br><span class="line">watch        ç›‘å¬æ–‡ä»¶å’Œå¯¹è±¡çš„äº‹ä»¶</span><br><span class="line">undo         å–æ¶ˆPUT&#x2F;DELETEæ“ä½œ</span><br><span class="line">policy       ç®¡ç†è®¿é—®ç­–ç•¥</span><br><span class="line">tag          ç®¡ç†æ¡¶å’Œå¯¹è±¡çš„æ ‡ç­¾</span><br><span class="line">ilm          ç®¡ç†æ¡¶çš„ç”Ÿå‘½å‘¨æœŸ</span><br><span class="line">version      è¾“å‡ºç‰ˆæœ¬ä¿¡æ¯</span><br><span class="line">replicate    é…ç½®æœåŠ¡å™¨ç«¯æ¡¶å¤åˆ¶</span><br><span class="line">admin        ç®¡ç†MinioæœåŠ¡å™¨</span><br><span class="line">update       æ£€æŸ¥è½¯ä»¶æ›´æ–°</span><br></pre></td></tr></table></figure><ul><li>[3] MC æœåŠ¡ç«¯å‘½ä»¤å‚æ•°<ul><li><code>mc admin xxx</code></li></ul></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">service     æœåŠ¡é‡å¯å¹¶åœæ­¢æ‰€æœ‰MinIOæœåŠ¡å™¨</span><br><span class="line">update      æ›´æ–°æ›´æ–°æ‰€æœ‰MinIOæœåŠ¡å™¨</span><br><span class="line">info        ä¿¡æ¯æ˜¾ç¤ºMinIOæœåŠ¡å™¨ä¿¡æ¯</span><br><span class="line">user        ç®¡ç†ç”¨æˆ·</span><br><span class="line">group       ç®¡ç†å°ç»„</span><br><span class="line">policy      MinIOæœåŠ¡å™¨ä¸­å®šä¹‰çš„ç­–ç•¥ç®¡ç†ç­–ç•¥</span><br><span class="line">config      é…ç½®ç®¡ç†MinIOæœåŠ¡å™¨é…ç½®</span><br><span class="line">heal        ä¿®å¤MinIOæœåŠ¡å™¨ä¸Šçš„ç£ç›˜ï¼Œå­˜å‚¨æ¡¶å’Œå¯¹è±¡</span><br><span class="line">profile     æ¦‚è¦æ–‡ä»¶ç”Ÿæˆæ¦‚è¦æ–‡ä»¶æ•°æ®ä»¥è¿›è¡Œè°ƒè¯•</span><br><span class="line">top         é¡¶éƒ¨æä¾›MinIOçš„é¡¶éƒ¨ç»Ÿè®¡ä¿¡æ¯</span><br><span class="line">trace       è·Ÿè¸ªæ˜¾ç¤ºMinIOæœåŠ¡å™¨çš„httpè·Ÿè¸ª</span><br><span class="line">console     æ§åˆ¶å°æ˜¾ç¤ºMinIOæœåŠ¡å™¨çš„æ§åˆ¶å°æ—¥å¿—</span><br><span class="line">prometheus  Prometheusç®¡ç†Prometheusé…ç½®</span><br><span class="line">kms         kmsæ‰§è¡ŒKMSç®¡ç†æ“ä½œ</span><br><span class="line">bucket      ç®¡ç†MinIOæœåŠ¡å™¨ä¸­å®šä¹‰çš„å­˜å‚¨æ¡¶</span><br></pre></td></tr></table></figure><ul><li><strong>[4] ç¤ºä¾‹æ¼”ç¤º</strong></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># MinIOäº‘å­˜å‚¨é…ç½®</span><br><span class="line">mc alias set minio http:&#x2F;&#x2F;192.168.1.51 admin 123456</span><br><span class="line">mc alias set s3 https:&#x2F;&#x2F;s3.amazonaws.com admin 123456</span><br><span class="line">mc alias set gcs  https:&#x2F;&#x2F;storage.googleapis.com admin 123456</span><br><span class="line"></span><br><span class="line"># å¼€å§‹æ“ä½œäº‘å­˜å‚¨ - åˆ—å‡ºæ‰€æœ‰å­˜å‚¨æ¡¶</span><br><span class="line">mc ls play</span><br><span class="line"></span><br><span class="line"># åˆ›å»ºä¸€ä¸ªæ¡¶</span><br><span class="line">mc mb play&#x2F;mybucket</span><br><span class="line"></span><br><span class="line"># ä¸Šä¼ ä¸œè¥¿</span><br><span class="line">mc cp myobject.txt play&#x2F;mybucket</span><br></pre></td></tr></table></figure><h2><span id="9-minio-python-sdk">9. MinIO Python SDK</span></h2><blockquote><p><strong>Python ä»£ç æ“ä½œ MinIO æœåŠ¡</strong></p></blockquote><ul><li><a href="https://docs.min.io/docs/python-client-quickstart-guide.html" target="_blank" rel="noopener">MinIO Python SDK for Amazon S3 Compatible Cloud Storage Slack</a></li><li><a href="https://docs.min.io/docs/python-client-api-reference" target="_blank" rel="noopener">Python Client API Reference</a></li><li><a href="https://github.com/minio/minio-py/tree/release/examples" target="_blank" rel="noopener">MinIO Python SDK Examples</a></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># å®‰è£…pipåŒ…</span><br><span class="line">pip3 install minio</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"># file_uploader.py</span><br><span class="line">from minio import Minio</span><br><span class="line">from minio.error import S3Error</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def main():</span><br><span class="line">    # Create a client with the MinIO server playground, its access key</span><br><span class="line">    # and secret key.</span><br><span class="line">    client &#x3D; Minio(</span><br><span class="line">        &quot;play.min.io&quot;,</span><br><span class="line">        access_key&#x3D;&quot;Q3AM3UQ867SPQQA43P2F&quot;,</span><br><span class="line">        secret_key&#x3D;&quot;zuf+tfteSlswRu7BJ86wekitnifILbZam1KYY3TG&quot;,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    # Make &#39;asiatrip&#39; bucket if not exist.</span><br><span class="line">    found &#x3D; client.bucket_exists(&quot;asiatrip&quot;)</span><br><span class="line">    if not found:</span><br><span class="line">        client.make_bucket(&quot;asiatrip&quot;)</span><br><span class="line">    else:</span><br><span class="line">        print(&quot;Bucket &#39;asiatrip&#39; already exists&quot;)</span><br><span class="line">    </span><br><span class="line">    # Upload &#39;&#x2F;home&#x2F;user&#x2F;Photos&#x2F;asiaphotos.zip&#39; as object name</span><br><span class="line">    # &#39;asiaphotos-2015.zip&#39; to bucket &#39;asiatrip&#39;.</span><br><span class="line">    client.fput_object(</span><br><span class="line">        &quot;asiatrip&quot;, &quot;asiaphotos-2015.zip&quot;, &quot;&#x2F;home&#x2F;user&#x2F;Photos&#x2F;asiaphotos.zip&quot;,</span><br><span class="line">    )</span><br><span class="line">    print(</span><br><span class="line">        &quot;&#39;&#x2F;home&#x2F;user&#x2F;Photos&#x2F;asiaphotos.zip&#39; is successfully uploaded as &quot;</span><br><span class="line">        &quot;object &#39;asiaphotos-2015.zip&#39; to bucket &#39;asiatrip&#39;.&quot;</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ &#x3D;&#x3D; &quot;__main__&quot;:</span><br><span class="line">    try:</span><br><span class="line">        main()</span><br><span class="line">    except S3Error as exc:</span><br><span class="line">        print(&quot;error occurred.&quot;, exc)</span><br></pre></td></tr></table></figure><blockquote><p>æœ¬æ–‡è½¬è½½è‡ªï¼šã€Œ Escape ã€ï¼ŒåŸæ–‡ï¼š<a href="https://tinyurl.com/yc3edfec" target="_blank" rel="noopener">https://tinyurl.com/yc3edfec</a> ï¼Œç‰ˆæƒå½’åŸä½œè€…æ‰€æœ‰ã€‚æ¬¢è¿æŠ•ç¨¿ï¼ŒæŠ•ç¨¿é‚®ç®±: <a href="mailto:editor@hi-linux.com">editor@hi-linux.com</a>ã€‚</p></blockquote></div><script src="https://my.openwrite.cn/js/readmore.js" type="text/javascript"></script><script>var isMobile = navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i);if (!isMobile) {    var btw = new BTWPlugin();    btw.init({        "id": "vip-container",        "blogId": "10135-1588830050631-449",        "name": "ã€Œå¥‡å¦™çš„ Linux ä¸–ç•Œã€",        "qrcode": "https://www.hi-linux.com/img/wechat/mp_qrcode_12.jpg",        "keyword": "VIP"    });}</script>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;MinIO - æ„å»ºé«˜æ€§èƒ½çš„äº‘åŸç”Ÿæ•°æ®çš„å¤šäº‘å¯¹è±¡å­˜å‚¨&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;code&gt;MinIO&lt;/code&gt; æä¾›å¼€æºã€é«˜æ€§èƒ½ã€å…¼å®¹ &lt;code&gt;s3&lt;/code&gt; çš„å¯¹è±¡å­˜å‚¨ï¼Œä¸ºæ¯ä¸ªå…¬å…±äº‘ã€æ¯ä¸ª &lt;code&gt;Kubernetes&lt;/code&gt; å‘è¡Œç‰ˆã€ç§æœ‰äº‘å’Œè¾¹ç¼˜äº‘ä¸­æ— ç¼è¿è¡Œï¼Œä½¿å…¶æˆä¸ºæ··åˆäº‘å’Œå¤šäº‘å¯¹è±¡å­˜å‚¨çš„é¢†å¯¼è€…ã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://min.io/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;MinIO è‹±æ–‡å®˜ç½‘åœ°å€&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://www.minio.org.cn/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;MinIO ä¸­æ–‡å®˜ç½‘åœ°å€&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;1-MinIO-çš„åº”ç”¨åœºæ™¯&quot;&gt;1. MinIO çš„åº”ç”¨åœºæ™¯&lt;/h2&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;MinIO æ˜¯ä¸€ä¸ªéå¸¸è½»é‡çš„æœåŠ¡ï¼Œå¯ä»¥å¾ˆç®€å•çš„å’Œå…¶ä»–åº”ç”¨çš„ç»“åˆã€‚&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;code&gt;MinIO&lt;/code&gt; æ˜¯ä¸€ä¸ªåŸºäº &lt;code&gt;Apache License v2.0&lt;/code&gt; å¼€æºåè®®çš„å¯¹è±¡å­˜å‚¨æœåŠ¡ã€‚å®ƒå…¼å®¹äºšé©¬é€Š &lt;code&gt;S3&lt;/code&gt; äº‘å­˜å‚¨æœåŠ¡æ¥å£ï¼Œéå¸¸é€‚åˆäºå­˜å‚¨å¤§å®¹é‡éç»“æ„åŒ–çš„æ•°æ®ï¼Œä¾‹å¦‚å›¾ç‰‡ã€è§†é¢‘ã€æ—¥å¿—æ–‡ä»¶ã€å¤‡ä»½æ•°æ®å’Œå®¹å™¨/è™šæ‹Ÿæœºé•œåƒç­‰ï¼Œè€Œä¸€ä¸ªå¯¹è±¡æ–‡ä»¶å¯ä»¥æ˜¯ä»»æ„å¤§å°ï¼Œä» &lt;code&gt;KB&lt;/code&gt; åˆ°æœ€å¤§ &lt;code&gt;TB&lt;/code&gt; ä¸ç­‰ã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ç½‘ç›˜ : æµ·é‡æ–‡ä»¶&lt;/li&gt;
&lt;li&gt;ç¤¾äº¤ç½‘ç«™ï¼šæµ·é‡å›¾ç‰‡&lt;/li&gt;
&lt;li&gt;ç”µå•†ç½‘ç«™ï¼šæµ·é‡å•†å“å›¾ç‰‡&lt;/li&gt;
&lt;li&gt;è§†é¢‘ç½‘ç«™ï¼šæµ·é‡è§†é¢‘æ–‡ä»¶&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;å¯¹äºä¸­å°å‹ä¼ä¸šï¼Œå¦‚æœä¸é€‰æ‹©å­˜å‚¨ä¸Šäº‘ï¼Œé‚£ä¹ˆ &lt;code&gt;MinIO&lt;/code&gt; æ˜¯ä¸ªä¸é”™çš„é€‰æ‹©ï¼Œéº»é›€è™½å°ï¼Œäº”è„ä¿±å…¨ã€‚å½“ç„¶ &lt;code&gt;MinIO&lt;/code&gt; é™¤äº†ç›´æ¥ä½œä¸ºå¯¹è±¡å­˜å‚¨ä½¿ç”¨ï¼Œè¿˜å¯ä»¥ä½œä¸ºäº‘ä¸Šå¯¹è±¡å­˜å‚¨æœåŠ¡çš„ç½‘å…³å±‚ï¼Œæ— ç¼å¯¹æ¥åˆ° &lt;code&gt;Amazon S3&lt;/code&gt; ç­‰ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Linux" scheme="https://www.hi-linux.com/categories/Linux/"/>
    
    
      <category term="Linux" scheme="https://www.hi-linux.com/tags/Linux/"/>
    
      <category term="æ•™ç¨‹" scheme="https://www.hi-linux.com/tags/%E6%95%99%E7%A8%8B/"/>
    
      <category term="MinIO" scheme="https://www.hi-linux.com/tags/MinIO/"/>
    
  </entry>
  
  <entry>
    <title>å…³äº Kubernetes çš„ Secret å¹¶ä¸å®‰å…¨è¿™ä»¶äº‹</title>
    <link href="https://www.hi-linux.com/posts/45918.html"/>
    <id>https://www.hi-linux.com/posts/45918.html</id>
    <published>2021-11-25T01:00:00.000Z</published>
    <updated>2021-12-18T08:41:42.651Z</updated>
    
    <content type="html"><![CDATA[<div id="vip-container"><p>K8s æä¾›äº† Secret èµ„æºä¾›æˆ‘ä»¬æ¥ä¿å­˜ã€è®¾ç½®ä¸€äº›æ•æ„Ÿä¿¡æ¯ï¼Œæ¯”å¦‚ API endpoint åœ°å€ï¼Œå„ç§ç”¨æˆ·å¯†ç æˆ– token ä¹‹ç±»çš„ä¿¡æ¯ã€‚åœ¨æ²¡æœ‰ä½¿ç”¨ K8s çš„æ—¶å€™ï¼Œè¿™äº›ä¿¡æ¯å¯èƒ½æ˜¯é€šè¿‡é…ç½®æ–‡ä»¶æˆ–è€…ç¯å¢ƒå˜é‡åœ¨éƒ¨ç½²çš„æ—¶å€™è®¾ç½®çš„ã€‚</p><p>ä¸è¿‡ï¼ŒSecret å…¶å®å¹¶ä¸å®‰å…¨ï¼Œç¨å¾®ç”¨ kubectl æŸ¥çœ‹è¿‡ Secret çš„äººéƒ½çŸ¥é“ï¼Œæˆ‘ä»¬å¯ä»¥éå¸¸æ–¹ä¾¿çš„çœ‹åˆ° Secret çš„åŸæ–‡ï¼Œåªè¦æœ‰ç›¸å…³çš„æƒé™å³å¯ï¼Œå°½ç®¡å®ƒçš„å†…å®¹æ˜¯ base64 ç¼–ç çš„ï¼Œè¿™åŸºæœ¬ä¸Šç­‰åŒäºæ˜æ–‡ã€‚</p><p>æ‰€ä»¥è¯´ï¼ŒK8s åŸç”Ÿçš„ Secret æ˜¯éå¸¸ç®€å•çš„ï¼Œä¸æ˜¯ç‰¹åˆ«é€‚åˆåœ¨å¤§å‹å…¬å¸é‡Œç›´æ¥ä½¿ç”¨ï¼Œå¯¹ RBAC çš„æŒ‘æˆ˜ä¹Ÿæ¯”è¾ƒå¤§ï¼Œå¾ˆå¤šä¸è¯¥çœ‹åˆ°æ˜æ–‡ä¿¡æ¯çš„äººå¯èƒ½éƒ½èƒ½çœ‹åˆ°ã€‚</p><p>å°¤å…¶æ˜¯ç°åœ¨å¾ˆå¤šå…¬å¸é‡‡ç”¨äº†æ‰€è°“çš„ GitOps ç†å¿µï¼Œå¾ˆå¤šä¸œè¥¿éƒ½éœ€è¦æ”¾åˆ° VCSï¼Œæ¯”å¦‚ git ä¸­ï¼Œè¿™ä¸€é—®é¢˜å°±æ›´æ—¥ç›Šçªå‡ºï¼Œå› ä¸º VCS ä¹Ÿå¾—éœ€è¦è®¾ç½®å¿…è¦çš„æƒé™ã€‚</p><a id="more"></a><h2><span id="é—®é¢˜">é—®é¢˜</span></h2><p>ç®€å•æ¥è¯´ï¼Œå¤§æ¦‚æœ‰å‡ ä¸ªåœ°æ–¹éƒ½å¯ä»¥è®©ä¸åº”è¯¥çœ‹åˆ° Secret å†…å®¹çš„äººè·å¾— Secret å†…å®¹ï¼š</p><ul><li>etcd å­˜å‚¨</li><li>é€šè¿‡ API server</li><li>åœ¨ node ä¸Šç›´æ¥æŸ¥çœ‹æ–‡ä»¶</li></ul><p>è¿™é‡Œæˆ‘ä»¬ä»¥è¿™ä¸ªä¾‹å­æ¥çœ‹ä¸€ä¸‹ Secret åœ¨ K8s ä¸­çš„ä½¿ç”¨æƒ…å†µã€‚</p><p>Secret å®šä¹‰ï¼Œ ç”¨æˆ·åå’Œå¯†ç åˆ†åˆ«ä¸º <code>admin</code> å’Œ <code>hello-secret</code>ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  name: mysecret</span><br><span class="line">type: Opaque</span><br><span class="line">data:</span><br><span class="line">  username: YWRtaW4&#x3D;</span><br><span class="line">  password: aGVsbG8tc2VjcmV0Cg&#x3D;&#x3D;</span><br></pre></td></tr></table></figure><p>Pod å®šä¹‰ï¼Œè¿™é‡Œæˆ‘ä»¬å°† Secret ä½œä¸º volume mount åˆ°å®¹å™¨ä¸­ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: mypod</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: mypod</span><br><span class="line">    image: docker.io&#x2F;containerstack&#x2F;alpine-stress</span><br><span class="line">    command:</span><br><span class="line">      - top</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: foo</span><br><span class="line">      mountPath: &quot;&#x2F;etc&#x2F;foo&quot;</span><br><span class="line">      readOnly: true</span><br><span class="line">  volumes:</span><br><span class="line">  - name: foo</span><br><span class="line">    secret:</span><br><span class="line">      secretName: mysecret</span><br></pre></td></tr></table></figure><p>Pod å¯åŠ¨åï¼Œæˆ‘ä»¬å¯ä»¥åˆ°å®¹å™¨ä¸­æ¥æŸ¥çœ‹ Secret ä½œä¸º volume mount åˆ°å®¹å™¨åçš„æ–‡ä»¶å†…å®¹ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl exec -it mypod sh</span><br><span class="line">&#x2F; # cd &#x2F;etc&#x2F;foo&#x2F;</span><br><span class="line">&#x2F;etc&#x2F;foo # ls -tal</span><br><span class="line">total 4</span><br><span class="line">drwxr-xr-x    1 root     root          4096 Apr 14 08:55 ..</span><br><span class="line">drwxrwxrwt    3 root     root           120 Apr 14 08:55 .</span><br><span class="line">drwxr-xr-x    2 root     root            80 Apr 14 08:55 ..2021_04_14_08_55_54.401661151</span><br><span class="line">lrwxrwxrwx    1 root     root            31 Apr 14 08:55 ..data -&gt; ..2021_04_14_08_55_54.401661151</span><br><span class="line">lrwxrwxrwx    1 root     root            15 Apr 14 08:55 password -&gt; ..data&#x2F;password</span><br><span class="line">lrwxrwxrwx    1 root     root            15 Apr 14 08:55 username -&gt; ..data&#x2F;username</span><br><span class="line">&#x2F;etc&#x2F;foo # ls -tal ..2021_04_14_08_55_54.401661151</span><br><span class="line">total 8</span><br><span class="line">drwxr-xr-x    2 root     root            80 Apr 14 08:55 .</span><br><span class="line">drwxrwxrwt    3 root     root           120 Apr 14 08:55 ..</span><br><span class="line">-rw-r--r--    1 root     root            13 Apr 14 08:55 password</span><br><span class="line">-rw-r--r--    1 root     root             5 Apr 14 08:55 username</span><br><span class="line">&#x2F;etc&#x2F;foo # cat password</span><br><span class="line">hello-secret</span><br><span class="line">&#x2F;etc&#x2F;foo #</span><br></pre></td></tr></table></figure><h3><span id="etcd-å­˜å‚¨">etcd å­˜å‚¨</span></h3><p>API server ä¸­çš„èµ„æºéƒ½ä¿å­˜åœ¨ etcd ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä»æ–‡ä»¶çœ‹åˆ°ç›¸å…³å†…å®¹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># hexdump -C &#x2F;var&#x2F;lib&#x2F;etcd&#x2F;member&#x2F;snap&#x2F;db | grep -A 5 -B 5 hello</span><br><span class="line">00043640  12 00 1a 07 64 65 66 61  75 6c 74 22 00 2a 24 32  |....default&quot;.*$2|</span><br><span class="line">00043650  35 66 37 35 38 30 38 2d  37 33 31 33 2d 34 38 64  |5f75808-7313-48d|</span><br><span class="line">00043660  39 2d 39 61 38 65 2d 38  61 35 66 66 32 32 63 64  |9-9a8e-8a5ff22cd|</span><br><span class="line">00043670  64 35 39 32 00 38 00 42  08 08 98 dc da 83 06 10  |d592.8.B........|</span><br><span class="line">00043680  00 7a 00 12 19 0a 08 70  61 73 73 77 6f 72 64 12  |.z.....password.|</span><br><span class="line">00043690  0d 68 65 6c 6c 6f 2d 73  65 63 72 65 74 0a 12 11  |.hello-secret...|</span><br><span class="line">000436a0  0a 08 75 73 65 72 6e 61  6d 65 12 05 61 64 6d 69  |..username..admi|</span><br><span class="line">000436b0  6e 1a 06 4f 70 61 71 75  65 1a 00 22 00 00 00 00  |n..Opaque..&quot;....|</span><br><span class="line">000436c0  00 00 00 08 95 5f 00 00  00 00 00 00 00 00 0a 37  |....._.........7|</span><br><span class="line">000436d0  2f 72 65 67 69 73 74 72  79 2f 73 65 72 76 69 63  |&#x2F;registry&#x2F;servic|</span><br><span class="line">000436e0  65 73 2f 65 6e 64 70 6f  69 6e 74 73 2f 6b 75 62  |es&#x2F;endpoints&#x2F;kub|</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼ŒåŸºæœ¬ yaml ä¸­çš„å†…å®¹éƒ½æ˜¯æ˜æ–‡å­˜æ”¾çš„ï¼Œè€Œä¸”æ˜¯è¿›è¡Œ base64 è§£ç ä¹‹åçš„å†…å®¹ã€‚</p><p>ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤ä¹Ÿå¯ä»¥è·å¾—ç±»ä¼¼çš„ç»“æœã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ETCDCTL_API&#x3D;3 etcdctl get --prefix &#x2F;registry&#x2F;secrets&#x2F;default&#x2F;mysecret | hexdump -C</span><br></pre></td></tr></table></figure><p>etcd æœ¬æ¥å­˜å‚¨çš„æ˜¯æ˜æ–‡æ•°æ®ï¼Œè¿™ä¸ªå¥½åƒå·²ç»ä» 1.7 å¼€å§‹æ”¯æŒ <a href="https://kubernetes.io/docs/tasks/administer-cluster/encrypt-data/" target="_blank" rel="noopener">åŠ å¯†å­˜å‚¨</a> äº†ï¼Œè€Œä¸”ç›´æ¥è®¿é—® etcd ä»ç‰©ç†ä¸Šæ¥è¯´ä¹Ÿä¸æ˜¯é‚£ä¹ˆå®¹æ˜“ã€‚</p><h3><span id="api-server">API server</span></h3><p>é€šè¿‡ API server åˆ™ç®€å•çš„å¤šï¼Œåªè¦æœ‰æƒé™å°±å¯ä»¥ä»ä»»ä½•èŠ‚ç‚¹ä¸Šé€šè¿‡è®¿é—® API server æ¥å¾—åˆ° secret çš„æ˜æ–‡å†…å®¹ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get secret mysecret -o yaml</span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  password: aGVsbG8tc2VjcmV0Cg&#x3D;&#x3D;</span><br><span class="line">  username: YWRtaW4&#x3D;</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: &quot;2021-04-14T08:55:52Z&quot;</span><br><span class="line">  name: mysecret</span><br><span class="line">  namespace: default</span><br><span class="line">  resourceVersion: &quot;2196&quot;</span><br><span class="line">  selfLink: &#x2F;api&#x2F;v1&#x2F;namespaces&#x2F;default&#x2F;secrets&#x2F;mysecret</span><br><span class="line">  uid: 25f75808-7313-48d9-9a8e-8a5ff22cdd59</span><br><span class="line">type: Opaque</span><br></pre></td></tr></table></figure><h3><span id="èŠ‚ç‚¹ä¸Š">èŠ‚ç‚¹ä¸Š</span></h3><p>åœ¨èŠ‚ç‚¹ä¸Šä¹Ÿå¯ä»¥çœ‹åˆ° Secret æ–‡ä»¶çš„å†…å®¹ã€‚</p><p>æŸ¥æ‰¾ foo volume çš„æŒ‚è½½ç‚¹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># mount | grep foo </span><br><span class="line">tmpfs on &#x2F;var&#x2F;lib&#x2F;kubelet&#x2F;pods&#x2F;280451e8-512b-489c-b5dd-df2b1a3c9b29&#x2F;volumes&#x2F;kubernetes.io~secret&#x2F;foo type tmpfs (rw,relatime)</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹è¿™ä¸ª volume ä¸‹é¢çš„æ–‡ä»¶å†…å®¹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># ls -tal &#x2F;var&#x2F;lib&#x2F;kubelet&#x2F;pods&#x2F;280451e8-512b-489c-b5dd-df2b1a3c9b29&#x2F;volumes&#x2F;kubernetes.io~secret&#x2F;foo</span><br><span class="line">total 4</span><br><span class="line">drwxrwxrwt 3 root root  120 4æœˆ  14 16:55 .</span><br><span class="line">drwxr-xr-x 2 root root   80 4æœˆ  14 16:55 ..2021_04_14_08_55_54.401661151</span><br><span class="line">lrwxrwxrwx 1 root root   31 4æœˆ  14 16:55 ..data -&gt; ..2021_04_14_08_55_54.401661151</span><br><span class="line">lrwxrwxrwx 1 root root   15 4æœˆ  14 16:55 password -&gt; ..data&#x2F;password</span><br><span class="line">lrwxrwxrwx 1 root root   15 4æœˆ  14 16:55 username -&gt; ..data&#x2F;username</span><br><span class="line">drwxr-xr-x 4 root root 4096 4æœˆ  14 16:55 ..</span><br><span class="line"></span><br><span class="line"># cat &#x2F;var&#x2F;lib&#x2F;kubelet&#x2F;pods&#x2F;280451e8-512b-489c-b5dd-df2b1a3c9b29&#x2F;volumes&#x2F;kubernetes.io~secret&#x2F;foo&#x2F;password</span><br><span class="line">hello-secret</span><br></pre></td></tr></table></figure><h2><span id="ç¬¬ä¸‰æ–¹æ–¹æ¡ˆ">ç¬¬ä¸‰æ–¹æ–¹æ¡ˆ</span></h2><p>é’ˆå¯¹ä¸Šé¢æåˆ°çš„å¯èƒ½æ³„éœ² Secret çš„å‡ ç‚¹ï¼Œå¤§æ¦‚è§£å†³æ–¹æ¡ˆä¸éš¾æƒ³åˆ°å¦‚ä¸‹å‡ ç§ï¼š</p><ul><li>etcd åŠ å¯†</li><li>API server ä¸¥æ ¼è¿›è¡Œæƒé™è®¾è®¡</li><li>å¼ºåŒ– node èŠ‚ç‚¹ç”¨æˆ·æƒé™ç®¡ç†å’Œç³»ç»Ÿå®‰å…¨</li></ul><p>ä¸è¿‡ï¼Œè¦ç›¸å…³ç¡®ä¿ Secret çš„ç»å¯¹å®‰å…¨ï¼Œä¸Šé¢è¿™å‡ ç§æ–¹æ¡ˆéƒ½æ˜¯å¿…é¡»ï¼Œç¼ºä¸€ä¸å¯ï¼Œç¼ºå°‘äº†é‚£ä¸€ä¸ªéƒ½ç›¸å½“äºåœ¨å¢™ä¸Šç•™äº†ä¸€ä¸ªæ´ã€‚</p><p>ç¤¾åŒºå’Œå…¬æœ‰äº‘æä¾›å•†éƒ½æœ‰ä¸€äº›äº§å“å’Œæ–¹æ¡ˆï¼Œæˆ‘ä»¬å¯ä»¥å‚è€ƒä¸€ä¸‹ã€‚</p><ul><li><a href="https://github.com/shyiko/kubesec" target="_blank" rel="noopener">shyiko/kubesec</a>: Secure Secret management for Kubernetes (with gpg, Google Cloud KMS and AWS KMS backends)</li><li><a href="https://github.com/bitnami-labs/sealed-secrets" target="_blank" rel="noopener">bitnami-labs/sealed-secrets</a>: A Kubernetes controller and tool for one-way encrypted Secrets</li><li><a href="https://www.vaultproject.io/docs/platform/k8s" target="_blank" rel="noopener">Vault by HashiCorp</a></li><li><a href="https://github.com/mozilla/sops" target="_blank" rel="noopener">mozilla/sops</a></li><li><a href="https://github.com/external-secrets/kubernetes-external-secrets" target="_blank" rel="noopener">Kubernetes External Secrets</a></li><li><a href="https://github.com/Soluto/kamus" target="_blank" rel="noopener">Kamus</a></li></ul><h3><span id="shyikokubesec">shyiko/kubesec</span></h3><p>kubesec åªå¯¹ Secret ä¸­æ•°æ®è¿›è¡ŒåŠ å¯†/è§£å¯†ï¼Œæ”¯æŒå¦‚ä¸‹ key ç®¡ç†æœåŠ¡æˆ–è½¯ä»¶ï¼š</p><ul><li>AWS Key Management Service</li><li>Google Cloud KMS</li><li>GnuPG</li></ul><h3><span id="bitnami-labssealed-secrets">bitnami-labs/sealed-secrets</span></h3><p>Bitnami åœ¨ K8s é¢†åŸŸä¹Ÿæ˜¯ä¸€å®¶äººäººçŸ¥æ™“çš„å…¬å¸ï¼Œè¾“å‡ºäº†å¾ˆå¤šæŠ€æœ¯å’Œæœ€ä½³å®è·µã€‚</p><p><img src="https://img.hi-linux.com/staticfile/sealed-secrets-20210520174450379-2021-05-20-foc4mT.png" alt></p><p><em>æœ¬å›¾æ¥è‡ª <a href="https://engineering.bitnami.com/articles/sealed-secrets.html" target="_blank" rel="noopener">Sealed Secrets: Protecting your passwords before they reach Kubernetes</a></em></p><p>SealeSecret å°† secret èµ„æºæ•´ä¸ªåŠ å¯†ä¿å­˜ä¸º <code>SealedSecret</code> èµ„æºï¼Œè€Œè§£å¯†åªèƒ½ç”±è¯¥é›†ç¾¤ä¸­çš„ controller è¿›è¡Œã€‚</p><p>SealeSecret æä¾›äº†ä¸€ä¸ª kubeseal å·¥å…·æ¥å¯¹ secret èµ„æºè¿›è¡ŒåŠ å¯†ï¼Œè¿™ä¸ªè¿‡ç¨‹éœ€è¦ä¸€ä¸ªå…¬å¼€ keyï¼ˆå…¬é’¥ï¼‰ï¼Œè¿™ä¸ªå…¬å¼€ key å°±æ˜¯ä» SealeSecret controller æ‹¿åˆ°çš„ã€‚</p><p>ä¸è¿‡ï¼Œåªä»ä»è¯´æ˜æ–‡æ¡£æ¥çœ‹ï¼Œ SealeSecret controller åŠ å¯†è§£å¯†æ‰€ä¾èµ–çš„ keyï¼Œä¹Ÿæ˜¯é€šè¿‡æ™®é€šçš„ Secret æ¥ä¿å­˜çš„ï¼Œè¿™éš¾é“ä¸æ˜¯ä¸€ä¸ªé—®é¢˜ï¼ŸåŒæ—¶ä¹Ÿå¢åŠ äº† SealeSecret controller çš„è¿ç»´æˆæœ¬ã€‚</p><h3><span id="mozillasops">mozilla/sops</span></h3><p>ä¸¥æ ¼æ¥è¯´ï¼Œ sops è·Ÿ K8s å¹¶æ²¡æœ‰ä»€ä¹ˆå¿…ç„¶å…³ç³»ï¼Œå®ƒåªæ˜¯ä¸€ä¸ªæ”¯æŒ YAML/JSON/ENV/INI ç­‰æ–‡ä»¶æ ¼å¼çš„åŠ å¯†æ–‡ä»¶ç¼–è¾‘å™¨ï¼Œå®ƒæ”¯æŒ AWS KMS, GCP KMS, Azure Key Vault, age, å’Œ PGP ç­‰æœåŠ¡ä¸åº”ç”¨ã€‚</p><p>å¦‚æœæœ‰æœ‰å…´è¶£å¯ä»¥çœ‹å®ƒçš„<a href="https://github.com/mozilla/sops" target="_blank" rel="noopener">ä¸»é¡µ</a>ã€‚</p><h3><span id="kubernetes-external-secrets">Kubernetes External Secrets</span></h3><p>Kubernetes External Secrets æ˜¯çŸ¥ååŸŸåæœåŠ¡æä¾›å•† godaddy å¼€å‘çš„å¼€æºè½¯ä»¶ï¼Œå®ƒå¯ä»¥ç›´æ¥å°†ä¿å­˜åœ¨å¤–éƒ¨ KMS ä¸­çš„æœºå¯†ä¿¡æ¯ä¼ ç»™ K8s ã€‚ç›®å‰æ”¯æŒçš„ KSM åŒ…æ‹¬ï¼š</p><ul><li>AWS Secrets Manager</li><li>AWS System Manager</li><li>Hashicorp Vault</li><li>Azure Key Vault</li><li>GCP Secret Manager</li><li>Alibaba Cloud KMS Secret Manager</li></ul><p>å®ƒé€šè¿‡è‡ªå®šä¹‰ controller å’Œ CRD æ¥å®ç°ï¼Œå…·ä½“æ¶æ„å›¾å¦‚ä¸‹ï¼š</p><p><img src="https://img.hi-linux.com/staticfile/kubernetes-external-secrets-architecture-2021-05-20-iCQv1L.png" alt="img"></p><p>å…·ä½“æ¥è¯´ç”¨æˆ·éœ€è¦åˆ›å»ºä¸€ä¸ª ExternalSecret ç±»å‹çš„èµ„æºï¼Œæ¥å°†å¤–éƒ¨ KMS çš„æ•°æ®æ˜ å°„åˆ° K8s çš„ Secret ä¸Šã€‚</p><p>ä¸è¿‡ï¼Œè¿™ç§æ–¹å¼å¤§æ¦‚åªæœ‰ä¸¤ç‚¹å¥½å¤„ï¼š</p><ul><li>ç»Ÿä¸€ key çš„ç®¡ç†ï¼Œæˆ–è€…æ²¿ç”¨æ—¢æœ‰ key èµ„äº§</li><li>key ä¿¡æ¯ä¸æƒ³æ”¾åˆ° VCS ç­‰</li></ul><p>å¯¹äºé˜²æ­¢ Sercet ä¿¡æ¯æ³„éœ²ï¼Œä½œç”¨ä¸å¤§ï¼Œå› ä¸ºå…¶æ˜æ–‡èµ„æºè¿˜æ˜¯å¯ä»¥åœ¨ API server/etcd ä¸Šçœ‹åˆ°ã€‚</p><p>æˆ–è€…è¯´ï¼ŒExternal Secrets çœŸæ­£åšçš„äº‹æƒ…ï¼Œä¹Ÿå°±æ˜¯ä»å¤–éƒ¨ KMS ä¸­çš„ key ï¼Œæ˜ å°„æˆ K8s ä¸­çš„ Secret èµ„æºè€Œå·²ï¼Œå¯¹ä¿è¯åœ¨ K8s é›†ç¾¤ä¸­æ•°æ®çš„å®‰å…¨æ€§ç”¨å¤„ä¸å¤§ã€‚</p><h3><span id="kamus">Kamus</span></h3><p>Kamus åŒæ ·æä¾›äº†åŠ å¯† key çš„æ–¹æ³•ï¼ˆä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·ï¼‰ï¼ŒåŒæ—¶åªæœ‰é€šè¿‡ K8s ä¸­çš„ controller æ‰èƒ½å¯¹è¿™ä¸ª key è¿›è¡Œè§£å¯†ã€‚ä¸è¿‡å®ƒ ä¿å­˜åœ¨ K8s ä¸­çš„ Secret æ˜¯åŠ å¯†çš„çŠ¶æ€ï¼Œç”¨æˆ·ä¸èƒ½åƒ External Secrets é‚£æ ·ç›´æ¥è·å¾— Secret çš„æ˜æ–‡å†…å®¹ã€‚</p><p>Kamus ç”± 3 ä¸ªç»„ä»¶ç»„æˆï¼Œåˆ†åˆ«æ˜¯ï¼š</p><ul><li>Encrypt API</li><li>Decrypt API</li><li>Key Management System (KMS)</li></ul><p>KMS æ˜¯ä¸€ä¸ªå¤–éƒ¨åŠ å¯†æœåŠ¡çš„å°è£…ï¼Œç›®å‰æ”¯æŒå¦‚ä¸‹æœåŠ¡ï¼š - AES - AWS KMS - Azure KeyVault - Google Cloud KMS</p><p>Kamus ä»¥ service account ä¸ºå•ä½å¯¹ secret è¿›è¡ŒåŠ å¯†ï¼Œä¹‹å Pod ä¼šé€šè¿‡ service account æ¥è¯·æ±‚ Kamus çš„è§£å¯†æœåŠ¡æ¥å¯¹è¯¥ secret è¿›è¡Œè§£å¯†ã€‚</p><p>å¯¹ K8s æ¥è¯´ï¼Œè§£å¯† secret å¯ä»¥é€šè¿‡ init container æ¥å®ç°ï¼šå®šä¹‰ä¸€ä¸ª åŸºäºå†…å­˜çš„ emptyDir ï¼Œä¸šåŠ¡å®¹å™¨å’Œ init å®¹å™¨ä½¿ç”¨åŒä¸€ä¸ª volumeï¼Œ init å®¹å™¨è§£å¯†åï¼Œå°†æ•°æ®å­˜æ”¾åˆ°è¯¥ volume ä¸‹ï¼Œä¹‹åä¸šåŠ¡å®¹å™¨å°±å¯ä»¥ä½¿ç”¨è§£å¯†åçš„ secret æ•°æ®äº†ã€‚</p><p><img src="https://img.hi-linux.com/staticfile/kamus-pod-2021-05-20-5Z6xjw.png" alt="img"></p><h3><span id="vault-by-hashicorp">Vault by HashiCorp</span></h3><p>HashiCorp å…¬å¸å°±ä¸å¤šè¯´ï¼Œåœ¨äº‘è®¡ç®—/DevOpsé¢†åŸŸä¹Ÿç®—æ˜¯æ•°ä¸€æ•°äºŒçš„å…¬å¸äº†ã€‚</p><p>Vault æœ¬èº«å°±æ˜¯ä¸€ä¸ª KMS ç±»ä¼¼çš„æœåŠ¡ï¼Œç”¨äºç®¡ç†æœºå¯†æ•°æ®ã€‚å¯¹äº K8s çš„åŸç”Ÿ secret ï¼Œå¤§æ¦‚æä¾›äº†å¦‚ä¸‹ä¸¤ç§æ–¹å¼çš„æ”¯æŒï¼š</p><ul><li><a href="https://www.vaultproject.io/docs/platform/k8s/injector" target="_blank" rel="noopener">Agent Sidecar Injector/vault-k8s</a></li><li><a href="https://www.vaultproject.io/docs/platform/k8s/csi" target="_blank" rel="noopener">Vault CSI Provider</a></li></ul><h4><span id="agent-sidecar-injector">Agent Sidecar Injector</span></h4><p>è¿™ç§æ–¹å¼å’Œä¸Šé¢çš„ Kamus ç±»ä¼¼ï¼Œä¹Ÿæ˜¯éœ€è¦ä¸¤ä¸ªç»„ä»¶ï¼š</p><ul><li>Mutation webhookï¼šè´Ÿè´£ä¿®æ”¹ pod å®šä¹‰ï¼Œæ³¨å…¥init/sidecar</li><li>agent-sidecarï¼šè´Ÿè´£è·å–å’Œè§£å¯†æ•°æ®ï¼Œå°†æ•°æ®ä¿å­˜åˆ°æŒ‡å®šçš„ volume/è·¯å¾„ä¸‹</li></ul><p>Vault agent sidecar injector ä¸ä»…æä¾›äº† init container æ¥åˆå§‹åŒ– secret ï¼Œè¿˜é€šè¿‡ sidecar æ¥å®šæœŸæ›´æ–° secret ï¼Œè¿™æ ·å°±éå¸¸æ¥è¿‘åŸç”Ÿ secret çš„å®ç°äº†ã€‚</p><p>åº”ç”¨ç¨‹åºåˆ™åªéœ€è¦åœ¨æ–‡ä»¶ç³»ç»Ÿä¸Šè¯»å–æŒ‡å®šçš„æ–‡ä»¶å°±å¯ä»¥äº†ï¼Œè€Œä¸å¿…å…³ç³»å¦‚ä½•ä»å¤–éƒ¨è·å–åŠ å¯†ä¿¡æ¯ã€‚</p><p>è¿™æ˜¯å®˜æ–¹ blog ä¸­çš„ä¸€ä¸ªç¤ºä¾‹ï¼š</p><p>Pod ä¿¡æ¯ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">spec:</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      annotations:</span><br><span class="line">        vault.hashicorp.com&#x2F;agent-inject: &quot;true&quot;</span><br><span class="line">        vault.hashicorp.com&#x2F;agent-inject-secret-helloworld: &quot;secrets&#x2F;helloworld&quot;</span><br><span class="line">        vault.hashicorp.com&#x2F;role: &quot;myapp&quot;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå®šä¹‰ä¸­ï¼Œ<code>vault-k8s</code> ä¼šå¯¹è¯¥ pod æ³¨å…¥ <code>vault agent</code>ï¼Œå¹¶ä½¿ç”¨ <code>secrets/helloworld</code> æ¥åˆå§‹åŒ–ã€‚Pod è¿è¡Œåï¼Œå¯ä»¥åœ¨ <code>/vault/secrets</code> ä¸‹æ‰¾åˆ°ä¸€ä¸ªåä¸º <code>helloworld</code> çš„æ–‡ä»¶ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl exec -ti app-XXXXXXXXX -c app -- cat &#x2F;vault&#x2F;secrets&#x2F;helloworld</span><br><span class="line">data: map[password:foobarbazpass username:foobaruser]</span><br><span class="line">metadata: map[created_time:2019-12-16T01:01:58.869828167Z deletion_time: destroyed:false version:1]</span><br></pre></td></tr></table></figure><p>å½“ç„¶è¿™ä¸ªæ•°æ®æ˜¯raw dataï¼Œæ²¡æœ‰ç»è¿‡æ ¼å¼åŒ–ã€‚å¦‚æœæƒ³æŒ‡å®šè¾“å‡ºåˆ°æ–‡ä»¶ä¸­çš„æ ¼å¼ï¼Œå¯ä»¥ä½¿ç”¨ vault çš„æ¨¡æ¿åŠŸèƒ½ã€‚</p><h4><span id="vault-csi-provider">Vault CSI Provider</span></h4><p>è¿™éƒ¨åˆ†å¯ä»¥å‚è€ƒä¸‹é¢çš„ç¤¾åŒºæ–¹æ¡ˆéƒ¨åˆ†ã€‚</p><h2><span id="ç¤¾åŒºæ–¹æ¡ˆ">ç¤¾åŒºæ–¹æ¡ˆ</span></h2><p>å½“ç„¶ï¼Œç¤¾åŒºæ²¡æœ‰ç†ç”±æ„è¯†ä¸åˆ°åŸç”Ÿ secret çš„é—®é¢˜ï¼Œå› æ­¤ç¤¾åŒºä¹Ÿæœ‰ <a href="https://github.com/kubernetes-sigs/secrets-store-csi-driver" target="_blank" rel="noopener">Kubernetes Secrets Store CSI Driver</a> ï¼Œä¸€ç§é€šè¿‡ CSI æ¥å£å°† Secret é›†æˆåˆ° K8s çš„æ–¹æ¡ˆã€‚</p><p>Secrets Store CSI driverï¼ˆ<code>secrets-store.csi.k8s.io</code>ï¼‰å¯ä»¥è®© K8s mount å¤šä¸ª secret ä»¥ volume çš„å½¢å¼ï¼Œä»å¤–éƒ¨ KMS mount åˆ° Pod é‡Œã€‚</p><p>è¦æƒ³ä½¿ç”¨ Secrets Store CSI Driver ï¼Œå¤§è‡´è¿‡ç¨‹å¦‚ä¸‹:</p><ul><li>å®šä¹‰ SecretProviderClass</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: secrets-store.csi.x-k8s.io&#x2F;v1alpha1</span><br><span class="line">kind: SecretProviderClass</span><br><span class="line">metadata:</span><br><span class="line">  name: my-provider</span><br><span class="line">spec:</span><br><span class="line">  provider: vault   # accepted provider options: azure or vault or gcp</span><br><span class="line">  parameters:       # provider-specific parameters</span><br></pre></td></tr></table></figure><ul><li>ä¸º Pod é…ç½® Volume</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">kind: Pod</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: secrets-store-inline</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - image: k8s.gcr.io&#x2F;e2e-test-images&#x2F;busybox:1.29</span><br><span class="line">    name: busybox</span><br><span class="line">    command:</span><br><span class="line">    - &quot;&#x2F;bin&#x2F;sleep&quot;</span><br><span class="line">    - &quot;10000&quot;</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: secrets-store-inline</span><br><span class="line">      mountPath: &quot;&#x2F;mnt&#x2F;secrets-store&quot;</span><br><span class="line">      readOnly: true</span><br><span class="line">  volumes:</span><br><span class="line">    - name: secrets-store-inline</span><br><span class="line">      csi:</span><br><span class="line">        driver: secrets-store.csi.k8s.io</span><br><span class="line">        readOnly: true</span><br><span class="line">        volumeAttributes:</span><br><span class="line">          secretProviderClass: &quot;my-provider&quot;</span><br></pre></td></tr></table></figure><p>Pod å¯åŠ¨ä¹‹åï¼Œå°±å¯ä»¥ç¡®è®¤è§£å¯†åçš„æ•°æ®äº†ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl exec secrets-store-inline -- ls &#x2F;mnt&#x2F;secrets-store&#x2F;</span><br><span class="line">foo</span><br></pre></td></tr></table></figure><h2><span id="æ€»ç»“">æ€»ç»“</span></h2><p>ä¸Šé¢çš„æ€»ç»“éƒ½æ˜¯åŸºäºäº’è”ç½‘å…¬å¼€çš„èµ„æ–™è€Œæ¥ï¼Œå¹¶æ²¡æœ‰ç»è¿‡äº²èº«ä½“éªŒï¼Œå› æ­¤æœ‰äº›åœ°æ–¹å¯èƒ½ç†è§£æœ‰è¯¯ï¼Œè¦æƒ³æ·±å…¥äº†è§£è¿˜éœ€è¦è‡ªå·±äº²æ‰‹ç¡®è®¤æœ€å¥½ã€‚</p><p>ä¸è¿‡æ€»ä½“æ¥è¯´ï¼Œç¤¾åŒºè¿™ç§æ–¹æ¡ˆå¯èƒ½æœ€ç®€å•ï¼Œéƒ¨ç½²ä¹Ÿä¸æ˜¯å¾ˆéº»çƒ¦ï¼Œåªæ˜¯è¿™å°±å’ŒåŸç”Ÿçš„ secret åŸºæœ¬æ²¡ä»€ä¹ˆå…³ç³»äº†ã€‚ã€‚ã€‚</p><p>Vault æ–¹æ¡ˆä¹Ÿå¾ˆæˆç†Ÿï¼Œå€¼å¾—å…³æ³¨ã€‚</p><blockquote><p>æœ¬æ–‡è½¬è½½è‡ªï¼šã€Œ äººé—´æŒ‡å— ã€ï¼ŒåŸæ–‡ï¼š<a href="https://tinyurl.com/y9warvpa" target="_blank" rel="noopener">https://tinyurl.com/y9warvpa</a> ï¼Œç‰ˆæƒå½’åŸä½œè€…æ‰€æœ‰ã€‚æ¬¢è¿æŠ•ç¨¿ï¼ŒæŠ•ç¨¿é‚®ç®±: <a href="mailto:editor@hi-linux.com">editor@hi-linux.com</a>ã€‚</p></blockquote></div><script src="https://my.openwrite.cn/js/readmore.js" type="text/javascript"></script><script>var isMobile = navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i);if (!isMobile) {    var btw = new BTWPlugin();    btw.init({        "id": "vip-container",        "blogId": "10135-1588830050631-449",        "name": "ã€Œå¥‡å¦™çš„ Linux ä¸–ç•Œã€",        "qrcode": "https://www.hi-linux.com/img/wechat/mp_qrcode_12.jpg",        "keyword": "VIP"    });}</script>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;K8s æä¾›äº† Secret èµ„æºä¾›æˆ‘ä»¬æ¥ä¿å­˜ã€è®¾ç½®ä¸€äº›æ•æ„Ÿä¿¡æ¯ï¼Œæ¯”å¦‚ API endpoint åœ°å€ï¼Œå„ç§ç”¨æˆ·å¯†ç æˆ– token ä¹‹ç±»çš„ä¿¡æ¯ã€‚åœ¨æ²¡æœ‰ä½¿ç”¨ K8s çš„æ—¶å€™ï¼Œè¿™äº›ä¿¡æ¯å¯èƒ½æ˜¯é€šè¿‡é…ç½®æ–‡ä»¶æˆ–è€…ç¯å¢ƒå˜é‡åœ¨éƒ¨ç½²çš„æ—¶å€™è®¾ç½®çš„ã€‚&lt;/p&gt;
&lt;p&gt;ä¸è¿‡ï¼ŒSecret å…¶å®å¹¶ä¸å®‰å…¨ï¼Œç¨å¾®ç”¨ kubectl æŸ¥çœ‹è¿‡ Secret çš„äººéƒ½çŸ¥é“ï¼Œæˆ‘ä»¬å¯ä»¥éå¸¸æ–¹ä¾¿çš„çœ‹åˆ° Secret çš„åŸæ–‡ï¼Œåªè¦æœ‰ç›¸å…³çš„æƒé™å³å¯ï¼Œå°½ç®¡å®ƒçš„å†…å®¹æ˜¯ base64 ç¼–ç çš„ï¼Œè¿™åŸºæœ¬ä¸Šç­‰åŒäºæ˜æ–‡ã€‚&lt;/p&gt;
&lt;p&gt;æ‰€ä»¥è¯´ï¼ŒK8s åŸç”Ÿçš„ Secret æ˜¯éå¸¸ç®€å•çš„ï¼Œä¸æ˜¯ç‰¹åˆ«é€‚åˆåœ¨å¤§å‹å…¬å¸é‡Œç›´æ¥ä½¿ç”¨ï¼Œå¯¹ RBAC çš„æŒ‘æˆ˜ä¹Ÿæ¯”è¾ƒå¤§ï¼Œå¾ˆå¤šä¸è¯¥çœ‹åˆ°æ˜æ–‡ä¿¡æ¯çš„äººå¯èƒ½éƒ½èƒ½çœ‹åˆ°ã€‚&lt;/p&gt;
&lt;p&gt;å°¤å…¶æ˜¯ç°åœ¨å¾ˆå¤šå…¬å¸é‡‡ç”¨äº†æ‰€è°“çš„ GitOps ç†å¿µï¼Œå¾ˆå¤šä¸œè¥¿éƒ½éœ€è¦æ”¾åˆ° VCSï¼Œæ¯”å¦‚ git ä¸­ï¼Œè¿™ä¸€é—®é¢˜å°±æ›´æ—¥ç›Šçªå‡ºï¼Œå› ä¸º VCS ä¹Ÿå¾—éœ€è¦è®¾ç½®å¿…è¦çš„æƒé™ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="å¾®æœåŠ¡" scheme="https://www.hi-linux.com/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/"/>
    
    
      <category term="æŠ€å·§" scheme="https://www.hi-linux.com/tags/%E6%8A%80%E5%B7%A7/"/>
    
      <category term="Linux" scheme="https://www.hi-linux.com/tags/Linux/"/>
    
      <category term="å¾®æœåŠ¡" scheme="https://www.hi-linux.com/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/"/>
    
  </entry>
  
  <entry>
    <title>Linux è¿ç»´å·¥ç¨‹å¸ˆå¿…é¡»çŸ¥é“çš„ 6 ç±»å¥½ä¹ æƒ¯å’Œ 23 ä¸ªæ•™è®­</title>
    <link href="https://www.hi-linux.com/posts/17487.html"/>
    <id>https://www.hi-linux.com/posts/17487.html</id>
    <published>2021-11-19T01:00:00.000Z</published>
    <updated>2021-12-18T08:41:42.656Z</updated>
    
    <content type="html"><![CDATA[<div id="vip-container"><p>ä»äº‹è¿ç»´ä¸‰å¹´åŠï¼Œé‡åˆ°è¿‡å„å¼å„æ ·çš„é—®é¢˜ï¼Œæ•°æ®ä¸¢å¤±ï¼Œç½‘ç«™æŒ‚é©¬ï¼Œè¯¯åˆ æ•°æ®åº“æ–‡ä»¶ï¼Œé»‘å®¢æ”»å‡»ç­‰å„ç±»é—®é¢˜ã€‚</p><p>ä»Šå¤©ç®€å•æ•´ç†ä¸€ä¸‹ï¼Œåˆ†äº«ç»™å„ä½å°ä¼™ä¼´ã€‚</p><h2><span id="çº¿ä¸Šæ“ä½œè§„èŒƒ">çº¿ä¸Šæ“ä½œè§„èŒƒ</span></h2><p><strong>1ã€æµ‹è¯•ä½¿ç”¨</strong></p><p>å½“åˆå­¦ä¹  Linux çš„ä½¿ç”¨ï¼Œä»åŸºç¡€åˆ°æœåŠ¡åˆ°é›†ç¾¤ï¼Œéƒ½æ˜¯åœ¨è™šæ‹Ÿæœºåšçš„ï¼Œè™½ç„¶è€å¸ˆå‘Šè¯‰æˆ‘ä»¬è·ŸçœŸæœºæ²¡æœ‰ä»€ä¹ˆå·®åˆ«ï¼Œå¯æ˜¯å¯¹çœŸå®ç¯å¢ƒçš„æ¸´æœ›æ—¥æ¸ä¸Šå‡ï¼Œä¸è¿‡è™šæ‹Ÿæœºçš„å„ç§å¿«ç…§å´è®©æˆ‘ä»¬å…»æˆäº†å„ç§æ‰‹è´±çš„ä¹ æƒ¯ï¼Œä»¥è‡´äºæ‹¿åˆ°æœåŠ¡å™¨æ“ä½œæƒé™æ—¶å€™ï¼Œå°±è¿«ä¸åŠå¾…çš„æƒ³å»è¯•è¯•ï¼Œè®°å¾—ä¸Šç­ç¬¬ä¸€å¤©ï¼Œè€å¤§æŠŠ root å¯†ç äº¤ç»™æˆ‘ï¼Œç”±äºåªèƒ½ä½¿ç”¨ puttyï¼Œæˆ‘å°±æƒ³ä½¿ç”¨ xshellï¼Œäºæ˜¯æ‚„æ‚„ç™»å½•æœåŠ¡å™¨å°è¯•æ”¹ä¸º Xshell+å¯†é’¥ç™»å½•ï¼Œå› ä¸ºæ²¡æœ‰æµ‹è¯•ï¼Œä¹Ÿæ²¡æœ‰ç•™ä¸€ä¸ª SSH è¿æ¥ï¼Œæ‰€æœ‰é‡å¯ SSHD æœåŠ¡å™¨ä¹‹åï¼Œè‡ªå·±å°±è¢«æŒ¡åœ¨æœåŠ¡å™¨ä¹‹å¤–äº†ï¼Œå¹¸å¥½å½“æ—¶æˆ‘å¤‡ä»½äº† sshd_config æ–‡ä»¶ï¼Œåæ¥è®©æœºæˆ¿äººå‘˜ cp è¿‡å»å°±å¯ä»¥äº†ï¼Œå¹¸äºè¿™æ˜¯ä¸€å®¶å°å…¬å¸ï¼Œä¸ç„¶ç›´æ¥å°±è¢«å¹²äº†â€¦â€¦åº†å¹¸å½“å¹´è¿æ°”æ¯”è¾ƒå¥½ã€‚</p><p>ç¬¬äºŒä¸ªä¾‹å­æ˜¯å…³äºæ–‡ä»¶åŒæ­¥çš„ï¼Œå¤§å®¶éƒ½çŸ¥é“ sync åŒæ­¥å¾ˆå¿«ï¼Œå¯æ˜¯ä»–åˆ é™¤æ–‡ä»¶çš„é€Ÿåº¦å¤§å¤§è¶…è¿‡äº† rm -rfï¼Œåœ¨ rsync ä¸­æœ‰ä¸€ä¸ªå‘½ä»¤æ˜¯ï¼Œä»¥æŸç›®å½•ä¸ºå‡†åŒæ­¥æŸæ–‡ä»¶ï¼ˆå¦‚æœç¬¬ä¸€ä¸ªç›®å½•æ˜¯ç©ºçš„ï¼Œé‚£ä¹ˆç»“æœå¯æƒ³è€ŒçŸ¥ï¼‰ï¼Œæºç›®å½•ï¼ˆæœ‰æ•°æ®çš„ï¼‰å°±ä¼šè¢«åˆ é™¤ï¼Œå½“åˆæˆ‘å°±æ˜¯å› ä¸ºè¯¯æ“ä½œï¼Œä»¥åŠç¼ºä¹æµ‹è¯•ï¼Œå°±ç›®å½•å†™åäº†ï¼Œå…³é”®æ˜¯æ²¡æœ‰å¤‡ä»½â€¦â€¦ç”Ÿäº§ç¯å¢ƒæ•°æ®è¢«åˆ äº†ã€‚</p><p>æ²¡å¤‡ä»½ï¼Œå¤§å®¶è‡ªå·±æƒ³åæœå§ï¼Œå…¶é‡è¦æ€§ä¸è¨€è€Œå–»ã€‚</p><a id="more"></a><p><strong>2ã€Enter å‰å†ä¸‰ç¡®è®¤</strong></p><p>å…³äº <code>rm -rf / var</code> è¿™ç§é”™è¯¯ï¼Œæˆ‘ç›¸ä¿¡æ‰‹å¿«çš„äººï¼Œæˆ–è€…ç½‘é€Ÿæ¯”è¾ƒæ…¢çš„æ—¶å€™ï¼Œå‡ºç°çš„å‡ ç‡ç›¸å½“å¤§ï¼Œå½“ä½ å‘ç°æ‰§è¡Œå®Œä¹‹åï¼Œä½ çš„å¿ƒè‡³å°‘æ˜¯å‡‰äº†åŠæˆªã€‚</p><p>å¤§å®¶å¯èƒ½ä¼šè¯´ï¼Œæˆ‘æŒ‰äº†è¿™ä¹ˆå¤šæ¬¡éƒ½æ²¡å‡ºè¿‡é”™ï¼Œä¸ç”¨æ€•ï¼Œæˆ‘åªæƒ³è¯´å½“å‡ºç°ä¸€æ¬¡ä½ å°±æ˜ç™½äº†ï¼Œä¸è¦ä»¥ä¸ºé‚£äº›è¿ç»´äº‹æ•…éƒ½æ˜¯åœ¨åˆ«äººèº«ä¸Šï¼Œå¦‚æœä½ ä¸æ³¨æ„ï¼Œä¸‹ä¸€ä¸ªå°±æ˜¯ä½ ã€‚</p><p><strong>3ã€åˆ‡å¿Œå¤šäººæ“ä½œ</strong></p><p>æˆ‘åœ¨çš„ä¸Šä¸€å®¶å…¬å¸ï¼Œè¿ç»´ç®¡ç†ç›¸å½“æ··ä¹±ï¼Œä¸¾ä¸€ä¸ªæœ€å…¸å‹çš„ä¾‹å­å§ï¼Œç¦»èŒå¥½å‡ ä»»çš„è¿ç»´éƒ½æœ‰æœåŠ¡å™¨ root å¯†ç ã€‚</p><p>é€šå¸¸æˆ‘ä»¬è¿ç»´æ¥åˆ°ä»»åŠ¡ï¼Œéƒ½ä¼šè¿›è¡Œç®€å•æŸ¥çœ‹å¦‚æœæ— æ³•è§£å†³ï¼Œå°±è¯·æ±‚ä»–äººå¸®å¿™ï¼Œå¯æ˜¯å½“é—®é¢˜ç„¦å¤´çƒ‚é¢çš„æ—¶å€™ï¼Œå®¢æœä¸»ç®¡ï¼ˆæ‡‚ç‚¹ Linuxï¼‰ï¼Œç½‘ç®¡ï¼Œä½ ä¸Šå¸ä¸€èµ·è°ƒè¯•ä¸€ä¸ªæœåŠ¡å™¨ï¼Œå½“ä½ å„ç§ç™¾åº¦,å„ç§å¯¹ç…§ï¼Œå®Œäº†å‘ç°ï¼Œä½ çš„æœåŠ¡å™¨é…ç½®æ–‡ä»¶ï¼Œè·Ÿä¸Šæ¬¡ä½ ä¿®æ”¹ä¸ä¸€æ ·äº†ï¼Œç„¶åå†æ”¹å›æ¥ï¼Œç„¶åå†è°·æ­Œï¼Œå…´å†²å†²å‘ç°é—®é¢˜ï¼Œè§£å†³äº†ï¼Œåˆ«äººå´å‘Šè¯‰ä½ ï¼Œä»–ä¹Ÿè§£å†³äº†ï¼Œä¿®æ”¹çš„æ˜¯ä¸åŒçš„å‚æ•°â€¦â€¦è¿™ä¸ªï¼Œæˆ‘å°±çœŸä¸çŸ¥é“å“ªä¸ªæ˜¯é—®é¢˜çœŸæ­£çš„åŸå› äº†ï¼Œå½“ç„¶è¿™è¿˜æ˜¯å¥½çš„ï¼Œé—®é¢˜è§£å†³äº†ï¼Œçš†å¤§æ¬¢å–œï¼Œå¯æ˜¯ä½ é‡åˆ°è¿‡ä½ åˆšä¿®æ”¹çš„æ–‡ä»¶ï¼Œæµ‹è¯•æ— æ•ˆï¼Œå†å»ä¿®æ”¹å‘ç°æ–‡ä»¶åˆè¢«ä¿®æ”¹çš„æ—¶å€™å‘¢ï¼ŸçœŸçš„å¾ˆæ¼ç«ï¼Œåˆ‡å¿Œå¤šäººæ“ä½œã€‚</p><p><strong>4ã€å…ˆå¤‡ä»½åæ“ä½œ</strong></p><p>å…»æˆä¸€ä¸ªä¹ æƒ¯ï¼Œè¦ä¿®æ”¹æ•°æ®æ—¶ï¼Œå…ˆå¤‡ä»½ï¼Œæ¯”å¦‚ <code>.conf</code> çš„é…ç½®æ–‡ä»¶ã€‚å¦å¤–ï¼Œä¿®æ”¹é…ç½®æ–‡ä»¶æ—¶ï¼Œå»ºè®®æ³¨é‡ŠåŸé€‰é¡¹ï¼Œç„¶åå†å¤åˆ¶ï¼Œä¿®æ”¹ã€‚</p><p>å†è€…è¯´ï¼Œå¦‚æœç¬¬ä¸€ä¸ªä¾‹å­ä¸­ï¼Œæœ‰æ•°æ®åº“å¤‡ä»½ï¼Œé‚£ rsync çš„è¯¯æ“ä½œä¸ä¹…æ²¡äº‹äº†å§ã€‚æ‰€ä»¥è¯´ä¸¢æ•°æ®åº“éä¸€æœä¸€å¤•ï¼Œéšä¾¿å¤‡ä»½ä¸€ä¸ªå°±ä¸ç”¨é‚£ä¹ˆæƒ¨ã€‚</p><h2><span id="æ¶‰åŠæ•°æ®">æ¶‰åŠæ•°æ®</span></h2><p><strong>5ã€æ…ç”¨rm -rf</strong></p><p>ç½‘ä¸Šçš„ä¾‹å­å¾ˆå¤šï¼Œå„ç§ <code>rm -rf /</code>ï¼Œå„ç§åˆ é™¤ä¸»æ•°æ®åº“ï¼Œå„ç§è¿ç»´äº‹æ•…â€¦â€¦</p><p>ä¸€ç‚¹å°å¤±è¯¯å°±ä¼šé€ æˆå¾ˆå¤§çš„æŸå¤±ã€‚å¦‚æœçœŸéœ€è¦åˆ é™¤ï¼Œä¸€å®šè¦è°¨æ…ã€‚</p><p><strong>6ã€å¤‡ä»½å¤§äºä¸€åˆ‡</strong></p><p>æœ¬æ¥ä¸Šé¢éƒ½æœ‰å„ç§å…³äºå¤‡ä»½ï¼Œä½†æ˜¯æˆ‘æƒ³æŠŠå®ƒåˆ’åˆ†åœ¨æ•°æ®ç±»å†æ¬¡å¼ºè°ƒï¼Œå¤‡ä»½éå¸¸ä¹‹é‡è¦å“‡ã€‚</p><p>æˆ‘è®°å¾—æˆ‘çš„è€å¸ˆè¯´è¿‡ä¸€å¥è¯ï¼Œæ¶‰åŠåˆ°æ•°æ®ä½•ç§çš„è°¨æ…éƒ½ä¸ä¸ºè¿‡ã€‚æˆ‘å°±èŒçš„å…¬å¸æœ‰åšç¬¬ä¸‰æ–¹æ”¯ä»˜ç½‘ç«™å’Œç½‘è´·å¹³å°çš„ï¼Œç¬¬ä¸‰æ–¹æ”¯ä»˜æ˜¯æ¯ä¸¤ä¸ªå°æ—¶å®Œå…¨å¤‡ä»½ä¸€æ¬¡ï¼Œç½‘è´·å¹³å°æ˜¯æ¯ 20 åˆ†é’Ÿå¤‡ä»½ä¸€æ¬¡ã€‚</p><p>æˆ‘ä¸å¤šè¯´äº†ï¼Œå¤§å®¶è‡ªå·±æ–Ÿé…Œå§ã€‚</p><p><strong>7ã€ç¨³å®šå¤§äºä¸€åˆ‡</strong></p><p>å…¶å®ä¸æ­¢æ˜¯æ•°æ®ï¼Œåœ¨æ•´ä¸ªæœåŠ¡å™¨ç¯å¢ƒï¼Œéƒ½æ˜¯ç¨³å®šå¤§äºä¸€åˆ‡ï¼Œä¸æ±‚æœ€å¿«ï¼Œä½†æ±‚æœ€ç¨³å®šï¼Œæ±‚å¯ç”¨æ€§ï¼Œæ‰€ä»¥æœªç»æµ‹è¯•ï¼Œä¸è¦åœ¨æœåŠ¡å™¨ä½¿ç”¨æ–°çš„è½¯ä»¶ï¼Œæ¯”å¦‚ Nginx+PHP-FPMï¼Œç”Ÿäº§ç¯å¢ƒä¸­ PHP å„ç§æŒ‚å•Šã€‚</p><p>é‡å¯ä¸‹å°±å¥½äº†ï¼Œæˆ–è€…æ¢ apache å°±å¥½äº†ã€‚</p><p><strong>8ã€ä¿å¯†å¤§äºä¸€åˆ‡</strong></p><p>ç°åœ¨å„ç§è‰³ç…§é—¨æ¼«å¤©é£ï¼Œå„ç§è·¯ç”±å™¨åé—¨ï¼Œæ‰€ä»¥è¯´ï¼Œæ¶‰åŠåˆ°æ•°æ®ï¼Œä¸ä¿å¯†æ˜¯ä¸è¡Œçš„ã€‚</p><h2><span id="æ¶‰åŠå®‰å…¨">æ¶‰åŠå®‰å…¨</span></h2><p><strong>9ã€SSH</strong></p><ul><li>æ›´æ”¹é»˜è®¤ç«¯å£ï¼ˆå½“ç„¶å¦‚æœä¸“ä¸šè¦é»‘ä½ ï¼Œæ‰«æä¸‹å°±å‡ºæ¥äº†ï¼‰</li><li>ç¦æ­¢ root ç™»å½•</li><li>ä½¿ç”¨æ™®é€šç”¨æˆ·+keyè®¤è¯+sudoè§„åˆ™+IPåœ°å€+ç”¨æˆ·é™åˆ¶</li><li>ä½¿ç”¨ hostdeny ç±»ä¼¼çš„é˜²çˆ†é‡Œç ´è§£è½¯ä»¶ï¼ˆè¶…è¿‡å‡ æ¬¡å°è¯•ç›´æ¥æ‹‰é»‘ï¼‰</li></ul><p>ç­›é€‰ <code>/etc/passwd</code> ä¸­ login çš„ç”¨æˆ·ã€‚</p><p><strong>10ã€é˜²ç«å¢™</strong></p><p>é˜²ç«å¢™ç”Ÿäº§ç¯å¢ƒä¸€å®šè¦å¼€ï¼Œå¹¶ä¸”è¦éµå¾ªæœ€å°åŸåˆ™ï¼Œdropæ‰€æœ‰ï¼Œç„¶åæ”¾è¡Œéœ€è¦çš„æœåŠ¡ç«¯å£ã€‚</p><p><strong>11ã€ç²¾ç»†æƒé™å’Œæ§åˆ¶ç²’åº¦</strong></p><p>èƒ½ä½¿ç”¨æ™®é€šç”¨æˆ·å¯åŠ¨çš„æœåŠ¡åšå†³ä¸ä½¿ç”¨rootï¼ŒæŠŠå„ç§æœåŠ¡æƒé™æ§åˆ¶åˆ°æœ€ä½ï¼Œæ§åˆ¶ç²’åº¦è¦ç²¾ç»†ã€‚</p><p><strong>12ã€å…¥ä¾µæ£€æµ‹å’Œæ—¥å¿—ç›‘æ§</strong></p><p>ä½¿ç”¨ç¬¬ä¸‰æ–¹è½¯ä»¶ï¼Œæ—¶åˆ»æ£€æµ‹ç³»ç»Ÿå…³é”®æ–‡ä»¶ä»¥åŠå„ç§æœåŠ¡é…ç½®æ–‡ä»¶çš„æ”¹åŠ¨ï¼Œæ¯”å¦‚ï¼š<code>/etc/passwd</code>ï¼Œ<code>/etc/my.cnf</code>ï¼Œ<code>/etc/httpd/con/httpd.conf</code>ç­‰ã€‚</p><p>ä½¿ç”¨é›†ä¸­åŒ–çš„æ—¥å¿—ç›‘æ§ä½“ç³»ï¼Œç›‘æ§ <code>/var/log/secure</code>ï¼Œ<code>/etc/log/message</code>ï¼Œftp ä¸Šä¼ ä¸‹è½½æ–‡ä»¶ç­‰æŠ¥è­¦é”™è¯¯æ—¥å¿—ã€‚</p><p>å¦å¤–é’ˆå¯¹ç«¯å£æ‰«æï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ä¸€äº›ç¬¬ä¸‰æ–¹è½¯ä»¶ï¼Œå‘ç°è¢«æ‰«æå°±ç›´æ¥æ‹‰å…¥ host.denyã€‚è¿™äº›ä¿¡æ¯å¯¹äºç³»ç»Ÿè¢«å…¥ä¾µåæ’é”™å¾ˆæœ‰å¸®åŠ©ã€‚</p><p>æœ‰äººè¯´è¿‡ï¼Œä¸€ä¸ªå…¬å¸åœ¨å®‰å…¨æŠ•å…¥çš„æˆæœ¬è·Ÿä»–è¢«å®‰å…¨æ”»å‡»æŸå¤±çš„æˆæœ¬æˆæ­£æ¯”ï¼Œå®‰å…¨æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„è¯é¢˜ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªå¾ˆåŸºç¡€çš„å·¥ä½œï¼ŒæŠŠåŸºç¡€åšå¥½äº†ï¼Œå°±èƒ½ç›¸å½“çš„æé«˜ç³»ç»Ÿå®‰å…¨æ€§ï¼Œå…¶ä»–çš„å°±æ˜¯å®‰å…¨é«˜æ‰‹åšçš„äº†ã€‚</p><h2><span id="æ—¥å¸¸ç›‘æ§">æ—¥å¸¸ç›‘æ§</span></h2><p><strong>13ã€ç³»ç»Ÿè¿è¡Œç›‘æ§</strong></p><p>å¥½å¤šäººè¸å…¥è¿ç»´éƒ½æ˜¯ä»ç›‘æ§åšèµ·ï¼Œå¤§çš„å…¬å¸ä¸€èˆ¬éƒ½æœ‰ä¸“ä¸š 24 å°æ—¶ç›‘æ§è¿ç»´ã€‚ç³»ç»Ÿè¿è¡Œç›‘æ§ä¸€èˆ¬åŒ…æ‹¬ç¡¬ä»¶å ç”¨ç‡ï¼Œå¸¸è§çš„æœ‰ï¼Œå†…å­˜ï¼Œç¡¬ç›˜ï¼ŒCPUï¼Œç½‘å¡ï¼ŒOSåŒ…æ‹¬ç™»å½•ç›‘æ§ï¼Œç³»ç»Ÿå…³é”®æ–‡ä»¶ç›‘æ§ã€‚</p><p>å®šæœŸçš„ç›‘æ§å¯ä»¥é¢„æµ‹å‡ºç¡¬ä»¶æŸåçš„æ¦‚ç‡ï¼Œå¹¶ä¸”ç»™è°ƒä¼˜å¸¦æ¥å¾ˆå®ç”¨çš„åŠŸèƒ½ã€‚</p><p><strong>14ã€æœåŠ¡è¿è¡Œç›‘æ§</strong></p><p>æœåŠ¡ç›‘æ§ä¸€èˆ¬å°±æ˜¯å„ç§åº”ç”¨ï¼ŒWebï¼ŒDBï¼ŒLVSç­‰ï¼Œè¿™ä¸€èˆ¬éƒ½æ˜¯ç›‘æ§ä¸€äº›æŒ‡æ ‡ã€‚</p><p>åœ¨ç³»ç»Ÿå‡ºç°æ€§èƒ½ç“¶é¢ˆçš„æ—¶å€™å°±èƒ½å¾ˆå¿«å‘ç°å¹¶è§£å†³ã€‚</p><p><strong>15ã€æ—¥å¿—ç›‘æ§</strong></p><p>è¿™é‡Œçš„æ—¥å¿—ç›‘æ§è·Ÿå®‰å…¨çš„æ—¥å¿—ç›‘æ§ç±»ä¼¼ï¼Œä½†è¿™é‡Œä¸€èˆ¬éƒ½æ˜¯ç¡¬ä»¶ï¼ŒOSï¼Œåº”ç”¨ç¨‹åºçš„æŠ¥é”™å’Œè­¦æŠ¥ä¿¡æ¯ã€‚</p><p>ç›‘æ§åœ¨ç³»ç»Ÿç¨³å®šè¿è¡Œçš„æ—¶å€™ç¡®å®æ²¡å•¥ç”¨ï¼Œä½†æ˜¯ä¸€æ—¦å‡ºç°é—®é¢˜ï¼Œä½ åˆæ²¡åšç›‘æ§ï¼Œå°±ä¼šå¾ˆè¢«åŠ¨äº†ã€‚</p><h2><span id="æ€§èƒ½è°ƒä¼˜">æ€§èƒ½è°ƒä¼˜</span></h2><p><strong>16ã€æ·±å…¥äº†è§£è¿è¡Œæœºåˆ¶</strong></p><p>å…¶å®æŒ‰ä¸€å¹´å¤šçš„è¿ç»´ç»éªŒæ¥è¯´ï¼Œè°ˆè°ƒä¼˜æ ¹æœ¬å°±æ˜¯çº¸ä¸Šè°ˆå…µï¼Œä½†æ˜¯æˆ‘åªæ˜¯æƒ³ç®€å•æ€»ç»“ä¸‹ï¼Œå¦‚æœæœ‰æ›´æ·±å…¥çš„äº†è§£ï¼Œæˆ‘ä¼šæ›´æ–°ã€‚åœ¨å¯¹è½¯ä»¶è¿›è¡Œä¼˜åŒ–ä¹‹å‰ï¼Œæ¯”å¦‚è¦æ·±å…¥äº†è§£ä¸€ä¸ªè½¯ä»¶çš„è¿è¡Œæœºåˆ¶ï¼Œæ¯”å¦‚ Nginx å’Œ Apacheï¼Œå¤§å®¶éƒ½è¯´ Nginx å¿«ï¼Œé‚£å°±å¿…é¡»çŸ¥é“ Nginx ä¸ºä»€ä¹ˆå¿«ï¼Œåˆ©ç”¨ä»€ä¹ˆåŸç†ï¼Œå¤„ç†è¯·æ±‚æ¯” Apacheï¼Œå¹¶ä¸”è¦èƒ½è·Ÿåˆ«äººç”¨æµ…æ˜¾æ˜“æ‡‚çš„è¯è¯´å‡ºæ¥ï¼Œå¿…è¦çš„æ—¶å€™è¿˜è¦èƒ½çœ‹æ‡‚æºä»£ç ï¼Œå¦åˆ™ä¸€åˆ‡ä»¥å‚æ•°ä¸ºè°ƒä¼˜å¯¹è±¡çš„æ–‡æ¡£éƒ½æ˜¯çè°ˆã€‚</p><p><strong>17ã€è°ƒä¼˜æ¡†æ¶ä»¥åŠå…ˆå</strong></p><p>ç†Ÿæ‚‰äº†åº•å±‚è¿è¡Œæœºåˆ¶ï¼Œå°±è¦æœ‰è°ƒä¼˜çš„æ¡†æ¶å’Œå…ˆåé¡ºåºï¼Œæ¯”å¦‚æ•°æ®åº“å‡ºç°ç“¶é¢ˆï¼Œå¥½å¤šäººç›´æ¥å°±å»æ›´æ”¹æ•°æ®åº“çš„é…ç½®æ–‡ä»¶ï¼Œæˆ‘çš„å»ºè®®æ˜¯ï¼Œå…ˆæ ¹æ®ç“¶é¢ˆå»åˆ†æï¼ŒæŸ¥çœ‹æ—¥å¿—ï¼Œå†™å‡ºæ¥è°ƒä¼˜æ–¹å‘ï¼Œç„¶åå†å…¥æ‰‹ï¼Œå¹¶ä¸”æ•°æ®åº“æœåŠ¡å™¨è°ƒä¼˜åº”è¯¥æ˜¯æœ€åä¸€æ­¥ï¼Œæœ€å…ˆçš„åº”è¯¥æ˜¯ç¡¬ä»¶å’Œæ“ä½œç³»ç»Ÿï¼Œç°åœ¨çš„æ•°æ®åº“æœåŠ¡å™¨éƒ½æ˜¯åœ¨å„ç§æµ‹è¯•ä¹‹åæ‰ä¼šå‘å¸ƒçš„</p><p>é€‚ç”¨äºæ‰€æœ‰æ“ä½œç³»ç»Ÿï¼Œä¸åº”è¯¥å…ˆä»ä»–å…¥æ‰‹ã€‚</p><p><strong>18ã€æ¯æ¬¡åªè°ƒä¸€ä¸ªå‚æ•°</strong></p><p>æ¯æ¬¡åªè°ƒä¸€ä¸ªå‚æ•°ï¼Œè¿™ä¸ªç›¸æ¯”å¤§å®¶éƒ½äº†è§£ï¼Œè°ƒçš„å¤šäº†ï¼Œä½ å°±è‡ªå·±å°±è¿·ç³Šäº†ã€‚</p><p><strong>19ã€åŸºå‡†æµ‹è¯•</strong></p><p>åˆ¤æ–­è°ƒä¼˜æ˜¯å¦æœ‰ç”¨ï¼Œå’Œæµ‹è¯•ä¸€ä¸ªæ–°ç‰ˆæœ¬è½¯ä»¶çš„ç¨³å®šæ€§å’Œæ€§èƒ½ç­‰æ–¹é¢ï¼Œå°±å¿…é¡»è¦åŸºå‡†æµ‹è¯•äº†ï¼Œæµ‹è¯•è¦æ¶‰åŠå¾ˆå¤šå› ç´ ã€‚</p><p>æµ‹è¯•æ˜¯å¦æ¥è¿‘ä¸šåŠ¡çœŸå®éœ€æ±‚è¿™è¦çœ‹æµ‹è¯•äººçš„ç»éªŒäº†ï¼Œç›¸å…³èµ„æ–™å¤§å®¶å¯ä»¥å‚è€ƒã€Šé«˜æ€§èƒ½MySQLã€‹ç¬¬ä¸‰ç‰ˆç›¸å½“çš„å¥½ã€‚</p><p>æˆ‘çš„è€å¸ˆæ›¾è¯´è¿‡ï¼Œæ²¡æœ‰æ”¾ä¹‹å››æµ·çš†å‡†çš„å‚æ•°ï¼Œä»»ä½•å‚æ•°æ›´æ”¹ä»»ä½•è°ƒä¼˜éƒ½å¿…é¡»ç¬¦åˆä¸šåŠ¡åœºæ™¯ï¼Œæ‰€ä»¥ä¸è¦å†è°·æ­Œä»€ä¹ˆä»€ä¹ˆè°ƒä¼˜äº†ï¼Œå¯¹ä½ çš„æå‡å’Œä¸šåŠ¡ç¯å¢ƒçš„æ”¹å–„æ²¡æœ‰é•¿ä¹…ä½œç”¨ã€‚</p><h2><span id="è¿ç»´å¿ƒæ€">è¿ç»´å¿ƒæ€</span></h2><p><strong>20ã€æ§åˆ¶å¿ƒæ€</strong></p><p>å¾ˆå¤š <code>rm -rf /data</code> éƒ½åœ¨ä¸‹ç­çš„å‰å‡ åˆ†é’Ÿï¼Œéƒ½åœ¨çƒ¦èºçš„é«˜å³°ï¼Œé‚£ä¹ˆä½ è¿˜ä¸æ‰“ç®—æ§åˆ¶ä¸‹ä½ çš„å¿ƒæ€ä¹ˆï¼Ÿ</p><p>æœ‰äººè¯´äº†ï¼Œçƒ¦èºä¹Ÿè¦ä¸Šç­ï¼Œå¯æ˜¯ä½ å¯ä»¥åœ¨çƒ¦èºçš„æ—¶å€™å°½é‡é¿å…å¤„ç†å…³é”®æ•°æ®ç¯å¢ƒï¼Œè¶Šæ˜¯æœ‰å‹åŠ›ï¼Œè¶Šè¦å†·é™ï¼Œä¸ç„¶ä¼šæŸå¤±æ›´å¤šã€‚</p><p>å¤§å¤šäººéƒ½æœ‰ <code>rm -rf /data/mysql</code> çš„ç»å†ï¼Œå‘ç°åˆ é™¤ä¹‹åï¼Œé‚£ç§å¿ƒæƒ…ä½ å¯ä»¥æƒ³è±¡ä¸€ä¸‹ï¼Œå¯æ˜¯å¦‚æœæ²¡æœ‰å¤‡ä»½ï¼Œä½ æ€¥åˆæœ‰ä»€ä¹ˆç”¨ï¼Œä¸€èˆ¬è¿™ç§æƒ…å†µä¸‹ï¼Œä½ å°±è¦å†·é™æƒ³ä¸‹æœ€åæ‰“ç®—äº†ï¼Œå¯¹äº MySQL æ¥è¯´ï¼Œåˆ é™¤äº†ç‰©ç†æ–‡ä»¶ï¼Œä¸€éƒ¨åˆ†è¡¨è¿˜ä¼šå­˜åœ¨å†…å­˜ä¸­ï¼Œæ‰€ä»¥æ–­å¼€ä¸šåŠ¡ï¼Œä½†æ˜¯ä¸è¦å…³é—­MySQLæ•°æ®åº“ï¼Œè¿™å¯¹æ¢å¤å¾ˆæœ‰å¸®åŠ©ï¼Œå¹¶ä½¿ç”¨ddå¤åˆ¶ç¡¬ç›˜ï¼Œç„¶åä½ å†è¿›è¡Œæ¢å¤ã€‚</p><p>å½“ç„¶äº†å¤§å¤šæ—¶å€™ä½ å°±åªèƒ½æ‰¾æ•°æ®æ¢å¤å…¬å¸äº†ã€‚</p><p>è¯•æƒ³ä¸€ä¸‹ï¼Œæ•°æ®è¢«åˆ äº†ï¼Œä½ å„ç§æ“ä½œï¼Œå…³é—­æ•°æ®åº“ï¼Œç„¶åä¿®å¤ï¼Œä¸ä½†æœ‰å¯èƒ½è¦†ç›–æ–‡ä»¶ï¼Œè¿˜æ‰¾ä¸åˆ°å†…å­˜ä¸­çš„è¡¨äº†ã€‚</p><p><strong>21ã€å¯¹æ•°æ®è´Ÿè´£</strong></p><p>ç”Ÿäº§ç¯å¢ƒä¸æ˜¯å„¿æˆï¼Œæ•°æ®åº“ä¹Ÿä¸æ˜¯å„¿æˆï¼Œä¸€å®šè¦å¯¹æ•°æ®è´Ÿè´£ã€‚ä¸å¤‡ä»½çš„åæœæ˜¯éå¸¸ä¸¥é‡çš„ã€‚</p><p><strong>22ã€è¿½æ ¹ç©¶åº•</strong></p><p>å¾ˆå¤šè¿ç»´äººå‘˜æ¯”è¾ƒå¿™ï¼Œé‡åˆ°é—®é¢˜è§£å†³å°±ä¸ä¼šå†ç®¡äº†ï¼Œè®°å¾—å»å¹´ä¸€ä¸ªå®¢æˆ·çš„ç½‘ç«™è€æ˜¯æ‰“ä¸å¼€ï¼Œç»è¿‡ PHP ä»£ç æŠ¥é”™ï¼Œå‘ç°æ˜¯ session å’Œ whos_online æŸåï¼Œå‰ä»»è¿ç»´æ˜¯é€šè¿‡ repair ä¿®å¤çš„ï¼Œæˆ‘å°±ä¹Ÿè¿™æ ·ä¿®å¤äº†ï¼Œä½†æ˜¯è¿‡äº†å‡ ä¸ªå°æ—¶ï¼Œåˆå‡ºç°äº†ã€‚åå¤ä¸‰å››æ¬¡ä¹‹åï¼Œæˆ‘å°±å»è°·æ­Œæ•°æ®åº“è¡¨è«åæŸååŸå› ï¼šä¸€æ˜¯ myisam çš„ bugï¼ŒäºŒæ˜¯ mysqlbugï¼Œä¸‰æ˜¯ MySQL åœ¨å†™å…¥è¿‡ç¨‹ä¸­è¢« killï¼Œæœ€åå‘ç°æ˜¯å†…å­˜ä¸å¤Ÿç”¨ï¼Œå¯¼è‡´ OOM kill äº† mysqld è¿›ç¨‹ï¼Œå¹¶ä¸”æ²¡æœ‰ swap åˆ†åŒºï¼Œåå°ç›‘æ§å†…å­˜æ˜¯å¤Ÿç”¨çš„ï¼Œæœ€åå‡çº§ç‰©ç†å†…å­˜è§£å†³ã€‚</p><p><strong>23ã€æµ‹è¯•å’Œç”Ÿäº§ç¯å¢ƒ</strong></p><p>åœ¨é‡è¦æ“ä½œä¹‹å‰ä¸€å®šè¦çœ‹è‡ªå·±æ‰€åœ¨çš„æœºå™¨ï¼Œå°½é‡é¿å…å¤šå¼€çª—å£ã€‚</p><blockquote><p>æœ¬æ–‡è½¬è½½è‡ªï¼šã€Œ åšå®¢å›­ ã€ï¼ŒåŸæ–‡ï¼š<a href="https://tinyurl.com/jrh7nr2x" target="_blank" rel="noopener">https://tinyurl.com/jrh7nr2x</a> ï¼Œç‰ˆæƒå½’åŸä½œè€…æ‰€æœ‰ã€‚æ¬¢è¿æŠ•ç¨¿ï¼ŒæŠ•ç¨¿é‚®ç®±: <a href="mailto:editor@hi-linux.com">editor@hi-linux.com</a>ã€‚</p></blockquote></div><script src="https://my.openwrite.cn/js/readmore.js" type="text/javascript"></script><script>var isMobile = navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i);if (!isMobile) {    var btw = new BTWPlugin();    btw.init({        "id": "vip-container",        "blogId": "10135-1588830050631-449",        "name": "ã€Œå¥‡å¦™çš„ Linux ä¸–ç•Œã€",        "qrcode": "https://www.hi-linux.com/img/wechat/mp_qrcode_12.jpg",        "keyword": "VIP"    });}</script>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä»äº‹è¿ç»´ä¸‰å¹´åŠï¼Œé‡åˆ°è¿‡å„å¼å„æ ·çš„é—®é¢˜ï¼Œæ•°æ®ä¸¢å¤±ï¼Œç½‘ç«™æŒ‚é©¬ï¼Œè¯¯åˆ æ•°æ®åº“æ–‡ä»¶ï¼Œé»‘å®¢æ”»å‡»ç­‰å„ç±»é—®é¢˜ã€‚&lt;/p&gt;
&lt;p&gt;ä»Šå¤©ç®€å•æ•´ç†ä¸€ä¸‹ï¼Œåˆ†äº«ç»™å„ä½å°ä¼™ä¼´ã€‚&lt;/p&gt;
&lt;h2 id=&quot;çº¿ä¸Šæ“ä½œè§„èŒƒ&quot;&gt;çº¿ä¸Šæ“ä½œè§„èŒƒ&lt;/h2&gt;
&lt;p&gt;&lt;strong&gt;1ã€æµ‹è¯•ä½¿ç”¨&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;å½“åˆå­¦ä¹  Linux çš„ä½¿ç”¨ï¼Œä»åŸºç¡€åˆ°æœåŠ¡åˆ°é›†ç¾¤ï¼Œéƒ½æ˜¯åœ¨è™šæ‹Ÿæœºåšçš„ï¼Œè™½ç„¶è€å¸ˆå‘Šè¯‰æˆ‘ä»¬è·ŸçœŸæœºæ²¡æœ‰ä»€ä¹ˆå·®åˆ«ï¼Œå¯æ˜¯å¯¹çœŸå®ç¯å¢ƒçš„æ¸´æœ›æ—¥æ¸ä¸Šå‡ï¼Œä¸è¿‡è™šæ‹Ÿæœºçš„å„ç§å¿«ç…§å´è®©æˆ‘ä»¬å…»æˆäº†å„ç§æ‰‹è´±çš„ä¹ æƒ¯ï¼Œä»¥è‡´äºæ‹¿åˆ°æœåŠ¡å™¨æ“ä½œæƒé™æ—¶å€™ï¼Œå°±è¿«ä¸åŠå¾…çš„æƒ³å»è¯•è¯•ï¼Œè®°å¾—ä¸Šç­ç¬¬ä¸€å¤©ï¼Œè€å¤§æŠŠ root å¯†ç äº¤ç»™æˆ‘ï¼Œç”±äºåªèƒ½ä½¿ç”¨ puttyï¼Œæˆ‘å°±æƒ³ä½¿ç”¨ xshellï¼Œäºæ˜¯æ‚„æ‚„ç™»å½•æœåŠ¡å™¨å°è¯•æ”¹ä¸º Xshell+å¯†é’¥ç™»å½•ï¼Œå› ä¸ºæ²¡æœ‰æµ‹è¯•ï¼Œä¹Ÿæ²¡æœ‰ç•™ä¸€ä¸ª SSH è¿æ¥ï¼Œæ‰€æœ‰é‡å¯ SSHD æœåŠ¡å™¨ä¹‹åï¼Œè‡ªå·±å°±è¢«æŒ¡åœ¨æœåŠ¡å™¨ä¹‹å¤–äº†ï¼Œå¹¸å¥½å½“æ—¶æˆ‘å¤‡ä»½äº† sshd_config æ–‡ä»¶ï¼Œåæ¥è®©æœºæˆ¿äººå‘˜ cp è¿‡å»å°±å¯ä»¥äº†ï¼Œå¹¸äºè¿™æ˜¯ä¸€å®¶å°å…¬å¸ï¼Œä¸ç„¶ç›´æ¥å°±è¢«å¹²äº†â€¦â€¦åº†å¹¸å½“å¹´è¿æ°”æ¯”è¾ƒå¥½ã€‚&lt;/p&gt;
&lt;p&gt;ç¬¬äºŒä¸ªä¾‹å­æ˜¯å…³äºæ–‡ä»¶åŒæ­¥çš„ï¼Œå¤§å®¶éƒ½çŸ¥é“ sync åŒæ­¥å¾ˆå¿«ï¼Œå¯æ˜¯ä»–åˆ é™¤æ–‡ä»¶çš„é€Ÿåº¦å¤§å¤§è¶…è¿‡äº† rm -rfï¼Œåœ¨ rsync ä¸­æœ‰ä¸€ä¸ªå‘½ä»¤æ˜¯ï¼Œä»¥æŸç›®å½•ä¸ºå‡†åŒæ­¥æŸæ–‡ä»¶ï¼ˆå¦‚æœç¬¬ä¸€ä¸ªç›®å½•æ˜¯ç©ºçš„ï¼Œé‚£ä¹ˆç»“æœå¯æƒ³è€ŒçŸ¥ï¼‰ï¼Œæºç›®å½•ï¼ˆæœ‰æ•°æ®çš„ï¼‰å°±ä¼šè¢«åˆ é™¤ï¼Œå½“åˆæˆ‘å°±æ˜¯å› ä¸ºè¯¯æ“ä½œï¼Œä»¥åŠç¼ºä¹æµ‹è¯•ï¼Œå°±ç›®å½•å†™åäº†ï¼Œå…³é”®æ˜¯æ²¡æœ‰å¤‡ä»½â€¦â€¦ç”Ÿäº§ç¯å¢ƒæ•°æ®è¢«åˆ äº†ã€‚&lt;/p&gt;
&lt;p&gt;æ²¡å¤‡ä»½ï¼Œå¤§å®¶è‡ªå·±æƒ³åæœå§ï¼Œå…¶é‡è¦æ€§ä¸è¨€è€Œå–»ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Linux" scheme="https://www.hi-linux.com/categories/Linux/"/>
    
    
      <category term="æŠ€å·§" scheme="https://www.hi-linux.com/tags/%E6%8A%80%E5%B7%A7/"/>
    
      <category term="Linux" scheme="https://www.hi-linux.com/tags/Linux/"/>
    
      <category term="å¼€æº" scheme="https://www.hi-linux.com/tags/%E5%BC%80%E6%BA%90/"/>
    
  </entry>
  
  <entry>
    <title>é˜¿é‡Œäº‘å‘å¸ƒå…¨æ–°å¼€æºæ“ä½œç³»ç»Ÿã€é¾™èœ¥ã€ï¼Œæ”¯æŒ X86 64 å’Œ ARM 64 æ¶æ„åŠé£è…¾ã€æµ·å…‰ã€å…†èŠ¯ã€é²²é¹ç­‰èŠ¯ç‰‡</title>
    <link href="https://www.hi-linux.com/posts/20754.html"/>
    <id>https://www.hi-linux.com/posts/20754.html</id>
    <published>2021-10-19T01:00:00.000Z</published>
    <updated>2021-12-18T08:41:42.654Z</updated>
    
    <content type="html"><![CDATA[<div id="vip-container"><p>è¿‘æ—¥ï¼Œ2021 äº‘æ –å¤§ä¼šä¸Šï¼Œé˜¿é‡Œäº‘å‘å¸ƒäº†å…¨æ–°æ“ä½œç³»ç»Ÿ <strong>â€œé¾™èœ¥â€(Anolis OS)</strong>ï¼Œå¹¶å®£å¸ƒå¼€æºã€‚</p><p>æ®äº†è§£ï¼Œé¾™èœ¥æ“ä½œç³»ç»Ÿ <strong>å®šä½äºæœåŠ¡å™¨å¸‚åœº</strong>ï¼Œæ”¯æŒ x86ã€ARM ç­‰å¤šç§ç¡¬ä»¶æ¶æ„å’Œè®¡ç®—åœºæ™¯ã€‚</p><p><strong>å®ƒç‰¹åˆ«é’ˆå¯¹äº‘åŸç”Ÿåº”ç”¨å¼€å‘åšäº†å¤šé‡ä¼˜åŒ–ï¼Œäº‘ä¸Šå…¸å‹åœºæ™¯çš„ç»¼åˆæ€§èƒ½å¯æå‡ 40ï¼…ï¼ŒåŒæ—¶æ•…éšœç‡å¯é™ä½ 50ï¼…ï¼Œè¿˜å…¼å®¹ CentOS ç”Ÿæ€ï¼Œæ”¯æŒä¸€é”®è¿ç§»ï¼Œå¹¶æä¾›å…¨æ ˆå›½å¯†èƒ½åŠ›ã€‚</strong></p><p>é¾™èœ¥æ“ä½œç³»ç»Ÿ <strong>å®Œå…¨å¼€æº</strong>ï¼Œé€šè¿‡å¼€æºç¤¾åŒºå’Œæ“ä½œç³»ç»Ÿå‚å•†ç­‰å½¢å¼æä¾›æœåŠ¡ï¼Œ<strong>æŠ€æœ¯æ”¯æŒè‡³å°‘ 10 å¹´ã€‚</strong></p><a id="more"></a><p>æœªæ¥ï¼Œ<strong>é˜¿é‡Œäº‘è®¡åˆ’ä¸ºé¾™èœ¥ç³»ç»ŸæŠ•å…¥ 20 äº¿å…ƒçš„ä¸“é¡¹èµ„é‡‘</strong>ï¼Œå¹¶è”åˆ 100 å®¶ç”Ÿæ€åˆä½œä¼™ä¼´æ¨åŠ¨ç”Ÿæ€å»ºè®¾ã€‚</p><p>äº‹å®ä¸Šï¼Œé¾™èœ¥æ“ä½œç³»ç»Ÿå¹¶éæ–°é²œäº‹ç‰©ï¼Œåªæ˜¯é¦–æ¬¡å¯¹å¤–å…¬å¸ƒè€Œå·²ï¼Œ<strong>å®ƒå·²ç»åœ¨é˜¿é‡Œå·´å·´å†…éƒ¨æ‰“ç£¨äº† 10 å¹´ä¹‹ä¹…ï¼Œç‰¹åˆ«æ˜¯æœ‰æ•ˆæ”¯æ’‘äº†å†å¹´æ¥çš„å¤©çŒ«åŒ 11 æ´»åŠ¨</strong>ï¼Œæ€§èƒ½å’Œç¨³å®šæ€§éƒ½ç»å—ä½äº†ä¸¥è‹›çš„è€ƒéªŒã€‚</p><p>å¦å¤–ï¼Œ<strong>é˜¿é‡Œè¾¾æ‘©é™¢æ“ä½œç³»ç»Ÿå®éªŒå®¤</strong> åŒæ­¥å®£å‘Šæˆç«‹ï¼Œæœªæ¥å°†ä¸“æ³¨äºæ“ä½œç³»ç»Ÿçš„ç ”å‘ã€æ¨å¹¿ã€‚</p><blockquote><p>é¾™èœ¥æ“ä½œç³»ç»Ÿ(Anolis OS) 8.4 ç‰ˆæœ¬ä¾ç„¶ç§‰æ‰¿ä¸å›½é™…ä¸»æµ Linux å‚å•†å‘è¡Œç‰ˆ 100% å…¼å®¹çš„åŸåˆ™ï¼Œä¸”æä¾›é…å¥—çš„è¿ç§»å·¥å…·ï¼ŒåŠ©åŠ›ç”¨æˆ·å®Œç¾å¹³æ»‘åœ°è¿ç§»è‡³é¾™èœ¥æ“ä½œç³»ç»Ÿ(Anolis OS)ï¼Œæ»¡è¶³ CentOS åœæœåçš„å„é¢†åŸŸã€å„è¡Œä¸šç”¨æˆ·çš„ä½¿ç”¨ä¹ æƒ¯å’Œéœ€æ±‚ã€‚åœ¨ç¡¬ä»¶ç”Ÿæ€æ–¹é¢é€šè¿‡å’Œ Intel åŠå›½å†…èŠ¯ç‰‡å‚å•†çš„åˆä½œï¼Œæ”¯æŒ Intelã€æµ·å…‰ã€å…†èŠ¯ã€é£è…¾ã€é²²é¹ç­‰ä¸€ç³»åˆ—èŠ¯ç‰‡å¹³å°ï¼Œè¿›è¡Œè½¯ã€ç¡¬ä¸€ä½“çš„ä¼˜åŒ–ï¼Œå……åˆ†å‘æŒ¥ç¡¬ä»¶å¹³å°çš„æ€§èƒ½ã€‚</p></blockquote><p>åœ¨åŸºæœ¬åº“ã€åº”ç”¨ç”Ÿæ€ä¸Šèå…¥äº†é€‚åˆäº‘åœºæ™¯æ–°ç»„ä»¶ï¼Œå„ç»„ä»¶ç»è¿‡äº‘è®¡ç®—åœºæ™¯è¶…å¤§è§„æ¨¡éƒ¨ç½²çš„æ‰“ç£¨å’Œå®Œå–„ï¼Œå¯æ»¡è¶³å„ä¸ªè¡Œä¸šé¢†åŸŸå¯¹äºä¸åŒç”Ÿäº§ç¯å¢ƒä¸‹ä¸åŒæ–¹æ¡ˆçš„å®é™…éœ€æ±‚ã€‚</p><h2><span id="äº®ç‚¹">äº®ç‚¹</span></h2><ul><li>100% å…¼å®¹<strong>å›½é™…ä¸»æµ Linux</strong> å‚å•†å‘è¡Œç‰ˆï¼›</li><li>æ”¯æŒ x86_64 å’Œ aarch64 æ¶æ„åŠé£è…¾ã€æµ·å…‰ã€å…†èŠ¯ã€é²²é¹ç­‰èŠ¯ç‰‡ï¼Œé€‚é… x86 åŠ arm64 <strong>ä¸»æµæœåŠ¡å™¨</strong>ç¡¬ä»¶ï¼›</li><li>æ”¯æŒ Linux Kernel <strong>4.19 LTS</strong> ç‰ˆæœ¬å¹¶åŒæ­¥ä¸Šæ¸¸ç¤¾åŒº<strong>æœ€æ–°æˆæœ</strong>ï¼Œå¸®åŠ©ç”¨æˆ·åŠæ—¶è·å¾—å¼€æºç¤¾åŒºåˆ›æ–°çº¢åˆ©ï¼›</li><li>æ”¯æŒå¼€æºåˆ†å¸ƒå¼å…³ç³»æ•°æ®åº“<strong>OceanBase</strong>ï¼›</li><li>æ”¯æŒå®‰å…¨å®¹å™¨<strong>Kata Containers</strong>ï¼›</li><li>æ”¯æŒå¼€æºäº‘åŸç”Ÿå…³ç³»å‹æ•°æ®åº“<strong>PolarDB for PostgreSQL</strong>ï¼›</li><li><strong>åŸºç¡€åº”ç”¨ç»„ä»¶</strong>å‡çº§ï¼›<br>Python 3.9/SWIG 4.0/Subversion 1.14/Redis 6/PostgreSQL 13/MariaDB 10.5ï¼›</li><li><strong>å·¥å…·é“¾</strong>å‡çº§ï¼›<br>GCC Toolset 10/LLVM Toolset 11.0.0/Rust Toolset 1.49.0/Go Toolset 1.15.7ï¼›</li><li>æä¾› CentOS ç³»ç»Ÿåˆ° Anolis OS è¿ç§»å·¥å…·ï¼Œå¸®åŠ©ç³»ç»ŸåŠåº”ç”¨çš„<strong>é¡ºæ»‘è¿ç§»</strong>ï¼›</li></ul><h2><span id="ç¡¬ä»¶æ”¯æ’‘">ç¡¬ä»¶æ”¯æ’‘</span></h2><h3><span id="æ”¯æŒæ¶æ„">æ”¯æŒæ¶æ„</span></h3><p>x86_64 å’Œ aarch64</p><h3><span id="cloud-kernel-å¹³å°å…¼å®¹æ€§">Cloud Kernel å¹³å°å…¼å®¹æ€§</span></h3><p>Cloud Kernel å†…æ ¸ <strong>å·²éªŒè¯æ”¯æŒçš„æœåŠ¡å™¨</strong> å¦‚ä¸‹ï¼Œåç»­å°†é€æ­¥å¢åŠ å¯¹å…¶ä»–æœåŠ¡å™¨çš„æ”¯æŒï¼Œä¹Ÿæ¬¢è¿å¹¿å¤§åˆä½œä¼™ä¼´/å¼€å‘è€…å‚ä¸è´¡çŒ®å’ŒéªŒè¯ã€‚</p><table><thead><tr><th>åç§°</th><th>æ¶æ„</th><th>CPU</th></tr></thead><tbody><tr><td>é£è…¾</td><td>aarch64</td><td>Phytium FT-2000+/64,Phytium S2500/64</td></tr><tr><td>æµ·å…‰</td><td>x86_64</td><td>Hygon C86 7185 32-core Process</td></tr><tr><td>å…†èŠ¯</td><td>x86_64</td><td>Zhaoxin KH-37800D</td></tr><tr><td>é²²é¹</td><td>aarch64</td><td>Kunpeng-920</td></tr></tbody></table><h2><span id="å‘å¸ƒå†…å®¹">å‘å¸ƒå†…å®¹</span></h2><p>ç›®å‰é¾™èœ¥æœ€æ–°çš„ç¨³å®šç‰ˆæ˜¯ 7 æœˆä»½å‘å¸ƒçš„ Anolis OS 8.4ï¼Œå‘å¸ƒå†…å®¹åŒ…æ‹¬ <strong>ISOã€è™šæ‹Ÿæœºé•œåƒå’Œ REPO æº</strong>ã€‚</p><h3><span id="iso-åˆ—è¡¨">ISO åˆ—è¡¨</span></h3><table><thead><tr><th><strong>åç§°</strong></th><th><strong>æè¿°</strong></th></tr></thead><tbody><tr><td>AnolisOS-8.4-x86_64-dvd.iso</td><td>x86_64æ¶æ„çš„å®‰è£… ISO</td></tr><tr><td>AnolisOS-8.4-aarch64-dvd.iso</td><td>aarch64æ¶æ„çš„å®‰è£… ISO</td></tr><tr><td>AnolisOS-8.4-src-dvd.iso</td><td>source åŒ…ISO</td></tr></tbody></table><h3><span id="è™šæ‹Ÿæœºé•œåƒåˆ—è¡¨">è™šæ‹Ÿæœºé•œåƒåˆ—è¡¨</span></h3><table><thead><tr><th><strong>åç§°</strong></th><th><strong>æè¿°</strong></th></tr></thead><tbody><tr><td>AnolisOS-8.4-GA-x86_64-ANCK.qcow2</td><td>x86_64æ¶æ„è™šæ‹Ÿæœºé•œåƒæ­é…ANCKå†…æ ¸</td></tr><tr><td>AnolisOS-8.4-GA-x86_64-RHCK.qcow2</td><td>x86_64æ¶æ„è™šæ‹Ÿæœºé•œåƒæ­é…RHCKå†…æ ¸[æ³¨1]</td></tr><tr><td>AnolisOS-8.4-GA-aarch64-ANCK.qcow2</td><td>aarch64æ¶æ„è™šæ‹Ÿæœºé•œåƒæ­é…ANCKå†…æ ¸</td></tr><tr><td>AnolisOS-8.4-GA-aarch64-RHCK.qcow2</td><td>aarch64æ¶æ„è™šæ‹Ÿæœºé•œåƒæ­é…RHCKå†…æ ¸</td></tr></tbody></table><blockquote><p>æ³¨1ï¼šRHCK å†…æ ¸å…¼å®¹ CentOS 8.4 çš„å†…æ ¸ï¼Œå½“å‰ç‰ˆæœ¬æ˜¯ kernel-4.18.0-305.an8</p><p>æ³¨2ï¼šé•œåƒç¼ºçœ sudo ç”¨æˆ· anuserï¼Œå¯¹åº”ç™»å½•å¯†ç æ˜¯ anolisosã€‚</p></blockquote><h3><span id="repo-æºåˆ—è¡¨">REPO æºåˆ—è¡¨</span></h3><table><thead><tr><th><strong>åç§°</strong></th><th><strong>æè¿°</strong></th></tr></thead><tbody><tr><td>BaseOS</td><td>BaseOS è½¯ä»¶åŒ…æºï¼Œè¯¥æºç›®çš„æ˜¯æä¾›å®‰è£…åŸºç¡€çš„æ‰€æœ‰æ ¸å¿ƒåŒ…ã€‚</td></tr><tr><td>AppStream</td><td>AppStream è½¯ä»¶åŒ…æºï¼Œè¯¥æºæä¾›é¢å¤–çš„å¤šåœºæ™¯ï¼Œå¤šç”¨é€”çš„ç”¨æˆ·æ€ç¨‹åºï¼Œæ•°æ®åº“ç­‰ã€‚è¯¥éƒ¨åˆ†å¼•å…¥äº†é¢å¤–çš„ RPM Module å½¢æ€ã€‚</td></tr><tr><td>PowerTools</td><td>PowerTools è½¯ä»¶åŒ…æºï¼Œ è¯¥æºæä¾›å¼€å‘è€…éœ€è¦çš„é¢å¤–åŒ…ã€‚</td></tr><tr><td>Plus</td><td>Plus è½¯ä»¶åŒ…æºï¼Œè¯¥æºæä¾› OpenAnolis SIG ç»„ä¸“é—¨ç ”å‘åŒ…ï¼Œå¦‚ ANCK å†…æ ¸ï¼ŒDragonwell8 JDKç­‰ã€‚</td></tr><tr><td>DDE</td><td>DDE æ¡Œé¢ä¸»åŒ…ä»¥åŠä¾èµ–åŒ…</td></tr></tbody></table><h3><span id="ä¸‹è½½åœ°å€">ä¸‹è½½åœ°å€</span></h3><ul><li>ç¤¾åŒºç½‘ç«™</li></ul><p><a href="https://mirrors.openanolis.cn/anolis/8.4/isos/" target="_blank" rel="noopener">https://mirrors.openanolis.cn/anolis/8.4/isos/</a></p><ul><li>é˜¿é‡Œäº‘é•œåƒ</li></ul><p><a href="https://mirrors.aliyun.com/anolis/8.4/" target="_blank" rel="noopener">https://mirrors.aliyun.com/anolis/8.4/</a></p><h2><span id="å‚è€ƒæ–‡æ¡£">å‚è€ƒæ–‡æ¡£</span></h2><ol><li><a href="https://news.mydrivers.com/1/790/790382.htm" target="_blank" rel="noopener">https://news.mydrivers.com/1/790/790382.htm</a></li><li><a href="https://segmentfault.com/a/1190000040419582" target="_blank" rel="noopener">https://segmentfault.com/a/1190000040419582</a></li></ol></div><script src="https://my.openwrite.cn/js/readmore.js" type="text/javascript"></script><script>var isMobile = navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i);if (!isMobile) {    var btw = new BTWPlugin();    btw.init({        "id": "vip-container",        "blogId": "10135-1588830050631-449",        "name": "ã€Œå¥‡å¦™çš„ Linux ä¸–ç•Œã€",        "qrcode": "https://www.hi-linux.com/img/wechat/mp_qrcode_12.jpg",        "keyword": "VIP"    });}</script>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;è¿‘æ—¥ï¼Œ2021 äº‘æ –å¤§ä¼šä¸Šï¼Œé˜¿é‡Œäº‘å‘å¸ƒäº†å…¨æ–°æ“ä½œç³»ç»Ÿ &lt;strong&gt;â€œé¾™èœ¥â€(Anolis OS)&lt;/strong&gt;ï¼Œå¹¶å®£å¸ƒå¼€æºã€‚&lt;/p&gt;
&lt;p&gt;æ®äº†è§£ï¼Œé¾™èœ¥æ“ä½œç³»ç»Ÿ &lt;strong&gt;å®šä½äºæœåŠ¡å™¨å¸‚åœº&lt;/strong&gt;ï¼Œæ”¯æŒ x86ã€ARM ç­‰å¤šç§ç¡¬ä»¶æ¶æ„å’Œè®¡ç®—åœºæ™¯ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;å®ƒç‰¹åˆ«é’ˆå¯¹äº‘åŸç”Ÿåº”ç”¨å¼€å‘åšäº†å¤šé‡ä¼˜åŒ–ï¼Œäº‘ä¸Šå…¸å‹åœºæ™¯çš„ç»¼åˆæ€§èƒ½å¯æå‡ 40ï¼…ï¼ŒåŒæ—¶æ•…éšœç‡å¯é™ä½ 50ï¼…ï¼Œè¿˜å…¼å®¹ CentOS ç”Ÿæ€ï¼Œæ”¯æŒä¸€é”®è¿ç§»ï¼Œå¹¶æä¾›å…¨æ ˆå›½å¯†èƒ½åŠ›ã€‚&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;é¾™èœ¥æ“ä½œç³»ç»Ÿ &lt;strong&gt;å®Œå…¨å¼€æº&lt;/strong&gt;ï¼Œé€šè¿‡å¼€æºç¤¾åŒºå’Œæ“ä½œç³»ç»Ÿå‚å•†ç­‰å½¢å¼æä¾›æœåŠ¡ï¼Œ&lt;strong&gt;æŠ€æœ¯æ”¯æŒè‡³å°‘ 10 å¹´ã€‚&lt;/strong&gt;&lt;/p&gt;
    
    </summary>
    
    
      <category term="Linux" scheme="https://www.hi-linux.com/categories/Linux/"/>
    
    
      <category term="Linux" scheme="https://www.hi-linux.com/tags/Linux/"/>
    
      <category term="å¼€æº" scheme="https://www.hi-linux.com/tags/%E5%BC%80%E6%BA%90/"/>
    
      <category term="é˜¿é‡Œäº‘" scheme="https://www.hi-linux.com/tags/%E9%98%BF%E9%87%8C%E4%BA%91/"/>
    
  </entry>
  
</feed>
